//==========ì„¹í„°1==========

/* [v10.0] ì›ìì  ì•¡ì…˜ ìŠ¤í…Œì´ì§•(Staging) ì‹œìŠ¤í…œ ì „ì—­ ê°ì²´ */
var GLOBAL_STAGING = {
    active: {}, // { uid: boolean } ìŠ¤í…Œì´ì§• ëª¨ë“œ í™œì„±í™” ì—¬ë¶€
    cache: {}   // { uid: { userObject_Snapshot } } ì„ì‹œ ì €ì¥ë³¸
};

/* [v10.0] ì§€ëŠ¥í˜• ì‹œìŠ¤í…œ í™˜ê²½ ì„¤ì • (Performance & Gini) */
var INTELLIGENT_CONFIG = {
    PERFORMANCE: {
        MAX_LOG_SIZE: 1.5 * 1024 * 1024, // 1.5MB ì´ˆê³¼ ì‹œ ìë™ ë¡œí…Œì´ì…˜
        LAG_THRESHOLD_MS: 450,           // ì‘ë‹µ 0.45ì´ˆ ì´ˆê³¼ ì‹œ ê²½ê³  ë° ìë™ ìµœì í™”
        GC_INTERVAL_MIN: 10              // 10ë¶„ë§ˆë‹¤ ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ ìœ ë„
    },
    ECONOMY: {
        GINI_CRITICAL: 0.45,             // ì§€ë‹ˆê³„ìˆ˜ 0.45 ì´ˆê³¼ ì‹œ 'ë¹ˆë¶€ê²©ì°¨ ê²½ë³´' ë° êµì • ê°€ë™
        MAX_PROGRESSIVE_TAX: 0.5,       // ë¶ˆí‰ë“± ì‹¬í™” ì‹œ ìì‚°ê°€ ìµœëŒ€ ì¶”ê°€ ì„¸ìœ¨ (5%)
        REWARD_BOOST_LIMIT: 1.5          // ì„œë¯¼ì¸µ ìµœëŒ€ ë³´ìƒ ê°•í™” ë°°ìœ¨ (1.5ë°°)
    }
};

/* [ì‹ ê·œ] ëª…ë ¹ì–´ ìë™ ë“±ë¡ ì‹œìŠ¤í…œ (Command Registry) */
var USER_COMMANDS = {};
var ADMIN_COMMANDS = {};

function registerUserCmd(cmd, desc, cat, func) {
    USER_COMMANDS[cmd] = { desc: desc, cat: cat, execute: func };
}

function registerAdminCmd(cmd, desc, func) {
    ADMIN_COMMANDS[cmd] = { desc: desc, execute: func };
}

/**
 * [ì „ì—­ í‘œì¤€ ê·œê²©] USER_SCHEMA v1.0
 * ì¹˜ìœ (Sector 19)ì™€ ì‹ ê·œê°€ì…(Sector 20-1)ì´ ê³µí†µìœ¼ë¡œ ì°¸ì¡°í•˜ëŠ” ë¦¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤.
 * ë®ì–´ì“°ê¸° ì‚¬ê³ ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ point ë“± í•µì‹¬ ìì‚°ì˜ ê¸°ë³¸ê°’ì€ 0ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
 */
var USER_SCHEMA = [
    { key: 'point', default: 0, type: 'number' },
    { key: 'bank', default: 0, type: 'number' },
    { key: 'tier', default: 0, type: 'number' },
    { key: 'creditScore', default: 600, type: 'number' },
    { key: 'inventory', default: [], type: 'array' },
    { key: 'collectedIcons', default: [], type: 'array' },
    { key: 'landHoldings', default: {}, type: 'object' },
    { key: 'landAvg', default: {}, type: 'object' },
    { key: 'chatLog', default: [], type: 'array' },
    { key: 'timeoutEndTime', default: 0, type: 'number' },
    { key: 'totalMiningTime', default: 0, type: 'number' },
    { key: 'artifactPieces', default: 0, type: 'number' },
    { key: 'totalGambleCount', default: 0, type: 'number' },
    { key: 'totalGambleWins', default: 0, type: 'number' },
    { key: 'totalTheftSuccess', default: 0, type: 'number' },
    { key: 'totalLandInvest', default: 0, type: 'number' },
    { key: 'dailyPromotionAttempts', default: 1, type: 'number' },
    { key: 'dailyGambleCount', default: 0, type: 'number' },
    { key: 'boughtWarningRemoval', default: false, type: 'boolean' },
    { key: 'hasVotedToday', default: false, type: 'boolean' },
    { key: 'lastFishingTime', default: 0, type: 'number' },    // ë‚šì‹œ ì¿¨íƒ€ì„ ê´€ë¦¬ìš© (Timestamp)
    { key: 'totalSpittoBought', default: 0, type: 'number' },  // ìŠ¤í”¼ë˜ ëˆ„ì  êµ¬ë§¤ëŸ‰ (í†µê³„ìš©)
    { key: 'horseParts', default: [], type: 'array' },       // 1) ê²½ë§ˆ ë¶€í’ˆ (ì•ˆì¥, ë“±ì ë“±) ìˆ˜ì§‘ ëª©ë¡
    { key: 'landDeedCount', default: 0, type: 'number' },
    { key: 'lottoFailCount', default: 0, type: 'number' },   // 3) ë¡œë˜/ìŠ¤í”¼ë˜ ìœ„ë¡œì˜í¸ì§€ ë³´ìœ  ê°œìˆ˜
    { key: 'luckyCharmEnd', default: 0, type: 'number' },    // 3) í–‰ìš´ì˜ë¶€ì  íš¨ê³¼ ì¢…ë£Œ ì‹œê°„ (Timestamp)
    { key: 'accruedInterest', default: 0, type: 'number' },   // ì ë¦½ëœ ì´ì ì£¼ë¨¸ë‹ˆ
    { key: 'lastBankUpdateTime', default: 0, type: 'number' }, // ë§ˆì§€ë§‰ ì€í–‰ ì”ì•¡ ë³€ë™ ì‹œê°„ (Timestamp)
    { key: 'totalFishingSuccess', default: 0, type: 'number' }, // ë‚šì‹œ ëˆ„ì  ì„±ê³µ íšŸìˆ˜ (ì¹­í˜¸ìš©)
    { key: 'totalDonation', default: 0, type: 'number' },       // ëˆ„ì  ê¸°ë¶€ ê¸ˆì•¡
    { key: 'consecutiveWins', default: 0, type: 'number' },     // [ì‹ ê·œ] í™€ì§ ì—°ìŠ¹ ê¸°ë¡ìš© í•„ë“œ
    { key: 'lastGambleTime', default: 0, type: 'number' },      // [ì‹ ê·œ] ë§ˆì§€ë§‰ í™€ì§ ì§„í–‰ ì‹œê°„ (1ì‹œê°„ ì´ˆê¸°í™”ìš©)
    { key: 'isManipulated', default: false, type: 'boolean' }, // ì¡°ì‘ í™œì„±í™” ì—¬ë¶€
    { key: 'gambleWinRate', default: 0, type: 'number' },      // ì„¤ì •ëœ í™€ì§ ìŠ¹ë¥ 
    { key: 'fishLuck', default: 0, type: 'number' },          // ì„¤ì •ëœ ë‚šì‹œ í–‰ìš´
    { key: 'horseWinRate', default: 0, type: 'number' },       // ê²½ë§ˆ ë³´ì •ì¹˜
    { key: 'spittoWinRate', default: 0, type: 'number' },       // ìŠ¤í”¼ë˜ ë³´ì •ì¹˜
    { key: 'shipLevel', default: 1, type: 'number' },           // ì„ ë°• ë“±ê¸‰ (1:ì¹´ë¼ë²¨, 2:í”„ë¦¬ê¹ƒ, 3:ê°¤ë¦¬ì˜¨)
    { key: 'cargo', default: {}, type: 'object' },              // í˜„ì¬ ì ì¬ í™”ë¬¼ { type: count }
    { key: 'cargoAvg', default: {}, type: 'object' },           // í™”ë¬¼ë³„ í‰ê·  ë§¤ì…ê°€ { type: price }
    { key: 'specialties', default: {}, type: 'object' },        // ë³´ìœ  íŠ¹ì‚°í’ˆ { name: count }
    { key: 'voyage', default: { active: false, dest: "", arrival: 0, items: [] }, type: 'object' }, // í•­í•´ ìƒíƒœ
    { key: 'tradeCount', default: 0, type: 'number' },          // ëˆ„ì  ë¬´ì—­ íšŸìˆ˜
    { key: 'totalCasinoBet', default: 0, type: 'number' },      // [ì¹´ì§€ë…¸] ëˆ„ì  ë°°íŒ…ì•¡
    { key: 'totalCasinoWin', default: 0, type: 'number' },      // [ì¹´ì§€ë…¸] ëˆ„ì  ë‹¹ì²¨ì•¡
    { key: 'shipName', default: '', type: 'string' },           // ì„ ë°• ì´ë¦„ ì €ì¥ í•„ë“œ ì¶”ê°€
    { key: 'lastCasinoResult', default: null, type: 'object' }, // { type: "ladder", round: 0, res: "", profit: 0, isWin: true }
    { key: 'dailyLadderWins', default: [], type: 'array' },    // ì‚¬ë‹¤ë¦¬ ë‹¹ì²¨ íˆìŠ¤í† ë¦¬
    { key: 'dailyBaccaratWins', default: [], type: 'array' },  // ë°”ì¹´ë¼ ë‹¹ì²¨ íˆìŠ¤í† ë¦¬
    { key: 'shipName', default: '', type: 'string' },
    { key: 'blackjackState', default: null, type: 'object' }, // { status, playerHand, dealerHand, bet }
    { key: 'dailyBlackjackWins', default: [], type: 'array' }, // ê¸ˆì¼ ë‹¹ì²¨ ê¸°ë¡ìš©
    { key: 'casinoAuditStartTime', default: 0, type: 'number' },   // [ê°ì‹œ] ì¹´ì§€ë…¸ ìµœì´ˆ ì§„ì… ì‹œê° (2ë¶„ ì²´í¬ìš©)
Â  Â  { key: 'casinoAuditStartAssets', default: 0, type: 'number' }, // [ê°ì‹œ] ì¹´ì§€ë…¸ ì‹œì‘ ì‹œì  ì´ ìì‚° (í¬ì¸íŠ¸+ì€í–‰)
Â  Â  { key: 'casinoAuditAlertHistory', default: [], type: 'array' },// [ê°ì‹œ] 2ë°° ì´ˆê³¼ ì•Œë¦¼ ë°œìƒ ì‹œì ë“¤ì˜ ìì‚° ê¸°ë¡ ë°°ì—´
Â  Â  { key: 'lastBotUseTime', default: 0, type: 'number' }          // [ê°ì‹œ] 3ë¶„ ë¯¸ì‚¬ìš© ë¦¬ì…‹ íŒë‹¨ìš© ë§ˆì§€ë§‰ í™œë™ ì‹œê°„
];

/* [ì´ˆê³ ì† ì—”ì§„] ì „ì—­ UID-ë‹‰ë„¤ì„ ìºì‹œ ì´ˆê¸°í™” */
if (typeof globalData !== 'undefined' && !globalData.nameToIdCache) {
    globalData.nameToIdCache = {};
}

/* [v10.0] ì§€ëŠ¥í˜• ì„±ëŠ¥ ê°ì‹œì(IPM) ì „ì—­ ë©”íŠ¸ë¦­ìŠ¤ */
var PERF_METRICS = {
    avgLag: 0,        // í‰ê·  ì§€ì—° ì‹œê°„ (ms)
    peakLag: 0,       // ìµœê³  ì§€ì—° ì‹œê°„ (ms)
    lastOptimize: 0,  // ë§ˆì§€ë§‰ ìµœì í™” ì‹œê°„
    msgPerMin: 0,     // ë¶„ë‹¹ ì²˜ë¦¬ ë©”ì‹œì§€ ìˆ˜
    logSize: 0        // í˜„ì¬ ë¡œê·¸ íŒŒì¼ í¬ê¸° (bytes)
};

/* íŒŒì¼ ë° ë°ì´í„° ë™ê¸°í™” ê°ì²´ */
var Lock = java.util.concurrent.locks.ReentrantLock; 
var lock = new Lock(); 
var logLock = new Lock(); // [v5.8] ì €ë„ë§(ë¸”ë™ë°•ìŠ¤) ì „ìš© ë…ë¦½ ë½ ì¶”ê°€
var SD_PATH = android.os.Environment.getExternalStorageDirectory().getAbsolutePath(); 
var BASE_DIR = SD_PATH + "/msgbot/data/"; 
var FILE_PATH = BASE_DIR + "attendance.json"; 
var REGISTRY_PATH = BASE_DIR + "user_registry.json";
var JOURNAL_PATH = BASE_DIR + "transaction.log"; // [v5.8] ì‹¤ì‹œê°„ ê±°ë˜ ê¸°ë¡ìš© ë¸”ë™ë°•ìŠ¤ ê²½ë¡œ
var BACKUP_DIR = BASE_DIR + "backup/"; 

/**
 * [v10.2] ë¡œê·¸ ë¬´ê²°ì„± ë° ì‹œìŠ¤í…œ ê¶Œí•œ ìê°€ì§„ë‹¨
 * ê¸°ëŠ¥: ë´‡ì´ ê°€ë™ë  ë•Œ ë¸”ë™ë°•ìŠ¤ íŒŒì¼ì— ì“°ê¸° ê¶Œí•œì´ ìˆëŠ”ì§€ ì¦‰ì‹œ ì²´í¬í•©ë‹ˆë‹¤.
 */
(function checkSystemIntegrity() {
    try {
        var logDir = new java.io.File(BASE_DIR);
        if (!logDir.exists()) logDir.mkdirs();

        var testFile = new java.io.File(JOURNAL_PATH);
        var isWritable = testFile.exists() ? testFile.canWrite() : logDir.canWrite();
        
        if (!isWritable) {
            // [êµì •] ë¡œê·¸ ê¸°ë¡ ì‹¤íŒ¨ ì‹œ ê´€ë¦¬ì ë°©ìœ¼ë¡œ ì¦‰ì‹œ ì¹´í†¡ ë°œì†¡
            var alertMsg = "ğŸš¨ [ë³´ì•ˆ ìœ„ê¸°] ë¸”ë™ë°•ìŠ¤ ë¡œê·¸ ì“°ê¸° ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.\nì‹œìŠ¤í…œ ë³µêµ¬ê°€ ë¶ˆê°€ëŠ¥í•  ìˆ˜ ìˆìœ¼ë‹ˆ ì €ì¥ì†Œ ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.";
            Log.error(alertMsg);
            try { Api.replyRoom("ë² ë¦­ë°©", alertMsg); } catch(e) {}
        } else {
            Log.info("âœ… [ë³´ì•ˆ ê°€ë™] ë¸”ë™ë°•ìŠ¤ ë¬´ê²°ì„± ê²€ì‚¬ í†µê³¼.");
            // ì„ íƒì‚¬í•­: ê°€ë™ ì„±ê³µ ì‹œì—ë„ ì•Œë¦¼ì„ ë°›ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì£¼ì„ì„ í•´ì œí•˜ì„¸ìš”.
            // try { Api.replyRoom("ë² ë¦­ë°©", "âœ… ë¸”ë™ë°•ìŠ¤ ê¸°ë¡ ì¥ì¹˜ê°€ ì •ìƒ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤."); } catch(e) {}
        }
    } catch (e) {
        Log.error("Integrity Check Error: " + e);
    }
})();

/* [ìµœì í™”] ì „ì—­ UID ìºì‹œ ì‹œìŠ¤í…œ */
var uidCache = uidCache || {}; 

/* [í•˜ì´ë¸Œë¦¬ë“œ ì—”ì§„] ë³‘ë ¬ ìˆ˜ì‹  ë° ìˆœì°¨ ì²˜ë¦¬ ì—”ì§„ ë¶„ë¦¬ */
// 1. ë³‘ë ¬ ìˆ˜ì‹  ì—”ì§„: 8ê°œì˜ ìŠ¤ë ˆë“œê°€ ë©”ì‹œì§€ë¥¼ ì¦‰ì‹œ ì ‘ìˆ˜ (ì‘ë‹µ ì†ë„ ë‹´ë‹¹)
var ParallelPool = java.util.concurrent.Executors.newFixedThreadPool(8);
// 2. ìˆœì°¨ ì²˜ë¦¬ ì—”ì§„: ë‹¨ 1ê°œì˜ íê°€ ë¡œì§ ë° ë‹µì¥ì„ ìˆœì„œëŒ€ë¡œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬ (ë°ì´í„° ë¬´ê²°ì„± ë‹´ë‹¹)
var LogicQueue = java.util.concurrent.Executors.newSingleThreadExecutor();
// 3. ì¼ë°˜ ë°±ê·¸ë¼ìš´ë“œ ì‘ì—…ìš© ì—”ì§„ (ë””ìŠ¤ì½”ë“œ/ëŒ€ì‹œë³´ë“œ ì „ìš©) */
var Executor = java.util.concurrent.Executors.newCachedThreadPool();
// 4. ë°±ê·¸ë¼ìš´ë“œ ì €ì¥ ì—”ì§„: ë¬´ê±°ìš´ íŒŒì¼ ì“°ê¸° ì „ìš©
var SaveExecutor = java.util.concurrent.Executors.newSingleThreadExecutor();

/* ë¡œê·¸ ì €ì¥ ê²½ë¡œ ë° ë””ë ‰í† ë¦¬ ì„¤ì • */ 
var BUG_LOG_PATH = BASE_DIR + "logs/bug_report.txt"; 
var ERROR_LOG_PATH = BASE_DIR + "logs/error_log.txt"; 
var logDir = new java.io.File(BASE_DIR + "logs/"); 
if (!logDir.exists()) logDir.mkdirs(); 
var dir = new java.io.File(BACKUP_DIR); 
if (!dir.exists()) dir.mkdirs(); 

/* ì „ì—­ ìƒíƒœ ë³€ìˆ˜ */ 
if (typeof globalData === 'undefined' || globalData === null) {
    var globalData = { rooms: {}, botActive: true }; 
}

/* [ì•ˆì •í™”] í•µì‹¬ ê²Œì„ ì—”ì§„ ë° ìƒíƒœ ì°¸ì¡° ì „ì—­ ì„ ì–¸ */
var racingData = null;      // ê²½ë§ˆ ì‹¤ì‹œê°„ ë°ì´í„° ì°¸ì¡°ìš©
var lotto = null;           // ë¡œë˜ ì‹¤ì‹œê°„ ë°ì´í„° ì°¸ì¡°ìš©
var marketOpenPrice = globalData.marketOpenPrice || 0;    // ëœë“œë§ˆí¬ ì‹œê°€ ì°¸ì¡°ìš©
var sprinkleData = {};      // ë¿Œë¦¬ê¸° ìƒíƒœ ì°¸ì¡°ìš©
var _msgReceiveTime = 0;    // [ì‹ ê·œ] ì‘ë‹µì†ë„ ì¸¡ì •ì„ ìœ„í•œ ì „ì—­ íƒ€ì„ìŠ¤íƒ¬í”„

/* [ì•ˆì •í™”] ì…ë ¥ ëŒ€ê¸° ë° í™œë™ ìƒíƒœ ë³€ìˆ˜ ì´ˆê¸° ì„ ì–¸ */
var menuWaitState = {};
var bankProcessState = {};
var selectWaitState = {};
var lottoPurchaseState = {};
var activeThefts = {};
var duelData = {};
var miningState = {};
var loanRegisterState = {};
var loanContractWaitState = {};


/**
 * [ê°œí¸] ë¬´ì—­ êµ­ê°€ë³„ ê³ ì • ìƒì‚° í’ˆëª© ë° íŠ¹ì‚°í’ˆ ë§¤í•‘ (ìˆœí™˜ ë§¤ì¹­ ì—”ì§„ìš©)
 * ì„¤ëª…: ê° êµ­ê°€ì˜ ìêµ­ ìƒì‚°ë¬¼ì„ ì •ì˜í•˜ë©°, ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ì´ë¥¼ ì œì™¸í•œ í’ˆëª©ì„ ì„ í˜¸/ê¸°í”¼ë¡œ ë°°ì •í•©ë‹ˆë‹¤.
 */
var TRADE_RELATION = {
    "ë…¸ë¥´ë”•": { produce: "ì‹ë£Œí’ˆ", set: "ë§Œë…„ì„¤ì‚¼" },
    "ìƒ¹ê·¸ë¦´ë¼": { produce: "ê³µì˜ˆí’ˆ", set: "ê³ ëŒ€ì°»ì" },
    "ë¸Œë¦¬íƒ€ë‹ˆì•„": { produce: "ê³µì—…í’ˆ", set: "ì¦ê¸°ê¸°ê´€ë¶€í’ˆ" },
    "ì—˜ë„ë¼ë„": { produce: "ë³´ì„", set: "í™©ê¸ˆì¡°ê°ìƒ" },
    "ì‚¬ë§‰ì˜ë³„": { produce: "ê·€ê¸ˆì†", set: "ì˜¤ì•„ì‹œìŠ¤ìˆ˜ì •" }
};

/**
 * [Gemini ìš”ì²­ ì‚¬í•­] ë°©ë³„ ë…ë¦½í™”ë¥¼ ìœ„í•œ ë°ì´í„° í…œí”Œë¦¿
 * ì„¤ëª…: ì•„ë˜ì˜ êµ¬ì¡°ê°€ ê° ë°©(Room)ì´ ìƒì„±ë  ë•Œë§ˆë‹¤ ë…ë¦½ì ìœ¼ë¡œ ë³µì œë˜ì–´ í• ë‹¹ë©ë‹ˆë‹¤.
 */
var ROOM_FEATURE_TEMPLATE = function() {
    return {
        /* [Gemini ìš”ì²­ ì‚¬í•­] ê²½ë§ˆ ì‹œìŠ¤í…œ ì‹¤ì‹œê°„ ìƒíƒœ ë° ìƒìˆ˜ ì„¤ëª… í†µí•© */
        racing: {
            round: 1,           // [íšŒì°¨]: ê²½ë§ˆì˜ ì§„í–‰ ì°¨ìˆ˜ë¥¼ ê¸°ë¡ (ë´‡ ì¬ì‹œì‘ ì‹œ 1ë¡œ ì´ˆê¸°í™”ë¨)
            horses: [           // [ì¶œì „ë§ˆ ì •ë³´]: ê° ë§ì˜ ê³ ìœ  ID, ì´ë¦„, ìš°ìŠ¹ ê°€ì¤‘ì¹˜(weight), ìƒíƒœ ì•„ì´ì½˜ ì €ì¥
                { id: 1, name: "ì–´ë§ˆì–´ë§ˆ", weight: 1.0, icon: "â˜ï¸ ë³´í†µ" },
                { id: 2, name: "ì–´ì„œë§ì„í•´", weight: 1.0, icon: "â˜ï¸ ë³´í†µ" },
                { id: 3, name: "ë§ˆì˜ì›¨ì´", weight: 1.0, icon: "â˜ï¸ ë³´í†µ" },
                { id: 4, name: "í•µíƒ„ë‘", weight: 1.0, icon: "â˜ï¸ ë³´í†µ" },
                { id: 5, name: "ëŒê²©ì•ìœ¼ë¡œ", weight: 1.0, icon: "â˜ï¸ ë³´í†µ" }
            ],
            bets: {},           // [ë°°íŒ… ê¸°ë¡]: { UID: {horseId, amount, name} } í˜•ì‹ìœ¼ë¡œ í˜„ì¬ íšŒì°¨ ë°°íŒ… ì •ë³´ë¥¼ ì €ì¥
            totalPool: 0,       // [ë‹¹ê¸° ëˆ„ì ê¸ˆ]: ì´ë²ˆ íšŒì°¨ì— ìœ ì €ë“¤ì´ ë°°íŒ…í•œ ìˆœìˆ˜ í¬ì¸íŠ¸ í•©ê³„
            carryOver: 0,       // [ì´ì›”ê¸ˆ/Jackpot]: ì´ì „ íšŒì°¨ì—ì„œ ë‹¹ì²¨ìê°€ ì—†ì–´ ë„˜ì–´ì˜¨ í¬ì¸íŠ¸ (70% ë¹„ìœ¨ ì ìš©ì•¡)
            // [ìš´ì˜ í”Œë˜ê·¸]: ë´‡ ë¡œë“œ ì‹œ í˜„ì¬ ì‹œê°„ì„ ì¦‰ì‹œ íŒë³„í•˜ì—¬ 09:00~23:59 ì‚¬ì´ë©´ ìë™ìœ¼ë¡œ ê°€ë™ ìƒíƒœ(true)ë¡œ ì„¤ì •
            isOperating: (function() {
                var h = new Date().getHours();
                return h >= 9 && h <= 23; 
            })(),
            isDeadlineNotified: false, // [ì•Œë¦¼ ì œì–´]: 49ë¶„ 59ì´ˆ ë§ˆê° ê³µì§€ê°€ ì¤‘ë³µ ë°œì†¡ë˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ëŠ” ìŠ¤ìœ„ì¹˜
            isResultProcessed: false   // [ì •ì‚° ì œì–´]: ì •ê°(00ë¶„) ê²°ê³¼ ì •ì‚° ë¡œì§ì´ ì¤‘ë³µ ì‹¤í–‰ë˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ëŠ” ìŠ¤ìœ„ì¹˜
        },

        /* ë°©ë³„ ëœë“œë§ˆí¬ ì‹œì¥ ë° ê¸°íƒ€ ë°ì´í„° */
        stockMarket: {},
        stockTraffic: {},
        marketOpenPrice: 0,
        sprinkleData: { active: false, winners: [], portions: [] },
        lotto: { round: 1, entries: {}, dailyPool: 0, jackpot: 0, lastWinNums: [] },

        msgCount: 0,

        government: {
            activePolicy: { // í˜„ì¬ ì‹œí–‰ ì¤‘ì¸ ì •ì±… ë°°ìœ¨ (ê¸°ë³¸ê°’)
                stockTax: 0.05,
                mineMult: 1.0,
                attendMult: 1.0,
                loanLimitMult: 1.0,
                bankInterest: 0.02,
                theftFineMult: 1.0,
                policeProbAdj: 0.0
            },
            pendingBill: null,   // ì˜¤ëŠ˜ ë°œì˜ëœ ì•ˆê±´ ë°ì´í„°
            votes: { pro: 0, con: 0, voters: [] }, // íˆ¬í‘œ ê°€ì¤‘ì¹˜ í•© ë° ì°¸ì—¬ì ëª…ë‹¨
            lastBillDate: "",
            resultStatus: null,
            isClosing: false
        },

        /* ë°©ë³„ ë…ë¦½ ì…ë ¥ ëŒ€ê¸° ìƒíƒœ */
        states: {
            menuWait: {}, bankProcess: {}, selectWait: {}, lottoPurchase: {},
            activeThefts: {}, duelData: {}, mining: {},
            loanRegister: {}, loanContractWait: {}
        }
    };
};

/* ê´€ë¦¬ì UID ê¸°ë°˜ ì¸ì¦ */ 
var adminUIDs = ["fixed-uuid-3873df88-0533-4647-99c8-8a4b0bde6da3", "fixed-uuid-ê´€ë¦¬ì2"]; 

/* ì‹œìŠ¤í…œ í•µì‹¬ ìƒìˆ˜ ì„¤ì • */
var SYSTEM_CONFIG = {

    TRADE: {
        PRICE_CYCLE_MIN: 60,        // ì‹œì„¸ ë³€ë™ ì£¼ê¸° (60ë¶„)

        GOODS_COST: {
            "ì‹ë£Œí’ˆ": 10000,
            "ê³µì—…í’ˆ": 15000,
            "ê³µì˜ˆí’ˆ": 20000,
            "ê·€ê¸ˆì†": 25000,
            "ë³´ì„": 30000
        },

        NATIONS: {
            "ë¸Œë¦¬íƒ€ë‹ˆì•„": { favorite: "", hate: "", specialty: "ì¦ê¸°ê¸°ê´€ë¶€í’ˆ" },
            "ìƒ¹ê·¸ë¦´ë¼": { favorite: "", hate: "", specialty: "ê³ ëŒ€ì°»ì" },
            "ì—˜ë„ë¼ë„": { favorite: "", hate: "", specialty: "í™©ê¸ˆì¡°ê°ìƒ" },
            "ë…¸ë¥´ë”•": { favorite: "", hate: "", specialty: "ë§Œë…„ì„¤ì‚¼" },
            "ì‚¬ë§‰ì˜ë³„": { favorite: "", hate: "", specialty: "ì˜¤ì•„ì‹œìŠ¤ìˆ˜ì •" }
        },
        SHIPS: {
            1: { name: "ì¹´ë¼ë²¨", capacity: 10, speedMult: 1.0, upgradeCost: 0 },
            2: { name: "í”„ë¦¬ê¹ƒ", capacity: 25, speedMult: 0.75, upgradeCost: 1000000 },
            3: { name: "ê°¤ë¦¬ì˜¨", capacity: 40, speedMult: 0.5, upgradeCost: 2000000 }
        },
        EVENTS: {
            PROB: 0.25,             // ë¬´ì—­ ì •ì‚° ì‹œ ì´ë²¤íŠ¸ ë°œìƒ ì´ í™•ë¥  (25%)
            LIST: {
                STORM: { name: "í­í’ìš°", penalty: 0.15, msg: "ğŸŒŠ í­í’ìš°ë¥¼ ë§Œë‚˜ ì„ ì²´ê°€ íŒŒì†ë˜ì—ˆìŠµë‹ˆë‹¤! (ìˆ˜ë¦¬ë¹„ ì§€ì¶œ)" },
                FIRE: { name: "í™”ì¬", penalty: 0.2, target: ["ì‹ë£Œí’ˆ", "ê³µì˜ˆí’ˆ"], msg: "ğŸ”¥ ì°½ê³ ì— í™”ì¬ê°€ ë°œìƒí•˜ì—¬ ì ì¬ë¬¼ì´ ì „ì†Œë˜ì—ˆìŠµë‹ˆë‹¤!" },
                CORROSION: { name: "ë¶€ì‹", penalty: 0.2, target: ["ê³µì—…í’ˆ", "ê·€ê¸ˆì†"], msg: "ğŸ§ª ì†Œê¸ˆë¬¼ì— í™”ë¬¼ì´ ë¶€ì‹ë˜ì–´ ê°€ì¹˜ê°€ í•˜ë½í–ˆìŠµë‹ˆë‹¤!" },
                PIRACY: { name: "í•´ì ìŠµê²©", penalty: 0.3, msg: "ğŸ´â€â˜ ï¸ í•´ì ì—ê²Œ ìŠµê²©ë‹¹í•´ ë¬´ì—­ ëŒ€ê¸ˆì˜ ì¼ë¶€ë¥¼ ì•½íƒˆë‹¹í–ˆìŠµë‹ˆë‹¤!" },
                SMOOTH: { name: "ìˆœí•­", boost: 0.2, msg: "ğŸŒ¬ï¸ ìˆœí’ì„ íƒ€ê³  ì˜ˆì •ë³´ë‹¤ ë¹ ë¥´ê²Œ ë„ì°©í–ˆìŠµë‹ˆë‹¤!" }
            }
        },
        GOODS: ["ì‹ë£Œí’ˆ", "ê³µì˜ˆí’ˆ", "ê³µì—…í’ˆ", "ê·€ê¸ˆì†", "ë³´ì„"],
        BASE_PRICE: 10000,
        SPECIALTY_COST: {
            "ì‹ë£Œí’ˆ": 10000,
            "ê³µì—…í’ˆ": 15000,
            "ê³µì˜ˆí’ˆ": 20000,
            "ê·€ê¸ˆì†": 25000,
            "ë³´ì„": 30000
        },
        BASE_TAX: 0.1,
        MAX_TAX: 0.10,
        SPECIALTY_CHANCE: 0.50,
        SPECIALTY_PROFIT: 3.0
    },

    /**
         * [ì‹ ê·œ] í’ˆëª©ë³„ ì°¨ë“± ìˆ˜ìµë¥  ë§¤íŠ¸ë¦­ìŠ¤
         * - ì„ í˜¸(pref): ì‹ë£Œí’ˆì€ ë†’ê²Œ(1.28), ë³´ì„ì€ ë‚®ê²Œ(1.19) ì„¤ì •í•˜ì—¬ ë°¸ëŸ°ìŠ¤ ì¡°ì •
         * - ì¼ë°˜(norm): ì„¸ê¸ˆ ê³ ë ¤ ì‹œ ì•½ì†Œí•œ ì´ë“ í˜¹ì€ ë³¸ì „ (1.05)
         * - ê¸°í”¼(hate): ê°•ë ¥í•œ ì†ì‹¤ ë¶€ì—¬ (0.8)
         */
        PROFIT_RATES: {
            "ì‹ë£Œí’ˆ": { pref: 1.34, norm: 1.08, hate: 0.8 }, 
            "ê³µì—…í’ˆ": { pref: 1.27, norm: 1.08, hate: 0.8 },
            "ê³µì˜ˆí’ˆ": { pref: 1.25, norm: 1.05, hate: 0.8 },
            "ê·€ê¸ˆì†": { pref: 1.24, norm: 1.05, hate: 0.8 },
            "ë³´ì„":   { pref: 1.23, norm: 1.05, hate: 0.8 }
        },

    MANIPULATION: {
        DEFAULT_GAMBLE: 65, // í™€ì§(ì‚¬ë‹¤ë¦¬/ë°”ì¹´ë¼) ì ì¤‘ ë³´ì •ì¹˜
        DEFAULT_FISH: 40,   // ë‚šì‹œ ë†’ì€ ë“±ê¸‰ ë‚šì„ ë³´ì •ì¹˜
        DEFAULT_RACING: 5,  // ê²½ë§ˆ ìš°ìŠ¹ ê°€ì¤‘ì¹˜ ë³´ë„ˆìŠ¤
        DEFAULT_SPITTO: 65, // ìŠ¤í”¼ë˜ ë‹¹ì²¨ ë³´ì •ì¹˜
        MAX_RATE: 100,
        MIN_RATE: 0
    },

    ECO: {

        /* [v11.9.24] ë°°ë‹¹ ì£¼ë¨¸ë‹ˆ ì ë¦½ ë°°ìœ¨ (ì‚¬ìš©ì•ˆ) */
        ACTIVITY_ACCUM_RATES: {
            MINE: 0,
            FISH: 0,
            CASINO: 0,
            BANK: 0,
            SHOP: 0,
            RACING: 0
        },

        /* [Gemini ìš”ì²­ ì‚¬í•­] ì‹œê°„ ê¸°ë°˜ í™•ì • ë°°ë‹¹ ì‹œìŠ¤í…œ ì„¤ì • */
        HOURLY_DIVIDEND: 10000,           // ì‹œê°„ë‹¹ ê¸°ë³¸ ë°°ë‹¹ê¸ˆ (10,000P)
        DIVIDEND_BONUS_THRESHOLD: 10,     // ì§€ë¶„ ë³´ë„ˆìŠ¤ ì‹œì‘ ì„ê³„ê°’ (10ì§€ë¶„)
        DIVIDEND_BONUS_RATE: 0.1,         // ì´ˆê³¼ 1ì§€ë¶„ë‹¹ ê°€ì‚° ë°°ìœ¨ (10%)

        /* [ê¸°ì´ˆ ê²½ì œ ì„¤ì •] */
        ATTEND_MIN: 8000, // [ì¶œì„ ìµœì†Œ ì§€ê¸‰]: í•˜í•œì„  8,000P
        ATTEND_MAX: 10000, // [ì¶œì„ ìµœëŒ€ ì§€ê¸‰]: ìƒí•œì„  10,000P
        GAMBLE_MIN: 2000,  // [ë„ë°• ìµœì†Œ ë² íŒ…]: 2,000P
        GAMBLE_MAX: 50000, // [ë„ë°• ìµœëŒ€ ë² íŒ…]: 50,000P (ì‚¬í–‰ì„± ì–µì œ)

        /* [ì‹ ê·œ] ìŠ¤í”¼ë˜ ë° ìƒì‚°í˜• ì»¨í…ì¸  ì„¤ì • */
        SPITTO: {
            PRICE: 2000,           // ë³µê¶Œ ê°€ê²©
            RTP: 0.855,              // ê¸°ëŒ€ ìˆ˜ìµë¥  (85.5%)
            PROBS: {
                RANK1: 0.0005,     // 1ë“± í™•ë¥  (0.05%)
                RANK2: 0.02,       // 2ë“± í™•ë¥  (2%)
                RANK3: 0.15,       // 3ë“± í™•ë¥  (15%)
                RANK4: 0.55         // 4ë“± í™•ë¥  (55%)
            },
            PRIZES: {
                RANK1: 500000,     // 1ë“± ìƒê¸ˆ
                RANK2: 25000,      // 2ë“± ìƒê¸ˆ
                RANK3: 5000,       // 3ë“± ìƒê¸ˆ
                RANK4: 1000         // 4ë“± ìƒê¸ˆ
            }
        },
        FISHING: {
            COOLDOWN: 600000,      // ì¿¨íƒ€ì„ (10ë¶„ = 600,000ms)
            MIN_REWARD: 500,       // ìµœì†Œ ë³´ìƒ
            MAX_REWARD: 1500,       // ìµœëŒ€ ë³´ìƒ
            FAIL_PROB: 0.05,         // ê½ í™•ë¥  (5%)
            ARTIFACT_CHANCE: 0.005  // [ì‹ ê·œ] ìœ ë¬¼ ì¡°ê° ë°œê²¬ í™•ë¥  (0.5%)
        },
        
        /* [ì‹ ê·œ] ì¤‘ì•™ì€í–‰ ì§€ê¸‰ì¤€ë¹„ì œë„ ì„¤ì • */
        BANK: {
            RESERVE_RATIO: 0.20, // [ì§€ê¸‰ì¤€ë¹„ìœ¨]: ì€í–‰ ì´ ì˜ˆê¸ˆì•¡ ì¤‘ ëŒ€ì¶œí•´ì¤„ ìˆ˜ ì—†ëŠ” ìµœì†Œ í˜„ê¸ˆ ë³´ìœ  ë¹„ì¤‘ (20%)
            INITIAL_RESERVE: 10000, // [ì´ˆê¸° ì¬ì›]: ë°ì´í„° ì´ˆê¸°í™” ì‹œ ì€í–‰ ê¸ˆê³ ì— ê¸°ë³¸ìœ¼ë¡œ ë“¤ì–´ìˆëŠ” í¬ì¸íŠ¸
            INTEREST_RATE: 0.02,  // [ë§¤ì¼ ì´ììœ¨] 0.02 = 2%, 0.05 = 5% (ì›í•˜ì‹œëŠ” ìˆ˜ì¹˜ë¡œ ë³€ê²½í•˜ì„¸ìš”)
            /* [ì§€ëŠ¥í˜• íƒ„ë ¥ ê¸ˆë¦¬ ì„¤ì •] */
            MIN_MULTIPLIER: 0.5,  // ê¸ˆë¦¬ í•˜í•œ ìŠ¹ìˆ˜ (0.5ë°°)
            MAX_MULTIPLIER: 3.0,  // ê¸ˆë¦¬ ìƒí•œ ìŠ¹ìˆ˜ (3.0ë°°)
            TARGET_RESERVE_RATIO: 0.1 // ì ì • êµ­ê³  ìœ ì§€ ë¹„ìœ¨ (ê²½ì œ ê¸°ì¤€ì ì˜ 10%)
        },

        /* [ì‹ ê·œ] ê²½ë§ˆ ì‹œìŠ¤í…œ ì„¸ë¶€ ì„¤ì • ìƒìˆ  */
        RACING: {
            MIN_BET: 10000,       // [ìµœì†Œ ë°°íŒ…ì•¡]: ê²½ë§ˆ ì°¸ì—¬ë¥¼ ìœ„í•œ ìµœì†Œ í¬ì¸íŠ¸
            MAX_BET: 30000,      // [ìµœëŒ€ ë°°íŒ…ì•¡]: í•œ íšŒì°¨ì— ê±¸ ìˆ˜ ìˆëŠ” ìµœëŒ€ í¬ì¸íŠ¸ ìƒí•œì„ 
            TAX_RATE: 0.1,       // [ê¸°ë³¸ ìˆ˜ìˆ˜ë£Œ]: ë‹¹ì²¨ê¸ˆ ì •ì‚° ì „ ì „ì²´ íŒëˆì—ì„œ êµ­ê³ ë¡œ í™˜ìˆ˜ë˜ëŠ” ë¹„ìœ¨ (10%)
            CANCEL_FEE: 0.1,     // [ì·¨ì†Œ ìœ„ì•½ê¸ˆ]: ë°°íŒ… ì·¨ì†Œ ì‹œ ì›ê¸ˆì—ì„œ ì°¨ê°ë˜ì–´ êµ­ê³ ë¡œ ê·€ì†ë˜ëŠ” ìˆ˜ìˆ˜ë£Œ (10%)
            WINLESS_BANK_RATE: 0.3,   // [ë¬´ìŠ¹ì êµ­ê³ í–‰]: ìš°ìŠ¹ì ì—†ì„ ì‹œ íŒëˆì˜ 30%ë¥¼ ì€í–‰ ê¸ˆê³ ë¡œ ì¦‰ì‹œ íšŒìˆ˜
            WINLESS_JACKPOT_RATE: 0.7, // [ë¬´ìŠ¹ì ì´ì›”ì•¡]: ìš°ìŠ¹ì ì—†ì„ ì‹œ íŒëˆì˜ 70%ë¥¼ ë‹¤ìŒ íšŒì°¨ carryOverë¡œ ëˆ„ì 
            OPEN_HOUR: 9,        // ê²½ë§ˆì¥ ìë™ ê°œì¥ ì‹œê° (ì˜¤ì „ 9ì‹œ)
            CLOSE_HOUR: 23,       // ê²½ë§ˆì¥ ë§ˆì§€ë§‰ ë°°íŒ… ë§ˆê° ì‹œê° (ì˜¤í›„ 11ì‹œ 59ë¶„)
            MAX_PAYOUT_MULT: 7   // [ë°°ë‹¹ ê¸°ì¤€ì ]: ë‹¹ì²¨ ì‹œ ì§€ê¸‰ë˜ëŠ” ê³ ì • ë°°ìœ¨ (í˜„ì¬ 7ë°° ê³ ì • ì§€ê¸‰)
        },
        
        /* [ê°œí¸] ëœë“œë§ˆí¬ ë¶€ë™ì‚° ì‹œìŠ¤í…œ ì„¤ì • */
        LANDMARK: {
            PREFIXES: ["ì„œìš¸", "ë‰´ìš•", "íŒŒë¦¬", "ë„ì¿„", "ë‘ë°”ì´", "ëŸ°ë˜", "ë¡œë§ˆ", "ë² ë¥¼ë¦°", "ì‹œë“œë‹ˆ", "ê´‘í™”ë¬¸", "ê°•ë‚¨", "í•´ìš´ëŒ€", "íŒêµ", "ì„±ìˆ˜"], 
            SUFFIXES: ["ë¹Œë”©", "íƒ€ì›Œ", "ìŠ¤í€˜ì–´", "íŒ°ë¦¬ìŠ¤", "ì„¼í„°", "ì•„ë ˆë‚˜", "ë®¤ì§€ì—„", "íŒŒí¬", "ê°€ë“ ", "ì•„í‹€ë¦¬ì—", "ìŠ¤í…Œì´ì…˜", "ë¼ì´ë¸ŒëŸ¬ë¦¬"], 
            TRAITS: { 
                "normal": { label: "ëœë“œë§ˆí¬", volatility: 0.5, prob: 44, icon: "ğŸ¢" },
                "bluechip": { label: "ë¹„ì¦ˆë‹ˆìŠ¤íƒ€ì›Œ", volatility: 1, prob: 28, icon: "ğŸ¨" },
                "hotspot": { label: "ìƒê°€", volatility: 1.8, prob: 28, icon: "ğŸšï¸" }
            },

           /* [Gemini] ëœë“œë§ˆí¬ ê³ ì •ê°€ ë° ì§€ë¶„ ìƒìŠ¹ ì •ì±… */
Â  Â  Â  Â  Â  Â  FIXED_POLICY: {
Â  Â  Â  Â  Â  Â  Â  Â  BASE_PRICE: 200000,Â  Â // 0ì§€ë¶„ ê¸°ì¤€ ê¸°ë³¸ê°€
Â  Â  Â  Â  Â  Â  Â  Â  PER_SHARE_RATE: 0.05Â  // 1ì§€ë¶„ë‹¹ ìƒìŠ¹ë¥  (5%)
Â  Â  Â  Â  Â  Â  },

            MANIPULATION: { 
                TARGET: "ì„œìš¸íƒ€ì›Œ", 
                IS_UP: true,       
                RATE: 0.25,        
                ACTIVE: false      
            },
            SETTINGS: { 
                MAX_COUNT: 10,     // ë¶€ë™ì‚° ë§¤ë¬¼ ìµœëŒ€ìˆ˜
                OPEN_HOUR: 7,      
                CLOSE_HOUR: 23,    
                MANI_RATE: 0.25,   
                DELIST_LIMIT: 0.001, // ê²½ë§¤(ìƒí) ìœ„ê¸° ê¸°ì¤€
                ABS_DELIST_LIMIT: 10000, 
                CLOSING_LIMIT: 0.40, 
                RESISTANCE_START: 0.20, 
                GRAVITY: 0.18      
            }
        },

        MINE: { // [ê´‘ì‚° ì±„êµ´ ì„¤ì •]
            BASE_PER_MIN: 40, // ë¶„ë‹¹ íšë“í•˜ëŠ” ê¸°ë³¸ ì±„êµ´ í¬ì¸íŠ¸ (ë¬¼ê°€ ë°°ìœ¨ ì ìš© ì „)
            COPPER_PROB: 0.06, // êµ¬ë¦¬ ë°œê²¬ í™•ë¥  (6%)
            GOLD_PROB: 0.035,   // ê¸ˆ ë°œê²¬ í™•ë¥  (3.5%)
            DIA_PROB: 0.008,   // ë‹¤ì´ì•„ëª¬ë“œ ë°œê²¬ í™•ë¥  (0.8%)
            COPPER_MULT: 3.0,  // êµ¬ë¦¬ ë°œê²¬ ì‹œ ìˆ˜ìµ ë°°ìœ¨
            GOLD_MULT: 7.0,    // ê¸ˆ ë°œê²¬ ì‹œ ìˆ˜ìµ ë°°ìœ¨
            DIA_MULT: 20.0,    // ë‹¤ì´ì•„ëª¬ë“œ ë°œê²¬ ì‹œ ìˆ˜ìµ ë°°ìœ¨
            ARTIFACT_CHANCE: 0.002, // [ìœ ë¬¼ ì¡°ê°]: ë§¤ ë¶„ë§ˆë‹¤ ìœ ë¬¼ì„ ì°¾ì„ í™•ë¥  (0.1%)
            ARTIFACT_GOAL: 50  // [ë„êµ´ì™• ì¹­í˜¸]: ìœ ë¬¼ ì¡°ê°ì„ ì´ ê°¯ìˆ˜ë§Œí¼ ëª¨ìœ¼ë©´ ìë™ ë¶€ì—¬
        },
        PRIVATE_LOAN: { // [ì‚¬ì±„(P2P) ì‹œì¥ ì„¤ì •]
            MIN_AMOUNT: 10000,       // ì‚¬ì±„ ë§¤ë¬¼ ë“±ë¡ ì‹œ ìµœì†Œ ë‹¨ìœ„
            MAX_RATE: 15,           // ë²•ì • ìµœê³  ì´ìœ¨ (3ì‹œê°„ë‹¹ ìµœëŒ€ 15%)
            COLLECTION_LIMIT: 24,   // [ì¶”ì‹¬ ì‹œì‘]: ëŒ€ì¶œ í›„ 24ì‹œê°„ ê²½ê³¼ ì‹œ ìˆ˜ìµ ì••ë¥˜(50%) ì‹œì‘
            INTEREST_PERIOD: 3,     // ì´ìê°€ ë³µë¦¬ë¡œ ê³„ì‚°ë˜ì–´ ë¶™ëŠ” ì£¼ê¸° (3ì‹œê°„)
            MIN_BORROW: 5000,       // ìœ ì €ê°€ ì‚¬ì±„ë¥¼ ë¹Œë¦´ ë•Œ ìµœì†Œ ë‹¨ìœ„
            DAILY_LIMIT: 1          // ì€í–‰ ëŒ€ì¶œ ì¼ì¼ ì´ìš© ì œí•œ íšŸìˆ˜
        },
        CREDIT: { // [ì€í–‰ ì‹ ìš© ë“±ê¸‰ ì²´ê³„]
            SCORES: [900, 800, 700, 600, 500], // ê° ë“±ê¸‰ì„ ë‚˜ëˆ„ëŠ” ê¸°ì¤€ ì ìˆ˜
            LIMITS: [1000000, 800000, 600000, 500000, 400000, 300000], // ë“±ê¸‰ë³„ ëŒ€ì¶œ ê°€ëŠ¥ í•œë„
            RATES: [1.014, 1.025, 1.05, 1.09, 1.14, 1.18], // ë“±ê¸‰ë³„ ê¸°ë³¸ ì´ìœ¨ (ì‹œì¥ ìŠ¹ìˆ˜ì™€ ì—°ë™ë˜ì–´ ìµœì¢… ì‚°ì¶œë¨)
            LABELS: ["1ë“±ê¸‰", "2ë“±ê¸‰", "3ë“±ê¸‰", "4ë“±ê¸‰", "5ë“±ê¸‰", "ì‹ ìš©ë¶ˆëŸ‰ì"], 
            ICONS: ["ğŸ‘‘", "ğŸ’", "ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰", "ğŸš«"] 
        }
    },

BACKUP: {
        // ì—¬ê¸°ì— ë³¸ì¸ì˜ ë””ìŠ¤ì½”ë“œ ì›¹í›„í¬ URLì„ ì…ë ¥í•˜ì„¸ìš”. (ë”°ì˜´í‘œ í•„ìˆ˜)
        DISCORD_WEBHOOK_URL: "https://discord.com/api/webhooks/1466005811594793000/LUVyScCaI88gKz4SxMUSOniTi890hRNVGvGn1SC_FoNhYU5Vy7bZD9PpjSF0mQHRUMUq"
    },

    SPAM: { // [ë„ë°° ë°©ì§€ ì—”ì§„ ì„¤ì •]
        LIMIT_COUNT: 5,        // ì œí•œ ì‹œê°„ ë‚´ í—ˆìš©ë˜ëŠ” ìµœëŒ€ ë©”ì‹œì§€ ìˆ˜
        LIMIT_WINDOW: 3000,    // ë„ë°° íŒì • ì‹œê°„ ë²”ìœ„ (3000ms = 3ì´ˆ)
        TIMEOUT_MS: 300000     // ë„ë°° ì ë°œ ì‹œ ë´‡ ì´ìš©ì´ ì œí•œë˜ëŠ” ì‹œê°„ (5ë¶„)
    },

    PROB: { // [í•µì‹¬ ê²Œì„ í™•ë¥  ì—”ì§„]
        ODD_EVEN_WIN: 0.45,        // í™€ì§ ê¸°ë³¸ ìŠ¹ë¥  (45%)
        ODD_EVEN_PAYOUT: 0.90,     // í™€ì§ ê¸°ë³¸ ë°°ë‹¹ë¥  (ì‚¬ìš©ì ì •ì˜)
        ODD_EVEN_FEVER: 0.50,      // í”¼ë²„íƒ€ì„ ì‹œ í™€ì§ ê¸°ë³¸ ìŠ¹ë¥  (50%)
        STOCK_NEW_LISTING: 0.8,    // ë§¤ ë³€ë™ íƒ€ì„ë§ˆë‹¤ ì‹ ê·œ ì¢…ëª©ì´ ìƒì¥ë  í™•ë¥  (50%)
        STOCK_SPECIAL: 0.5,        // íŠ¹ì • ì¢…ëª©ì— íŠ¹ìˆ˜ ì´ë²¤íŠ¸(í­ë“±/í­ë½)ê°€ ë°œìƒí•  í™•ë¥  (50%)
        STOCK_UP_CHANCE: 0.45      // íŠ¹ìˆ˜ ì´ë²¤íŠ¸ ë°œìƒ ì‹œ 'ìƒìŠ¹'ì¼ í™•ë¥  (45%, í•˜ë½ì´ ì¡°ê¸ˆ ë” ë†’ìŒ)
    },
    
    MSG: { // [ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì„¤ì •]
        PREFIX: {
            INFO: "â„¹ï¸", ERROR: "ğŸš«", ADMIN: "âš™ï¸", SUCCESS: "âœ…", 
            WARN: "âš ï¸", GAMBLE_WIN: "ğŸŠ", GAMBLE_LOSE: "ğŸ’€", LOAN: "ğŸš¬", MINE: "â›ï¸", TIMEOUT: "ğŸ”‡"
        }, 
        ERR_FORM: "í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.", 
        ERR_MONEY: "í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.", 
        ERR_USER: "ëŒ€ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", 
        ERR_TIMEOUT: "ë„ë°°ë¡œ ì¸í•´ ì´ìš©ì´ ì¼ì‹œ ì œí•œë˜ì—ˆìŠµë‹ˆë‹¤." 
        },

    /* [v10.7] ì¹´ì§€ë…¸ ì§€ëŠ¥í˜• í™•ë¥  ë³´ì • ì •ë°€ ì„¸íŒ… */
    ADJUST: {
            ENABLED: true,
            STEP_AMOUNT: 100000,  // 10ë§ŒP ë‹¨ìœ„
            STEP_RATE: 0.01,      // ë‹¨ìœ„ë‹¹ -1%
            PROB_FLOOR: 0.35      // ìµœì†Œ ìŠ¹ë¥  í•˜í•œì„  (35%)
        },

    /* [ì‹ ê·œ] í†µí•© ì¹´ì§€ë…¸ ì‹œìŠ¤í…œ ìƒì„¸ ì„¤ì • */
    CASINO: {
        LADDER: { 
            INTERVAL_SEC: 120,    // 2ë¶„ ì£¼ê¸°
            PAYOUT_SINGLE: 1.9,   // í™€/ì§ ë°°ë‹¹
            PAYOUT_COMB: 4.0,     // ì¡°í•© ë°°ë‹¹
            LIMIT: 500000         // 1íšŒ ìµœëŒ€ ë°°íŒ… í•œë„
        },
        BACCARAT: { 
            INTERVAL_SEC: 180,    // 3ë¶„ ì£¼ê¸°
            PAYOUT: { PLAYER: 2.0, BANKER: 1.95, TIE: 8.0 },
            LIMIT: 1000000        // 1íšŒ ìµœëŒ€ ë°°íŒ… í•œë„
        }
    }
};

//==========ì„¹í„°2==========

/**
 * [v8.1 ê°œí¸] ë¸”ë™ë°•ìŠ¤ ë³µêµ¬ ì—”ì§„ (Smart Replay Option 2)
 * ê¸°ëŠ¥: ìë³¸ê¸ˆ ëŒ€ë¹„ ìˆ˜ìµ í•„í„°ë§ ë¡œì§ì„ ë„ì…í•˜ì—¬ ë³´ë„ˆìŠ¤ ë ˆë²„ë¦¬ì§€ë¥¼ ì´ìš©í•œ ë¶€ë‹¹ ìˆ˜ìµì„ ì°¨ë‹¨í•©ë‹ˆë‹¤.
 * [Gemini ìš”ì²­ ì‚¬í•­ ë°˜ì˜]: ì‚¬ìœ (Reason) í•„í„°ë§ ì‹œìŠ¤í…œ ì™„ë²½ í†µí•©
 */
function recoverFromJournal(data) {
    try {
        var journalFile = new java.io.File(JOURNAL_PATH);
        if (!journalFile.exists() || journalFile.length() === 0) return;

        var logs = FileStream.read(JOURNAL_PATH).split("\n");
        var recoveryCount = 0;
        var skipCount = 0;
        var taintedUsers = {}; // ìë³¸ê¸ˆ í•œë„ë¥¼ ì´ˆê³¼í•˜ì—¬ ë² íŒ…í•œ ìœ ì € íƒœê·¸ ëª©ë¡

        logs.forEach(function(line) {
            if (!line.trim()) return;
            var parts = line.split("|"); 
            // [êµì •]: ì‚¬ìœ ê°€ í¬í•¨ëœ 5ê°œ í•­ëª©ì´ ëª¨ë‘ ìˆëŠ”ì§€ í™•ì¸
            if (parts.length < 5) return;

            var uid = parts[0];
            var room = parts[1];
            var delta = Number(parts[2]);
            var brDelta = Number(parts[3] || 0);
            var reason = parts[4] || ""; 

            if (data.rooms[room] && data.rooms[room].users[uid] && !isNaN(delta)) {
                var user = data.rooms[room].users[uid];

                // [í•„í„° 1]: ì…ì¥ ë³´ë„ˆìŠ¤ ê¸°ë¡ì€ í•©ì‚°ì—ì„œ ì œì™¸ (ì¤‘ë³µ ì§€ê¸‰ ë°©ì§€)
                if (reason.indexOf("ì…ì¥ ì¶•í•˜") !== -1) {
                    skipCount++;
                    return;
                }

                // [í•„í„° 2]: ìë³¸ê¸ˆ í•œë„ ì´ˆê³¼ ë² íŒ… ê°ì§€ (ì˜µì…˜ 2 ë…¼ë¦¬)
                if (delta < 0 && Math.abs(delta) > Number(user.point)) {
                    taintedUsers[uid] = true;
                    return;
                }

                // [í•„í„° 3]: íƒœê·¸ëœ ìœ ì €ì˜ ìˆ˜ìµ(+) ê¸°ë¡ ë¬´íš¨í™”
                if (taintedUsers[uid] && delta > 0) {
                    skipCount++;
                    return;
                }

                // [ìµœì¢… ë°˜ì˜]: í•„í„°ë¥¼ í†µê³¼í•œ ì •ë‹¹í•œ ë°ì´í„°ë§Œ í•©ì‚° (0ì› í•˜í•œì„  ê°•ì œ ì ìš©)
                user.point = Math.max(0, Number(user.point || 0) + delta);
                data.rooms[room].bankReserve = Number(data.rooms[room].bankReserve || 0) + brDelta;
                recoveryCount++;
            }
        });

        if (recoveryCount > 0 || skipCount > 0) {
            Log.info("[Recovery] ë¸”ë™ë°•ìŠ¤ ì—”ì§„: " + recoveryCount + "ê±´ ë³µêµ¬ ì™„ë£Œ (ë¶€ë‹¹ ì´ë“ ë° ë³´ë„ˆìŠ¤ " + skipCount + "ê±´ í•„í„°ë§)");
            // [ì¤‘ë³µ ë³µêµ¬ ë°©ì§€ ë° ê¸°ë¡ ë³´ì¡´ ë¡œì§]:
            // 1. í˜„ì¬ ë³µêµ¬ì— ì‚¬ìš©ëœ ë¡œê·¸ë¥¼ 'ì „ì²´ ë³´ê´€ìš© íŒŒì¼'ì— ë”°ë¡œ ì €ì¥í•©ë‹ˆë‹¤. (ë””ìŠ¤ì½”ë“œ ì „ì†¡ìš©)
            var historyPath = BASE_DIR + "total_history.log";
            var rawLogs = FileStream.read(JOURNAL_PATH);
            FileStream.append(historyPath, rawLogs);

            // 2. ë¬¼ë¦¬ íŒŒì¼(attendance.json)ì— ë³µêµ¬ëœ ì”ì•¡ì„ ì¦‰ì‹œ í™•ì • ì €ì¥í•©ë‹ˆë‹¤.
            safeSaveData(data, true); 

            // 3. ë³µêµ¬ìš© ë¡œê·¸(transaction.log)ë§Œ ë¹„ì›Œì„œ ë‹¤ìŒ ë¦¬ë¡œë“œ ì‹œ ì¤‘ë³µ ì—°ì‚°ì„ ì°¨ë‹¨í•©ë‹ˆë‹¤.
            var jFile = new java.io.File(JOURNAL_PATH);
            if (jFile.exists()) {
                jFile.delete(); 
                Log.info("[Recovery] ë¡œê·¸ ì´ê´€ ë° ë³µêµ¬ìš© íŒŒì¼ ì´ˆê¸°í™” ì™„ë£Œ.");
            }
        }
    } catch (e) {
        Log.error("Journal Recovery Error: " + e);
    }
}

/**
 * [v11.9.3 ìµœì¢…í˜•] ë‚ ì§œ í•„í„°ë§ ê¸°ë°˜ ë°°ë‹¹ ì£¼ë¨¸ë‹ˆ ì •ë°€ ì¬ê³„ì‚° ì—”ì§„
 * ê¸°ëŠ¥: ë¸”ë™ë°•ìŠ¤ ë¡œê·¸ ì¤‘ 'ì˜¤ëŠ˜' ë°œìƒí•œ ì‹¤ì œ í™œë™ ìˆ˜ìµë§Œ ì¶”ì¶œí•˜ì—¬ ì£¼ë¨¸ë‹ˆë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤.
 */
function util_recalculateDailyPools(data, roomName) {
    try {
        var logFile = new java.io.File(JOURNAL_PATH);
        if (!logFile.exists() || logFile.length() === 0) return;

        var logs = FileStream.read(JOURNAL_PATH).split("\n");
        var roomObj = data.rooms[roomName];
        var cfg = SYSTEM_CONFIG.ECO.ACTIVITY_ACCUM_RATES;
        
        // ì˜¤ëŠ˜ ë‚ ì§œ ë¬¸ìì—´ (ë¡œê·¸ì˜ ì‹œê°„ ì •ë³´ì™€ ëŒ€ì¡°ìš©)
        var todayPrefix = new Date().toLocaleDateString(); 

        // 1. ê¸°ì¡´ ì˜¤ì—¼ëœ ì£¼ë¨¸ë‹ˆ ì´ˆê¸°í™”
        roomObj.features.dailyPools = { mine: 0, fish: 0, casino: 0, bank: 0, shop: 0, race: 0 };

        logs.forEach(function(line) {
            if (!line.trim()) return;
            var parts = line.split("|");
            // [êµì •] ë¡œê·¸ì— ê¸°ë¡ëœ ë°© ì´ë¦„ì´ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
            if (parts.length < 5 || parts[1] !== roomName) return;

            var amount = Math.abs(Number(parts[2])); 
            var reason = parts[4]; 

            /* =====ìš”ì²­ì‚¬í•­ ì‹œì‘===== */
            // 1. ì¹´ì§€ë…¸ ë°°ë‹¹ê¸ˆ ì§‘ê³„ (ì›ê¸ˆ ëˆ„ì  ë°©ì‹ìœ¼ë¡œ í†µì¼)
            if (reason.indexOf("í™€ì§ ì ì¤‘") !== -1) {
                var originalBet = amount / 0.85; 
                var houseCommission = originalBet * 0.15; 
                roomObj.features.dailyPools.casino += Math.floor(houseCommission);
            }
            else if (reason.indexOf("í™€ì§ ë¯¸ì ì¤‘") !== -1) {
                roomObj.features.dailyPools.casino += amount;
            }
            // 2. ê¸°íƒ€ í™œë™ ì§‘ê³„ (cfg ì°¸ì¡° ì œê±°)
            else if (reason.indexOf("ê´‘ì‚°") !== -1) roomObj.features.dailyPools.mine += amount;
            else if (reason.indexOf("ë‚šì‹œ ë³´ìƒ") !== -1) roomObj.features.dailyPools.fish += amount;
            else if (reason.indexOf("ì´ì ì§€ê¸‰") !== -1) roomObj.features.dailyPools.bank += amount;
            else if (reason.indexOf("ìƒì  êµ¬ë§¤") !== -1) roomObj.features.dailyPools.shop += amount;
            else if (reason.indexOf("ê²½ë§ˆ ë°°íŒ…") !== -1) roomObj.features.dailyPools.race += amount;
        });
        
    } catch (e) {
        Log.error("Recalculate DailyPools Error: " + e);
    }
}

/**
 * [v11.9.16 ìµœì¢…ì•ˆ] ì˜¤ëŠ˜ì¹˜ ë°±ì—… ë¡œê·¸ ì†Œê¸‰ í•©ì‚° ì—”ì§„ (Date Filtering)
 * ê¸°ëŠ¥: ë¡œì§ ë³€ê²½ ì „ ë°±ì—…ëœ 'ì˜¤ëŠ˜ì˜ ë¡œê·¸'ë¥¼ ë¶„ì„í•˜ì—¬ ë©”ëª¨ë¦¬ ì£¼ë¨¸ë‹ˆë¥¼ ë³µêµ¬í•©ë‹ˆë‹¤.
 */
function util_restoreDailyPoolsFromHistory(data, roomName) {
    try {
        var historyPath = BASE_DIR + "total_history.log";
        var hFile = new java.io.File(historyPath);
        if (!hFile.exists() || hFile.length() === 0) return 0;

        var logs = FileStream.read(historyPath).split("\n");
        var roomObj = data.rooms[roomName];
        var cfg = SYSTEM_CONFIG.ECO.ACTIVITY_ACCUM_RATES;
        var restoredCount = 0;

        // [í•µì‹¬] ì˜¤ëŠ˜ ë‚ ì§œ í•„í„° (ì˜ˆ: "2026. 2. 4.")
        var todayStr = new Date().toLocaleDateString();

        logs.forEach(function(line) {
            if (!line.trim()) return;
            var p = line.split("|");
            // í˜•ì‹ì´ ë§ì§€ ì•Šê±°ë‚˜, ë‹¤ë¥¸ ë°©ì˜ ê¸°ë¡ì´ê±°ë‚˜, ì˜¤ëŠ˜ ë‚ ì§œê°€ ì•„ë‹ˆë©´ í†µê³¼
            // (ì°¸ì¡°: ë¡œê·¸ê°€ ë¹„ì›Œì§ˆ ë•Œ ì°íŒ ì‹œìŠ¤í…œ ë‚ ì§œ ì •ë³´ê°€ ìˆëŠ” ê²½ìš°ë§Œ í•©ì‚°)
            if (p.length < 5 || p[1] !== roomName) return;
            
            // ë§Œì•½ ë¡œê·¸ì— ë‚ ì§œ ì •ë³´ê°€ ì—†ë‹¤ë©´ ì˜¤ëŠ˜ ë°œìƒí•œ ëª¨ë“  ë¡œê·¸ë¥¼ ì½ìœ¼ë¯€ë¡œ 
            // 00ì‹œ ì •ì‚° ì§í›„ì— í•œ ë²ˆë§Œ ì‹¤í–‰í•˜ëŠ” ê²ƒì´ ê°€ì¥ ì•ˆì „í•©ë‹ˆë‹¤.
            
            var amt = Math.abs(Number(p[2]));
            var reason = p[4];

            if (reason.indexOf("ê´‘ì‚°") !== -1) roomObj.features.dailyPools.mine += Math.floor(amt * cfg.MINE);
            else if (reason.indexOf("ë‚šì‹œ") !== -1) roomObj.features.dailyPools.fish += Math.floor(amt * cfg.FISH);
            // ê³¼ê±° ë¡œê·¸ì— ì°íŒ 'í™€ì§'ì´ë‚˜ 'ì ì¤‘' í‚¤ì›Œë“œê¹Œì§€ ì‹¹ ê¸ì–´ëª¨ìë‹ˆë‹¤.
            else if (reason.indexOf("ì¹´ì§€ë…¸") !== -1 || reason.indexOf("ì‚¬ë‹¤ë¦¬") !== -1 || reason.indexOf("ë°”ì¹´ë¼") !== -1 || reason.indexOf("í™€ì§") !== -1 || reason.indexOf("ì ì¤‘") !== -1) {
                roomObj.features.dailyPools.casino += Math.floor(amt * cfg.CASINO);
            }
            else if (reason.indexOf("ì´ì") !== -1) roomObj.features.dailyPools.bank += Math.floor(amt * cfg.BANK);
            else if (reason.indexOf("ìƒì ") !== -1 || reason.indexOf("êµ¬ë§¤") !== -1) roomObj.features.dailyPools.shop += Math.floor(amt * cfg.SHOP);
            else if (reason.indexOf("ê²½ë§ˆ") !== -1) roomObj.features.dailyPools.race += Math.floor(amt * cfg.RACING);
            
            restoredCount++;
        });
        return restoredCount;
    } catch (e) {
        Log.error("History Restoration Error: " + e);
        return 0;
    }
}

/**
 * [Gemini ì •ë°€ êµì •] ë°ì´í„°ë² ì´ìŠ¤ ë¡œë“œ í•¨ìˆ˜
 */
function getDatabase() {

    // [ê°œì„ ] ë©”ëª¨ë¦¬ ìƒì£¼ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ë¦¬ë¡œë“œ ì‹œ ë¬´ì—­ ê³ ì°© ìœ ì €ë¥¼ ì¦‰ì‹œ ì¹˜ë£Œ
   if (globalData && globalData.rooms) {
        try {
            for (var r in globalData.rooms) {
                var roomObj = globalData.rooms[r];
                if (roomObj && roomObj.users) {
                    for (var id in roomObj.users) {
                        var u = roomObj.users[id];
                        // ë¬´ì—­ ì •ì‚° ì¤‘ ë©ˆì¶˜ ìœ ì € ê°•ì œ í•´ì œ
                        if (u.voyage && u.voyage.active === true && u.voyage.isProcessing === true) {
                            u.voyage.isProcessing = false;
                            u.voyage.isAlerted = false;
                        }
                    }
                }
            }
        } catch(e) { Log.error("Healer Error: " + e); }
    }

    // 1. RAM ìƒì£¼ ë°ì´í„° ìš°ì„  ë°˜í™˜ (ë¬¼ë¦¬ì  íŒŒì¼ ì½ê¸° ìƒëµìœ¼ë¡œ ì‘ë‹µ ì†ë„ ê·¹ëŒ€í™”)
    if (globalData && globalData.rooms && Object.keys(globalData.rooms).length > 0) {
        return globalData; 
    }

    try {
        var file = new java.io.File(FILE_PATH);
        var initialData;
        
        if (!file.exists()) {
            initialData = {
                rooms: {}, admins: ["ê´€ë¦¬ì"], botActive: true,
                nickHistory: {}, adminLogs: [], economyDamping: 0.5,
                lastDailyReset: "", isRecovering: false, nameToIdCache: {}
            };
        } else {
            var content = FileStream.read(FILE_PATH);
            if (!content) throw new Error("Empty File");
            initialData = JSON.parse(content);
        }

        // 2. ë¸”ë™ë°•ìŠ¤(Journal) ë¡œê·¸ ì¦‰ì‹œ ë³µêµ¬ ë³‘í•©
        recoverFromJournal(initialData);

        // [ì‹ ê·œ] ë¬´ì—­ ì •ì‚° ê³ ì°©(stuck) ìœ ì € ìë™ ë³µêµ¬ ì—”ì§„ (Auto-Healer)
        // ê¸°ëŠ¥: /ë¦¬ë¡œë“œ ì‹œ ì •ì‚° ì ê¸ˆ(isProcessing)ì´ trueë¡œ êµ³ì€ ìœ ì €ë“¤ì„ ì°¾ì•„ ìë™ìœ¼ë¡œ í’€ì–´ì¤ë‹ˆë‹¤.
        (function util_autoRepairTradeStuck(data) {
            if (!data || !data.rooms) return;
            var count = 0;
            for (var r in data.rooms) {
                var users = data.rooms[r].users;
                for (var id in users) {
                    var u = users[id];
                    // í•­í•´ ì¤‘(active)ì¸ë° ì •ì‚° ì¤‘(isProcessing)ì¸ ìƒíƒœì—ì„œ ë©ˆì¶˜ ìœ ì € íƒìƒ‰
                    if (u.voyage && u.voyage.active === true && u.voyage.isProcessing === true) {
                        u.voyage.isProcessing = false; // ë½ í•´ì œ
                        u.voyage.isAlerted = false;    // ë¶€ë„ ì•Œë¦¼ ìƒíƒœ ì´ˆê¸°í™”
                        count++;
                    }
                }
            }
            if (count > 0) Log.info("ğŸ› ï¸ [Auto-Healer] ë¬´ì—­ ê³ ì°© ìœ ì € " + count + "ëª… ìë™ í•´ì œ ì™„ë£Œ.");
        })(initialData);
        
        // 3. [ë¬´ê²°ì„± ìœ ì§€] ë°©ë³„ ë…ë¦½ì„± ë° Feature í…œí”Œë¦¿ ê°•ì œ ì´ì‹ (ê¸°ì¡´ ë¡œì§ ë³´ì¡´)
        if (initialData.rooms) {
            for (var rName in initialData.rooms) {
                var targetRoom = initialData.rooms[rName];
                if (!targetRoom.features) {
                    if (typeof ROOM_FEATURE_TEMPLATE === 'function') {
                        targetRoom.features = ROOM_FEATURE_TEMPLATE();
                    }
                } else {
                    var template = ROOM_FEATURE_TEMPLATE();
                    if (!targetRoom.features.racing) targetRoom.features.racing = template.racing;
                    if (!targetRoom.features.lotto) targetRoom.features.lotto = template.lotto;
                    if (!targetRoom.features.stockMarket) targetRoom.features.stockMarket = template.stockMarket;
                    if (!targetRoom.features.states) {
                        targetRoom.features.states = template.states;
                    } else {
                        var s = targetRoom.features.states;
                        var ts = template.states;
                        for (var key in ts) {
                            if (!s[key] || typeof s[key] !== 'object') s[key] = {};
                        }
                    }
                }
                if (!targetRoom.loanPools) targetRoom.loanPools = {};
                if (!targetRoom.loanContracts) targetRoom.loanContracts = {};
                if (targetRoom.bankReserve === undefined) targetRoom.bankReserve = 10000;
            }
        }

        // 4. ì‹œìŠ¤í…œ ì—”ì§„(Executor) ë° ìºì‹œ ê°ì²´ ë°”ì¸ë”©
        if (initialData) {
            // initialData.SaveExecutor = SaveExecutor;
            // initialData.Executor = Executor;
            if (!initialData.nameToIdCache) initialData.nameToIdCache = {};
        }
        
        globalData = initialData;
        return globalData;
    } catch (e) {
        Log.error("DB Load Error: " + e);
        var stableFile = new java.io.File(BACKUP_DIR + "last_stable_backup.json");
        if (stableFile.exists()) {
            globalData = JSON.parse(FileStream.read(BACKUP_DIR + "last_stable_backup.json"));
            return globalData;
        }
        return null;
    }
}

/* ë¡œì§ ì¶”ì  ì‹œì‘ */
function startTracking(user, commandName) {
    if (!user) return;
    user.lastAction = { cmd: commandName, status: "PENDING", time: Date.now(), msg: "ìˆ˜í–‰ ì‹œì‘" };
}

/**
 * [v8.1 ì—…ê·¸ë ˆì´ë“œ] í¬ì¸íŠ¸ ë³€ë™ ê²€ì¦ ë° ì‚¬ìœ  í¬í•¨ ë¸”ë™ë°•ìŠ¤ ê¸°ë¡
 * [êµì •]: ë¡œê·¸ í•œ ì¤„ì— reasonì„ ë°˜ë“œì‹œ í¬í•¨í•˜ì—¬ ì €ì¥í•©ë‹ˆë‹¤.
 */
function verifyPointTransaction(user, prePoint, changeAmount, reason, roomName, brDelta) {
    try {
        var expected = Number(prePoint) + Number(changeAmount);
        var actual = Number(user.point);
        
        if (actual !== expected) {
            var errorMsg = "[" + new Date().toLocaleString() + "] [ë¶ˆì¼ì¹˜] " + (user.name||"") + ": " + reason + " (ì˜ˆìƒ:" + fp(expected) + "/ì‹¤ì œ:" + fp(actual) + ")\n";
            FileStream.append(ERROR_LOG_PATH, errorMsg);
            // [ê°œë³„ ìœ ì € ë¡¤ë°±]: ì—°ì‚° ì˜¤ë¥˜ ê°ì§€ ì‹œ í•´ë‹¹ ìœ ì €ì˜ ë°ì´í„°ë§Œ ì•ˆì „ ì§€ì ìœ¼ë¡œ ë˜ëŒë¦¼
            var db = getDatabase();
            var safeUser = null;
            for (var r in db.rooms) { 
                if (db.rooms[r].users[user.uid]) { 
                    safeUser = db.rooms[r].users[user.uid]; 
                    break; 
                } 
            }
            
            if (safeUser) {
                var roomData = db.rooms[roomName || "ë‚´ë¦¬ë‹¤"];
                if (roomData) {
                    // ë¬¸ì œê°€ ëœ ìœ ì € ê°ì²´ë§Œ ë°±ì—…ë³¸ìœ¼ë¡œ í†µì§¸ë¡œ êµì²´ (ì „ì²´ ë¡¤ë°±)
                    roomData.users[user.uid] = JSON.parse(JSON.stringify(safeUser)); 
                }
            }
            
            try { 
                Api.replyRoom(roomName || "ë‚´ë¦¬ë‹¤", "ğŸ›¡ï¸ [ë°ì´í„° ë¬´ê²°ì„± ê°€ë“œ] " + (user.name || "ìœ ì €") + "ë‹˜ì˜ ìì‚° ì—°ì‚° ì˜¤ë¥˜ë¥¼ ê°ì§€í•˜ì—¬ í•´ë‹¹ ìœ ì € ë°ì´í„°ë¥¼ ë¡¤ë°±í–ˆìŠµë‹ˆë‹¤."); 
            } catch(e){}
            
            user.lastAction = { cmd: reason, status: "FAIL", amount: changeAmount, time: Date.now(), msg: "ë°ì´í„° ë¶ˆì¼ì¹˜ ë° ë¡¤ë°±" };
        } else {
            if (roomName) {
                logLock.lock();
                try {
                    // [í•µì‹¬ êµì •]: ë¡œê·¸ í¬ë§·ì— reason í•­ëª© ì¶”ê°€ (5ì—´ êµ¬ì¡°)
                    var journalEntry = user.uid + "|" + roomName + "|" + changeAmount + "|" + (brDelta || 0) + "|" + reason + "\n";
                    FileStream.append(JOURNAL_PATH, journalEntry);
                } finally {
                    logLock.unlock();
                }
            }
            if (user.lastAction && user.lastAction.status !== "FAIL") {
                user.lastAction = { cmd: reason, status: "SUCCESS", amount: changeAmount, time: Date.now(), msg: "ì •ìƒ ì™„ë£Œ" };
            }
        }
    } catch(e) { 
        FileStream.append(ERROR_LOG_PATH, "ê²€ì¦ì˜¤ë¥˜: " + e + "\n"); 
    }
}

/* ë¡œì§ ì¶”ì  ì¢…ë£Œ */
function endTracking(user, isSuccess, resultMsg) {
    if (!user || !user.lastAction) return;
    if (user.lastAction.status === "FAIL") return; 
    user.lastAction.status = isSuccess ? "SUCCESS" : "CRASH";
    user.lastAction.msg = resultMsg;
    user.lastAction.endTime = Date.now();
}

//==========ì„¹í„°3==========

/* [ìµœì í™”] í•˜ì´ë¸Œë¦¬ë“œ ë¹„ë™ê¸° ì˜ì†í™”(Asynchronous Persistence) ì—”ì§„ v6.0 (Defense + Performance) */
/**
 * @param {Object} data - ì €ì¥í•  ë°ì´í„° ê°ì²´
 * @param {Boolean} isForceBackup - trueì¼ ê²½ìš° ë°±ì—… íŒŒì¼ê¹Œì§€ ë¬¼ë¦¬ì ìœ¼ë¡œ ê¸°ë¡
 */
function safeSaveData(data, isForceBackup) {
    if (!data) return;

    var isHealed = false; // ì¹˜ìœ  ë°œìƒ ì—¬ë¶€
    var healReports = []; // ì¹˜ìœ  ë‚´ì—­ ë³´ê³ ì„œ

    /**
     * [1ë‹¨ê³„: ë¬´ê²°ì„± ê²€ì—­ì†Œ] - ë©”ì¸ ìŠ¤ë ˆë“œ ìˆ˜í–‰
     * ì‚¬ìš©ìë‹˜ì˜ í•µì‹¬ ë°©ì–´ ë¡œì§(í¬ì¸íŠ¸/ì€í–‰/ëœë“œë§ˆí¬/ê°€ë°© 80% ê¸‰ê°, ìœ ì € ì¦ë°œ ë“±)ì„ ê·¸ëŒ€ë¡œ ìœ ì§€í•©ë‹ˆë‹¤.
     */
    try {
        var roomCount = Object.keys(data.rooms || {}).length;
        if (roomCount === 0) throw new Error("ì €ì¥ ê±°ë¶€: ë°©(rooms) ê°ì²´ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");

        // ë¹„êµìš© ê¸°ì¡´ ë°ì´í„° ë¡œë“œ (ë°©ì–´ ë¡œì§ ê²€ì¦ìš©)
        var DB_DATA = null;
        try {
            var dbFile = new java.io.File(FILE_PATH);
            if (dbFile.exists()) {
                var dbContent = FileStream.read(FILE_PATH);
                if (dbContent) DB_DATA = JSON.parse(dbContent);
            }
        } catch(e) { Log.error("DB Read for Healing Fail: " + e); }

        for (var rName in data.rooms) {
            var room = data.rooms[rName];
            
            for (var uid in room.users) {
                var u = room.users[uid];

                // [1] ë©´ì œê¶Œ ì²´í¬: ì €ì¥ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ë³´ì•ˆ ì—”ì§„ì˜ ì ‘ê·¼ì„ ì°¨ë‹¨
                if (u.skipHealing === true) continue; 

                // [2] ì •ë°€ ë¶€ë¶„ ë³µêµ¬ ë¡œì§ (Surgical Repair)
                if (DB_DATA && DB_DATA.rooms[rName] && DB_DATA.rooms[rName].users[uid]) {
                    var safeU = DB_DATA.rooms[rName].users[uid];
                    var isFieldHealed = false;

                    // A. í¬ì¸íŠ¸ ì •ë°€ ì²´í¬ (NaN ë˜ëŠ” 80%â†‘ ê¸‰ê° ì‹œ í•´ë‹¹ í•„ë“œë§Œ ë³µêµ¬)
                    var lastPoint = Number(safeU.point || 0);
                    var cr = getCreditInfo(u.creditScore || 600);
                    var maxAllowDrop = Math.max(cr.limit * 1.5, lastPoint * 0.5);

                    if (isNaN(u.point) || (lastPoint > 10000 && (lastPoint - u.point) > maxAllowDrop)) {
                        u.point = lastPoint; 
                        isFieldHealed = true;
                    }

                    // B. ì€í–‰ ì”ê³  ì •ë°€ ì²´í¬
                    var lastBank = Number(safeU.bank || 0);
                    if (isNaN(u.bank) || (lastBank > 10000 && (lastBank - u.bank) / lastBank >= 0.8)) {
                        u.bank = lastBank;
                        isFieldHealed = true;
                    }

                    // C. ë¶€ë™ì‚° ì§€ë¶„ ì •ë°€ ì²´í¬
                    if (safeU.landHoldings && u.landHoldings) {
                        for (var lName in safeU.landHoldings) {
                            var lastQty = Number(safeU.landHoldings[lName] || 0);
                            var curQty = Number(u.landHoldings[lName] || 0);
                            if (lastQty >= 10 && (lastQty - curQty) / lastQty >= 0.8) {
                                u.landHoldings[lName] = lastQty; // í•´ë‹¹ ê±´ë¬¼ ì§€ë¶„ë§Œ ë³µêµ¬
                                isFieldHealed = true;
                            }
                        }
                    }

                    // D. ì¸ë²¤í† ë¦¬ ì •ë°€ ì²´í¬
                    var lastInvCount = Array.isArray(safeU.inventory) ? safeU.inventory.length : 0;
                    var curInvCount = Array.isArray(u.inventory) ? u.inventory.length : 0;
                    if (lastInvCount >= 5 && (curInvCount / lastInvCount) <= 0.2) {
                        u.inventory = JSON.parse(JSON.stringify(safeU.inventory)); // ê°€ë°©ë§Œ ë³µêµ¬
                        isFieldHealed = true;
                    }

                    // ìˆ˜ë¦¬ ë°œìƒ ì‹œ ë¦¬í¬íŠ¸ ì¶”ê°€
                    if (isFieldHealed) {
                        isHealed = true;
                        healReports.push(u.name + " (ìì‚°/í•­ëª© ì •ë°€ ìˆ˜ë¦¬: ë¬´ì—­ ìƒíƒœ ë³´ì¡´)");
                    }
                }
            } // ìœ ì € ë£¨í”„ ì¢…ë£Œ (3ë²ˆì§¸ ì¤‘ê´„í˜¸)
        } // ë°© ë£¨í”„ ì¢…ë£Œ (4ë²ˆì§¸ ì¤‘ê´„í˜¸)

        // ëª¨ë“  ë°©ì˜ ê²€ì‚¬ê°€ ëë‚œ ì‹œì ì— í•œ ë²ˆë§Œ ì¹˜ìœ  ë³´ê³ ì„œ ë°œì†¡
        if (isHealed && healReports.length > 0) {
            try {
                var reportMsg = "ğŸš¨ [ë°ì´í„° ìê°€ ì¹˜ìœ  ì‘ë™]\nì†ìƒ ì˜ì‹¬ ë°ì´í„°ë¥¼ ì œì™¸í•˜ê³  ì •ìƒ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n" +
                                "[ì¹˜ìœ  ë‚´ì—­]\nâ€¢ " + healReports.join("\nâ€¢ ") + "\n\n" +
                                "âš ï¸ ê´€ë¦¬ìëŠ” í•´ë‹¹ ìœ ì €ì˜ í™œë™ì„ ì ê²€í•˜ì‹­ì‹œì˜¤.";
                Api.replyRoom("ë‚´ë¦¬ë‹¤", reportMsg);
                Api.replyRoom("ë² ë¦­ë°©", "ğŸ©¹ [Healer Audit]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + healReports.join("\n") + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
            } catch(e) {}
        }

    } catch (validationError) {
        // ê²€ì¦ ì‹¤íŒ¨ ì‹œ ë¡œê·¸ ë‚¨ê¸°ê³  ì €ì¥ ì¤‘ë‹¨ (íŒŒì¼ ì˜¤ì—¼ ë°©ì§€)
        Log.error("!!! [ë°ì´í„° ì˜¤ì—¼ ë°©ì§€ ì‘ë™] !!!");
        Log.error("ì‚¬ìœ : " + validationError.message);
        try {
            Api.replyRoom("ë² ë¦­ë°©", "ğŸš¨ [ë°ì´í„° ë³´í˜¸ ì‹œìŠ¤í…œ ì‘ë™]\nì‹¬ê°í•œ ë°ì´í„° ì˜¤ì—¼ì´ ê°ì§€ë˜ì–´ ìë™ ì €ì¥ì„ ì°¨ë‹¨í–ˆìŠµë‹ˆë‹¤.\nì‚¬ìœ : " + validationError.message + "\n\nâš ï¸ ê´€ë¦¬ìëŠ” ì¦‰ì‹œ ì‹œìŠ¤í…œì„ ì ê²€í•˜ì‹­ì‹œì˜¤.");
        } catch (e) {}
        return; 
    }

    // [ì¤‘ìš”] ë©”ëª¨ë¦¬ ë™ê¸°í™” (ì¦‰ì‹œ ë°˜ì˜í•˜ì—¬ ëª…ë ¹ì–´ ë°˜ì‘ ì†ë„ ìœ ì§€)
    globalData = data;

    /**
     * [2ë‹¨ê³„: ë¹„ë™ê¸° ì˜ì†í™”] - ë°°ê²½ ìŠ¤ë ˆë“œ ìˆ˜í–‰ (íŒ…ê¹€ ë°©ì§€ í•µì‹¬)
     * ë¬´ê±°ìš´ 'ë¬¸ìì—´ ë³€í™˜(Stringify)'ê³¼ 'íŒŒì¼ ì“°ê¸°'ë¥¼ ë°°ê²½ì—ì„œ ëª°ë˜ ì²˜ë¦¬í•˜ì—¬
     * ë©”ì¸ ìŠ¤ë ˆë“œ(ëª…ë ¹ì–´ ì²˜ë¦¬)ê°€ ë©ˆì¶”ê±°ë‚˜ íŒ…ê¸°ëŠ” ê²ƒì„ ë°©ì§€í•©ë‹ˆë‹¤.
     */
    SaveExecutor.execute(new java.lang.Runnable({
        run: function() {
            lock.lock(); 
            try {
                var content = JSON.stringify(data, function(key, value) {
                    if (key === "Executor" || key === "SaveExecutor" || (value && typeof value.getClass === 'function')) {
                        return undefined;
                    }
                    return value;
                });
                
                var check = JSON.parse(content);
                if (!check || !check.rooms) throw new Error("ë°ì´í„° êµ¬ì¡° ë¶ˆì™„ì „ (rooms ëˆ„ë½)");

                var targetPath = FILE_PATH;
                var tempPath = FILE_PATH + ".tmp";
                
                FileStream.write(tempPath, content);
                var tempFile = new java.io.File(tempPath);

                if (tempFile.exists() && tempFile.length() > 0) {
                    var orgFile = new java.io.File(targetPath);
                    if (orgFile.exists()) orgFile.delete();
                    tempFile.renameTo(orgFile);

                    // [í•µì‹¬] ëª¨ë“  ë¬¼ë¦¬ì  íŒŒì¼ ì €ì¥ì´ ëë‚œ ì´ ì‹œì ì—ì„œ ë©´ì œê¶Œì„ ì¼ê´„ íšŒìˆ˜í•©ë‹ˆë‹¤.
                    for (var r in data.rooms) {
                        if (!data.rooms[r].users) continue;
                        for (var id in data.rooms[r].users) {
                            data.rooms[r].users[id].skipHealing = false;
                        }
                    }
                }

                if (isForceBackup) {
                    var backupPath = BACKUP_DIR + "last_stable_backup.json";
                    FileStream.write(backupPath + ".tmp", content);
                    var bTemp = new java.io.File(backupPath + ".tmp");
                    if (bTemp.exists() && bTemp.length() > 0) {
                        var oldB = new java.io.File(backupPath);
                        if (oldB.exists()) oldB.delete();
                        bTemp.renameTo(oldB);
                    }
                }
                
                content = null; 
            } catch (e) {
                Log.error("Async Save Fail: " + e.message);
                var saveErr = "ğŸš¨ [ì‹œìŠ¤í…œ ë¹„ìƒ: ì €ì¥ ë§ˆë¹„]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâ€¢ ì‚¬ìœ : " + e.message + "\nâš ï¸ ê¸°ê¸° ì €ì¥ì†Œ ê¶Œí•œ ë° ìš©ëŸ‰ì„ í™•ì¸í•˜ì„¸ìš”.";
                try { Api.replyRoom("ë² ë¦­ë°©", saveErr); } catch (err) {}
            } finally {
                lock.unlock();
                java.lang.System.gc(); 
            }
        }
    }));
}

//==========ì„¹í„°4==========

/* ê´€ë¦¬ì ë° ì‹œìŠ¤í…œ ì„¤ì • */
var FIXED_ADMINS = ["95 ë‚¨ ê´‘ì–´", "ë² ë¦­"]; // ì—¬ê¸°ì— ë³¸ì¸ì˜ ì •í™•í•œ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”
var TIERS = ["ì•„ì´ì–¸", "ë¸Œë¡ ì¦ˆ", "ì‹¤ë²„", "ê³¨ë“œ", "í”Œë ˆí‹°ë„˜", "ì—ë©”ë„ë“œ", "ë‹¤ì´ì•„ëª¬ë“œ", "ë§ˆìŠ¤í„°", "ê·¸ëœë“œë§ˆìŠ¤í„°", "ì±Œë¦°ì €"];
var ALLOWED_ROOMS = ["ë‚´ë¦¬ë‹¤", "í…ŒìŠ¤íŠ¸", "ë² ë¦­ë°©"]; 

//==========ì„¹í„°5==========

/* ê³ í‹°ì–´ ìŠ¹ê¸‰ í™•ë¥  ì„¤ì • */
var TIER_PROBS = {
    0: { up: 95, stay: 5, down: 0 },
    1: { up: 85, stay: 15, down: 0 },
    2: { up: 70, stay: 25, down: 5 },
    3: { up: 50, stay: 40, down: 10 },
    4: { up: 35, stay: 50, down: 15 },
    5: { up: 20, stay: 60, down: 20 },
    6: { up: 12, stay: 68, down: 20 },
    7: { up: 8, stay: 67, down: 25 },  
    8: { up: 5, stay: 70, down: 25 }  
};

/* ìƒì  ì¹´í…Œê³ ë¦¬ ì •ì˜ */
var SHOP_CATEGORIES = {
    1: "ğŸ¨ ì¥ì°©/ê¾¸ë¯¸ê¸° (ì•„ì´ì½˜)",
    2: "ğŸ”‚ ì„±ì¥/ê²Œì„ (ìŠ¹ê¸‰, ë°©ì–´)",
    3: "ğŸ’³ ê²½ì œ/ì§€ì› (ì‹ ìš©, ì¸ì¦, ê¸°íƒ€)",
    4: "ğŸ ëœë¤ ë½‘ê¸° (ì•„ì´ì½˜ ë°•ìŠ¤)",
    5: "ğŸ« íŠ¹ìˆ˜/ë³µê¶Œ (ë¡œë˜)",
    6: "ğŸš¢ ë¬´ì—­ ë¬¼í’ˆ (ìˆ˜ì¶œìš© ìƒì)"
};

/* [ìˆ˜ì •] ìƒì  ì•„ì´í…œ ë°ì´í„° (ê²½ê³ ì‚­ì œê¶Œ ì¶”ê°€) */
var SHOP_ITEMS = [
    { id: 1, name: "í™œë™ê°€ ì•„ì´ì½˜", icon: "ğŸŒ±", price: 5000, effect: "icon", title: "", cat: 1 },
    { id: 2, name: "ìˆ™ë ¨ì ì•„ì´ì½˜", icon: "âš”ï¸", price: 10000, effect: "icon", title: "", cat: 1 },
    { id: 3, name: "ëŸ¬ë¸”ë¦¬ ì•„ì´ì½˜", icon: "â£ï¸", price: 20000, effect: "icon", title: "", cat: 1 },
    { id: 4, name: "ë² í…Œë‘ ì•„ì´ì½˜", icon: "ğŸ’", price: 30000, effect: "icon", title: "", cat: 1 },
    { id: 5, name: "ì—ì´ë¦¬ì–¸ ì•„ì´ì½˜", icon: "ğŸ‘¾", price: 50000, effect: "icon", title: "", cat: 1 },
    { id: 6, name: "ë„¤ì„ë“œ ì•„ì´ì½˜", icon: "ğŸ‘‘", price: 70000, effect: "icon", title: "", cat: 1 },
    { id: 8, name: "ìŠ¹ê¸‰ ê¸°íšŒ êµ¬ë§¤", icon: "ğŸ”‚", price: 4000, effect: "promotion", cat: 2 },  
    { id: 9, name: "ê°•ë“± ë°©ì–´ê¶Œ", icon: "ğŸ›¡ï¸", price: 20000, effect: "tierGuard", cat: 2 },
    { id: 10, name: "ì‹ ìš© ì ìˆ˜ íšŒë³µ", icon: "ğŸ’Š", price: 10000, effect: "credit", value: 50, cat: 3 },
    { id: 11, name: "[ì‹œì¦Œ] ë¡¤ íŒìˆ˜ ì¸ì¦ê¶Œ", icon: "ğŸ«", price: 100000, effect: "gameAuth", cat: 3 },
    /* [ì‹ ê·œ] ê²½ê³ ì‚­ì œê¶Œ: ê¸°ë³¸ê°€ 500,000P ì„¤ì • */
    { id: 13, name: "ê²½ê³ ì‚­ì œê¶Œ", icon: "ğŸ«", price: 1500000, effect: "warnClear", cat: 3 },
    { id: 12, name: "ëœë¤ ì•„ì´ì½˜ ë°•ìŠ¤", icon: "ğŸ", price: 5000, effect: "randomBox", cat: 4 },
    { id: 7, name: "ë¡œë˜ êµ¬ë§¤", icon: "ğŸŸï¸", price: 2000, effect: "lotto", cat: 5 },
    { id: 14, name: "ìŠ¤í”¼ë˜ ë³µê¶Œ", icon: "ğŸ§§", price: 2000, effect: "spitto", cat: 5 },
    { id: 101, name: "ì‹ë£Œí’ˆ ìƒì", icon: "ğŸ", price: 10000, effect: "trade_cargo", value: "ì‹ë£Œí’ˆ", cat: 6 },
    { id: 103, name: "ê³µì—…í’ˆ ìƒì", icon: "âš™ï¸", price: 15000, effect: "trade_cargo", value: "ê³µì—…í’ˆ", cat: 6 },
    { id: 102, name: "ê³µì˜ˆí’ˆ ìƒì", icon: "ğŸº", price: 20000, effect: "trade_cargo", value: "ê³µì˜ˆí’ˆ", cat: 6 },
    { id: 104, name: "ê·€ê¸ˆì† ìƒì", icon: "ğŸª™", price: 25000, effect: "trade_cargo", value: "ê·€ê¸ˆì†", cat: 6 },
    { id: 105, name: "ë³´ì„ ìƒì", icon: "ğŸ’", price: 30000, effect: "trade_cargo", value: "ë³´ì„", cat: 6 },
    { id: 106, name: "ì„ ë°• ì´ë¦„ë³€ê²½ê¶Œ", icon: "ğŸ“", price: 500000, effect: "ship_rename", cat: 6 }
];

/* [ì‹ ê·œ] ëœë¤ ì•„ì´ì½˜ ë°•ìŠ¤ ìƒì„¸ êµ¬ì„± ë° í™•ë¥  ì„¤ì • */
var RANDOM_BOX_CONFIG = {
    PROBS: [
        { grade: "ê½ (Trash)", icon: "ğŸ’©", prob: 0.60, items: ["ğŸ’©", "ğŸ¤¡", "ğŸ§¤", "ğŸ‘", "ğŸŒ‚", "ğŸª ", "ğŸš½", "ğŸ¦´", "ğŸ§±", "ğŸ§¹", "ğŸ§º", "ğŸ§»", "ğŸ§¼", "ğŸ¦¶", "ğŸ¦Ÿ"] },
        { grade: "ë…¸ë§ (Normal)", icon: "ğŸŒ±", prob: 0.20, items: ["ğŸŒ±", "âš”ï¸", "â£ï¸", "ğŸ€", "ğŸ€", "ğŸˆ", "ğŸ§¸", "ğŸª", "ğŸ­", "ğŸ", "ğŸ„", "ğŸŒ»", "ğŸ±", "ğŸ¶", "ğŸ"] },
        { grade: "ë ˆì–´ (Rare)", icon: "ğŸ’", prob: 0.10, items: ["ğŸ’", "ğŸ‘¾", "ğŸ›¡ï¸", "ğŸ°", "ğŸ”±", "ğŸ§¿", "ğŸ­", "ğŸ¨", "ğŸ§ª", "ğŸ”­", "ğŸ¸", "ğŸ¹", "ğŸ•¯ï¸", "â›“ï¸", "ğŸ§¬"] },
        { grade: "ì—í”½ (Epic)", icon: "ğŸ”®", prob: 0.05, items: ["ğŸ‘‘", "â˜„ï¸", "ğŸ§¨", "ğŸ”®", "â›©ï¸", "ğŸ¡", "ğŸš", "ğŸŒ‹", "ğŸ…", "ğŸ¦…", "ğŸ¹", "ğŸ°", "ğŸ›¥ï¸", "ğŸ§¿"] },
        { grade: "ìœ ë‹ˆí¬ (Unique)", icon: "ğŸ¦„", prob: 0.03, items: ["ğŸª", "ğŸ®", "ğŸ²", "ğŸ¦¾", "ğŸ›°ï¸", "ğŸ¦„", "ğŸ§", "ğŸ¦", "ğŸ‹", "ğŸ¦œ", "ğŸ•¸ï¸", "ğŸƒ", "ğŸ…", "ğŸ§œ"] },
        { grade: "ë ˆì „ë”ë¦¬ (Legendary)", icon: "ğŸ°", prob: 0.02, items: ["ğŸ”¥", "ğŸ’«", "ğŸŒŒ", "âš¡", "ğŸ›¸", "ğŸŒˆ", "â˜€ï¸", "â„ï¸", "ğŸŒ‘", "ğŸ”±", "ğŸ’®", "ğŸ’ ", "ğŸ–ï¸" ] }
    ],
    PAYBACK: 2000 // ì¤‘ë³µ ì•„ì´ì½˜ ë‹¹ì²¨ ì‹œ í™˜ê¸‰ê¸ˆ
};

//==========ì„¹í„°6==========

/**
 * [ì‹œìŠ¤í…œ ëª¨ë“ˆ] ëª…ë ¹ì–´ ìë™ ë“±ë¡ ë° ë„ì›€ë§ ê´€ë¦¬
 * ê¸°ëŠ¥: CMD_LISTì˜ ë°ì´í„°ë¥¼ USER_COMMANDS/ADMIN_COMMANDS ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— ë§¤í•‘í•˜ê³  ë„ì›€ë§ ìƒì„±
 */

/* [1] ë„ì›€ë§ ìƒì„± í•¨ìˆ˜ (ë™ì  ë Œë”ë§) */
function generateHelpMenu(category) {
    var list = [];
    for (var cmd in USER_COMMANDS) {
        var item = USER_COMMANDS[cmd];
        if (item.cat === category) {
            list.push("â€¢ " + cmd + ": " + item.desc);
        }
    }
    return list.length > 0 ? list.join("\n") : "í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì— ì¤€ë¹„ëœ ëª…ë ¹ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.";
}

function generateAdminHelp() {
    var list = [];
    var idx = 1;
    for (var cmd in ADMIN_COMMANDS) {
        list.push(idx + ". " + cmd + " (" + ADMIN_COMMANDS[cmd].desc + ")");
        idx++;
    }
    return "âš™ï¸ [ê´€ë¦¬ì ì „ìš© ëª…ë ¹ì–´]\n" + list.join("\n");
}

/* [2] ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸ ë°ì´í„° (ìˆ˜ì •ë¨: ê²°íˆ¬ ì‘ë‹µ ë° ê²½ë§ˆ ëª…ë ¹ì–´ í†µí•© ì¶”ê°€) */
var CMD_LIST = {
    user: [
        { cmd: "/ì¶œì„", desc: "ë§¤ì¼ í¬ì¸íŠ¸ íšë“", cat: "ì¡°íšŒ", func: "_gameShopLogic" },
        { cmd: "/ë‚´ì •ë³´", desc: "ë‚´ ìŠ¤íƒ¯ í™•ì¸", cat: "ì¡°íšŒ", func: "_gameInfoLogic" },
        { cmd: "/ê°€ì´ë“œ", desc: "ì‹¬í™” ì‹œìŠ¤í…œ ê°€ì´ë“œ í™•ì¸", cat: "ì¡°íšŒ", func: "_gameInfoLogic" },
        { cmd: "/ì‹ ìš©ë“±ê¸‰", desc: "ì‹ ìš© ì ìˆ˜ì™€ ë“±ê¸‰ í™•ì¸", cat: "ì¡°íšŒ", func: "_gameInfoLogic" },
        { cmd: "/ì¶œì„ìˆœìœ„", desc: "í¬ì¸íŠ¸ ë­í‚¹ í™•ì¸", cat: "ì¡°íšŒ", func: "_gameInfoLogic" },
        { cmd: "/ìœ ì €ì •ë³´", desc: "[ë‹‰ë„¤ì„] ìƒì„¸ì •ë³´ ë³´ê¸°", cat: "ì¡°íšŒ", func: "_gameInfoLogic" },
        { cmd: "/ëª…ì˜ˆì˜ì „ë‹¹", desc: "ì±Œë¦°ì € ëª…ë‹¨ í™•ì¸", cat: "ì¡°íšŒ", func: "_gameInfoLogic" },
        { cmd: "/ë²„ê·¸ì œë³´", desc: "[ë‚´ìš©] ì˜¤ë¥˜ ë° ë²„ê·¸ ì‹ ê³ ", cat: "ì¡°íšŒ", func: "_gameInfoLogic" },
        { cmd: "/í•‘", desc: "ë´‡ ì‘ë‹µ ì†ë„ ì¸¡ì •", cat: "ì¡°íšŒ", func: "_gameInfoLogic" },
        { cmd: "/ê²½ë§ˆ", desc: "í˜„ì¬ ì¶œì „ë§ˆ ì •ë³´ ë° ë°°ë‹¹ í™•ì¸", cat: "ì¡°íšŒ", func: "_gameInfoLogic" }, // [ì‹ ê·œ ê²½ë§ˆ ì¡°íšŒ]
        { cmd: "/ì½”ë“œí™•ì¸", desc: "ê¸°ê¸°ë³€ê²½/ì „ì²´ë³€ê²½ ëŒ€ë¹„ ë³µêµ¬ì½”ë“œ í™•ì¸", cat: "ì¡°íšŒ", func: "_gameInfoLogic" },
        { cmd: "/ê³„ì •ì—°ë™", desc: "[ì½”ë“œ] ì…ë ¥í•˜ì—¬ ì´ì „ ë°ì´í„° ë³µêµ¬", cat: "ì¡°íšŒ", func: "_gameInfoLogic" },
        { cmd: "/ì¹´ì§€ë…¸", desc: "ì‚¬ë‹¤ë¦¬ ë° ë°”ì¹´ë¼ í†µí•© ê²Œì„ì¥", cat: "ê²Œì„", func: "_gameCasinoLogic" },
        { cmd: "/í™€ì§", desc: "(í†µí•©ë¨) /ì¹´ì§€ë…¸ ëª…ë ¹ì–´ë¥¼ ì´ìš©í•˜ì„¸ìš”", cat: "ê²Œì„", func: "_gameActionLogic" },
        { cmd: "/ìŠ¹ê¸‰", desc: "í‹°ì–´ ìŠ¹ê¸‰ ë„ì „", cat: "ê²Œì„", func: "_gameActionLogic" },
        { cmd: "/ë°°íŒ…", desc: "[ë§ë²ˆí˜¸] [í¬ì¸íŠ¸] ê²½ë§ˆ ì°¸ì—¬", cat: "ê²Œì„", func: "_gameActionLogic" }, // [ì‹ ê·œ ê²½ë§ˆ ë°°íŒ…]
        { cmd: "ë°°íŒ…ì·¨ì†Œ", desc: "í˜„ì¬ íšŒì°¨ ë°°íŒ… ì² íšŒ (ìˆ˜ìˆ˜ë£Œ 10%)", cat: "ê²Œì„", func: "_gameActionLogic" }, // [ì‹ ê·œ ê²½ë§ˆ ì·¨ì†Œ]
        { cmd: "/ê²°íˆ¬", desc: "[ë‹‰ë„¤ì„] [í¬ì¸íŠ¸] ì‹ ì²­", cat: "ê²Œì„", func: "_gameActionLogic" },
        { cmd: "ìˆ˜ë½", desc: "ê²°íˆ¬ ì‹ ì²­ ìŠ¹ë‚™", cat: "ê²Œì„", func: "_gameActionLogic" },
        { cmd: "ê±°ì ˆ", desc: "ê²°íˆ¬ ì‹ ì²­ ê±°ì ˆ", cat: "ê²Œì„", func: "_gameActionLogic" },
        { cmd: "ì·¨ì†Œ", desc: "ê²°íˆ¬ ì‹ ì²­ ì² íšŒ", cat: "ê²Œì„", func: "_gameActionLogic" },
        { cmd: "/ë„ë‘‘ì§ˆ", desc: "[ë‹‰ë„¤ì„] í¬ì¸íŠ¸ íƒˆì·¨ ì‹œë„", cat: "ê²Œì„", func: "_gameActionLogic" },
        { cmd: "ì¡ì•˜ë‹¤ìš”ë†ˆ", desc: "ë„ë‘‘ì§ˆ ë°©ì–´ (1ë¶„ ì´ë‚´)", cat: "ê²Œì„", func: "_gameActionLogic" },
        { cmd: "ì¤ê¸°", desc: "ë°”ë‹¥ì— ë–¨ì–´ì§„ í¬ì¸íŠ¸ íšë“", cat: "ê²Œì„", func: "_gameActionLogic" },
        { cmd: "/ìƒì ", desc: "ì•„ì´ì½˜ ë° ë°©ì–´ê¶Œ êµ¬ë§¤", cat: "ìƒì ", func: "_gameShopLogic" },
        { cmd: "/êµ¬ë§¤", desc: "[ë²ˆí˜¸] ìƒì  ë¬¼í’ˆ êµ¬ë§¤", cat: "ìƒì ", func: "_gameShopLogic" },
        { cmd: "/ê°€ë°©", desc: "ë³´ìœ  ì¤‘ì¸ ì•„ì´ì½˜/ì¹­í˜¸ í™•ì¸", cat: "ìƒì ", func: "_handleInventoryLogic" },
        { cmd: "/ì¥ì°©", desc: "[ë²ˆí˜¸] ë³´ìœ  ì•„ì´í…œ ì¥ì°©", cat: "ìƒì ", func: "_handleInventoryLogic" },
        { cmd: "/ë¶„í•´", desc: "[ë²ˆí˜¸] ì•„ì´ì½˜ ë¶„í•´ ë° í¬ì¸íŠ¸ íšŒìˆ˜", cat: "ìƒì ", func: "_handleInventoryLogic" },
        { cmd: "/ë¡œë˜ì •ë³´", desc: "ë‚´ ë¡œë˜ ë²ˆêµ¬ ë° ê²°ê³¼ í™•ì¸", cat: "ìƒì ", func: "_handleLottoLogic" },
        { cmd: "/ì•„ì´ì½˜ì´ˆê¸°í™”", desc: "ì„¤ì •í•œ ì•„ì´ì½˜ ì‚­ì œ", cat: "ìƒì ", func: "_handleLottoLogic" },
        { cmd: "/ì€í–‰", desc: "ì˜ˆê¸ˆ/ì¶œê¸ˆ/ì†¡ê¸ˆ/ëŒ€ì¶œ/ì‚¬ì±„ ì¢…í•© ê´€ë¦¬", cat: "ê²½ì œ", func: "_gameBankLogic" },
        { cmd: "/ëŒ€ì¶œí•œë„", desc: "ì‹ ìš© ë“±ê¸‰ë³„ í•œë„ í™•ì¸", cat: "ê²½ì œ", func: "_gameInfoLogic" },
        { cmd: "/ìƒí™˜", desc: "[ê¸ˆì•¡] ëŒ€ì¶œê¸ˆ ì§ì ‘ ìƒí™˜", cat: "ê²½ì œ", func: "_gameBankLogic" },
        { cmd: "/ëœë“œë§ˆí¬", desc: "ì‹¤ì‹œê°„ ë¶€ë™ì‚° ì‹œì„¸ í™•ì¸", cat: "ë¶€ë™ì‚°", func: "_gameLandmarkLogic" },
        { cmd: "/ë‚´ë¶€ë™ì‚°", desc: "ë³´ìœ  ì§€ë¶„ ë° ìˆ˜ìµë¥  í™•ì¸", cat: "ë¶€ë™ì‚°", func: "_gameLandmarkLogic" },
        { cmd: "/íˆ¬ì", desc: "[ê±´ë¬¼ëª…] [ìˆ˜ëŸ‰] ì§€ë¶„ ë§¤ì…", cat: "ë¶€ë™ì‚°", func: "_gameLandmarkLogic" },
        { cmd: "/ë§¤ê°", desc: "[ê±´ë¬¼ëª…] [ìˆ˜ëŸ‰] ì§€ë¶„ ì²˜ë¶„", cat: "ë¶€ë™ì‚°", func: "_gameLandmarkLogic" },
        { cmd: "/ê´‘ì‚°ì‹œì‘", desc: "ë°©ì¹˜í˜• í¬ì¸íŠ¸ ì±„êµ´ ì‹œì‘", cat: "ê´‘ì‚°", func: "_handleMiningLogic" },
        { cmd: "/ê´‘ì‚°ì •ë³´", desc: "í˜„ì¬ ì±„êµ´ í˜„í™© ë° ì˜ˆìƒ ìˆ˜ìµ í™•ì¸", cat: "ê´‘ì‚°", func: "_handleMiningLogic" },
        { cmd: "/ê´‘ì‚°ì¢…ë£Œ", desc: "ì±„êµ´ ì™„ë£Œ ë° í¬ì¸íŠ¸ ì •ì‚°", cat: "ê´‘ì‚°", func: "_handleMiningLogic" },
        { cmd: "/ìœ ë¬¼ë„ê°", desc: "ìœ ë¬¼ ì¡°ê° ìˆ˜ì§‘ í˜„í™© í™•ì¸", cat: "ê´‘ì‚°", func: "_gameInfoLogic" },
        { cmd: "/ì˜íšŒ", desc: "í˜„ì¬ ì •ì±… ë° ì•ˆê±´ ì¡°íšŒ", cat: "ì •ë¶€", func: "_gameGovernmentLogic" },
        { cmd: "/íˆ¬í‘œ", desc: "[ì°¬ì„±|ë°˜ëŒ€] ì•ˆê±´ íˆ¬í‘œ ì°¸ì—¬", cat: "ì •ë¶€", func: "_gameGovernmentLogic" },
        { cmd: "/ìŠ¤í”¼ë˜", desc: "ì¦‰ì„ë³µê¶Œ êµ¬ë§¤ (1,000P)", cat: "ìƒ", func: "_gameLotteryLogic" },
        { cmd: "/ë‚šì‹œ", desc: "ê°•ê°€ì—ì„œ ë¬¼ê³ ê¸° ë‚šê¸° (10ë¶„ ì¿¨íƒ€ì„)", cat: "ê²Œì„", func: "_gameActivityLogic" },
        { cmd: "/ë¬´ì—­", desc: "ê°€ìƒ êµ­ê°€ì™€ì˜ í•´ìƒ êµì—­ ë° ì„ ë°• ê´€ë¦¬", cat: "ë¬´ì—­", func: "_gameTradeLogic" }
    ],
    admin: [
        { cmd: "/ê³µì§€", desc: "[ë‚´ìš©] ë‚´ë¦¬ë‹¤ ë°©ì— ê³µì§€ ì „ì†¡", func: "_adminSystemLogic" },
        { cmd: "/ë´‡êµ¬ë™", desc: "[ì˜¨|ì˜¤í”„] ì‹œìŠ¤í…œ ì œì–´", func: "_adminSystemLogic" },
        { cmd: "/ì§„ë‹¨", desc: "[ë‹‰ë„¤ì„] ìœ ì € ìƒíƒœ ì •ë°€ ë¶„ì„", func: "_adminUserManageLogic" },
        { cmd: "/ë¬´ì—­ë³µêµ¬", desc: "[ë‹‰ë„¤ì„] ì •ì‚° ê¼¬ì„ ê°•ì œ í•´ì œ ë° ì¬ì‹œì‘", func: "_adminUserManageLogic" },
        { cmd: "/ë¸”ë™ë°•ìŠ¤", desc: "[ë‹‰ë„¤ì„] ìµœê·¼ ê±°ë˜ ë‚´ì—­ ì—­ì¶”ì ", func: "_adminUserManageLogic" },
        { cmd: "/ë¶€ë™ì‚°ìì‚°ë³µêµ¬", desc: "ìœ ì € í‰ë‹¨ê°€ ê¸°ë°˜ ì‹œì„¸ ê¸´ê¸‰ ë³µêµ¬", func: "_adminEconomyLogic" },
        { cmd: "/ë§¤ë¬¼ì¶”ê°€", desc: "[ì´ë¦„] [ê°€ê²©] ì‹ ê·œ ìƒì¥", func: "_adminEconomyLogic" },
        { cmd: "/ë§¤ë¬¼ì‚­ì œ", desc: "[ê±´ë¬¼ëª…] ì‹œì¥ì—ì„œ ì˜êµ¬ ì œê±°", func: "_adminEconomyLogic" },
        { cmd: "/ë§¤ë¬¼ìˆ˜ì •", desc: "[ê¸°ì¡´] [ìƒˆì´ë¦„] [ê°€ê²©] ìˆ˜ì •", func: "_adminEconomyLogic" },
        { cmd: "/ê²½ì œì •ë³´", desc: "ì€í–‰ ì¬ì› ë° ê²½ì œ ì§€í‘œ í™•ì¸", func: "_adminEconomyLogic" },
        { cmd: "/ì¬ì›ìˆ˜ì •", desc: "[ê¸ˆì•¡] ì€í–‰ ê¸ˆê³  ìë³¸ ì¡°ì •", func: "_adminEconomyLogic" },
        { cmd: "/ë°ì´í„°êµì •", desc: "ì€í–‰ ì¬ì› ë° ìœ ì € ë°ì´í„° ë™ê¸°í™”", func: "_adminEconomyLogic" },
        { cmd: "/ë¬¼ê°€ì¡°ì •", desc: "[ê¸°ì¤€ê°’] ì¸í”Œë ˆ ë°˜ì˜ ìƒì ê°€ ì¡°ì ˆ", func: "_adminEconomyLogic" },
        { cmd: "/ë¬¼ê°€ì™„ì¶©", desc: "[0.0~1.0] ë¬¼ê°€ ë³€ë™í­ ì¡°ì ˆ", func: "_adminEconomyLogic" },
        { cmd: "/ê°•ì œì¬ê°€ë™", desc: "ì‹œìŠ¤í…œ ë½ í•´ì œ ë° ë¦¬ì…‹", func: "_adminSystemLogic" },
        { cmd: "/ì„œë²„ìƒíƒœ", desc: "ì§€ëŠ¥í˜• ì„±ëŠ¥ ê°ì‹œì(IPM) ëŒ€ì‹œë³´ë“œ", func: "_adminEconomyLogic" },
        { cmd: "/ìœ ì €ì‚­ì œ", desc: "[ë‹‰ë„¤ì„] ë°ì´í„° ì˜êµ¬ ì‚­ì œ", func: "_adminUserManageLogic" },
        { cmd: "/ìœ ì €ë°ì´í„°", desc: "ìƒì„¸ JSON ë°ì´í„° í™•ì¸", func: "_adminUserManageLogic" },
        { cmd: "/ë°ì´í„°ì´ì „", desc: "[êµ¬ë‹‰] > [ì‹ ë‹‰] ìì‚° ì´ì „", func: "_adminUserManageLogic" },
        { cmd: "/ë‹‰ë„¤ì„ê¸°ë¡", desc: "[ë‹‰ë„¤ì„] ë³€ê²½ ì´ë ¥ ì¡°íšŒ", func: "_adminUserManageLogic" },
        { cmd: "/ì¶œì„ì´ˆê¸°í™”", desc: "[ë‹‰ë„¤ì„] ì˜¤ëŠ˜ ê¸°ë¡ ì‚­ì œ", func: "_adminUserManageLogic" },
        { cmd: "/ì±„êµ´ì‹œê°„ë³µêµ¬", desc: "[ë‹‰ë„¤ì„] [ë¶„] ê°œë³„ ë³µêµ¬", func: "_adminUserManageLogic" },
        { cmd: "/ì „ì²´ì±„êµ´ë³µêµ¬", desc: "00ì‹œ ëˆ„ë½ë¶„ + ì˜¤ëŠ˜ ì±„êµ´ë¶„ ìë™ í•©ì‚° ë³µêµ¬", func: "_adminUserManageLogic" },
        { cmd: "/ë°°ë‹¹ê¸ˆê°•ì œì •ì‚°", desc: "ëˆ„ë½ëœ ë°°ë‹¹ê¸ˆ ì¦‰ì‹œ ì§€ê¸‰ ë° ì£¼ë¨¸ë‹ˆ ì´ˆê¸°í™”", func: "_adminUserManageLogic" },
        { cmd: "/í¬ì¸íŠ¸ì§€ê¸‰", desc: "[ë‹‰ë„¤ì„] [ìˆ˜ëŸ‰] ì§ì ‘ ì§€ê¸‰", func: "_adminEconomyLogic" },
        { cmd: "/ì „ì²´í¬ì¸íŠ¸ì§€ê¸‰", desc: "[ìˆ˜ëŸ‰] ì „ì› ì§€ê¸‰", func: "_adminEconomyLogic" },
        { cmd: "/í¬ì¸íŠ¸ì°¨ê°", desc: "[ë‹‰ë„¤ì„] [ìˆ˜ëŸ‰] ì°¨ê°", func: "_adminEconomyLogic" },
        { cmd: "/ë„ë°•ì œí•œ", desc: "[ì˜¨|ì˜¤í”„] ì‹œìŠ¤í…œ ì œì–´", func: "_adminSystemLogic" },
        { cmd: "/ë¿Œë¦¬ê¸°", desc: "ëœë¤ í¬ì¸íŠ¸ ì„ ì°©ìˆœ ì´ë²¤íŠ¸", func: "_adminEconomyLogic" },
        { cmd: "/ê´€ë¦¬ìë“±ë¡", desc: "[ë‹‰ë„¤ì„] ë¶€ê´€ë¦¬ì ì¶”ê°€", func: "_adminSystemLogic" },
        { cmd: "/ê´€ë¦¬ìí•´ì œ", desc: "[ë‹‰ë„¤ì„] ê´€ë¦¬ì ê¶Œí•œ ë°•íƒˆ", func: "_adminSystemLogic" },
        { cmd: "/ê´€ë¦¬ìëª©ë¡", desc: "ê¶Œí•œ ë³´ìœ ì ëª…ë‹¨ ì¡°íšŒ", func: "_adminSystemLogic" },
        { cmd: "/ê´€ë¦¬ìë¡œê·¸", desc: "ìµœê·¼ ê´€ë¦¬ í™œë™ ë‚´ì—­", func: "_adminLogLogic" },
        { cmd: "/ì œë³´ëª©ë¡", desc: "ë²„ê·¸ ì œë³´ í™•ì¸", func: "_adminLogLogic" },
        { cmd: "/ì œë³´ì´ˆê¸°í™”", desc: "ì œë³´ ë‚´ì—­ ì „ì²´ ì‚­ì œ", func: "_adminLogLogic" },
        { cmd: "/ì˜¤ë¥˜ë¡œê·¸", desc: "ì‹œìŠ¤í…œ ì—ëŸ¬ ë¡œê·¸ í™•ì¸", func: "_adminLogLogic" },
        { cmd: "/ì˜¤ë¥˜ì´ˆê¸°í™”", desc: "ì‹œìŠ¤í…œ ì—ëŸ¬ ë¡œê·¸ ì‚­ì œ", func: "_adminLogLogic" },
        { cmd: "/ìŠ¹ê¸‰íšŸìˆ˜ì´ˆê¸°í™”", desc: "ì „ì²´ ìŠ¹ê¸‰ ê¸°íšŒ ë¦¬ì…‹", func: "_adminEconomyLogic" },
        { cmd: "/ëª…ë ¹ì–´ì ê²€", desc: "í•µì‹¬ ë¡œì§ ì‘ë™ ì—¬ë¶€ ì „ìˆ˜ ì¡°ì‚¬", func: "_adminEconomyLogic" },
        { cmd: "/ì‹œì¦Œê°•ì œì¢…ë£Œ", desc: "ëª¨ë“  í‹°ì–´ ì´ˆê¸°í™”", func: "_adminEconomyLogic" },
        { cmd: "/ì¶œì„ì¼ìˆ˜ìˆ˜ì •", desc: "[ë‹‰ë„¤ì„] [ìˆ˜ì¹˜] ìˆ˜ì •", func: "_adminUserManageLogic" },
        { cmd: "/ì „ì²´ì¶œì„ìˆ˜ì •", desc: "ëª¨ë“  ìœ ì € ì¶œì„ì¼ ê³ ì •", func: "_adminUserManageLogic" },
        { cmd: "/ë¡œë˜ë°ì´í„°ì´ˆê¸°í™”", desc: "ë¡œë˜ ì‹œìŠ¤í…œ ë¦¬ì…‹", func: "_adminEconomyLogic" },
        { cmd: "/ì „ì²´ë³µì›", desc: "ë°ì´í„° ë¡¤ë°± (ì•ˆì „ ì§€ì )", func: "_adminEconomyLogic" },
        { cmd: "/ìœ ì €ë³µì›", desc: "[ë‹‰ë„¤ì„] ë¶€ë¶„ ë³µêµ¬", func: "_adminUserManageLogic" },
        { cmd: "/ì‹œìŠ¤í…œìê°€ë³µì›", desc: "ë©”ëª¨ë¦¬ ìµœì í™” ë° ë³€ìˆ˜ ì´ˆê¸°í™”", func: "_adminEconomyLogic" },
        { cmd: "/ì´ì›”ê¸ˆìˆ˜ì •", desc: "[ê¸ˆì•¡] ê²½ë§ˆ ì­íŒŸ ê¸ˆì•¡ ê°•ì œ ì¡°ì •", func: "_adminEconomyLogic" },
        { cmd: "/ì¬ì›ì¶©ì „", desc: "[ê¸ˆì•¡] ì€í–‰ ê¸ˆê³  ìë³¸ ê¸´ê¸‰ ìˆ˜í˜ˆ", func: "_adminEconomyLogic" },
        { cmd: "/ë³´ì•ˆì ê²€", desc: "ë°ì´í„° ë³´í˜¸ ì—”ì§„ ìê°€ì§„ë‹¨", func: "_adminEconomyLogic" },
        { cmd: "/êµ­ê³ ë¡œê·¸", desc: "ì¤‘ì•™ì€í–‰ ì¬ì› ë³€ë™ ë‚´ì—­ ì‹¤ì‹œê°„ ì¶”ì ", func: "_adminEconomyLogic" },
        { cmd: "/ëª…ë¶€í™•ì¸", desc: "ë“±ë¡ëœ ì „ì²´ ìœ ì € ë³µêµ¬ ì½”ë“œ ì¡°íšŒ", func: "_adminEconomyLogic" },
        { cmd: "/ëª…ë¶€ì‚­ì œ", desc: "[ë‹‰ë„¤ì„] íŠ¹ì • ìœ ì € ëª…ë¶€ ê°•ì œ ì‚­ì œ", func: "_adminEconomyLogic" },
        { cmd: "/ëª…ë¶€ì—…ë°ì´íŠ¸", desc: "ë“±ë¡ëœ ì „ì²´ ìœ ì € ë³µêµ¬ ì½”ë“œ ì—…ë°ì´íŠ¸", func: "_adminEconomyLogic" },
        { cmd: "/ì‹ ìš©ì¡°ì •", desc: "[ë‹‰ë„¤ì„] [ì ìˆ˜] ì‹ ìš©ì ìˆ˜ ì§ì ‘ ê°€ê°", func: "_adminUserManageLogic" },
        { cmd: "/ì¹­í˜¸íšŒìˆ˜", desc: "[ë‹‰ë„¤ì„] [ì¹­í˜¸ëª…] ë°•íƒˆ", func: "_adminUserManageLogic" },
        { cmd: "/ì¡°ì‘", desc: "[ë‹‰ë„¤ì„] [í™€ì§%] [ë‚šì‹œ%]", func: "_adminUserManageLogic", hidden: true },
        { cmd: "/ë°°ë‹¹ë³µêµ¬", desc: "ë¡œê·¸ ê¸°ë°˜ ë°°ë‹¹ê¸ˆ ì†Œê¸‰ í•©ì‚°", func: "_adminEconomyLogic", hidden: true },
        { cmd: "/ë°°ë‹¹ì´ˆê¸°í™”", desc: "[í•­ëª©] ë°°ë‹¹ ì£¼ë¨¸ë‹ˆ ê°•ì œ ë¦¬ì…‹", func: "_adminEconomyLogic", hidden: true },
        { cmd: "/ë³´ì•ˆí…ŒìŠ¤íŠ¸", desc: "[1-3] ë³´ì•ˆ ì—”ì§„ 4ë‹¨ê³„ ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸", func: "_adminEconomyLogic" },
        { cmd: "/ì „ì²´ë¶€ë™ì‚°", desc: "ì „ êµ¬ì—­ ìœ ì €ë“¤ì˜ ë¶€ë™ì‚° ë³´ìœ  í˜„í™© ì´ê´„ ì¡°íšŒ", func: "_adminEconomyLogic" },
        { cmd: "/ë¶€ë™ì‚°íšŒìˆ˜", desc: "[ë‹‰ë„¤ì„] [ê±´ë¬¼ëª…] [ìˆ˜ëŸ‰|ì „ë¶€] ì§€ë¶„ ê°•ì œ ëª°ìˆ˜", func: "_adminEconomyLogic" },
        { cmd: "/ë°°ë‹¹í˜„í™©", desc: "6ëŒ€ í•µì‹¬ ëœë“œë§ˆí¬ì˜ ë‹¹ì¼ ëˆ„ì  ì˜ˆìƒ ë°°ë‹¹ê¸ˆ ì‹¤ì‹œê°„ ì¡°íšŒ", func: "_adminEconomyLogic" },
        { cmd: "/ì‹œì¥ë°ì´í„°êµì •", desc: "í—¬ëŸ¬ ê°„ì„­ìœ¼ë¡œ ê¼¬ì¸ ëœë“œë§ˆí¬ ìˆ˜ëŸ‰ ê°•ì œ ì••ì¶• ë° êµì •", func: "_adminEconomyLogic" },
        { cmd: "/ê²½ì œì „ì²´ë¦¬ì…‹", desc: "ëª¨ë“  ìœ ì € ìì‚°/ë¶€ì±„ ì´ˆê¸°í™”ë° 20ë§ŒP ê³µí‰ ì§€ê¸‰", func: "_adminEconomyLogic" },
        { cmd: "/ìì •í…ŒìŠ¤íŠ¸", desc: "00ì‹œ ë¦¬ì…‹ ë¡œì§ ê°•ì œ íŠ¸ë¦¬ê±°", func: "_adminEconomyLogic" },
        { cmd: "/ì—°ë™ì§„ë‹¨", desc: "1:1 ì±„íŒ…ë°© ê³„ì • ì—°ë™ ìƒíƒœ ë¶„ì„", func: "_adminUserManageLogic" },
        { cmd: "/ë°©ëª©ë¡", desc: "DB ì „ì²´ ë°© ë¦¬ìŠ¤íŠ¸ ë° ìœ ì €ìˆ˜ ìŠ¤ìº”", func: "_adminSystemLogic" },
        { cmd: "/ì§€ë¶„í˜„í™©", desc: "ì „ êµ¬ì—­ ëœë“œë§ˆí¬ ì†Œìœ ì ë° ì§€ë¶„ ìƒì„¸ ì¡°íšŒ", func: "_adminEconomyLogic" }
    ]
};

/* ì „ì—­ ìƒíƒœ ë³€ìˆ˜ë“¤ (ì„¹í„°1ê³¼ ì¤‘ë³µ ë°©ì§€ ì²˜ë¦¬) */ 
var sprayData = { 
    totalPoint: 0, 
    remainingPoint: 0, 
    maxWinners: 0, 
    currentWinners: 0, 
    winnersList: [], 
    isActive: false, 
    timer: null 
};

/* ì„¹í„°1ì— ì—†ëŠ” ë³€ìˆ˜ë§Œ ì‹ ê·œ ì„ ì–¸ */ 
// var selectWaitState = {}; 
// var bankProcessState = {};

//==========ì„¹í„°7==========

/**
 * [ì‹ ì„¤: ê°€ìƒ ì •ë¶€ ì •ì±… ì¶”ì¶œê¸°] v1.0
 * ê¸°ëŠ¥: í•´ë‹¹ ë°©ì˜ í˜„ì¬ ì‹œí–‰ ì¤‘ì¸ ì •ì±… ê°ì²´ë¥¼ ì•ˆì „í•˜ê²Œ ë°˜í™˜
 */
function util_getActivePolicy(roomData) {
    if (roomData && roomData.features && roomData.features.government && roomData.features.government.activePolicy) {
        return roomData.features.government.activePolicy;
    }
    // ì •ì±… ë°ì´í„°ê°€ ì—†ì„ ê²½ìš° í‘œì¤€ ê¸°ë³¸ê°’ ë°˜í™˜ (ì‹œìŠ¤í…œ ì¤‘ë‹¨ ë°©ì§€)
    return {
        stockTax: 0.05,
        mineMult: 1.0,
        attendMult: 1.0,
        loanLimitMult: 1.2,
        bankInterest: 0.01,
        theftFineMult: 1.0,
        policeProbAdj: 0.0
    };
}

/**
 * [ì‹ ì„¤] ì…ë ¥ ëŒ€ê¸°ì—´ ìë™ ë§Œë£Œ ì—”ì§„ (Auto-Timeout Guard)
 * ê¸°ëŠ¥: 30ì´ˆê°„ ì‘ë‹µ ì—†ëŠ” ìœ ì €ë¥¼ íƒì§€í•˜ì—¬ ì¦‰ì‹œ ì•Œë¦¼ì„ ë°œì†¡í•˜ê³  ëŒ€ê¸° ìƒíƒœë¥¼ í•´ì œí•©ë‹ˆë‹¤.
 * (ì´ í•¨ìˆ˜ëŠ” ì„¹í„° 16-1ì˜ ìŠ¤ì¼€ì¤„ëŸ¬ ë£¨í”„ì—ì„œ í˜¸ì¶œë©ë‹ˆë‹¤.)
 */
function util_autoClearTimeouts(data) {
    var now = Date.now();
    for (var rName in data.rooms) {
        var roomObj = data.rooms[rName];
        if (!roomObj || !roomObj.features || !roomObj.features.states) continue;
        
        var states = roomObj.features.states;
        var queues = ["menuWait", "bankProcess", "lottoPurchase", "selectWait"];

        queues.forEach(function(qKey) {
            var q = states[qKey];
            if (!q) return;
            for (var uid in q) {
                var entry = q[uid];
                // ê° ëŒ€ê¸°ì—´ë³„ ì‹œê°„ í•„ë“œê°’ ì°¸ì¡° (time ë˜ëŠ” timestamp)
                var startTime = entry.time || entry.timestamp || 0;
                
                if (startTime > 0 && (now - startTime > 30000)) {
                    var u = roomObj.users[uid];
                    if (u) {
                        try {
                            Api.replyRoom(rName, formatError(u, "ì…ë ¥ ì‹œê°„ ì´ˆê³¼", "30ì´ˆ ì´ë‚´ì— ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì§€ ì•Šì•„ ë©”ë‰´ê°€ ë‹«í˜”ìŠµë‹ˆë‹¤."));
                        } catch(e) {}
                    }
                    delete q[uid]; // ëŒ€ê¸° ìƒíƒœ ì¦‰ì‹œ íŒŒê¸°
                    safeSaveData(data); // ìƒíƒœ ë³€ê²½ ì‹¤ì‹œê°„ ì €ì¥
                }
            }
        });
    }
}

/**
 * [ì›ìì  ê°œí¸: ë²”ìš© ë°ì´í„° ê²Œì´íŠ¸ì›¨ì´] v2.0
 * ê²€ì¦: íƒ€ì… ì¼ì¹˜ ë° ìœ íš¨ ìˆ«ì ì—¬ë¶€ë¥¼ ì„ í–‰ ê²€ì‚¬í•˜ê³  ì •ìƒ ë³€ê²½ ìŠ¹ì¸ í”Œë˜ê·¸ ë¶€ì—¬
 */
function util_setData(user, key, value, reason, roomName) {
    if (!user || key === undefined) return;
    
    var preValue = user[key];
    
    // [ì›ìì  ê²€ì¦] ê¸°ì¡´ ë°ì´í„°ì™€ íƒ€ì…ì´ ë‹¤ë¥´ê±°ë‚˜ ìˆ«ìê°€ ì•„ë‹Œ ê²½ìš°(NaN) ì°¨ë‹¨
    if (preValue !== undefined && preValue !== null) {
        if (typeof preValue !== typeof value || (typeof value === 'number' && isNaN(value))) {
            Log.error("[Atomic Audit Fail] " + (user.name || "Unknown") + "ì˜ " + key + " ì˜¤ì—¼ ì‹œë„ ì°¨ë‹¨ (" + reason + ")");
            return; 
        }
    }

    user[key] = value; 
    user.skipHealing = true; // ì •ìƒ ë¡œì§ì— ì˜í•œ ë³€ê²½ì´ë¯€ë¡œ í—¬ëŸ¬ ë¬´ì‹œ ê¶Œí•œ ë¶€ì—¬

    if (key === 'tier' && preValue !== value) {
        Log.info("[Status Change] " + user.name + " í‹°ì–´ ë³€ë™: " + preValue + " -> " + value);
    }
}

/**
 * [ì›ìì  ê°œí¸: ì¤‘ì•™ì€í–‰ êµ­ê³  3ì¤‘ ë°©ì–´ë§‰] v2.1 (ì „ì²´ ë¡¤ë°± ì ìš©)
 */
function util_updateReserve(roomData, delta, reason, roomName) {
    if (!roomData || isNaN(delta) || delta === 0) return;
    
    var preReserve = Number(roomData.bankReserve || 0);
    var expectedReserve = preReserve + Number(delta);

    var normalOutflow = ["ê²½ë§ˆ ë‹¹ì²¨ê¸ˆ", "ë¡œë˜", "ì£¼ì‹ ë§¤ë„", "ì€í–‰ ì¶œê¸ˆ", "ì¬ì›", "ì§€ì›ê¸ˆ", "íˆ¬í‘œ", "ê±°ë§ˆë¹„", "ìŠ¤í”¼ë˜"];
    var isVerified = normalOutflow.some(function(act) { return reason.indexOf(act) !== -1; });

    roomData.bankReserve = expectedReserve;

    var isCorrupted = isNaN(roomData.bankReserve) || (roomData.bankReserve !== expectedReserve);
    var lossRate = preReserve > 0 ? (preReserve - roomData.bankReserve) / preReserve : 0;
    var isAbnormalLoss = !isVerified && (preReserve > 100000 && lossRate >= 0.8);

    if (isCorrupted || isAbnormalLoss) {
        var db = getDatabase();
        var rName = roomName || "ë‚´ë¦¬ë‹¤";
        // [ìˆ˜ì •] êµ­ê³  ë°ì´í„° ì „ì²´ë¥¼ ì•ˆì „ ì§€ì ìœ¼ë¡œ ë¡¤ë°±
        if (db.rooms[rName]) {
            roomData.bankReserve = Number(db.rooms[rName].bankReserve || 10000);
        }
        try { Api.replyRoom(rName, "ğŸš¨ [êµ­ê³  ë³´ì•ˆ ì—”ì§„] ë¹„ì¸ê°€ ë³€ë™ ê°ì§€\nì‚¬ìœ : " + (isCorrupted ? "ì—°ì‚°ì˜¤ë¥˜" : "ì´ìƒê¸‰ê°") + "\nìƒíƒœ: êµ­ê³  ì „ì²´ ë°ì´í„°ë¥¼ ì´ì „ ì„¸ì´ë¸Œ ì§€ì ìœ¼ë¡œ ë¡¤ë°±í–ˆìŠµë‹ˆë‹¤."); } catch(e){}
    }
}

/**
 * [ì›ìì  ê°œí¸: ëœë“œë§ˆí¬ ì§€ë¶„ ì •ë°€ ê°ì‚¬] v2.2 (Landmark Edition)
 */
function util_updateLandmark(user, landName, delta, reason, roomName) {
    if (!user || !landName || isNaN(delta)) return;
    if (!user.landHoldings || typeof user.landHoldings !== 'object') {
        user.landHoldings = {};
    } else {
        // ê¸°ì¡´ ê°ì²´ë¥¼ ë³µì‚¬í•˜ì—¬ ìƒˆë¡œìš´ ë©”ëª¨ë¦¬ ì£¼ì†Œë¡œ í• ë‹¹ (ì°¸ì¡° ëŠê¸°)
        user.landHoldings = JSON.parse(JSON.stringify(user.landHoldings));
    }
    
    var preCount = Number(user.landHoldings[landName] || 0);
    var expectedCount = preCount + Number(delta);
    
    var normalLandActs = ["ë§¤ê°", "íŒë§¤", "ì²­ì‚°", "ì² ê±°", "êµì •", "ë³µêµ¬", "ì´ì „", "ì´ê´€"];
    var isVerified = normalLandActs.some(function(act) { return reason.indexOf(act) !== -1; });

    if (isVerified || delta > 0) user.skipHealing = true;
    
    user.landHoldings[landName] = expectedCount;

    if (isNaN(user.landHoldings[landName]) || user.landHoldings[landName] !== expectedCount || user.landHoldings[landName] < 0) {
        var db = getDatabase();
        var safeUser = null;
        for (var r in db.rooms) { if (db.rooms[r].users[user.uid]) { safeUser = db.rooms[r].users[user.uid]; break; } }
        
        if (safeUser) {
            var roomData = getDatabase().rooms[roomName || "ë‚´ë¦¬ë‹¤"];
            if (roomData) roomData.users[user.uid] = JSON.parse(JSON.stringify(safeUser));
            try { Api.replyRoom(roomName || "ë² ë¦­", "ğŸ›¡ï¸ [ë¶€ë™ì‚° ë³´ì•ˆ ì—”ì§„] ë°ì´í„° ì˜¤ì—¼ ê°ì§€\nëŒ€ìƒ: " + user.name + "\nìƒíƒœ: ë°ì´í„° ë¡¤ë°± ì™„ë£Œ"); } catch(e){}
        }
    }
}

/**
 * [ì›ìì  ê°œí¸: ì€í–‰ ì”ê³  ê²Œì´íŠ¸ì›¨ì´] v2.1 (ì „ì²´ ë¡¤ë°± ì ìš©)
 */
function util_updateBank(user, roomData, delta, reason, roomName) {
    if (!user || isNaN(delta) || delta === 0) return;

    var preBank = Number(user.bank || 0);
    var expectedBank = preBank + Number(delta);

    var normalBankActs = ["ì¶œê¸ˆ", "ì†¡ê¸ˆ", "ì´ì²´", "ê²°ì œ", "ì§€ë¶ˆ", "ê¸°ë¶€", "ìˆ˜ìˆ˜ë£Œ", "ì´ì", "ëŒ€ë‚©", "ì´ê´€", "ë³µêµ¬", "ì •ì‚°"];
    var isVerified = (delta > 0) || normalBankActs.some(function(act) { return reason.indexOf(act) !== -1; });

    if (isVerified) user.skipHealing = true;

    var now = Date.now();
    if (user.lastBankUpdateTime > 0 && preBank > 0) {
        var timePassed = now - user.lastBankUpdateTime;
        var earned = preBank * SYSTEM_CONFIG.ECO.BANK.INTEREST_RATE * (timePassed / 86400000);
        user.accruedInterest = (user.accruedInterest || 0) + earned;
    }
    user.lastBankUpdateTime = now;
    user.bank = Math.max(0, expectedBank);

    if (isNaN(user.bank) || user.bank !== expectedBank) {
        var db = getDatabase();
        var safeUser = null;
        for (var r in db.rooms) { if (db.rooms[r].users[user.uid]) { safeUser = db.rooms[r].users[user.uid]; break; } }
        
        if (safeUser) {
            // [í•µì‹¬: ëˆë³µì‚¬ ë°©ì§€] ì˜ˆê¸ˆ ì—°ì‚° ì˜¤ë¥˜ ì‹œ ìœ ì € ë°ì´í„° ì „ì²´ ë¡¤ë°±
            if (roomData) roomData.users[user.uid] = JSON.parse(JSON.stringify(safeUser));
            try { Api.replyRoom(roomName || "ë² ë¦­", "ğŸ›¡ï¸ [ì€í–‰ ë³´ì•ˆ ì—”ì§„] ìì‚° ì˜¤ì—¼ ì°¨ë‹¨\nëŒ€ìƒ: " + user.name + "\nìƒíƒœ: ì•ˆì „ ì„¸ì´ë¸Œ ì§€ì ìœ¼ë¡œ ì „ì²´ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤."); } catch(e){}
        }
    }
}

/**
Â * [ì‹œìŠ¤í…œ] ì§„ë‹¨ìš© ì²´í¬í¬ì¸íŠ¸ ë„ì¥ í•¨ìˆ˜
Â * ì„¤ëª…: ìŠ¤ì¼€ì¤„ëŸ¬ ë¡œì§ì˜ ì™„ê²°ì„±ì„ ì²´í¬í•˜ê¸° ìœ„í•´ ë©”ëª¨ë¦¬ì— íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ê¸°ë¡í•©ë‹ˆë‹¤.
Â */
function util_stamp(key) {
    if (typeof globalData !== 'undefined' && globalData !== null) {
        if (!globalData.statusCheck) globalData.statusCheck = {};
        globalData.statusCheck[key] = Date.now();
    }
}

/**
 * [ìˆ˜ì •] í†µí•© ìˆœìì‚° ê³„ì‚° ì—”ì§„ (ì—ëŸ¬ ë¡œê¹… ë° ì•ˆì „ì„± ê°•í™”)
 */
function util_calculateNetWorth(user, roomData) {
    if (!user) return 0;
    try {
        var data = getDatabase(); 
        var liquidAssets = Number(user.point || 0) + Number(user.bank || 0);
        var landmarkAssets = 0;

        var market = data.landmarkMarket || (roomData && roomData.features ? roomData.features.landmarkMarket : null);

        if (user.landHoldings && market) {
            for (var lName in user.landHoldings) {
                var landmark = market[lName];
                if (landmark) landmarkAssets += (Number(user.landHoldings[lName] || 0) * Number(landmark.price || 0));
            }
        }
        
        var bankDebt = (user.loan && user.loan.debt) ? Number(user.loan.debt) : 0;
        var sacheDebt = 0;
        var sacheClaims = 0; 

        if (roomData && roomData.loanContracts) {
            for (var cid in roomData.loanContracts) {
                var c = roomData.loanContracts[cid];
                if (c.borrowerUid === user.uid) sacheDebt += Number(c.currentDebt || 0);
                if (c.lenderUid === user.uid) sacheClaims += Number(c.currentDebt || 0);
            }
        }
        return Math.max(0, Math.floor(liquidAssets + landmarkAssets + sacheClaims - bankDebt - sacheDebt));
    } catch(e) {
        Log.error("NetWorth Calculation Error for " + user.name + ": " + e);
        return Number(user.point || 0); 
    }
}

/**
 * [ì‹ ì„¤: ì›ìì  ìŠ¤í…Œì´ì§• ì—”ì§„] v1.0
 * ê¸°ëŠ¥: ë¡œì§ ì‹œì‘ ì „ ìœ ì € ë°ì´í„°ì˜ 'ê°€ìƒ ë³µì‚¬ë³¸'ì„ ë§Œë“¤ì–´ ë©”ëª¨ë¦¬ì— ê²©ë¦¬í•©ë‹ˆë‹¤.
 */
function util_stagingStart(user) {
    if (!user || !user.uid) return;
    GLOBAL_STAGING.active[user.uid] = true;
    GLOBAL_STAGING.cache[user.uid] = JSON.parse(JSON.stringify(user));
}

/**
 * [ì‹ ì„¤: ì›ìì  ì»¤ë°‹] v1.0
 * ê¸°ëŠ¥: ëª¨ë“  ë¡œì§ì´ ì—ëŸ¬ ì—†ì´ ì¢…ë£Œë˜ì—ˆì„ ë•Œ, ê°€ìƒ ì£¼ë¨¸ë‹ˆì˜ ë‚´ìš©ì„ ì‹¤ì œ DBì— ë°˜ì˜í•©ë‹ˆë‹¤.
 */
function util_stagingCommit(user, roomData) {
    if (!user || !user.uid || !GLOBAL_STAGING.active[user.uid]) return;
    user.skipHealing = true;
    delete GLOBAL_STAGING.active[user.uid];
    delete GLOBAL_STAGING.cache[user.uid];
    // ì»¤ë°‹ ì„±ê³µ ì‹œ ìµœì¢… ìƒíƒœë¥¼ ë¬¼ë¦¬ íŒŒì¼ë¡œ ì˜ì†í™”
    safeSaveData(globalData);
}

/**
 * [ì‹ ì„¤: ì›ìì  ë¡¤ë°±] v1.0
 * ê¸°ëŠ¥: ë¡œì§ ë„ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´, ê°€ìƒ ì£¼ë¨¸ë‹ˆë¥¼ íŒŒê¸°í•˜ê³  ì‹œì‘ ì „ ìƒíƒœë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.
 */
function util_stagingRollback(user, roomName) {
    if (!user || !user.uid || !GLOBAL_STAGING.active[user.uid]) return;
    var snapshot = GLOBAL_STAGING.cache[user.uid];
    if (snapshot && globalData.rooms[roomName]) {
        globalData.rooms[roomName].users[user.uid] = snapshot; // ì‹œì‘ ì „ ìƒíƒœë¡œ ì¦‰ì‹œ ë³µêµ¬
    }
    delete GLOBAL_STAGING.active[user.uid];
    delete GLOBAL_STAGING.cache[user.uid];
    Log.info("[Atomic Rollback] " + user.name + "ë‹˜ì˜ íŠ¸ëœì­ì…˜ ì‹¤íŒ¨ë¡œ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
}

/**
 * [ì›ìì  ê°œí¸: í¬ì¸íŠ¸ ê²Œì´íŠ¸ì›¨ì´ ì—”ì§„] v7.2 (Staging í˜¸í™˜í˜•)
 */
function util_updatePoint(user, roomData, delta, reason, roomName) {
    if (!user || isNaN(delta) || delta === 0) return;
    
    // [v10.0] ìŠ¤í…Œì´ì§• í™œì„±í™” ì—¬ë¶€ì— ë”°ë¥¸ ë™ì  ì°¸ì¡°
    var targetUser = GLOBAL_STAGING.active[user.uid] ? user : user;
    /* (ì°¸ê³ : ìŠ¤í…Œì´ì§• ì¤‘ì´ë©´ ì´ë¯¸ user ê°ì²´ê°€ ë©”ëª¨ë¦¬ìƒì—ì„œ ë¶„ë¦¬ëœ ìƒíƒœì„) */

   // [ì ì§„ì  ì¹¨ì‹ ë°©ì–´] ìŠ¤í…Œì´ì§•(ë³´í˜¸ë§‰) ì™¸ë¶€ì—ì„œ ë°œìƒí•˜ëŠ” ëª¨ë“  ì°¨ê°ì„ ì‹ ìš© ë“±ê¸‰ ê¸°ì¤€ìœ¼ë¡œ í•„í„°ë§
    // [ìˆ˜ì •]: ê´€ë¦¬ì í™œë™(reasonì— 'ì°¨ê°' í¬í•¨)ì´ê±°ë‚˜ ì§ì ‘ì ì¸ ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ ì‹œ ë°©ì–´ ë¡œì§ í†µê³¼
    var isAdminAction = (reason && reason.indexOf("ì°¨ê°") !== -1);
    
    if (!GLOBAL_STAGING.active[user.uid] && delta < 0 && !isAdminAction) {
        var cr = getCreditInfo(user.creditScore || 600);
        // 1íšŒ ìµœëŒ€ í—ˆìš©ì¹˜: ì‹ ìš©í•œë„ì˜ 1.2ë°° ë˜ëŠ” í˜„ì¬ ìì‚°ì˜ 40% ì¤‘ í° ê°’
        var dropLimit = Math.max(cr.limit * 1.2, (user.point || 0) * 0.4); 
        
        if (Math.abs(delta) > dropLimit) {
            var shieldMsg = "ğŸ›¡ï¸ [ë³´ì•ˆ ì‹œìŠ¤í…œ ì‘ë™]\nâ€¢ ëŒ€ìƒ: " + user.name + "\nâ€¢ ë‚´ìš©: ë¹„ì •ìƒ ì§€ì¶œ(í•œë„ ì´ˆí•©) ê°ì§€\nâœ… ê²°ê³¼: ìì‚° ë³´í˜¸ë¥¼ ìœ„í•´ ê±°ë˜ë¥¼ ì°¨ë‹¨í•˜ê³  ë¡¤ë°±í–ˆìŠµë‹ˆë‹¤.";
            Api.replyRoom("ë‚´ë¦¬ë‹¤", shieldMsg);
            Api.replyRoom("ë² ë¦­ë°©", "ğŸš¨ [Security Alert]\n" + user.name + " (" + reason + ") ì°¨ë‹¨ë¨");

            throw new Error("ì‹ ìš© ë“±ê¸‰[" + cr.label + "] ì§€ì¶œ í•œë„ ì´ˆê³¼ (ì¹¨ì‹ ë°©ì–´)");
        }
    }

    var normalKeywords = [
        "ë¶€ë™ì‚°", "ë§¤ì…", "ë§¤ê°", "ë°°ë‹¹", "ì„ëŒ€", "ê±´ë¬¼", "íˆ¬ì",
        "ë§¤ìˆ˜", "ë§¤ë„", "ìƒì ", "êµ¬ë§¤", "ì˜ˆê¸ˆ", "ì¶œê¸ˆ", "ì†¡ê¸ˆ", "ì´ì²´", "ë°°íŒ…", "ê¸°ë¶€", 
        "ì°¨ê°", "í™€ì§", "ê²°íˆ¬", "ë²Œê¸ˆ", "ìƒí™˜", "íŒ¨ë„í‹°", "ë¶„í•´", "ì¤ê¸°", "ë„ë‘‘ì§ˆ", "ìˆ˜ìˆ˜ë£Œ", 
        "ìˆ˜ê±°", "ì •ì‚°", "í™˜ìˆ˜", "ì§•ìˆ˜", "ìŠ¤í”¼ë˜", "ë¡œë˜", "ë‚šì‹œ", "ì¸ì¦", "ê±°ë§ˆë¹„", "ì‚¬ì±„", 
        "ë“±ë¡", "ì·¨ì†Œ", "ëŒ€ë‚©", "ë³µêµ¬", "êµì •", "ì´ì „", "ë¦¬ì…‹", "ì‹œì¦Œ", "ì‹œìŠ¤í…œ", "ë°°ë‹¹", 
        "ì¥ë ¤", "ì§€ì›", "ëª°ìˆ˜", "ë°•ìŠ¤", "ëœë¤ë°•ìŠ¤", "ë½‘ê¸°", "ì•„ì´ì½˜", "ê°œë´‰", "ì§€ê¸‰",
        "ì¹´ì§€ë…¸", "ì‚¬ë‹¤ë¦¬", "ë°”ì¹´ë¼", "ì ì¤‘", "ë¯¸ì ì¤‘"
    ];
    var isVerifiedAction = (delta > 0) || normalKeywords.some(function(k) { return reason && reason.indexOf(k) !== -1; });

    var prePoint = Number(user.point || 0);
    var actualDelta = (delta < 0 && (prePoint + delta) < 0) ? -prePoint : Number(delta);
    var expectedPoint = prePoint + actualDelta;

    if (isVerifiedAction) user.skipHealing = true;

    var brDelta = 0; 
    if (roomData && typeof roomData === 'object') {
        if (roomData.bankReserve === undefined) roomData.bankReserve = 10000;
        var bankOutput = [
            "ì¶œì„ ë³´ìƒ", "ë¯¼ìƒì§€ì›ê¸ˆ", "í™€ì§ ì ì¤‘", "ì£¼ì‹ ë§¤ë„", "ê´‘ì‚° ì±„êµ´", 
            "ë¡œë˜ 1ë“±", "ë¡œë˜ 2ë“±", "ë¡œë˜ 3ë“±", "ë¶„í•´ íšŒìˆ˜", "ì¤‘ë³µ í™˜ê¸‰", 
            "ê²°íˆ¬ ìŠ¹ë¦¬", "ë¿Œë¦¬ê¸° ì¤ê¸°", "ê²½ë§ˆ ë‹¹ì²¨", "ì€í–‰ ì¶œê¸ˆ", "ëŒ€ì¶œ ì‹¤í–‰", 
            "íˆ¬í‘œ ê±°ë§ˆë¹„", "êµ­ê°€ íŠ¹ë³„ ë°°ë‹¹ê¸ˆ", "ì •ë¶€ ê·¼ë¡œ ì¥ë ¤ê¸ˆ", "ìŠ¤í”¼ë˜ ë‹¹ì²¨ê¸ˆ",
            "ë¬´ì—­ ì •ì‚° ìˆ˜ìµ" // <-- ì´ í‚¤ì›Œë“œê°€ ì¶”ê°€ë˜ì–´ì•¼ êµ­ê³ ì—ì„œ ì°¨ê°ë©ë‹ˆë‹¤.
        ];
        var bankInput = [
            "ì£¼ì‹ ë§¤ìˆ˜", "í™€ì§ ë¯¸ì ì¤‘", "ì²´í¬ ë²Œê¸ˆ", "ëŒ€ì¶œ ìƒí™˜", "ìƒì  êµ¬ë§¤", 
            "ê²½ì°° ë²Œê¸ˆ", "ë„ë‘‘ì§ˆ ì„±ê³µ", "ì€í–‰ ê¸°ë¶€", "ê²½ë§ˆ ë°°íŒ…", "ì·¨ì†Œ ìˆ˜ìˆ˜ë£Œ", 
            "ë¡œë˜ êµ¬ë§¤", "ë³´ìœ ì„¸ ì§•ìˆ˜", "ìì‚° í™˜ìˆ˜", "ë¶€ë™ì‚° ë§¤ì…", "ìŠ¤í”¼ë˜ êµ¬ë§¤"
        ];
        if (actualDelta > 0) {
            // ì‚¬ìœ ì— "ë°°ë‹¹ê¸ˆ"ì´ë‚˜ "ì¥ë ¤ê¸ˆ"ì´ í¬í•¨ë˜ë©´ êµ­ê³ ì—ì„œ ì°¨ê°í•˜ë„ë¡ ì„¤ê³„
            if (bankOutput.some(function(r){ return reason.indexOf(r) !== -1; })) brDelta = -actualDelta;
        } else {
            if (bankInput.some(function(r){ return reason.indexOf(r) !== -1; })) brDelta = Math.abs(actualDelta);
        }

       /* [v11.9.24] ë°°ë‹¹ ì£¼ë¨¸ë‹ˆ: í¬ì¸íŠ¸ê°€ ì•„ë‹Œ 'ì›ê¸ˆ(Revenue)' ëˆ„ì ìœ¼ë¡œ ë³€ê²½ */
        if (roomData.features && roomData.features.dailyPools) {
            var dp = roomData.features.dailyPools;
            var r = reason || "";
            var absAmt = Math.abs(actualDelta);

            // [êµì •]: ìƒìˆ˜ë¥¼ ì—¬ê¸°ì„œ ê³±í•˜ì§€ ì•Šê³  ì›ê¸ˆ(absAmt)ë§Œ ê·¸ëŒ€ë¡œ ë”í•©ë‹ˆë‹¤.
            if (r.indexOf("ê´‘ì‚°") !== -1) dp.mine += absAmt;
            else if (r.indexOf("ë‚šì‹œ") !== -1) dp.fish += absAmt;
            else if (r.indexOf("ì¹´ì§€ë…¸") !== -1 || r.indexOf("ì‚¬ë‹¤ë¦¬") !== -1 || r.indexOf("ë°”ì¹´ë¼") !== -1 || r.indexOf("í™€ì§") !== -1 || r.indexOf("ì ì¤‘") !== -1) {
                dp.casino += absAmt;
            }
            else if (r.indexOf("ìƒì ") !== -1 || r.indexOf("êµ¬ë§¤") !== -1) dp.shop += absAmt;
            else if (r.indexOf("ì´ì") !== -1) dp.bank += absAmt;
            else if (r.indexOf("ê²½ë§ˆ") !== -1 || r.indexOf("ë°°íŒ…") !== -1) dp.race += absAmt;
        }
        util_updateReserve(roomData, brDelta, reason, roomName);
    }

    user.point = expectedPoint; 

    // [ê°ì‹œ ì—”ì§„] 1:1 ëŒ€í™”ë°© ì¹´ì§€ë…¸ ì–´ë·°ì§• ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ (êµ¬ë¶„ì„  ì œê±° ë° ìµœì í™”)
    if (delta > 0 && ALLOWED_ROOMS.indexOf(roomName) === -1 && user.casinoAuditStartTime > 0) {
        var auditNow = Date.now();
        // 1) 2ë¶„ ì´ë‚´ ìˆ˜ìµì¸ì§€ ê²€ì‚¬
        if (auditNow - user.casinoAuditStartTime <= 120000) {
            var currentTotalAssets = Number(user.point) + Number(user.bank || 0);
            
            var lastCheckpoint = (user.casinoAuditAlertHistory && user.casinoAuditAlertHistory.length > 0)
                ? user.casinoAuditAlertHistory[user.casinoAuditAlertHistory.length - 1]
                : user.casinoAuditStartAssets;

            // 2) ê¸°ì¤€ì  ëŒ€ë¹„ 2ë°° ì´ˆê³¼ ë‹¬ì„± íŒì •
            if (currentTotalAssets >= lastCheckpoint * 2 && currentTotalAssets >= user.casinoAuditStartAssets * 2) {
                if (!user.casinoAuditAlertHistory) user.casinoAuditAlertHistory = [];
                user.casinoAuditAlertHistory.push(currentTotalAssets);

                var alertLog = user.casinoAuditAlertHistory.map(function(val, idx) {
                    return "â€¢ ì•Œë¦¼" + (idx + 1) + "íšŒ: " + fp(val) + " P";
                }).join("\n");

                var alertTitle = user.casinoAuditAlertHistory.length === 1 ? "ì¹´ì§€ë…¸ ê³ ìˆ˜ìµ ê°ì§€" : "ê³ ì•¡ ìˆ˜ìµ ì§€ì† ë°œìƒ";
                
                var reportBody = "ğŸš¨ [" + alertTitle + "]\n" +
                                 "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                                 "ğŸ‘¤ ëŒ€ìƒì: " + user.name + " (ID: " + user.uid + ")\n" +
                                 "ğŸ“ ë°œìƒì¥ì†Œ: 1:1 ëŒ€í™”ë°© (" + roomName + ")\n" +
                                 "ğŸ’° í˜„ì¬ ì”ì•¡: " + fp(currentTotalAssets) + " P\n\n" +
                                 "ğŸ“ˆ ë°œìƒì‚¬ìœ : " + (reason || "ì¹´ì§€ë…¸ ê²Œì„ ê²°ê³¼") + "\n\n" +
                                 "ğŸ“Š ìœ ì € í˜„í™©:\n" +
                                 "â€¢ ì‹œì‘ìì‚°: " + fp(user.casinoAuditStartAssets) + " P\n" +
                                 alertLog + "\n\n" + // ìš”ì²­í•˜ì‹  ëŒ€ë¡œ ì¤‘ê°„ êµ¬ë¶„ì„ ì„ ì œê±°í–ˆìŠµë‹ˆë‹¤.
                                 "âš ï¸ ê´€ë¦¬ìëŠ” ì–´ë·°ì§• ì—¬ë¶€ë¥¼ í™•ì¸í•˜ì‹­ì‹œì˜¤.\n" +
                                 "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”";

                try { Api.replyRoom("ë² ë¦­ë°©", reportBody); } catch(e) { Log.error("Audit Alert Fail: " + e); }
            }
        }
    }

    if (!GLOBAL_STAGING.active[user.uid]) {
        var lossRate = prePoint > 0 ? (prePoint - user.point) / prePoint : 0;
        if ((isNaN(user.point) || user.point === null || user.point !== expectedPoint) || (!user.skipHealing && lossRate >= 0.8)) {
            var db = getDatabase();
            var safeUser = null;
            for (var r in db.rooms) { if (db.rooms[r].users[user.uid]) { safeUser = db.rooms[r].users[user.uid]; break; } }
            if (safeUser) {
                if (roomData) roomData.users[user.uid] = JSON.parse(JSON.stringify(safeUser)); // í•´ë‹¹ ìœ ì €ë§Œ ë¡¤ë°±
                try { Api.replyRoom(roomName, "ğŸ›¡ï¸ [ë³´ì•ˆ ì—”ì§„] ë¹„ì •ìƒ ë³€ë™ ì°¨ë‹¨ ë° í•´ë‹¹ ìœ ì € ë°ì´í„° ë¡¤ë°± ì™„ë£Œ"); } catch(e){}
            }
        }
    }

    try {
        var totalNetWorth = util_calculateNetWorth(user, roomData);
        var assetTitles = [
            { name: "ìì‚°ì™•", limit: 5000000, id: 703, msg: "[ì¥ì°© íš¨ê³¼]: ë§¤ì¼ 00ì‹œ ì€í–‰ ì˜ˆê¸ˆ ì´ì ìˆ˜ë ¹ ì‹œ ì´ìœ¨ 1.5ë°° ë³´ë„ˆìŠ¤ê°€ ì ìš©ë©ë‹ˆë‹¤." },
            { name: "ë¶€í˜¸", limit: 2000000, id: 702, msg: "ìƒë¥˜ ì‚¬íšŒì˜ ì¼ì›ì´ ë˜ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤." },
            { name: "ê±°ìƒ", limit: 1000000, id: 701, msg: "ì‹œì¥ì„ ì›€ì§ì´ëŠ” ê±°ëŒ€í•œ ì†ê¸¸ì´ ëŠê»´ì§‘ë‹ˆë‹¤." },
            { name: "ì¬ë²Œ", limit: 500000, id: 700, msg: "ì„±ê³µì ì¸ ìì‚° ì¶•ì ì˜ ì²« ê²°ì‹¤ì„ ë§ºì—ˆìŠµë‹ˆë‹¤." }
        ];

       var rStub = { reply: function(m) { try { Api.replyRoom(roomName || "ë‚´ë¦¬ë‹¤", m); } catch(e){} } };

        for (var i = 0; i < assetTitles.length; i++) {
            var t = assetTitles[i];
            if (totalNetWorth >= t.limit) {
                // ê³µìš© í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ì‘ìœ„ ìˆ˜ì—¬ì‹ ì§„í–‰ (ê°€ë°© ì²´í¬ ë° ì¥ì°© ë¡œì§ ë‚´ì¥ë¨)
                var awarded = util_checkAndAwardTitle(
                    user, 
                    rStub, 
                    t.name, 
                    t.id, 
                    "ğŸ’°", 
                    "ë‚´ë¦¬ë‹¤ ê²½ì œ ìœ„ì›íšŒ", 
                    "ìˆœìì‚° " + fp(t.limit) + "P", 
                    t.msg, 
                    roomName
                );
                
                if (awarded) break; // í•˜ë‚˜ë¼ë„ ìˆ˜ì—¬í–ˆë‹¤ë©´ ì¤‘ë‹¨ (ì¤‘ë³µ ë°©ì§€)
            }
        }
    } catch(e) {}

    if (typeof verifyPointTransaction === 'function') {
        verifyPointTransaction(user, prePoint, actualDelta, reason, roomName, brDelta);
    }
}

/* í¬ì¸íŠ¸ ë‹¨ìœ„ ì‰¼í‘œ í¬ë§·íŒ… (0ì› ë²„ê·¸ ë°©ì§€í˜•) */
function fp(val) {
    var num = Number(val);
    if (isNaN(num)) return "0";
    return String(Math.floor(num)).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}
var fP = fp;

/* UI í¬ë§·í„° í•¨ìˆ˜êµ° */
function formatCommand(title, user, content, nextStep) { 
    var msg = title + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"; 
    if (user !== null) { 
        var nameTag = (typeof user === "string") ? user : getDisplayName(user); 
        msg += nameTag + "ë‹˜\n"; 
    } 
    msg += content + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"; 
    if (nextStep) msg += "\nğŸ’¡ [ê°€ì´ë“œ]: " + nextStep; 
    return msg; 
}

function formatSimple(title, content, nextStep) {
    var msg = "â„¹ï¸ " + title + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + content + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”";
    if (nextStep) msg += "\nğŸ’¡ [ê°€ì´ë“œ]: " + nextStep;
    return msg;
}

function formatAdmin(title, content) { 
    return "âš™ï¸ " + title + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + content + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"; 
}

function formatError(user, content, nextStep) { 
    var nameTag = (typeof user === "string") ? user : getDisplayName(user); 
    var msg = "ğŸš« ì˜¤ë¥˜ ë°œìƒ\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + nameTag + "ë‹˜\nì‚¬ìœ : " + content + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"; 
    if (nextStep) msg += "\nğŸ’¡ [ê°€ì´ë“œ]: " + nextStep; 
    return msg; 
}

/**
 * [ì‹ ì„¤] ì‹¤ì‹œê°„ ì—ëŸ¬ ê³ ë°œ ì—”ì§„ (Error Push)
 * ê¸°ëŠ¥: ì‹œìŠ¤í…œ ì¥ì•  ë°œìƒ ì‹œ ê´€ë¦¬ìì—ê²Œ ì¦‰ì‹œ ì¹´í†¡ ë¦¬í¬íŠ¸ ì „ì†¡
 */
function util_reportError(e, room, sender, msg) {
    var isCommand = msg.startsWith("/") || 
                    ["ì¤ê¸°", "ìˆ˜ë½", "ê±°ì ˆ", "ì·¨ì†Œ", "ì¡ì•˜ë‹¤ìš”ë†ˆ", "ë°°íŒ…ì·¨ì†Œ"].indexOf(msg) !== -1 ||
                    !isNaN(Number(msg));

    if (!isCommand) {
        Log.error("[Silent Error] " + sender + ": " + e.message);
        return;
    }

    // [êµì •] ì—ëŸ¬ ë©”ì‹œì§€ í•œê¸€ ë³€í™˜ ë¡œì§
    var rawErr = e.message || String(e);
    var koErr = rawErr;
    if (rawErr.indexOf("is not a function") !== -1) koErr = "ì‹¤í–‰í•  í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ (ë¡œì§ ëˆ„ë½)";
    else if (rawErr.indexOf("is not defined") !== -1) koErr = "ì •ì˜ë˜ì§€ ì•Šì€ ë³€ìˆ˜ ì‚¬ìš© (ì°¸ì¡° ì˜¤ë¥˜)";
    else if (rawErr.indexOf("null") !== -1 && rawErr.indexOf("read property") !== -1) koErr = "ë°ì´í„°ê°€ ë¹„ì–´ìˆìŒ (ê°ì²´ ì°¸ì¡° ì‹¤íŒ¨)";
    else if (rawErr.indexOf("JSON") !== -1) koErr = "ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨ (JSON ê·œê²© ìœ„ë°˜)";

    var errLog = "ğŸš¨ [ì¥ì•  ë°œìƒ ì•Œë¦¼]\n" +
                 "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                 "ğŸ‘¤ ë°œìƒ ìœ ì €: " + sender + "\n" +
                 "ğŸ“ ë°œìƒ ì¥ì†Œ: " + room + "\n" +
                 "ğŸ’¬ ì…ë ¥ ë‚´ìš©: " + msg + "\n" +
                 "ğŸš« ì—ëŸ¬ ë‚´ìš©: " + koErr + "\n" +
                 "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                 "ğŸ’¡ ë¡œê·¸ í™•ì¸ í›„ ì¡°ì¹˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.";
    
    try { 
        Api.replyRoom("ë² ë¦­ë°©", errLog); 
    } catch(err) {
        Log.error("Error Report Send Fail: " + err);
    }
    Log.error("[Error Push] " + sender + ": " + rawErr);
}

/**
 * [ì‹ ê·œ] ëœë“œë§ˆí¬ ê°€ê²© ë³€ë™ ì—”ì§„
 */
function stock_calculateNextPrice(currentPrice) {
    if (!marketOpenPrice || marketOpenPrice <= 0) return currentPrice;
    var cfg = SYSTEM_CONFIG.ECO.STOCK.SETTINGS;
    var growthRate = (currentPrice - marketOpenPrice) / marketOpenPrice;
    var change = (Math.random() * 2.4 - 1.2) / 100;

    if (growthRate > cfg.RESISTANCE_START) {
        // [ìµœì¢… êµì •]: ì‚­ì œëœ timeWeight ì°¸ì¡°ë¥¼ ì œê±°í•˜ì—¬ ìˆ˜ì‹ ì˜¤ë¥˜ë¥¼ ë°©ì§€í•¨
        var resistance = (growthRate - cfg.RESISTANCE_START) * cfg.GRAVITY;
        change -= resistance;
        
        if (growthRate >= (cfg.CLOSING_LIMIT - 0.01) && change > 0) {
            if (Math.random() < 0.8) change = -Math.abs(change) * 0.5;
        }
    }
    return Math.max(10, currentPrice + (currentPrice * change));
}

/**
 * [ì‹ ì„¤] êµ­ê³  ë¹„ìƒíƒœì„¸ ë°°ìœ¨ ì‚°ì¶œ (ì§€ëŠ¥í˜• ë°©ì–´)
 */
function util_getEmergencyMultiplier(roomName) {
    var data = getDatabase();
    var roomData = data.rooms[roomName];
    if (!roomData || !roomData.economyBase) return 1.0;
    
    var reserve = Number(roomData.bankReserve || 0);
    var base = Number(roomData.economyBase);
    
    // ì¬ê³ ê°€ ê¸°ì¤€ì ì˜ 10% ë¯¸ë§Œì´ë©´ ëª¨ë“  ë³´ìƒ 50% ì‚­ê°
    if (reserve < (base * 0.1)) return 0.5; 
    return 1.0;
}

/**
 * [ì‹ ì„¤] êµ­ê³  ì§€ê¸‰ ê°€ëŠ¥ ì—¬ë¶€ ì²´í¬ (ë¶€ë„ ë°©ì–´)
 */
function util_isBankSolvent(roomName, amount) {
    var targetRoom = (ALLOWED_ROOMS.indexOf(roomName) === -1) ? "ë‚´ë¦¬ë‹¤" : roomName;
    var roomData = data.rooms[targetRoom];
    if (!roomData) return false;
    return (Number(roomData.bankReserve || 0) >= amount);
}

/**
 * [ì‹ ì„¤] êµ­ê°€ ë¶€ë„ ìƒíƒœ í™•ì¸ í•¨ìˆ˜
 * ë¶€ë„ ì„ í¬(disaster) ìƒíƒœì¸ì§€ í™•ì¸í•˜ì—¬ ë¦¬ìŠ¤í¬ ì»¨í…ì¸  ì§„í–‰ ì—¬ë¶€ ê²°ì •
 */
function util_isBankruptcy(roomName) {
    var data = getDatabase();
    var roomData = data.rooms[roomName];
    if (!roomData) return false;
    // lastBankAlertê°€ 'disaster'ì¸ ê²½ìš°ì—ë§Œ true(ë¶€ë„ìƒíƒœ)ë¥¼ ë°˜í™˜
    return roomData.lastBankAlert === "disaster";
}

/**
 * [ì‹ ì„¤] ì¢…ëª© ì•½ì–´ ê²€ìƒ‰ ì—”ì§„
 * @param {Object} market - ê²€ìƒ‰ ëŒ€ìƒ ì¢…ëª© ê°ì²´ (ì „ì²´ ì‹œì¥ í˜¹ì€ ë³´ìœ  ëœë“œë§ˆí¬)
 * @param {String} input - ìœ ì € ì…ë ¥ ì•½ì–´ (ì˜ˆ: "ë‚˜íˆ¬ì¦")
 */
function util_findStockByShorthand(market, input) {
    var stocks = Object.keys(market);
    var matched = [];
    var searchStr = input ? input.trim() : "";
    if (searchStr === "") return matched;

    for (var i = 0; i < stocks.length; i++) {
        var name = stocks[i];
        var searchIdx = 0;
        // ì…ë ¥ëœ ê¸€ìê°€ ì¢…ëª©ëª…ì— ìˆœì„œëŒ€ë¡œ ë“¤ì–´ìˆëŠ”ì§€ ì²´í¬ (ì˜ˆ: ë‚˜...íˆ¬...ì¦)
        for (var j = 0; j < name.length && searchIdx < searchStr.length; j++) {
            if (name[j] === searchStr[searchIdx]) searchIdx++;
        }
        if (searchIdx === searchStr.length) matched.push(name);
    }
    return matched;
}

/**
 * [ì‹ ì„¤] ëœë“œë§ˆí¬ ìµœëŒ€ì£¼ì£¼ ì¶”ì¶œ ì—”ì§„
 * @param {Object} roomData - í•´ë‹¹ ë°© ë°ì´í„°
 * @param {String} landName - ê±´ë¬¼ ì´ë¦„
 * @returns {Object|null} ìœ ì € ê°ì²´ ë° ID, ì§€ë¶„ëŸ‰
 */
function util_getMajorityOwner(roomData, landName) {
    var topOwnerId = null;
    var maxQty = 0;
    
    // í•´ë‹¹ ë°©ì˜ ëª¨ë“  ìœ ì €ë¥¼ ë£¨í”„í•˜ë©° íŠ¹ì • ê±´ë¬¼ì˜ ì§€ë¶„ 1ìœ„ë¥¼ íƒìƒ‰
    for (var uid in roomData.users) {
        var u = roomData.users[uid];
        var qty = (u.landHoldings && u.landHoldings[landName]) ? Number(u.landHoldings[landName]) : 0;
        
        // ì§€ë¶„ì´ í˜„ì¬ ìµœê³ ì¹˜ë³´ë‹¤ ë§ì„ ê²½ìš° ê°±ì‹ 
        if (qty > maxQty) {
            maxQty = qty;
            topOwnerId = uid;
        }
    }
    
    // ì§€ë¶„ ë³´ìœ ìê°€ í•œ ëª…ì´ë¼ë„ ìˆìœ¼ë©´ ê°ì²´ ë°˜í™˜, ì—†ìœ¼ë©´ null ë°˜í™˜
    return topOwnerId ? { id: topOwnerId, data: roomData.users[topOwnerId], qty: maxQty } : null;
}

/**
 * [ì‹ ê·œ] ì „ êµ¬ì—­ íŠ¹ì • ê±´ë¬¼ì˜ ì´ ì§€ë¶„ í•©ê³„ ê³„ì‚° (Global)
 * ì„¤ëª…: ëª¨ë“  ë°©ì˜ ìœ ì € ë°ì´í„°ë¥¼ ë’¤ì ¸ íŠ¹ì • ê±´ë¬¼ì˜ ë°œí–‰ëœ ì´ ì§€ë¶„ ìˆ˜ë¥¼ í•©ì‚°í•©ë‹ˆë‹¤.
 */
function util_getTotalShares(landName, data) {
    var total = 0;
    if (!data || !data.rooms) return 0;
    for (var r in data.rooms) {
        var room = data.rooms[r];
        if (!room.users) continue;
        for (var u in room.users) {
            total += Number((room.users[u].landHoldings || {})[landName] || 0);
        }
    }
    return total;
}

//==========ì„¹í„°8==========

/**
 * [v10.0 ì§€ëŠ¥í˜• ì—”ì§„] ì§€ë‹ˆ ê³„ìˆ˜(Gini Coefficient) ê³„ì‚° í•¨ìˆ˜
 * ì›ë¦¬: ìì‚°ì˜ ë¶ˆí‰ë“±ë„ë¥¼ ì‚°ì¶œ (0: ì™„ì „í‰ë“±, 1: ì™„ì „ë¶ˆí‰ë“±)
 * $$G = \frac{\sum_{i=1}^{n} \sum_{j=1}^{n} |x_i - x_j|}{2n^2 \bar{x}}$$
 */
function util_calculateGini(roomName) {
    var data = getDatabase();
    var room = data.rooms[roomName];
    if (!room) return 0;

    var assets = [];
    for (var uid in room.users) {
        assets.push(util_calculateNetWorth(room.users[uid], room));
    }
    
    var n = assets.length;
    if (n < 2) return 0;
    
    assets.sort(function(a, b) { return a - b; });
    
    var mean = assets.reduce(function(a, b) { return a + b; }, 0) / n;
    if (mean === 0) return 0;

    var sumDiff = 0;
    for (var i = 0; i < n; i++) {
        for (var j = 0; j < n; j++) {
            sumDiff += Math.abs(assets[i] - assets[j]);
        }
    }
    
    return sumDiff / (2 * n * n * mean);
}

/**
Â * [Gemini ì •ë°€ êµì •] ê²½ì œ ì§€í‘œ ê³„ì‚° í•¨ìˆ˜ (ì‹œìŠ¤í…œ íŒëˆ ì™„ë²½ í†µí•© ë²„ì „)
Â * ë°˜ì˜: ëœë“œë§ˆí¬, ê²½ë§ˆ ë°°íŒ…ì•¡, ë¡œë˜ ì­íŒŸ, ì€í–‰ ì¬ì› ë“±ì„ ëª¨ë‘ í•©ì‚°í•˜ì—¬ ë¬¼ê°€ ì™œê³¡ ë°©ì§€
Â */
function calculateEconomy(data, roomName) {
    var totalAssets = 0;      // [ë¬¼ê°€ìš©] ì‹œìŠ¤í…œ ì „ì²´ í†µí™”ëŸ‰
    var totalUserWealth = 0;  // [í‰ê· ìš©] ìœ ì €ë“¤ì˜ ì‹¤ì§ˆ ìˆœìì‚° í•©ê³„
    var userCount = 0;
    var economyBase = 0;      // [ì¡°íšŒìš©] í˜„ì¬ ë°©ì˜ ë¬¼ê°€ ê¸°ì¤€ì 

    if (!data || !data.rooms) return { total: 0, count: 0, average: 0, base: 0 };
    var roomsToScan = roomName ? [roomName] : Object.keys(data.rooms);
    
    // 1. ì „ì—­ ì­íŒŸ íŒëˆ í•©ì‚°
    if (!roomName) totalAssets += Number(data.lotto_jackpot_pool || 0);

    for (var i = 0; i < roomsToScan.length; i++) {
        var r = roomsToScan[i];
        var roomData = data.rooms[r];
        if (!roomData) continue;

        // ë¬¼ê°€ ê¸°ì¤€ì  í™•ë³´
        economyBase = Number(roomData.economyBase || 0);

        // A. ì‹œìŠ¤í…œ ê¸ˆê³  ë° ì§„í–‰ ì¤‘ì¸ íŒëˆ í•©ì‚°
        totalAssets += Number(roomData.bankReserve || 0);
        if (roomData.features) {
            if (roomData.features.racing) {
                totalAssets += Number(roomData.features.racing.totalPool || 0);
                totalAssets += Number(roomData.features.racing.carryOver || 0);
            }
            if (roomData.features.lotto) totalAssets += Number(roomData.features.lotto.dailyPool || 0);
        }

        // B. ìœ ì € ë°ì´í„° í•©ì‚° ë£¨í”„
        for (var uid in roomData.users) {
            var u = roomData.users[uid];
            if (!u) continue;

            // 1. [í‰ê· ìì‚°ìš©]: ì±„ê¶Œ/ì±„ë¬´ê°€ í¬í•¨ëœ ìœ ì €ì˜ ì‹¤ì§ˆ ìˆœìì‚° í•©ì‚°
            totalUserWealth += util_calculateNetWorth(u, roomData);

            // 2. [ë¬¼ê°€ìš©]: ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•´ êµ­ê³ ì— ì—†ëŠ” 'í˜„ê¸ˆ'ê³¼ 'ë¶€ë™ì‚° ê°€ì¹˜'ë§Œ í†µí™”ëŸ‰ì— ì¶”ê°€
            var cash = Number(u.point || 0);
            var landmarkVal = 0;
            var market = data.landmarkMarket || (roomData.features ? roomData.features.landmarkMarket : null);
            if (u.landHoldings && market) {
                for (var lName in u.landHoldings) {
                    if (market[lName]) landmarkVal += (Number(u.landHoldings[lName]) * Number(market[lName].price));
                }
            }
            totalAssets += (cash + landmarkVal);
            userCount++;
        } // ìœ ì € ë£¨í”„ ì¢…ë£Œ
    }

    return {
        total: Math.max(0, totalAssets), 
        count: userCount,
        average: userCount > 0 ? Math.floor(totalUserWealth / userCount) : 0,
        base: economyBase // ìš”ì²­í•˜ì‹  ë¬¼ê°€ê¸°ì¤€ í•„ë“œ ì¶”ê°€
    };
}

/**
 * [v10.0 ì§€ëŠ¥í˜• ì—”ì§„] ì§€ë‹ˆ ê³„ìˆ˜(Gini Coefficient) ê³„ì‚° í•¨ìˆ˜
 * ê¸°ëŠ¥: í•´ë‹¹ ë°©ì˜ ìì‚° ë¶ˆí‰ë“±ë„ë¥¼ ì‚°ì¶œí•©ë‹ˆë‹¤. (0: í‰ë“±, 1: ë…ì )
 * ìœ„ì¹˜: ê²½ì œ ì§€í‘œ ê³„ì‚°ë¶€(Sector 8) í•˜ë‹¨
 */
function util_calculateGini(roomName) {
    var data = getDatabase();
    var room = data.rooms[roomName];
    if (!room || !room.users) return 0;

    var assets = [];
    for (var uid in room.users) {
        // ìœ ì €ë³„ ìˆœìì‚°(í˜„ê¸ˆ+ì˜ˆê¸ˆ+ëœë“œë§ˆ-ë¹š) ë¦¬ìŠ¤íŠ¸ ì¶”ì¶œ
        var netWorth = util_calculateNetWorth(room.users[uid], room);
        assets.push(Math.max(0, netWorth));
    }
    
    var n = assets.length;
    if (n < 2) return 0; // ë¹„êµ ëŒ€ìƒì´ 2ëª… ë¯¸ë§Œì´ë©´ ê³„ì‚° ë¶ˆê°€
    
    assets.sort(function(a, b) { return a - b; }); // ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬ (ë¡œë Œì¸  ê³¡ì„  ê¸°ë°˜)
    
    var mean = assets.reduce(function(a, b) { return a + b; }, 0) / n;
    if (mean === 0) return 0;

    var sumDiff = 0;
    for (var i = 0; i < n; i++) {
        for (var j = 0; j < n; j++) {
            // ëª¨ë“  ìœ ì € ê°„ ìì‚° ì°¨ì´ì˜ ì ˆëŒ“ê°’ í•©ì‚°
            sumDiff += Math.abs(assets[i] - assets[j]);
        }
    }
    
    // ìµœì¢… ì§€ë‹ˆ ê³„ìˆ˜ ì‚°ì¶œ (Gini Index ê³µì‹)
    return sumDiff / (2 * n * n * mean);
}

//==========ì„¹í„°9==========

/**
 * [ì‹ ì„¤: ì§€ëŠ¥í˜• ë¹ˆë¶€ê²©ì°¨ êµì • ë°°ìœ¨] v1.0
 * ê¸°ëŠ¥: ì§€ë‹ˆ ê³„ìˆ˜ì— ë”°ë¼ ìì‚°ê°€ì—ê²ŒëŠ” ëˆ„ì§„ì„¸ë¥¼, ì„œë¯¼ì—ê²ŒëŠ” ë³´ë„ˆìŠ¤ë¥¼ ë¶€ì—¬í•˜ëŠ” ì§€ëŠ¥í˜• ìˆ˜ì¹˜ë¥¼ ë°˜í™˜
 */
function util_getGiniCorrection(user, roomName) {
    var gini = util_calculateGini(roomName);
    var conf = INTELLIGENT_CONFIG.ECONOMY;
    
    if (gini < conf.GINI_CRITICAL) return { tax: 1.0, reward: 1.0, level: "ì•ˆì •" };

    var data = getDatabase();
    var room = data.rooms[roomName];
    var eco = calculateEconomy(data, roomName);
    var myNetWorth = util_calculateNetWorth(user, room);
    
    // í‰ê·  ìì‚°ë³´ë‹¤ ë†’ìœ¼ë©´ 'ìì‚°ê°€', ë‚®ìœ¼ë©´ 'ì„œë¯¼'ìœ¼ë¡œ ë¶„ë¥˜
    var isWealthy = myNetWorth > eco.average;
    var intensity = (gini - conf.GINI_CRITICAL) / (1 - conf.GINI_CRITICAL); // ê²©ì°¨ ê°•ë„ (0~1)

    if (isWealthy) {
        // ìì‚°ê°€: ì„¸ê¸ˆ ê°€ì‚° (ìµœëŒ€ +20%)
        return { 
            tax: 1.0 + (conf.MAX_PROGRESSIVE_TAX * intensity), 
            reward: 1.0, 
            level: "ë¶ˆí‰ë“±(ëˆ„ì§„ì„¸ ê°€ì‚°)" 
        };
    } else {
        // ì„œë¯¼: ë³´ìƒ ê°•í™” (ìµœëŒ€ 1.5ë°°)
        return { 
            tax: 1.0, 
            reward: 1.0 + ((conf.REWARD_BOOST_LIMIT - 1.0) * intensity), 
            level: "ë¶ˆí‰ë“±(ì„œë¯¼ ì§€ì›)" 
        };
    }
}

/**
 * [ê³µí†µ í•¨ìˆ˜: ë¬¼ê°€ ë°°ìœ¨ í†µí•© ì—”ì§„] v5.9
 * ê¸°ëŠ¥: íŠ¹ì • ë°©ì˜ ê²½ì œ ì§€í‘œë¥¼ ë¶„ì„í•˜ì—¬ í˜„ì¬ì˜ ìµœì¢… ë¬¼ê°€ ë°°ìœ¨(Multiplier)ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
 * ìš©ë„: ìƒì ê°€ ì¡°ì ˆ, ì¶œì„ ë³´ìƒ ì¡°ì ˆ, ì±„êµ´ íš¨ìœ¨ ì¡°ì ˆ ë“±
 */
function util_getEcoMultiplier(roomName) {
    var data = getDatabase();
    var roomData = data.rooms[roomName];
    if (!roomData || !roomData.economyBase || roomData.economyBase <= 0) return 1.0;

    // ì„¹í„° 8ì˜ í†µí•© ê²½ì œ ì§€í‘œ í˜¸ì¶œ (ì±„ê¶Œ/ë¶€ì±„ ë°˜ì˜ ìˆ˜ì¹˜)
    var currentEco = calculateEconomy(data, roomName);
    var rawRatio = currentEco.total / roomData.economyBase;
    
    // ë¬¼ê°€ ì™„ì¶© ë¹„ìœ¨(Damping) ì ìš©
    var damping = (data.economyDamping !== undefined) ? data.economyDamping : 0.5;
    var multiplier = 1 + (rawRatio - 1) * damping;
    
    // ìµœì†Œ ë°°ìœ¨ ì œí•œ (í•˜í•œì„  0.5ë°°)
    return Math.max(0.5, multiplier);
}

/**
 * [ì‹œìŠ¤í…œ] ì•„ì´í…œ ê°€ê²© ê³„ì‚° í•¨ìˆ˜
 * ê¸°ëŠ¥: í†µí•© ì—”ì§„ ë°°ìœ¨ì„ ì ìš©í•˜ì—¬ ì‹¤ì‹œê°„ ë‹¨í’ˆê°€(1ê°œ ê°€ê²©)ë¥¼ ì‚°ì¶œí•©ë‹ˆë‹¤.
 */
function getItemPrice(item, user, roomName) {
    var multiplier = util_getEcoMultiplier(roomName);
    var giniCorr = util_getGiniCorrection(user, roomName);
    var basePrice = Math.floor(Number(item.price) * multiplier * giniCorr.tax);

    // ê¸°ì´ˆê°€(Base) ì„¤ì •: ë¬´ì—­ ë¬¼í’ˆì¼ ê²½ìš° ì„¹í„° 1ì˜ ìƒìˆ˜ë¥¼ ìš°ì„  ì°¸ì¡°
    var rawPrice = Number(item.price);
    if (item.effect === "trade_cargo" && item.value) {
        var tradeCfg = SYSTEM_CONFIG.TRADE;
        rawPrice = (tradeCfg.GOODS_COST && tradeCfg.GOODS_COST[item.value]) ? tradeCfg.GOODS_COST[item.value] : rawPrice;
    }

    // ìµœì¢… ê¸°ë³¸ê°€ ì‚°ì¶œ: (ì›ê°€ * ë¬¼ê°€ë°°ìœ¨ * ì§€ë‹ˆëˆ„ì§„ì„¸)
    var basePrice = Math.floor(rawPrice * multiplier * giniCorr.tax);

    // [ìˆ˜ì§‘ëŒ€ë§ˆì™•] ëª¨ë“  ìƒì  êµ¬ë§¤ê°€ 15% í• ì¸
    if (user.title === "ìˆ˜ì§‘ëŒ€ë§ˆì™•") {
        basePrice = Math.floor(basePrice * 0.85);
    }

    // [ìŠ¹ê¸‰ê¶Œ ëˆ„ì  í• ì¦] êµ¬ë§¤í•  ë•Œë§ˆë‹¤ ê¸°ë³¸ê°€ì˜ 10%ì”© ì˜êµ¬ í• ì¦
    if (item.id === 8) { 
        var boughtCount = Number(user.purchasedPromotionAttempts || 0);
        var surchargeUnit = Math.floor(basePrice * 0.10); // ê¸°ë³¸ê°€ì˜ 10% ì‚°ì¶œ
        return basePrice + (surchargeUnit * boughtCount); 
    }

    return basePrice;
}

/**
 * [Gemini ì •ë°€ êµì •] ê²½ì œ ë¶€ì–‘ ì§€ì›ê¸ˆ ì²´í¬ í•¨ìˆ˜ (ì¤‘ë³µ ì„ ì–¸ ì œê±° ë° í†µí•©)
 */
function checkEconomicStimulus(user, roomName, isManual) {
    if ((user.totalAttendance || 0) < 2) return;
    
    var currentCount = user.dailyStimulusCount || 0;
    if (currentCount >= 1) return;

    var data = getDatabase();
    if (!data) return;
    
    var eco = calculateEconomy(data, roomName);
    var avgAsset = eco.average;
    var roomData = data.rooms[roomName];
    var myNetWorth = util_calculateNetWorth(user, roomData);

    // ì§€ê¸‰ ê¸°ì¤€ì„ : í‰ê·  ìˆœìì‚°ì˜ 40% ë¯¸ë§Œ
    var targetLine = Math.floor(avgAsset * 0.4);
    
    if (myNetWorth < targetLine) {
        var multiplier = util_getEcoMultiplier(roomName);
        var giniCorr = util_getGiniCorrection(user, roomName);
        var gap = targetLine - myNetWorth;
        var emergencyMult = util_getEmergencyMultiplier(roomName);
        // ì§€ëŠ¥í˜• ë³´ìƒ ë¶€ìŠ¤íŠ¸(giniCorr.reward)ë¥¼ ì ìš©í•˜ì—¬ ì„œë¯¼ ìì‚° ë³µêµ¬ ê°€ì†
        var baseGive = Math.floor(10000 * multiplier * emergencyMult * giniCorr.reward);
        var giveAmount = Math.min(baseGive, gap); 

        // [ì‹ ê·œ] ì‹ ìš©ë¶ˆëŸ‰ì í˜ë„í‹°: ë¯¼ìƒì§€ì›ê¸ˆ 20% ì‚­ê°
        if (Number(user.creditScore || 600) < 500) {
            giveAmount = Math.floor(giveAmount * 0.8);
        }
        
        if (giveAmount < 100 || !util_isBankSolvent(roomName, giveAmount)) return;

        util_updatePoint(user, roomData, giveAmount, "ë¯¼ìƒì§€ì›ê¸ˆ ì§€ê¸‰", roomName);
        user.dailyStimulusCount = currentCount + 1;

        var msg = "\nê²½ì œ ìœ„ê¸° ê·¹ë³µì„ ìœ„í•œ ê¸´ê¸‰ ë¯¼ìƒì§€ì›ê¸ˆì´ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.\n" +
                  "ğŸ’° ì§€ì›ê¸ˆì•¡: +" + fp(giveAmount) + "P";

        Api.replyRoom(roomName, formatCommand("ğŸ ë¯¼ìƒì§€ì›ê¸ˆ ì•ˆë‚´", user, msg, "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
        safeSaveData(data);
    }
}


//==========ì„¹í„°10==========

/* ì‹ ìš© ì •ë³´ ê³„ì‚° í•¨ìˆ˜ (ìƒìˆ˜ ì—°ë™) */
function getCreditInfo(score, roomName) {
    var s = Number(score || 600);
    var conf = SYSTEM_CONFIG.ECO.CREDIT;
    var data = getDatabase();
    var roomData = data.rooms[roomName || "ë‚´ë¦¬ë‹¤"];
    
    // 00ì‹œì— í™•ì •ëœ í‰ê·  ìì‚° í˜¸ì¶œ
    var avgAsset = (roomData && roomData.features && roomData.features.government) ? 
                   Number(roomData.features.government.dailyAvgAsset || 420000) : 420000;

    // [í•µì‹¬ ë¹„ìœ¨ ê³µì‹]: í˜„ì¬ í‰ê·  ìì‚° / ê¸°ì¤€ì (420,000P)
    // ì˜ˆ: í‰ê· ì´ 63ë§ŒPë©´ ë°°ìœ¨ì€ 1.5ë°°ê°€ ë¨
    var assetRatio = avgAsset / 420000;

    for(var i=0; i<conf.SCORES.length; i++) {
        if(s >= conf.SCORES[i]) {
            return { 
                grade: i+1, 
                limit: Math.floor(conf.LIMITS[i] * assetRatio), // ê¸°ë³¸í•œë„ * ë¹„ìœ¨ ì ìš©
                label: conf.LABELS[i], 
                rate: conf.RATES[i], 
                icon: conf.ICONS[i] 
            };
        }
    }
    // ë§ˆì§€ë§‰ ë“±ê¸‰ (ì‹ ìš©ë¶ˆëŸ‰)
    var lastIdx = conf.SCORES.length;
    return { 
        grade: lastIdx+1, 
        limit: Math.floor(conf.LIMITS[lastIdx] * assetRatio), 
        label: conf.LABELS[lastIdx], 
        rate: conf.RATES[lastIdx], 
        icon: conf.ICONS[lastIdx] 
    };
}

/* ì‹ ìš© í•œë„ í‘œ ìƒì„± í•¨ìˆ˜ (ë¹„ìœ¨ì œ ë°˜ì˜) */
function getCreditLimitTable(roomName) {
    var conf = SYSTEM_CONFIG.ECO.CREDIT;
    var list = [];
    var data = getDatabase();
    var roomData = data.rooms[roomName || "ë‚´ë¦¬ë‹¤"];
    
    // 1. í‰ê·  ìì‚° ë¹„ë¡€ ë°°ìœ¨ ê³„ì‚° (ê¸°ì¤€ì  420,000P)
    var avgAsset = (roomData && roomData.features && roomData.features.government) ? 
                   Number(roomData.features.government.dailyAvgAsset || 420000) : 420000;
    var assetRatio = avgAsset / 420000;

    // 2. í˜„ì¬ ì‹œì¥ ìŠ¹ìˆ˜(dynMult) ì‹¤ì‹œê°„ í˜¸ì¶œ
    var dynMult = 1.0;
    if (typeof util_getDynamicRateMultiplier === 'function') {
        dynMult = util_getDynamicRateMultiplier(roomName);
    }

    // 3. 1ë“±ê¸‰ ~ 5ë“±ê¸‰ ë£¨í”„ ì²˜ë¦¬
    for(var i=0; i<conf.SCORES.length; i++) {
        var baseRatePct = (conf.RATES[i] - 1) * 100;
        var appliedRate = (baseRatePct * dynMult).toFixed(1); // ì‹œì¥ ìŠ¹ìˆ˜ ì ìš© ë° ì†Œìˆ˜ì  ê³ ì •
        var dynamicLimit = Math.floor(conf.LIMITS[i] * assetRatio); // í‰ê·  ìì‚° ë¹„ë¡€ í•œë„ ì ìš©
        
        list.push(conf.ICONS[i] + " " + conf.LABELS[i] + " (" + conf.SCORES[i] + "ì ~): " + appliedRate + "%\n(í•œë„ " + fp(dynamicLimit) + "P)");
    }
    
    var lastIdx = conf.SCORES.length; 
    var lastBaseRate = (conf.RATES[lastIdx] - 1) * 100;
    var lastApplied = (lastBaseRate * dynMult).toFixed(1); 
    var lastDynamicLimit = Math.floor(conf.LIMITS[lastIdx] * assetRatio);
    
    list.push(conf.ICONS[lastIdx] + " " + conf.LABELS[lastIdx] + " (<" + conf.SCORES[lastIdx-1] + "): " + lastApplied + "%\n(í•œë„ " + fp(lastDynamicLimit) + "P)");
    
    return list.join("\n");
}

/**
 * [ìˆ˜ì •] ë‹‰ë„¤ì„ í‘œì‹œ ìƒì„± í•¨ìˆ˜ (ì¹­í˜¸ ì „ìš© ì•„ì´ì½˜ ìë™ ë…¸ì¶œ ì‹œìŠ¤í…œ)
 * [Gemini ìš”ì²­ ì‚¬í•­ ë°˜ì˜]: ì¹­í˜¸ ì¥ì°© ì‹œ ì¸ë²¤í† ë¦¬ì—ì„œ í•´ë‹¹ ì¹­í˜¸ì˜ ì•„ì´ì½˜ì„ ì°¾ì•„ ìë™ìœ¼ë¡œ ì ‘ë‘ì‚¬ì— ë¶™ì…ë‹ˆë‹¤.
 */
function getDisplayName(user) {
    if (!user) return "ì•Œ ìˆ˜ ì—†ìŒ";
    var userIcon = user.icon || "";
    var tierIcon = (user.tier === 9 ? "ğŸ†" : ""); 
    var credit = getCreditInfo(user.creditScore || 600);
    
    var titleStr = "";
    
    // 1ìˆœìœ„: ì‹ ìš©ë¶ˆëŸ‰ìì¼ ê²½ìš° ë¬´ì¡°ê±´ [ì‹ ìš©ë¶ˆëŸ‰ì] í‘œì‹œ
    if (credit.label === "ì‹ ìš©ë¶ˆëŸ‰ì") {
        titleStr = "[ì‹ ìš©ë¶ˆëŸ‰ì] ";
    } 
    // 2ìˆœìœ„: ì¼ë°˜ ìƒíƒœì¼ ë•Œ ì¥ì°© ì¤‘ì¸ ì¹­í˜¸ í‘œì‹œ (ì•„ì´ì½˜ ì œí•œ ë¡œì§)
    else if (user.title && user.title.length > 0) {
        var titleIcon = "";
        
        // [Gemini ê·œì¹™]: ë„êµ´ì™•, ìˆ˜ì§‘ëŒ€ë§ˆì™•ë§Œ ì¸ë²¤í† ë¦¬ì—ì„œ ì•„ì´ì½˜ì„ ì°¾ì•„ í•©ì¹©ë‹ˆë‹¤.
        if (user.title === "ë„êµ´ì™•" || user.title === "ìˆ˜ì§‘ëŒ€ë§ˆì™•") {
            if (user.inventory && user.inventory.length > 0) {
                for (var i = 0; i < user.inventory.length; i++) {
                    var item = user.inventory[i];
                    if (item.effect === "title" && item.title === user.title) {
                        titleIcon = item.icon || ""; 
                        break;
                    }
                }
            }
        }
        
        // titleIconì´ ë¹„ì–´ìˆìœ¼ë©´(ê·¸ ì™¸ ì¹­í˜¸ë“¤) ìë™ìœ¼ë¡œ [ì¹­í˜¸ëª…]ë§Œ ì¶œë ¥ë©ë‹ˆë‹¤.
        titleStr = "[" + titleIcon + user.title + "] ";
    }
    
    return titleStr + tierIcon + userIcon + (user.name || "ì•Œ ìˆ˜ ì—†ìŒ");
}

/* [ìˆ˜ì •] ê´€ë¦¬ì ì—¬ë¶€ í™•ì¸ í•¨ìˆ˜ (FIXED_ADMINS ì²´í¬ ì¶”ê°€) */
function isAdmin(sender, data, uid) {
    var name = String(sender).trim();
    
    // 1. ì†ŒìŠ¤ì½”ë“œì— í•˜ë“œì½”ë”©ëœ ì´ë¦„ì€ ë°ì´í„°ë² ì´ìŠ¤ í™•ì¸ ì—†ì´ ì¦‰ì‹œ ë§ˆìŠ¤í„° ê¶Œí•œ ë¶€ì—¬
    if (FIXED_ADMINS.indexOf(name) !== -1) return true;
    
    // 2. UID ê¸°ë°˜ ë§ˆìŠ¤í„° ì¸ì¦
    if (uid && adminUIDs.indexOf(uid) !== -1) return true;

    // 3. ë¶€ê´€ë¦¬ì ë“± ì¼ë°˜ ê´€ë¦¬ì ëª…ë‹¨ ì²´í¬
    if (data && data.admins && data.admins.indexOf(name) !== -1) return true;

    return false;
}

//==========ì„¹í„°11==========

function util_checkUserState(user, uid, roomName) {
    var now = Date.now();
    var data = getDatabase();
    var roomData = data.rooms[roomName || "ë‚´ë¦¬ë‹¤"];
    
    // [êµì •]: ë°©ë³„ ë…ë¦½ states ë°ì´í„° ì°¸ì¡° (ì—†ì„ ê²½ìš° ë¹ˆ ê°ì²´ ì²˜ë¦¬ë¡œ Crash ë°©ì§€)
    var states = (roomData && roomData.features) ? roomData.features.states : {};
    var dData = states.duelData || {};
    var aThefts = states.activeThefts || {};

    // 1. ê°ì˜¥(ì§•ì—­) ìƒíƒœ ì²´í¬
    if (user.jailReleaseTime && now < user.jailReleaseTime) {
        var diff = user.jailReleaseTime - now;
        var remainMin = Math.ceil(diff / (1000 * 60));
        var timeStr = remainMin >= 60 ? Math.ceil(remainMin / 60) + "ì‹œê°„" : remainMin + "ë¶„";
        return { canAction: false, reason: "í˜„ì¬ ì§•ì—­ ì¤‘ì…ë‹ˆë‹¤. (" + timeStr + " ë‚¨ìŒ)" };
    }

    // 2. ê´‘ì‚° ì±„êµ´ ìƒíƒœ ì²´í¬
    if (user.mining && user.mining.active) {
        return { canAction: false, reason: "í˜„ì¬ ê´‘ì‚°ì—ì„œ ì±„êµ´ ì‘ì—… ì¤‘ì…ë‹ˆë‹¤." };
    }

    // 3. ê²°íˆ¬ ì§„í–‰ ìƒíƒœ ì²´í¬ (ë°©ë³„ ë°ì´í„° ì°¸ì¡°í˜•ìœ¼ë¡œ êµì •)
    if (dData[uid]) return { canAction: false, reason: "í˜„ì¬ ê²°íˆ¬ ì‹ ì²­ì„ ë°›ì€ ìƒíƒœì…ë‹ˆë‹¤." };
    for (var dKey in dData) {
        if (dData[dKey].challengerUid === uid) return { canAction: false, reason: "í˜„ì¬ íƒ€ì¸ì—ê²Œ ê²°íˆ¬ë¥¼ ì‹ ì²­í•œ ìƒíƒœì…ë‹ˆë‹¤." };
    }

    // 4. ë„ë‘‘ì§ˆ ì§„í–‰ ìƒíƒœ ì²´í¬ (ë°©ë³„ ë°ì´í„° ì°¸ì¡°í˜•ìœ¼ë¡œ êµì •)
    if (aThefts[uid]) return { canAction: false, reason: "í˜„ì¬ ë„ë‘‘ì§ˆì˜ í‘œì ì´ ë˜ì–´ ë°©ì–´ ì¤‘ì…ë‹ˆë‹¤." };
    for (var vKey in aThefts) {
        if (aThefts[vKey].thiefUid === uid) return { canAction: false, reason: "í˜„ì¬ ë‹¤ë¥¸ ìœ ì €ë¥¼ í„¸ê³  ìˆëŠ” ì¤‘ì…ë‹ˆë‹¤." };
    }

    return { canAction: true, reason: "" };
}

/* ê¸°ì¡´ í˜¸í™˜ì„±ì„ ìœ„í•œ ë‹¨ìˆœ ì²´í¬ í•¨ìˆ˜ */
function isUserBusy(uid, roomName) {
    var data = getDatabase();
    var rName = roomName || "ë‚´ë¦¬ë‹¤";
    if (data.rooms[rName] && data.rooms[rName].users[uid]) {
        var res = util_checkUserState(data.rooms[rName].users[uid], uid, rName);
        return !res.canAction;
    }
    return false;
}

/* ìœ ì € ì´ë¦„ ê²€ìƒ‰ í•¨ìˆ˜ */
function findUserByName(roomData, name) {
    var res = [];
    var searchName = name.trim();
    if (searchName === "") return res; 
    for (var id in roomData.users) {
        var u = roomData.users[id];
        if (u.name === searchName) {
            return [{ id: id, data: u }];
        }
        if (u.name.indexOf(searchName) !== -1) {
            res.push({ id: id, data: u });
        }
    }
    return res;
}

/**
 * [ì‹ ì„¤] ì „ì—­ ìœ ì € ê²€ìƒ‰ ì—”ì§„ (Cross-Room Search)
 * ê¸°ëŠ¥: í˜„ì¬ ë°©ë¿ë§Œ ì•„ë‹ˆë¼ ëª¨ë“  ë°©ì˜ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë’¤ì ¸ì„œ ìœ ì €ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
 */
function findUserGlobal(name) {
    var res = [];
    var searchName = name.trim();
    if (searchName === "") return res;
    
    var data = getDatabase();
    // =====ìš”ì²­ì‚¬í•­ ì‹œì‘=====
    // [êµì •] ì˜¤ì§ ALLOWED_ROOMS(ë‹¨ì²´ë°©) ë°ì´í„°ë§Œ ê²€ìƒ‰ ëŒ€ìƒìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ì¤‘ë³µ ì œê±°
    for (var i = 0; i < ALLOWED_ROOMS.length; i++) {
        var rName = ALLOWED_ROOMS[i];
        var room = data.rooms[rName];
        if (!room || !room.users) continue;

        for (var id in room.users) {
            var u = room.users[id];
            if (u.name === searchName || u.name.indexOf(searchName) !== -1) {
                res.push({ id: id, data: u, roomName: rName });
            }
        }
    }
    return res;
}

/* ì¤‘ë³µ ìœ ì € ì„ íƒ í•¸ë“¤ëŸ¬ í•¨ìˆ˜ (ì „ì—­ ëŒ€ì‘í˜•) */
function handleUserSelection(replier, targetUid, found, type, extra, user, roomName) {
    var data = getDatabase();
    var roomData = data.rooms[roomName];
    if (!roomData || !roomData.features) return;

    roomData.features.states.selectWait[targetUid] = { 
        timestamp: Date.now(), 
        results: found, // ì—¬ê¸°ì— ê° ìœ ì €ì˜ roomNameì´ í¬í•¨ë˜ì–´ ìˆìŒ
        type: type, 
        extra: extra 
    };
    
    var list = [];
    for(var i=0; i<found.length; i++) {
        var f = found[i];
        // [ë°© ì´ë¦„ í‘œì‹œ] ê´€ë¦¬ìê°€ ì–´ëŠ ë°© ìœ ì €ë¥¼ ê±´ë“œë¦¬ëŠ”ì§€ ëª…í™•íˆ í‘œì‹œ
        list.push((i + 1) + ". [" + f.roomName + "] " + f.data.name);
    }

    replier.reply(formatCommand("ğŸ” ì „ì—­ ì¤‘ë³µ ìœ ì € ì„ íƒ", user, "ê´€ë¦¬í•˜ì‹¤ ëŒ€ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.\n\n" + list.join("\n") + "\n\n(ì·¨ì†Œ: [ì·¨ì†Œ])", "ì…ë ¥ ëŒ€ê¸°: 30ì´ˆ"));
}

/**
 * [ì‹ ì„¤] ì¤‘ë³µ ì¢…ëª© ì„ íƒ í•¸ë“¤ëŸ¬
 */
function handleStockSelection(replier, targetUid, found, type, qty, user, roomName) {
    var data = getDatabase();
    var roomData = data.rooms[roomName];
    if (!roomData || !roomData.features) return;

    roomData.features.states.selectWait[targetUid] = { 
        timestamp: Date.now(), 
        results: found, 
        type: type,     
        extra: { amount: qty } 
    };
    var list = found.map(function(name, i) { return (i + 1) + ". " + name; });
    replier.reply(formatCommand("ğŸ” ì¢…ëª© ì„ íƒ", user, "ì—¬ëŸ¬ ì¢…ëª©ì´ ê²€ìƒ‰ë˜ì—ˆìŠµë‹ˆë‹¤.\në²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.\n\n" + list.join("\n") + "\n\n(ì·¨ì†Œ: [ì·¨ì†Œ])", "ì…ë ¥ ëŒ€ê¸°: 30ì´ˆ"));
}

/**
 * [ì‹ ì„¤: ì›ìì  ì‹ ë¶„ ë™ê¸°í™” ì—”ì§„] v1.0
 * ê¸°ëŠ¥: ìœ ì €ì˜ ë‹‰ë„¤ì„ ë³€ê²½ ì‹œ ì „ ì„œë²„ì˜ ëª¨ë“  ì°¸ì¡° ë°ì´í„°(ì‚¬ì±„, ê²½ë§ˆ ë“±)ë¥¼ ì¼ê´„ ê°±ì‹ í•©ë‹ˆë‹¤.
 * @param {String} uid - ìœ ì € ê³ ìœ  ID
 * @param {String} oldName - ë³€ê²½ ì „ ì´ë¦„
 * @param {String} newName - ë³€ê²½ í›„ ì´ë¦„
 */
function util_syncIdentityGlobal(uid, oldName, newName) {
    var data = getDatabase();
    var syncCount = 0;

    for (var rName in data.rooms) {
        var room = data.rooms[rName];
        
        // 1. ì‚¬ì±„ ê³„ì•½ì„œ(Loan Contracts) ë™ê¸°í™”
        if (room.loanContracts) {
            for (var cid in room.loanContracts) {
                var c = room.loanContracts[cid];
                if (c.borrowerUid === uid) { c.borrowerName = newName; syncCount++; }
                if (c.lenderUid === uid) { c.lenderName = newName; syncCount++; }
            }
        }

        // 2. ê²½ë§ˆ ë°°íŒ… ê¸°ë¡(Racing Bets) ë™ê¸°í™”
        if (room.features && room.features.racing && room.features.racing.bets) {
            var bets = room.features.racing.bets;
            if (bets[uid]) {
                bets[uid].name = newName;
                syncCount++;
            }
        }
        
        // 3. ì‚¬ì±„ ë“±ë¡ ë§¤ë¬¼(Loan Pools) ë™ê¸°í™”
        if (room.loanPools) {
            for (var pid in room.loanPools) {
                if (room.loanPools[pid].lenderUid === uid) {
                    room.loanPools[pid].lenderName = newName;
                    syncCount++;
                }
            }
        }
    }

    if (syncCount > 0) {
        Log.info("[AIS] " + oldName + " â” " + newName + " (" + syncCount + "ê°œ ë°ì´í„° ì›ìì  ë™ê¸°í™” ì™„ë£Œ)");
    }
}

/* ë‚ ì§œ ë° ì‹œì¦Œ ìœ í‹¸ í•¨ìˆ˜ */
function getSimpleDate() { var d = new Date(); return d.getFullYear() + "-" + ("0" + (d.getMonth() + 1)).slice(-2) + "-" + ("0" + d.getDate()).slice(-2); }
function getSimpleSeason() { var d = new Date(); return d.getFullYear().toString().slice(-2) + "-" + (d.getMonth() + 1) + "ì‹œì¦Œ"; }
function generateUUID() { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) { var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); }); }

/**
 * [ê³µí†µ í•¨ìˆ˜: ì¹­í˜¸ ìë™ ë¶€ì—¬ ì‹œìŠ¤í…œ] v6.0 (í‘œì¤€ í¬ë§· ì ìš©)
 */
function util_checkAndAwardTitle(user, replier, titleName, titleId, icon, committee, condition, guideText, roomName) {
    if (!user.inventory) user.inventory = [];
    
    var hasTitle = false;
    for (var i = 0; i < user.inventory.length; i++) {
        if (user.inventory[i].title === titleName) {
            hasTitle = true;
            break;
        }
    }
    if (hasTitle) return false;

    user.inventory.push({ 
        id: titleId, 
        name: "[" + titleName + "] ì¹­í˜¸", 
        icon: icon, 
        effect: "title", 
        title: titleName 
    });

    user.title = titleName;

    var winMsg = "ğŸŠ [" + committee + ": ì‘ìœ„ ìˆ˜ì—¬]\n" +
                 "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                 "ì¶•í•˜í•©ë‹ˆë‹¤! " + (user.name || "ìœ ì €") + "ë‹˜\n\n" +
                 condition + "ë¥¼ ëŒíŒŒí•˜ì—¬\n" +
                 "êµ­ê°€ ê³µì¸ [" + titleName + "] ì¹­í˜¸ë¥¼ í•˜ì‚¬ë°›ì•˜ìŠµë‹ˆë‹¤.\n\n" +
                 "âœ¨ ìƒíƒœ: [" + titleName + "] ìë™ ì¥ì°© ì™„ë£Œ\n" +
                 "ğŸ’¼ ë³´ê´€: ì˜êµ¬ ìì‚°ìœ¼ë¡œ ê°€ë°©ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.\n" +
                 "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                 "ğŸ’¡ " + guideText;

    // [í•µì‹¬ êµì •]: replierê°€ ë¬´íš¨í•œ í™˜ê²½(ë¬¸ìì—´ ì „ë‹¬ ë“±)ì—ì„œë„ ì‘ë‹µì´ ë‚˜ê°€ë„ë¡ ì˜ˆì™¸ ì²˜ë¦¬
    try {
        if (replier && typeof replier.reply === 'function') {
            replier.reply(winMsg);
        } else {
            Api.replyRoom(roomName || "ë‚´ë¦¬ë‹¤", winMsg);
        }
    } catch(e) {
        Log.error("Award Title Reply Error: " + e);
    }
    return true;
}

/**
 * [ì‹ ì„¤] ìˆœìì‚° ë°±ë¶„ìœ„ ê³„ì‚° ì—”ì§„
 * ê¸°ëŠ¥: í•´ë‹¹ ë°© ìœ ì €ë“¤ì˜ ìì‚°ì„ ì „ìˆ˜ ì¡°ì‚¬í•˜ì—¬ ë‚˜ì˜ ìƒëŒ€ì  ìœ„ì¹˜(ìƒìœ„ %)ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
 */
function util_getNetWorthPercentile(user, roomName) {
    try {
        var data = getDatabase();
        var roomObj = data.rooms[roomName || "ë‚´ë¦¬ë‹¤"];
        if (!roomObj || !roomObj.users) return 100;

        var netWorths = [];
        for (var uid in roomObj.users) {
            // ëª¨ë“  ìœ ì €ì˜ ì‹¤ì§ˆ ìˆœìì‚°(í˜„ê¸ˆ+ì˜ˆê¸ˆ+ë¶€ë™ì‚°-ë¹š) ë¦¬ìŠ¤íŠ¸ ìƒì„±
            var nw = util_calculateNetWorth(roomObj.users[uid], roomObj);
            netWorths.push(nw);
        }
        
        // ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (ìì‚° 1ë“±ì´ 0ë²ˆ ì¸ë±ìŠ¤)
        netWorths.sort(function(a, b) { return b - a; });

        var myNetWorth = util_calculateNetWorth(user, roomObj);
        var myRank = netWorths.indexOf(myNetWorth) + 1; // ë‚´ ë“±ìˆ˜
        var totalUsers = netWorths.length;

        // ë°±ë¶„ìœ¨ ê³„ì‚° (ìƒìœ„ 0% ~ 100%)
        return totalUsers > 0 ? (myRank / totalUsers) * 100 : 100;
    } catch (e) {
        Log.error("Percentile Calc Error: " + e);
        return 50; // ì—ëŸ¬ ì‹œ í‰ê· ì¹˜ ë°˜í™˜
    }
}

/**
 * [ì‹ ì„¤] ì§€ëŠ¥í˜• ì°¨ë“± ì†Œë“ì„¸ ë° UI ë°ì´í„° ìƒì„±ê¸°
 * ê¸°ì¤€: ìƒìœ„ 10% ì´ë‚´(7%), 30% ì´ë‚´(5%), ê·¸ ì™¸(3%)
 * ë°˜í™˜: { ì„¸ìœ¨%, ì°¨ê°ì•¡, ë‚´ìˆœìœ„%, ì„¸í›„ìˆ˜ìµ }
 */
function util_applyIncomeTax(user, income, roomName) {
    var percentile = util_getNetWorthPercentile(user, roomName);
    var rate = 0.03; // ê¸°ë³¸ 3% (ì„œë¯¼ì¸µ)

    if (percentile <= 10) {
        rate = 0.07; // ìƒìœ„ 10% (ìµœìƒìœ„ì¸µ)
    } else if (percentile <= 30) {
        rate = 0.05; // ìƒìœ„ 30% (ì¤‘ì‚°ì¸µ)
    }

    // [ì¶”ê°€] ê¸°ë¶€ì™• ì¹­í˜¸ íš¨ê³¼: ëª¨ë“  ì„¸ê¸ˆ 50% ê°ë©´ í˜œíƒ ì ìš©
    if (user.title === "ê¸°ë¶€ì™•") {
        rate = rate * 0.5;
    }

    var taxAmount = Math.floor(income * rate);
    var netIncome = income - taxAmount;

    return {
        ratePct: (rate * 100).toFixed(1),
        taxAmount: taxAmount,              // ì°¨ê°ë  ì„¸ê¸ˆ ì•¡ìˆ˜
        rankPct: Math.floor(percentile),   // UI í‘œì‹œìš© ë‚´ ìˆœìœ„ %
        netIncome: netIncome               // ì„¸ê¸ˆ ë–¼ê³  ë‚¨ì€ ì‹¤ì œ ìˆ˜ìµ
    };
}

/**
 * [ì‹ ê·œ ì¶”ê°€] ì‹ ìš© ë“±ê¸‰ë³„ ë¬´ì—­ ìˆ˜ìµ ë°°ìœ¨ ë°˜í™˜ ì—”ì§„
 * ê¸°ëŠ¥: ë“±ê¸‰(1~6)ì— ë”°ë¼ ìˆœìˆ˜ìµì˜ 90%~60% ì°¨ë“± ì§€ê¸‰ ë°°ìœ¨ì„ ê²°ì •í•©ë‹ˆë‹¤.
 */
function util_getTradeCreditMult(grade) {
    var mapping = { 
        1: 0.90, // 1ë“±ê¸‰: 90% ìˆ˜ë ¹
        2: 0.85, // 2ë“±ê¸‰: 85% ìˆ˜ë ¹
        3: 0.80, // 3ë“±ê¸‰: 80% ìˆ˜ë ¹
        4: 0.75, // 4ë“±ê¸‰: 75% ìˆ˜ë ¹
        5: 0.70, // 5ë“±ê¸‰: 70% ìˆ˜ë ¹
        6: 0.60  // ì‹ ìš©ë¶ˆëŸ‰ì: 60% ìˆ˜ë ¹
    };
    // ë“±ê¸‰ ì •ë³´ê°€ ì—†ìœ¼ë©´ ìµœí•˜ ë“±ê¸‰(60%) ë°°ìœ¨ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ë°˜í™˜í•©ë‹ˆë‹¤.
    return mapping[grade] || 0.60;
}

//==========ì„¹í„°12==========

/* ê²½ì°° ì¶œë™ ê²°ê³¼ ì²˜ë¦¬ í•¨ìˆ˜ (ì¤‘ì•™ì€í–‰ ì—°ë™ ë° ë°©ë³„ ê²©ë¦¬ ë³´ì •) */
function processPoliceResult(roomName, thiefUid, victimUid) {
    var data = getDatabase();
    if (!data) return;
    var room = data.rooms[roomName];
    if (!room || !room.features || !room.features.states) return;

    // [í•µì‹¬ ìˆ˜ì •] ì „ì—­ ë³€ìˆ˜ê°€ ì•„ë‹Œ ë°©ë³„ ë…ë¦½ ìƒíƒœ ì €ì¥ì†Œë¥¼ ì°¸ì¡°í•˜ë„ë¡ ì—°ê²°
    var activeThefts = room.features.states.activeThefts; 

    var theftData = activeThefts[victimUid];
    if (!theftData) return;
    
    var thief = room.users[thiefUid];
    
    if (activeThefts[victimUid].successTimer) clearTimeout(activeThefts[victimUid].successTimer);
    
    // [ìƒíƒœ í•´ì œ] ì˜¬ë°”ë¥¸ ì°¸ì¡° ê²½ë¡œì—ì„œ ì‚­ì œ ìˆ˜í–‰
    delete activeThefts[victimUid]; 
    
    // 1. ë²Œê¸ˆ ê³„ì‚°: í˜„ê¸ˆ ì°¨ê°ì€ ë³´ìœ ì•¡ì˜ 10%
Â  Â  var cashFine = Math.floor(Number(thief.point) * 0.1);
Â  Â  // 2. ëŒ€ë‚© ê³„ì‚°: 1,000P í•˜í•œì„  ë³´ì¥ (ë¶€ì¡±ë¶„ ì‚°ì¶œ)
Â  Â  var loanGap = Math.max(0, 1000 - cashFine);
Â  Â Â 
Â  Â  util_updatePoint(thief, room, -cashFine, "ë„ë‘‘ì§ˆ ì²´í¬ ë²Œê¸ˆ", roomName);
Â  Â Â 
Â  Â  var loanMsg = "";
Â  Â  if (loanGap > 0) {
Â  Â  Â  Â  if (!thief.loan) thief.loan = { debt: 0, items: [] };
Â  Â  Â  Â  thief.loan.debt = Number(thief.loan.debt || 0) + loanGap;
Â  Â  Â  Â  if (!thief.loan.items) thief.loan.items = [];
Â  Â  Â  Â  thief.loan.items.push(loanGap);
Â  Â  Â  Â  loanMsg = "\nâš ï¸ ë²Œê¸ˆ ë¶€ì¡±ë¶„ ëŒ€ë‚©: " + fp(loanGap) + "P ëŒ€ì¶œ ì „í™˜";
Â  Â  }
Â  Â Â 
Â  Â  var jailTime = 1 * 60 * 60 * 1000;
Â  Â  util_setData(thief, 'jailReleaseTime', Date.now() + jailTime, "ë„ë‘‘ì§ˆ ì²´í¬ ì§•ì—­", roomName);
Â  Â Â 
Â  Â  var msg = "ğŸš¨ [ê²½ì°° ì¶œë™]\nëŒ€ìƒ: " + getDisplayName(thief) + "\në‚´ìš©: ë„ë‘‘ì§ˆ í˜„í–‰ë²” ì²´í¬\në²Œê¸ˆ: -" + fp(cashFine) + "P / ì§•ì—­ 1ì‹œê°„" + loanMsg + "\në‚´ ì”ì•¡: " + fp(thief.point) + "P";
    Api.replyRoom(roomName, formatAdmin("ğŸš“ ì²´í¬ ì™„ë£Œ", msg));
    safeSaveData(data);
}

/* ë„ë‘‘ì§ˆ ì„±ê³µ ê²°ê³¼ ì²˜ë¦¬ í•¨ìˆ˜ (ì¤‘ì•™ì€í–‰ ì—°ë™ ë° ë°©ë³„ ê²©ë¦¬ ë³´ì •) */
function processTheftResult(roomName, thiefUid, victimUid) {
    var data = getDatabase();
    if (!data) return;
    var room = data.rooms[roomName];
    if (!room || !room.features || !room.features.states) return;
    
    // [í•µì‹¬ ìˆ˜ì •] ë°©ë³„ ë…ë¦½ ìƒíƒœ ì €ì¥ì†Œ ì°¸ì¡° ì—°ê²°
    var activeThefts = room.features.states.activeThefts;

    if (!room.users[thiefUid] || !room.users[victimUid]) { 
        if (activeThefts[victimUid]) delete activeThefts[victimUid]; 
        Api.replyRoom(roomName, "âš ï¸ [ì‹œìŠ¤í…œ ì•Œë¦¼]\në„ë‘‘ì§ˆ ì§„í–‰ ì¤‘ ëŒ€ìƒì´ ì‚¬ë¼ì ¸ ìƒí™©ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        return; 
    }
    
    if (activeThefts[victimUid] && activeThefts[victimUid].policeTimer) clearTimeout(activeThefts[victimUid].policeTimer);

    var thief = room.users[thiefUid];
    var victim = room.users[victimUid];
    
    // 1. íƒˆì·¨ì•¡: 5% ~ 10% ì‚¬ì´ ëœë¤
    var minSteal = Math.floor(Number(victim.point) * 0.05);
    var maxSteal = Math.floor(Number(victim.point) * 0.10);
    var stealAmount = Math.floor(Math.random() * (maxSteal - minSteal + 1)) + minSteal;
    
    // 2. í”¼í•´ì ë³´í˜¸: 6ì‹œê°„ ë™ì•ˆ íƒ€ê²Ÿ ì œì™¸
    victim.lastTheftVictimTime = Date.now() + (6 * 60 * 60 * 1000);

    util_updatePoint(victim, room, -stealAmount, "ë„ë‘‘ì§ˆ ë‹¹í•¨", roomName);

    var plunderArtifact = "";
    if (Math.random() < 0.10 && Number(victim.artifactPieces || 0) > 0) {
        victim.artifactPieces = Number(victim.artifactPieces) - 1;
        thief.artifactPieces = Number(thief.artifactPieces || 0) + 1;
        plunderArtifact = "\n\nâœ¨ [ìœ ë¬¼ ì•½íƒˆ ì„±ê³µ]!\n" + victim.name + "ë‹˜ì˜ 'ìœ ë¬¼ ì¡°ê°' 1ê°œë¥¼ ê°€ë¡œì±˜ìŠµë‹ˆë‹¤!";
    }

    var res = processRepayment(thief, stealAmount, thiefUid, roomName); 
    
    // ë„ë‘‘ì˜ í¬ì¸íŠ¸ ì¦ê°€ (ì´ ëˆì€ í”¼í•´ìì—ê²Œì„œ ì™”ìœ¼ë¯€ë¡œ ì€í–‰ ì¬ì› ë³€ë™ 0)
    util_updatePoint(thief, room, Number(res.actualGain), "ë„ë‘‘ì§ˆ ì„±ê³µ", roomName);
    
   // 2. [í™•ì •] ë„ë‘‘ì§ˆ ì„±ê³µ ëˆ„ì  í†µê³„ ê²Œì´íŠ¸ì›¨ì´ ë³´í˜¸
    var nextTheftSuccess = Number(thief.totalTheftSuccess || 0) + 1;
    util_setData(thief, 'totalTheftSuccess', nextTheftSuccess, "ë„ë‘‘ì§ˆ ì„±ê³µ ê¸°ë¡", roomName);

    // 3. ë¦¬í”Œë¼ì´ì–´ ìŠ¤í… ì„ ì–¸ (ì¹­í˜¸ ìë™ ë¶€ì—¬ ì‹œìŠ¤í…œ ì—°ë™ìš©)
    var replierStub = { reply: function(m) { Api.replyRoom(roomName, m); } };

    // ì¹­í˜¸ ë¶€ì—¬ ë¡œì§ (ê²Œì´íŠ¸ì›¨ì´ë¡œ ê°±ì‹ ëœ ìµœì‹  ê°’ì„ ì°¸ì¡°)
    if (thief.totalTheftSuccess >= 50) {
        util_checkAndAwardTitle(thief, replierStub, "ì•½íƒˆì™•", 1203, "ğŸ‘¤", "ë‚´ë¦¬ë‹¤ ê·¸ë¦¼ì ê¸¸ë“œ", "ëˆ„ì  ë„ë‘‘ì§ˆ ì„±ê³µ 50íšŒ", "[ì¥ì°© íš¨ê³¼]: ë„ë‘‘ì§ˆ ì‹œ ê²½ì°°ì´ ì¶œë™í•  í™•ë¥ ì´ ê¸°ì¡´ 50%ì—ì„œ 30%ë¡œ ê°ì†Œí•©ë‹ˆë‹¤.");
    } else if (thief.totalTheftSuccess >= 30) {
        util_checkAndAwardTitle(thief, replierStub, "ëŒ€ë„", 1202, "ğŸ‘º", "ë‚´ë¦¬ë‹¤ ê·¸ë¦¼ì ê¸¸ë“œ", "ëˆ„ì  ë„ë‘‘ì§ˆ ì„±ê³µ 30íšŒ", "ëŒ€ë‹´í•œ ìˆ˜ë²•ìœ¼ë¡œ ì„¸ìƒì„ ë†€ë¼ê²Œ í•˜ê³  ìˆìŠµë‹ˆë‹¤.");
    } else if (thief.totalTheftSuccess >= 10) {
        util_checkAndAwardTitle(thief, replierStub, "ì¢€ë„ë‘‘", 1201, "ğŸ§¤", "ë‚´ë¦¬ë‹¤ ê·¸ë¦¼ì ê¸¸ë“œ", "ëˆ„ì  ë„ë‘‘ì§ˆ ì„±ê³µ 10íšŒ", "ë‚¨ì˜ ì§€ê°‘ì„ ê°€ë³ê²Œ ë§Œë“œëŠ” ê¸°ìˆ ì„ ìµí˜”ìŠµë‹ˆë‹¤.");
    }
    
    // [ìƒíƒœ í•´ì œ] ì˜¬ë°”ë¥¸ ì°¸ì¡° ê²½ë¡œì—ì„œ ì‚­ì œ ìˆ˜í–‰
    if (activeThefts[victimUid]) delete activeThefts[victimUid]; 
    
    var content = "ğŸ•µï¸ ë„ë‘‘ì§ˆ ì„±ê³µ!\n" + getDisplayName(victim) + "ë‹˜ì˜ ì§€ê°‘ì—ì„œ\n" + fp(stealAmount) + "Pë¥¼ í›”ì³¤ìŠµë‹ˆë‹¤!" + res.repayMsg + plunderArtifact;
    // [ìˆ˜ì •] ë„ë‘‘ì§ˆ ê²°ê³¼ì— ë³´ìœ  í¬ì¸íŠ¸ í‘œì‹œ ì¶”ê°€
    Api.replyRoom(roomName, formatCommand("ğŸ’° ë„ë‘‘ì§ˆ ê²°ê³¼", thief, content, "ë‚´ ì”ì•¡: " + fp(thief.point) + "P"));
    safeSaveData(data);
}

//==========ì„¹í„°13==========

/**
 * [ê²½ì œ ì‹œìŠ¤í…œ ëª¨ë“ˆ] í†µí•© ìë™ ìƒí™˜ ë° ì‹ ìš© ê´€ë¦¬ (ìˆ˜ì •ëœ ì°¨ë“± ë¹„ìœ¨ ë²„ì „)
 * ìˆ˜ì • ë‚´ìš©: 
 * 1. ì¼ë°˜ ì€í–‰ ë¹š ìƒí™˜: 30%
 * 2. ì‹ ìš©ë¶ˆëŸ‰ì/ì‚¬ì±„ ê°•ì œì¶”ì‹¬: 50%
 * 3. ì€í–‰ ëŒ€í™˜ ì±„ë¬´(ëŒ€ë‚©ê±´): 70%
 */

/* [ê¸°ëŠ¥ 1] ì‹ ìš©ë¶ˆëŸ‰ì ìƒíƒœ ì œì–´ */
function checkAndHandleDefaulter(user, roomName) {
    var currentScore = Number(user.creditScore || 600);
    if (currentScore < 500) {
        if (!user.isDefaulter) {
            util_setData(user, 'isDefaulter', true, "ì‹ ìš©ë„ í•˜ë½(500ë¯¸ë§Œ)", roomName);
            var msg = "ì‹ ìš© ì ìˆ˜ 500ì  ë¯¸ë§Œ í•˜ë½\n\n1. ëŒ€ì¶œ ë³´ìœ  ì‹œ ìˆ˜ìµ 50% ìë™ìƒí™˜\n2. ê°ì¢… ì§€ì›ê¸ˆ 20% ì‚­ê° (êµ­ê³  í™˜ìˆ˜)\n3. ì˜íšŒ íˆ¬í‘œê¶Œ ë°•íƒˆ"
            try { Api.replyRoom(roomName, formatCommand("ğŸ“‰ ì‹ ìš©ë¶ˆëŸ‰ì ì§€ì •", user, msg, "ëŒ€ì¶œ ìƒí™˜ì„ ê¶Œì¥í•©ë‹ˆë‹¤.")); } catch(e){}
        }
    } else {
        if (user.isDefaulter) { user.isDefaulter = false; }
    }
}

/* [ê¸°ëŠ¥ 2] ì€í–‰ ëŒ€ì¶œê¸ˆ ë¶„ì‚° ìƒí™˜ ì—”ì§„ */
function distributeRepayment(user, amount, roomName) {
    if (!user.loan || Number(user.loan.debt) < 1) {
        if (user.loan) { user.loan.debt = 0; user.loan.items = []; user.isTransferred = false; }
        return { actualRepay: 0, creditGain: 0, clearedCount: 0 };
    }
    
    var remainingRepay = Math.floor(Number(amount));
    var initialAmount = remainingRepay;
    var clearedCount = 0;
    
    if (!user.loan.items) user.loan.items = [];
    user.loan.items.sort(function(a, b) { return a - b; });
    
    var newItems = [];
    for (var i = 0; i < user.loan.items.length; i++) {
        var loanItem = Number(user.loan.items[i]);
        if (loanItem > 0 && remainingRepay >= loanItem) {
            remainingRepay -= loanItem;
            clearedCount++;
        } else {
            loanItem -= remainingRepay;
            remainingRepay = 0;
            if (loanItem > 0) newItems.push(loanItem);
        }
    }
    
    var actualRepayed = initialAmount - remainingRepay;
    user.loan.items = newItems;
    var remainingTotal = 0;
    for (var i = 0; i < newItems.length; i++) { 
        remainingTotal += Number(newItems[i]); 
    }
    user.loan.debt = remainingTotal; 

    // [ë³´ì •]: getCreditInfo í˜¸ì¶œ ì‹œ roomNameì„ ì „ë‹¬í•˜ì—¬ í˜„ì¬ ë°©ì˜ ê²½ì œ ì§€í‘œì— ë§ëŠ” ì‹ ìš© ê°€ì ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
    var crInfo = getCreditInfo(user.creditScore || 600, roomName);
    var restoreThreshold = Math.floor(crInfo.limit * 0.8);
    var appliedGain = (actualRepayed >= restoreThreshold) ? (clearedCount * 80) : 0;

    var nextScore = Math.min(1000, Number(user.creditScore || 600) + appliedGain);
    util_setData(user, 'creditScore', nextScore, "ëŒ€ì¶œ ìƒí™˜ ê°€ì ", roomName);

    // [í™•ì •]: ëŒ€ì¶œê¸ˆì´ ì™„ì „íˆ 0ì´ ë˜ì—ˆì„ ë•Œë§Œ ì±„ë¬´ ì™„ë‚© ì²˜ë¦¬ ë° íŠ¹ìˆ˜ ì±„ë¬´ í”Œë˜ê·¸ë¥¼ í•´ì œí•©ë‹ˆë‹¤.
    if (user.loan.debt <= 0) {
        user.loan.debt = 0; 
        user.loan.items = []; 
        util_setData(user, 'isTransferred', false, "ì±„ë¬´ ì™„ë‚©", roomName);
    }
    
    return { actualRepay: actualRepayed, creditGain: appliedGain, clearedCount: clearedCount };
}

/* [ê¸°ëŠ¥ 3] ì‚¬ì±„(P2P) ìë™ ì¶”ì‹¬ ì²˜ë¦¬ (ìˆ˜ì •: ì¶”ì‹¬ ë¹„ìœ¨ 50% ì ìš©) */
function processPrivateCollection(user, userUid, amount, roomName) {
    var data = getDatabase();
    var roomData = data.rooms[roomName];
    if (!roomData) return { collected: 0, msg: "" };

    if (!user.loan || Number(user.loan.debt || 0) <= 0) {
        util_setData(user, 'isTransferred', false, "ì±„ë¬´ ë¶€ì¬ ìƒíƒœ ë™ê¸°í™”", roomName);
    }
    
    // [ì„¤ì • ìˆ˜ì •] ì§ì ‘ ì¶”ì‹¬ í•œë„ë¥¼ ìˆ˜ìµì˜ 50%ë¡œ ë³€ê²½
    var totalLimit = Math.floor(Number(amount) * 0.5); 
    var remainingAmount = totalLimit; 
    
    var totalCollected = 0;
    var collectionLog = "";

    if (roomData.loanContracts) {
        for (var cid in roomData.loanContracts) {
            var c = roomData.loanContracts[cid];
            if (c.borrowerUid === userUid && c.status === 'overdue' && remainingAmount > 0) {
                var collectTarget = Math.min(remainingAmount, c.currentDebt);
                
                var lender = roomData.users[c.lenderUid];
                if (lender) {
                    util_updatePoint(lender, roomData, collectTarget, "ì‚¬ì±„ ì¶”ì‹¬ ìˆ˜ìµ (" + c.borrowerName + ")", roomName);
                }

                c.currentDebt -= collectTarget;
                totalCollected += collectTarget;
                remainingAmount -= collectTarget;
                collectionLog += "\n- " + c.lenderName + "ë‹˜ê»˜ " + fp(collectTarget) + "P ì†¡ê¸ˆ";

                if (c.currentDebt <= 0) {
                    delete roomData.loanContracts[cid];
                    collectionLog += " (ì™„ë‚© ì¢…ë£Œ)";
                }
            }
        }
    }

    if (totalCollected > 0) {
        var msg = "\n\nğŸš¨ [ì‚¬ì±„ ê°•ì œ ì¶”ì‹¬ ì•ˆë‚´]\nì‚¬ì±„ ì—°ì²´ë¡œ ì¸í•´ ìˆ˜ìµì˜ 50%ê°€ ì±„ê¶Œìì—ê²Œ ìë™ ê·€ì†ë˜ì—ˆìŠµë‹ˆë‹¤." + collectionLog;
        return { collected: totalCollected, msg: msg };
    }
    return { collected: 0, msg: "" };
}

/* [ê¸°ëŠ¥ 4] í†µí•© ìë™ ìƒí™˜ í”„ë¡œì„¸ìŠ¤ (ìˆ˜ì •: ë¹„ìœ¨ ì²´ê³„ ì „ë©´ ê°œí¸) */
function processRepayment(user, amount, userUid, roomName) {
    var amt = Number(amount) || 0;
    var currentGain = amt;
    var totalRepayMsg = "";
    var data = getDatabase();

    if (!user.loan || Number(user.loan.debt || 0) <= 0) {
        user.isTransferred = false;
    }

    // 1. ì‚¬ì±„ ì§ì ‘ ì¶”ì‹¬ (50% ë¹„ìœ¨ ì‘ë™)
    var privateRes = processPrivateCollection(user, userUid, currentGain, roomName);
    if (privateRes.collected > 0) {
        currentGain -= privateRes.collected;
        totalRepayMsg += privateRes.msg;
    }

    // 2. ì€í–‰ ëŒ€ì¶œ ìë™ ìƒí™˜
    if (currentGain > 0 && user.loan && Number(user.loan.debt) > 0) {
        // [ê¸°ë³¸ê°’] ì¼ë°˜ ìœ ì € ìƒí™˜ ë¹„ìœ¨ 30%
        var repaymentRate = 0.3; 
        var typeLabel = "ì¼ë°˜ ìƒí™˜";

        // [ì¡°ê±´ 1] ëŒ€í™˜ ì±„ë¬´(ì€í–‰ì´ ì‚¬ì±„ë¥¼ ëŒ€ì‹  ê°šì•„ì¤€ ê²½ìš°)ëŠ” 70% ì••ë¥˜
        if (user.isTransferred === true || user.isTransferred === "true") {
            repaymentRate = 0.7; 
            typeLabel = "ğŸš¨ ëŒ€í™˜ ì±„ë¬´ ê°•ì œ ì¶”ì‹¬";
        } 
        // [ì¡°ê±´ 2] ì‹ ìš©ë¶ˆëŸ‰ì(500ì  ë¯¸ë§Œ)ëŠ” ìˆ˜ìµ ë°œìƒ ì‹œ 50% ì••ë¥˜ (ìƒí™˜ ë¡œì§ í™•ì •)
Â  Â  Â  Â  else if (Number(user.creditScore || 600) < 500) {
Â  Â  Â  Â  Â  Â  repaymentRate = 0.5;Â 
Â  Â  Â  Â  Â  Â  typeLabel = "ì‹ ìš©ë¶ˆëŸ‰ ì œí•œ ìƒí™˜";
Â  Â  Â  Â  }

        var intendedRepay = Math.floor(currentGain * repaymentRate);
        if (intendedRepay > Number(user.loan.debt)) intendedRepay = Number(user.loan.debt);
        
        var res = distributeRepayment(user, intendedRepay, roomName);
        currentGain -= res.actualRepay;

        totalRepayMsg += "\n\nğŸ¦ [ì€í–‰ " + typeLabel + "]\nğŸ’° " + fp(res.actualRepay) + "P ìƒí™˜ë¨ (" + Math.floor(repaymentRate * 100) + "%)";
        
        if (res.creditGain > 0) {
            totalRepayMsg += "\nğŸ“ˆ ì‹ ìš© ì ìˆ˜ +" + res.creditGain + " ìƒìŠ¹";
        }
        
        totalRepayMsg += "\n(ë‚¨ì€ ëŒ€ì¶œ: " + fp(user.loan.debt) + "P)";
    } // if (currentGain > 0...) ë¸”ë¡ ì¢…ë£Œ
    
    return { actualGain: currentGain, repayMsg: totalRepayMsg };
}

//==========ì„¹í„°14==========

/* [ê°œí¸] ëœë“œë§ˆí¬ ë¦¬ìŠ¤íŠ¸ ìƒì„± í•¨ìˆ˜ (ë¶€ë™ì‚° ì»¨ì…‰ ì ìš©) */
function generateLandmarkList(data, roomName) {
    var list = [];
    var dangerLandmarks = [];
    var keys = Object.keys(data.landmarkMarket || {});
    if (keys.length === 0) return null;

    // íƒ€ì…ë³„ ìš°ì„ ìˆœìœ„ ì •ì˜ (ë‚®ì„ìˆ˜ë¡ ìƒë‹¨)
    var getTypePriority = function(name) {
        var fixed = ["ê´‘ì‚°", "ë‚šì‹œí„°", "ì¹´ì§€ë…¸", "ì¤‘ì•™ì€í–‰", "ë°±í™”ì ", "ê²½ë§ˆì¥"];
        if (fixed.indexOf(name) !== -1) return 1; // 1ìˆœìœ„: ê³ ì • ëœë“œë§ˆí¬

        var land = data.landmarkMarket[name];
        if (!land) return 4;
        
        if (land.type === "bluechip") return 2; // 2ìˆœìœ„: ë¹„ì¦ˆë‹ˆìŠ¤íƒ€ì›Œ (ğŸ¨)
        if (land.type === "hotspot") return 3;  // 3ìˆœìœ„: ìƒê°€ ë° ê¸°íƒ€ (ğŸšï¸)
        return 4;
    };

    // ë‹¤ì¤‘ ì •ë ¬: 1ìˆœìœ„ íƒ€ì…(ìš°ì„ ìˆœìœ„), 2ìˆœìœ„ ì´ë¦„(ê°€ë‚˜ë‹¤)
    keys.sort(function(a, b) {
        var priA = getTypePriority(a);
        var priB = getTypePriority(b);
        
        if (priA !== priB) return priA - priB;
        return a.localeCompare(b); // ê°€ë‚˜ë‹¤ìˆœ
    });

    var roomData = data.rooms[roomName]; // í•´ë‹¹ ë°©ì˜ ìœ ì € ë°ì´í„°ë¥¼ ì°¸ì¡°í•˜ê¸° ìœ„í•´ ê°€ì ¸ì˜´
    var landmarkTraits = SYSTEM_CONFIG.ECO.LANDMARK.TRAITS;

    var fixCfg = SYSTEM_CONFIG.ECO.LANDMARK.FIXED_POLICY; // ëˆ„ë½ëœ ë³€ìˆ˜ ì •ì˜ ì¶”ê°€

    for (var i = 0; i < keys.length; i++) {
        var name = keys[i];
        var landmark = data.landmarkMarket[name];
        var trait = landmarkTraits[landmark.type] || landmarkTraits.normal;
        
        var ownerTag = ""; 
        if (roomData) {
            var owner = util_getMajorityOwner(roomData, name);
            if (owner && owner.data) {
                ownerTag = "\n[" + getDisplayName(owner.data) + "]";
            }
        }
        
        var displayPrice = Number(landmark.price);
        var statusInfo = "";

        if (landmark.type === "normal") {
            // [ê°€ê²© ë™ê¸°í™”] ì„¹í„° 7ì˜ ì „ì—­ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
            var totalShares = util_getTotalShares(name, data);
            displayPrice = fixCfg.BASE_PRICE + (totalShares * (fixCfg.BASE_PRICE * fixCfg.PER_SHARE_RATE));
            statusInfo = " (ì´ " + totalShares + "ì§€ë¶„)";
        } else {
            var diff = displayPrice - Number(landmark.lastPrice);
            var rate = landmark.lastPrice > 0 ? ((diff / landmark.lastPrice) * 100).toFixed(1) : "0.0";
            var sign = diff > 0 ? "ğŸ”º" : (diff < 0 ? "ğŸ”¹" : "â–");
            statusInfo = " (" + sign + " " + Math.abs(rate) + "%)";
        }
        
        var warningMark = "";
        if (landmark.delistTick && landmark.delistTick > 0) {
            warningMark = " âš ï¸";
            dangerLandmarks.push(name);
        }
        
        list.push(trait.icon + " " + name + ": " + fp(displayPrice) + "P" + statusInfo + warningMark + ownerTag);
    } // for ë£¨í”„ ë

    var result = list.join("\n");

    if (dangerLandmarks.length > 0) {
        result += "\n\nâš ï¸ ë¶€ì§€ ê°€ì¹˜ í•˜ë½ìœ¼ë¡œ ê°•ì œ ì² ê±° ìœ„ê¸°!\ní•´ë‹¹ ê±´ë¬¼ : " + dangerLandmarks.join(", ");
    }
    
    return result;
}

//==========ì„¹í„°15==========

/* ëœë“œë§ˆí¬ ì´ë¦„ ìƒì„± í•¨ìˆ˜ (ë¶€ë™ì‚° ì „ìš©) */
function generateLandmarkName(data) {
    var conf = SYSTEM_CONFIG.ECO.LANDMARK;
    var name = "";
    for (var i = 0; i < 20; i++) {
        var pre = conf.PREFIXES[Math.floor(Math.random() * conf.PREFIXES.length)];
        var suf = conf.SUFFIXES[Math.floor(Math.random() * conf.SUFFIXES.length)];
        name = pre + suf;
        if (!data.landmarkMarket || !data.landmarkMarket[name]) break;
    }
    return name;
}

/* ëœë“œë§ˆí¬ íƒ€ì… í• ë‹¹ í•¨ìˆ˜ */
function assignLandmarkType() {
    var conf = SYSTEM_CONFIG.ECO.LANDMARK;
    var rand = Math.random() * 100;
    var cumulative = 0;
    for (var type in conf.TRAITS) {
        cumulative += conf.TRAITS[type].prob;
        if (rand < cumulative) return type;
    }
    return "normal";
}

/* ëœë“œë§ˆí¬ ì‹œì„¸ ë³€ë™ ë¡œì§ í•¨ìˆ˜ (ë¶€ë™ì‚° ë§ˆì¼“ í†µí•© ë²„ì „) */
function updateLandmarkPrices(data) {
    var conf = SYSTEM_CONFIG.ECO.LANDMARK;
    if (!data.landmarkMarket) data.landmarkMarket = {};
    if (!data.landmarkTraffic) data.landmarkTraffic = {}; 

    // 1. [ê³ ì •] ì‚¬ìš©ì ì§€ì • 6ëŒ€ í•µì‹¬ ëœë“œë§ˆí¬ ê°•ì œ ìƒì¥
    var fixedSites = {
        "ê´‘ì‚°": { price: 500000, type: "bluechip", icon: "â›ï¸" },
        "ë‚šì‹œí„°": { price: 300000, type: "normal", icon: "ğŸ£" },
        "ì¹´ì§€ë…¸": { price: 1000000, type: "hotspot", icon: "ğŸ°" },
        "ì¤‘ì•™ì€í–‰": { price: 5000000, type: "bluechip", icon: "ğŸ¦" },
        "ë°±í™”ì ": { price: 1500000, type: "hotspot", icon: "ğŸ¢" },
        "ê²½ë§ˆì¥": { price: 800000, type: "normal", icon: "ğŸ‡" }
    };
    
    for (var fName in fixedSites) {
        if (!data.landmarkMarket[fName]) {
            var site = fixedSites[fName];
            data.landmarkMarket[fName] = { 
                price: site.price, lastPrice: site.price, type: site.type, 
                delistTick: 0, delistLimit: 9999, trend: "none", trendTick: 0, openPrice: site.price 
            };
        }
    }

    var mainRoom = data.rooms["ë‚´ë¦¬ë‹¤"];
    var pol = util_getActivePolicy(mainRoom);

    var now = new Date();
    var currentHour = now.getHours();
    var isMarketOpen = (currentHour >= conf.SETTINGS.OPEN_HOUR && currentHour <= conf.SETTINGS.CLOSE_HOUR);
    
    var totalSum = 0;
    var count = 0;
    for (var k in data.landmarkMarket) { totalSum += Number(data.landmarkMarket[k].price); count++; }
    var marketAvg = count > 0 ? (totalSum / count) : 1000;

    var eco = calculateEconomy(data, "ë‚´ë¦¬ë‹¤");
    var activeUserCount = Math.max(1, eco.count); 
    var ecoBaseFloor = conf.SETTINGS.ABS_DELIST_LIMIT;

    var eventNews = [];

    /* [1] ì‹ ê·œ ë§¤ë¬¼ ë“±ë¡ ì²˜ë¦¬ */
    if (data.pendingNewLandmark && isMarketOpen) {
        if (Object.keys(data.landmarkMarket).length < conf.SETTINGS.MAX_COUNT) {
            var newName = generateLandmarkName(data);
            var newType = assignLandmarkType();
            var startPrice = Math.floor(marketAvg * ((Math.random() * 0.3) + 0.8));
            
            data.landmarkMarket[newName] = { 
                price: Number(startPrice), lastPrice: Number(startPrice), 
                type: newType, delistTick: 0, delistLimit: Math.floor(Math.random() * 4) + 2,
                trend: "none", trendTick: 0, openPrice: startPrice,
                isOverheated: false
            };
            eventNews.push("ğŸ™ï¸ ì‹ ê·œ ë§¤ë¬¼ ë“±ë¡: " + conf.TRAITS[newType].icon + " " + newName + " (" + fp(startPrice) + "P)");
        }
        data.pendingNewLandmark = false;
    }

    /* [2] ì¡°ì‘ í”„ë¦¬ì…‹ ì„¤ì • ë¡œë“œ */
    var mani = conf.MANIPULATION;
    var specLand = (mani && mani.ACTIVE) ? mani.TARGET : null;
    var specFactor = (mani && mani.ACTIVE) ? (mani.IS_UP ? Math.abs(mani.RATE) : -Math.abs(mani.RATE)) : 0;

    if (!specLand && data.pendingSpecialEffect && isMarketOpen) {
        specLand = data.pendingSpecialEffect.landmark; // landmarkë¡œ í‚¤ê°’ ëŒ€ì‘
        specFactor = data.pendingSpecialEffect.factor;
    }

    /* [3] ì‹œì„¸ ë³€ë™ ê³„ì‚° ë£¨í”„ */
    var msgCount = (mainRoom.features.msgCount || 0);
    var units = Math.floor(Math.min(msgCount, 500) / 50); 
    var hypeFactor = 1 + (units * 0.01); 

    for (var name in data.landmarkMarket) {
        var landmark = data.landmarkMarket[name];
        var trait = conf.TRAITS[landmark.type] || conf.TRAITS.normal;
        var changePercent = 0;
        
        landmark.lastPrice = Number(landmark.price);

        /* [Gemini] ëœë“œë§ˆí¬ íƒ€ì…(normal) ë³€ë™ ì œì™¸ ë¡œì§ */
        if (landmark.type === "normal") {
            // ëœë“œë§ˆí¬ëŠ” ì£¼ì‹í˜• ë³€ë™ì„ í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì—°ì‚°ì„ ê±´ë„ˆëœë‹ˆë‹¤.
            landmark.delistTick = 0; // ê°•ì œ ì² ê±° ìœ„í—˜ ë°©ì§€
            continue; 
        }

        if (isMarketOpen) {
            if (name === specLand) { 
                // [ì¡°ì‘ ë§¤ë¬¼] í­ë“±/í­ë½ ì²˜ë¦¬
                changePercent = specFactor * hypeFactor;
                eventNews.push("ğŸš¨ [ë³€ë™ì„± ì•Œë¦¼]\nê±´ë¬¼: " + name + "\në‚´ìš©: " + (specFactor > 0 ? "ğŸš€ ì‹œì„¸ í­ë“±" : "ğŸ“‰ ì‹œì„¸ í­ë½") + " (" + (Math.abs(changePercent * 100)).toFixed(1) + "%)");
            } else {
                // [ì¼ë°˜ ë§¤ë¬¼] íŠ¸ë Œë“œ ë° ì‹œì„¸ ë³€ë™ ì—°ì‚°
                if (landmark.trendTick <= 0) {
                    // íŠ¸ë Œë“œ ìœ ì§€ ì‹œê°„ ë‹¨ì¶•: ê¸°ì¡´ 2~5íšŒ -> ìˆ˜ì • 2~3íšŒ (ë” ë¹ ë¥¸ íƒœì„¸ ì „í™˜)
                    landmark.trendTick = Math.floor(Math.random() * 2) + 2; 
                    var p = Math.random(); 
                    landmark.trend = (p < 0.35) ? "up" : (p < 0.70 ? "down" : "volatile");
                }

                // ë³€ë™ í­ ëœë¤í™”: ê³ ì • 2.5% ëŒ€ì‹  1.0% ~ 4.0% ì‚¬ì´ì˜ ë¬´ì‘ìœ„ ë°°ìœ¨ ê²°ì •
                var randomRate = (Math.random() * 0.03) + 0.01; 
                var baseRate = (landmark.trend === "up" ? randomRate : (landmark.trend === "down" ? -randomRate : (Math.random() * 0.08 - 0.04)));
                changePercent = baseRate * trait.volatility * hypeFactor;
                
                var traffic = data.landmarkTraffic[name] || { buy: 0, sell: 0 };
                var trafficImpact = Math.max(-0.15, Math.min(0.15, ((traffic.buy - traffic.sell) / (activeUserCount * 5)) * 0.01));
                changePercent += trafficImpact;

                if (pol.volatilityMult) changePercent *= pol.volatilityMult;

                // [v11.9.9 êµì •] ì €í•­ì„  ë° í•˜ë½ ì••ë ¥ ë¡œì§ (ìƒìŠ¹ í¸í–¥ ì œê±°)
                var refPrice = landmark.openPrice || landmark.price;
                var growthRate = (landmark.price - refPrice) / refPrice;
                var sConf = conf.SETTINGS;

                if (growthRate > sConf.RESISTANCE_START) {
                    var gap = growthRate - sConf.RESISTANCE_START;
                    changePercent -= gap * sConf.GRAVITY;
                    changePercent += (Math.random() * 0.06 - 0.03); // ëŒ€ì¹­ì  ë‚œìˆ˜ ë°œìƒ
                    
                    if (growthRate >= sConf.CLOSING_LIMIT - 0.05) changePercent -= 0.08;
                }
                landmark.trendTick--;
            } // else ë¸”ë¡ ë
        } // if (isMarketOpen) ë¸”ë¡ ë
        
        // ìµœì¢… ê°€ê²© ê²°ì • ë° ìµœì €ê°€(10P) ë³´ì¥
        landmark.price = Math.max(10, Math.round(landmark.price * (1 + changePercent))); 

        // ê°•ì œ ì² ê±°(ìƒí) ìœ„ê¸° ì²´í¬
        if (landmark.price < (marketAvg * conf.SETTINGS.DELIST_LIMIT) || landmark.price < ecoBaseFloor) { 
            landmark.delistTick++; 
        } else { 
            landmark.delistTick = 0; 
        }
    } // for ë£¨í”„ ë

    /* ê°•ì œ ì² ê±°(ê²½ë§¤) ì§‘í–‰ */
    var demolished = [];
    for (var name in data.landmarkMarket) {
        if (data.landmarkMarket[name].delistTick >= data.landmarkMarket[name].delistLimit) demolished.push(name);
    }
    
    demolished.forEach(function(delName) { 
        for (var r in data.rooms) {
            for (var uid in data.rooms[r].users) {
                var u = data.rooms[r].users[uid];
                if (u.landHoldings) {
                    delete u.landHoldings[delName];
                    if (u.landAvg) delete u.landAvg[delName];
                }
            }
        }
        delete data.landmarkMarket[delName]; 
        eventNews.push("ğŸš¨ [ê°•ì œ ì² ê±°] " + delName + "\nì‚¬ìœ : ë¶€ì§€ ê°€ì¹˜ ë¯¸ë‹¬ë¡œ ì¸í•œ êµ­ê³  í™˜ìˆ˜"); 
    });

    data.landmarkTraffic = {}; 
    data.pendingSpecialEffect = null; 
    return eventNews;
}

/* ë¶€ë™ì‚° ì‹œì¥ ìˆ˜ë™ ì œì–´ ì—”ì§„ */
function market_forceNewLandmark() {
    var data = getDatabase();
    data.pendingNewLandmark = true;
    return "âœ… ë‹¤ìŒ ë³€ë™ íƒ€ì„ì— ì‹ ê·œ ë§¤ë¬¼ ë“±ë¡ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.";
}

function market_updateLandmarkNow(roomName) {
    var data = getDatabase();
    var result = updateLandmarkPrices(data);
    var body = "ğŸ“ˆ ë¶€ë™ì‚° ì‹œì„¸ ë³€ë™\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸŸ¢ ë¶€ë™ì‚° ìš´ì˜ì¤‘\n\n" + (generateLandmarkList(data) || "ë§¤ë¬¼ ì •ë³´ ì—†ìŒ");
    if (result.length > 0) body += "\n\n" + result.join("\n");
    body += "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"; 
    Api.replyRoom(roomName || "ë‚´ë¦¬ë‹¤", body);
    safeSaveData(data);
    return "âœ… ë¶€ë™ì‚° ì‹œì„¸ ê°±ì‹  ì™„ë£Œ.";
}

//==========ì„¹í„°16-1==========

/* í†µí•© ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰ í•¨ìˆ˜ (ë…ë¦½ ëª¨ë“ˆí˜• ì—”ì§„ + ëŒ€ì‹œë³´ë“œ ì—°ë™) */
function runScheduler() {
    var SCHEDULER_KEY = "kakaobot_scheduler_v5";
    var oldTimer = java.lang.System.getProperty(SCHEDULER_KEY);
    if (oldTimer) try { clearInterval(parseInt(oldTimer)); } catch (e) {}
    
    var newTimer = setInterval(function() {
        try {
            var data = getDatabase(); 
            if (!data) return;

            // [ë² ë¦­ë°© ì „ìš©]: ìŠ¤ì¼€ì¤„ëŸ¬ ì§€ì—°(ë¶€ì •ë§¥) ê°ì§€
            if (globalData.statusCheck && globalData.statusCheck.mainLoop) {
                var delay = Date.now() - globalData.statusCheck.mainLoop;
                if (delay > 15000) { // 15ì´ˆ ì´ìƒ ì§€ì—° ì‹œ
                    Api.replyRoom("ë² ë¦­ë°©", "ğŸ’“ [ì‹œìŠ¤í…œ ë¶€ì •ë§¥]\nìŠ¤ì¼€ì¤„ëŸ¬ ë£¨í”„ê°€ " + (delay/1000).toFixed(1) + "ì´ˆê°„ ì •ì§€ í›„ ì¬ê°œë˜ì—ˆìŠµë‹ˆë‹¤.");
                }
            }

            util_stamp("mainLoop"); // ë¡œì§ ì‹œì‘ ì‹œì ì— ë„ì¥ì„ ì°ì–´ ë¬´í•œ ê²½ê³ ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.

            // 0. ì…ë ¥ ëŒ€ê¸°ì—´ ìë™ ë§Œë£Œ ê°ì‹œ ì—”ì§„ ê°€ë™ (1ì´ˆ ì£¼ê¸°)
            // ì„¹í„° 7ì—ì„œ ì •ì˜í•œ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ 30ì´ˆ ì´ˆê³¼ ì‹œ ìë™ ë©”ì‹œì§€ë¥¼ ë°œì†¡í•©ë‹ˆë‹¤.
            if (typeof util_autoClearTimeouts === 'function') {
                util_autoClearTimeouts(data);
            }

            // ëª¨ë“  ì„¹í„°ê°€ ê³µìœ í•  ìƒíƒœ ê°ì²´ (Context)
            var ctx = {
                isUpdated: false,
                isForceBackup: false,
                now: new Date(),
                today: getSimpleDate(),
                season: getSimpleSeason(),
                /* [Gemini ìš”ì²­ ì‚¬í•­] í•˜ë“œì½”ë”© ìœ ì§€: ë©”ì¸ ìš´ì˜ ë°© ì§€ì • */
                targetRoom: "ë‚´ë¦¬ë‹¤",
                // ì•„ë˜ URLì— ë³¸ì¸ì˜ êµ¬ê¸€ ì›¹ ì•± URLì„ ì…ë ¥í•˜ì„¸ìš”.
                dashboardUrl: "https://script.google.com/macros/s/AKfycbyoURblg3-nLNgSE57Pb9RmjqK3wXyMSRpm9WrkWe3z2kyE_q_wmoabNECLNXWQ2SBZ/exec"
            };

            /* [ì‹ ê·œ] í•˜ì´ë¸Œë¦¬ë“œ ë””ìŠ¤ì½”ë“œ ì›ê²© ë°±ì—… (30ë¶„ ì „ì²´ / 1ë¶„ ë¡œê·¸) */
            /* [3. ë””ìŠ¤ì½”ë“œ ë°±ì—… - ì—ëŸ¬ ê²©ë¦¬ ë³´í˜¸ë§‰ ì„¤ì¹˜] */
            try {
                var webhookUrl = SYSTEM_CONFIG.BACKUP ? SYSTEM_CONFIG.BACKUP.DISCORD_WEBHOOK_URL : "";
                if (webhookUrl && webhookUrl.indexOf("http") === 0) {
                    var currentMin = ctx.now.getMinutes();
                    
                    // A. ì „ì²´ ë°ì´í„° ë°±ì—… (30ë¶„ ì£¼ê¸°)
                    if ((currentMin === 0 || currentMin === 30) && data.lastFullBackupMin !== currentMin) {
                        data.lastFullBackupMin = currentMin;
                        _sendDiscordFile(webhookUrl, FILE_PATH, "FULL_DATA_" + ctx.today + "_" + ctx.now.getHours() + "h" + currentMin + "m.json");
                    }

                    // B. ë¸”ë™ë°•ìŠ¤ ë¡œê·¸ ë°±ì—… (1ë¶„ ì£¼ê¸°)
                    if (data.lastLogBackupMin !== currentMin) {
                        data.lastLogBackupMin = currentMin;
                        logLock.lock();
                        try {
                            var logFile = new java.io.File(JOURNAL_PATH);
                            if (logFile.exists() && logFile.length() > 0) {
                                // 1. ì „ì†¡ìš© ì„ì‹œ íŒŒì¼ ìƒì„± (ë ˆì´ìŠ¤ ì»¨ë””ì…˜ ë°©ì§€)
                                var tempFileName = "LOG_TEMP_" + Date.now() + ".txt";
                                var tempPath = BASE_DIR + tempFileName;
                                var rawLogs = FileStream.read(JOURNAL_PATH);
                                
                                if (rawLogs && rawLogs.trim().length > 0) {
                                    // 2. íˆìŠ¤í† ë¦¬ í•©ì‚° ë° ì›ë³¸ ì¦‰ì‹œ ì´ˆê¸°í™”
                                    FileStream.append(BASE_DIR + "total_history.log", rawLogs);
                                    FileStream.write(JOURNAL_PATH, ""); 
                                    
                                    // 3. ì„ì‹œ íŒŒì¼ ì“°ê¸° ë° ë””ìŠ¤ì½”ë“œ ì „ì†¡ ìš”ì²­
                                    FileStream.write(tempPath, rawLogs);
                                    _sendDiscordFile(webhookUrl, tempPath, "LOG_" + ctx.now.getHours() + "h" + currentMin + "m.txt", true);
                                    
                                    Log.info("[Backup] ë¸”ë™ë°•ìŠ¤ ë¡œê·¸ ë¶„ë¦¬ ë° ì „ì†¡ ì˜ˆì•½ ì™„ë£Œ.");
                                }
                            }
                        } finally {
                            logLock.unlock();
                        }
                    }
                }
            } catch (backupError) {
                // ë°±ì—…ì—ì„œ ì—ëŸ¬ê°€ ë‚˜ë”ë¼ë„ ë¡œê·¸ë§Œ ë‚¨ê¸°ê³  ì•„ë˜ ê²Œì„ ë¡œì§ìœ¼ë¡œ ì •ìƒ ì§„í–‰
                Log.error("ğŸš¨ ë°±ì—… ì—”ì§„ ì¼ì‹œ ì˜¤ë¥˜ (ê²©ë¦¬ë¨): " + backupError);
            }

            // 1. ê²½ì œ/ê²½ë§ˆ (ì„¹í„° 16-2)
            try {
                if (typeof _runSector16Logic === 'function') _runSector16Logic(data, ctx);
            } catch (e) {
                Log.error("Sector 16 Logic Crash: " + e);
            }

            // 2. ì¼ì¼ ì´ˆê¸°í™” (ì„¹í„° 17)
            try {
                if (typeof _runSector17Logic === 'function') _runSector17Logic(data, ctx);
            } catch (e) {
                Log.error("Sector 17 Logic Crash: " + e);
            }

            // 3. ë¡œë˜ ì¶”ì²¨ (ì„¹í„° 18)
            try {
                if (typeof _runSector18Logic === 'function') _runSector18Logic(data, ctx);
            } catch (e) {
                Log.error("Sector 18 Logic Crash: " + e);
            }

            /* [ìµœì¢… ì €ì¥] í•˜ì´ë¸Œë¦¬ë“œ ë¹„ë™ê¸° ì €ì¥ ì²˜ë¦¬ */
            if (ctx.isUpdated) {
                SaveExecutor.execute(new java.lang.Runnable({
                    run: function() { safeSaveData(data, ctx.isForceBackup); }
                }));
            }

            util_stamp("mainLoop");

        } catch (e) { Log.error("Scheduler Error: " + e); }
    }, 1000);
    java.lang.System.setProperty(SCHEDULER_KEY, String(newTimer));
}

/**
 * [ì‹ ê·œ] ë””ìŠ¤ì½”ë“œ íŒŒì¼ ì „ì†¡ í—¬í¼ í•¨ìˆ˜
 */
function _sendDiscordFile(url, filePath, fileName) {
    Executor.execute(new java.lang.Runnable({
        run: function() {
            try {
                var file = new java.io.File(filePath);
                if (!file.exists()) return;

                org.jsoup.Jsoup.connect(url)
                    .data("file", fileName, new java.io.FileInputStream(file))
                    .ignoreContentType(true)
                    .ignoreHttpErrors(true)
                    .method(org.jsoup.Connection.Method.POST)
                    .execute();
                
                Log.info("[Remote Backup] " + fileName + " ì „ì†¡ ì„±ê³µ");
            } catch (e) {
                Log.error("Discord Backup Fail: " + e);
            }
        }
    }));
}

/** * [Gemini ìš”ì²­ ì‚¬í•­] ëŒ€ì‹œë³´ë“œ ë°ì´í„° ì „ì†¡ í•¨ìˆ˜ (ë¶€ë™ì‚° ë°ì´í„° ì „ì†¡ ê·œê²©)
 * ìˆ˜ì • ë‚´ìš©: ì£¼ì‹(stocks) í•„ë“œë¥¼ ëœë“œë§ˆí¬(landmarks) í•„ë“œë¡œ êµì²´í•˜ì—¬ ì „ì†¡í•©ë‹ˆë‹¤.
 */
function _sendToDashboard(data, ctx) {
    var totalPoints = 0;
    var userCount = 0;
    
    var mainRoomData = data.rooms[ctx.targetRoom];
    
    if (mainRoomData && mainRoomData.users) {
        for (var u in mainRoomData.users) {
            var userObj = mainRoomData.users[u];
            totalPoints += (Number(userObj.point || 0) + Number(userObj.bank || 0));
            userCount++;
        }
        
        if (mainRoomData.bankReserve !== undefined) {
            totalPoints += Number(mainRoomData.bankReserve);
        }
    }

    var payload = {
        total_money: totalPoints,
        user_count: userCount,
        landmarks: data.landmarkMarket || {}
    };

    Executor.execute(new java.lang.Runnable({
        run: function() {
            try {
                org.jsoup.Jsoup.connect(ctx.dashboardUrl)
                    .header("Content-Type", "application/json")
                    .requestBody(JSON.stringify(payload))
                    .ignoreContentType(true)
                    .ignoreHttpErrors(true)
                    .method(org.jsoup.Connection.Method.POST)
                    .execute();
            } catch (e) { Log.error("Dashboard Sync Error: " + e); }
        }
    }));
}

//==========ì„¹í„°16-2==========

/* [ì‹ ì„¤] ì§€ëŠ¥í˜• ê²½ì œ ìˆœí™˜ ì´ë²¤íŠ¸ (3ì¢… ëœë¤ - ì¦‰ì‹œ ë°œë™í˜•) */
function _runEconomicStimulus(data, ctx) {
    var roomName = ctx.targetRoom;
    var roomData = data.rooms[roomName];
    if (!roomData || !roomData.economyBase) return;

    var reserve = Number(roomData.bankReserve || 0);
    var base = Number(roomData.economyBase);
    
    // [ì¡°ê±´] ê¸°ì¤€ì  150% ì´ˆê³¼ ì‹œ 'ì¦‰ì‹œ' ë°œë™ (í•˜ë£¨ 1íšŒ ì œí•œ)
    if (reserve > base * 1.5 && data.lastStimulusDate !== ctx.today) {
        
        data.lastStimulusDate = ctx.today;
        var excess = reserve - base; // ì´ˆê³¼ë¶„ ê³„ì‚°
        var eventType = Math.floor(Math.random() * 3) + 1; // 1~3 ëœë¤ ì„ íƒ

        // â‘  [ì§ì ‘ ë¶„ë°°] íŠ¹ë³„ ë°°ë‹¹ê¸ˆ (ì´ˆê³¼ë¶„ì˜ 10% í™˜ì›)
        if (eventType === 1) {
            var totalGiveaway = Math.floor(excess * 0.1);
            var activeUsers = [];
            var nowTs = Date.now();
            for (var uid in roomData.users) {
                // ìµœê·¼ 3ì¼ ë‚´ ì ‘ì†ìë§Œ ëŒ€ìƒ
                if (nowTs - (new Date(roomData.users[uid].lastDate).getTime() || 0) < 3 * 86400000) {
                    activeUsers.push(roomData.users[uid]);
                }
            }

            if (activeUsers.length > 0) {
                var perUser = Math.floor(totalGiveaway / activeUsers.length);
                activeUsers.forEach(function(u) {
                    var res = processRepayment(u, perUser, u.uid, roomName);
                    util_updatePoint(u, roomData, Number(res.actualGain), "êµ­ê°€ íŠ¹ë³„ ë°°ë‹¹ê¸ˆ", roomName);
                });
                
                var msg1 = "ğŸŠ [êµ­ê°€ ê²½ì œ í˜¸í™©: íŠ¹ë³„ ë°°ë‹¹ê¸ˆ ì§€ê¸‰] ğŸŠ\n" +
                           "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                           "ì¤‘ì•™ì€í–‰ì˜ ìˆ˜ìµì´ ê¸°ì¤€ì¹˜ë¥¼ ì´ˆê³¼í•˜ì—¬\n" +
                           "êµ­ë¯¼ ì—¬ëŸ¬ë¶„ê»˜ ë°°ë‹¹ê¸ˆì„ ì¦‰ì‹œ í™˜ì›í•©ë‹ˆë‹¤!\n\n" +
                           "ğŸ’° ì´ í™˜ì› ê·œëª¨: " + fp(totalGiveaway) + "P (êµ­ê³  ì§€ì¶œ)\n" +
                           "ğŸ‘¥ ëŒ€ìƒ ì¸ì›: " + activeUsers.length + "ëª…\n" +
                           "ğŸ§§ ì¸ë‹¹ ë°°ë‹¹: +" + fp(perUser) + "P\n" +
                           "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                           "ğŸ’¡ ë¹šì´ ìˆëŠ” ê²½ìš° ìš°ì„  ìƒí™˜ë˜ì—ˆìŠµë‹ˆë‹¤.";
                Api.replyRoom(roomName, msg1);
            }
        }

        // â‘¡ [ë„ë°• í™œì„±í™”] ì­íŒŸ/ì´ì›”ê¸ˆ ì§€ì› (ì´ˆê³¼ë¶„ì˜ 10% íˆ¬ì…)
        else if (eventType === 2) {
            var supportAmt = Math.floor(excess * 0.1);
            var halfAmt = Math.floor(supportAmt / 2);
            
            data.lotto_jackpot_pool = (Number(data.lotto_jackpot_pool) || 0) + halfAmt;
            if (roomData.features && roomData.features.racing) {
                roomData.features.racing.carryOver = (Number(roomData.features.racing.carryOver) || 0) + halfAmt;
            }
            util_updateReserve(roomData, -supportAmt, "ë„ë°• ì‚°ì—… ì§„í¥ ì§€ì›ê¸ˆ", roomName);

            var msg2 = "ğŸ° [êµ­ê°€ ì§€ì›: ì‚¬í–‰ì„± ì‚°ì—… ì§„í¥ì±…] ğŸ°\n" +
                       "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                       "ê²½ê¸° ë¶€ì–‘ì„ ìœ„í•´ ì¤‘ì•™ì€í–‰ì´ ë§‰ëŒ€í•œ ìê¸ˆì„ íˆ¬ì…í•©ë‹ˆë‹¤!\n\n" +
                       "ğŸ‡ ê²½ë§ˆì¥ ì´ì›”ê¸ˆ: +" + fp(halfAmt) + "P ì§€ì›!\n" +
                       "ğŸ« ë¡œë˜ ì­íŒŸ: +" + fp(halfAmt) + "P ì§€ì›!\n" +
                       "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                       "ì§€ê¸ˆ ë°”ë¡œ ì¼í™•ì²œê¸ˆì˜ ê¸°íšŒë¥¼ ë…¸ë¦¬ì„¸ìš”!";
            Api.replyRoom(roomName, msg2);
        }

        // â‘¢ [ìƒì‚°ì„± í–¥ìƒ] 1:1 ë§¤ì¹­ ë³´ë„ˆìŠ¤ (2ì‹œê°„ ì§€ì†)
        else if (eventType === 3) {
            data.stimulusEndTime = Date.now() + (2 * 60 * 60 * 1000);
            
            var msg3 = "â›ï¸ [ê¸´ê¸‰: ìƒì‚°ì„± 1:1 ë§¤ì¹­ ì§€ì› ì‚¬ì—…] ğŸ£\n" +
                       "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                       "êµ­ê°€ ê²½ì œ í™œì„±í™”ë¥¼ ìœ„í•´ 'ê·¼ë¡œ ì¥ë ¤ê¸ˆ'ì´ ì§€ê¸‰ë©ë‹ˆë‹¤.\n\n" +
                       "â³ ì§€ì† ì‹œê°„: ì§€ê¸ˆë¶€í„° 2ì‹œê°„ ë™ì•ˆ\n" +
                       "âœ¨ íš¨ê³¼: ê´‘ì‚°/ë‚šì‹œ ìˆ˜ìµì˜ 100%ë¥¼ ì€í–‰ì´ ì¶”ê°€ ì§€ê¸‰!\n" +
                       "(ì˜ˆ: 1,000P ì±„êµ´ ì‹œ âœ ì€í–‰ì´ +1,000P ë” ì–¹ì–´ì¤Œ)\n" +
                       "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                       "\"ì¼í•œ ë§Œí¼ ë” ë“œë¦½ë‹ˆë‹¤! ì§€ê¸ˆ ë°”ë¡œ ì›€ì§ì´ì„¸ìš”!\"";
            Api.replyRoom(roomName, msg3);
        }
        
        ctx.isUpdated = true;
    }
}

/* ë…ë¦½ ë¡œì§ í•¨ìˆ˜: ì‚¬ì±„ ë° ì‹œìŠ¤í…œ ê´€ë¦¬ + ë¶€ë™ì‚° ìŠ¤ì¼€ì¤„ëŸ¬ í†µí•© ì—”ì§„ */
function _runSector16Logic(data, ctx) {
    if (ALLOWED_ROOMS.indexOf(ctx.targetRoom) === -1) return;
    try { _runEconomicStimulus(data, ctx); } catch(e) {}
    var nowTs = ctx.now.getTime();
    var currentHour = ctx.now.getHours();
    var currentMin = ctx.now.getMinutes();
    var currentSec = ctx.now.getSeconds();
    var conf = SYSTEM_CONFIG.ECO.LANDMARK;
    var rConf = SYSTEM_CONFIG.ECO.RACING; 
    var mani = conf.MANIPULATION;

    var mainRoomData = data.rooms[ctx.targetRoom];
    if (!mainRoomData || !mainRoomData.features) return; 

    var racingData = mainRoomData.features.racing;
    var lotto = mainRoomData.features.lotto;

    var gov = mainRoomData.features.government;

    /* [ê°€ìƒ ì •ë¶€] 1. ì•ˆê±´ ìë™ ë°œì˜ (20:00) */
    if (currentHour === 20 && currentMin === 0 && gov.lastBillDate !== ctx.today) {
        if (typeof gov_generateBill === 'function') {
            gov.pendingBill = gov_generateBill(); // ì•ˆê±´ ìƒì„± (ì„¹í„° 46 ë¡œì§)
            gov.votes = { pro: 0, con: 0, voters: [] };
            gov.lastBillDate = ctx.today;
            gov.isClosing = false;
            gov.resultStatus = null;

            var billMsg = "ğŸ›ï¸ [ë‚´ë¦¬ë‹¤ ì˜íšŒ ì•ˆê±´ ë°œì˜]\n" +
                          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                          "ğŸ“œ ì•ˆê±´: " + gov.pendingBill.name + "\n\n" +
                          "âœ… í˜œíƒ: " + gov.pendingBill.buffDesc + "\n" +
                          "âš ï¸ ëŒ€ê°€: " + gov.pendingBill.penaltyDesc + "\n" +
                          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                          "ğŸ•’ íˆ¬í‘œ ì‹œê°„: 20:00 ~ 23:50\n" +
                          "ğŸ ì°¸ì—¬ ë³´ìƒ: 2000P (ì¦‰ì‹œ ì§€ê¸‰)\n\n" +
                          "ğŸ’¡ ì°¸ì—¬: [/íˆ¬í‘œ ì°¬ì„±] ë˜ëŠ” [/íˆ¬í‘œ ë°˜ëŒ€]\n" +
                          "(ì°¸ì—¬ìœ¨ 50% ë¯¸ë§Œ ì‹œ ê¸°ê°ë©ë‹ˆë‹¤)";
            Api.replyRoom(ctx.targetRoom, billMsg);
            ctx.isUpdated = true;
        }
    }

    /* [ê°€ìƒ ì •ë¶€] 2. íˆ¬í‘œ ë§ˆê° ë° ì •ì¡±ìˆ˜ ê²€ì¦ (23:50) */
    if (currentHour === 23 && currentMin === 50 && gov.pendingBill && !gov.isClosing) {
        gov.isClosing = true;
        
        // ì •ì¡±ìˆ˜ ê³„ì‚°: ì˜¤ëŠ˜ ì¶œì„í•œ ìœ ì € ê¸°ì¤€ 50%
        var attendees = 0;
        for (var uid in mainRoomData.users) {
            if (mainRoomData.users[uid].lastDate === ctx.today) attendees++;
        }
        var quorum = Math.ceil(attendees * 0.5);
        var participantCount = gov.votes.voters.length;

        if (participantCount < quorum) {
            gov.resultStatus = "REJECTED_QUORUM";
            var failMsg = "ğŸ“¢ [ì˜íšŒ í†µë³´] ê¸ˆì¼ ì•ˆê±´ì´ ê¸°ê°ë˜ì—ˆìŠµë‹ˆë‹¤.\n" +
                          "ì‚¬ìœ : íˆ¬í‘œ ì •ì¡±ìˆ˜ ë¯¸ë‹¬\n" +
                          "(ì°¸ì—¬: " + participantCount + "ëª… / í•„ìš”: " + quorum + "ëª…)";
            Api.replyRoom(ctx.targetRoom, failMsg);
        } else {
            gov.resultStatus = (gov.votes.pro > gov.votes.con) ? "PASSED" : "REJECTED_VOTE";
            var resultText = (gov.resultStatus === "PASSED") ? "ê°€ê²° (ì°¬ì„± ê³¼ë°˜)" : "ë¶€ê²° (ë°˜ëŒ€ ê³¼ë°˜)";
            var finalMsg = "ğŸ›ï¸ [ì˜íšŒ íˆ¬í‘œ ì¢…ë£Œ]\nê²°ê³¼: " + resultText + "\n" +
                           "(ì°¬ì„± " + gov.votes.pro + "í‘œ / ë°˜ëŒ€ " + gov.votes.con + "í‘œ)\n\n" +
                           "ğŸ’¡ ê°€ê²°ëœ ì •ì±…ì€ 00ì‹œ 05ë¶„ì— ë°œíš¨ë©ë‹ˆë‹¤.";
            Api.replyRoom(ctx.targetRoom, finalMsg);
        }
        ctx.isUpdated = true;
    }

    /* [ê°€ìƒ ì •ë¶€] 3. ì •ì±… ê³µì‹ ì ìš© (00:05) */
    // ì¼ì¼ ì´ˆê¸°í™” ë¡œì§ë³´ë‹¤ ìš°ì„ ê¶Œì„ ê°–ë„ë¡ currentMin === 5 ì¡°ê±´ì—ì„œ ì •ì‚° ìš°ì„  ì‹¤í–‰
    if (currentHour === 0 && currentMin === 5 && gov.resultStatus !== null) {
        if (gov.resultStatus === "PASSED") {
            gov.activePolicy = JSON.parse(JSON.stringify(gov.pendingBill.effects));
            Api.replyRoom(ctx.targetRoom, "ğŸ›ï¸ [ì •ë¶€ ê³µí‘œ] ìƒˆë¡œìš´ ì •ì±… ë°œíš¨!\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nì•ˆê±´ '" + gov.pendingBill.name + "'ì´ ê°€ê²°ë˜ì–´ ì§€ê¸ˆë¶€í„° ëª¨ë“  ì‹œìŠ¤í…œì— ê³µì‹ ì ìš©ë©ë‹ˆë‹¤.");
        }
        
        // ì •ì‚° ì™„ë£Œ í›„ ìƒíƒœ ì´ˆê¸°í™” (ë°ì´í„° íœ˜ë°œ ë°©ì§€)
        gov.pendingBill = null;
        gov.resultStatus = null;
        gov.isClosing = false;
        for (var userUid in mainRoomData.users) {
            mainRoomData.users[userUid].hasVotedToday = false;
        }
        ctx.isUpdated = true;
    }

    /* [ì‹œìŠ¤í…œ] 5ë¶„ ì£¼ê¸° ì˜¤í† ì„¸ì´ë¸Œ & ë¶€ë™ì‚° ì‹œì¥ ì œì–´ */
    try {
        if (currentMin % 5 === 0 && data.lastAutoSaveMin !== currentMin) {
            data.lastAutoSaveMin = currentMin;
            ctx.isUpdated = true;
            ctx.isForceBackup = true; 
        }

        /* [v10.0 IPM] 5ë¶„ ì£¼ê¸° ì‹œìŠ¤í…œ ì„±ëŠ¥ ì§„ë‹¨ ë° ììœ¨ ìµœì í™” */
        if (currentMin % 5 === 0 && data.lastMonitorMin !== currentMin) {
            data.lastMonitorMin = currentMin;
            var logFile = new java.io.File(JOURNAL_PATH);
            PERF_METRICS.logSize = logFile.exists() ? logFile.length() : 0;

            if (PERF_METRICS.logSize > (INTELLIGENT_CONFIG ? INTELLIGENT_CONFIG.PERFORMANCE.MAX_LOG_SIZE : 1572864)) {
                var archivePath = BASE_DIR + "logs/transaction_" + ctx.today + ".bak";
                logFile.renameTo(new java.io.File(archivePath));
                Log.info("[IPM] ì„±ëŠ¥ ìœ ì§€ë¥¼ ìœ„í•´ ë¡œê·¸ ì•„ì¹´ì´ë¹™ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.");
            }

            if (PERF_METRICS.avgLag > (INTELLIGENT_CONFIG ? INTELLIGENT_CONFIG.PERFORMANCE.LAG_THRESHOLD_MS : 450)) {
                globalData.nameToIdCache = {}; 
                java.lang.System.gc();        
                Log.warn("[IPM] ì„±ëŠ¥ ì €í•˜ê°€ ê°ì§€ë˜ì–´ ë©”ëª¨ë¦¬ ê¸´ê¸‰ ìµœì í™”ë¥¼ ìˆ˜í–‰í–ˆìŠµë‹ˆë‹¤.");
            }
            PERF_METRICS.msgPerMin = 0; 
        }

        // [ë¶€ë™ì‚°] ê°œì¥ ì‹œ ì‹œê°€ ë™ê¸°í™” ë¡œì§
        if (currentHour === conf.SETTINGS.OPEN_HOUR && currentMin === 0 && data.lastMarketOpenDate !== ctx.today) {
            data.lastMarketOpenDate = ctx.today;
            if (data.landmarkMarket) {
                for (var lKey in data.landmarkMarket) {
                    data.landmarkMarket[lKey].openPrice = data.landmarkMarket[lKey].price;
                }
                ctx.isUpdated = true;
            }
        }
    } catch(e) { Log.error("Sys/Save Logic Error: " + e); }

    /* [2. ë¶€ë™ì‚° ì‹œì„¸ ë³€ë™ í†µí•© ì—”ì§„] (ì •ê° 1íšŒ ì‹¤í–‰) */
    // ì„¤ëª…: ê¸°ì¡´ì— íŒŒí¸í™”ë˜ì–´ ìˆë˜ 10ë¶„ ì£¼ê¸° ë¡œì§ê³¼ ì£¼ì‹(Stock) ë¡œì§ì„ ëª¨ë‘ ì œê±°í•˜ê³  ì´ í•˜ë‚˜ë¡œ í†µí•©í•©ë‹ˆë‹¤.
    try {
        var landCfg = SYSTEM_CONFIG.ECO.LANDMARK.SETTINGS;
        if (currentHour >= landCfg.OPEN_HOUR && currentHour <= landCfg.CLOSE_HOUR && currentMin === 0 && data.lastLandUpdateHour !== currentHour) {
            
            data.lastLandUpdateHour = currentHour; 

            if (mani && mani.ACTIVE === true) {
                data.pendingSpecialEffect = { landmark: mani.TARGET, factor: mani.IS_UP ? Math.abs(mani.RATE) : -Math.abs(mani.RATE), forceMani: true };
            }
            
            var landResult = updateLandmarkPrices(data);
            if (mainRoomData.features) mainRoomData.features.msgCount = 0;

            var statusText = "ğŸŸ¢ ë¶€ë™ì‚° ì‹œì¥ ìš´ì˜ ì¤‘ (" + landCfg.OPEN_HOUR + ":00 ~ " + landCfg.CLOSE_HOUR + ":59)";
            var body = "ğŸ“ˆ ë¶€ë™ì‚° ì‹œì„¸ ë³€ë™\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + statusText + "\n\n" + (generateLandmarkList(data, ctx.targetRoom) || "ë§¤ë¬¼ ì •ë³´ ì—†ìŒ");
            
            if (landResult && landResult.length > 0) body += "\n\n" + landResult.join("\n");
            body += "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”";
            
            Api.replyRoom(ctx.targetRoom, body);
            ctx.isUpdated = true;
            util_stamp("landmarkLogic");
        }
    } catch (e) { Log.error("Landmark Engine Error: " + e); }

    /* ë¬´ì—­ ì‹œìŠ¤í…œ 1ì‹œê°„ ì£¼ê¸° ìˆœí™˜ ì‹œì„¸ ë³€ë™ ì—”ì§„ */
    /**
     * ê¸°ëŠ¥: ë§¤ì‹œ 30ë¶„ ì •ê°ì— 5ê°œêµ­ì˜ ì„ í˜¸/ê¸°í”¼ í’ˆëª©ì„ 'ìˆœí™˜ ë§¤ì¹­' ë°©ì‹ìœ¼ë¡œ êµì²´ (1ì‹œê°„ ì£¼ê¸°)
     * ê·œì¹™: ìêµ­ ìƒì‚° í’ˆëª©ì€ ì ˆëŒ€ ì„ í˜¸/ê¸°í”¼ì— í¬í•¨ë˜ì§€ ì•ŠìŒ (ìˆ˜ì… í•„ìš”ì„± ê°•ì¡°)
     */
    try {
        var tradeCfg = SYSTEM_CONFIG.TRADE;
        if (currentMin === 30 && data.lastTradeUpdateHour !== currentHour) {
            data.lastTradeUpdateHour = currentHour;
            
            if (!mainRoomData.features.tradeMarket) mainRoomData.features.tradeMarket = {};
            
            // ìˆœí™˜ ë§¤ì¹­ì„ ìœ„í•œ í‘œì¤€ ë°°ì—´ ì •ì˜ (ìƒì‚°í’ˆ ê¸°ì¤€)
            var nations = ["ë…¸ë¥´ë”•", "ìƒ¹ê·¸ë¦´ë¼", "ë¸Œë¦¬íƒ€ë‹ˆì•„", "ì—˜ë„ë¼ë„", "ì‚¬ë§‰ì˜ë³„"];
            var goods = ["ì‹ë£Œí’ˆ", "ê³µì˜ˆí’ˆ", "ê³µì—…í’ˆ", "ë³´ì„", "ê·€ê¸ˆì†"];
            
            // ë§¤ ì‹œê°„ ê²¹ì¹˜ì§€ ì•ŠëŠ” ëœë¤ ì˜¤í”„ì…‹(1~3) ê²°ì • (ìêµ­ ë¬¼í’ˆ íšŒí”¼ìš©)
            var offset = Math.floor(Math.random() * 3) + 1; 
            var hOffset = (offset + 2) % 5; if (hOffset === 0) hOffset = 4;

            for (var i = 0; i < nations.length; i++) {
                var nName = nations[i];
                // ìƒì‚° ì¸ë±ìŠ¤ ië¥¼ ê¸°ì¤€ìœ¼ë¡œ ì˜¤í”„ì…‹ë§Œí¼ ë°€ì–´ì„œ ë°°ì •
                var favIdx = (i + offset) % 5;
                var hateIdx = (i + hOffset) % 5;

                mainRoomData.features.tradeMarket[nName] = {
                    favorite: goods[favIdx],
                    hate: goods[hateIdx],
                    specialty: tradeCfg.NATIONS[nName].specialty
                };
            }

            var tradeNotice = "âš™ï¸ [ë‚´ë¦¬ë‹¤ ë¬´ì—­ ì§€ë¶€ ê³µë³´]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                              "ğŸŒ ì„¸ê³„ êµì—­ ì‹œì„¸ê°€ 'ìˆœí™˜ ë§¤ì¹­'ìœ¼ë¡œ ë³€ë™ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n" +
                              "ê° êµ­ê°€ëŠ” í˜„ì¬ ë¶€ì¡±í•œ íƒ€êµ­ ë¬¼ìë¥¼ ì„ í˜¸í•˜ë©°,\nìêµ­ ìƒì‚° í’ˆëª©ì€ ì¼ì ˆ ë§¤ì…í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n" +
                              "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                              "ğŸ’¡ í™•ì¸: [/ë¬´ì—­] â” 1. ì„¸ê³„ ì‹œì„¸ í™•ì¸\n" +
                              "(â€» ì‹œì„¸ëŠ” ë§¤ì‹œ 30ë¶„ ì •ê°ì— ë³€ë™ë©ë‹ˆë‹¤.)";
            
            Api.replyRoom(ctx.targetRoom, tradeNotice);
            ctx.isUpdated = true;
            util_stamp("tradeMarketLogic");
        }
    } catch (e) { Log.error("Trade Market Update Error: " + e); }

    /* [1. ì‚¬ì±„ ë° ê²½ì œ ê°ì‹œ ì—”ì§„] (ë³´ì¡´ êµ¬ì—­) */
    // ì„¤ëª…: êµ­ê°€ ë¶€ë„, ì‚¬ì±„ ì´ì, ê°•ì œ ì¶”ì‹¬ ë“± ì‹œìŠ¤í…œ ì•ˆì •ì„±ì„ ìœ„í•œ í•µì‹¬ ë¡œì§ì…ë‹ˆë‹¤.
    try {
        for (var rName in data.rooms) {
            if (ALLOWED_ROOMS.indexOf(rName) === -1) continue;
            var roomData = data.rooms[rName];
            if (!roomData.loanContracts) roomData.loanContracts = {};

            if (roomData.bankReserve !== undefined) {
                var reserve = roomData.bankReserve;
                if (!roomData.lastBankAlert) roomData.lastBankAlert = "normal";

                var roomBase = roomData.economyBase || 3500000;
                var dangerLimit = Math.floor(roomBase * 0.3);
                var disasterLimit = Math.floor(roomBase * 0.1);
                var normalLimit = Math.floor(roomBase * 0.5);

                if (reserve < disasterLimit && roomData.lastBankAlert !== "disaster") {
                    roomData.lastBankAlert = "disaster";
                    var disasterMsg = "ğŸš¨ [êµ­ê°€ ë¶€ë„ ì„ í¬] ğŸš¨\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nì¤‘ì•™ì€í–‰ì˜ êµ­ê³ ê°€ ë°”ë‹¥ë‚¬ìŠµë‹ˆë‹¤(10% ë¯¸ë§Œ).\n\nğŸš« ë™ê²°: ë¶€ë™ì‚° ë§¤ë§¤, ì¹´ì§€ë…¸, ê²½ë§ˆ ë“± ëª¨ë“  íˆ¬ì í™œë™ì´ ì „ë©´ ê¸ˆì§€ë©ë‹ˆë‹¤.\nğŸ¥ ì œí•œ: ì¶œì„ ë° ë³µì§€ í¬ì¸íŠ¸ê°€ 50% ì‚­ê°ë©ë‹ˆë‹¤.\n\nâš ï¸ í•´ì œ ì¡°ê±´: êµ­ê³ ê°€ ê¸°ì¤€ì ì˜ 50%(" + fp(normalLimit) + "P) ì´ìƒ ì¶©ì „ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.";
                    Api.replyRoom(rName, disasterMsg);
                    ctx.isUpdated = true;
                }
                else if (reserve < dangerLimit && reserve >= disasterLimit && roomData.lastBankAlert === "normal") {
                    roomData.lastBankAlert = "warning";
                    var warningMsg = "âš ï¸ [êµ­ê°€ ë¶€ë„ ìœ„í—˜ ì•Œë¦¼]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nì¤‘ì•™ì€í–‰ ì¬ì›ì´ ìœ„í—˜ ìˆ˜ì¤€(30% ë¯¸ë§Œ)ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.\n\nğŸ¦ í˜„ì¬ ê¸ˆê³ : " + fp(reserve) + "P\nğŸ’¡ ì§€ì†ì ì¸ êµ­ê³  ìœ ì¶œ ì‹œ ë¶€ë„ê°€ ì„ í¬ë˜ì–´ ëª¨ë“  ê²½ì œ í™œë™ì´ ë™ê²°ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
                    Api.replyRoom(rName, warningMsg);
                    ctx.isUpdated = true;
                }
                else if (reserve >= normalLimit && (roomData.lastBankAlert === "warning" || roomData.lastBankAlert === "disaster")) {
                    roomData.lastBankAlert = "normal";
                    var normalMsg = "âœ… [êµ­ê°€ ë¶€ë„ í•´ì œ]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nêµ­ê³ ê°€ ì•ˆì •ê¶Œ(50% ì´ìƒ)ìœ¼ë¡œ ë³µêµ¬ë˜ì–´ ëª¨ë“  ê²½ì œ í™œë™ì´ ì •ìƒí™”ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nğŸ”“ í•´ì œ: ë¶€ë™ì‚°, ë„ë°•, ê²½ë§ˆ ì‹œìŠ¤í…œ ì¬ê°€ë™\nğŸ’° ë³µì§€: ëª¨ë“  ë³´ìƒì´ ì •ìƒ ì§€ê¸‰ìœ¼ë¡œ ì „í™˜ë©ë‹ˆë‹¤.";
                    Api.replyRoom(rName, normalMsg);
                    ctx.isUpdated = true;
                }
            }

            for (var cid in roomData.loanContracts) {
                var c = roomData.loanContracts[cid];
                var periodsPassed = Math.floor((nowTs - c.startTime) / 10800000); 
                
                if (c.appliedPeriods === undefined) c.appliedPeriods = 0;
                
                if (periodsPassed > c.appliedPeriods) {
                    var pendingPeriods = periodsPassed - c.appliedPeriods;
                    var totalNewInterest = 0;
                    for (var i = 0; i < pendingPeriods; i++) {
                        var currentDebt = Number(c.currentDebt || 0);
                        var interest = Math.floor(currentDebt * (Number(c.rate) / 100));
                        c.currentDebt = currentDebt + interest;
                        totalNewInterest += interest;
                    }
                    c.appliedPeriods = periodsPassed;
                    ctx.isUpdated = true;
                    
                    try {
                        var interestMsg = "ğŸš¬ [ì‚¬ì±„ ì´ì ê°±ì‹ ]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ‘¤ ëŒ€ìƒ: " + c.borrowerName + "ë‹˜\nğŸ¤ ì±„ê¶Œì: " + c.lenderName + "\nğŸ•’ ê²½ê³¼: " + (periodsPassed * 3) + "ì‹œê°„\nğŸ’° ì¶”ê°€ ì´ì: +" + fp(totalNewInterest) + "P\nğŸ“‰ í˜„ì¬ ì±„ë¬´: " + fp(c.currentDebt) + "P\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”";
                        Api.replyRoom(rName, interestMsg);
                    } catch(e) {}
                }

                var duration = nowTs - c.startTime;
                var overdueLimit = 24 * 60 * 60 * 1000;
                var bankTakeoverLimit = 36 * 60 * 60 * 1000;

                if (c.status === 'active' && duration > overdueLimit && duration <= bankTakeoverLimit) {
                    c.status = 'overdue'; ctx.isUpdated = true;
                    try { Api.replyRoom(rName, "ğŸš¨ [ê°•ì œ ì¶”ì‹¬ ì§‘í–‰ ì•Œë¦¼]\nëŒ€ìƒ: " + c.borrowerName + "ë‹˜\nì‚¬ìœ : ìƒí™˜ ê¸°í•œ(24ì‹œê°„) ì´ˆê³¼\n\nì§€ê¸ˆë¶€í„° ìˆ˜ìµì˜ 50%ê°€ ì±„ê¶Œìì—ê²Œ ìë™ ê·€ì†ë©ë‹ˆë‹¤."); } catch(e){}
                }
                else if (duration > bankTakeoverLimit) {
                    var amountToPay = Number(c.currentDebt);
                    var lender = roomData.users[c.lenderUid];
                    var borrower = roomData.users[c.borrowerUid];

                    if (lender && borrower) {
                        util_updatePoint(lender, roomData, amountToPay, "ì‚¬ì±„ ì€í–‰ ëŒ€ë‚© íšŒìˆ˜ (" + c.borrowerName + ")", rName);
                        if (!borrower.loan) borrower.loan = { debt: 0, items: [] };
                        borrower.loan.debt = Number(borrower.loan.debt) + amountToPay;
                        borrower.loan.items.push(amountToPay);
                        borrower.isTransferred = true; 
                        borrower.creditScore = Math.max(0, (borrower.creditScore || 600) - 120);
                        checkAndHandleDefaulter(borrower, rName);
                        
                        var takeoverMsg = "ğŸ›ï¸ [ì¤‘ì•™ì€í–‰ ëŒ€í™˜ ì§‘í–‰]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ‘¤ ëŒ€ìƒ: " + c.borrowerName + "ë‹˜\në‚´ìš©: ì‚¬ì±„ ì—°ì²´ 36ì‹œê°„ ê²½ê³¼ë¡œ ì€í–‰ì´ ëŒ€ë‚© ì²˜ë¦¬í•˜ì˜€ìŠµë‹ˆë‹¤.\n\nâš ï¸ [í˜ë„í‹°]: ì‹ ìš©ì ìˆ˜ -120ì  ê°•ë“±\nâš ï¸ í•´ë‹¹ ì±„ë¬´ëŠ” [ì€í–‰ ëŒ€í™˜ ëŒ€ì¶œ]ë¡œ ì „í™˜ë˜ì—ˆìœ¼ë©°, ëª¨ë“  ìˆ˜ìµì˜ 70%ê°€ ê°•ì œ ìƒí™˜ë©ë‹ˆë‹¤.\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”";
                        Api.replyRoom(rName, takeoverMsg);
                        delete roomData.loanContracts[cid];
                        ctx.isUpdated = true;
                    }
                }
            }
        }
    } catch (e) { Log.error("Loan/Bank Logic Error: " + e); }

    /* [3. ê²½ë§ˆ ì‹œìŠ¤í…œ í†µí•© ìŠ¤ì¼€ì¤„ëŸ¬] */
    try {
        // A. ê°œì¥ ì•Œë¦¼
        if (currentHour === rConf.OPEN_HOUR && currentMin === 0) {
            if (racingData.lastOpenDate !== ctx.today) {
                racingData.isOperating = true;
                racingData.isResultProcessed = false; 
                racingData.isDeadlineNotified = false;
                racingData.lastOpenDate = ctx.today;
                var startMsg = "ğŸ‡ [ë‚´ë¦¬ë‹¤ ê²½ë§ˆì¥ ê°œì¥ ì•Œë¦¼]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nì§€ê¸ˆë¶€í„° ì œ " + racingData.round + "íšŒì°¨ ê²½ë§ˆ ë°°íŒ…ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤!\n\nğŸ•’ ë°°íŒ… ì‹œê°„: ë§¤ì‹œ 00ë¶„ ~ 49ë¶„ 59ì´ˆ\nğŸ ê²°ê³¼ ë°œí‘œ: ë§¤ì‹œ 00ë¶„ 00ì´ˆ\nğŸš« ìš´ì˜ ì¢…ë£Œ: 23:59 (00:00 ìµœì¢… ê²°ê³¼)\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’¡ í˜„í™© í™•ì¸: [/ê²½ë§ˆ] ì…ë ¥";
                Api.replyRoom(ctx.targetRoom, startMsg);
            }
        }

        // B. ë°°íŒ… ë§ˆê° ì•Œë¦¼
        if (currentMin === 50 && !racingData.isDeadlineNotified) {
            if (currentHour >= rConf.OPEN_HOUR && currentHour <= rConf.CLOSE_HOUR) {
                racingData.isOperating = true; 
                racingData.isDeadlineNotified = true;
                var deadlineMsg = "ğŸ“¢ [ê²½ë§ˆ ë°°íŒ… ë§ˆê° ì•Œë¦¼]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nì œ " + racingData.round + "íšŒì°¨ ë°°íŒ…ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\nğŸ¦ ìµœì¢… ì§‘ê³„ í¬ì¸íŠ¸: " + fp(racingData.totalPool) + "P\nğŸ ìš°ìŠ¹ë§ˆ íŒë… ë° ì •ì‚° ì§„í–‰ ì¤‘...\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ‡ ì ì‹œ í›„ ì •ê°(00ë¶„)ì— ê²°ê³¼ê°€ ë°œí‘œë©ë‹ˆë‹¤!";
                Api.replyRoom(ctx.targetRoom, deadlineMsg);
                ctx.isUpdated = true;
            }
        }

        // C. ê²°ê³¼ ë°œí‘œ ë° ì •ì‚°
        var isRaceTime = (currentHour >= rConf.OPEN_HOUR && currentHour <= 23) || currentHour === 0;
        if (isRaceTime && currentMin === 0 && currentHour !== rConf.OPEN_HOUR) {
            if (racingData.lastProcessedHour !== currentHour) {
                racingData.isOperating = (currentHour >= rConf.OPEN_HOUR && currentHour <= 23);
                racingData.lastProcessedHour = currentHour;

                // [ì‹ ê·œ] ë°°íŒ… ë°€ì§‘ë„ì— ë”°ë¥¸ í™•ë¥  ì—­ë³´ì • (ë°°íŒ…ì´ ëª°ë¦´ìˆ˜ë¡ ìš°ìŠ¹ í™•ë¥  ê°ì†Œ)
                if (racingData.totalPool > 0) {
                    racingData.horses.forEach(function(h) {
                        var horseBetAmt = 0;
                        for (var uid in racingData.bets) {
                            if (racingData.bets[uid].horseId === h.id) {
                                horseBetAmt += Number(racingData.bets[uid].amount);
                            }
                        }
                        var betRatio = horseBetAmt / racingData.totalPool;
                        
                        // ë°€ì§‘ë„ ë³´ì • ê³„ìˆ˜: ë°°íŒ… ë¹„ìœ¨ì˜ 80%ë§Œí¼ ê°€ì¤‘ì¹˜ ì‚­ê° (ì—­ë°° ìœ ë„)
                        // ì˜ˆ: í•œ ë§ì— 100% ëª°ë¦¬ë©´ ìš°ìŠ¹ í™•ë¥ ì´ ê¸°ì¡´ì˜ 20% ìˆ˜ì¤€ìœ¼ë¡œ ê¸‰ë½
                        var penalty = 1 - (betRatio * 0.5);
                        h.weight = Math.max(0.1, h.weight * penalty); 
                    });
                }

                /* [ì¡°ì‘ ì—”ì§„] íŠ¹ì • ìœ ì €ì˜ ë°°íŒ…ë§ˆ ìš°ìŠ¹ ê°€ì¤‘ì¹˜ ë¶€ì—¬ */
                for (var uid in racingData.bets) {
                    var betUser = roomData.users[uid];
                    // ì¡°ì‘ì´ ì¼œì ¸ ìˆê³  ê²½ë§ˆ ë³´ì •ì¹˜ê°€ ì„¤ì •ëœ ê²½ìš°
                    if (betUser && betUser.isManipulated && (betUser.horseWinRate || 0) > 0) {
                        var targetHorseId = racingData.bets[uid].horseId;
                        var horse = racingData.horses[targetHorseId - 1];
                        
                        // [ë°¸ëŸ°ìŠ¤ ì¡°ì •]: 100ë°° ëŒ€ì‹  ì„¤ì •ê°’ì˜ 0.2ë°°ë¥¼ ê°€ì‚° (70% ì„¤ì • ì‹œ +14.0 ê°€ì¤‘ì¹˜)
                        // ë³´í†µ ë§ì˜ ê°€ì¤‘ì¹˜ê°€ 1.0 ë‚´ì™¸ì´ë¯€ë¡œ, 14.0ë§Œ ë”í•´ì ¸ë„ ì••ë„ì ì¸ ìš°ìŠ¹ í›„ë³´ê°€ ë©ë‹ˆë‹¤.
                        horse.weight += (betUser.horseWinRate * 0.2); 
                    }
                }
                
                var totalW = 0; racingData.horses.forEach(function(h){ totalW += h.weight; });
                var rVal = Math.random() * totalW; var accum = 0; var winner = racingData.horses[0];
                for(var i=0; i<racingData.horses.length; i++){ accum += racingData.horses[i].weight; if(rVal < accum){ winner = racingData.horses[i]; break; } }

                var tax = Math.floor(racingData.totalPool * rConf.TAX_RATE);
                var basePool = racingData.totalPool - tax + racingData.carryOver;
                var winPool = 0; var winnerUids = [];
                for(var uid in racingData.bets){ if(racingData.bets[uid].horseId === winner.id){ winPool += racingData.bets[uid].amount; winnerUids.push(uid); } }

                var mainRoom = data.rooms[ctx.targetRoom];
                // [êµì²´] ì§ì ‘ ì—°ì‚° ëŒ€ì‹  ë³´ì•ˆ ì—”ì§„ ì‚¬ìš© (ìˆ˜ìˆ˜ë£Œ ì…ê³ )
                if(mainRoom) util_updateReserve(mainRoom, tax, "ê²½ë§ˆ ìˆ˜ìˆ˜ë£Œ ì…ê³ ", ctx.targetRoom);

                var resultHeader = "ğŸ [ì œ " + racingData.round + "íšŒ ê²½ë§ˆ ê²°ê³¼ ë° ìƒˆ ê²½ê¸° ì•ˆë‚´]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n[ğŸ† ì§€ë‚œ ê²½ê¸° ê²°ê³¼]\n\"ë§ˆì§€ë§‰ ì§ì„  ì£¼ë¡œì—ì„œ " + winner.id + "ë²ˆ " + winner.name + "ê°€ ê³¨ì¸!\"\n\nğŸ¥‡ ìš°ìŠ¹ë§ˆ: [" + winner.id + "ë²ˆ " + winner.name + "]\n";
                var resultBody = "";
                
                if(winnerUids.length > 0) {
                    // [ë™ê¸°í™”]: ìµœì € ë³´ì¥ ë°°ìœ¨ì„ ìµœëŒ€ ìƒí•œ ë°°ìœ¨(MAX_PAYOUT_MULT)ê³¼ ì¼ì¹˜ì‹œí‚µë‹ˆë‹¤.
                    var targetMult = Number(rConf.MAX_PAYOUT_MULT || 7); 
                    var totalRequiredForPrize = Math.floor(winPool * targetMult);
                    
                    var subsidyNeeded = Math.max(0, totalRequiredForPrize - basePool);
                    var actualSubsidy = 0;
                    if (subsidyNeeded > 0 && mainRoom) {
                        actualSubsidy = Math.min(subsidyNeeded, mainRoom.bankReserve || 0);
                        util_updateReserve(mainRoom, -actualSubsidy, "ê²½ë§ˆ ë³´ì „ê¸ˆ ì§€ì¶œ", ctx.targetRoom);
                    }
                    var finalDistributePool = basePool + actualSubsidy;
                    var totalActuallyPaid = 0;

                    resultBody += "ğŸ›ï¸ êµ­ê³  ìˆ˜ìˆ˜ë£Œ(10%): " + fp(tax) + "P ì…ê³ \n";
                    if (actualSubsidy > 0) {
                        resultBody += "ğŸ›¡ï¸ " + targetMult + "ë°° ë°°ë‹¹ ë³´ì „ ì§€ì›: " + fp(actualSubsidy) + "P\n";
                    } else if (racingData.carryOver > 0) {
                        resultBody += "ğŸ’° ì´ì›”ê¸ˆ í¬í•¨: " + fp(racingData.carryOver) + "P ë°©ì¶œ!\n";
                    }
                    
                    resultBody += "\n[ğŸ–ï¸ ì£¼ìš” ë‹¹ì²¨ì]";
                    winnerUids.forEach(function(uId){
                        var b = racingData.bets[uId]; var u = null;
                        for(var r in data.rooms){ if(data.rooms[r].users[uId]){ u = data.rooms[r].users[uId]; break; } }
                        if(u){
                            var share = b.amount / winPool;
                            var prize = Math.floor(share * finalDistributePool);
                            
                            // [ê³ ì • ë°°ë‹¹ í•µì‹¬]: ìƒí•œì„ ê³¼ ë³´ì¥ì•¡ì„ ë™ì¼í•˜ê²Œ ì„¤ì • (targetMult ë°° ê³ ì •)
                            var fixedLimit = b.amount * targetMult; 
                            
                            // ê³„ì‚°ëœ ë‹¹ì²¨ê¸ˆì´ ë³´ì¥ì•¡ë³´ë‹¤ í¬ë©´ ë³´ì¥ì•¡(7ë°°)ìœ¼ë¡œ ê¹ê³ , 
                            // ë¶€ì¡±í•˜ë©´ ë³´ì „ê¸ˆì´ í¬í•¨ëœ prizeë¥¼ ê·¸ëŒ€ë¡œ ì§€ê¸‰í•˜ì—¬ ê²°ê³¼ì ìœ¼ë¡œ 7ë°°ë¥¼ ë§ì¶¤
                            if (prize > fixedLimit) prize = fixedLimit;

                            if (!util_isBankSolvent(ctx.targetRoom, prize)) {
                                try { Api.replyRoom(ctx.targetRoom, "ğŸš¨ [êµ­ê³  ë¶€ë„] ê²½ë§ˆ ë‹¹ì²¨ê¸ˆ ì§€ê¸‰ ëŠ¥ë ¥ì´ ë¶€ì¡±í•˜ì—¬ ì´ì›” ì²˜ë¦¬ë©ë‹ˆë‹¤."); } catch(e){}
                                return;
                            }

                            var res = processRepayment(u, prize, uId, ctx.targetRoom);
                            util_updatePoint(u, mainRoomData, Number(res.actualGain), "ê²½ë§ˆ ë‹¹ì²¨ê¸ˆ", ctx.targetRoom);
                            totalActuallyPaid += prize;
                            
                            resultBody += "\nâ€¢ " + b.name + " (+" + fp(res.actualGain) + "P) âœ¨" + targetMult + "ë°°ë³´ì¥";
                        }
                    });
                    
                    // ì •ì‚° í›„ ë‚¨ì€ ê¸ˆì•¡ì€ ë‹¤ìŒ íšŒì°¨ë¡œ ì´ì›” (íŒëˆì´ ë„˜ì³¤ì„ ê²½ìš° ëŒ€ë¹„)
                    racingData.carryOver = Math.max(0, finalDistributePool - totalActuallyPaid);
                    if (racingData.carryOver > 10) {
                        resultBody += "\n\nğŸ’° ìƒí•œ ì´ˆê³¼ë¶„ " + fp(racingData.carryOver) + "PëŠ”\në‹¤ìŒ íšŒì°¨ ë°°ë‹¹ìœ¼ë¡œ ì´ì›”ë˜ì—ˆìŠµë‹ˆë‹¤!";
                    }
               } else {
                    var currentRoundNetPool = racingData.totalPool - tax; 
                    var toBank = Math.floor(currentRoundNetPool * rConf.WINLESS_BANK_RATE); 
                    racingData.carryOver = (currentRoundNetPool - toBank) + racingData.carryOver;
                    if(mainRoom) util_updateReserve(mainRoom, toBank, "ê²½ë§ˆ ë¬´ìŠ¹ì êµ­ê³  í™˜ìˆ˜", ctx.targetRoom);
                    resultBody += "ğŸ’€ ë‹¹ì²¨ ìœ ì € ì—†ìŒ\nğŸ’° ì´ì›”ê¸ˆ ë³´ì „ ì™„ë£Œ: " + fp(racingData.carryOver) + "P\n" +
                                 "ğŸ›ï¸ ê¸ˆê¸° íŒëˆ êµ­ê³  ê·€ì†(" + (rConf.WINLESS_BANK_RATE * 100).toFixed(0) + "%): " + fp(toBank) + "P";
                }

                var isClosing = (currentHour === 0);
                if (isClosing) {
                    racingData.isOperating = false;
                    resultBody += "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’¤ ê¸ˆì¼ ê²½ë§ˆ ìš´ì˜ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\në‹¤ìŒ ê²½ê¸°ëŠ” ì˜¤ì „ 09:00ì— ì‹œì‘ë©ë‹ˆë‹¤.";
                } else {
                    resultBody += "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâœ¨ [ì œ " + (racingData.round + 1) + "íšŒ ê²½ê¸° ì‹œì‘] âœ¨\nì§€ê¸ˆë¶€í„° ë‹¤ìŒ ê²½ê¸° ë°°íŒ…ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.";
                }

                Api.replyRoom(ctx.targetRoom, resultHeader + resultBody);
                util_stamp("racingLogic");

                racingData.round++; 
                racingData.bets = {}; 
                racingData.totalPool = 0;
                racingData.isDeadlineNotified = false;
                
                var conds = [{l:"ğŸš€ ìµœìƒ",w:1.5},{l:"â˜€ï¸ ì–‘í˜¸",w:1.2},{l:"â˜ï¸ ë³´í†µ",w:1.0},{l:"ğŸ’§ ë¶€ì§„",w:0.7}];
                racingData.horses.forEach(function(h){ var c=conds[Math.floor(Math.random()*conds.length)]; h.icon=c.l; h.weight=c.w; });
                ctx.isUpdated = true;
            }
        }
    } catch (e) { Log.error("Racing Logic Error: " + e); }

    /* [5. í†µí•© ì¹´ì§€ë…¸ ë°±ê·¸ë¼ìš´ë“œ ì—”ì§„] */
    /**
     * ê¸°ëŠ¥: ì‚¬ë‹¤ë¦¬(2ë¶„), ë°”ì¹´ë¼(3ë¶„) ì£¼ê¸°ì— ë§ì¶° ë‹¹ì²¨ ê²°ê³¼ ìƒì„± ë° ì •ì‚°
     * íŠ¹ì§•: ì±„íŒ…ë°© ì•Œë¦¼ ì—†ì´ 'ì¡°ìš©íˆ' ë°ì´í„°ë§Œ ê°±ì‹ í•˜ë©°, ê²°ê³¼ëŠ” ìœ ì €ê°€ ë©”ë‰´ ì§„ì… ì‹œ í™•ì¸
     */
    try {
        if (!mainRoomData.features.casino) {
            mainRoomData.features.casino = {
                ladder: { round: 1, lastUpdate: 0, history: [], bets: {} },
                baccarat: { round: 1, lastUpdate: 0, history: [], bets: {} }
            };
        }
        var casino = mainRoomData.features.casino;

        // --- [A] ì‚¬ë‹¤ë¦¬ ê²Œì„ ì—”ì§„ (2ë¶„ ì£¼ê¸°) ---
        if (currentMin % 2 === 0 && currentSec === 0 && casino.ladder.lastUpdate !== currentMin) {
            casino.ladder.lastUpdate = currentMin;
            
            var adj = SYSTEM_CONFIG.ADJUST;
            var oddSum = 0, evenSum = 0;

            // 1. í˜„ì¬ íšŒì°¨ì˜ í™€/ì§ë³„ ì´ ë°°íŒ…ì•¡ ì§‘ê³„
            for (var uid in casino.ladder.bets) {
                var b = casino.ladder.bets[uid];
                if (b.pick.indexOf("í™€") !== -1) oddSum += b.amount;
                else evenSum += b.amount;
            }

            var rigProb = null;
            // í•´ë‹¹ íšŒì°¨ ë°°íŒ… ìœ ì € ì¤‘ ì¡°ì‘ ëŒ€ìƒì´ ìˆëŠ”ì§€ ìŠ¤ìº”
            for (var uid in casino.ladder.bets) {
                var u = mainRoomData.users[uid];
                if (u && u.isManipulated) {
                    rigProb = u.gambleWinRate / 100; // ìœ ì € ê°œë³„ ì„¤ì •ê°’(ì˜ˆ: 0.65) ì‚¬ìš©
                    break; 
                }
            }

            // ìš°ì„ ìˆœìœ„: 1ìˆœìœ„ ì¡°ì‘í™•ë¥  / 2ìˆœìœ„ í”¼ë²„íƒ€ì„ / 3ìˆœìœ„ ê¸°ë³¸ìŠ¹ë¥ 
            var winProb = (rigProb !== null) ? rigProb : SYSTEM_CONFIG.PROB.ODD_EVEN_WIN;
            
            // ì¡°ì‘ ëŒ€ìƒìê°€ ì—†ì„ ë•Œë§Œ ê³ ì•¡ ë°°íŒ… í˜ë„í‹°(10ë§ŒPë‹¹ -1%) ì‘ë™
            if (rigProb === null && adj && adj.ENABLED) {
                var penalty = (Math.floor(oddSum / 100000) * 0.01) - (Math.floor(evenSum / 100000) * 0.01);
                winProb = Math.max(0.30, Math.min(0.70, winProb - penalty));
            }

            // 3. ë³´ì •ëœ í™•ë¥ ì— ë”°ë¼ ê²°ê³¼(oe) ë¨¼ì € ê²°ì •
            var oe = (Math.random() < winProb) ? "í™€" : "ì§"; 

            // 4. ê²°ì •ëœ ê²°ê³¼ì— ë§ëŠ” ì‹œê°ì  ê²½ë¡œ(ì¢Œ/ìš°, 3/4ì¤„) ì—­ì‚°
            var start, lines;
            if (oe === "ì§") {
                if (Math.random() < 0.5) { start = "ì¢Œ"; lines = 3; }
                else { start = "ìš°"; lines = 4; }
            } else {
                if (Math.random() < 0.5) { start = "ì¢Œ"; lines = 4; }
                else { start = "ìš°"; lines = 3; }
            }
            var result = { start: start, lines: lines, oe: oe, full: start + lines + oe };

            // 2. ë‹¹ì²¨ì ì •ì‚° (ì¡°ìš©íˆ í¬ì¸íŠ¸ ì§€ê¸‰)
            for (var uid in casino.ladder.bets) {
                var bet = casino.ladder.bets[uid];
                var u = null;
                // ë°© ì´íƒˆ ìœ ì €ë¥¼ ëŒ€ë¹„í•´ ì „ êµ¬ì—­ ìœ ì € íƒìƒ‰ (ì •ì‚° ë©ˆì¶¤ ë°©ì§€ í•µì‹¬)
                for (var r in data.rooms) { if (data.rooms[r].users[bet.uid || uid]) { u = data.rooms[r].users[bet.uid || uid]; break; } }
                if (!u) continue;

                var isWin = (bet.pick === oe || bet.pick === result.full);
                var nowStr = new Date().getHours() + ":" + ("0" + new Date().getMinutes()).slice(-2);

                if (isWin) {
                    var mult = (bet.pick.length > 1) ? 4.0 : 1.9;
                    if (u.title === "ë„ë°•ì™•") mult += 0.05; // ì¹­í˜¸ íš¨ê³¼ ì—°ë™
                    var winAmt = Math.floor(bet.amount * mult);
                    
                    // ë‹¹ì¼ ë¦¬í¬íŠ¸ ë° ì§ì „ ê²°ê³¼ ê¸°ë¡
                    if (!u.dailyLadderWins) u.dailyLadderWins = [];
                    u.dailyLadderWins.unshift({ round: casino.ladder.round, pick: bet.pick, profit: winAmt, time: nowStr });
                    u.lastCasinoResult = { type: "ladder", round: casino.ladder.round, res: bet.pick, profit: winAmt, isWin: true };

                    // ì¤‘ì•™ì€í–‰ ì§€ë¶ˆ ëŠ¥ë ¥ ì²´í¬ (ë¶€ë„ ë°©ì§€)
                    if (util_isBankSolvent(ctx.targetRoom, winAmt)) {
                        u.skipHealing = true; // ê³ ì•¡ ë‹¹ì²¨ ì‹œ ë¡¤ë°± ë°©ì§€
                        var res = processRepayment(u, winAmt, bet.uid || uid, ctx.targetRoom);
                        util_updatePoint(u, mainRoomData, Number(res.actualGain), "ì‚¬ë‹¤ë¦¬ ì ì¤‘ (" + result.full + ")", ctx.targetRoom);
                        u.totalGambleWins = (u.totalGambleWins || 0) + 1;
                        u.lastCasinoResult = { type: "ladder", round: casino.ladder.round, res: bet.pick, profit: winAmt, isWin: true };
                    }
                } else {
                    // ë¯¸ì ì¤‘ ì‹œ ì§ì „ ê²°ê³¼ë§Œ ì—…ë°ì´íŠ¸ (ì†ì‹¤ì•¡ ê¸°ë¡)
                    u.lastCasinoResult = { type: "ladder", round: casino.ladder.round, res: "ë¯¸ì ì¤‘", profit: -bet.amount, isWin: false };
            }
         }

            // 3. ê¸°ë¡ ì•„ì¹´ì´ë¹™ ë° ì´ˆê¸°í™”
            casino.ladder.history.unshift({ round: casino.ladder.round, res: result.full, time: Date.now() });
            if (casino.ladder.history.length > 10) casino.ladder.history.pop();
            casino.ladder.round++;
            casino.ladder.bets = {};
            ctx.isUpdated = true;
        }

        // --- [B] ë°”ì¹´ë¼ ê²Œì„ ì—”ì§„ (3ë¶„ ì£¼ê¸°) ---
        if (currentMin % 3 === 0 && currentSec === 0 && casino.baccarat.lastUpdate !== currentMin) {
            casino.baccarat.lastUpdate = currentMin;

            // 1. ê²°ê³¼ ìƒì„± ë° ë³´ì • (ADJUST ê²½ë¡œ êµì •)
            var adj = SYSTEM_CONFIG.ADJUST; 
            
            var rigTargetPick = null;
            // [ì¡°ì‘] ë°°íŒ… ìœ ì € ì¤‘ ì¡°ì‘ í™œì„±í™” ìœ ì € íƒìƒ‰
            for (var uid in casino.baccarat.bets) {
                var u = mainRoomData.users[uid];
                if (u && u.isManipulated && Math.random() < (u.gambleWinRate / 100)) {
                    rigTargetPick = casino.baccarat.bets[uid].pick;
                    break; 
                }
            }

            var generateBaccarat = function(forced) {
                if (forced) {
                    // ì¡°ì‘ ë°œë™ ì‹œ: í”Œë ˆì´ì–´(9:0), ë±…ì»¤(0:9), íƒ€ì´(5:5) ê°•ì œ ìƒì„±
                    if (forced === "P") return { ps: 9, bs: 0, res: "P" };
                    if (forced === "B") return { ps: 0, bs: 9, res: "B" };
                    return { ps: 5, bs: 5, res: "T" };
                }
                var ps = Math.floor(Math.random() * 10);
                var bs = Math.floor(Math.random() * 10);
                var res = (ps > bs) ? "P" : (ps < bs ? "B" : "T");
                return { ps: ps, bs: bs, res: res };
            };

            var r = generateBaccarat(rigTargetPick);

            // 2. ìŠ¹ë¦¬íŒ€ íŒëˆ í™•ì¸ ë° ì€ë°€í•œ ì¬ì¶”ì²¨(Nerf)
            if (adj && adj.ENABLED) {
                var totalOnWin = 0;
                for (var uid in casino.baccarat.bets) {
                    if (casino.baccarat.bets[uid].pick === r.res) {
                        totalOnWin += casino.baccarat.bets[uid].amount;
                    }
                }
                var nerfProb = Math.floor(totalOnWin / (adj.STEP_AMOUNT || 100000)) * (adj.STEP_RATE || 0.01);
                if (Math.random() < nerfProb) r = generateBaccarat();
            }

            var pScore = r.ps, bScore = r.bs, resTag = r.res;
            var resName = { "P": "í”Œë ˆì´ì–´", "B": "ë±…ì»¤", "T": "íƒ€ì´" }[resTag];

            // 3. ë‹¹ì²¨ì ì •ì‚° (ì „ êµ¬ì—­ ìœ ì € íƒìƒ‰í˜•ìœ¼ë¡œ êµì²´í•˜ì—¬ ë©ˆì¶¤ ë°©ì§€)
            for (var uid in casino.baccarat.bets) {
                var bBet = casino.baccarat.bets[uid];
                var bu = null;
                // [ì•ˆì „]: ë©”ì¸ë°©ë¿ë§Œ ì•„ë‹ˆë¼ ì „ êµ¬ì—­ì—ì„œ ìœ ì € ê°ì²´ í™•ë³´
                for (var rName in data.rooms) { 
                    if (data.rooms[rName].users[uid]) { bu = data.rooms[rName].users[uid]; break; } 
                }
                
                if (!bu) continue;

                if (bBet.pick === resTag) {
                    var bMult = (resTag === "T") ? 8.0 : (resTag === "P" ? 2.0 : 1.95);
                    var bWinAmt = Math.floor(bBet.amount * bMult);
                    bu.skipHealing = true;
                    var bRes = processRepayment(bu, bWinAmt, uid, ctx.targetRoom);
                    util_updatePoint(bu, mainRoomData, Number(bRes.actualGain), "ë°”ì¹´ë¼ ì ì¤‘ (" + resName + ")", ctx.targetRoom);
                    bu.totalCasinoWin = (bu.totalCasinoWin || 0) + bWinAmt;
                    bu.lastCasinoResult = { type: "baccarat", round: casino.baccarat.round, res: resName, profit: bWinAmt, isWin: true };
                    } else {
                   bu.lastCasinoResult = { type: "baccarat", round: casino.baccarat.round, res: "ë¯¸ì ì¤‘", profit: -bBet.amount, isWin: false };
                }
            }

            // 3. ê¸°ë¡ ì•„ì¹´ì´ë¹™ ë° ì´ˆê¸°í™”
            casino.baccarat.history.unshift({ round: casino.baccarat.round, res: resTag, p: pScore, b: bScore, time: Date.now() });
            if (casino.baccarat.history.length > 10) casino.baccarat.history.pop();
            casino.baccarat.round++;
            casino.baccarat.bets = {};
            ctx.isUpdated = true;
        }
    } catch (e) { Log.error("Casino Background Engine Error: " + e); }

    // ì¶”ê°€: ì¹´ì§€ë…¸ 1ë¶„ ë¯¸ì‚¬ìš© ì‹œ ìë™ í‡´ì¥ ì•Œë¦¼ ì—”ì§„ (ìŠ¤ì¼€ì¤„ëŸ¬ ë£¨í”„ ë‚´ ìœ„ì¹˜)
    try {
        var nowTs = Date.now();
        for (var r in data.rooms) {
            var roomUsers = data.rooms[r].users;
            for (var uid in roomUsers) {
                var u = roomUsers[uid];
                // 1:1 ëŒ€í™”ë°© ìœ ì €ì´ë©´ì„œ, ì¹´ì§€ë…¸ ê°ì‹œê°€ í™œì„±í™”ëœ ìƒíƒœì´ê³ , ë§ˆì§€ë§‰ í™œë™ í›„ 1ë¶„(60,000ms)ì´ ê²½ê³¼í•œ ê²½ìš°
                if (u.casinoAuditStartTime > 0 && (nowTs - (u.lastBotUseTime || 0) > 60000)) {
                    var exitLog = "ğŸšª [ì¹´ì§€ë…¸ í‡´ì¥ ì•Œë¦¼]\n" +
                                  "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                                  "ğŸ‘¤ ìœ ì €: " + u.name + "\n" +
                                  "ğŸ†” ID: " + uid + "\n" +
                                  "ğŸ’° ìµœì¢…ìì‚°: " + fp(Number(u.point) + Number(u.bank || 0)) + " P\n" +
                                  "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                                  "âœ… 1ë¶„ ë¯¸í™œë™ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.";
                    
                    try { Api.replyRoom("ë² ë¦­ë°©", exitLog); } catch(e) {}
                    
                    // ê°ì‹œ ë°ì´í„° ì´ˆê¸°í™” (í‡´ì¥ ì²˜ë¦¬)
                    u.casinoAuditStartTime = 0;
                    u.casinoAuditStartAssets = 0;
                    u.casinoAuditAlertHistory = [];
                    ctx.isUpdated = true; // ë³€ê²½ ì‚¬í•­ ì €ì¥ í”Œë˜ê·¸
                }
            }
        }
    } catch (e) { Log.error("Casino Exit Monitor Error: " + e); }

    /* [4. í”¼ë²„íƒ€ì„ ë° ê²°íˆ¬ ì²´í¬] */
    try {
            for (var dKey in duelData) {
            var d = duelData[dKey];
            if (nowTs > d.expire) {
                var room = data.rooms[d.room];
                if (room && room.users[d.challengerUid]) {
                    util_updatePoint(room.users[d.challengerUid], room, Number(d.point), "ê²°íˆ¬ ë§Œë£Œ í™˜ê¸‰", d.room);
                    try { Api.replyRoom(d.room, "â° ê²°íˆ¬ ë§Œë£Œ\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nìƒëŒ€ë°© ì‘ë‹µ ì—†ìŒìœ¼ë¡œ " + fp(d.point) + "P í™˜ê¸‰ ì™„ë£Œ\në‚´ ì”ì•¡: " + fp(room.users[d.challengerUid].point) + "P"); } catch(err) {}
                }
                delete duelData[dKey]; ctx.isUpdated = true; 
            }
        }
    } catch (e) { Log.error("Fever/Duel Logic Error: " + e); }
}
// ì—”ì§„ ê°€ë™
runScheduler();

//==========ì„¹í„°17==========

/**
 * ì„¹í„° 17 ë¡œì§ í•¨ìˆ˜: ë¶€ë™ì‚° ì‹œì¥ ë§ˆê°, ì¼ì¼ ë°ì´í„° ì´ˆê¸°í™” ë° ì‹œì¦Œ ë¦¬ì…‹ ê´€ë¦¬
 * [v11.0] Landmark & Property Tax System
 */
function _runSector17Logic(data, ctx) {

    // [ìˆ˜ì •] ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ ê°€ë“œ: ë¡œì§ ì§„ì… ì§í›„ì— ë°”ë¡œ ë‚ ì§œë¥¼ ê°±ì‹ í•˜ì—¬ ë¬´í•œ ë°˜ë³µ ì°¨ë‹¨
    if (data.lastDailyReset === ctx.today) return;
    data.lastDailyReset = ctx.today;
    if (typeof safeSaveData === 'function') safeSaveData(data); // ì¦‰ì‹œ ë¬¼ë¦¬ ì €ì¥

    // [ë¶€ë™ì‚°] ê³¼ì—´ ìƒíƒœ ë° ì¼ì¼ ë³€ë™ ë°ì´í„° ì´ˆê¸°í™”
    if (data.landmarkMarket) {
        for (var lName in data.landmarkMarket) {
                data.landmarkMarket[lName].isOverheated = false;
            }
            Log.info("[Landmark Engine] ë¶€ë™ì‚° ì˜ì—… ì¢…ë£Œì— ë”°ë¥¸ ê³¼ì—´ ìƒíƒœ ì´ˆê¸°í™” ì™„ë£Œ.");
        }
        
        // [1] ìë™ ë¬¼ê°€ ê¸°ì¤€ì  ë³´ì • ì‹œìŠ¤í…œ
        for (var rName in data.rooms) {
            var rObj = data.rooms[rName];
            var eco = calculateEconomy(data, rName); // ì„¹í„° 8ì—ì„œ ê³ ì¹œ ë¶€ë™ì‚° í•©ì‚° ì—”ì§„ ì‚¬ìš©

            // [ì‹ ê·œ] 00ì‹œ ê¸°ì¤€ ìœ ì € í‰ê·  ìˆœìì‚° í™•ì • (ë‚´ì¼ ëŒ€ì¶œ í•œë„ì˜ ê¸°ì¤€ì´ ë¨)
            if (rObj.features && rObj.features.government) {
                rObj.features.government.dailyAvgAsset = eco.average;
                Log.info("[" + rName + "] ë‚´ì¼ì ëŒ€ì¶œ ìœ ë™ í•œë„ ê¸°ì¤€ì  ì„¤ì •: " + fp(eco.average) + "P");
            }
            
            if (eco.total > 0) {
                var oldBase = rObj.economyBase || eco.total;
                rObj.economyBase = Math.floor(Math.sqrt(oldBase * eco.total));
                Log.info("[" + rName + "] ê²½ì œ ê¸°ì¤€ì  ìë™ ì¡°ì • ì™„ë£Œ: " + fp(rObj.economyBase) + "P");
            }
        }

        // [2] ë¶€ë™ì‚° ì‹œì¥ ì¢…ë£Œ ì²˜ë¦¬ (ì „ì—­ ê³µì§€)
        try { 
            Api.replyRoom(ctx.targetRoom, formatAdmin("ğŸ“‰ ì¥ ë§ˆê° ì•Œë¦¼", "ê¸ˆì¼ ë¶€ë™ì‚° ì‹œì¥ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n(ì¼ì¼ ì‹œì„¸ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.)")); 
        } catch(e) {}

        // [4] í”¼ë²„íƒ€ì„ ìš”ì¼ë³„ ê³µì§€
        var dayOfWeek = ctx.now.getDay(); 
        if (dayOfWeek === 0) {
            try { Api.replyRoom(ctx.targetRoom, formatAdmin("ğŸ”¥ í”¼ë²„íƒ€ì„ ì‹œì‘", "ì¼ìš”ì¼ í•œì • ì´ë²¤íŠ¸!\nìŠ¹ê¸‰ í™•ë¥  +5% ìƒìŠ¹ì´ ì ìš©ë©ë‹ˆë‹¤.")); } catch(e){}
        } else if (dayOfWeek === 1) {
            try { Api.replyRoom(ctx.targetRoom, formatAdmin("â„ï¸ í”¼ë²„íƒ€ì„ ì¢…ë£Œ", "ì´ë²¤íŠ¸ê°€ ì¢…ë£Œë˜ì–´\nìŠ¹ê¸‰ í™•ë¥ ì´ ì •ìƒí™”ë˜ì—ˆìŠµë‹ˆë‹¤.")); } catch(e){}
        }

        // [3, 4ë²ˆ í†µí•©] ìœ ë ¹ ìœ ì € ì²­ì†Œ ë° ê°•ë ¥í•œ ëˆ„ì§„ì„¸(ë³´ìœ ì„¸) ì§‘í–‰ ë¡œì§
        for (var rName in data.rooms) {
            var roomObj = data.rooms[rName];
            var eco = calculateEconomy(data, rName);
            var wealthyThreshold = eco.average * 3; // í‰ê·  ìì‚°ì˜ 3ë°° ì´ˆê³¼ ì‹œ ë¶€ìœ ì¸µ

            var reportTotalTax = 0;   
            var reportTaxCount = 0;   
            var reportPurgeCount = 0; 

            for (var id in roomObj.users) {
                var u = roomObj.users[id];
                
                // [3ë²ˆ] 14ì¼ ì´ìƒ ë¯¸ì¶œì„ ìœ ì € ë°ì´í„° ì²­ì†Œ ë° ìì‚° êµ­ê³  ê·€ì† (ê¸°ì¡´ 30ì¼ì—ì„œ ë‹¨ì¶•)
                var lastDateTs = u.lastDate ? new Date(u.lastDate).getTime() : 0;
                var daysInActive = (Date.now() - lastDateTs) / (1000 * 60 * 60 * 24);
                
                if (u.lastDate !== "" && daysInActive > 14) {
                    if (Number(u.point) > 0) {
                        util_updatePoint(u, roomObj, -u.point, "ì¥ê¸° ë¯¸ì ‘ì† ìì‚° í™˜ìˆ˜", rName);
                    }
                    delete roomObj.users[id];
                    reportPurgeCount++;
                    continue;
                }

                // [ë³´ìœ ì„¸ ì§‘í–‰] ë¶€ë™ì‚° ê°€ì¹˜ê°€ í¬í•¨ëœ ìˆœìì‚° ê¸°ì¤€ ì§•ìˆ˜
                var netWorth = util_calculateNetWorth(u, roomObj);
                var taxRate = 0;
                
                if (netWorth > 1000000) taxRate = 0.05;      // 100ë§ŒP ì´ˆê³¼: 5%
                else if (netWorth > 500000) taxRate = 0.03;  // 50ë§ŒP ì´ˆê³¼: 3%
                else if (netWorth > 100000) taxRate = 0.01;  // 10ë§ŒP ì´ˆê³¼: 1%

                if (taxRate > 0) {
                    var tax = Math.floor(netWorth * taxRate);
                    if (u.title === "ê¸°ë¶€ì™•") {
                        tax = Math.floor(tax * 0.5);
                    }
                    if (tax > 0) {
                        var currentCash = Number(u.point);
                        if (currentCash >= tax) {
                            // í˜„ê¸ˆì´ ì¶©ë¶„í•œ ê²½ìš° ì •ìƒ ì§•ìˆ˜
                            util_updatePoint(u, roomObj, -tax, "ë¶€ë™ì‚° ë³´ìœ ì„¸ ì§•ìˆ˜", rName);
                        } else {
                            // í˜„ê¸ˆì´ ë¶€ì¡±í•œ ê²½ìš°: ì”ì•¡ ì „ì•¡ ë‚©ë¶€ + ë¶€ì¡±ë¶„ ëŒ€ì¶œ ì „í™˜
                            var loanGap = tax - currentCash;
                            if (currentCash > 0) util_updatePoint(u, roomObj, -currentCash, "ë¶€ë™ì‚° ë³´ìœ ì„¸(ë¶€ë¶„ë‚©ë¶€)", rName);
                            
                            if (!u.loan) u.loan = { debt: 0, items: [] };
                            u.loan.debt = Number(u.loan.debt || 0) + loanGap;
                            u.loan.items.push(loanGap);
                            
                            // ì€í–‰ì´ ëŒ€ë‚©í•œ ê²ƒìœ¼ë¡œ ê°„ì£¼í•˜ì—¬ êµ­ê³ ì— ë¶€ì¡±ë¶„ ì…ê³ 
                            util_updateReserve(roomObj, loanGap, "ë³´ìœ ì„¸ ë¶€ì¡±ë¶„ ëŒ€ì¶œ ì „í™˜", rName);
                        }
                        reportTotalTax += tax;
                        reportTaxCount++;
                    }
                }
            }

            // [ìë™ ë³´ê³ ] ì •ì‚° ë‚´ì—­ì´ ìˆì„ ë•Œë§Œ ê²°ê³¼ ì¶œë ¥
            if (reportTaxCount > 0 || reportPurgeCount > 0) {
               var reportMsg = "ğŸŒ™ [ì•¼ê°„ ê²½ì œ ì•ˆì •í™” ì •ì‚° ë³´ê³ ]\n" +
                                "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                                "âœ… ë³´ìœ ì„¸(ëˆ„ì§„ì œ) ì§•ìˆ˜ ì™„ë£Œ\n" +
                                "â€¢ ë‚©ì„¸ ì¸ì›: " + reportTaxCount + "ëª…\n" +
                                "â€¢ ì´ ì„¸ìˆ˜: +" + fp(reportTotalTax) + "P (êµ­ê³  ì…ê³ )\n\n" +
                                "âœ… ìœ ë ¹ ìœ ì € ë°ì´í„° ì •ë¦¬\n" +
                                "â€¢ ì²­ì†Œ ì¸ì›: " + reportPurgeCount + "ëª…\n" +
                                "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                                "ğŸ›ï¸ ì¤‘ì•™ì€í–‰ ê¸ˆê³ ê°€ ìµœì‹ í™”ë˜ì—ˆìŠµë‹ˆë‹¤.";
                Api.replyRoom(rName, reportMsg);
            }

            // í•˜ì´í”„ ì¹´ìš´íŠ¸(ì±„íŒ…ëŸ‰) ì´ˆê¸°í™”
            if (roomObj.features) roomObj.features.msgCount = 0;
        }

        // [5] í•µì‹¬: ëª¨ë“  ë°© ìœ ì € ìŠ¤íƒ¯ ì´ˆê¸°í™” (ì§€ëŠ¥í˜• ê¸ˆë¦¬ ì—”ì§„ ì ìš©)
        for (var rName in data.rooms) {
            var roomObj = data.rooms[rName];
            if (!roomObj.features) continue;

            // [ì—°ë™] ì„¹í„° 49ì˜ ì§€ëŠ¥í˜• íƒ„ë ¥ ê¸ˆë¦¬ ìŠ¹ìˆ˜ í˜¸ì¶œ
            var dynMult = 1.0;
            if (typeof util_getDynamicRateMultiplier === 'function') {
                dynMult = util_getDynamicRateMultiplier(rName);
            }

            if (roomObj.features.lotto) {
                roomObj.features.lotto.entries = {}; 
                roomObj.features.lotto.dailyPool = 0;
            }

            for (var id in roomObj.users) {
                var u = roomObj.users[id];

                /* [v11.2] ê´‘ì‚° ì¬ì¤‘ ìœ ì € ê°€ê²°ì‚° (ê¸°ì¡´ ë¡œì§ ì˜¤ë¥˜ ìˆ˜ì •) */
                if (u.mining && u.mining.active === true) {
                    var nowTs = Date.now();
                    var durationMin = Math.floor((nowTs - u.mining.startTime) / 60000);
                    
                    if (durationMin >= 1) {
                        var pol = util_getActivePolicy(roomObj);
        var multiplier = util_getEcoMultiplier(rName) * (pol.mineMult || 1.0);
        var midEarn = Math.floor(durationMin * SYSTEM_CONFIG.ECO.MINE.BASE_PER_MIN * multiplier);
        
        // ì •ì‚°ë¶„ë§Œ í•©ì‚°í•˜ê³  startTimeì€ ìœ ì§€í•˜ì—¬ ì‹œê°„ íë¦„ì„ ë³´ì¡´í•¨
        if (roomObj.features.dailyPools) {
            var accumRate = SYSTEM_CONFIG.ECO.ACTIVITY_ACCUM_RATES.MINE || 0.01;
            roomObj.features.dailyPools.mine += Math.floor(midEarn * accumRate);
        }
        
        Log.info("[Mining Mid-Settlement] " + u.name + "ë‹˜ 00ì‹œ ê°€ê²°ì‚° ì™„ë£Œ (ì‹œê°„ ìœ ì§€)");
                    }
                }

                u.dailyLoanCount = 0; 
                u.dailyGambleCount = 0;
                u.dailyPromotionAttempts = 1; 
                u.dailyStimulusCount = 0; 
                u.dailyCreditRestoreCount = 0;
                u.dailyLadderWins = [];    // ì‚¬ë‹¤ë¦¬ ë‹¹ì¼ ë‹¹ì²¨ ê¸°ë¡ ì´ˆê¸°í™”
                u.dailyBaccaratWins = [];  // ë°”ì¹´ë¼ ë‹¹ì¼ ë‹¹ì²¨ ê¸°ë¡ ì´ˆê¸°í™”
                u.lastCasinoResult = null; // ë©”ë‰´ì˜ ì§ì „ ê²°ê³¼ í‘œì‹œ ì´ˆê¸°í™”
                
                // [ë³´ì•ˆê°•í™”] ì‹œê°„ ë¹„ë¡€ ì ë¦½ ì´ì ì •ì‚° (0ì‹œ ì •ê°)
                var now = Date.now();
                // 0ì‹œ ì •ê°ê¹Œì§€ ë‚¨ì€ ë§ˆì§€ë§‰ ìª¼ê°€ë¦¬ ì´ìê¹Œì§€ í•©ì‚°
                if (u.lastBankUpdateTime > 0 && Number(u.bank) > 0) {
                    var timePassed = now - u.lastBankUpdateTime;
                    var dayMs = 24 * 60 * 60 * 1000;
                    var lastMinuteEarned = Number(u.bank) * SYSTEM_CONFIG.ECO.BANK.INTEREST_RATE * (timePassed / dayMs);
                    u.accruedInterest = (u.accruedInterest || 0) + lastMinuteEarned;
                }

                // ê¸´ê¸‰ ê²½ì œ ì¡°ì¹˜ ë°°ìœ¨ í™•ì¸
                var emergencyMult = util_getEmergencyMultiplier(rName);

                // [ìì‚°ì™•] ì¹­í˜¸ íš¨ê³¼: ì´ì 1.5ë°° ë³´ë„ˆìŠ¤ ì ìš©
                var wealthBonus = (u.title === "ìì‚°ì™•") ? 1.5 : 1.0;
                // ì§€ê¸‰í•  ìµœì¢… ê¸ˆì•¡ (ê¸´ê¸‰ ë°°ìœ¨ ë° ì¹­í˜¸ ë³´ë„ˆìŠ¤ í†µí•© ê³„ì‚°)
                var finalInterest = Math.floor((u.accruedInterest || 0) * emergencyMult * wealthBonus);

                if (finalInterest > 0) {
                    // êµ­ê³  ì§€ë¶ˆ ëŠ¥ë ¥ í™•ì¸ ë° ì§€ê¸‰ ë¡œì§ (ì´í›„ ì¤‘ê´„í˜¸ ë‹«í˜ í™•ì¸ í•„ìˆ˜)
                    if (util_isBankSolvent(rName, finalInterest)) {
                        util_updateBank(u, roomObj, finalInterest, "ì€í–‰ ì˜ˆê¸ˆ ì´ì ì§€ê¸‰", rName);
                        util_updateReserve(roomObj, -finalInterest, "ì€í–‰ ì˜ˆê¸ˆ ì´ì ì§€ê¸‰", rName);

                        // [v11.0] ì¤‘ì•™ì€í–‰ ìµœëŒ€ì£¼ì£¼ ë°°ë‹¹ì„ ìœ„í•œ ì¼ì¼ ë°œìƒ ì´ì ì´ì•¡ ëˆ„ì 
                        // ì„¤ëª…: ìœ ì €ì—ê²Œ ì´ìê°€ ì„±ê³µì ìœ¼ë¡œ ì§€ê¸‰ë  ë•Œë§ˆë‹¤ í•´ë‹¹ ê¸ˆì•¡ì„ ì€í–‰ ìˆ˜ìµ ì¥ë¶€ì— í•©ì‚°í•©ë‹ˆë‹¤.
                        if (roomObj.features.dailyPools) {
                            var accumRate = SYSTEM_CONFIG.ECO.ACTIVITY_ACCUM_RATES.BANK || 0.05;
                            roomObj.features.dailyPools.bank += Math.floor(finalInterest * accumRate);
                        }
                        
                        // [í•µì‹¬] ì§€ê¸‰ì— ì„±ê³µí–ˆì„ ë•Œë§Œ ì´ì ì£¼ë¨¸ë‹ˆë¥¼ 0ìœ¼ë¡œ ì´ˆê¸°í™”
                        u.accruedInterest = 0; 
                    } else {
                        // [í•µì‹¬] ì§€ê¸‰ ì‹¤íŒ¨ ì‹œ u.accruedInterestë¥¼ 0ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì§€ ì•ŠìŒ!
                        // ë°ì´í„°ëŠ” ë³´ì¡´ë˜ë©° ë‚´ì¼ ì •ì‚° ì‹œ ì˜¤ëŠ˜ì¹˜ ì´ìê°€ ë‹¤ì‹œ ë”í•´ì§ (ì´ì›”)
                        Log.info("[Bank Default] " + u.name + "ë‹˜ êµ­ê³  ê³ ê°ˆë¡œ ì´ì ì§€ê¸‰ ë³´ë¥˜ ë° ì´ì›”");
                    }
                }

                u.lastBankUpdateTime = now;
                
                // [ë³´ì•ˆê°•í™”] ì§€ëŠ¥í˜• ì°¨ë“± ëŒ€ì¶œ ì´ì ê°€ì‚° (ì‹ ìš©ë“±ê¸‰ë³„ + íƒ„ë ¥ ìŠ¹ìˆ˜)
                if (u.loan && Number(u.loan.debt) > 0) { 
                    u.creditScore = Math.max(0, Number(u.creditScore) - 5); 
                    
                    // ì‹ ìš©ë“±ê¸‰ ì •ë³´ í˜¸ì¶œ (ì„¹í„° 10 ì—°ë™)
                    var cr = getCreditInfo(u.creditScore);

                    // [ê¸°ë¶€ì™•] ì±„ë¬´ ì´ì ê°ë©´ ë¡œì§
                    var dailyRate = (cr.rate - 1) * dynMult;

                    var dailyInterest = Math.floor(Number(u.loan.debt) * dailyRate);
                    
                    var preDebt = Number(u.loan.debt);
                    var expectedDebt = preDebt + dailyInterest;
                    u.loan.debt = expectedDebt;
                    
                    if (isNaN(u.loan.debt) || u.loan.debt !== expectedDebt) {
                        u.loan.debt = preDebt;
                        Log.error("[System] " + u.name + " ëŒ€ì¶œ ì´ì ì—°ì‚° ì˜¤ë¥˜ ì°¨ë‹¨ ë° ë³µêµ¬");
                    }

                    if (typeof checkAndHandleDefaulter === 'function') checkAndHandleDefaulter(u, rName); 
                }
            }

            // [ìˆ˜ì •] 6ëŒ€ ëœë“œë§ˆí¬ 24ì‹œê°„ í™•ì • ë°°ë‹¹ ì •ì‚° ë° ê¸°ë¶€ì™• ì„¸ê¸ˆ ê°ë©´ ë³´ê³  ë¡œì§
            if (ecoCfg && ecoCfg.HOURLY_DIVIDEND) {
                var targetNames = ["ê´‘ì‚°", "ë‚šì‹œí„°", "ì¹´ì§€ë…¸", "ì¤‘ì•™ì€í–‰", "ë°±í™”ì ", "ê²½ë§ˆì¥"];
                var baseDailyPayout = ecoCfg.HOURLY_DIVIDEND * 24; 

                targetNames.forEach(function(landName) {
                    var owner = util_getMajorityOwner(roomObj, landName);
                    
                    if (owner && owner.data) {
                        var threshold = ecoCfg.BONUS_THRESHOLD || 10;
                        var bonusRate = ecoCfg.BONUS_RATE || 0.1;
                        var shareMult = owner.qty > threshold ? 1.0 + (owner.qty - threshold) * bonusRate : 1.0;
                        
                        var finalDividend = Math.floor(baseDailyPayout * shareMult);
                        
                        if (owner.data.title === "ê°“ë¬¼ì£¼") finalDividend = Math.floor(finalDividend * 1.1);

                        if (finalDividend > 0) {
                            // [ì§€ëŠ¥í˜• ì°¨ë“± ì„¸ê¸ˆ ê³„ì‚°] ì„¹í„° 11 ì—”ì§„ í˜¸ì¶œ (ê¸°ë¶€ì™• 50% ê°ë©´ ìë™ í¬í•¨)
                            var taxInfo = util_applyIncomeTax(owner.data, finalDividend, rName);

                            util_updatePoint(owner.data, roomObj, taxInfo.netIncome, "ëœë“œë§ˆí¬ ì¼ì¼ í™•ì • ë°°ë‹¹: " + landName, rName);
                            util_updateReserve(roomObj, taxInfo.taxAmount, "ëœë“œë§ˆí¬ ë°°ë‹¹ ì†Œë“ì„¸ ì§•ìˆ˜", rName);

                            // [UI ê°œì„ ] ê¸°ë¶€ì™• ì¹­í˜¸ ë³´ìœ  ì‹œ ê°ë©´ ì•ˆë‚´ ë¬¸êµ¬ ì¶”ê°€
                            var taxBenefitTag = (owner.data.title === "ê¸°ë¶€ì™•") ? " [ê¸°ë¶€ì™• í˜œíƒ ì ìš©]" : "";

                            divReport.push("â€¢ " + landName + ": " + owner.data.name + " (+" + fp(finalDividend) + "P)\n" +
                                           "â”” âš–ï¸ ì„¸ê¸ˆ(" + taxInfo.ratePct + "%): -" + fp(taxInfo.taxAmount) + "P" + taxBenefitTag + "\n" +
                                           "â”” ğŸ’° ìµœì¢… ì§€ê¸‰: +" + fp(taxInfo.netIncome) + "P");
                        }
                    }
                });

                // ì£¼ë¨¸ë‹ˆ ì´ˆê¸°í™” ë¡œì§ (í™œë™ ì ë¦½ ë°©ì‹ì€ íê¸°í–ˆìœ¼ë‚˜, ë°ì´í„° ì •ë¦¬ë¥¼ ìœ„í•´ ì´ˆê¸°í™” ìœ ì§€)
                if (roomObj.features.dailyPools) {
                    var pools = roomObj.features.dailyPools;
                    for (var key in pools) { pools[key] = 0; }
                }

                // ë°°ë‹¹ ê²°ê³¼ ë°œí‘œ
                if (divReport.length > 0) {
                    var msg = "ğŸŒ™ [ë‚´ë¦¬ë‹¤ ê²½ì œ ìœ„ì›íšŒ: ì¼ì¼ í™•ì • ë°°ë‹¹ ë³´ê³ ]\n" +
                              "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                              "ê¸ˆì¼ 24ì‹œê°„ ë™ì•ˆ ê±´ë¬¼ì„ ë³´ìœ í•˜ì‹ \n" +
                              "ê° êµ¬ì—­ ìµœëŒ€ì£¼ì£¼ë¶„ë“¤ê»˜ ë°°ë‹¹ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.\n\n" +
                              divReport.join("\n") + "\n" +
                              "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                              "ğŸ’¡ ì‹œê°„ë‹¹ " + fp(ecoCfg.HOURLY_DIVIDEND) + "Pê°€ ì•ˆì •ì ìœ¼ë¡œ ì ë¦½ë©ë‹ˆë‹¤.";
                    Api.replyRoom(rName, msg);
                }
            }

            try {
                // ìì • ì •ì‚° ì‹œ ë³´ê´€ìš© ë¡œê·¸ì™€ ë³µêµ¬ìš© ë¡œê·¸ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì—¬ ìƒˆë‚ ì„ ì¤€ë¹„í•©ë‹ˆë‹¤.
                var jFile = new java.io.File(JOURNAL_PATH);
                if (jFile.exists()) jFile.delete();
                
                var hFile = new java.io.File(BASE_DIR + "total_history.log");
                if (hFile.exists()) hFile.delete();
                Log.info("[System] ì¼ì¼ ë¡œê·¸ ì´ˆê¸°í™” ì™„ë£Œ.");
            } catch(e) { Log.error("Log Rotation Error: " + e); }

            try { 
                Api.replyRoom(rName, formatAdmin("ğŸ« ë¡œë˜ íŒë§¤ ì‹œì‘", "ìƒˆë¡œìš´ ë¡œë˜ íŒë§¤ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.\në§¤ì¼ ë°¤ 22ì‹œ ì¶”ì²¨!")); 
            } catch(e) {}
        }

        // [6] ì‹œì¦Œ ë¦¬ì…‹ ì²˜ë¦¬ (ë§¤ì›” 1ì¼)
        if (ctx.now.getDate() === 1 && data.lastSeasonReset !== ctx.season) {
            data.lastSeasonReset = ctx.season;
            for (var r in data.rooms) { 
                for (var id in data.rooms[r].users) { 
                    var u = data.rooms[r].users[id];
                    u.tier = 0;
                    u.gameAuthCount = 0; 
                    u.purchasedAuthCount = 0; 
                    u.purchasedPromotionAttempts = 0;
                } 
            }
            try { 
                Api.replyRoom(ctx.targetRoom, formatAdmin("ğŸ† ì‹œì¦Œ ë¦¬ì…‹", "ìƒˆë¡œìš´ ì‹œì¦Œì´ ì‹œì‘ë˜ì–´ ëª¨ë“  í‹°ì–´ ë° ê²Œì„ ì¸ì¦ ê¸°ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.")); 
            } catch(e) {}
        }

        // [ìµœì¢…] ëª¨ë“  ë¡œì§ ìˆ˜í–‰ í›„ ë‚ ì§œ ê°±ì‹  (ê°€ì¥ ë§ˆì§€ë§‰ì— ìˆ˜í–‰í•´ì•¼ í•¨)
        data.lastDailyReset = ctx.today; 
        ctx.isUpdated = true;
        util_stamp("dailyReset");
    } // _runSector17Logic í•¨ìˆ˜ë¥¼ ë‹«ëŠ” ê´„í˜¸

//==========ì„¹í„°18==========

/**
 * ì„¹í„° 18 ë¡œì§ í•¨ìˆ˜: ë¡œë˜ íŒë§¤ ë§ˆê° ì•Œë¦¼ ë° ë‹¹ì²¨ ì¶”ì²¨ í”„ë¡œì„¸ìŠ¤
 * ìˆ˜ì • ì‚¬í•­: ë°©ë³„ ê²©ë¦¬ëœ ë¡œë˜ ë°ì´í„°(Features) í†µí•© ì¶”ì²¨ ë° ìƒê¸ˆ ì§€ê¸‰
 */
function _runSector18Logic(data, ctx) {
    var currentHour = ctx.now.getHours();
    var currentMin = ctx.now.getMinutes();
    
    // ì¤‘ì•™ì€í–‰ ì¬ì› ì°¸ì¡° (ë©”ì¸ ìš´ì˜ ë°© ê¸°ì¤€)
    var mainRoomData = data.rooms[ctx.targetRoom]; 

    /* 7. ë¡œë˜ íŒë§¤ ë§ˆê° ì•Œë¦¼ (21:00) */
    if (currentHour === 21) {
        if (!data.lotto_flags) data.lotto_flags = {};
        if (data.lotto_flags.lastCloseNotify !== ctx.today) {
            data.lotto_flags.lastCloseNotify = ctx.today;

            // [í•µì‹¬] ëª¨ë“  ë°©ì˜ íŒë§¤ê¸ˆ(dailyPool)ì„ í•©ì‚°í•˜ì—¬ ì´ì•¡ ê³„ì‚°
            var totalDailyPool = 0;
            for (var r in data.rooms) {
                if (data.rooms[r].features && data.rooms[r].features.lotto) {
                    totalDailyPool += Number(data.rooms[r].features.lotto.dailyPool || 0);
                }
            }
            var totalJackpot = Number(data.lotto_jackpot_pool || 0); 
            var displayPool = totalDailyPool + totalJackpot;

            // ëª¨ë“  ë°©ì— ë§ˆê° ì•Œë¦¼ ì „ì†¡ (ê²©ë¦¬ ë°œì†¡)
            try { 
                Api.replyRoom(ctx.targetRoom, formatAdmin("ğŸ ë¡œë˜ íŒë§¤ ë§ˆê°", "ì ì‹œ í›„ 22ì‹œ ì¶”ì²¨!\ní˜„ì¬ ëˆ„ì  ìƒê¸ˆ: " + fp(displayPool) + "P")); 
            } catch(e) {}
            
            ctx.isUpdated = true;
        }
    }

    /* 8. ë¡œë˜ ë‹¹ì²¨ ë²ˆí˜¸ ì¶”ì²¨ ë° ìƒê¸ˆ ì§€ê¸‰ (22:00) */
    if (currentHour === 22) {
        if (!data.lotto_flags) data.lotto_flags = {};
        if (data.lotto_flags.lastDrawNotify !== ctx.today) {
            data.lotto_flags.lastDrawNotify = ctx.today;
            
            // ë‹¹ì²¨ ë²ˆí˜¸ ìƒì„±
            var win = []; 
            while(win.length < 3) { 
                var n = Math.floor(Math.random() * 15) + 1; 
                if(win.indexOf(n) === -1) win.push(n); 
            }
            win.sort(function(a,b){return a-b}); 
            data.last_win_nums = win; 

            var totalDailyPool = 0;
            var w1 = [], w2 = [], w3 = [];
            var fails = []; // ë‚™ì²¨ì ìˆ˜ì§‘ìš© ë°°ì—´ ì„ ì–¸

            // [í•µì‹¬] ëª¨ë“  ë°©ì„ ëŒë©° ë…ë¦½ëœ ì‘ëª¨ ë‚´ì—­(entries) ìˆ˜ì§‘ ë° ë‹¹ì²¨ì ë¶„ë¥˜
            for (var rName in data.rooms) {
                var roomObj = data.rooms[rName];
                if (!roomObj.features || !roomObj.features.lotto) continue;
                
                var rLotto = roomObj.features.lotto;
                totalDailyPool += Number(rLotto.dailyPool || 0);

                for (var uid in rLotto.entries) {
                    var userFound = roomObj.users[uid];
                    if (!userFound) {
                        delete rLotto.entries[uid];
                        continue;
                    }
                    rLotto.entries[uid].forEach(function(tk) {
                        var match = 0; 
                        tk.forEach(function(n){ if(win.indexOf(n) !== -1) match++; });
                        if(match === 3) w1.push({u: userFound, id: uid, rm: rName}); 
                        else if(match === 2) w2.push({u: userFound, id: uid, rm: rName}); 
                        else if(match === 1) w3.push({u: userFound, id: uid, rm: rName});

                        else fails.push({u: userFound, id: uid, rm: rName}); // ë‚™ì²¨ì ìˆ˜ì§‘ ì¶”ê°€

                    });
                }
                // ì •ì‚° í›„ í•´ë‹¹ ë°©ì˜ íŒëˆ ì´ˆê¸°í™”
                rLotto.dailyPool = 0;
            }

            var baseJackpot = Number(data.lotto_jackpot_pool || 0);
            var totalPrizePool = totalDailyPool + baseJackpot;
            var totalPayout = 0;
            var resM = "ë‹¹ì²¨ ë²ˆí˜¸: [" + win.join(", ") + "]\n";

            // 1ë“± ì§€ê¸‰ (ì „ì•¡ në¹µ)
            if(w1.length > 0) { 
                var p1 = Math.floor(totalPrizePool / w1.length); 
                w1.forEach(function(obj){
                    // ë¶€ë™ì‚° ìì‚°ì´ í¬í•¨ëœ ê²½ì œ ì§€í‘œ ê¸°ì¤€ìœ¼ë¡œ ì§€ê¸‰ ëŠ¥ë ¥ ì²´í¬
                    if (!util_isBankSolvent(obj.rm, p1)) {
                        try { Api.replyRoom(obj.rm, "ğŸš¨ [êµ­ê³  ë¶€ë„] ë¡œë˜ ìƒê¸ˆ ì§€ê¸‰ ëŠ¥ë ¥ì´ ë¶€ì¡±í•˜ì—¬ ì´ì›” ì²˜ë¦¬ë©ë‹ˆë‹¤."); } catch(e){}
                        return;
                    }
                    var res = processRepayment(obj.u, p1, obj.id, obj.rm);
                    util_updatePoint(obj.u, data.rooms[obj.rm], Number(res.actualGain), "ë¡œë˜ 1ë“± ë‹¹ì²¨", obj.rm);
                    totalPayout += p1;
                }); 
                resM += "ğŸ¥‡ 1ë“±: " + w1.length + "ëª… (ê° " + fp(p1) + "P)\n"; 
                data.lotto_jackpot_pool = 0; 
            } else {
                resM += "ğŸ¥‡ 1ë“± ì—†ìŒ (ì „ì•¡ ì´ì›”)\n"; 
                data.lotto_jackpot_pool = totalPrizePool; 
            }

            // 2ë“±/3ë“± ì§€ê¸‰ (ê³ ì • ìƒê¸ˆ)
            w2.forEach(function(obj){ 
                var res = processRepayment(obj.u, 50000, obj.id, obj.rm);
                util_updatePoint(obj.u, data.rooms[obj.rm], Number(res.actualGain), "ë¡œë˜ 2ë“± ë‹¹ì²¨", obj.rm);
                totalPayout += 50000;
            }); 
            if(w2.length > 0) resM += "ğŸ¥ˆ 2ë“±: " + w2.length + "ëª… (ê° 5,0000P)\n";

            w3.forEach(function(obj){ 
                var res = processRepayment(obj.u, 10000, obj.id, obj.rm);
                util_updatePoint(obj.u, data.rooms[obj.rm], Number(res.actualGain), "ë¡œë˜ 3ë“± ë‹¹ì²¨", obj.rm);
                totalPayout += 10000;
            }); 
            if(w3.length > 0) resM += "ğŸ¥‰ 3ë“±: " + w3.length + "ëª… (ê° 1,0000P)";

            // êµ­ê³ (ì¤‘ì•™ì€í–‰) ì¬ì› ì •ì‚°
                if (totalPayout > 0) {
                resM += "\n\nğŸ¦ ìƒê¸ˆ ì´ì•¡ " + fp(totalPayout) + "P êµ­ê³  ì§€ê¸‰ ì™„ë£Œ";
            }

            fails.forEach(function(obj) {
                if (Math.random() < 0.2) { // 20% í™•ë¥ 
                    obj.u.lottoFailCount = (obj.u.lottoFailCount || 0) + 1;
                    var failMsg = "\n\n ğŸ“© ìœ ì €ë‹˜ ë‚™ì²¨ë˜ì—ˆì§€ë§Œ 'ìœ„ë¡œì˜í¸ì§€'ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤.\n";
                    
                    if (obj.u.lottoFailCount >= 15) {
                        obj.u.lottoFailCount = 0;
                        obj.u.luckyCharmEnd = Date.now() + (3600000); // 1ì‹œê°„
                        obj.u.inventory.push({ id: 888, name: "í–‰ìš´ì˜ë¶€ì ", icon: "ğŸ”®", effect: "item", title: "í–‰ìš´ì˜ë¶€ì " });
                        failMsg += "âœ‰ï¸ í¸ì§€ 15ì¥ì´ ëª¨ì—¬ [í–‰ìš´ì˜ë¶€ì ]ìœ¼ë¡œ ë³€í–ˆìŠµë‹ˆë‹¤! âœ¨\nâ³ 1ì‹œê°„ ë™ì•ˆ í™€ì§ ìŠ¹ë¥  +3%ê°€ ìë™ ì ìš©ë©ë‹ˆë‹¤.";
                    } else {
                        failMsg += "í˜„ì¬ ìˆ˜ì§‘: " + obj.u.lottoFailCount + " / 15";
                    }
                    try { Api.replyRoom(obj.rm, "ğŸ’€ ë‚™ì²¨ ì•Œë¦¼\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + obj.u.name + "ë‹˜" + failMsg); } catch(e) {}
                }
            });

            // ëª¨ë“  ë°©ì— ê²°ê³¼ ë°œí‘œ
            try {
                java.lang.Thread.sleep(200); 
                Api.replyRoom(ctx.targetRoom, formatAdmin("ğŸ° ë¡œë˜ ì¶”ì²¨ ê²°ê³¼", resM));
            } catch(e) {}
            util_stamp("lottoLogic");
            ctx.isUpdated = true;
        }
    }
}

//==========ì„¹í„°19==========

/* ë©”ì¸ ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆ í•¨ìˆ˜ (ìˆ˜ì‹  ë¬´ê²°ì„± ì§„ë‹¨ ë²„ì „) */
action = function(room, msg, sender, isGroupChat, replier, imageDB) {
    _perfStartTime = java.lang.System.currentTimeMillis();
    _msgReceiveTime = Date.now();
    
    // [Step 1] ë³‘ë ¬ ìˆ˜ì‹  ì—”ì§„ ê°€ë™
    ParallelPool.execute(new java.lang.Runnable({
        run: function() {
            var realRoom = room ? room.trim() : ""; 
            var roomName = (realRoom === "ë² ë¦­ë°©") ? "ë‚´ë¦¬ë‹¤" : realRoom;
            var cleanSender = sender ? String(sender).trim() : ""; 

            // [ìˆ˜ì •] í—ˆìš©ëœ ë‹¨ì²´ë°©ì´ ì•„ë‹ˆë”ë¼ë„, 1:1 ì±„íŒ…ë°©(isGroupChatì´ false)ì´ë©´ í†µê³¼ì‹œí‚µë‹ˆë‹¤.
            if (ALLOWED_ROOMS.indexOf(realRoom) === -1 && isGroupChat === true) return;
            if (cleanSender === "ì˜¤í”ˆì±„íŒ…ë´‡") return;

            // [Step 2] ìˆœì°¨ ì²˜ë¦¬ ì—”ì§„ ê°€ë™
            LogicQueue.execute(new java.lang.Runnable({
                run: function() {
                    lock.lock(); 
                    try { 
                        var data = getDatabase(); 
                        if (!data) return;

                        var cacheKey = "GLOBAL_" + cleanSender;


                        // 1. ì‹ë³„ì ì´ˆê¸°í™”
                        var targetUid = null;
                        var isSynced = false;

                        // 2. [ê°•ë ¥ ë™ê¸°í™”] 1:1 ë°©ì¼ ê²½ìš° "ë‚´ë¦¬ë‹¤" ë°©ì˜ UIDë¡œ ê°•ì œ ì „í™˜ ë° ìœ ë ¹ ë°ì´í„° ì œê±°
                        if (ALLOWED_ROOMS.indexOf(realRoom) === -1) {
                            var mainBase = data.rooms["ë‚´ë¦¬ë‹¤"];
                            var currentRoomUsers = data.rooms[roomName] ? data.rooms[roomName].users : {};
                            
                            if (mainBase && mainBase.users) {
                                for (var mId in mainBase.users) {
                                    if (mainBase.users[mId].name.trim() === cleanSender.trim()) {
                                        targetUid = mId; // ë©”ì¸ ë°© UIDë¥¼ í˜„ì¬ ì‹ë³„ê°’ìœ¼ë¡œ ê°•ì œ ì„¤ì •
                                        globalData.nameToIdCache[cacheKey] = targetUid; // ìºì‹œ ê°•ì œ ê°±ì‹ 
                                        isSynced = true; 

                                        /* [ë°ì´í„° ì •í™”] 1:1ë°©ì— ì˜ëª» ìƒì„±ëœ ê°€ì§œ UID ìœ ì €ê°€ ìˆë‹¤ë©´ ì¦‰ì‹œ ì‚­ì œ */
                                        for (var localId in currentRoomUsers) {
                                            if (localId !== targetUid && currentRoomUsers[localId].name === cleanSender) {
                                                delete data.rooms[roomName].users[localId];
                                                Log.info("[ì •í™”] " + cleanSender + "ë‹˜ì˜ ìœ ë ¹ ë°ì´í„°(" + localId + ")ë¥¼ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.");
                                            }
                                        }
                                        break;
                                    }
                                }
                            }
                        }

                        // 3. ë™ê¸°í™” ëŒ€ìƒì´ ì•„ë‹ ë•Œë§Œ ê¸°ì¡´ ìºì‹œ ì°¸ì¡°
                        if (!isSynced) targetUid = globalData.nameToIdCache[cacheKey];

                        // 4. [í•µì‹¬ êµì •] ë™ê¸°í™” ì„±ê³µ ì‹œ 1:1ë°© ì „ìš© UID ìƒì„±ì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ì •ë°€ ë£¨í”„ ê±´ë„ˆëœ€
                        var needsSearch = !targetUid || (targetUid && !isSynced && (!data.rooms[roomName] || !data.rooms[roomName].users[targetUid]));

                        if (needsSearch) {
                            var hashMatchId = null;
                            var currentImgHash = null;
                            try { if (imageDB) currentImgHash = imageDB.getProfileHash(); } catch(e) {}

                            for (var id in (data.rooms[roomName] ? data.rooms[roomName].users : {})) {
                                var u = data.rooms[roomName].users[id];
                                if (u.name === cleanSender) { targetUid = id; break; }
                                if (currentImgHash && u.imageHash === currentImgHash) { hashMatchId = id; }
                            }

                            /* [ë³´ì •] 1:1ë°© ìˆ«ì í•¸ë“¤ëŸ¬ ì‘ë™ì„ ìœ„í•œ ì„ ì œì  UID ë™ê¸°í™” */
                        if (ALLOWED_ROOMS.indexOf(realRoom) === -1) {
                            var bridge = data.rooms["ë‚´ë¦¬ë‹¤"];
                            if (bridge && bridge.users) {
                                for (var bUid in bridge.users) {
                                    if (bridge.users[bUid].name.trim() === cleanSender.trim()) {
                                        targetUid = bUid; 
                                        break;
                                    }
                                }
                            }
                        }

                            // [AIS] ë‹‰ë„¤ì„ ë³€ê²½ ê°ì§€ ì‹œ ì¦‰ì‹œ ì´ë¦„ ì—…ë°ì´íŠ¸ ë° ë™ê¸°í™”
                            if (!targetUid && hashMatchId) {
                                targetUid = hashMatchId;
                                var u = data.rooms[roomName].users[targetUid];
                                if (typeof util_syncIdentityGlobal === 'function') util_syncIdentityGlobal(targetUid, u.name, cleanSender);
                                u.name = cleanSender;
                                globalData.nameToIdCache[cacheKey] = targetUid;
                            }
                        }

                        /* [í•µì‹¬ ê°€ë“œ] ì´ì œ ì‹ë³„ëœ targetUidë¡œ ê´€ë¦¬ì ì—¬ë¶€ë¥¼ ì •í™•íˆ íŒë³„í•©ë‹ˆë‹¤. */
                        if (data.botActive === false && !isAdmin(cleanSender, data, targetUid)) {
                            return; 
                        }

                        if (!data.rooms[roomName]) data.rooms[roomName] = { users: {} };
                        var roomData = data.rooms[roomName];
                        
                        if (!roomData.features) {
                            if (typeof ROOM_FEATURE_TEMPLATE === 'function') {
                                roomData.features = ROOM_FEATURE_TEMPLATE();
                            }
                        }

                // [2ë²ˆ] ì‹¤ì‹œê°„ í•˜ì´í”„(ì±„íŒ…ëŸ‰) ê¸°ë¡
                roomData.features.msgCount = (roomData.features.msgCount || 0) + 1;

               /* [ì•ˆì „ íŒ¨ì¹˜] í…œí”Œë¦¿ êµ¬ì¡° ë³€ê²½ ì‹œ ì‹¤ì‹œê°„ ë°˜ì˜ (ëˆ„ë½ ë°ì´í„° ìë™ ìƒì„±) */

                // [v11.0] 6ëŒ€ ëœë“œë§ˆí¬ ì¼ì¼ ë°°ë‹¹ê¸ˆ ëˆ„ì  ì£¼ë¨¸ë‹ˆ ìë™ ë³µêµ¬ ë¡œì§ (Healer)
                // ì„¤ëª…: ê¸°ì¡´ ë°© ë°ì´í„°ì— ì£¼ë¨¸ë‹ˆê°€ ì—†ëŠ” ê²½ìš°, ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•´ ì¦‰ì‹œ ìƒì„±í•©ë‹ˆë‹¤.
                if (!roomData.features.dailyPools) {
                    roomData.features.dailyPools = { 
                        mine: 0, fish: 0, casino: 0, bank: 0, shop: 0, race: 0 
                    };
                }

                // ì„¤ëª…: ì„¹í„° 1ì˜ í…œí”Œë¦¿ì— ìƒˆë¡œìš´ ê¸°ëŠ¥ì´ ì¶”ê°€ë˜ë©´, ê¸°ì¡´ ë°©ì—ë„ ì¦‰ì‹œ í•´ë‹¹ ê³µê°„ì„ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.
                if (typeof ROOM_FEATURE_TEMPLATE === 'function') {
                    var template = ROOM_FEATURE_TEMPLATE();
                    // 1. ë©”ì¸ ê¸°ëŠ¥ í‚¤ ëˆ„ë½ ì²´í¬ (racing, lotto ë“±)
                    for (var key in template) {
                        if (!roomData.features[key]) {
                            roomData.features[key] = template[key];
                        }
                    }
                    // 2. States ë‚´ë¶€ ëˆ„ë½ ì²´í¬ (menuWait, bankProcess ë“±)
                    if (!roomData.features.states) {
                        roomData.features.states = template.states;
                    } else {
                        for (var skey in template.states) {
                            if (!roomData.features.states[skey]) {
                                roomData.features.states[skey] = {};
                            }
                        }
                    }
                }
                
                var rFeatures = roomData.features;

                if (!rFeatures.states) rFeatures.states = { 
                    menuWait: {}, bankProcess: {}, selectWait: {}, lottoPurchase: {},
                    activeThefts: {}, duelData: {}, mining: {}, loanRegister: {}, loanContractWait: {} 
                };

                /* [ë§ˆì´ê·¸ë ˆì´ì…˜] ê¸°ì¡´ ì „ì—­ ë°ì´í„°ë¥¼ í˜„ì¬ ë°©ìœ¼ë¡œ ì´ì‚¬ (ìµœì´ˆ 1íšŒ) */
                if (data.lotto && !rFeatures.lotto.round) {
                    rFeatures.lotto = data.lotto;
                }

                // [Gemini ìš”ì²­ ì‚¬í•­] ë°ì´í„° ì°¸ì¡° ì§€ì—­í™” (Thread-Safe)
                if (rFeatures && rFeatures.states) {
                    var racingData = rFeatures.racing;
                    var lotto = rFeatures.lotto;
                    var feverData = rFeatures.feverData;
                    var sprinkleData = rFeatures.sprinkleData;

                    var menuWaitState = rFeatures.states.menuWait; 
                    var bankProcessState = rFeatures.states.bankProcess;
                    var selectWaitState = rFeatures.states.selectWait;
                    var lottoPurchaseState = rFeatures.states.lottoPurchase;
                    var activeThefts = rFeatures.states.activeThefts;
                    var duelData = rFeatures.states.duelData;
                    var miningState = rFeatures.states.mining;
                    var loanRegisterState = rFeatures.states.loanRegister;
                    var loanContractWaitState = rFeatures.states.loanContractWait;
                }

                // [ê²°íˆ¬ ë¡œì§ ìš°ì„ ìˆœìœ„ ê°€ë“œ]
                // ìˆ˜ë½, ê±°ì ˆ, ì·¨ì†Œ í‚¤ì›Œë“œ ì…ë ¥ ì‹œ ë‹¤ë¥¸ ëŒ€ê¸° ìƒíƒœê°€ ê°„ì„­í•˜ì§€ ëª»í•˜ë„ë¡ ê²°íˆ¬ ë°ì´í„°ë¥¼ ìµœìš°ì„  íƒìƒ‰í•©ë‹ˆë‹¤.
                var SYSTEM_KEYWORDS = ["ì¤ê¸°", "ìˆ˜ë½", "ê±°ì ˆ", "ì·¨ì†Œ", "ì¡ì•˜ë‹¤ìš”ë†ˆ", "ë°°íŒ…ì·¨ì†Œ"];
                var isSystemMsg = msg.startsWith("/") || SYSTEM_KEYWORDS.indexOf(msg) !== -1;

                /* [ì‹ ê·œ] ë„ë°° ë°©ì§€ ë° íƒ€ì„ì•„ì›ƒ ì²´í¬ ì—”ì§„ */
                var user = null;
                var currentImgHash = null;
                try { if (imageDB) currentImgHash = imageDB.getProfileHash(); } catch(e) {}

                // [v6.7 í†µí•©] ìœ ì € ê°ì²´ ë° UID ë™ì‹œ íƒìƒ‰ ì—”ì§„
                for (var id in roomData.users) {
                    var u = roomData.users[id];
                    // í•´ì‹œê°’(í”„ì‚¬) ë˜ëŠ” ë‹‰ë„¤ì„ì´ ì¼ì¹˜í•˜ëŠ”ì§€ ê²€ì‚¬
                    if ((currentImgHash && u.imageHash === currentImgHash) || u.name === cleanSender) {
                        user = u;
                        targetUid = id; // ì°¾ì€ ìœ ì €ì˜ ê³ ìœ  ì½”ë“œ(ID)ë¥¼ ì¦‰ì‹œ ë°”ì¸ë”©
                        break;
                    }
                }

               // 1:1 ì±„íŒ…ë°©ì¼ ê²½ìš°, ì‹œìŠ¤í…œì´ ì°¸ì¡°í•˜ëŠ” 'ë°© ë°ì´í„°(roomData)' ìì²´ë¥¼ ë©”ì¸ë°©ìœ¼ë¡œ ë°”ê¿”ì¹˜ê¸°í•©ë‹ˆë‹¤.
                // íŠ¹ì • ë°© ì´ë¦„ì„ ì§€ì •í•˜ì§€ ì•Šê³ , DBì— ìˆëŠ” ëª¨ë“  ë°©ì„ ë’¤ì ¸ì„œ ê°€ì¥ ë¶€ìì¸ ê³„ì •ì„ ì°¾ì•„ëƒ…ë‹ˆë‹¤.
                if (ALLOWED_ROOMS.indexOf(realRoom) === -1) {
                    var bestMatchUser = null;
                    var bestMatchUid = null;
                    var bestMatchRoomData = null;
                    var maxPoints = -1;

                    // 1. DBì— ì¡´ì¬í•˜ëŠ” ëª¨ë“  ë°©ì„ ìˆœíšŒ
                    for (var dbRoomName in data.rooms) {
                        // í˜„ì¬ 1:1 ë°©(ìê¸° ìì‹ )ì€ ì œì™¸í•˜ê³  ê²€ìƒ‰
                        if (dbRoomName === realRoom) continue;

                        var rData = data.rooms[dbRoomName];
                        if (!rData || !rData.users) continue;

                        // 2. í•´ë‹¹ ë°©ì˜ ìœ ì € ëª©ë¡ ìŠ¤ìº”
                        for (var mUid in rData.users) {
                            var mUser = rData.users[mUid];
                            
                            // ì´ë¦„ ì¼ì¹˜ í™•ì¸ (ê³µë°± ì œê±° í›„ ë¹„êµ)
                            if (mUser.name.trim() === cleanSender.trim()) {
                                var uPoint = Number(mUser.point || 0);
                                
                                // ë™ëª…ì´ì¸(ë˜ëŠ” ìœ ë ¹ê³„ì •) ì¤‘ í¬ì¸íŠ¸ê°€ ê°€ì¥ ë§ì€ 'ì§„ì§œ'ë¥¼ ì„ íƒ
                                if (uPoint > maxPoints) {
                                    maxPoints = uPoint;
                                    bestMatchUser = mUser;
                                    bestMatchUid = mUid;
                                    bestMatchRoomData = rData;
                                }
                            }
                        }
                    }

                    // 3. ì°¾ì€ 'ì§„ì§œ ê³„ì •'ìœ¼ë¡œ 1:1ë°© ë°ì´í„° ë®ì–´ì“°ê¸°
                    if (bestMatchUser && bestMatchRoomData) {
                        user = bestMatchUser;           // ìœ ì € ê°ì²´ êµì²´
                        targetUid = bestMatchUid;       // UID êµì²´
                        roomData = bestMatchRoomData;   // [í•µì‹¬] ì¥ë¶€ë¥¼ ì°¾ì€ ë°©ì˜ ì¥ë¶€ë¡œ êµì²´
                        
                        // ë¡œê·¸: ì—°ê²°ëœ ë°© ì´ë¦„ì´ ë¬´ì—‡ì¸ì§€ í™•ì¸í•˜ê³  ì‹¶ë‹¤ë©´ ì£¼ì„ í•´ì œ
                        // Log.info("[ì—°ë™ ì„±ê³µ] " + cleanSender + " -> " + bestMatchRoomData.users[bestMatchUid].name);
                    }
                }

                /* [v6.6 ë”¥ í—¬ëŸ¬] íƒ€ì… ê²€ì¦í˜• ìê°€ ì¹˜ìœ  ì—”ì§„ (Deep Healing & Memory Sync) */
                if (user && targetUid) {
                    var isDeepHealed = false;
                    
                    // [êµì •]: ê²Œì´íŠ¸ì›¨ì´ ë° ì €ë„ë§ ì‹ë³„ì„ ìœ„í•œ UID ê°•ì œ ë°”ì¸ë”©
                    if (!user.uid || user.uid !== targetUid) {
                        user.uid = targetUid;
                        isDeepHealed = true;
                    }

                    // [êµì²´] ì „ì—­ í‘œì¤€ ê·œê²© USER_SCHEMAë¥¼ í˜¸ì¶œí•˜ì—¬ ëˆ„ë½ ë°ì´í„° ìˆ˜ë¦¬
                    USER_SCHEMA.forEach(function(item) {
                        var val = user[item.key];
                        
                        // íƒ€ì…ì´ ë§ë‹¤ë©´ ë³´ì¡´
                        if (val !== undefined && val !== null) {
                            if (typeof val === item.type || (item.type === 'array' && Array.isArray(val))) return;
                        }

                        // ìˆ˜ë¦¬: ìˆ«ìëŠ” í˜•ë³€í™˜ ì‹œë„, ê·¸ ì™¸ëŠ” ê¸°ë³¸ê°’ ì£¼ì…
                        if (item.type === 'number' && val !== undefined && !isNaN(Number(val))) {
                            user[item.key] = Number(val);
                        } else {
                            user[item.key] = item.default;
                        }
                        isDeepHealed = true;
                    });

                    // 3. [Sync] ìˆ˜ë¦¬ ë°œìƒ ì‹œ ë¬¼ë¦¬ ì €ì¥ ë° ë©”ëª¨ë¦¬(globalData) ì¦‰ì‹œ ê°±ì‹ 
                    if (isDeepHealed) {
                        Log.info("[Deep-Healer] " + user.name + "ë‹˜ êµ¬ì¡° ìµœì í™” ë° ë™ê¸°í™” ì™„ë£Œ.");
                        safeSaveData(data, false);
                        if (typeof globalData !== 'undefined') globalData = data; 
                    }

                    /**
                     * [ë¬´ì—­ ì‹œìŠ¤í…œ: ë„ì°© ì‹¤ì‹œê°„ íŠ¸ë¦¬ê±°]
                     * ê¸°ëŠ¥: í•­í•´ ì‹œê°„ì´ ê²½ê³¼í•œ í›„ ìœ ì €ê°€ ì±„íŒ…ì„ ì¹˜ë©´ ì¦‰ì‹œ ì •ì‚° ë¡œì§ ì‹¤í–‰
                     */
                    if (user && user.voyage && user.voyage.active === true) {
    var v = user.voyage;
    if (Date.now() >= (v.arrival || 0)) {

        // [ì•ˆì „ì¥ì¹˜] 5ë¶„ ì´ìƒ ì •ì‚°ì´ ì•ˆ ëë‚¬ë‹¤ë©´ ì ê¸ˆ ê°•ì œ í•´ì œ (ìê°€ ì¹˜ìœ )
        if (v.isProcessing === true && (nowTs - (v.lastAttemptTime || 0) > 300000)) {
            v.isProcessing = false;
        }

        // ì •ì‚° ì¤‘ì´ ì•„ë‹ ë•Œë§Œ ì§„ì…
        if (v.isProcessing !== true) {
            v.lastAttemptTime = nowTs; // ì‹œë„ ì‹œê°„ ê¸°ë¡
            if (typeof _processTradeArrival === 'function') {
                user.skipHealing = true;
                _processTradeArrival(user, data, replier, roomName, targetUid);
                // ì •ì‚° í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ ì²˜ë¦¬ê°€ ëë‚œ í›„ activeê°€ falseê°€ ë˜ë¯€ë¡œ ì¤‘ë³µ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ
            }
        }
                    }
                }

                // 4. [Spam Guard] ë„ë°° ë°©ì§€ ë¡œì§ (ë¬´ì—­ ì •ì‚° ì´í›„ì— ì‹¤í–‰)
                var now = Date.now();
                    var conf = SYSTEM_CONFIG.SPAM;
                    if (user.timeoutEndTime && now < user.timeoutEndTime) return;

                    user.chatLog.push(now);
                    user.chatLog = user.chatLog.filter(function(time) { return now - time < conf.LIMIT_WINDOW; });

                    if (user.chatLog.length > conf.LIMIT_COUNT) {
                        user.timeoutEndTime = now + conf.TIMEOUT_MS;
                        user.chatLog = [];
                        var expireTime = new Date(user.timeoutEndTime).toLocaleTimeString();
                        var timeoutMsg = "ğŸ”‡ [ë„ë°° ê°ì§€: ì´ìš© ì œí•œ]\n" +
                                         "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                                         "ëŒ€ìƒ: " + getDisplayName(user) + "ë‹˜\n" +
                                         "ì‚¬ìœ : ë‹¨ì‹œê°„ ê³¼ë„í•œ ì±„íŒ… ë°œì†¡\n" +
                                         "ì œí•œ: " + Math.floor(conf.TIMEOUT_MS / 60000) + "ë¶„ê°„ ë´‡ ì´ìš© ë¶ˆê°€\n" +
                                         "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                                         "ğŸ’¡ í•´ì œ ì‹œê°: " + expireTime;
                        replier.reply(timeoutMsg);
                        safeSaveData(data);
                        return;
                    }
                }

                /* [í•µì‹¬] ë²„ê·¸ ì œë³´ ë° ì§„ì‹¤ íŒë³„ ì‹œìŠ¤í…œ */
                if (msg.startsWith("/ë²„ê·¸ì œë³´ ")) {
                    var content = msg.substring(6).trim();
                    if (content.length < 2) return replier.reply("ë‚´ìš©ì„ ìƒì„¸íˆ ì ì–´ì£¼ì„¸ìš”.");
                    
                    if(user) { 
                        var lastAct = user.lastAction;
                        var timeDiff = lastAct ? (Date.now() - lastAct.time) : 99999999;
                        var diagnosis = "";
                        var isConfirmed = false;

                        if (lastAct && timeDiff < 300000) { 
                            if (lastAct.status === "PENDING") { diagnosis = "âš ï¸ ë¡œì§ ì¤‘ë‹¨ë¨(ì‘ë‹µì—†ìŒ)"; isConfirmed = true; }
                            else if (lastAct.status === "CRASH") { diagnosis = "ğŸš« ì‹œìŠ¤í…œ ì—ëŸ¬(Crash)"; isConfirmed = true; }
                            else if (lastAct.status === "FAIL") { diagnosis = "ğŸ“‰ ë°ì´í„° ë¶ˆì¼ì¹˜(ê³„ì‚°ì˜¤ë¥˜)"; isConfirmed = true; }
                            else if (lastAct.status === "SUCCESS") { 
                                replier.reply("ğŸ¤– [ì‹œìŠ¤í…œ ì§„ë‹¨: ì •ìƒ]\nì§ì „ ì‘ì—…(" + lastAct.cmd + ")ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nì˜¤ë¥˜ê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                                return;
                            }
                        } else { 
                            diagnosis = "â“ ì‹¤í–‰ ê¸°ë¡ ì—†ìŒ(ë¡œì§ ë¯¸ì§„ì…/ì˜¤íƒ€)"; isConfirmed = true; 
                        }

                        var logTime = new Date().toLocaleString();
                        var logTxt = "[" + logTime + "] " + cleanSender + ": " + content + "\n    ã„´ íŒë…: " + diagnosis + "\n";
                        FileStream.append(BUG_LOG_PATH, logTxt);
                        
                        if(isConfirmed) replier.reply("âœ… [ì œë³´ ì ‘ìˆ˜]\níŒë… ê²°ê³¼: " + diagnosis + "\në¶„ì„ ë‚´ìš©ì´ ë²„ê·¸ ë¦¬ìŠ¤íŠ¸ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        else replier.reply("ğŸ“ ì œë³´ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    }
                    return;
                }

                /* ê´€ë¦¬ììš© ì‹œìŠ¤í…œ ì œì–´ */
                if (isAdmin(sender, data)) {
                    if (msg === "/ê°•ì œì¬ê°€ë™") {
                        if (lock.isLocked()) lock.unlock(); 
                        globalData = getDatabase(); 
                        if (globalData) { globalData.botActive = true; safeSaveData(globalData); }
                        replier.reply(formatAdmin("ğŸ”„ ì‹œìŠ¤í…œ ì¬ê°€ë™", "ê²°ê³¼: ë½ í•´ì œ ë° ë©”ëª¨ë¦¬ ë™ê¸°í™” ì™„ë£Œ"));
                        return;
                    }
                }

//==========ì„¹í„°20-1==========

if (!data) return;
var roomData = data.rooms[roomName] || { users: {} };
data.rooms[roomName] = roomData;

// [ìˆ˜ì •] 1:1 ì±„íŒ…ë°© ì „ìš© ë°ì´í„° ë¸Œë¦¿ì§€ ë° ì—°ë™ ì•ˆë‚´ ë©”ì‹œì§€ ì¶”ê°€
if (ALLOWED_ROOMS.indexOf(roomName) === -1) {
    var MAIN_ROOM = "ë‚´ë¦¬ë‹¤";
    var mainData = data.rooms[MAIN_ROOM];
    
    if (mainData && mainData.users) {
        for (var mUid in mainData.users) {
            if (mainData.users[mUid].name.trim() === cleanSender.trim()) {
                targetUid = mUid; 
                user = mainData.users[mUid]; 
                
                if (roomData.users[targetUid]) delete roomData.users[targetUid];
                break;
            }
        }
    }

    // [ì‹ ê·œ] 1:1 ë°© ì…ì¥ ìœ ì € ëŒ€ìƒ ë‹‰ë„¤ì„ ì—°ë™ í•„ìˆ˜ ì•ˆë‚´
    if (user && !user.hasSeenSyncNotice) {
        var syncNotice = "ğŸ”” [ì •ë³´ ì—°ë™ ì•ˆë‚´]\n" +
                         "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                         "1:1 ëŒ€í™”ë°©ì˜ ëª¨ë“  ì •ë³´ëŠ” ë©”ì¸ë°©('ë‚´ë¦¬ë‹¤')ì˜\n" +
                         "ë°ì´í„°ì™€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì—°ë™ë©ë‹ˆë‹¤.\n\n" +
                         "âš ï¸ ì£¼ì˜ì‚¬í•­:\n" +
                         "ë°˜ë“œì‹œ ë©”ì¸ë°©ê³¼ [ë‹‰ë„¤ì„]ì´ ë™ì¼í•´ì•¼ í•˜ë©°,\n" +
                         "ë‹‰ë„¤ì„ ë³€ê²½ ì‹œ ì—°ë™ì´ ëŠê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n" +
                         "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                         "ğŸ’¡ ë™ì¼í•œ ë‹‰ë„¤ì„ ì‚¬ìš© ì‹œ ëª¨ë“  ìì‚°ì´ ê³µìœ ë©ë‹ˆë‹¤.";
        replier.reply(syncNotice);
        user.hasSeenSyncNotice = true; // ì•ˆë‚´ 1íšŒ ì œí•œ
    }

    if (!user) {
        replier.reply("ğŸš« [ë¯¸ê°€ì… ì‚¬ìš©ì]\në‹¨ì²´ë°©('ë‚´ë¦¬ë‹¤')ì— ë¨¼ì € ì ‘ì†í•˜ì—¬ ê³„ì •ì„ ìƒì„±í•´ì•¼ 1:1 ê¸°ëŠ¥ì„ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\nâš ï¸ ì•ˆë‚´: ë©”ì¸ë°©ê³¼ ë‹‰ë„¤ì„ì´ ì¼ì¹˜í•´ì•¼ ì •ë³´ê°€ ì—°ë™ë©ë‹ˆë‹¤.");
        return; 
    }
}

// [2] í˜„ì¬ ì ‘ì†í•œ ë°©(1:1ë°© í¬í•¨)ì˜ ê¸°ëŠ¥ ê°ì²´ê°€ ì—†ìœ¼ë©´ ì¦‰ì‹œ ìƒì„±
if (!roomData.features) {
    roomData.features = (typeof ROOM_FEATURE_TEMPLATE === 'function') ? ROOM_FEATURE_TEMPLATE() : {};
}
// í•˜ìœ„ states êµ¬ì¡°ê°€ ëˆ„ë½ëœ ê²½ìš° ê°•ì œ ë³´ê°•
if (!roomData.features.states) {
    roomData.features.states = { 
        menuWait: {}, bankProcess: {}, selectWait: {}, lottoPurchase: {},
        activeThefts: {}, duelData: {}, mining: {}, loanRegister: {}, loanContractWait: {} 
    };
}

// [3] 1:1ë°©ì´ë¼ë©´ í¬ì¸íŠ¸ ê´€ë¦¬ëŠ” ë©”ì¸ë°©ìœ¼ë¡œ, ì„¸ì…˜ ê´€ë¦¬ëŠ” í˜„ì¬ë°©ìœ¼ë¡œ ë¶„ë¦¬
if (ALLOWED_ROOMS.indexOf(roomName) === -1) {
    var redirectedData = data.rooms["ë‚´ë¦¬ë‹¤"];
    if (redirectedData && redirectedData.users[targetUid]) {
        // user ê°ì²´ëŠ” ë©”ì¸ë°©ì˜ ë°ì´í„°(ëˆ, í…œ ë“±)ë¥¼ ì°¸ì¡°
        user = redirectedData.users[targetUid];
    }
}

// 2. [ì‹ ë¶„ ë³µêµ¬] ì‹ë³„ ì‹¤íŒ¨ ì‹œ ì˜êµ¬ ëª…ë¶€(Registry) ëŒ€ì¡°
var isIdentityRecovered = false;

if (!targetUid) {
    var regKey = roomName + "_" + cleanSender;
    try {
        var regFile = new java.io.File(REGISTRY_PATH);
        if (regFile.exists()) {
            var registry = JSON.parse(FileStream.read(REGISTRY_PATH));
            if (registry[regKey]) {
                targetUid = registry[regKey]; 
                globalData.nameToIdCache[cacheKey] = targetUid; 
                isIdentityRecovered = true;
                Log.info("[Identity Restore] " + cleanSender + "ë‹˜ ì‹ ë¶„ ë³µêµ¬ ì™„ë£Œ.");
            }
        }
    } catch(e) { Log.error("Registry Read Error"); }
}

// 3. [ì‹ ê·œ ìƒì„±] ì§„ì§œ ì‹ ê·œ ìœ ì €ì¼ ê²½ìš°
if (!targetUid) {
    targetUid = generateUUID();
    globalData.nameToIdCache[cacheKey] = targetUid;
    
    try {
        var regKey = roomName + "_" + cleanSender;
        var regFile = new java.io.File(REGISTRY_PATH);
        var registry = regFile.exists() ? JSON.parse(FileStream.read(REGISTRY_PATH)) : {};
        registry[regKey] = targetUid;
        FileStream.write(REGISTRY_PATH, JSON.stringify(registry));
    } catch(e) {}
}

// [C] UIDëŠ” í™•ë³´ë˜ì—ˆìœ¼ë‚˜ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ì´ˆê¸°í™” (1:1 ë°©ì€ ìƒì„± ê¸ˆì§€)
if (ALLOWED_ROOMS.indexOf(roomName) !== -1 && !roomData.users[targetUid]) {
    var newUser = { uid: targetUid, name: cleanSender, imageHash: currentImgHash, lastDate: "" };

    USER_SCHEMA.forEach(function(item) {
        if (typeof item.default === 'object' && item.default !== null) {
            newUser[item.key] = JSON.parse(JSON.stringify(item.default));
        } else {
            newUser[item.key] = item.default;
        }
    });

    roomData.users[targetUid] = newUser;

    if (typeof util_updatePoint === 'function') {
        util_updatePoint(roomData.users[targetUid], roomData, 100000, "ì…ì¥ ì¶•í•˜ ë³´ë„ˆìŠ¤", roomName);
    }
    
    uidCache[cacheKey] = targetUid;
    
    var welcomeTitle = isIdentityRecovered ? "ğŸŠ [" + cleanSender + "]ë‹˜ ì‹ ë¶„ ë³µêµ¬ ì™„ë£Œ!" : "ğŸŠ [" + cleanSender + "]ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!";
    var welcomeSub = isIdentityRecovered ? "ğŸ›¡ï¸ ì˜êµ¬ ëª…ë¶€ì—ì„œ ê³¼ê±° ê³ ìœ  ì½”ë“œë¥¼ ì°¾ì•„ ì—°ê²°í–ˆìŠµë‹ˆë‹¤." : "ğŸ ì…ì¥ ì¶•í•˜ ë³´ë„ˆìŠ¤: " + fP(100000) + "P ì§€ê¸‰!";
    
    // [ë¬¸ë²• ì•ˆì „] ê´„í˜¸ë¡œ ê°ì‹¸ê³  ì„¸ë¯¸ì½œë¡  ëª…ì‹œ
    var welcomeMsg = (welcomeTitle + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                     welcomeSub + "\n" +
                     "ğŸ•¹ï¸ ë¯¸ë‹ˆê²Œì„ ë° ì¶œì„ì²´í¬ ê¸°ëŠ¥ ì œê³µ\n" +
                     "ğŸ’³ ì‹ ìš© ë“±ê¸‰: 4ë“±ê¸‰ (600ì ) ë¶€ì—¬\n\n" + 
                     "ğŸ“– ì´ìš© ì „ ë°˜ë“œì‹œ '/ë„ì›€ë§'ì„ í™•ì¸í•´ì£¼ì„¸ìš”!");
                      
    replier.reply(welcomeMsg); 
    safeSaveData(data);
}

//==========ì„¹í„°20-2==========

/* [ë°ì´í„° & ê°€ë“œ í†µí•© ì—”ì§„] 1:1ë°© ë™ê¸°í™” ë° ìˆ«ì í•¸ë“¤ëŸ¬ í”„ë¦¬íŒ¨ìŠ¤ */
if (ALLOWED_ROOMS.indexOf(realRoom) === -1) {
    // 1. ë°ì´í„° ë³¸ì²´ ì—°ê²°: 1:1ë°©ì€ ë¬´ì¡°ê±´ 'ë‚´ë¦¬ë‹¤' ë°©ì˜ ì§€ê°‘ì„ ì‚¬ìš©
    var mainRoomData = data.rooms["ë‚´ë¦¬ë‹¤"];
    if (mainRoomData && mainRoomData.users[targetUid]) {
        user = mainRoomData.users[targetUid]; 
    } else {
        user = roomData.users[targetUid];
    }

    // 2. í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ë° ìƒíƒœ ê°€ë“œ: 1:1ë°© ì „ìš© ë¡œì§ ì°¨ë‹¨ í•´ì œ
    var isAllowedCmd = (msg.startsWith("/ì¹´ì§€ë…¸") || msg.startsWith("/ë‚´ì •ë³´") || msg.startsWith("/ì€í–‰") || msg.startsWith("/ì—°ë™ì§„ë‹¨") || msg.startsWith("/ë°©ëª©ë¡") || msg.startsWith("/ê´€ë¦¬ì"));
    
    var inState = false;
    // í˜„ì¬ 1:1 ë°©(local)ê³¼ ë©”ì¸ ë°©(main)ì˜ ëª¨ë“  ëŒ€ê¸° ìƒíƒœë¥¼ ì´ì¤‘ ê²€ì‚¬
    var localSt = roomData.features ? roomData.features.states : null;
    var mainSt = (mainRoomData && mainRoomData.features) ? mainRoomData.features.states : null;

    var checkWait = function(st) {
        if (!st) return false;
        return (st.menuWait[targetUid] || st.bankProcess[targetUid] || st.selectWait[targetUid]);
    };

    if (checkWait(localSt) || checkWait(mainSt) || (user && user.blackjackState) || (user && user.voyage && user.voyage.active === true)) {
        inState = true;
    }

    // í—ˆìš©ëœ ëª…ë ¹ì–´ë„ ì•„ë‹ˆê³  ëŒ€ê¸° ìƒíƒœë„ ì•„ë‹ˆë¼ë©´ ë¡œì§ ì¢…ë£Œ (ì¼ë°˜ ì±„íŒ… ë¬´ì‹œ)
    if (!isAllowedCmd && !inState) return;

} else {
    // ë‹¨ì²´ë°©ì¼ ê²½ìš°: ìê¸° ë°© ë°ì´í„°ë¥¼ ë³¸ì²´ë¡œ ì‚¬ìš©
    user = roomData.users[targetUid];
}

/* [v11.0] ì£¼ì‹ -> ëœë“œë§ˆí¬ ë°ì´í„° ìë™ ë§ˆì´ê·¸ë ˆì´ì…˜ */
if (user.landHoldings === undefined) {
    // 1. ê¸°ì¡´ ì£¼ì‹ ë°ì´í„°ë¥¼ ë¶€ë™ì‚° ë°ì´í„°ë¡œ ì•ˆì „í•˜ê²Œ ì´ì „
    user.landHoldings = user.stockHoldings || {};
    user.landAvg = user.stockAvg || {};
    user.totalLandInvest = user.totalInvestAmount || 0;
    user.landDeedCount = user.stockCertCount || 0;
    
    // 2. ì´ì „ ì™„ë£Œ í›„ êµ¬ ë°ì´í„° í•„ë“œ ì‚­ì œ (ë©”ëª¨ë¦¬ ìµœì í™” ë° ì¤‘ë³µ ì´ì „ ë°©ì§€)
    delete user.stockHoldings;
    delete user.stockAvg;
    delete user.totalInvestAmount;
    delete user.stockCertCount;
}

/* ë°ì´í„° êµ¬ì¡° ë³´ì • ë° í•„ìˆ˜ ë³€ìˆ˜ ì´ˆê¸°í™” */
if (!user.inventory) user.inventory = [];
if (user.landDeedCount === undefined) user.landDeedCount = 0;
if (user.totalLandInvest === undefined) user.totalLandInvest = 0;

if (msg === "ì¤ê¸°") {
    var rFeatures = roomData.features;
    if (rFeatures && rFeatures.sprinkleData && rFeatures.sprinkleData.active) {
        if (typeof _gameActionLogic_Part3 === 'function') {
            _gameActionLogic_Part3(msg, user, data, replier, roomName, targetUid);
            return; // ì¤ê¸° ì²˜ë¦¬ ì‹œ ë¡œì§ ì¢…ë£Œí•˜ì—¬ ê°€ë“œ ìš°íšŒ ë° í•˜ë‹¨ ë¡œì§ ì¤‘ë³µ ë°©ì§€
        }
    }
}

/* [ìˆ˜ì •] ë°ì´í„° êµ¬ì¡° ë³´ì • ë° ì´ˆê¸°í™” */
if (!user.inventory) user.inventory = [];
if (user.tierGuard === undefined) user.tierGuard = 0;
if (user.gameAuthCount === undefined) user.gameAuthCount = 0;
if (user.purchasedAuthCount === undefined) user.purchasedAuthCount = 0;

/* [ì‹ ê·œ: Gemini ìš”ì²­ ì‚¬í•­] ê²½ê³ ì‚­ì œê¶Œ êµ¬ë§¤ ì—¬ë¶€ í•„ë“œ ë§ˆì´ê·¸ë ˆì´ì…˜ */
if (user.boughtWarningRemoval === undefined) user.boughtWarningRemoval = false;

/* [ê°œí¸] ëœë¤ë°•ìŠ¤ ì‹œìŠ¤í…œ ê´€ë ¨ ë³€ìˆ˜ ì•ˆì „ ì´ˆê¸°í™” ë° ìë™ ë§ˆì´ê·¸ë ˆì´ì…˜ */
if (user.boxFragments === undefined) user.boxFragments = 0;
if (user.boxTickets === undefined) user.boxTickets = 0;

// 1. ê¸°ë¡ì¥(collectedIcons)ì´ ì—†ìœ¼ë©´ ìƒì„±
if (user.collectedIcons === undefined) {
    user.collectedIcons = [];
}

// 2. [Gemini ìš”ì²­ ì‚¬í•­] ê¸°ì¡´ ë³´ìœ  ì•„ì´ì½˜ ê¸°ë¡ ìë™ ë§ˆì´ê·¸ë ˆì´ì…˜
// ê°€ë°©ì— ìˆëŠ” ì•„ì´ì½˜ë“¤ì„ ì „ìˆ˜ ì¡°ì‚¬í•˜ì—¬ í•œ ë²ˆì´ë¼ë„ ë½‘ì€ ê¸°ë¡ì— ìë™ ë“±ë¡í•©ë‹ˆë‹¤.
if (user.inventory && user.inventory.length > 0) {
    user.inventory.forEach(function(it) {
        if (it.effect === "icon" && user.collectedIcons.indexOf(it.icon) === -1) {
            user.collectedIcons.push(it.icon);
        }
    });
}

/* [í•µì‹¬] ê°•ì œ ì¶”ì‹¬ í”Œë˜ê·¸ ì´ˆê¸°í™” ë° ë³´ì • */
if (user.isTransferred === undefined) user.isTransferred = false;

/* [ê¸°ëŠ¥] ê¸°ì¡´ ì•„ì´ì½˜ ë° ì¹­í˜¸ ê°€ë°© ìë™ ë§ˆì´ê·¸ë ˆì´ì…˜ */
if (user.inventory) {
    // 1. ì•„ì´ì½˜ ë§ˆì´ê·¸ë ˆì´ì…˜
    if (user.icon && user.icon !== "") {
        var hasIconInInv = false;
        for (var j = 0; j < user.inventory.length; j++) {
            if (user.inventory[j].icon === user.icon) { hasIconInInv = true; break; }
        }
        if (!hasIconInInv) {
            for (var k = 0; k < SHOP_ITEMS.length; k++) {
                if (SHOP_ITEMS[k].effect === "icon" && SHOP_ITEMS[k].icon === user.icon) {
                    user.inventory.push({
                        id: SHOP_ITEMS[k].id, name: SHOP_ITEMS[k].name, icon: SHOP_ITEMS[k].icon,
                        effect: "icon", title: ""
                    });
                    // ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œ ê¸°ë¡ì¥ì—ë„ ë™ì‹œ ë“±ë¡
                    if (user.collectedIcons.indexOf(user.icon) === -1) user.collectedIcons.push(user.icon);
                    break;
                }
            }
        }
    }
    
    // 2. ì¹­í˜¸ ë§ˆì´ê·¸ë ˆì´ì…˜ (ëˆ„ë½ë¶„ ì¶”ê°€)
    if (user.title && user.title !== "") {
        var hasTitleInInv = false;
        for (var j = 0; j < user.inventory.length; j++) {
            if (user.inventory[j].title === user.title) { hasTitleInInv = true; break; }
        }
        if (!hasTitleInInv) {
            for (var k = 0; k < SHOP_ITEMS.length; k++) {
                if (SHOP_ITEMS[k].effect === "title" && SHOP_ITEMS[k].title === user.title) {
                    user.inventory.push({
                        id: SHOP_ITEMS[k].id, name: SHOP_ITEMS[k].name, icon: SHOP_ITEMS[k].icon || "",
                        effect: "title", title: SHOP_ITEMS[k].title
                    });
                    break;
                }
            }
        }
    }
}

var today = getSimpleDate();
user.point = Number(user.point || 0);

/* ë¯¼ìƒì§€ì›ê¸ˆ ì¦‰ì‹œ ì²´í¬ */
if (user && user.lastDate !== today) {
    checkEconomicStimulus(user, roomName, false);
}

/* [ì‹ ê·œ] ê¸°ì¡´ ì˜ˆê¸ˆì ì´ì ì—”ì§„ ê°•ì œ í™œì„±í™” */
// ì˜ˆê¸ˆì€ ìˆëŠ”ë° ê¸°ì¤€ ì‹œê°„ì´ 0ì¸ ê²½ìš°, ì§€ê¸ˆ ì´ ìˆœê°„ë¶€í„° ì´ìê°€ ìŒ“ì´ë„ë¡ ê¸°ì¤€ì  ì„¤ì •
if (user.bank > 0 && (!user.lastBankUpdateTime || user.lastBankUpdateTime === 0)) {
    user.lastBankUpdateTime = Date.now();
}

// [ê°ì‹œ ì—”ì§„] 3ë¶„ ë¯¸ì‚¬ìš© ì‹œ ì„¸ì…˜ ìë™ ì´ˆê¸°í™” ë¡œì§
var nowTs = Date.now();
if (user.lastBotUseTime > 0 && (nowTs - user.lastBotUseTime > 180000)) {
    // 3ë¶„(180,000ms) ì´ˆê³¼ ì‹œ ê°ì‹œ ë°ì´í„° ë¦¬ì…‹
    user.casinoAuditStartTime = 0;
    user.casinoAuditStartAssets = 0;
    user.casinoAuditAlertHistory = [];
}
// ëª¨ë“  í™œë™ ì‹œ ë§ˆì§€ë§‰ ë´‡ ì‚¬ìš© ì‹œê°„ ê°±ì‹  (ì„¸ì…˜ ìœ ì§€)
user.lastBotUseTime = nowTs;

util_stagingStart(user); 

// [êµì •] ì„¹í„° 25ì—ì„œ ì‚¬ìš©í•  ëª…ë ¹ì–´ ì²˜ë¦¬ í™•ì¸ ë³€ìˆ˜ë¥¼ ì—¬ê¸°ì„œ ì„ ì–¸í•©ë‹ˆë‹¤.
var isProcessed = false; 

/**
 * [ë…ë¦½í˜• í•¨ìˆ˜] ì¤‘ë³µ ìœ ì € ì„ íƒ ì²˜ë¦¬ ì—”ì§„ (ì „ì—­ ì›ê²© ê´€ì œ v10.5)
 * ì„¤ëª…: ë‹‰ë„¤ì„ ê²€ìƒ‰ ì‹œ ì¤‘ë³µ ë°œìƒ ê±´ì— ëŒ€í•œ ìœ ì €ì˜ ìˆ«ì ì„ íƒì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
 * ë°˜ì˜: ëª¨ë“  ê´€ë¦¬ì ëª…ë ¹ì–´ê°€ ìœ ì €ê°€ ì†í•œ ì‹¤ì œ ë°©(Target Room)ì˜ ë°ì´í„°ë¥¼ ìˆ˜ì •í•˜ë„ë¡ êµì •.
 */
function _handleSelectionLogic(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];
    if (!roomData || !roomData.features || !roomData.features.states.selectWait) return false;

    var selectWaitState = roomData.features.states.selectWait;
    if (!selectWaitState[targetUid]) return false;

    // 1. ì‹œê°„ ì´ˆê³¼ ì²´í¬ (30ì´ˆ)
    if (Date.now() - selectWaitState[targetUid].timestamp > 30000 || msg === "ì·¨ì†Œ") {
        delete selectWaitState[targetUid];
        if (msg === "ì·¨ì†Œ") {
            replier.reply(formatCommand("ğŸš« ì„ íƒ ì·¨ì†Œ", user, "ì‘ì—…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."));
        } else {
            replier.reply(formatError(user, "ì„ íƒ ì‹œê°„ ì´ˆê³¼", "30ì´ˆ ì´ë‚´ì— ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì§€ ì•Šì•„ ë©”ë‰´ê°€ ë‹«í˜”ìŠµë‹ˆë‹¤."));
        }
        return true;
    }

    // 3. ìˆ«ì ì„ íƒ ë° ë¡œì§ ì‹¤í–‰
    var choice = parseInt(msg.replace(/[^0-9]/g, ""));
    if (!isNaN(choice) && choice >= 1 && choice <= selectWaitState[targetUid].results.length) {
        var state = selectWaitState[targetUid];
        var selected = state.results[choice - 1]; // ì„ íƒëœ ê²€ìƒ‰ ê²°ê³¼ (roomName ì •ë³´ í¬í•¨)
        var type = state.type;
        var extra = state.extra;
        var targetUser = selected.data;
        
        // [ì›ê²© ê´€ì œ í•µì‹¬] ìœ ì €ê°€ ì‹¤ì œë¡œ ìƒì£¼í•˜ëŠ” ë°©ì˜ ë°ì´í„°ë¥¼ íƒ€ê²ŸíŒ…
        var targetRoom = selected.roomName || roomName; 
        var targetRoomData = data.rooms[targetRoom];
        
        delete selectWaitState[targetUid]; // ì„ íƒ ì™„ë£Œ ì‹œ ì„¸ì…˜ ì‚­ì œ

        // [ì¶”ê°€] ì¡°ì‘ ì„¤ì •/í•´ì œ ì¤‘ë³µ ìœ ì € ì„ íƒ ì‹œ ì‹¤ì œ ë°ì´í„° ë°˜ì˜ë¶€
           if (type === "admin_manipulate_on") {
            targetUser.isManipulated = true;
            var maniCfg = SYSTEM_CONFIG.MANIPULATION;
            var gRate = (extra && extra.gambleRate) ? extra.gambleRate : maniCfg.DEFAULT_GAMBLE;
            var fLuck = (extra && extra.fishLuck) ? extra.fishLuck : maniCfg.DEFAULT_FISH;
            targetUser.gambleWinRate = Math.min(maniCfg.MAX_RATE, Math.max(maniCfg.MIN_RATE, gRate));
            targetUser.fishLuck = Math.min(maniCfg.MAX_RATE, Math.max(maniCfg.MIN_RATE, fLuck));
            targetUser.skipHealing = true;
            replier.reply(formatAdmin("ğŸ¯ ì¡°ì‘ í™œì„±í™”", "ëŒ€ìƒ: [" + targetRoom + "] " + targetUser.name + "\nğŸ² í™€ì§ ìŠ¹ë¥ : " + targetUser.gambleWinRate + "%\nğŸ£ ë‚šì‹œ ë³´ì •: " + targetUser.fishLuck + "%"));
        }
        else if (type === "admin_manipulate_off") {
            targetUser.isManipulated = false;
            targetUser.gambleWinRate = 0;
            targetUser.fishLuck = 0;
            targetUser.skipHealing = true;
            replier.reply(formatAdmin("ğŸ¯ ì¡°ì‘ í•´ì œ", "ëŒ€ìƒ: [" + targetRoom + "] " + targetUser.name + "\nëª¨ë“  í™•ë¥ ì´ ì •ìƒìœ¼ë¡œ ëŒì•„ì™”ìŠµë‹ˆë‹¤."));
        }
        else if (type === "stock_buy" || type === "stock_sell") {
            var landName = selected; 
            var cmdPrefix = (type === "stock_buy") ? "/íˆ¬ì " : "/ë§¤ê° ";
            _gameLandmarkLogic(cmdPrefix + landName + " " + extra.amount, targetUser, data, replier, targetRoom, selected.id);
            return true;
        }
        else if (type === "info") {
            var cr = getCreditInfo(targetUser.creditScore);
            var info = "ğŸ“ ì†Œì†: " + targetRoom + "\nğŸ’° í¬ì¸íŠ¸: " + fp(targetUser.point) + "P\nğŸ¦ ì˜ˆê¸ˆ: " + fp(targetUser.bank) + "P\nğŸ’³ ì‹ ìš©: " + cr.label + " (" + targetUser.creditScore + "ì )\nğŸ… í‹°ì–´: " + (TIERS[targetUser.tier] || "ì•„ì´ì–¸");
            replier.reply(formatCommand("ğŸ” ìœ ì € ìƒì„¸ ì •ë³´", targetUser, info, null));
        }
        else if (type === "mining_info") {
            var isMin = (targetUser.mining && targetUser.mining.active === true);
            var dur = isMin ? Math.floor((Date.now() - targetUser.mining.startTime) / 60000) : 0;
            var tot = (targetUser.totalMiningTime || 0) + dur;
            var pol = util_getActivePolicy(targetRoomData);
            var mult = util_getEcoMultiplier(targetRoom) * (pol.mineMult || 1.0);
            if (targetUser.loan && Number(targetUser.loan.debt) > 0) mult *= 1.5;
            var est = isMin ? Math.floor(dur * SYSTEM_CONFIG.ECO.MINE.BASE_PER_MIN * mult) : 0;

            var body = "\n" + (isMin ? "ì±„êµ´ ì§„í–‰: " + dur + "ë¶„ì§¸...\n" : "âœ¨ ìƒíƒœ: í˜„ì¬ íœ´ì‹ ì¤‘ì…ë‹ˆë‹¤.\n") +
                       "ğŸ“ˆ ëˆ„ì  ì±„êµ´: " + fp(tot) + "ë¶„ ê²½ê³¼\n" +
                       "ğŸ’° ì˜ˆìƒ ìˆ˜ìµ: +" + fp(est) + "P\n" +
                       "âš–ï¸ ì •ì±… íš¨ê³¼: x" + mult.toFixed(1) + " (ì ìš© ì¤‘)\n\n" +
                       "âœ¨ ê´‘ë¬¼ ë°œê²¬ ìˆ˜ìµì€ ì¢…ë£Œ ì‹œ í•©ì‚°ë©ë‹ˆë‹¤.";
            replier.reply(formatCommand("ğŸ” ìœ ì € ê´‘ì‚° ì§„í–‰ í˜„í™©", targetUser, body, null));
        }
        else if (type === "transfer") {
            if (selected.id === targetUid) return replier.reply(formatError(user, "ì†¡ê¸ˆ ë¶ˆê°€", "ìê¸° ìì‹ ì—ê²ŒëŠ” ì†¡ê¸ˆí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
            util_updatePoint(user, roomData, -extra.amount, "ì†¡ê¸ˆ ë³´ëƒ„", roomName);
            var res = processRepayment(targetUser, extra.amount, selected.id, targetRoom);
            util_updatePoint(targetUser, targetRoomData, Number(res.actualGain), "ì†¡ê¸ˆ ë°›ìŒ", targetRoom);
            replier.reply(formatCommand("ğŸ’¸ ì†¡ê¸ˆ ì™„ë£Œ", user, "[" + targetRoom + "] " + getDisplayName(targetUser) + "ë‹˜ê»˜ " + fp(extra.amount) + "P ë³´ëƒˆìŠµë‹ˆë‹¤.", "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
        }
        else if (type === "admin_userdata") { 
            replier.reply(formatAdmin("ìœ ì € ë°ì´í„° ì¡°íšŒ", JSON.stringify(targetUser, null, 2))); 
        }
        else if (type === "admin_point_give") {
            util_updatePoint(targetUser, targetRoomData, extra.amount, "ê´€ë¦¬ì ì§€ê¸‰", targetRoom);
            replier.reply(formatAdmin("í¬ì¸íŠ¸ ì§€ê¸‰ ì™„ë£Œ", "[" + targetRoom + "] " + getDisplayName(targetUser) + "ë‹˜: +" + fp(extra.amount) + "P\n(í˜„ì¬: " + fp(targetUser.point) + "P)"));
            try { Api.replyRoom("ë² ë¦­ë°©", "âš™ï¸ [Admin Action: Selected]\nâ€¢ ì‹¤í–‰ì: " + user.name + "\nâ€¢ ëŒ€ìƒ: [" + targetRoom + "] " + targetUser.name + "\nâ€¢ ë‚´ìš©: " + fp(extra.amount) + "P ì§€ê¸‰ ì™„ë£Œ"); } catch(e) {}
        }
        else if (type === "admin_point_take") {
            util_updatePoint(targetUser, targetRoomData, -extra.amount, "ê´€ë¦¬ì ì°¨ê°", targetRoom);
            replier.reply(formatAdmin("í¬ì¸íŠ¸ ì°¨ê° ì™„ë£Œ", "[" + targetRoom + "] " + getDisplayName(targetUser) + "ë‹˜ ì°¨ê° ì²˜ë¦¬ë¨"));
        }
        else if (type === "admin_attend_edit") {
            targetUser.totalAttendance = extra.days;
            replier.reply(formatAdmin("ì¶œì„ ìˆ˜ì • ì™„ë£Œ", "[" + targetRoom + "] " + getDisplayName(targetUser) + "ë‹˜: " + extra.days + "ì¼"));
        }
        else if (type === "admin_credit_edit") {
            var oldScore = Number(targetUser.creditScore || 600);
            targetUser.creditScore = Math.min(1000, Math.max(0, oldScore + extra.score));
            if (typeof checkAndHandleDefaulter === 'function') checkAndHandleDefaulter(targetUser, targetRoom);
            var crInfo = getCreditInfo(targetUser.creditScore);
            replier.reply(formatAdmin("âš™ï¸ ì‹ ìš© ì ìˆ˜ ì¡°ì • ì™„ë£Œ", "ëŒ€ìƒ: [" + targetRoom + "] " + getDisplayName(targetUser) + "\në³€ë™: " + extra.score + "ì \ní˜„ì¬: " + targetUser.creditScore + "ì  (" + crInfo.label + ")"));
        }
        else if (type === "admin_title_take") {
            var titleToTake = extra.title;
            var inv = targetUser.inventory || [];
            var removed = false;
            targetUser.inventory = inv.filter(function(it) {
                if (it.effect === "title" && (it.title === titleToTake || it.name.indexOf(titleToTake) !== -1)) {
                    removed = true; return false;
                }
                return true;
            });
            if (targetUser.title === titleToTake) { targetUser.title = ""; removed = true; }
            if (removed) {
                replier.reply(formatAdmin("ğŸ–ï¸ ì¹­í˜¸ íšŒìˆ˜ ì™„ë£Œ", "[" + targetRoom + "] " + getDisplayName(targetUser) + "ë‹˜ì—ê²Œì„œ [" + titleToTake + "] ì¹­í˜¸ë¥¼ ë°•íƒˆí–ˆìŠµë‹ˆë‹¤."));
            } else {
                replier.reply(formatAdmin("íšŒìˆ˜ ì‹¤íŒ¨", "[" + targetRoom + "] " + getDisplayName(targetUser) + "ë‹˜ì€ í•´ë‹¹ ì¹­í˜¸ë¥¼ ë³´ìœ í•˜ê³  ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."));
            }
        }
        else if (type === "admin_delete") {
            var tName = targetUser.name;
            var targetId = selected.id;
            var refundLog = "";
            var refundCount = 0;
            var totalRefunded = 0;
            // [êµì •] targetRoomDataì˜ ì‚¬ì±„ ê³„ì•½ ì²˜ë¦¬
            if (targetRoomData.loanContracts) {
                for (var cid in targetRoomData.loanContracts) {
                    var c = targetRoomData.loanContracts[cid];
                    if (c.borrowerUid === targetId) {
                        var lender = targetRoomData.users[c.lenderUid];
                        if (lender) {
                            var debtAmt = Number(c.currentDebt);
                            util_updatePoint(lender, targetRoomData, debtAmt, "ì‚¬ì±„ ê°•ì œ ì •ì‚°", targetRoom);
                            totalRefunded += debtAmt;
                            refundCount++;
                            try { Api.replyRoom(targetRoom, "ğŸš¬ [ì‚¬ì±„ ê°•ì œ ì •ì‚°]\n" + tName + "ë‹˜ì˜ ë°ì´í„° ì‚­ì œë¡œ ì¸í•´ " + lender.name + "ë‹˜ê»˜ ë¯¸ìˆ˜ê¸ˆ " + fp(debtAmt) + "Pê°€ ì „ì•¡ ë°˜í™˜ë˜ì—ˆìŠµë‹ˆë‹¤."); } catch(e){}
                        }
                        delete targetRoomData.loanContracts[cid];
                    }
                }
            }
            if (targetUser.loan && Number(targetUser.loan.debt) > 0) {
                var bankDebt = Number(targetUser.loan.debt);
                util_updateReserve(targetRoomData, bankDebt, "ëŒ€ì¶œê¸ˆ êµ­ê³  íšŒìˆ˜", targetRoom);
                refundLog += "\n\nğŸ¦ ì€í–‰ ëŒ€ì¶œê¸ˆ " + fp(bankDebt) + "Pê°€ êµ­ê³ ë¡œ ìë™ íšŒìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.";
            }
            if (refundCount > 0) refundLog += "\nâš ï¸ ì‚¬ì±„ ë³´ì „ ì™„ë£Œ: " + refundCount + "ê±´ (" + fp(totalRefunded) + "P)";
            
            // ìºì‹œ ì‚­ì œ
            if (typeof uidCache !== 'undefined') {
                for (var key in uidCache) { if (uidCache[key] === targetId) delete uidCache[key]; }
            }
            // [êµì •] ì‹¤ì œ ìœ ì €ê°€ ìˆëŠ” ë°©ì—ì„œ ì‚­ì œ
            delete targetRoomData.users[targetId];
            try {
                var regFile = new java.io.File(REGISTRY_PATH);
                if (regFile.exists()) {
                    var regData = JSON.parse(FileStream.read(REGISTRY_PATH));
                    // [êµì •] íƒ€ê²Ÿ ë°© ì´ë¦„ í‚¤ë¡œ ëª…ë¶€ ì‚­ì œ
                    delete regData[targetRoom + "_" + tName];
                    FileStream.write(REGISTRY_PATH, JSON.stringify(regData));
                }
            } catch (e) { Log.error("Registry Delete Error: " + e); }
            replier.reply(formatAdmin("ìœ ì € ì‚­ì œ ì™„ë£Œ", "[" + targetRoom + "] ë°©ì—ì„œ [" + tName + "]ë‹˜ì˜ ë°ì´í„°ë¥¼ ì˜êµ¬ ì‚­ì œí–ˆìŠµë‹ˆë‹¤." + refundLog));
        }

        else if (type === "admin_land_take") {
            var holdings = targetUser.landHoldings || {};
            var matchedLand = util_findStockByShorthand(holdings, extra.land);
            
            if (matchedLand.length === 0) {
                replier.reply(formatAdmin("ğŸš« íšŒìˆ˜ ì‹¤íŒ¨", "[" + targetUser.name + "]ë‹˜ì€ í•´ë‹¹ ì§€ë¶„ì´ ì—†ìŠµë‹ˆë‹¤."));
            } else {
                var sName = matchedLand[0];
                var currentQty = Number(holdings[sName] || 0);
                var takeQty = (extra.qty === "ì „ë¶€") ? currentQty : parseInt(extra.qty.replace(/,/g, ""));
                if (takeQty > currentQty) takeQty = currentQty;

                targetUser.skipHealing = true;
                util_updateLandmark(targetUser, sName, -takeQty, "ê´€ë¦¬ì ê°•ì œ íšŒìˆ˜", targetRoom);
                
                if (Number(targetUser.landHoldings[sName]) <= 0) {
                    delete targetUser.landHoldings[sName];
                    if (targetUser.landAvg) delete targetUser.landAvg[sName];
                }
                replier.reply(formatAdmin("âš™ï¸ ë¶€ë™ì‚° íšŒìˆ˜ ì™„ë£Œ", "[" + targetRoom + "] " + targetUser.name + "ë‹˜ì˜ [" + sName + "] ì§€ë¶„ì„ íšŒìˆ˜í–ˆìŠµë‹ˆë‹¤."));
            }
        }

        else if (type === "admin_attend_reset") {
            targetUser.lastDate = "";
            replier.reply(formatAdmin("ì¶œì„ ì´ˆê¸°í™”", "[" + targetRoom + "] " + getDisplayName(targetUser) + "ë‹˜ì˜ ì˜¤ëŠ˜ ì¶œì„ ê¸°ë¡ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤."));
        }
        else if (type === "user_restore") {
            var stablePath = BASE_DIR + "backup/last_stable_backup.json";
            var stableFile = new java.io.File(stablePath);

            if (!stableFile.exists() || stableFile.length() === 0) {
                replier.reply(formatAdmin("ğŸš« ë³µêµ¬ ì‹¤íŒ¨", "ì•ˆì „ ë°±ì—… íŒŒì¼(last_stable_backup.json)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
                return true;
            }

            try {
                var sourceCode = (extra && extra.sourceCode) ? extra.sourceCode : selected.id;
                var targetId = selected.id;
                var fullNick = selected.data.name; 

                var backupContent = FileStream.read(stablePath);
                var backupData = JSON.parse(backupContent);
                var rawBackupUser = null;

                for (var r in backupData.rooms) {
                    if (backupData.rooms[r].users[sourceCode]) {
                        rawBackupUser = backupData.rooms[r].users[sourceCode];
                        break;
                    }
                }

                if (!rawBackupUser) throw new Error("ë°±ì—…ë³¸ì— í•´ë‹¹ ë°ì´í„°(ID:" + sourceCode + ")ê°€ ì—†ìŠµë‹ˆë‹¤.");

                var backupUser = JSON.parse(JSON.stringify(rawBackupUser));
                var schema = { chatLog: [], inventory: [], stockHoldings: {}, stockAvg: {}, point: 50000 };
                for (var key in schema) { if (backupUser[key] === undefined) backupUser[key] = schema[key]; }

                backupUser.name = fullNick;
                // [êµì •] targetRoomDataì— ë³µì› ë°ì´í„° ì´ì‹
                targetRoomData.users[targetId] = backupUser;

                safeSaveData(data, false);
                if (typeof globalData !== 'undefined') globalData = data;

                replier.reply(formatAdmin("âœ… ë°ì´í„° ì •ë°€ ì´ê´€ ì™„ë£Œ",
                    "ğŸ“ ì†Œì†: " + targetRoom + "\n" +
                    "í˜„ì¬ ëŒ€ìƒ: " + fullNick + "\n" +
                    "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                    "ğŸ’° ìµœì¢… ë³µêµ¬ ì”ì•¡: " + fp(backupUser.point) + "P\n\n" +
                    "ğŸ’¡ ì›ê²©ì§€ ë°©ìœ¼ë¡œì˜ ë°ì´í„° ë™ê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."));

            } catch (e) {
                replier.reply(formatAdmin("ğŸš« ë³µêµ¬ ì¤‘ë‹¨", "ë³µêµ¬ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì‚¬ìœ : " + e.message));
                Log.error("Select Restore Error: " + e);
            }
        }
        else if (type === "admin_nick_log") {
            var hist = data.nickHistory[selected.id] || [];
            if (hist.length === 0) {
                replier.reply(formatAdmin("ë‹‰ë„¤ì„ ê¸°ë¡", "[" + targetRoom + "] " + getDisplayName(targetUser) + "ë‹˜ì€ ë³€ê²½ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤."));
            } else {
                var logMsg = [];
                for(var i=0; i<hist.length; i++) logMsg.push((i+1) + ". " + hist[i].old + " (" + hist[i].date + ")");
                replier.reply(formatAdmin("ğŸ“‹ ë‹‰ë„¤ì„ ë³€ê²½ ì´ë ¥", "ğŸ“ ì†Œì†: " + targetRoom + "\ní˜„ì¬: " + targetUser.name + "\n\n[ê³¼ê±° ê¸°ë¡]\n" + logMsg.join("\n")));
            }
        }
        else if (type === "admin_blackbox") {
            _executeBlackboxSearch(selected.id, targetUser, replier);
        }
        else if (type === "admin_reg_delete") {
            var targetKey = selected.id; 
            var targetFullNick = selected.data.name;
            try {
                var regFile = new java.io.File(REGISTRY_PATH);
                if (regFile.exists()) {
                    var regData = JSON.parse(FileStream.read(REGISTRY_PATH));
                    delete regData[targetKey];
                    FileStream.write(REGISTRY_PATH, JSON.stringify(regData));
                    replier.reply(formatAdmin("ëª…ë¶€ ì‚­ì œ ì™„ë£Œ", "ì°¾ì€ ìœ ì €: [" + targetFullNick + "]\nê´€ë ¨ ì‹ë³„ ì½”ë“œë¥¼ ëª…ë¶€ì—ì„œ íŒŒê¸°í–ˆìŠµë‹ˆë‹¤."));
                }
            } catch (e) { Log.error("Registry Delete Error: " + e); }
        }

        safeSaveData(data);
        return true; 
    } // if (!isNaN(choice)...) ë¸”ë¡ ë§ˆê°
}

//==========ì„¹í„°21==========

/**
 * [ë…ë¦½í˜• í•¨ìˆ˜] ë¡œë˜ ë²ˆí˜¸ ì…ë ¥ ì²˜ë¦¬ ì—”ì§„
 */
function _handleLottoInput(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];
    if (!roomData || !roomData.features) return false;

    // ë°©ë³„ ë…ë¦½ ìƒíƒœ ì €ì¥ì†Œ ì°¸ì¡°
    var lottoPurchaseState = roomData.features.states.lottoPurchase;
    
    // í˜„ì¬ ìœ ì €ê°€ ë¡œë˜ êµ¬ë§¤ ëŒ€ê¸° ì¤‘ì¸ì§€ í™•ì¸
    if (!lottoPurchaseState || !lottoPurchaseState[targetUid]) return false;

    // 1. ì‹œê°„ ì´ˆê³¼ ë° ì·¨ì†Œ ê°€ë“œ
    if (Date.now() - lottoPurchaseState[targetUid].time > 30000) {
        delete lottoPurchaseState[targetUid];
        replier.reply(formatError(user, "ì…ë ¥ ì‹œê°„ ì´ˆê³¼", "30ì´ˆê°€ ì§€ë‚˜ êµ¬ë§¤ê°€ ìë™ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."));
        return true;
    }
    if (msg === "ì·¨ì†Œ") {
        delete lottoPurchaseState[targetUid];
        replier.reply(formatCommand("ğŸš« êµ¬ë§¤ ì·¨ì†Œ", user, "ë¡œë˜ êµ¬ë§¤ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    // 2. í™œë™ ìƒíƒœ ê²€ì¦
    var stateRes = util_checkUserState(user, targetUid, roomName);
    if (!stateRes.canAction) {
        delete lottoPurchaseState[targetUid];
        replier.reply(formatError(user, "êµ¬ë§¤ ë¶ˆê°€", stateRes.reason));
        return true;
    }

    // 3. ë²ˆí˜¸ íŒŒì‹±
    var rawNums = msg.match(/\d+/g);
    if (!rawNums || rawNums.length !== 3) {
        replier.reply(formatError(user, "ì…ë ¥ ì˜¤ë¥˜", "ìˆ«ì 3ê°œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.\nì˜ˆ) 1 5 10"));
        return true;
    }
    
    var nums = rawNums.map(Number).sort(function(a, b) { return a - b; });
    var isInvalid = (nums[0] === nums[1] || nums[1] === nums[2] || nums[0] === nums[2]);
    for (var i = 0; i < 3; i++) { if (nums[i] < 1 || nums[i] > 15) isInvalid = true; }
    
    if (isInvalid) {
        replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "1~15 ì‚¬ì´ì˜ ì¤‘ë³µ ì—†ëŠ” ìˆ«ì 3ê°œë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
        return true;
    }

    // 4. ê°€ê²© í™•ì¸ ë° ì”ì•¡ ì²´í¬
    var lottoPrice = (lottoPurchaseState[targetUid].price !== undefined) ? lottoPurchaseState[targetUid].price : 2000;
    if (Number(user.point) < lottoPrice) {
         delete lottoPurchaseState[targetUid];
         replier.reply(formatError(user, "ì”ì•¡ ë¶€ì¡±", fp(lottoPrice) + "Pê°€ í•„ìš”í•©ë‹ˆë‹¤."));
         return true;
    }

    // 5. ë¡œë˜ ë°ì´í„° ë“±ë¡
    var lotto = roomData.features.lotto;
    if (!lotto.entries) lotto.entries = {};
    if (!lotto.entries[targetUid]) lotto.entries[targetUid] = [];

    lotto.entries[targetUid].push(nums);
    lotto.dailyPool = (Number(lotto.dailyPool) || 0) + lottoPrice;

    // 6. ê²°ì œ ë° ì™„ë£Œ
    var prePoint = Number(user.point);
    util_updatePoint(user, roomData, -lottoPrice, "ë¡œë˜ êµ¬ë§¤", roomName);
    var actualDeducted = prePoint - Number(user.point);

    delete lottoPurchaseState[targetUid];
    
    replier.reply(formatCommand("ğŸ« ë¡œë˜ êµ¬ë§¤ ì™„ë£Œ", user, 
        "ì„ íƒ ë²ˆí˜¸: [" + nums.join(", ") + "]\n" +
        "ì°¨ê° ê¸ˆì•¡: " + fp(actualDeducted) + "P\n" +
        "ì¶”ì²¨ ì‹œê°„: ë§¤ì¼ ë°¤ 22:00", 
        "ë‚´ ì”ì•¡: " + fP(user.point) + "P"
    ));

    safeSaveData(data);
    return true; 
}

/* [ì±„íŒ… ë³´ë„ˆìŠ¤ ë¡œì§ ë¶„ë¦¬] - ì„¹í„° 21 í•˜ë‹¨ì— ì¶”ê°€ */
function _runChatBonusLogic(msg, user, data, replier, roomName, targetUid) {

    if (ALLOWED_ROOMS.indexOf(roomName) === -1) return;

    if (msg.indexOf("/") !== 0) {
        user.chatCount = (user.chatCount || 0) + 1;
        user.chatCycleCount = (user.chatCycleCount || 0) + 1;
        
        if (user.chatCycleCount > 13 || !user.chatBonusTarget) {
            user.chatCycleCount = 1; 
            user.chatBonusTarget = Math.floor(Math.random() * 12) + 1;
            user.chatBonusGiven = false; 
        }
        
        if (user.chatCycleCount >= user.chatBonusTarget && !user.chatBonusGiven) {
            // [v5.9] í†µí•© ìƒíƒœ ê°€ë“œ
            var stateRes = util_checkUserState(user, targetUid, roomName);
            if (!stateRes.canAction && stateRes.reason.indexOf("ì§•ì—­") !== -1) return;

            var multiplier = util_getEcoMultiplier(roomName);
            var basePrize = Math.floor(Math.random() * 501) + 1500;
            var prize = Math.floor(basePrize * multiplier);

            // [ì‹ ê·œ] ì‹ ìš©ë¶ˆëŸ‰ì í˜ë„í‹°: ì±„íŒ… ë³´ë„ˆìŠ¤ 20% ì‚­ê°
            var penaltyMsg = "";
            if (Number(user.creditScore || 600) < 500) {
                var penalty = Math.floor(prize * 0.2);
                prize -= penalty;
                penaltyMsg = "\nâš ï¸ ì‹ ìš©ë¶ˆëŸ‰ í˜ë„í‹° ì ìš© (-20%)";
            }
            
            var res = processRepayment(user, prize, targetUid, roomName);
            util_updatePoint(user, data.rooms[roomName], Number(res.actualGain), "ì±„íŒ… ë³´ë„ˆìŠ¤", roomName);

            user.creditScore = Math.min(1000, Number(user.creditScore || 600) + 1);
            
            var output = "ğŸ ì±„íŒ… ë³´ë„ˆìŠ¤\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + getDisplayName(user) + "ë‹˜\n" + fp(prize) + "Pë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!" + (res.repayMsg ? res.repayMsg : "") + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”";
            replier.reply(output + "\në‚´ ì”ì•¡: " + fP(user.point) + "P");
            
            user.chatBonusGiven = true; 
        }
    }
}

//==========ì„¹í„°22-1==========

/* [ë…ë¦½í˜• í•¨ìˆ˜] í†µí•© ì—…ë¬´ ì²˜ë¦¬ í•¸ë“¤ëŸ¬ 1ë‹¨ê³„: ì†¡ê¸ˆ, ì˜ˆê¸ˆ ë° ê¸°ë¶€ */
function _handleBankStep1(msg, user, data, replier, roomName, targetUid) {
    var bankProcessState = data.rooms[roomName].features.states.bankProcess;
    if (!bankProcessState || !bankProcessState[targetUid]) return false;

    var state = bankProcessState[targetUid];
    var types = ['transfer', 'deposit', 'donate', 'blackjack_bet_input'];
    if (types.indexOf(state.type) === -1) return false; // ë‚´ ë‹´ë‹¹ ì—…ë¬´ê°€ ì•„ë‹ˆë©´ íŒ¨ìŠ¤

    // 1. ê³µí†µ ê°€ë“œ (ì‹œê°„ ì´ˆê³¼ ë° ì·¨ì†Œ)
    if (Date.now() - state.time > 30000 || msg === "ì·¨ì†Œ") {
        delete bankProcessState[targetUid];
        if (msg === "ì·¨ì†Œ") {
            replier.reply(formatCommand("ğŸš« ì—…ë¬´ ì·¨ì†Œ", user, "ì—…ë¬´ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."));
        } else {
            replier.reply(formatError(user, "ì„ íƒ ì‹œê°„ ì´ˆê³¼", "30ì´ˆ ì´ë‚´ì— ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì§€ ì•Šì•„ ë©”ë‰´ê°€ ë‹«í˜”ìŠµë‹ˆë‹¤."));
        }
        return true;
    }
    if (msg.startsWith("/")) return false; // ëª…ë ¹ì–´ëŠ” í˜ë ¤ë³´ëƒ„

    // 2. ìŠ¤ë§ˆíŠ¸ ê°€ë“œ (ì§•ì—­)
    if (user.jailReleaseTime && Date.now() < user.jailReleaseTime) {
        delete bankProcessState[targetUid];
        var diff = user.jailReleaseTime - Date.now();
        var remainMin = Math.ceil(diff / (1000 * 60));
        replier.reply(formatError(user, "ì—…ë¬´ ë¶ˆê°€", "í˜„ì¬ ì§•ì—­ ì¤‘ì…ë‹ˆë‹¤. (" + remainMin + "ë¶„ ë‚¨ìŒ)"));
        return true;
    }

    var roomData = data.rooms[roomName];
    if (roomData.bankReserve === undefined) roomData.bankReserve = SYSTEM_CONFIG.ECO.BANK.INITIAL_RESERVE;

    if (state.type === 'blackjack_bet_input') {
        var amt = parseInt(msg.replace(/,/g, ""));
        var minB = SYSTEM_CONFIG.ECO.GAMBLE_MIN || 2000;
        var maxB = SYSTEM_CONFIG.ECO.GAMBLE_MAX || 50000;

        if (isNaN(amt) || amt < minB || amt > maxB) {
            replier.reply(formatError(user, "ë°°íŒ… ê¸ˆì•¡ ì˜¤ë¥˜", fp(minB) + "P ~ " + fp(maxB) + "P ì‚¬ì´ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
            return true;
        }
        if (Number(user.point) < amt) {
            replier.reply(formatError(user, "ì”ì•¡ ë¶€ì¡±", "ë³´ìœ  í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."));
            return true;
        }

        delete bankProcessState[targetUid]; // ì…ë ¥ ì„¸ì…˜ ì¢…ë£Œ
        // ì„¹í„° 52ì— ì •ì˜ëœ ë¸”ë™ì­ ì‹œì‘ í•¨ìˆ˜ í˜¸ì¶œ
        _startBlackjackGame(user, data, replier, roomName, targetUid, amt);
        return true;
    }

    /* [ê¸°ëŠ¥ 1] ì†¡ê¸ˆ ì²˜ë¦¬ */
    if (state.type === 'transfer') {
        var ps = msg.split(" ");
        if (ps.length < 2) {
            replier.reply(formatError(user, "ì…ë ¥ ì˜¤ë¥˜", "í˜•ì‹: [ë‹‰ë„¤ì„] [ê¸ˆì•¡]"));
            return true;
        }
        var am = parseInt(ps.pop().replace(/,/g, ""));
        var tn = ps.join(" ").trim();
        var found = findUserByName(roomData, tn);

        if (found.length === 0) {
            replier.reply(formatError(user, "ëŒ€ìƒ ì—†ìŒ", "[" + tn + "]ë‹˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        } else if (found.length > 1) {
            handleUserSelection(replier, targetUid, found, "transfer", { amount: am }, user, roomName);
            delete bankProcessState[targetUid];
        } else if (found[0].id === targetUid) {
            replier.reply(formatError(user, "ë³¸ì¸ ì†¡ê¸ˆ ë¶ˆê°€", "ìì‹ ì—ê²ŒëŠ” ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        } else if (isNaN(am) || am <= 0) {
            replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜", "ì •í™•í•œ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
        } else if (user.point < am) {
            replier.reply(formatError(user, "ì”ì•¡ ë¶€ì¡±", "ë³´ìœ  í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."));
        } else {
            var rc = found[0].data;
            util_updatePoint(user, roomData, -am, "ì†¡ê¸ˆ ë³´ëƒ„", roomName);
            var res = processRepayment(rc, am, found[0].id, roomName);
            util_updatePoint(rc, roomData, Number(res.actualGain), "ì†¡ê¸ˆ ë°›ìŒ", roomName);
            replier.reply(formatCommand("ğŸ’¸ ì†¡ê¸ˆ ì™„ë£Œ", user, getDisplayName(rc) + "ë‹˜ê»˜ " + fp(am) + "Pë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤." + res.repayMsg, "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
            delete bankProcessState[targetUid];
            safeSaveData(data);
        }
        return true;
    }

        /* [ê¸°ëŠ¥ 2] ì˜ˆê¸ˆ ì²˜ë¦¬ */
    else if (state.type === 'deposit') {
        var amt = parseInt(msg.replace(/,/g, ""));
        if (isNaN(amt) || amt <= 0) {
            replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜", "ì˜ˆê¸ˆí•  ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
        } else if (user.point < amt) {
            replier.reply(formatError(user, "í¬ì¸íŠ¸ ë¶€ì¡±", "ë³´ìœ í•˜ì‹  í¬ì¸íŠ¸ë³´ë‹¤ ë§ìŠµë‹ˆë‹¤."));
        } else {
            util_updateBank(user, roomData, amt, "ì€í–‰ ì˜ˆê¸ˆ", roomName);
            util_updatePoint(user, roomData, -amt, "ì€í–‰ ì˜ˆê¸ˆ", roomName);
            replier.reply(formatCommand("ğŸ’° ì˜ˆê¸ˆ ì™„ë£Œ", user, fp(amt) + "Pë¥¼ í†µì¥ì— ì…ê¸ˆí–ˆìŠµë‹ˆë‹¤.\n(ì¤‘ì•™ì€í–‰ ê°€ìš© ì¬ì›ìœ¼ë¡œ í¸ì…ë¨)", "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
            delete bankProcessState[targetUid];
            safeSaveData(data);
        }
        return true;
    }

        /* [ê¸°ëŠ¥ 3] ê¸°ë¶€ ì²˜ë¦¬ */
    else if (state.type === 'donate') {
        var amt = parseInt(msg.replace(/,/g, ""));
        if (isNaN(amt) || amt <= 0) {
            replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜", "ê¸°ë¶€í•  ê¸ˆì•¡ì„ ìˆ«ìë¡œ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”."));
        } else if (user.point < amt) {
            replier.reply(formatError(user, "ì”ì•¡ ë¶€ì¡±", "ë³´ìœ í•˜ì‹  í¬ì¸íŠ¸ë³´ë‹¤ ë§ì€ ê¸ˆì•¡ì€ ê¸°ë¶€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        } else {
            var replierStub = { reply: function(m) { Api.replyRoom(roomName, m); } };
            util_updatePoint(user, roomData, -amt, "ì€í–‰ ê¸°ë¶€", roomName);
            var nextDonation = (user.totalDonation || 0) + amt;
            util_setData(user, 'totalDonation', nextDonation, "ê¸°ë¶€ê¸ˆ ëˆ„ì ", roomName);
            
            // 1. [ì‹ ê·œ] ê¸°ë¶€ ê¸ˆì•¡ì— ë”°ë¥¸ ì‹ ìš©ë„ íšŒë³µ ë¡œì§ (10,000Pë‹¹ 10ì )
            var creditGain = Math.floor(amt / 10000) * 10;
            if (creditGain > 0) {
                var nextScore = Math.min(1000, Number(user.creditScore || 600) + creditGain);
                util_setData(user, 'creditScore', nextScore, "ê¸°ë¶€ ë³´ìƒ ì‹ ìš© íšŒë³µ", roomName);
                if (typeof checkAndHandleDefaulter === 'function') checkAndHandleDefaulter(user, roomName);
            }

            // 2. [ìˆ˜ì •] ê¸°ë¶€ ì¹­í˜¸ ì¡°ê±´ ë° ê¸°ë¶€ì™• í˜œíƒ ë³€ê²½
            var donation = user.totalDonation;
            
            if (donation >= 5000000) {
                util_checkAndAwardTitle(user, replierStub, "ê¸°ë¶€ì™•", 5004, "ğŸ‘‘", "ë‚´ë¦¬ë‹¤ ì‚¬íšŒë³µì§€ í˜‘ì˜íšŒ", "ëˆ„ì  ê¸°ë¶€ ê¸ˆì•¡ " + fp(5000000) + "P", "[ì¥ì°© íš¨ê³¼]: ëª¨ë“  ì¢…ë¥˜ì˜ ì„¸ê¸ˆ(ì†Œë“ì„¸, ë¬´ì—­ì„¸, ì¹´ì§€ë…¸ì„¸)ì´ 50% ìƒì‹œ ê°ë©´ë©ë‹ˆë‹¤.", roomName);
            } else if (donation >= 3000000) {
                util_checkAndAwardTitle(user, replierStub, "ìì„ ê°€", 5003, "âœ¨", "ë‚´ë¦¬ë‹¤ ì‚¬íšŒë³µì§€ í˜‘ì˜íšŒ", "ëˆ„ì  ê¸°ë¶€ ê¸ˆì•¡ " + fp(3000000) + "P", "ì‚¬íšŒ ì „ë°˜ì— ê±¸ì³ ì„ í•œ ì˜í–¥ë ¥ì„ ë„ë¦¬ í¼ëœ¨ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.", roomName);
            } else if (donation >= 1000000) {
                util_checkAndAwardTitle(user, replierStub, "ê¸°ë¶€ì²œì‚¬", 5002, "ğŸ‘¼", "ë‚´ë¦¬ë‹¤ ì‚¬íšŒë³µì§€ í˜‘ì˜íšŒ", "ëˆ„ì  ê¸°ë¶€ ê¸ˆì•¡ " + fp(1000000) + "P", "ì–´ë ¤ìš´ ì´ë“¤ì—ê²Œ í¬ë§ì˜ ë¹›ì„ ì„ ì‚¬í–ˆìŠµë‹ˆë‹¤.", roomName);
            } else if (donation >= 500000) {
                util_checkAndAwardTitle(user, replierStub, "ì„ í•œì†ê¸¸", 5001, "ğŸŒ±", "ë‚´ë¦¬ë‹¤ ì‚¬íšŒë³µì§€ í˜‘ì˜íšŒ", "ëˆ„ì  ê¸°ë¶€ ê¸ˆì•¡ " + fp(500000) + "P", "ë‹¹ì‹ ì˜ ë”°ëœ»í•œ ë§ˆìŒì´ ì‚¬íšŒì˜ ì†Œì¤‘í•œ ë°€ì•Œì´ ë©ë‹ˆë‹¤.", roomName);
            }

            var thanksMsg = "ì¤‘ì•™ì€í–‰ì— " + fp(amt) + "Pë¥¼ ê¸°ë¶€í•˜ì…¨ìŠµë‹ˆë‹¤.\n" +
                            "ë³´ë‚´ì£¼ì‹  ì†Œì¤‘í•œ ìì‚°ì€ êµ­ê°€ ê²½ì œ ìœ„ê¸° ê·¹ë³µê³¼ \n" +
                            "ì „ì²´ ìœ ì € ë³µì§€ í–¥ìƒì„ ìœ„í•´ ê·€í•˜ê²Œ ì‚¬ìš©ë©ë‹ˆë‹¤.\n\n" +
                            "ğŸ“ˆ [ì‹ ìš© íšŒë³µ]: +" + creditGain + "ì  ìƒìŠ¹\n" +
                            "ğŸ¦ [êµ­ê³  ì…ê³ ]: ê¸°ë¶€ê¸ˆì´ ì¤‘ì•™ì€í–‰ ì¬ì›ìœ¼ë¡œ ê·€ì†ë¨\n" +
                            "ğŸ“Š ëˆ„ì  ê¸°ë¶€ì•¡: " + fp(donation) + "P";
                replier.reply(formatCommand("ğŸ ê¸°ë¶€ ì™„ë£Œ", user, thanksMsg, "(í˜„ì¬ ì”ì•¡: " + fp(user.point) + "P)"));
                delete bankProcessState[targetUid];
                safeSaveData(data)
            }
        return true;
    }
    return false;
}
            
//==========ì„¹í„°22-2==========

/* [ë…ë¦½í˜• í•¨ìˆ˜] í†µí•© ì—…ë¬´ ì²˜ë¦¬ í•¸ë“¤ëŸ¬ 2ë‹¨ê³„: ì¶œê¸ˆ, ëŒ€ì¶œ, ìƒí™˜ */
function _handleBankStep2(msg, user, data, replier, roomName, targetUid) {
    var bankProcessState = data.rooms[roomName].features.states.bankProcess;
    if (!bankProcessState || !bankProcessState[targetUid]) return false;

    var state = bankProcessState[targetUid];
    var types = ['withdraw', 'loan', 'repay'];
    if (types.indexOf(state.type) === -1) return false;

    // ê³µí†µ ê°€ë“œ
    if (Date.now() - state.time > 30000) {
        delete bankProcessState[targetUid];
        replier.reply(formatError(user, "ì…ë ¥ ì‹œê°„ ì´ˆê³¼", "ì…ë ¥ ì‹œê°„ì´ 30ì´ˆë¥¼ ì´ˆê³¼í•˜ì—¬ ì€í–‰ ì—…ë¬´ê°€ ìë™ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."));
        return true;
    }
    if (msg === "ì·¨ì†Œ") {
        delete bankProcessState[targetUid];
        replier.reply(formatCommand("ğŸš« ì—…ë¬´ ì·¨ì†Œ", user, "ìš”ì²­í•˜ì‹  ì€í–‰ ì—…ë¬´ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."));
        return true;
    }
    if (msg.startsWith("/")) return false;

    var roomData = data.rooms[roomName];
    if (roomData.bankReserve === undefined) roomData.bankReserve = SYSTEM_CONFIG.ECO.BANK.INITIAL_RESERVE;

    /* [ê¸°ëŠ¥ 1] ì¶œê¸ˆ ì²˜ë¦¬ */
    if (state.type === 'withdraw') {
        var amt = parseInt(msg.replace(/,/g, ""));
        if (isNaN(amt) || amt <= 0) {
            replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜", "ì¶œê¸ˆí•  ìˆ«ìë¥¼ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”."));
        } else if (user.bank < amt) {
            replier.reply(formatError(user, "ì”ê³  ë¶€ì¡±", "í†µì¥ ì”ê³ ë³´ë‹¤ ë§ì€ ê¸ˆì•¡ì€ ì¶œê¸ˆí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        } else if (roomData.bankReserve < amt) {
            replier.reply(formatError(user, "ì€í–‰ ì§€ê¸‰ ë¶ˆëŠ¥", "ì£„ì†¡í•©ë‹ˆë‹¤. í˜„ì¬ ì€í–‰ì˜ í˜„ê¸ˆ ìœ ë™ì„±(ì‹¤ì¬ê³ )ì´ ë¶€ì¡±í•˜ì—¬ ì¶œê¸ˆì´ ì¼ì‹œ ì œí•œë©ë‹ˆë‹¤.\nëŒ€ì¶œê¸ˆ íšŒìˆ˜ ë° ìˆ˜ìˆ˜ë£Œ ì ë¦½ ì‹œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.\n\nğŸ¦ í˜„ì¬ ì€í–‰ ê¸ˆê³ : " + fp(roomData.bankReserve) + "P"));
        } else {
           // 1. ì€í–‰ ì”ê³  ê°ì‚¬ ì—”ì§„ ê°€ë™ (- ì°¨ê°)
            util_updateBank(user, roomData, -amt, "ì€í–‰ ì¶œê¸ˆ", roomName);
            
            // 2. í¬ì¸íŠ¸ ê²Œì´íŠ¸ì›¨ì´ ê°€ë™ (+ ì§€ê¸‰ ë° êµ­ê³  ì°¨ê° ì—°ë™)
            util_updatePoint(user, roomData, amt, "ì€í–‰ ì¶œê¸ˆ", roomName);
            
            replier.reply(formatCommand("ğŸ§ ì¶œê¸ˆ ì™„ë£Œ", user, fp(amt) + "Pë¥¼ í˜„ê¸ˆìœ¼ë¡œ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", "ë³´ìœ  í¬ì¸íŠ¸: " + fp(user.point) + "P"));
            
            delete bankProcessState[targetUid]; // ìƒíƒœ í•´ì œ
            safeSaveData(data); // ì¦‰ì‹œ ì €ì¥
        }
        return true;
    }

        /* [ê¸°ëŠ¥ 2] ëŒ€ì¶œ ì‹¤í–‰ */
    else if (state.type === 'loan') {
        var amt = parseInt(msg.replace(/,/g, ""));
        var cr = getCreditInfo(user.creditScore);
        var bConf = SYSTEM_CONFIG.ECO.BANK;
        var lConf = SYSTEM_CONFIG.ECO.PRIVATE_LOAN;

        var totalDeposits = 0;
        for (var id in roomData.users) { totalDeposits += (roomData.users[id].bank || 0); }
        var requiredReserve = Math.floor(totalDeposits * bConf.RESERVE_RATIO);
        var lendableAmount = roomData.bankReserve - requiredReserve;

        var cr = getCreditInfo(user.creditScore, roomName);

        if (isNaN(amt) || amt <= 0) {
            replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜", "ëŒ€ì¶œë°›ì„ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
        } else if (amt > lendableAmount) {
            var reserveInfo = "í˜„ì¬ ì€í–‰ì˜ ëŒ€ì¶œ ê°€ëŠ¥ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.\n(ì§€ê¸‰ì¤€ë¹„ìœ¨ " + (bConf.RESERVE_RATIO * 100) + "% ì¤€ìˆ˜ ì¤‘)\n\n" + "ğŸ¦ í˜„ì¬ ê¸ˆê³ : " + fp(roomData.bankReserve) + "P\n" + "ğŸ›¡ï¸ ë²•ì • ì¤€ë¹„ê¸ˆ: " + fp(requiredReserve) + "P\n" + "ğŸ’° ì‹¤ì œ ëŒ€ì¶œ ê°€ëŠ¥ì•¡: " + fp(Math.max(0, lendableAmount)) + "P";
            replier.reply(formatError(user, "ì€í–‰ ìê¸ˆ ë™ê²°", reserveInfo));
        } else if ((user.dailyLoanCount || 0) >= lConf.DAILY_LIMIT) {
            delete bankProcessState[targetUid];
            replier.reply(formatError(user, "ëŒ€ì¶œ ì œí•œ", "ëŒ€ì¶œì€ í•˜ë£¨ì— ìµœëŒ€ " + lConf.DAILY_LIMIT + "íšŒê¹Œì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."));
        } else if (amt > cr.limit) {
            replier.reply(formatError(user, "í•œë„ ì´ˆê³¼", cr.label + "ì˜ ìµœëŒ€ í•œë„ëŠ” " + fp(cr.limit) + "Pì…ë‹ˆë‹¤."));
        } else {
            user.dailyLoanCount = (user.dailyLoanCount || 0) + 1;
            
            // [ìˆ˜ì •] ëŒ€ì¶œ ì‹¤í–‰ ì‹œ íšŸìˆ˜ì™€ ìƒê´€ì—†ì´ ì¦‰ì‹œ ì‹ ìš©ì ìˆ˜ -20ì  í•˜ë½ í˜ë„í‹° ì ìš©
            user.creditScore = Math.max(0, Number(user.creditScore || 600) - 100);
            checkAndHandleDefaulter(user, roomName);

            var dynMult = (typeof util_getDynamicRateMultiplier === 'function') ? util_getDynamicRateMultiplier(roomName) : 1.0;

            // [ê¸°ë¶€ì™•] ì‹¤í–‰ ì‹œ ì„ ì´ì 30% ê°ë©´
            var rateGap = (cr.rate - 1) * dynMult;
            var finalRate = 1 + rateGap;

            var total = Math.floor(amt * finalRate);
            if (!user.loan || typeof user.loan !== 'object') user.loan = { debt: 0, items: [] };
            if (!user.loan.items) user.loan.items = [];
            user.loan.debt = Number(user.loan.debt || 0) + Number(total);
            user.loan.items.push(Number(total));
            
            util_updatePoint(user, roomData, amt, "ì€í–‰ ëŒ€ì¶œ ì‹¤í–‰", roomName);

            // [ì¶”ê°€]: ìœ ì € ìƒíƒœì— ë”°ë¥¸ ìë™ ìƒí™˜ ë¹„ìœ¨ íŒì • ë° ì•ˆë‚´ ë¬¸êµ¬ ì¡°ë¦½
            var autoRepayRate = user.isTransferred ? "70%" : (user.creditScore < 500 ? "50%" : "30%");
            var successContent = fp(amt) + "P ì…ê¸ˆ ì™„ë£Œ\n(ìƒí™˜ ì˜ˆì •ì•¡: " + fp(total) + "P)\n\n" +
                                 "ğŸ“¢ [ìë™ ìƒí™˜ ì•ˆë‚´]\n" +
                                 "í–¥í›„ ë°œìƒí•˜ëŠ” ëª¨ë“  ìˆ˜ìµì˜ " + autoRepayRate + "ê°€\n" +
                                 "ëŒ€ì¶œê¸ˆìœ¼ë¡œ ìë™ ìƒí™˜ë©ë‹ˆë‹¤.\n\n" +
                                 "ğŸ“‰ [ì‹ ìš© í•˜ë½]: ëŒ€ì¶œ ì‹¤í–‰ìœ¼ë¡œ ì ìˆ˜ê°€ -100ì  í•˜ë½í–ˆìŠµë‹ˆë‹¤.";

            replier.reply(formatCommand("ğŸ¦ ëŒ€ì¶œ ìŠ¹ì¸", user, successContent, "ë³´ìœ  í¬ì¸íŠ¸: " + fp(user.point) + "P"));
            delete bankProcessState[targetUid];
            safeSaveData(data);
        }
        return true;
    }

        /* [ê¸°ëŠ¥ 3] ìƒí™˜ ì²˜ë¦¬ */
    else if (state.type === 'repay') {
        var amt = parseInt(msg.replace(/,/g, ""));
        if (isNaN(amt) || amt <= 0) {
            replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜", "ìƒí™˜í•  ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
        } else if (user.point < amt) {
            replier.reply(formatError(user, "í¬ì¸íŠ¸ ë¶€ì¡±", "ë³´ìœ í•˜ì‹  í¬ì¸íŠ¸ê°€ ìƒí™˜ì•¡ë³´ë‹¤ ì ìŠµë‹ˆë‹¤."));
        } else {
            var res = distributeRepayment(user, amt, roomName);
            util_updatePoint(user, roomData, -Number(res.actualRepay), "ëŒ€ì¶œ ìƒí™˜", roomName);
            var currentDebt = (user.loan && user.loan.debt) ? Number(user.loan.debt) : 0;
            var repaySuccessMsg = fp(res.actualRepay) + "P ìƒí™˜ë˜ì—ˆìŠµë‹ˆë‹¤.";
            
            // ì‹ ìš© íšŒë³µ ì¡°ê±´ ë‹¬ì„± ì‹œì—ë§Œ ë¬¸êµ¬ ì‚½ì…
            if (res.creditGain > 0) {
                repaySuccessMsg += "\nğŸ“ˆ ì‹ ìš© ì ìˆ˜ +" + res.creditGain + " ìƒìŠ¹";
            }
            
            repaySuccessMsg += "\n\nğŸ¦ ì€í–‰ ì¬ì› ì¶©ì „: +" + fp(res.actualRepay) + "P";

            replier.reply(formatCommand("ğŸ“‰ ìƒí™˜ ì™„ë£Œ", user, repaySuccessMsg, "ë‚¨ì€ ëŒ€ì¶œê¸ˆ: " + fp(currentDebt) + "P"));
            delete bankProcessState[targetUid];
            safeSaveData(data);
        }
        return true;
    }
    return false;
}
            
//==========ì„¹í„°22-3==========

/* [ë…ë¦½í˜• í•¨ìˆ˜] í†µí•© ì—…ë¬´ ì²˜ë¦¬ í•¸ë“¤ëŸ¬ 3ë‹¨ê³„: ì‚¬ì±„ ë“±ë¡ ë° ë¹Œë¦¬ê¸° */
function _handleBankStep3(msg, user, data, replier, roomName, targetUid) {
    var bankProcessState = data.rooms[roomName].features.states.bankProcess;
    if (!bankProcessState || !bankProcessState[targetUid]) return false;

    var state = bankProcessState[targetUid];
    var types = ['p2p_reg_input', 'p2p_borrow_amt'];
    if (types.indexOf(state.type) === -1) return false;

    if (Date.now() - state.time > 30000) {
        delete bankProcessState[targetUid];
        replier.reply(formatError(user, "ì…ë ¥ ì‹œê°„ ì´ˆê³¼", "ì…ë ¥ ì‹œê°„ì´ 30ì´ˆë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤."));
        return true;
    }
    if (msg === "ì·¨ì†Œ") {
        delete bankProcessState[targetUid];
        replier.reply(formatCommand("ğŸš« ì—…ë¬´ ì·¨ì†Œ", user, "ì—…ë¬´ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    var roomData = data.rooms[roomName];

    /* [ê¸°ëŠ¥ 1] ì‚¬ì±„ ë“±ë¡ */
    if (state.type === 'p2p_reg_input') {
        var parts = msg.split(" ");
        if (parts.length < 2) {
            replier.reply(formatError(user, "ì…ë ¥ ì˜¤ë¥˜", "í˜•ì‹: [ê¸ˆì•¡] [ì´ìœ¨]\nì˜ˆ) 10000 5"));
        } else {
            var amt = parseInt(parts[0]);
            var rate = parseInt(parts[1]);
            var conf = SYSTEM_CONFIG.ECO.PRIVATE_LOAN;

            if (isNaN(amt) || amt < conf.MIN_AMOUNT) {
                replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜", "ìµœì†Œ " + fp(conf.MIN_AMOUNT) + "P ì´ìƒ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤."));
            } else if (isNaN(rate) || rate < 5 || rate > conf.MAX_RATE) {
                replier.reply(formatError(user, "ì´ìœ¨ ì˜¤ë¥˜", "ì´ìœ¨ì€ 5% ~ " + conf.MAX_RATE + "% ì‚¬ì´ë¡œ ì„¤ì •í•˜ì„¸ìš”."));
            } else if (user.point < amt) {
                replier.reply(formatError(user, "í¬ì¸íŠ¸ ë¶€ì¡±", "ë³´ìœ  í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."));
            } else {
                util_updatePoint(user, roomData, -amt, "ì‚¬ì±„ í’€ ë“±ë¡", roomName);
                var poolId = generateUUID();
                if (!roomData.loanPools) roomData.loanPools = {};
                roomData.loanPools[poolId] = {
                    lenderUid: targetUid, lenderName: user.name, totalAmount: amt,
                    remainingAmount: amt, rate: rate, time: Date.now()
                };

                // 3. ìƒíƒœ í•´ì œ (ì¤‘ë³µ ì…ë ¥ ë°©ì§€)
                if (bankProcessState) delete bankProcessState[targetUid];

                // 4. [ë³´ì•ˆ] ë¬¼ë¦¬ ì €ì¥ ì „ ë©´ì œê¶Œ ë¶€ì—¬ ë° ì¦‰ì‹œ ì €ì¥ ì§‘í–‰
                user.skipHealing = true; 
                safeSaveData(data, true); // ë¹„ë™ê¸° íë¥¼ ê±°ì¹˜ì§€ ì•Šê³  ì¦‰ì‹œ ë¬¼ë¦¬ íŒŒì¼ ê¸°ë¡

                replier.reply(formatCommand("ğŸ’° ì‚¬ì±„ ë“±ë¡ ì™„ë£Œ", user, fp(amt) + "P (ì´ì " + rate + "%/3h) ë§¤ë¬¼ì„ ì˜¬ë ¸ìŠµë‹ˆë‹¤.", "ë‚¨ì€ ì”ì•¡: " + fp(user.point) + "P"));
            }
        }
        return true;
    }

        /* [ê¸°ëŠ¥ 2] ì‚¬ì±„ ë¹Œë¦¬ê¸° */
    else if (state.type === 'p2p_borrow_amt') {
        var amt = parseInt(msg);
        var pool = roomData.loanPools[state.extra.poolId];
        var conf = SYSTEM_CONFIG.ECO.PRIVATE_LOAN;

        if (!pool) {
            replier.reply(formatError(user, "ë§¤ë¬¼ ì •ë³´ ì—†ìŒ", "ìœ íš¨í•˜ì§€ ì•Šì€ ë§¤ë¬¼ì…ë‹ˆë‹¤."));
        } else if (isNaN(amt) || amt < conf.MIN_BORROW) {
            replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜", "ìµœì†Œ " + fp(conf.MIN_BORROW) + "P ì´ìƒ ë¹Œë ¤ì•¼ í•©ë‹ˆë‹¤."));
        } else if (amt > pool.remainingAmount) {
            replier.reply(formatError(user, "ê¸ˆì•¡ ì´ˆê³¼", "ì”ì—¬ ê¸ˆì•¡(" + fp(pool.remainingAmount) + "P)ê¹Œì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."));
        } else if (pool.lenderUid === targetUid) {
            replier.reply(formatError(user, "ê³„ì•½ ë¶ˆê°€", "ë³¸ì¸ ì‚¬ì±„ëŠ” ë¹Œë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        } else {
            pool.remainingAmount -= amt;
            if (pool.remainingAmount <= 0) delete roomData.loanPools[state.extra.poolId];
            var initialDebt = Math.floor(amt * 1.1);
            var contractId = generateUUID();
            if (!roomData.loanContracts) roomData.loanContracts = {};
            roomData.loanContracts[contractId] = {
                lenderUid: pool.lenderUid, lenderName: pool.lenderName,
                borrowerUid: targetUid, borrowerName: user.name,
                principal: amt, currentDebt: initialDebt, rate: pool.rate,
                startTime: Date.now(), status: 'active'
            };
            util_updatePoint(user, roomData, amt, "ì‚¬ì±„ ë¹Œë¦¼ íšŒìˆ˜ ìŠ¹ì¸", roomName);
            replier.reply(formatCommand("ğŸ“ ì‚¬ì±„ ê³„ì•½ ì²´ê²°", user, pool.lenderName + "ë‹˜ìœ¼ë¡œë¶€í„° " + fp(amt) + "Pë¥¼ ë¹Œë ¸ìŠµë‹ˆë‹¤.\n(ì„ ì´ì 10% í¬í•¨ ì±„ë¬´: " + fp(initialDebt) + "P)", "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
            delete bankProcessState[targetUid];
            safeSaveData(data);
        }
        return true;
    }
    return false;
}

//==========ì„¹í„°22-4==========

/* [ë…ë¦½í˜• í•¨ìˆ˜] í†µí•© ì—…ë¬´ ì²˜ë¦¬ í•¸ë“¤ëŸ¬ 4ë‹¨ê³„: ì‚¬ì±„ ìƒí™˜/íšŒìˆ˜/ìˆ˜ê±° */
function _handleBankStep4(msg, user, data, replier, roomName, targetUid) {
    var bankProcessState = data.rooms[roomName].features.states.bankProcess;
    if (!bankProcessState || !bankProcessState[targetUid]) return false;

    var state = bankProcessState[targetUid];
    var types = ['p2p_repay_amt', 'p2p_withdraw_amt', 'p2p_collect_manual'];
    if (types.indexOf(state.type) === -1) return false;

    if (Date.now() - state.time > 30000 || msg === "ì·¨ì†Œ") {
        delete bankProcessState[targetUid];
        if (msg === "ì·¨ì†Œ") replier.reply(formatCommand("ğŸš« ì—…ë¬´ ì·¨ì†Œ", user, "ì—…ë¬´ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."));
        else replier.reply(formatError(user, "ì…ë ¥ ì‹œê°„ ì´ˆê³¼", "ì…ë ¥ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    var roomData = data.rooms[roomName];

    /* [ê¸°ëŠ¥ 1] ì‚¬ì±„ ìƒí™˜ */
    if (state.type === 'p2p_repay_amt') {
        var amt = parseInt(msg);
        var contract = roomData.loanContracts[state.extra.contractId];
        if (!contract) {
            replier.reply(formatError(user, "ê³„ì•½ ì •ë³´ ì—†ìŒ"));
        } else if (isNaN(amt) || amt <= 0 || user.point < amt) {
            replier.reply(formatError(user, "ê¸ˆì•¡/í¬ì¸íŠ¸ ì˜¤ë¥˜"));
        } else {
            var actualRepay = Math.min(amt, contract.currentDebt);
            util_updatePoint(user, roomData, -actualRepay, "ì‚¬ì±„ ìƒí™˜ ì§€ë¶ˆ", roomName);
            var lender = roomData.users[contract.lenderUid];
            if (lender) util_updatePoint(lender, roomData, actualRepay, "ì‚¬ì±„ ì´ì ìˆ˜ì…", roomName);
            
            contract.currentDebt -= actualRepay;
            var footerMsg = "ë‚¨ì€ ë¹š: " + fp(contract.currentDebt) + "P";
            if (contract.currentDebt <= 0) {
                delete roomData.loanContracts[state.extra.contractId];
                footerMsg = "ëª¨ë“  ì±„ë¬´ê°€ ë³€ì œë˜ì—ˆìŠµë‹ˆë‹¤.";
            }
            replier.reply(formatCommand("ğŸ“‰ ì‚¬ì±„ ìƒí™˜ ì™„ë£Œ", user, contract.lenderName + "ë‹˜ê»˜ " + fp(actualRepay) + "Pë¥¼ ê°šì•˜ìŠµë‹ˆë‹¤.\n" + footerMsg, "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
            delete bankProcessState[targetUid];
            safeSaveData(data);
        }
        return true;
    }

        /* [ê¸°ëŠ¥ 2] ì‚¬ì±„ ë§¤ë¬¼ íšŒìˆ˜ */
    else if (state.type === 'p2p_withdraw_amt') {
        var amt = (msg === "ì „ì•¡") ? state.extra.max : parseInt(msg);
        var pool = roomData.loanPools[state.extra.poolId];
        if (!pool) {
            replier.reply(formatError(user, "ë§¤ë¬¼ ì •ë³´ ì—†ìŒ"));
        } else if (isNaN(amt) || amt <= 0 || amt > pool.remainingAmount) {
            replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜"));
        } else {
            pool.remainingAmount -= amt;
            util_updatePoint(user, roomData, amt, "ì‚¬ì±„ í’€ ì§ì ‘ ìˆ˜ê±°", roomName);
            if (pool.remainingAmount <= 0) delete roomData.loanPools[state.extra.poolId];
            replier.reply(formatCommand("âœ… ì‚¬ì±„ íšŒìˆ˜ ì™„ë£Œ", user, fp(amt) + "Pë¥¼ íšŒìˆ˜í–ˆìŠµë‹ˆë‹¤.", "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
            delete bankProcessState[targetUid];
            safeSaveData(data);
        }
        return true;
    }

        /* [ê¸°ëŠ¥ 3] ì±„ë¬´ì ê°•ì œ ìˆ˜ê±° */
    else if (state.type === 'p2p_collect_manual') {
        var contract = roomData.loanContracts[state.extra.contractId];
        if (!contract) {
            replier.reply(formatError(user, "ê³„ì•½ ì •ë³´ ì—†ìŒ"));
        } else {
            var debtor = roomData.users[contract.borrowerUid];
            if (!debtor) {
                replier.reply(formatError(user, "ì±„ë¬´ì ì •ë³´ ì—†ìŒ"));
            } else {
                var collectAmt = Math.min(Number(debtor.point), contract.currentDebt);
                if (collectAmt <= 0) {
                    replier.reply(formatError(user, "ìˆ˜ê±° ì‹¤íŒ¨", "ì±„ë¬´ìì˜ ì§€ê°‘ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤."));
                } else {
                    util_updatePoint(debtor, roomData, -collectAmt, "ì‚¬ì±„ ê°•ì œ ìˆ˜ê±° ë‹¹í•¨", roomName);
                    util_updatePoint(user, roomData, collectAmt, "ì‚¬ì±„ ì§ì ‘ ìˆ˜ê±° ìˆ˜ìµ", roomName);
                    contract.currentDebt -= collectAmt;
                    var footer = "ë‚¨ì€ ë¹š: " + fp(contract.currentDebt) + "P";
                    if (contract.currentDebt <= 0) {
                        delete roomData.loanContracts[state.extra.contractId];
                        footer = "ëª¨ë“  ì±„ë¬´ê°€ ë³€ì œë˜ì—ˆìŠµë‹ˆë‹¤.";
                    }
                    replier.reply(formatCommand("ğŸš¬ ê°•ì œ ìˆ˜ê±° ì™„ë£Œ", user, debtor.name + "ë‹˜ì—ê²Œì„œ " + fp(collectAmt) + "Pë¥¼ ìˆ˜ê±°í–ˆìŠµë‹ˆë‹¤.\n" + footer, "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
                    safeSaveData(data);
                }
            }
        }
        delete bankProcessState[targetUid];
        return true;
    }
    return false;
}

//==========ì„¹í„°22-5==========

/* [ë…ë¦½í˜• í•¨ìˆ˜] í†µí•© ì—…ë¬´ ì²˜ë¦¬ í•¸ë“¤ëŸ¬ 5ë‹¨ê³„: ìƒì  ì•„ì´í…œ êµ¬ë§¤ ë° ìˆ˜ëŸ‰ ì²˜ë¦¬ */
function _handleBankStep5(msg, user, data, replier, roomName, targetUid) {
    var bankProcessState = data.rooms[roomName].features.states.bankProcess;
    if (!bankProcessState || !bankProcessState[targetUid]) return false;

    var state = bankProcessState[targetUid];
    var types = ['shop_buy', 'shop_quantity', 'ship_rename_input', 'ship_rename_confirm'];
    if (types.indexOf(state.type) === -1) return false;

    // [1:1 ì „ìš© ê°€ë“œ] ìƒì  ë° ì„ ë°• ê´€ë¦¬ ê¸°ëŠ¥ì€ 1:1ë°©ì—ì„œ ì°¨ë‹¨ (ìš”ì²­ ì‚¬í•­ ë°˜ì˜)
    if (ALLOWED_ROOMS.indexOf(roomName) === -1) {
        delete bankProcessState[targetUid];
        replier.reply("ğŸš« [ê¸°ëŠ¥ ì œí•œ]\nìƒì  ë° ì„ ë°• ì´ë¦„ ë³€ê²½ì€ ë‹¨ì²´ë°©('ë‚´ë¦¬ë‹¤')ì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.\n\nâœ… 1:1 ê°€ëŠ¥: ì¹´ì§€ë…¸, ì€í–‰, ë‚´ì •ë³´");
        return true;
    }

    // ê³µí†µ ë„¤ë¹„ê²Œì´ì…˜ ë°” ì •ì˜ (ì¤‘ê°„ ë‹¨ê³„ ì•ˆë‚´ìš©)
    var SHOP_NAV = "\n\nâ†©ï¸ ë’¤ë¡œ / ğŸ  ì²˜ìŒìœ¼ë¡œ / âì·¨ì†Œ";

    // 1. ê³µí†µ ê°€ë“œ ë° ì·¨ì†Œ ë¡œì§
    if (Date.now() - state.time > 30000 || msg === "ì·¨ì†Œ" || msg === "âì·¨ì†Œ") {
        delete bankProcessState[targetUid];
        var cancelMsg = state.type.indexOf('ship_') !== -1 ? "ì„ ë°• ëª…ëª… ì ˆì°¨ë¥¼ ì¤‘ë‹¨í–ˆìŠµë‹ˆë‹¤." : "ìƒì  ì´ìš©ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.";
        replier.reply(formatCommand("ğŸš« ì‘ì—… ì·¨ì†Œ", user, cancelMsg));
        return true;
    }

    if (msg === "ì²˜ìŒìœ¼ë¡œ" || msg === "ğŸ  ì²˜ìŒìœ¼ë¡œ") {
        delete bankProcessState[targetUid];
        return _gameShopLogic("/ìƒì ", user, data, replier, roomName, targetUid);
    }

    if (msg === "ë’¤ë¡œ" || msg === "â†©ï¸ ë’¤ë¡œ") {
        // [ìˆ˜ì •] ê° ìƒíƒœë³„ë¡œ í•œ ë‹¨ê³„ ì „ ë©”ë‰´ë¡œ ëŒì•„ê°€ë„ë¡ ë¶„ê¸° ì²˜ë¦¬
        if (state.type === 'shop_quantity') {
            var prevItems = state.extra.prevItems || [];
            bankProcessState[targetUid] = { type: 'shop_buy', time: Date.now(), extra: { items: prevItems } };
            var list = prevItems.map(function(it, i) { return (i + 1) + ". " + it.icon + " " + it.name + " : " + fp(getItemPrice(it, user, roomName)) + "P"; });
            replier.reply(formatCommand("ğŸ›’ ìƒì  ë¬¼í’ˆ ëª©ë¡", user, list.join("\n") + SHOP_NAV, "êµ¬ë§¤í•  ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
        } else if (state.type === 'shop_buy' || state.type === 'ship_rename_input') {
            delete bankProcessState[targetUid];
            return _gameShopLogic("/ìƒì ", user, data, replier, roomName, targetUid);
        } else if (state.type === 'ship_rename_confirm') {
            // í™•ì¸ì°½ì—ì„œ ë’¤ë¡œê°€ë©´ ë‹¤ì‹œ ì´ë¦„ ì…ë ¥ì°½ìœ¼ë¡œ ì´ë™
            bankProcessState[targetUid] = { type: 'ship_rename_input', time: Date.now(), extra: state.extra };
            replier.reply(formatCommand("ğŸ“ ì„ ë°• ì´ë¦„ ì…ë ¥", user, "ë³€ê²½í•˜ì‹¤ ì„ ë°•ì˜ ì´ë¦„ì„ ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(2~8ì, ë„ì–´ì“°ê¸° í¬í•¨)" + SHOP_NAV, "ì·¨ì†Œ: [ì·¨ì†Œ]"));
        }
        return true;
    }

    // 2. ì„ ë°• ì´ë¦„ ì…ë ¥ ì²˜ë¦¬ (ë„ì–´ì“°ê¸° ìˆ˜ìš© ë° í™•ì¸ ë‹¨ê³„ë¡œ ì´ë™)
    if (state.type === 'ship_rename_input') {
        var inputName = msg.trim(); // ì•ë’¤ ê³µë°±ë§Œ ì œê±°í•˜ì—¬ ì¤‘ê°„ ë„ì–´ì“°ê¸° ë³´ì¡´
        if (inputName.length < 2 || inputName.length > 8) {
            replier.reply(formatError(user, "ì´ë¦„ ê¸¸ì´ ì˜¤ë¥˜", "2~8ê¸€ì ì‚¬ì´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”." + SHOP_NAV));
            return true;
        }
        if (!/^[a-zA-Z0-9ê°€-í£\s]+$/.test(inputName)) {
            replier.reply(formatError(user, "ì‚¬ìš© ë¶ˆê°€ ë¬¸ì", "íŠ¹ìˆ˜ë¬¸ìëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤." + SHOP_NAV));
            return true;
        }
        
        var isDup = false;
        for (var r in data.rooms) { 
            for (var uId in data.rooms[r].users) { 
                if (data.rooms[r].users[uId].shipName === inputName) { isDup = true; break; } 
            } 
            if (isDup) break; 
        }
        if (isDup) { replier.reply(formatError(user, "ì´ë¦„ ì¤‘ë³µ", "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë¦„ì…ë‹ˆë‹¤." + SHOP_NAV)); return true; }

        // í™•ì¸ ë‹¨ê³„(Confirm) ìƒíƒœë¡œ ì „ì´
        bankProcessState[targetUid] = { 
            type: 'ship_rename_confirm', 
            time: Date.now(), 
            extra: { newName: inputName, price: state.extra.price } 
        };
        
        var confirmMsg = "ìƒˆë¡œìš´ ì„ ë°• ì´ë¦„: [" + inputName + "]\n\nì´ ì´ë¦„ìœ¼ë¡œ ìµœì¢… ê²°ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê²°ì • ì‹œ ì´ë¦„ë³€ê²½ê¶Œì´ ì¦‰ì‹œ ì‚¬ìš©ë©ë‹ˆë‹¤.\n\n1. ì˜ˆ (ë³€ê²½ ìŠ¹ì¸)\n2. ì•„ë‹ˆì˜¤ (ì¬ì…ë ¥)" + SHOP_NAV;
        replier.reply(formatCommand("âš“ ì„ ë°• ëª…ëª… í™•ì¸", user, confirmMsg, "ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”."));
        return true;
    }

    // 3. ì„ ë°• ì´ë¦„ ìµœì¢… í™•ì • (ë¡œì§ ì¢…ë£Œ ì§€ì  - ëŒ€ê¸° ì‚­ì œ ë° ë„¤ë¹„ê²Œì´ì…˜ ì œê±°)
    if (state.type === 'ship_rename_confirm') {
        if (msg === "1" || msg === "ì˜ˆ") {
            var finalName = state.extra.newName;
            var cost = state.extra.price || 0;
            
            // [ì¢…ë£Œ ì²˜ë¦¬] ê²°ì œ ì§ì „ ëŒ€ê¸°ì—´ì„ ë¨¼ì € ì‚­ì œí•˜ì—¬ ì¤‘ë³µ ì…ë ¥ì„ ì°¨ë‹¨í•©ë‹ˆë‹¤.
            delete bankProcessState[targetUid];

            if (Number(user.point) < cost) {
                replier.reply(formatError(user, "ê²°ì œ ì‹¤íŒ¨", "ì”ì•¡ì´ ë¶€ì¡±í•˜ì—¬ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."));
                return true;
            }
            
            util_updatePoint(user, data.rooms[roomName], -cost, "ì„ ë°• ì´ë¦„ ë³€ê²½ê¶Œ ì‚¬ìš©", roomName);
            user.shipName = finalName;
            
            // [ì™„ë£Œ ë©”ì‹œì§€] ëë‚˜ëŠ” ì§€ì ì´ë¯€ë¡œ SHOP_NAV ì—†ì´ ê¹”ë”í•˜ê²Œ ì¶œë ¥
            replier.reply(formatCommand("ğŸš¢ ì„ ë°• ëª…ëª…ì‹ ì™„ë£Œ", user, "ì„±ê³µì ìœ¼ë¡œ [" + finalName + "](ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!", "ë¬´ì—­ í˜„í™©: [/ë¬´ì—­]"));
            safeSaveData(data);
        return true; // ë¡œì§ ì¢…ë£Œ ëª…ì‹œ
        } else if (msg === "2" || msg === "ì•„ë‹ˆì˜¤") {
            bankProcessState[targetUid] = { type: 'ship_rename_input', time: Date.now(), extra: state.extra };
            replier.reply(formatCommand("ğŸ“ ì„ ë°• ì´ë¦„ ì…ë ¥", user, "ë³€ê²½í•˜ì‹¤ ì´ë¦„ì„ ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”." + SHOP_NAV));
            return true; // ë¡œì§ ì¢…ë£Œ ëª…ì‹œ
        }
        return true;
    }
    if (msg.startsWith("/")) {
        delete bankProcessState[targetUid];
        return false;
    }

    var roomData = data.rooms[roomName];

    /* [ê¸°ëŠ¥ 1] ìƒì  ì•„ì´í…œ ë²ˆí˜¸ ì„ íƒ ì²˜ë¦¬ */
    if (state.type === 'shop_buy') {
        var idx = parseInt(msg.replace(/[^0-9]/g, "")) - 1;
        var filteredItems = (state.extra && state.extra.items) ? state.extra.items : [];

        if (isNaN(idx) || idx < 0 || idx >= filteredItems.length) {
            replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "ëª©ë¡ì— ìˆëŠ” ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”." + SHOP_NAV));
        } else {
            var item = filteredItems[idx];

            /* ì˜ˆì™¸ ì²˜ë¦¬ 1: ì‹ ìš© ì ìˆ˜ íšŒë³µì œ ì¼ì¼ ì œí•œ */
            if (item.effect === "credit" && (user.dailyCreditRestoreCount || 0) >= 1) {
                delete bankProcessState[targetUid];
                replier.reply(formatError(user, "êµ¬ë§¤ ì œí•œ", "ì‹ ìš© ì ìˆ˜ íšŒë³µì œëŠ” í•˜ë£¨ì— 1ê°œë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤."));
                return true;
            }

            /* ì˜ˆì™¸ ì²˜ë¦¬ 2: ê²½ê³ ì‚­ì œê¶Œ ì œí•œ ë¡œì§ (í‰ìƒ 1íšŒ + ì‚¬ì±„ ë³´ìœ  ì‹œ ë¶ˆê°€) */
            if (item.effect === "warnClear") {
                if (user.boughtWarningRemoval === true) {
                    delete bankProcessState[targetUid];
                    replier.reply(formatError(user, "êµ¬ë§¤ ë¶ˆê°€", "ê²½ê³ ì‚­ì œê¶Œì€ í‰ìƒ ë‹¨ 1íšŒë§Œ êµ¬ë§¤ ê°€ëŠ¥í•©ë‹ˆë‹¤."));
                    return true;
                }
                var hasSache = false;
                if (roomData.loanContracts) {
                    for (var cid in roomData.loanContracts) {
                        if (roomData.loanContracts[cid].borrowerUid === targetUid) { hasSache = true; break; }
                    }
                }
                if (hasSache) {
                    delete bankProcessState[targetUid];
                    replier.reply(formatError(user, "êµ¬ë§¤ ì œí•œ", "ì‚¬ì±„ë¥¼ ëª¨ë‘ ìƒí™˜í•œ í›„ì—ë§Œ êµ¬ë§¤ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤."));
                    return true;
                }
            }

            /* ì˜ˆì™¸ ì²˜ë¦¬ 3: ê²Œì„ ì¸ì¦ê¶Œ ì‹œì¦Œ 2íšŒ ì œí•œ */
            if (item.effect === "gameAuth" && (user.purchasedAuthCount || 0) >= 2) {
                delete bankProcessState[targetUid];
                replier.reply(formatError(user, "êµ¬ë§¤ í•œë„ ì´ˆê³¼", "ì¸ì¦ê¶Œì€ ì‹œì¦Œë‹¹ ìµœëŒ€ 2íšŒê¹Œì§€ë§Œ êµ¬ë§¤ ê°€ëŠ¥í•©ë‹ˆë‹¤."));
                return true;
            }

            // ìˆ˜ëŸ‰ ì…ë ¥ ë‹¨ê³„ë¡œ ì „í™˜ ì‹œ í˜„ì¬ ì•„ì´í…œ ëª©ë¡ì„ ì €ì¥(ë’¤ë¡œê°€ê¸°ìš©)
            if (["promotion", "tierGuard", "randomBox", "spitto", "trade_cargo"].indexOf(item.effect) !== -1) {
                var itemPrice = getItemPrice(item, user, roomName); 
                bankProcessState[targetUid] = { 
                    type: 'shop_quantity', 
                    time: Date.now(), 
                    extra: { item: item, prevItems: filteredItems } // prevItems ì¶”ê°€
                };
                
                var quantityInfo = "êµ¬ë§¤í•˜ì‹¤ [" + item.name + "]ì˜ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n\n" +
                                   "ğŸ’µ ê°œë‹¹ ê°€ê²©: " + fp(itemPrice) + "P\n" +
                                   "ğŸ’° ë³´ìœ  í¬ì¸íŠ¸: " + fp(user.point) + "P" + SHOP_NAV;
                                   
                replier.reply(formatCommand("ğŸ”¢ ìˆ˜ëŸ‰ ì…ë ¥", user, quantityInfo, "ì·¨ì†Œ: [ì·¨ì†Œ]"));
            } else {
                /* ë‹¨ê¶Œ êµ¬ë§¤ ë¡œì§ */
                var finalPrice = getItemPrice(item, user, roomName);
                var isUsingTicket = (item.effect === "randomBox" && (user.boxTickets || 0) > 0);

                if (!isUsingTicket && Number(user.point) < finalPrice) {
                    delete bankProcessState[targetUid];
                    replier.reply(formatError(user, "í¬ì¸íŠ¸ ë¶€ì¡±", fp(finalPrice) + "Pê°€ í•„ìš”í•©ë‹ˆë‹¤."));
                } else {
                    var hasItem = false;
                    if (item.effect === "icon" || item.effect === "title") {
                        var inv = user.inventory || [];
                        for (var i = 0; i < inv.length; i++) { if (inv[i].id === item.id) { hasItem = true; break; } }
                    }

                    if (hasItem) {
                        delete bankProcessState[targetUid];
                        replier.reply(formatError(user, "ì¤‘ë³µ ì†Œìœ ", "ì´ë¯¸ ë³´ìœ  ì¤‘ì¸ ì•„ì´í…œì…ë‹ˆë‹¤."));
                    } else {
                        var isDelayedBilling = (item.effect === "ship_rename");

                       if (!isUsingTicket && !isDelayedBilling) {
                            util_updatePoint(user, roomData, -finalPrice, "ìƒì  êµ¬ë§¤: " + item.name, roomName);
                        }
                        delete bankProcessState[targetUid];
                        if (typeof _handleShopEffect === 'function') _handleShopEffect(item, user, roomName, replier, data, targetUid, finalPrice, isUsingTicket, 1);
                    } // closes else (M)
                } // closes else (H)
            } // closes else (E/107í–‰) <--- [êµì •] ì´ ì¤‘ê´„í˜¸ê°€ ëˆ„ë½ë˜ì–´ ìˆì—ˆìŠµë‹ˆë‹¤!
            return true;
        } // closes if (state.type === 'shop_buy')
    }

    /* [ê¸°ëŠ¥ 2] ìˆ˜ëŸ‰ ì…ë ¥ ì²˜ë¦¬ (ë¡œì§ ì¢…ë£Œ ì§€ì ) */
    else if (state.type === 'shop_quantity') {
        var item = (state.extra && state.extra.item) ? state.extra.item : null;
        if (!item) { delete bankProcessState[targetUid]; return true; }

        var qty = parseInt(msg.replace(/[^0-9]/g, ""));
        if (isNaN(qty) || qty <= 0) {
            // ë‹¤ì‹œ ì…ë ¥ì„ ê¸°ë‹¤ë¦¬ëŠ” êµ¬ê°„ì€ ë‚´ë¹„ê²Œì´ì…˜ ë°” í¬í•¨
            replier.reply(formatError(user, "ì…ë ¥ ì˜¤ë¥˜", "ìˆ«ìë¡œ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." + SHOP_NAV));
        } else {
            var multiplier = util_getEcoMultiplier(roomName);
            var basePrice = Math.floor(Number(item.price) * multiplier);
            if (user.title === "ìˆ˜ì§‘ëŒ€ë§ˆì™•") basePrice = Math.floor(basePrice * 0.85);
            
            var totalPrice = 0;

            if (item.id === 8) { 
                var count = Number(user.purchasedPromotionAttempts || 0);
                var d = Math.floor(basePrice * 0.10); // í• ì¦ ë‹¨ìœ„ (10%)
                
                // ë“±ì°¨ìˆ˜ì—´ì˜ í•© ê³µì‹: Sn = n/2 * [2a + (n-1)d]
                // a = í˜„ì¬ ì‚´ ìˆ˜ ìˆëŠ” ì²« ë²ˆì§¸ ìœ ë‹›ì˜ ê°€ê²©
                var a = basePrice + (d * count);
                totalPrice = Math.round((qty / 2) * (2 * a + (qty - 1) * d));
            } else {
                totalPrice = getItemPrice(item, user, roomName) * qty; 
            }

            if (Number(user.point) < totalPrice) {

                replier.reply(formatError(user, "í¬ì¸íŠ¸ ë¶€ì¡±", "ì´ " + fp(totalPrice) + "Pê°€ í•„ìš”í•©ë‹ˆë‹¤." + SHOP_NAV));
            } else {
                // [ì¢…ë£Œ ì²˜ë¦¬] ê²°ì œê°€ ì„±ê³µí–ˆìœ¼ë¯€ë¡œ ëŒ€ê¸° ìƒíƒœë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.
                delete bankProcessState[targetUid]; 

                if (item.effect !== "trade_cargo") {
                    util_updatePoint(user, roomData, -totalPrice, "ìƒì  êµ¬ë§¤: " + item.name + " x" + qty, roomName);
                }
                
                // ìµœì¢… íš¨ê³¼ ë°œë™ (ë©”ì‹œì§€ëŠ” ì„¹í„° 30ì—ì„œ ë„¤ë¹„ê²Œì´ì…˜ ì—†ì´ ì¶œë ¥ë¨)
                if (typeof _handleShopEffect === 'function') {
                    _handleShopEffect(item, user, roomName, replier, data, targetUid, totalPrice, false, qty);
                }
                return true; 
            }
        } 
        return true; 
    } 
    return false;
}

//==========ì„¹í„°23-1==========

/* [ë…ë¦½í˜• í•¨ìˆ˜] ë©”ë‰´ ì„ íƒ ëŒ€ê¸° ì²˜ë¦¬ 1ë‹¨ê³„ (ë©”ì¸ ë©”ë‰´ ë¶„ê¸°) */
function _handleMenuStep1(msg, user, data, replier, roomName, targetUid) {
    var menuWaitState = data.rooms[roomName].features.states.menuWait;
    if (!menuWaitState || !menuWaitState[targetUid]) return false;

    var state = menuWaitState[targetUid];
    var now = Date.now();

    // 1. [ì‹œê°„ ì´ˆê³¼ ì²´í¬] 30ì´ˆ í†µì¼
    if (now - state.time > 30000) {
        delete menuWaitState[targetUid];
        replier.reply(formatError(user, "ì…ë ¥ ì‹œê°„ ì´ˆê³¼", "30ì´ˆ ì´ë‚´ì— ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì§€ ì•Šì•„ ë©”ë‰´ê°€ ë‹«í˜”ìŠµë‹ˆë‹¤."));
        return true;
    }

    // 2. ì·¨ì†Œ ì…ë ¥ ì‹œ ì²˜ë¦¬
    if (msg === "ì·¨ì†Œ") {
        delete menuWaitState[targetUid];
        replier.reply(formatCommand("ğŸš« ë©”ë‰´ ì„ íƒ ì·¨ì†Œ", user, "ì‘ì—…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    // 3. [ëª…ë ¹ì–´ ê°€ë“œ] ëª…ë ¹ì–´(/) ì…ë ¥ ì‹œ ëŒ€ê¸° ìƒíƒœë¥¼ ìœ ì§€í•˜ë˜, ì²˜ë¦¬ëŠ” í•˜ìœ„ ë¡œì§ì— ìœ„ì„
    if (msg.startsWith("/")) {
        return false;
    }

    var roomData = data.rooms[roomName];
    // ì¤‘ì•™ì€í–‰ ì¬ì› ì´ˆê¸°í™” (UI ì¶œë ¥ìš©)
    if (roomData.bankReserve === undefined) roomData.bankReserve = SYSTEM_CONFIG.ECO.BANK.INITIAL_RESERVE;

    var choice = msg.trim();
    var bankProcessState = roomData.features.states.bankProcess; // ìƒíƒœê°’ í• ë‹¹ì„ ìœ„í•´ ì°¸ì¡°

    /* [1ë‹¨ê³„] ì€í–‰ ë©”ì¸ ë©”ë‰´ ì„ íƒ ì²˜ë¦¬ (v5.2 ê¸°ë¶€ ì„ íƒ ì¶”ê°€) */
    if (state.type === 'bank_menu') {
        delete menuWaitState[targetUid]; // ë©”ë‰´ ì„ íƒ ì™„ë£Œ ì‹œ ëŒ€ê¸° ìƒíƒœ í•´ì œ

        if (choice === "1") {
            bankProcessState[targetUid] = { type: 'deposit', time: Date.now() };
            replier.reply(formatCommand("ğŸ’° ì˜ˆê¸ˆ ì§„í–‰", user, "ì˜ˆê¸ˆí•  ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(ë³´ìœ : " + fp(user.point) + "P)", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
        } else if (choice === "2") {
            bankProcessState[targetUid] = { type: 'withdraw', time: Date.now() };
            replier.reply(formatCommand("ğŸ§ ì¶œê¸ˆ ì§„í–‰", user, "ì¶œê¸ˆí•  ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(ì”ê³ : " + fp(user.bank) + "P)", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
        } else if (choice === "3") {
            bankProcessState[targetUid] = { type: 'transfer', time: Date.now() };
            replier.reply(formatCommand("ğŸ’¸ ì†¡ê¸ˆ ì§„í–‰", user, "ë°›ì„ ì‚¬ëŒì˜ [ë‹‰ë„¤ì„]ê³¼ [ê¸ˆì•¡]ì„ ë„ì–´ì“°ê¸°ë¡œ ì…ë ¥í•˜ì„¸ìš”.\n(ì˜ˆ: í™ê¸¸ë™ 5000)", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
        } else if (choice === "4") {
            var cr = getCreditInfo(user.creditScore);
            if (cr.limit <= 0) {
                replier.reply(formatError(user, "ëŒ€ì¶œ ë¶ˆê°€", "ì‹ ìš©ë“±ê¸‰ì´ ë„ˆë¬´ ë‚®ìŠµë‹ˆë‹¤."));
            } else {
                bankProcessState[targetUid] = { type: 'loan', time: Date.now() };
                var loanMsg = "í¬ë§ ëŒ€ì¶œê¸ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n" +
                              "ë‚´ í•œë„: " + fp(cr.limit) + "P (ì´ìœ¨: " + ((cr.rate - 1) * 100).toFixed(0) + "%)\n" +
                              "ğŸ¦ ì€í–‰ ê°€ìš© ì¬ì›: " + fp(roomData.bankReserve) + "P";
                replier.reply(formatCommand("ğŸ¦ ëŒ€ì¶œ ì§„í–‰", user, loanMsg, "ì·¨ì†Œ: [ì·¨ì†Œ]"));
            }
        } else if (choice === "5") {
            if (!user.loan || user.loan.debt <= 0) {
                replier.reply(formatError(user, "ìƒí™˜ ë¶ˆê°€", "ê°šì„ ëŒ€ì¶œê¸ˆì´ ì—†ìŠµë‹ˆë‹¤."));
            } else {
                bankProcessState[targetUid] = { type: 'repay', time: Date.now() };
                replier.reply(formatCommand("ğŸ“‰ ìƒí™˜ ì§„í–‰", user, "ìƒí™˜í•  ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(ëŒ€ì¶œ ì”ì•¡: " + fp(user.loan.debt) + "P)\në³´ìœ  í¬ì¸íŠ¸: " + fp(user.point) + "P", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
            }
        } else if (choice === "6") {
            // [ì¤‘ìš”] ì‚¬ì±„ ë©”ë‰´ ì„ íƒ ì‹œì—ëŠ” bankProcessê°€ ì•„ë‹Œ menuWaitStateë¥¼ ê°±ì‹ í•´ì•¼ í•¨ (ì„œë¸Œ ë©”ë‰´ ì´ë™)
            menuWaitState[targetUid] = { type: 'p2p_loan_menu', time: Date.now() };
            var p2pMenu = "1. ğŸ’° ì‚¬ì±„ ë“±ë¡ (ë§¤ë¬¼ ì˜¬ë¦¬ê¸°)\n" +
                          "2. ğŸ“‹ ì‚¬ì±„ ëª©ë¡ (ë¶„í•  ëŒ€ì¶œ ë°›ê¸°)\n" +
                          "3. ğŸ“‰ ì‚¬ì±„ ìƒí™˜ (ë¹Œë¦° ëˆ ê°šê¸°)\n" +
                          "4. ğŸ“¥ ì‚¬ì±„ íšŒìˆ˜ (ë“±ë¡ ë§¤ë¬¼ íšŒìˆ˜)\n" +
                          "5. ğŸ‘¥ ë‚´ ì±„ë¬´ì í˜„í™© (ì§ì ‘ ìˆ˜ê±° ê°€ëŠ¥)";
            replier.reply(formatCommand("ğŸš¬ ì‚¬ì±„ ì‹œì¥ ì—…ë¬´ ì„ íƒ", user, p2pMenu, "ì›í•˜ì‹œëŠ” ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
            return true; // ì—¬ê¸°ì„œ true ë°˜í™˜í•˜ì—¬ ì¢…ë£Œ (ë‹¤ìŒ ë¡œì§ ìˆ˜í–‰ X)
        } else if (choice === "7") {
            bankProcessState[targetUid] = { type: 'donate', time: Date.now() };
            replier.reply(formatCommand("ğŸ ê¸°ë¶€ ì§„í–‰", user, "ê¸°ë¶€í•  ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(ë³´ìœ : " + fp(user.point) + "P)", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
        } else {
            // ì˜ëª»ëœ ë²ˆí˜¸ ì…ë ¥ ì‹œ ë‹¤ì‹œ ë©”ë‰´ ëŒ€ê¸° ìƒíƒœë¡œ ë³µêµ¬? 
            // ê¸°íš ì˜ë„ìƒ ë©”ë‰´ê°€ ë‹«íˆëŠ” ê²Œ ì¼ë°˜ì ì´ë¯€ë¡œ ì—ëŸ¬ ë©”ì‹œì§€ í›„ ì¢…ë£Œ ì²˜ë¦¬
            replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "ì˜¬ë°”ë¥¸ ë©”ë‰´ ë²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."));
        }
        return true;
    }
    return false; // ì´ í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬í•˜ì§€ ì•Šì€ state.typeì¸ ê²½ìš° (ì˜ˆ: p2p_loan_menu ë“±)
}

//==========ì„¹í„°23-2==========

/* [ë…ë¦½í˜• í•¨ìˆ˜] ë©”ë‰´ ì„ íƒ ëŒ€ê¸° ì²˜ë¦¬ 2ë‹¨ê³„ (ì‚¬ì±„ ì‹œì¥ ì„œë¸Œ ë©”ë‰´) */
function _handleMenuStep2(msg, user, data, replier, roomName, targetUid) {
    var menuWaitState = data.rooms[roomName].features.states.menuWait;
    if (!menuWaitState || !menuWaitState[targetUid]) return false;

    var state = menuWaitState[targetUid];
    // ì´ í•¨ìˆ˜ëŠ” 'p2p_loan_menu' íƒ€ì…ë§Œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
    if (state.type !== 'p2p_loan_menu') return false;

    // 1. [ì‹œê°„ ì´ˆê³¼ ë° ì·¨ì†Œ ê°€ë“œ]
    if (Date.now() - state.time > 30000 || msg === "ì·¨ì†Œ") {
        delete menuWaitState[targetUid];
        if (msg === "ì·¨ì†Œ") replier.reply(formatCommand("ğŸš« ì‚¬ì±„ ì—…ë¬´ ì·¨ì†Œ", user, "ì‘ì—…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."));
        else replier.reply(formatError(user, "ì…ë ¥ ì‹œê°„ ì´ˆê³¼", "30ì´ˆ ì´ë‚´ì— ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì§€ ì•Šì•„ ë©”ë‰´ê°€ ë‹«í˜”ìŠµë‹ˆë‹¤."));
        
        // ëª…ë ¹ì–´ ì…ë ¥ ì‹œì—ëŠ” falseë¥¼ ë°˜í™˜í•˜ì—¬ í•˜ìœ„ ë¡œì§ìœ¼ë¡œ ì „ë‹¬
        if (msg.startsWith("/")) return false;
        return true;
    }

    // 2. [ëª…ë ¹ì–´ í†µë¡œ]
    if (msg.startsWith("/")) {
        delete menuWaitState[targetUid];
        return false;
    }

    var choice = msg.trim();
    var roomData = data.rooms[roomName];
    var bankProcessState = roomData.features.states.bankProcess;

    // ì„ íƒì§€ ì²˜ë¦¬ ì‹œì‘ (ì¼ë‹¨ í˜„ì¬ ëŒ€ê¸° ìƒíƒœ í•´ì œ)
    delete menuWaitState[targetUid];

    if (choice === "1") {
        bankProcessState[targetUid] = { type: 'p2p_reg_input', time: Date.now() };
        replier.reply(formatCommand("ğŸ’° ì‚¬ì±„ ë§¤ë¬¼ ë“±ë¡", user, "ë“±ë¡í•  [ê¸ˆì•¡]ê³¼ [ì´ìœ¨]ì„ ì…ë ¥í•˜ì„¸ìš”.\n(ì˜ˆ: 10000 5)", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
    }
    else if (choice === "2") {
        var pools = Object.keys(roomData.loanPools || {});
        if (pools.length === 0) {
            replier.reply(formatSimple("ğŸ“‹ ì‚¬ì±„ ì‹œì¥", "í˜„ì¬ ë“±ë¡ëœ ë§¤ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.", null));
        } else {
            var list = []; 
            var tempPools = [];
            for(var i=0; i<pools.length; i++) {
                var p = roomData.loanPools[pools[i]];
                list.push((i+1) + ". [" + p.lenderName + "] ì”ì—¬: " + fp(p.remainingAmount) + "P (" + p.rate + "%)");
                tempPools.push(pools[i]);
            }
            menuWaitState[targetUid] = { type: 'p2p_select_pool', time: Date.now(), extra: { pools: tempPools } };
            replier.reply(formatCommand("ğŸ“‹ ì‚¬ì±„ ë§¤ë¬¼ ëª©ë¡", user, list.join("\n"), "ë¹Œë¦¬ê³  ì‹¶ì€ ë§¤ë¬¼ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
        }
    }
    else if (choice === "3") {
        var myContracts = [];
        if (roomData.loanContracts) {
            for(var id in roomData.loanContracts) {
                if(roomData.loanContracts[id].borrowerUid === targetUid) myContracts.push({ id: id, data: roomData.loanContracts[id] });
            }
        }
        if (myContracts.length === 0) {
            replier.reply(formatError(user, "ë‚´ì—­ ì—†ìŒ", "í˜„ì¬ ì´ ë°©ì—ì„œ ë¹Œë ¤ ì“°ê³  ìˆëŠ” ì‚¬ì±„ê°€ ì—†ìŠµë‹ˆë‹¤."));
        } else {
            var list = [];
            for(var i=0; i<myContracts.length; i++) {
                var c = myContracts[i].data;
                list.push((i+1) + ". [" + c.lenderName + "] ì±„ë¬´ì•¡: " + fp(c.currentDebt) + "P (ì´ìœ¨ " + c.rate + "%)");
            }
            menuWaitState[targetUid] = { type: 'p2p_select_repay', time: Date.now(), extra: { contracts: myContracts.map(function(x){return x.id;}) } };
            replier.reply(formatCommand("ğŸ“‰ ì‚¬ì±„ ìƒí™˜ ì„ íƒ", user, list.join("\n"), "ê°šì„ ì‚¬ì±„ì˜ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”."));
        }
    }
    else if (choice === "4") {
        var myPools = [];
        if (roomData.loanPools) {
            for(var id in roomData.loanPools) {
                if(roomData.loanPools[id].lenderUid === targetUid) myPools.push({ id: id, data: roomData.loanPools[id] });
            }
        }
        if (myPools.length === 0) {
            replier.reply(formatError(user, "ë‚´ì—­ ì—†ìŒ", "ì´ ë°©ì— ì˜¬ë ¤ë‘” ì‚¬ì±„ í’€ì´ ì—†ìŠµë‹ˆë‹¤."));
        } else {
            var list = [];
            for(var i=0; i<myPools.length; i++) {
                var p = myPools[i].data;
                list.push((i+1) + ". ì”ì—¬: " + (p.remainingAmount) + "P (ì´ìœ¨ " + p.rate + "%/3h)");
            }
            menuWaitState[targetUid] = { type: 'p2p_select_withdraw', time: Date.now(), extra: { pools: myPools.map(function(x){return x.id;}) } };
            replier.reply(formatCommand("ğŸ“¥ ì‚¬ì±„ í’€ íšŒìˆ˜", user, list.join("\n"), "íšŒìˆ˜í•  ì‚¬ì±„ í’€ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”."));
        }
    }
    else if (choice === "5") {
        var myDebtors = [];
        if (roomData.loanContracts) {
            for(var id in roomData.loanContracts) {
                if(roomData.loanContracts[id].lenderUid === targetUid) myDebtors.push({ id: id, data: roomData.loanContracts[id] });
            }
        }
        if (myDebtors.length === 0) {
            replier.reply(formatSimple("ğŸ‘¥ ë‚´ ì±„ë¬´ì í˜„í™©", "í˜„ì¬ ëˆì„ ë¹Œë ¤ ê°„ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.", null));
        } else {
            var list = [];
            var tempContracts = [];
            for(var i=0; i<myDebtors.length; i++) {
                var d = myDebtors[i].data;
                var status = (Date.now() - d.startTime > 24*60*60*1000) ? " (ğŸš¨ì—°ì²´)" : "";
                list.push((i+1) + ". [" + d.borrowerName + "] ë¹š: " + fp(d.currentDebt) + "P" + status);
                tempContracts.push(myDebtors[i].id);
            }
            menuWaitState[targetUid] = { type: 'p2p_select_collect', time: Date.now(), extra: { contracts: tempContracts } };
            replier.reply(formatCommand("ğŸ‘¥ ë‚´ ì±„ë¬´ì ëª…ë‹¨", user, list.join("\n"), "ê°•ì œ ìˆ˜ê±°ë¥¼ ì›í•˜ì‹œë©´ ìœ ì € ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
        }
    }
    else {
        // ì˜ëª»ëœ ë²ˆí˜¸ ì…ë ¥ ì²˜ë¦¬
        replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "ì˜¬ë°”ë¥¸ ë©”ë‰´ ë²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."));
    }

    return true;
}

//==========ì„¹í„°23-3==========

/* [ë…ë¦½í˜• í•¨ìˆ˜] ë©”ë‰´ ì„ íƒ ëŒ€ê¸° ì²˜ë¦¬ 3ë‹¨ê³„ (ì‚¬ì±„ ëª©ë¡ ì„ íƒ) */
function _handleMenuStep3(msg, user, data, replier, roomName, targetUid) {
    var menuWaitState = data.rooms[roomName].features.states.menuWait;
    if (!menuWaitState || !menuWaitState[targetUid]) return false;

    var state = menuWaitState[targetUid];
    // ì´ í•¨ìˆ˜ê°€ ì²˜ë¦¬í•  íƒ€ì… ëª©ë¡ ì •ì˜ (ì‚¬ì±„ ê´€ë ¨ ì„ íƒì§€ë“¤)
    var types = ['p2p_select_pool', 'p2p_select_repay', 'p2p_select_withdraw', 'p2p_select_collect'];
    if (types.indexOf(state.type) === -1) return false;

    // 1. [ì‹œê°„ ì´ˆê³¼ ë° ì·¨ì†Œ ê°€ë“œ]
    if (Date.now() - state.time > 30000 || msg === "ì·¨ì†Œ") {
        delete menuWaitState[targetUid];
        if (msg === "ì·¨ì†Œ") replier.reply(formatCommand("ğŸš« ì‚¬ì±„ ì—…ë¬´ ì·¨ì†Œ", user, "ì‘ì—…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."));
        else replier.reply(formatError(user, "ì…ë ¥ ì‹œê°„ ì´ˆê³¼", "30ì´ˆ ì´ë‚´ì— ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì§€ ì•Šì•„ ë©”ë‰´ê°€ ë‹«í˜”ìŠµë‹ˆë‹¤."));
        
        if (msg.startsWith("/")) return false;
        return true;
    }

    // 2. [ëª…ë ¹ì–´ í†µë¡œ]
    if (msg.startsWith("/")) {
        delete menuWaitState[targetUid];
        return false;
    }

    var choice = msg.trim();
    var roomData = data.rooms[roomName];
    var bankProcessState = roomData.features.states.bankProcess;

    /* [ì„ íƒ ë¶„ê¸° 1] ì‚¬ì±„ ë¹Œë¦¬ê¸° ë§¤ë¬¼ ì„ íƒ */
    if (state.type === 'p2p_select_pool') {
        delete menuWaitState[targetUid];
        var idx = parseInt(choice) - 1;
        var poolId = (state.extra && state.extra.pools) ? state.extra.pools[idx] : null;
        
        if (!poolId || !roomData.loanPools[poolId]) {
            replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "ëª©ë¡ì— ìˆëŠ” ë²ˆí˜¸ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”."));
        } else {
            bankProcessState[targetUid] = { type: 'p2p_borrow_amt', time: Date.now(), extra: { poolId: poolId } };
            replier.reply(formatCommand("ğŸ’° ì‚¬ì±„ ê¸ˆì•¡ ì„¤ì •", user, "ì„ íƒ ë§¤ë¬¼: [" + roomData.loanPools[poolId].lenderName + "]\nì”ì—¬ ê¸ˆì•¡: " + fp(roomData.loanPools[poolId].remainingAmount) + "P\n\në¹Œë¦´ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
        }
        return true;
    }

    /* [ì„ íƒ ë¶„ê¸° 2] ì‚¬ì±„ ìƒí™˜ ëŒ€ìƒ ì„ íƒ */
    else if (state.type === 'p2p_select_repay') {
        delete menuWaitState[targetUid];
        var idx = parseInt(choice) - 1;
        var contractId = (state.extra && state.extra.contracts) ? state.extra.contracts[idx] : null;
        
        if (!contractId || !roomData.loanContracts[contractId]) {
            replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "ìƒí™˜í•  ê³„ì•½ ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."));
        } else {
            bankProcessState[targetUid] = { type: 'p2p_repay_amt', time: Date.now(), extra: { contractId: contractId } };
            var contract = roomData.loanContracts[contractId];
            replier.reply(formatCommand("ğŸ“‰ ì‚¬ì±„ ìƒí™˜ì•¡ ì…ë ¥", user, "ì±„ê¶Œì: [" + contract.lenderName + "]\në‚¨ì€ ë¹š: " + fp(contract.currentDebt) + "P\nğŸ’° ë‚´ ì”ì•¡: " + fp(user.point) + "P\n\nê°šì„ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
        }
        return true;
    }

    /* [ì„ íƒ ë¶„ê¸° 3] ì‚¬ì±„ ë§¤ë¬¼ íšŒìˆ˜ ëŒ€ìƒ ì„ íƒ */
    else if (state.type === 'p2p_select_withdraw') {
        delete menuWaitState[targetUid];
        var idx = parseInt(choice) - 1;
        var poolId = (state.extra && state.extra.pools) ? state.extra.pools[idx] : null;
        
        if (!poolId || !roomData.loanPools[poolId]) {
            replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜"));
        } else {
            bankProcessState[targetUid] = { type: 'p2p_withdraw_amt', time: Date.now(), extra: { poolId: poolId, max: roomData.loanPools[poolId].remainingAmount } };
            replier.reply(formatCommand("ğŸ“¥ íšŒìˆ˜ ê¸ˆì•¡ ì…ë ¥", user, "í˜„ì¬ í’€ ì”ì•¡: " + fp(roomData.loanPools[poolId].remainingAmount) + "P\n\níšŒìˆ˜í•  ê¸ˆì•¡ì„ ì…ë ¥í•˜ê±°ë‚˜ [ì „ì•¡]ì„ ì…ë ¥í•˜ì„¸ìš”.", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
        }
        return true;
    }

    /* [ì„ íƒ ë¶„ê¸° 4] ì±„ë¬´ì ê°•ì œ ìˆ˜ê±° ëŒ€ìƒ ì„ íƒ */
    else if (state.type === 'p2p_select_collect') {
        delete menuWaitState[targetUid];
        var idx = parseInt(choice) - 1;
        var contractId = (state.extra && state.extra.contracts) ? state.extra.contracts[idx] : null;
        
        if (!contractId || !roomData.loanContracts[contractId]) {
            replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜"));
        } else {
            bankProcessState[targetUid] = { type: 'p2p_collect_manual', time: Date.now(), extra: { contractId: contractId } };
            replier.reply(formatCommand("ğŸš¬ ì‚¬ì±„ ê°•ì œ ìˆ˜ê±° í™•ì¸", user, "[" + roomData.loanContracts[contractId].borrowerName + "]ë‹˜ì˜ ì§€ê°‘ì—ì„œ ìì‚°ì„ ìˆ˜ê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì§„í–‰í•˜ì‹œë ¤ë©´ ì•„ë¬´ ë©”ì‹œì§€ë‚˜ ì…ë ¥í•´ì£¼ì„¸ìš”.", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
        }
        return true;
    }

    return false;
}

//==========ì„¹í„°23-4==========

/* [ë…ë¦½í˜• í•¨ìˆ˜] ë©”ë‰´ ì„ íƒ ëŒ€ê¸° ì²˜ë¦¬ 4ë‹¨ê³„ (ìƒì /ë„ì›€ë§/ê°€ì´ë“œ) */
function _handleMenuStep4(msg, user, data, replier, roomName, targetUid) {
    // [í•µì‹¬] ìˆ«ì ì…ë ¥ ì‹œì—ëŠ” ë©”ì¸ ë°©ì´ ì•„ë‹ˆë¼ 'í˜„ì¬ ìœ ì €ê°€ ìˆëŠ” ë°©(1:1ë°©)'ì˜ ëŒ€ê¸° ìƒíƒœë¥¼ í™•ì¸í•´ì•¼ í•¨
    var currentRoomData = data.rooms[roomName]; 
    if (!currentRoomData || !currentRoomData.features) return false;
    
    var menuWaitState = currentRoomData.features.states.menuWait;

    if (!menuWaitState || !menuWaitState[targetUid]) return false;

    var state = menuWaitState[targetUid];
    // ì²˜ë¦¬ ê°€ëŠ¥ íƒ€ì…ì— ë¬´ì—­(trade) ê´€ë ¨ ìƒíƒœë“¤ì„ ì¼ê´„ ì¶”ê°€
    var types = [
        'shop_category', 'shop_detail', 'help', 'guide_menu', 
        'trade_main', 'trade_market', 'trade_depart', 'trade_status', 'trade_ship',
        'trade_select_cargo', // <-- í•˜ì—­ ì„¤ì • ë‹¨ê³„ ì¸ì‹ ì¶”ê°€
        'casino_main', 'casino_ladder', 'casino_baccarat',
        'casino_ladder_sub', 'casino_baccarat_sub' 
    ];
    if (types.indexOf(state.type) === -1) return false;

    // 1. [ì‹œê°„ ì´ˆê³¼ ë° ì·¨ì†Œ ê°€ë“œ]
    if (Date.now() - state.time > 30000 || msg === "ì·¨ì†Œ") {
        delete menuWaitState[targetUid];
        if (msg === "ì·¨ì†Œ") {
            replier.reply(formatCommand("ğŸš« ë©”ë‰´ ì„ íƒ ì·¨ì†Œ", user, "ì‘ì—…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."));
        } else {
            replier.reply(formatError(user, "ì„ íƒ ì‹œê°„ ì´ˆê³¼", "30ì´ˆ ì´ë‚´ì— ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì§€ ì•Šì•„ ë©”ë‰´ê°€ ë‹«í˜”ìŠµë‹ˆë‹¤."));
        }
        
        if (msg.startsWith("/")) return false;
        return true;
    }

    /**
     * [ìƒì  ì „ìš© ë„¤ë¹„ê²Œì´ì…˜: ë’¤ë¡œ / ì²˜ìŒìœ¼ë¡œ]
     * ê¸°ëŠ¥: ìœ ì €ê°€ ì¹´í…Œê³ ë¦¬ë‚˜ ìƒì„¸ ë©”ë‰´ì—ì„œ ìƒìœ„ ë‹¨ê³„ë¡œ ì´ë™
     */
    if (state.type.startsWith('shop_')) {
        if (msg === "ì²˜ìŒìœ¼ë¡œ" || msg === "ğŸ  ì²˜ìŒìœ¼ë¡œ") {
            delete menuWaitState[targetUid];
            return _gameShopLogic("/ìƒì ", user, data, replier, roomName, targetUid);
        }
        if (msg === "ë’¤ë¡œ" || msg === "â†©ï¸ ë’¤ë¡œ") {
            if (state.type === 'shop_category') {
                delete menuWaitState[targetUid];
                replier.reply(formatCommand("ğŸ›’ ìƒì  ì¢…ë£Œ", user, "ìƒì  ì´ìš©ì„ ì¢…ë£Œí•˜ê³  í‡´ê±°í–ˆìŠµë‹ˆë‹¤."));
            } else {
                // ìƒì„¸ ë©”ë‰´ì—ì„œ ë’¤ë¡œê°€ë©´ ìƒì  ë©”ì¸(ì¹´í…Œê³ ë¦¬ ì„ íƒ)ìœ¼ë¡œ ì´ë™
                return _gameShopLogic("/ìƒì ", user, data, replier, roomName, targetUid);
            }
            return true;
        }
    }

    /**
     * [ë¬´ì—­ ì „ìš© ë„¤ë¹„ê²Œì´ì…˜: ë’¤ë¡œ / ì²˜ìŒìœ¼ë¡œ]
     * ê¸°ëŠ¥: ìœ ì €ê°€ ì–´ëŠ ë‹¨ê³„ì—ì„œë“  ìƒìœ„ ë©”ë‰´ë¡œ ì´ë™í•  ìˆ˜ ìˆê²Œ ì²˜ë¦¬
     */
    if (state.type.startsWith('trade_')) {
        if (msg === "ì²˜ìŒìœ¼ë¡œ") {
            // ë¬´ì—­ ë©”ì¸ ë¡œì§ì„ ë‹¤ì‹œ í˜¸ì¶œí•˜ì—¬ ì´ˆê¸° í™”ë©´ìœ¼ë¡œ ì´ë™
            if (typeof _gameTradeLogic === 'function') {
                _gameTradeLogic("/ë¬´ì—­", user, data, replier, roomName, targetUid);
                return true;
            }
        }
        if (msg === "ë’¤ë¡œ") {
            if (state.type === 'trade_main') {
                delete menuWaitState[targetUid];
                replier.reply(formatCommand("â›µ ë¬´ì—­ ì¢…ë£Œ", user, "ë¬´ì—­ ì§€ë¶€ì—ì„œ í‡´ê±°í•˜ì˜€ìŠµë‹ˆë‹¤."));
            } else if (state.type === 'trade_select_cargo') {
                // í•˜ì—­ ì„¤ì •ì—ì„œ ë’¤ë¡œê°€ë©´ ëª©ì ì§€ ì„ íƒ(ì¶œí•­ ì¤€ë¹„) í™”ë©´ìœ¼ë¡œ ì´ë™
                _prepareVoyage(user, replier, tradeCfg, roomData);
                menuWaitState[targetUid] = { type: 'trade_depart', time: Date.now(), depth: 2 };
            } else {
                // ê·¸ ì™¸ ìƒì„¸ ë©”ë‰´(ì‹œì„¸, ì¶œí•­ì¤€ë¹„ ë“±)ì—ì„œ ë’¤ë¡œê°€ë©´ ë¬´ì—­ ë©”ì¸ìœ¼ë¡œ ì´ë™
                _gameTradeLogic("/ë¬´ì—­", user, data, replier, roomName, targetUid);
            }
            return true;
        }
    }

    /**
     * [ì¹´ì§€ë…¸ ì „ìš© ë„¤ë¹„ê²Œì´ì…˜: ë’¤ë¡œ / ì²˜ìŒìœ¼ë¡œ]
     * ê¸°ëŠ¥: ì¹´ì§€ë…¸ ì–´ëŠ ë‹¨ê³„ì—ì„œë“  ìƒìœ„ ë©”ë‰´ë‚˜ í™€ë¡œ ì´ë™ ê°€ëŠ¥
     */
    if (state.type.startsWith('casino_')) {
        if (msg === "ì²˜ìŒìœ¼ë¡œ") {
            if (typeof _gameCasinoLogic === 'function') {
                _gameCasinoLogic("/ì¹´ì§€ë…¸", user, data, replier, roomName, targetUid);
                return true;
            }
        }
        if (msg === "ë’¤ë¡œ") {
            if (state.type === 'casino_main') {
                delete menuWaitState[targetUid];
                replier.reply(formatCommand("ğŸ° ì¹´ì§€ë…¸ í‡´ì¥", user, "ì¹´ì§€ë…¸ í™€ì—ì„œ í‡´ê±°í•˜ì˜€ìŠµë‹ˆë‹¤."));
            } else if (state.type.endsWith('_sub')) {
                // ìƒì„¸ í™”ë©´(sub)ì—ì„œ ë’¤ë¡œ ê°ˆ ê²½ìš°, í•´ë‹¹ ê²Œì„ì˜ ë©”ë‰´(1 ë˜ëŠ” 2)ë¥¼ ë‹¤ì‹œ í˜¸ì¶œ
                var parentChoice = state.type.indexOf('ladder') !== -1 ? "1" : "2";
                menuWaitState[targetUid].type = 'casino_main'; // ìƒíƒœë¥¼ ë¶€ëª¨ë¡œ ì„ì‹œ ë³µêµ¬ í›„ í˜¸ì¶œ
                if (typeof _gameCasinoLogic === 'function') {
                    _gameCasinoLogic(parentChoice, user, data, replier, roomName, targetUid);
                }
            } else {
                // ê²Œì„ ë©”ë‰´ì—ì„œ ë’¤ë¡œ ê°ˆ ê²½ìš° ì¹´ì§€ë…¸ ë©”ì¸ìœ¼ë¡œ ì´ë™
                if (typeof _gameCasinoLogic === 'function') {
                    _gameCasinoLogic("/ì¹´ì§€ë…¸", user, data, replier, roomName, targetUid);
                }
            }
            return true;
        }
    }

    // 2. [ëª…ë ¹ì–´ í†µë¡œ]
    if (msg.startsWith("/")) {
        delete menuWaitState[targetUid];
        return false;
    }

    var choice = msg.replace(/[^0-9]/g, "").trim();
    var bankProcessState = data.rooms[roomName].features.states.bankProcess;

    /* [ê¸°ëŠ¥ 1] ìƒì  ì¹´í…Œê³ ë¦¬ ì„ íƒ */
    if (state.type === 'shop_category') {
        var catId = parseInt(choice);
        if (isNaN(catId) || !SHOP_CATEGORIES[catId]) {
            delete menuWaitState[targetUid];
            replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "ì˜¬ë°”ë¥¸ ì¹´í…Œê³ ë¦¬ ë²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."));
        } 
        // 5ë²ˆ(íŠ¹ìˆ˜/ë³µê¶Œ) ì¹´í…Œê³ ë¦¬ ì„ íƒ ì‹œ ì„œë¸Œ ë©”ë‰´ë¡œ ë¶„ê¸°
        else if (catId === 5) {
            menuWaitState[targetUid] = { type: 'shop_detail', category: '5', time: Date.now() };
            
            // [ìˆ˜ì •] ìŠ¤í”¼ë˜ ê°€ê²© ìë™ ê³„ì‚° (ì„¤ì •ê°’ * ë¬¼ê°€ë°°ìœ¨)
            var spittoBase = SYSTEM_CONFIG.ECO.SPITTO.PRICE;
            var spittoPrice = Math.floor(spittoBase * util_getEcoMultiplier(roomName));

            var lotteryMenu = "ì›í•˜ì‹œëŠ” ë³µê¶Œ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.\n\n" +
                              "1. ë¡œë˜ (ì¶”ì²¨ì‹: 22:00 ë°œí‘œ)\n" +
                              "2. ìŠ¤í”¼ë˜ (ì¦‰ì„ì‹: " + fp(spittoPrice) + "P)";
            
            replier.reply(formatCommand("ğŸ« íŠ¹ìˆ˜/ë³µê¶Œ ìƒì ", user, lotteryMenu, "ì·¨ì†Œ: [ì·¨ì†Œ] / ì…ë ¥ ëŒ€ê¸°: 30ì´ˆ"));
        }

        else if (catId === 6) {
            var filteredItems = [];
            for (var i = 0; i < SHOP_ITEMS.length; i++) {
                if (SHOP_ITEMS[i].cat === 6) filteredItems.push(SHOP_ITEMS[i]);
            }
            var list = [];
            for (var j = 0; j < filteredItems.length; j++) {
                var item = filteredItems[j];
                list.push((j + 1) + ". " + item.icon + " " + item.name + " : " + fp(getItemPrice(item, user, roomName)) + "P");
            }
            // ìƒì  êµ¬ë§¤ ëŒ€ê¸° ìƒíƒœë¡œ ì „í™˜
            bankProcessState[targetUid] = { type: 'shop_buy', time: Date.now(), extra: { items: filteredItems } };
            delete menuWaitState[targetUid]; 
            var shopContent = list.join("\n") + "\n\nğŸ’° ë³´ìœ  í¬ì¸íŠ¸: " + fp(user.point) + "P";
            replier.reply(formatCommand("ğŸ›’ " + SHOP_CATEGORIES[6], user, shopContent, "êµ¬ë§¤í•  ë¬¼í’ˆì˜ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
        }

        else {
            var filteredItems = [];
            for (var i = 0; i < SHOP_ITEMS.length; i++) {
                if (SHOP_ITEMS[i].cat === catId) filteredItems.push(SHOP_ITEMS[i]);
            }

            if (filteredItems.length === 0) {
                delete menuWaitState[targetUid];
                replier.reply(formatSimple("ğŸ›’ ìƒì  ì•Œë¦¼", "í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì— ë¬¼í’ˆì´ ì—†ìŠµë‹ˆë‹¤.", "ë‹¤ë¥¸ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”."));
            } else {
                var list = [];
                for (var j = 0; j < filteredItems.length; j++) {
                    var item = filteredItems[j];
                    list.push((j + 1) + ". " + item.icon + " " + item.name + " : " + fp(getItemPrice(item, user, roomName)) + "P");
                }
                bankProcessState[targetUid] = { type: 'shop_buy', time: Date.now(), extra: { items: filteredItems } };
                delete menuWaitState[targetUid]; // ë©”ë‰´ ëŒ€ê¸° í•´ì œ -> ìƒì  êµ¬ë§¤ ëŒ€ê¸° ì§„ì…
                var shopContent = list.join("\n") + "\n\nğŸ’° ë³´ìœ  í¬ì¸íŠ¸: " + fp(user.point) + "P";
                replier.reply(formatCommand("ğŸ›’ " + SHOP_CATEGORIES[catId], user, shopContent, "êµ¬ë§¤í•  ë¬¼í’ˆì˜ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
            }
        }
        return true;
    }

/* [ê¸°ëŠ¥ 1-1] ìƒì  ìƒì„¸ ì„ íƒ (ë³µê¶Œ ì¹´í…Œê³ ë¦¬ ë‚´ ë²ˆí˜¸ ì„ íƒ ì²˜ë¦¬) */
    else if (state.type === 'shop_detail') {
        delete menuWaitState[targetUid]; // ìƒì„¸ ì„ íƒ ì§„ì… ì‹œ ë©”ë‰´ ëŒ€ê¸° í•´ì œ
        
        if (state.category === '5') { // ë³µê¶Œ ì¹´í…Œê³ ë¦¬ì¸ ê²½ìš°
            if (choice === "1") { // ë¡œë˜ ì„ íƒ ì‹œ
                var lottoItem = null;
                for(var i=0; i<SHOP_ITEMS.length; i++) { 
                    if(SHOP_ITEMS[i].effect === "lotto") { lottoItem = SHOP_ITEMS[i]; break; } 
                }
                // ë¡œë˜ëŠ” ë‹¨ê¶Œ êµ¬ë§¤ì´ë¯€ë¡œ ë°”ë¡œ êµ¬ë§¤ í™•ì¸ ë‹¨ê³„ë¡œ ì´ë™
                bankProcessState[targetUid] = { type: 'shop_buy', time: Date.now(), extra: { items: [lottoItem] } };
                _handleBankStep5("1", user, data, replier, roomName, targetUid);
            } 
            else if (choice === "2") { // ìŠ¤í”¼ë˜ ì„ íƒ ì‹œ
                var spittoItem = null;
                for(var i=0; i<SHOP_ITEMS.length; i++) { 
                    if(SHOP_ITEMS[i].effect === "spitto") { spittoItem = SHOP_ITEMS[i]; break; } 
                }
                // ìŠ¤í”¼ë˜ëŠ” ì—¬ëŸ¬ ê°œ êµ¬ë§¤ê°€ ê°€ëŠ¥í•˜ë¯€ë¡œ ìˆ˜ëŸ‰ ì…ë ¥ ë‹¨ê³„ë¡œ ì´ë™
                bankProcessState[targetUid] = { type: 'shop_quantity', time: Date.now(), extra: { item: spittoItem } };
                replier.reply(formatCommand("ğŸ”¢ ìŠ¤í”¼ë˜ ìˆ˜ëŸ‰ ì…ë ¥", user, "êµ¬ë§¤í•˜ì‹¤ [ìŠ¤í”¼ë˜ ë³µê¶Œ]ì˜ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
            } 
            else {
                replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "1ë²ˆ(ë¡œë˜) ë˜ëŠ” 2ë²ˆ(ìŠ¤í”¼ë˜)ì„ ì„ íƒí•´ì£¼ì„¸ìš”."));
            }
        }
        return true;
    }

    /**
     * [ê¸°ëŠ¥ 4] ë¬´ì—­ ì‹œìŠ¤í…œ ë©”ë‰´ ë¶„ê¸° ì²˜ë¦¬
     * ì„¤ëª…: ì„¹í„° 51ì— ì •ì˜ë  ë¬´ì—­ ì—”ì§„ìœ¼ë¡œ ì„ íƒ ë²ˆí˜¸ë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤.
     */
    if (state.type.startsWith('trade_')) {
        if (typeof _gameTradeLogic === 'function') {
            _gameTradeLogic(msg, user, data, replier, roomName, targetUid);
            return true;
        }
    }

    /**
     * [ê¸°ëŠ¥ 5] í†µí•© ì¹´ì§€ë…¸ ë©”ë‰´ ë¶„ê¸° ì²˜ë¦¬
     * ì„¤ëª…: ì„¹í„° 52ì— ì •ì˜ë  ì¹´ì§€ë…¸ ì—”ì§„ìœ¼ë¡œ ì„ íƒ ë²ˆí˜¸ë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤.
     */
    if (state.type.startsWith('casino_')) {
        if (typeof _gameCasinoLogic === 'function') {
            _gameCasinoLogic(msg, user, data, replier, roomName, targetUid);
            return true;
        }
    }

    /* [ê¸°ëŠ¥ 2] ë„ì›€ë§ ë©”ë‰´ ì„ íƒ */
    else if (state.type === 'help') {
        delete menuWaitState[targetUid];
        var helpBody = ""; var next = "";
        var targetCat = "";
        
        if (choice === "1") { targetCat = "ì¡°íšŒ"; next = "ë‚´ ì •ë³´ í™•ì¸: [/ë‚´ì •ë³´]"; }
        else if (choice === "2") { targetCat = "ê²Œì„"; next = "ì¹´ì§€ë…¸ ì´ìš©: [/ì¹´ì§€ë…¸]"; }
        else if (choice === "3") { targetCat = "ìƒì "; next = "ìƒì  í™•ì¸: [/ìƒì ]"; }
        else if (choice === "4") { targetCat = "ê²½ì œ"; next = "ì€í–‰ ë° ì‚¬ì±„ ë©”ë‰´: [/ì€í–‰]"; }
        else if (choice === "5") { targetCat = "ë¶€ë™ì‚°"; next = "ì‹œì„¸ í™•ì¸: [/ëœë“œë§ˆí¬]"; }
        else if (choice === "6") { targetCat = "ê´‘ì‚°"; next = "ì±„êµ´ ì‹œì‘: [/ê´‘ì‚°ì‹œì‘]"; }
        else if (choice === "7") { targetCat = "ì •ë¶€"; next = "ì •ì±… í™•ì¸: [/ì˜íšŒ]"; }
        else if (choice === "8") { targetCat = "ë¬´ì—­"; next = "ë¬´ì—­ ì‹œì‘: [/ë¬´ì—­]"; }
        
        if (targetCat !== "") {
            var list = [];
            for(var i=0; i<CMD_LIST.user.length; i++) {
                var c = CMD_LIST.user[i];
                if(c.cat === targetCat) list.push("â€¢ " + c.cmd + ": " + c.desc);
            }
            helpBody = list.join("\n");
        } 
        else if (choice === "9" && isAdmin(user.name, data, targetUid)) { // ê´€ë¦¬ì ë²ˆí˜¸ 8 -> 9 ì´ë™ ì™„ë£Œ
            var list = [];
            var displayIdx = 1;
            for(var i=0; i<CMD_LIST.admin.length; i++) {
                var a = CMD_LIST.admin[i];
                // hidden ì†ì„±ì´ trueì¸ ëª…ë ¹ì–´ëŠ” ë¦¬ìŠ¤íŠ¸ì— ë„£ì§€ ì•Šê³  í†µê³¼
                if (a.hidden === true) continue; 
                
                list.push(displayIdx + ". " + a.cmd + " " + a.desc);
                displayIdx++;
            }
            helpBody = "âš™ï¸ [ê´€ë¦¬ì ì „ìš© ëª…ë ¹ì–´]\n" + list.join("\n"); 
            next = "ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ì‹ ì¤‘íˆ ì‚¬ìš©í•˜ì„¸ìš”.";
        }
        
        if (helpBody !== "") { 
            replier.reply(formatCommand("ğŸ“– ìƒì„¸ ë„ì›€ë§", null, helpBody, next)); 
        } else {
            replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "ì˜¬ë°”ë¥¸ ë²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."));
        }
        return true;
    }

    /* [ê¸°ëŠ¥ 3] ê°€ì´ë“œ ë©”ë‰´ ì„ íƒ */
    else if (state.type === 'guide_menu') {
        delete menuWaitState[targetUid];
        var guideBody = "";
        var guideTitle = "";

        if (choice === "1") {
            guideTitle = "ğŸ›ï¸ ì¤‘ì•™ì€í–‰ ë° ì‹ ìš© ê²½ì œ";
            guideBody = "â€¢ ì¤‘ì•™ì€í–‰ ì¬ì›: ìƒì  ìˆ˜ìµ, ë„ë°• íŒ¨ë°°ê¸ˆ ë“±ì´ ê¸ˆê³ ë¡œ ì ë¦½ë©ë‹ˆë‹¤.\n" + "â€¢ ì§€ê¸‰ì¤€ë¹„ì œë„: ì´ ì˜ˆê¸ˆì˜ 20%ëŠ” ëŒ€ì¶œ ë¶ˆê°€í•œ ì¤€ë¹„ê¸ˆì…ë‹ˆë‹¤. ê¸ˆê³  ê³ ê°ˆ ì‹œ ì¶œê¸ˆì´ ì œí•œë©ë‹ˆë‹¤.\n" + "â€¢ ìë™ ìƒí™˜: ë¹š ë³´ìœ  ì‹œ ìˆ˜ìµì˜ ì¼ë¶€ê°€ ê°•ì œ ìƒí™˜ë©ë‹ˆë‹¤.\n" + "  (ì€í–‰ëŒ€ì¶œ 30% / ì‹ ë¶ˆÂ·ì‚¬ì±„ 50% / ëŒ€í™˜ 70%)";
        }
        else if (choice === "2") {
            guideTitle = "ğŸ‡ ì¤‘ì•™ ê²½ë§ˆ ì‹œìŠ¤í…œ";
            guideBody = "â€¢ ë°°íŒ…: ë§¤ì‹œ 00~49ë¶„ ì°¸ì—¬, ì •ê°ì— ê²°ê³¼ ë°œí‘œ ë° ì •ì‚°.\n" + "â€¢ ë‹¹ì²¨ê¸ˆ: 10% êµ­ê³  ìˆ˜ìˆ˜ë£Œ ì œì™¸ í›„ ì§€ë¶„ë§Œí¼ ë¶„í•  ì§€ê¸‰.\n" + "â€¢ í•˜í•œ ë³´ì¥: ë‹¹ì²¨ ì‹œ ë°°íŒ…ì•¡ì˜ ìµœì†Œ 7ë°° ë°°ë‹¹ì„ ì€í–‰ì´ ë³´ì „í•´ë“œë¦½ë‹ˆë‹¤.\n" + "â€¢ ìƒí•œ ì œí•œ: ë…ì  ë°©ì§€ë¥¼ ìœ„í•´ ë°°íŒ…ì•¡ì˜ ìµœëŒ€ 7ë°°ê¹Œì§€ë§Œ ìˆ˜ë ¹ ê°€ëŠ¥í•©ë‹ˆë‹¤.";
        }
        else if (choice === "3") {
            guideTitle = "ğŸ“ˆ ë¶€ë™ì‚° ì‹œì„¸ ë° íˆ¬ì";
            guideBody = "â€¢ ìš´ì˜: 07:00 ~ 23:59 (10ë¶„ë§ˆë‹¤ ë³€ë™)\n" + "â€¢ ì„¸ê¸ˆ: ë§¤ê° ì‹œ íŒë§¤ ê¸ˆì•¡ì˜ 5%ê°€ ì–‘ë„ì†Œë“ì„¸ë¡œ ìë™ ì°¨ê°ë©ë‹ˆë‹¤.\n" + "â€¢ ë°°ë‹¹ê¸ˆ: ëœë“œë§ˆí¬ 6ì¢…ì€ ì‹œê°„ë‹¹ 10,000P ìˆ˜ìµì´ ë°œìƒí•©ë‹ˆë‹¤.(ì§€ë¶„ì—ë”°ë¼ ë‹¨ë¦¬ ì¦ê°€)";
        }
        else if (choice === "4") {
            guideTitle = "ğŸ° í†µí•© ì¹´ì§€ë…¸ ë° ë¡œë˜";
            guideBody = "â€¢ ì‚¬ë‹¤ë¦¬: [ë‹¨ì¼] 1.9ë°°, [ì¡°í•©] 4.0ë°° ë‹¹ì²¨ê¸ˆ ì§€ê¸‰. (2ë¶„ ì£¼ê¸°)\n" +
                        "â€¢ ë°”ì¹´ë¼: í”Œë ˆì´ì–´, ë±…ì»¤, íƒ€ì´ ë°°íŒ… ì§€ì›. (3ë¶„ ì£¼ê¸°)\n" +
                        "â€¢ ë¸”ë™ì­: AI ë”œëŸ¬ì™€ ìˆ˜ì‹¸ì›€, 21ì— ê·¼ì ‘í•˜ë©´ ìŠ¹ë¦¬! (ì‹¤ì‹œê°„)\n" +
                        "â€¢ íŠ¹ì§•: ê²°ê³¼ëŠ” ê²Œì„ë°© ë‚´ì—ì„œë§Œ 'ì‹¤ì‹œê°„'ìœ¼ë¡œ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.\n" +
                        "â€¢ ë¡œë˜: 1~15 ì¤‘ 3ê°œ ìˆ«ì ì„ íƒ. ë§¤ì¼ 22ì‹œ ìë™ ì¶”ì²¨ ë° ì´ì›”.";
        }
        else if (choice === "5") {
            guideTitle = "â›ï¸ í™œë™ ë° ìˆ˜ìµ";
            guideBody = "â€¢ ê´‘ì‚°: ë°©ì¹˜í˜• ìˆ˜ìµí˜• í™œë™. ì±„ë¬´ ë³´ìœ  ì‹œ ê·¼ë¡œ ì˜ìš• ê³ ì·¨ë¡œ íš¨ìœ¨ì´ 1.5ë°° ìƒìŠ¹í•©ë‹ˆë‹¤.\n" + "â€¢ ìœ ë¬¼: ì±„êµ´ ì¤‘ 0.1% í™•ë¥ ë¡œ ë°œê²¬. ì¡°ê° ìˆ˜ì§‘ëŸ‰ì— ë”°ë¼ [ë„êµ´ì™•] ë“± 5ë‹¨ê³„ ì¹­í˜¸ê°€ ë¶€ì—¬ë©ë‹ˆë‹¤.\n" + "â€¢ ë„ë‘‘ì§ˆ: íƒ€ì¸ ìì‚° 10% ê°•íƒˆ. [ì¡ì•˜ë‹¤ìš”ë†ˆ] ëŒ€ì‘ ì‹œ ë²Œê¸ˆ ë° ê°ì˜¥ 1ì‹œê°„ì´ ë¶€ê³¼ë©ë‹ˆë‹¤.";
        }
        else if (choice === "6") {
            guideTitle = "ğŸ ë¯¼ìƒ ì§€ì› ë° ë³µì§€";
            guideBody = "â€¢ ì§€ì›ê¸ˆ: ì‹¤ì§ˆ ìˆœìì‚°ì´ í‰ê· ì˜ 40% ë¯¸ë§Œì¸ ì„œë¯¼ ìœ ì €ì—ê²Œ í•˜ë£¨ í•œ ë²ˆ ì§€ê¸‰ë©ë‹ˆë‹¤.\n" + "â€¢ ìì‚°ê°€ ì¹­í˜¸: ì´ ìì‚°(ê°€ìš©+ì£¼ì‹+ì±„ê¶Œ-ë¶€ì±„) ëŒíŒŒ ì‹œ ì¬ë²Œ, ê±°ìƒ ë“± ì˜êµ¬ ì†Œì¥ ì¹­í˜¸ë¥¼ íšë“í•©ë‹ˆë‹¤.";
        }

        else if (choice === "7") {
            guideTitle = "ğŸ›ï¸ ì •ë¶€ ë° íˆ¬í‘œ ê°€ì´ë“œ";
            guideBody = "â€¢ ë°œì˜: ë§¤ì¼ 20:00 ìƒˆë¡œìš´ ì•ˆê±´ì´ ìë™ ìƒì •ë©ë‹ˆë‹¤.\n" +
                        "â€¢ íˆ¬í‘œ: 20:00 ~ 23:50 ì‚¬ì´ ì°¸ì—¬ ê°€ëŠ¥ ([/íˆ¬í‘œ ì°¬ì„±|ë°˜ëŒ€])\n" +
                        "â€¢ ê°€ì¤‘: ì•„ì´ì–¸~ì‹¤ë²„(1í‘œ) / ê³¨ë“œ~ì—ë©”(2í‘œ) / ë‹¤ì´ì•„~(3í‘œ)\n" +
                        "â€¢ ë³´ìƒ: íˆ¬í‘œ ì¦‰ì‹œ ê±°ë§ˆë¹„ 500Pê°€ êµ­ê³ ì—ì„œ ì§€ê¸‰ë©ë‹ˆë‹¤.\n" +
                        "â€¢ ì˜ê²°: ë‹¹ì¼ ì¶œì„ ì¸ì›ì˜ 50% ë¯¸ë§Œ ì°¸ì—¬ ì‹œ ë¬´ì¡°ê±´ ê¸°ê°ë©ë‹ˆë‹¤.\n" +
                        "â€¢ ë°œíš¨: ê°€ê²°ëœ ì•ˆê±´ì€ ë‹¤ìŒ ë‚  00:05ë¶€í„° ì‹œìŠ¤í…œì— ë°˜ì˜ë©ë‹ˆë‹¤.";
        }
        else if (choice === "8") {
        guideTitle = "ğŸ‘‘ ëœë“œë§ˆí¬ í™•ì • ë°°ë‹¹ ì‹œìŠ¤í…œ";
        guideBody = "6ëŒ€ í•µì‹¬ ì‹œì„¤ì˜ ìµœëŒ€ì£¼ì£¼ì—ê²ŒëŠ” ë§¤ì¼ 00:00ì— ì‹¤ì‹œê°„ ëˆ„ì ëœ 'í™•ì • ë°°ë‹¹ê¸ˆ'ì´ ì§€ê¸‰ë©ë‹ˆë‹¤.\n\n" +
                    "[ğŸ’° ì‹œê°„ì œ í™•ì • ë°°ë‹¹ ê³µì‹]\n" +
                    "ìµœì¢… ë°°ë‹¹ê¸ˆ = (ê¸°ë³¸ ìˆ˜ìµ Ã— ê²½ê³¼ ì‹œê°„) Ã— â­ì§€ë¶„ ë³´ë„ˆìŠ¤\n\n" +
                    "1ï¸âƒ£ ê¸°ë³¸ ìˆ˜ìµ: ì‹œê°„ë‹¹ 10,000P í™•ì • ì ë¦½\n" +
                    "2ï¸âƒ£ ì¼ì¼ ì´ì•¡: ìì • ì •ì‚° ì‹œ 240,000P (24ì‹œê°„ ê¸°ì¤€)\n\n" +
                    "[â­ ì§€ë¶„ ë³´ë„ˆìŠ¤ ì‹œìŠ¤í…œ]\n" +
                    "ë³´ìœ  ì§€ë¶„ì´ 10ê°œë¥¼ ì´ˆê³¼í•˜ë©´ ìˆ˜ìµì´ ë‹¨ë¦¬ë¡œ ê°€ì‚°ë©ë‹ˆë‹¤!\n" +
                    "â€¢ 10ì§€ë¶„ ì´í•˜: ê¸°ë³¸ 1.0ë°° (ê°€ì‚° ì—†ìŒ)\n" +
                    "â€¢ 10ì§€ë¶„ ì´ˆê³¼: 1ì§€ë¶„ë‹¹ +0.1ë°° ì¶”ê°€ ê°€ì‚°\n" +
                    "(ì˜ˆ: 11ì§€ë¶„ = 1.1ë°° / 15ì§€ë¶„ = 1.5ë°° / 20ì§€ë¶„ = 2.0ë°°)\n\n" +
                    "[ğŸ–ï¸ íŠ¹ë³„ í˜œíƒ]\n" +
                    "â€¢ 'ê°“ë¬¼ì£¼' ì¹­í˜¸ ì¥ì°© ì‹œ ìµœì¢… ë°°ë‹¹ê¸ˆ 10% ì¶”ê°€ ë³´ë„ˆìŠ¤\n\n" +
                    "ğŸ’¡ íŒ: ì´ì œ í™œë™ëŸ‰ê³¼ ìƒê´€ì—†ì´ ê±´ë¬¼ì„ ì†Œìœ í•œ ì‹œê°„ë§Œí¼ ìˆ˜ìµì´ ë³´ì¥ë©ë‹ˆë‹¤. 10ì§€ë¶„ ì´ˆê³¼ ì‹œ ë°°ë‹¹ íš¨ìœ¨ì´ ë¹„ì•½ì ìœ¼ë¡œ ìƒìŠ¹í•©ë‹ˆë‹¤!";
    }
        else if (choice === "9") {
            guideTitle = "âš“ ë¬´ì—­ ë° í•´ìƒ êµì—­ ê°€ì´ë“œ";
            guideBody = "â€¢ ì‹œì„¸ ë³€ë™: ì„¸ê³„ ì‹œì¥ì˜ ìˆ˜ìš”ëŠ” ë§¤ì‹œ 30ë¶„ì— ê°±ì‹ ë©ë‹ˆë‹¤.\n" +
                        "â€¢ ì‹œì„¸ ê³ ì •: ì „ëµì ì¸ ë¬´ì—­ì„ ìœ„í•´ ì¶œí•­í•˜ëŠ” ìˆœê°„ì˜ ì‹œì„¸ê°€ ë„ì°© ì‹œê¹Œì§€ ê³ ì •(Snapshot)ë©ë‹ˆë‹¤.\n" +
                        "â€¢ í•­í•´ ì´ë²¤íŠ¸: 25% í™•ë¥ ë¡œ í•­í•´ ì¤‘ ëŒë°œ ìƒí™©ì´ ë°œìƒí•©ë‹ˆë‹¤.\n" +
                        "  - ğŸŒ¬ï¸ ìˆœí’: í•­í•´ ì†ë„ê°€ 20% ë‹¨ì¶•ë˜ì–´ ë¹ ë¥´ê²Œ ë„ì°©í•©ë‹ˆë‹¤.\n" +
                        "  - ğŸŒŠ ì¬í•´: í­í’ìš°(ìˆ˜ë¦¬ë¹„), í™”ì¬/ë¶€ì‹(í™”ë¬¼ ì†ìƒ), í•´ì (ê¸ˆì „ ì•½íƒˆ) ë¦¬ìŠ¤í¬ê°€ ì¡´ì¬í•©ë‹ˆë‹¤.\n" +
                        "â€¢ ë¬´ì—­ì„¸: ë¬´ì—­ ì„±ê³µ ì‹œ ìˆ˜ìµì˜ 10%ê°€ ê¸°ë³¸ ì§•ìˆ˜ë˜ë©°, ì§€ë‹ˆê³„ìˆ˜ê°€ ë†’ì€ ìì‚°ê°€ëŠ” ìµœëŒ€ 15%ê¹Œì§€ ë¶€ê³¼ë©ë‹ˆë‹¤.\n\n" +
                        "ğŸ’¡ íŒ: ì‹œì„¸ê°€ ë°”ë€Œê¸° ì§ì „ì— ë¬¼ê±´ì„ ì‹£ê³  ë‚˜ê°€ë©´, ë°”ë€ ì‹œì„¸ì™€ ìƒê´€ì—†ì´ ë†’ì€ ìˆ˜ìµì„ í™•ì • ì§€ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤!";
        }

        if (guideBody !== "") {
            replier.reply(formatCommand("ğŸ“” " + guideTitle, null, guideBody, "ë‹«ê¸°: [ì·¨ì†Œ]"));
        } else {
            replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "ì˜¬ë°”ë¥¸ ë²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."));
        }
        return true;
    }

    return false;
}

/* [ëª…ë ¹ì–´ ì§„ì…ì ] ë„ì›€ë§ ë° ê°€ì´ë“œ (í•¨ìˆ˜ ë°– ë…ë¦½ ì‹¤í–‰ ë³´ì¥) */
if (msg === "/ë„ì›€ë§") {
    var menuWaitState = data.rooms[roomName].features.states.menuWait; // ì•ˆì „ ì°¸ì¡°
    menuWaitState[targetUid] = { type: 'help', time: Date.now() };
    var menu = "1. ğŸ‘¤ ì¡°íšŒ ë° ì •ë³´\n" +
               "2. ğŸ® ê²Œì„ ë° ì¹´ì§€ë…¸\n" +
               "3. ğŸ›’ ìƒì  ë° ì•„ì´í…œ\n" +
               "4. ğŸ¦ ì€í–‰ ë° ì‚¬ì±„\n" +
               "5. ğŸ—ï¸ ëœë“œë§ˆí¬\n" +
               "6. â›ï¸ ê´‘ì‚° ì±„êµ´ (ë°©ì¹˜í˜•)\n" +
               "7. ğŸ›ï¸ ì •ë¶€ ë° íˆ¬í‘œ\n" +
               "8. âš“ ë¬´ì—­ ë° í•´ìƒ êµì—­\n";
    
    if (isAdmin(user.name, data, targetUid)) menu += "9. âš™ï¸ ê´€ë¦¬ì ê¸°ëŠ¥\n";
    replier.reply(formatCommand("ğŸ“– ë‚´ë¦¬ë‹¤ë´‡ ë„ì›€ë§", null, "ì›í•˜ì‹œëŠ” ë©”ë‰´ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.\n\n" + menu, "ì…ë ¥ ëŒ€ê¸°: 30ì´ˆ"));
    return;
}

if (msg === "/ê°€ì´ë“œ") {
    var menuWaitState = data.rooms[roomName].features.states.menuWait; // ì•ˆì „ ì°¸ì¡°
    menuWaitState[targetUid] = { type: 'guide_menu', time: Date.now() };
    var menu = "1. ğŸ›ï¸ ì¤‘ì•™ì€í–‰ ë° ì‹ ìš© ê²½ì œ\n" +
               "2. ğŸ‡ ì¤‘ì•™ ê²½ë§ˆ ì‹œìŠ¤í…œ\n" +
               "3. ğŸ—ï¸ ëœë“œë§ˆí¬ íˆ¬ì\n" +
               "4. ğŸ° ì¹´ì§€ë…¸ ë° ë¡œë˜\n" +
               "5. â›ï¸ í™œë™ ë° ìˆ˜ìµ\n" +
               "6. ğŸ ë¯¼ìƒ ì§€ì› ë° ë³µì§€\n" +
               "7. ğŸ›ï¸ ì •ë¶€ ë° íˆ¬í‘œ ê°€ì´ë“œ\n" +
               "8. ğŸ‘‘ ìµœëŒ€ì£¼ì£¼ ë°°ë‹¹ ë° íŠ¹ê¶Œ\n" +
               "9. âš“ ë¬´ì—­ ë° í•´ìƒ êµì—­ ê°€ì´ë“œ";
    replier.reply(formatCommand("ğŸ“” ë‚´ë¦¬ë‹¤ë´‡ ë§ˆìŠ¤í„° ê°€ì´ë“œ", null, "ìƒì„¸ ë‚´ìš©ì„ ë³´ê³  ì‹¶ì€ í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.\n\n" + menu, "ì…ë ¥ ëŒ€ê¸°: 30ì´ˆ"));
    return;
}

//==========ì„¹í„°24==========

/* [í†µí•© ê°€ë“œ] 1:1ë°© ì„¸ì…˜ ê°ì§€ ë° í•˜ë“œì½”ë”© ì˜ì¡´ì„± ì œê±° */
if (ALLOWED_ROOMS.indexOf(realRoom) === -1) {
    var isAllowedCmd = (msg.startsWith("/ì¹´ì§€ë…¸") || msg.startsWith("/ë‚´ì •ë³´") || msg.startsWith("/ì€í–‰") || msg.startsWith("/ì—°ë™ì§„ë‹¨") || msg.startsWith("/ë°©ëª©ë¡") || msg.startsWith("/ê´€ë¦¬ì"));

    var inState = false;
    var MAIN_NAME = "ë‚´ë¦¬ë‹¤"; 

    var localSt = (data.rooms[roomName] && data.rooms[roomName].features) ? data.rooms[roomName].features.states : null;
    var mainSt = (data.rooms[MAIN_NAME] && data.rooms[MAIN_NAME].features) ? data.rooms[MAIN_NAME].features.states : null;

    var checkSession = function(st) {
        if (!st) return false;
        return (st.menuWait[targetUid] || st.bankProcess[targetUid] || st.selectWait[targetUid]);
    };

    // [ìˆ˜ì •] í•­í•´ ìƒíƒœì¸ ìœ ì €ë„ ê°€ë“œë¥¼ í†µê³¼í•˜ë„ë¡ í—ˆìš©
    if (checkSession(localSt) || checkSession(mainSt) || (user && user.blackjackState) || (user && user.voyage && user.voyage.active === true)) {
        inState = true;
    }

    // ëª…ë ¹ì–´ë„ ì•„ë‹ˆê³  íŠ¹ì • ìƒíƒœë„ ì•„ë‹ˆë©´ ì—¬ê¸°ì„œ ì°¨ë‹¨(Return)
    if (!isAllowedCmd && !inState) return;

    // [ì¶”ê°€] ê°€ë“œë¥¼ í†µê³¼í•œ ìœ ì €ê°€ ë¬´ì—­ ë„ì°© ìƒíƒœë¼ë©´ ì¦‰ì‹œ ì •ì‚° ì‹¤í–‰
    if (user && user.voyage && user.voyage.active === true) {
        var v = user.voyage;
        if (Date.now() >= (v.arrival || 0) && v.isProcessing !== true) {
            if (typeof _processTradeArrival === 'function') {
                _processTradeArrival(user, data, replier, roomName, targetUid);
            }
        }
    }
}

// í˜„ì¬ ì±„íŒ… ì¤‘ì¸ ë¬¼ë¦¬ì ì¸ ë°©ì˜ ë°ì´í„° (1:1 ë°© ê·¸ ìì²´)
var physicalRoom = data.rooms[roomName];
var actualFeatures = physicalRoom ? physicalRoom.features : null;

// [ë³´ì •] 1:1 ë°©ì—ì„œ ìˆ«ìë¥¼ ì…ë ¥í–ˆì„ ë•Œ ì‘ë‹µí•˜ë„ë¡ ëŒ€ê¸° ìƒíƒœ ê°•ì œ ì°¸ì¡°
if (actualFeatures && actualFeatures.states) { 

    // targetUidê°€ ë©”ì¸ë°© UIDë¡œ ë³€í™˜ëœ ìƒíƒœì´ë¯€ë¡œ, í˜„ì¬ ë°©ì˜ statesì—ì„œ í•´ë‹¹ UIDë¥¼ ê²€ìƒ‰
    var currentStates = actualFeatures.states;

    // 1. ê´€ë¦¬ì ë° ì¡°ì‘ í•¸ë“¤ëŸ¬
    if (typeof _handleAdminMain === 'function' && _handleAdminMain(msg, user, data, replier, roomName, targetUid)) return;
    if (typeof _handleAdminManiStep === 'function' && _handleAdminManiStep(msg, user, data, replier, roomName, targetUid)) return;

    // 2. ë¸”ë™ì­ ì¬ë„ì „/ì•¡ì…˜ (1:1ë°© ì„¸ì…˜ ìš°ì„ )
    if (currentStates.menuWait[targetUid]) {
        var mType = currentStates.menuWait[targetUid].type;
        if (mType === 'blackjack_retry' && typeof _handleBlackjackRetry === 'function') {
            if (_handleBlackjackRetry(msg, user, data, replier, roomName, targetUid)) return;
        }
        if (mType === 'blackjack_action' && typeof _handleBlackjackAction === 'function') {
            if (_handleBlackjackAction(msg, user, data, replier, roomName, targetUid)) return;
        }
    }

    // 3. í†µí•© ì¹´ì§€ë…¸ ë°°íŒ… (ì±„íŒ…ìœ¼ë¡œ 'í™€ 5000' ë“± ì…ë ¥ ì‹œ)
    if (typeof _handleCasinoBet === 'function' && _handleCasinoBet(msg, user, data, replier, roomName, targetUid)) return;
    
    // 4. ê³µìš© ë©”ë‰´ í•¸ë“¤ëŸ¬ (Step 1~4)
    // ì´ í•¨ìˆ˜ë“¤ì´ ë‚´ë¶€ì ìœ¼ë¡œ data.rooms[roomName].features.statesë¥¼ ì°¸ì¡°í•˜ë„ë¡ ì„¤ê³„ë˜ì–´ì•¼ í•¨
    if (typeof _handleMenuStep1 === 'function' && _handleMenuStep1(msg, user, data, replier, roomName, targetUid)) return;
    if (typeof _handleMenuStep2 === 'function' && _handleMenuStep2(msg, user, data, replier, roomName, targetUid)) return;
    if (typeof _handleMenuStep3 === 'function' && _handleMenuStep3(msg, user, data, replier, roomName, targetUid)) return;
    if (typeof _handleMenuStep4 === 'function' && _handleMenuStep4(msg, user, data, replier, roomName, targetUid)) return;

    // 5. ì€í–‰ ì—…ë¬´ ë° ìƒì  êµ¬ë§¤ ìˆ˜ëŸ‰ í•¸ë“¤ëŸ¬
    if (typeof _handleBankStep1 === 'function' && _handleBankStep1(msg, user, data, replier, roomName, targetUid)) return;
    if (typeof _handleBankStep2 === 'function' && _handleBankStep2(msg, user, data, replier, roomName, targetUid)) return;
    if (typeof _handleBankStep3 === 'function' && _handleBankStep3(msg, user, data, replier, roomName, targetUid)) return;
    if (typeof _handleBankStep4 === 'function' && _handleBankStep4(msg, user, data, replier, roomName, targetUid)) return;
    if (typeof _handleBankStep5 === 'function' && _handleBankStep5(msg, user, data, replier, roomName, targetUid)) return;

    // 6. ê¸°íƒ€ ì‹œìŠ¤í…œ í•¸ë“¤ëŸ¬
    if (typeof _handleSelectionLogic === 'function' && _handleSelectionLogic(msg, user, data, replier, roomName, targetUid)) return;
    if (typeof _handleLottoInput === 'function' && _handleLottoInput(msg, user, data, replier, roomName, targetUid)) return;
}

// 7. ì¼ë°˜ ê²Œì„ ëª…ë ¹ì–´ ì²˜ë¦¬
if (typeof _handleGameLogic === 'function') {
    if (_handleGameLogic(msg, user, data, replier, roomName, targetUid, cleanSender)) return;
}

/* 8. ì±„íŒ… ë³´ë„ˆìŠ¤ ë¡œì§ (í•¨ìˆ˜ ì—°ê²°) */
if (typeof _runChatBonusLogic === 'function') {
    _runChatBonusLogic(msg, user, data, replier, roomName, targetUid);
}

//==========ì„¹í„°25==========

    /* [v10.1] C. ê´€ë¦¬ì ëª…ë ¹ì–´ ì²˜ë¦¬ (íŠ¸ëœì­ì…˜ flow ìœ ì§€) */
    if (!isProcessed && isAdmin(sender, data, targetUid)) {
        if (typeof _handleAdminLogic === 'function') {
            if (_handleAdminLogic(msg, user, data, replier, roomName, targetUid, sender)) {
                isProcessed = true; 
            }
        }
    }

    /* [v10.1] D. ëª…ë ¹ì–´ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ìë™ ì‹¤í–‰ (íŠ¸ëœì­ì…˜ flow ìœ ì§€) */
    if (!isProcessed && msg.startsWith("/")) {
        var cmdKey = msg.split(" ")[0];
        
        // 1. ë“±ë¡ëœ ì‚¬ìš©ì ëª…ë ¹ì–´ ì‹¤í–‰
        if (USER_COMMANDS && USER_COMMANDS[cmdKey]) {
            USER_COMMANDS[cmdKey].execute(msg, user, data, replier, roomName, targetUid, sender);
            isProcessed = true; 
        } 
        
        // 2. ê´€ë¦¬ì/ì‚¬ìš©ì ëª…ë ¹ì–´ ëª¨ë‘ ì—†ëŠ” ê²½ìš° ì²˜ë¦¬
        else if (!ADMIN_COMMANDS[cmdKey]) {
            var unknownCmdMsg = "'" + cmdKey + "'ì€(ëŠ”) ë“±ë¡ë˜ì§€ ì•Šì€ ëª…ë ¹ì–´ì…ë‹ˆë‹¤.";
            replier.reply(formatError(user, "ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì–´", unknownCmdMsg + "\n'/ë„ì›€ë§'ì„ ì…ë ¥í•˜ì—¬ ì „ì²´ ëª…ë ¹ì–´ ëª©ë¡ì„ í™•ì¸í•˜ì„¸ìš”."));
            isProcessed = true; 
        }
    }

//==========ì„¹í„°26==========

// 1. [Atomic Commit] ëª¨ë“  ë¡œì§ ì •ìƒ ì¢…ë£Œ ì‹œ íŠ¸ëœì­ì…˜ í™•ì •
        if (typeof util_stagingCommit === 'function') {
            util_stagingCommit(user, roomData);
        }

    } catch (e) {
        // 2. [Rollback] ì—ëŸ¬ ë°œìƒ ì‹œ ë°ì´í„° ë³µêµ¬ ë° ë³´ê³ 
        if (typeof util_stagingRollback === 'function') util_stagingRollback(user, roomName);
        if (typeof util_reportError === 'function') util_reportError(e, roomName, cleanSender, msg);
        try {
            Api.replyRoom(roomName, formatError(user, "ì‹œìŠ¤í…œ ë³´í˜¸ ì‘ë™", "ë¡œì§ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì—¬ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤."));
        } catch (err) { 
            Log.error("ğŸš¨ [Critical Error]: " + err); 
        }
    } finally {
        // 3. [IPM ì„±ëŠ¥ ê¸°ë¡ ë³µêµ¬ ë° ë½ í•´ì œ]
        if (typeof _perfStartTime !== 'undefined') {
            var _pDur = java.lang.System.currentTimeMillis() - _perfStartTime;
            if (typeof PERF_METRICS !== 'undefined') {
                // ì§€ì—° ì‹œê°„ ê°€ì¤‘ í‰ê· ì¹˜ ê³„ì‚°
                PERF_METRICS.avgLag = Math.floor((PERF_METRICS.avgLag * 9 + _pDur) / 10);
                // ìµœê³  ì§€ì—° ì‹œê°„ ê¸°ë¡ ê°±ì‹ 
                if (_pDur > PERF_METRICS.peakLag) PERF_METRICS.peakLag = _pDur;
                // ë¶„ë‹¹ ë©”ì‹œì§€ ì²˜ë¦¬ìˆ˜ ì¹´ìš´íŠ¸ ì¦ê°€
                PERF_METRICS.msgPerMin++;
            }
        }
        
        // ë°ì´í„° ë™ê¸°í™” ë½ í•´ì œ
        if (typeof lock !== 'undefined' && lock.isLocked()) {
            lock.unlock(); 
        }
    } 

    // ì—¬ê¸°ì„œë¶€í„° ì„¹í„° 19ì—ì„œ ì‹œì‘ëœ 8ê°œì˜ ê³„ì¸µì„ ì—­ìˆœìœ¼ë¡œ ë‹«ìŠµë‹ˆë‹¤.
    } // 4. [LogicQueue] run: function() { ì¢…ë£Œ
    } // 5. [LogicQueue] new java.lang.Runnable({ ê°ì²´ ì¢…ë£Œ
    ) // 6. [LogicQueue] new java.lang.Runnable( ìƒì„±ì ì¢…ë£Œ
    ); // 7. [LogicQueue] .execute( ë©”ì†Œë“œ ì¢…ë£Œ

    } // 8. [ParallelPool] run: function() { ì¢…ë£Œ
    } // 9. [ParallelPool] new java.lang.Runnable({ ê°ì²´ ì¢…ë£Œ
    ) // 10. [ParallelPool] new java.lang.Runnable( ìƒì„±ì ì¢…ë£Œ
    ); // 11. [ParallelPool] .execute( ë©”ì†Œë“œ ì¢…ë£Œ

}; // 12. [Final] action ë¦¬ìŠ¤ë„ˆ í•¨ìˆ˜ ì „ì²´ ì¢…ë£Œ

//==========ì„¹í„°27==========

/**
 * [ë…ë¦½í˜• í•¨ìˆ˜ 1] ì¸ë²¤í† ë¦¬ ë¡œì§ (ìì‚°ê°€ ì˜êµ¬ ì¹­í˜¸ í†µí•©ë³¸)
 * ê¸°ëŠ¥: ë³´ìœ  ì•„ì´í…œ í™•ì¸, ì¥ì°©, ë¶„í•´ ì²˜ë¦¬
 * ìˆ˜ì •: ì˜êµ¬ ì¹­í˜¸(700ë²ˆëŒ€) ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜ ë° ë³´í˜¸ ë¡œì§ ì¶”ê°€
 */
function _handleInventoryLogic(msg, user, data, replier, roomName, targetUid) {
    // 1. ê°€ë°© ì¡°íšŒ (ë¶„ë¥˜ ë° ìë™ ì •ë ¬ ì ìš©)
    if (msg === "/ê°€ë°©") {
        var inv = user.inventory || [];
        
        // ID ê¸°ì¤€ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬ (ìì‚°ê°€ ì¹­í˜¸ 700~703ë²ˆì´ ì¹­í˜¸ ìƒë‹¨ì— ì˜¤ë„ë¡ ì •ë ¬)
        inv.sort(function(a, b) {
            var idA = Number(a.id) || 9999;
            var idB = Number(b.id) || 9999;
            if (idA !== idB) return idA - idB;
            return (a.name || "").localeCompare(b.name || "");
        });

        var iconEntries = [];
        var titleEntries = [];
        
        if (inv.length === 0) {
            iconEntries.push("(ë³´ìœ  ì¤‘ì¸ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤)");
        } else {
            for (var i = 0; i < inv.length; i++) {
                var it = inv[i];
                var activeMark = "";
                
                // í˜„ì¬ ì¥ì°© ìƒíƒœ í™•ì¸ (âœ… í‘œì‹œ)
                if (it.effect === "icon" && user.icon === it.icon) activeMark = " (âœ… ì¥ì°© ì¤‘)";
                else if (it.effect === "title" && user.title === it.title) activeMark = " (âœ… ì¥ì°© ì¤‘)";
                
                var displayIcon = it.icon || "";
                var entry = "";

                if (it.effect === "icon") {
                    // ì•„ì´ì½˜ ì¹´í…Œê³ ë¦¬: [ì•„ì´ì½˜] ì´ë¦„ í¬ë§·
                    entry = (i + 1) + ". " + (displayIcon || "ğŸ“¦") + " " + it.name + activeMark;
                    iconEntries.push(entry);
                } else if (it.effect === "title") {

                    // 1. ëª¨ë“  ì¹­í˜¸ê°€ ë³´ì´ë„ë¡ í•„í„°(continue) ì œê±°
                    // 2. ìˆ˜ì§‘ëŒ€ë§ˆì™•, ë„êµ´ì™•ì„ ì œì™¸í•œ ì¹­í˜¸ì˜ ì•„ì´ì½˜ ìˆ¨ê¹€ ì²˜ë¦¬
                    var finalDisplayIcon = "";
                    if (it.title === "ìˆ˜ì§‘ëŒ€ë§ˆì™•" || it.title === "ë„êµ´ì™•") {
                        finalDisplayIcon = it.icon || "";
                    }

                    var entry = "";
                    if (finalDisplayIcon) {
                        // ì•„ì´ì½˜ì´ í—ˆìš©ëœ ì¹­í˜¸: [ì•„ì´ì½˜+ì´ë¦„] í¬ë§·
                        entry = (i + 1) + ". [" + finalDisplayIcon + it.title + "] ì¹­í˜¸" + activeMark;
                    } else {
                        // ê·¸ ì™¸ ëª¨ë“  ì¹­í˜¸: ì•„ì´ì½˜ ì—†ì´ [ì´ë¦„] í¬ë§·
                        entry = (i + 1) + ". [" + it.title + "] ì¹­í˜¸" + activeMark;
                    }
                    titleEntries.push(entry);
                }
            }
        }

        var horseInfo = "ğŸ ê²½ë§ˆ ì¥ë¹„: [" + (user.horseParts.length > 0 ? user.horseParts.join(", ") : "ì—†ìŒ") + "] " + (user.horseParts.length) + " / 4 ê°œ";
        var landInfo = "ğŸ™ï¸ ë¶€ë™ì‚° ë“±ê¸°ë¶€: " + (user.landDeedCount || 0) + " / 10 ê°œ";
        var letterInfo = "ğŸ“© ìœ„ë¡œì˜ í¸ì§€: " + (user.lottoFailCount || 0) + " / 15 ê°œ";
        
        var charmStatus = "";
        if (user.luckyCharmEnd && Date.now() < user.luckyCharmEnd) {
            var remainMin = Math.ceil((user.luckyCharmEnd - Date.now()) / 60000);
            charmStatus = "\nğŸ”® í–‰ìš´ì˜ë¶€ì : í™œì„± ì¤‘ (" + remainMin + "ë¶„ ë‚¨ìŒ)";
        }

        var invDisplay = "[ì•„ì´í…œ ë³´ê´€í•¨]\n";
        invDisplay += "ğŸ–¼ï¸ ì•„ì´ì½˜ ëª©ë¡ (ë“±ê¸‰ìˆœ)\n";
        invDisplay += (iconEntries.length > 0 ? iconEntries.join("\n") : "- ì—†ìŒ") + "\n\n";
        
        invDisplay += "ğŸ–ï¸ ì¹­í˜¸ ëª©ë¡ (ë“±ê¸‰ìˆœ)\n";
        invDisplay += (titleEntries.length > 0 ? titleEntries.join("\n") : "- ì—†ìŒ");

        var consumables = "\n\n[ë‚´ ì†Œëª¨í’ˆ ì •ë³´]\n" +
                          "ğŸ›¡ï¸ ê°•ë“± ë°©ì–´ê¶Œ: " + (user.tierGuard || 0) + "ê°œ\n" +
                          "ğŸ”‚ ì¶”ê°€ ìŠ¹ê¸‰ê¶Œ: " + (user.purchasedPromotionAttempts || 0) + "íšŒ\n" +
                          "ğŸ§© ë¶„í•´ ì¡°ê°: " + (user.boxFragments || 0) + " / 5 ê°œ\n" +
                          "ğŸ« ëœë¤ë°•ìŠ¤ ì´ìš©ê¶Œ: " + (user.boxTickets || 0) + "ë§¤" + charmStatus;

        // 2. ìˆ˜ì§‘ ì§„í–‰ë„ ì„¹ì…˜ ì¡°ë¦½ (ë¶€ë™ì‚° ìš©ì–´ ë°˜ì˜)
        var progress = "\n\n[ğŸ“Š ìˆ˜ì§‘ ë° ì¹­í˜¸ ì§„í–‰ë„]\n" +
                       horseInfo + "\n" +
                       landInfo + "\n" +
                       letterInfo;
        
        var content = invDisplay + consumables + progress + "\n\n(ì¥ì°©: [/ì¥ì°© ë²ˆí˜¸]) (ë¶„í•´: [/ë¶„í•´ ë²ˆí˜¸])";
        
        replier.reply(formatCommand("ğŸ’ ë‚´ ê°€ë°©", user, content, "íˆ¬ì: [/íˆ¬ì ê±´ë¬¼ëª… ìˆ˜ëŸ‰]"));
        return true;
    }

    // 2. ì•„ì´í…œ ì¥ì°© (ì‹ ìš©ë¶ˆëŸ‰ì ì œí•œ ë° ì¸ë±ìŠ¤ ì •í•©ì„± ìœ ì§€)
    if (msg.indexOf("/ì¥ì°© ") === 0) {
        if (Number(user.creditScore || 600) < 500) {
            replier.reply(formatError(user, "ì¥ì°© ë¶ˆê°€", "í˜„ì¬ ì‹ ìš©ë¶ˆëŸ‰ì ìƒíƒœì´ë¯€ë¡œ ì•„ì´ì½˜ ë° ì¹­í˜¸ ë³€ê²½ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤. ì‹ ìš©ì„ ë¨¼ì € íšŒë³µí•˜ì„¸ìš”."));
            return true;
        }

        var parts = msg.trim().split(/\s+/);
        if (parts.length < 2) {
            replier.reply(formatError(user, "í˜•ì‹ ì˜¤ë¥˜", "/ì¥ì°© [ë²ˆí˜¸]"));
            return true;
        }

        var idx = parseInt(parts[1]);
        var inv = user.inventory || [];
        if (isNaN(idx) || idx < 1 || idx > inv.length) {
            replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "ê°€ë°©ì— í‘œì‹œëœ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."));
            return true;
        }

        var selected = inv[idx - 1];
        if (selected.effect === "icon") {
            user.icon = selected.icon;
            replier.reply(formatCommand("âœ¨ ì•„ì´ì½˜ ì¥ì°©", user, "[" + selected.icon + "] ì•„ì´ì½˜ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.", "ë‚´ ì •ë³´: [/ë‚´ì •ë³´]"));
        } else if (selected.effect === "title") {
            user.title = selected.title || "";
            replier.reply(formatCommand("ğŸ–ï¸ ì¹­í˜¸ ì¥ì°©", user, "[" + (selected.title || selected.name) + "] ì¹­í˜¸ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.", "ë‚´ ì •ë³´: [/ë‚´ì •ë³´]"));
        }
        safeSaveData(data);
        return true;
    }

    // 3. ì•„ì´ì½˜ ë¶„í•´ ë¡œì§ (ì˜êµ¬ ì¹­í˜¸ ë³´í˜¸ ë¡œì§ ì¶”ê°€)
    if (msg.indexOf("/ë¶„í•´ ") === 0) {
        var inv = user.inventory || [];
        if (inv.length === 0) return replier.reply(formatError(user, "ë¶„í•´ ë¶ˆê°€", "ë¶„í•´í•  ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤."));

        user.skipHealing = true;

        var numbers = msg.match(/\d+/g);
        if (!numbers) return replier.reply(formatError(user, "ì…ë ¥ ì˜¤ë¥˜", "/ë¶„í•´ [ë²ˆí˜¸]"));

        var targetIndices = [];
        var protectedCount = 0;

        numbers.forEach(function(n) {
            var idx = parseInt(n) - 1;
            if (idx >= 0 && idx < inv.length && targetIndices.indexOf(idx) === -1) {
                var item = inv[idx];
                // [ì•ˆì „ ì¥ì¹˜] ID 700~799ë²ˆëŒ€(ìì‚°ê°€/ì—…ì  ì˜êµ¬ ì¹­í˜¸)ëŠ” ë¶„í•´ ëŒ€ìƒì—ì„œ ì œì™¸
                if (item.effect === "title" && item.id >= 700 && item.id < 800) {
                    protectedCount++;
                } else {
                    targetIndices.push(idx);
                }
            }
        });

        if (protectedCount > 0 && targetIndices.length === 0) {
            return replier.reply(formatError(user, "ë¶„í•´ ë¶ˆê°€", "ì˜êµ¬ ì—…ì  ì¹­í˜¸ëŠ” ë¶„í•´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        }
        if (targetIndices.length === 0) return replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "ì •í™•í•œ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));

        var disassembledNames = [];
        var earnedFragments = targetIndices.length;
        
        // ì—­ìˆœ ì •ë ¬í•˜ì—¬ splice ì‹œ ì¸ë±ìŠ¤ ë°€ë¦¼ ë°©ì§€
        targetIndices.sort(function(a, b) { return b - a; });

        targetIndices.forEach(function(idx) {
            var item = inv[idx];
            disassembledNames.push((item.icon || "ğŸ“¦") + " " + item.name);
            if (item.effect === "icon" && user.icon === item.icon) user.icon = "";
            if (item.effect === "title" && user.title === item.title) user.title = "";
            inv.splice(idx, 1);
        });

        user.boxFragments = (user.boxFragments || 0) + earnedFragments;
        var earnedTickets = 0;
        
        while (user.boxFragments >= 5) {
            user.boxFragments -= 5;
            user.boxTickets = (user.boxTickets || 0) + 1;
            earnedTickets++;
        }

        var resultMsg = "ì•„ì´í…œ " + targetIndices.length + "ê°œë¥¼ ë¶„í•´í–ˆìŠµë‹ˆë‹¤.\n\n" +
                        "[ë¶„í•´ ëª©ë¡]\n" + disassembledNames.join(", ") + "\n\n" +
                        "ğŸ§© íšë“ ì¡°ê°: +" + earnedFragments + " ê°œ\n" +
                        "(í˜„ì¬ ì¡°ê°: " + user.boxFragments + " / 5 ê°œ)";

        if (protectedCount > 0) resultMsg += "\n\nâš ï¸ ì•Œë¦¼: ì„ íƒí•˜ì‹  ì˜êµ¬ ì¹­í˜¸ " + protectedCount + "ê°œëŠ” ë¶„í•´ ëŒ€ìƒì—ì„œ ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤.";
        if (earnedTickets > 0) resultMsg += "\nğŸ« ëœë¤ë°•ìŠ¤ ì´ìš©ê¶Œ: +" + earnedTickets + "ë§¤ íšë“! (ì¡°ê° ë³€í™˜ ì™„ë£Œ)";

        replier.reply(formatCommand("â™»ï¸ ì•„ì´ì½˜ ë¶„í•´ ì™„ë£Œ", user, resultMsg, "ì´ìš©ê¶Œ í™•ì¸: [/ê°€ë°©]"));
        safeSaveData(data);
        return true;
    }
}

//==========ì„¹í„°28==========

/**
Â * [ë…ë¦½í˜• í•¨ìˆ˜ 2] ë¡œë˜ ë° ì•„ì´ì½˜ ë¡œì§
Â */
function _handleLottoLogic(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];

    // 1. ë°© ë°ì´í„° ë° ê¸°ëŠ¥ í…œí”Œë¦¿ ì¡´ì¬ ì—¬ë¶€ ì²´í¬ (ì•ˆì „ ê°€ë“œ)
    if (!roomData || !roomData.features) return false;

    // 2. [í•µì‹¬] ì´ í•¨ìˆ˜ ì „ìš© ì§€ì—­ ë³€ìˆ˜ë¡œ ë¡œë˜ ë°ì´í„° ì—°ê²° (ë¨¹í†µ ë°©ì§€)
    var lotto = roomData.features.lotto;

Â  Â  if (msg === "/ì•„ì´ì½˜ì´ˆê¸°í™”") {
Â  Â  Â  Â  user.icon = "";
Â  Â  Â  Â  replier.reply(formatCommand("âœ… ì•„ì´ì½˜ ì´ˆê¸°í™”", user, "ì„¤ì •ëœ ì•„ì´ì½˜ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.", "ìƒì  ì´ìš©: [/ìƒì ]"));
Â  Â  Â  Â  safeSaveData(data);
Â  Â  Â  Â  return true;
Â  Â  }

Â  Â  if (msg === "/ë¡œë˜ì •ë³´") {
Â  Â  Â  Â  var currentHour = new Date().getHours();
Â  Â  Â  Â  var isAfterDraw = (currentHour >= 22);
Â  Â  Â  Â  var myLottos = (lotto.entries && lotto.entries[targetUid]) ? lotto.entries[targetUid] : [];
Â  Â  Â  Â  var winNums = lotto.lastWinNums || [];

Â  Â  Â  Â  var result = "ğŸ« ë¡œë˜ ì •ë³´\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + getDisplayName(user) + "ë‹˜\n[ë‚˜ì˜ êµ¬ë§¤ ë²ˆí˜¸]\n";
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (myLottos.length === 0) {
Â  Â  Â  Â  Â  Â  result += "(êµ¬ë§¤í•œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤)\n";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  for (var i = 0; i < myLottos.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  var nums = myLottos[i];
Â  Â  Â  Â  Â  Â  Â  Â  var line = (i + 1) + ") " + nums.join(", ");
Â  Â  Â  Â  Â  Â  Â  Â  if (isAfterDraw && winNums.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  var matchCount = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for(var j=0; j < nums.length; j++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (winNums.indexOf(nums[j]) !== -1) matchCount++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (matchCount === 3) line += " ğŸ¥‡1ë“±!";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (matchCount === 2) line += " ğŸ¥ˆ2ë“±!";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (matchCount === 1) line += " ğŸ¥‰3ë“±!";
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  result += line + "\n";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  result += "\n[ë‹¹ì¼ ë‹¹ì²¨ ë²ˆí˜¸]\n";
Â  Â  Â  Â  if (isAfterDraw) {
Â  Â  Â  Â  Â  Â  if (winNums.length > 0) result += "ğŸ† " + winNums.join(", ");
Â  Â  Â  Â  Â  Â  else result += "ğŸ† ì§‘ê³„ ì¤‘ì…ë‹ˆë‹¤.";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  result += "ğŸ† ì•„ì§ ì¶”ì²¨ ì „ì…ë‹ˆë‹¤.";
Â  Â  Â  Â  }
Â  Â  Â  Â  result += "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’¡ [ê°€ì´ë“œ]: êµ¬ë§¤: [/êµ¬ë§¤ 5]";
Â  Â  Â  Â  replier.reply(result);
        return true;
Â  Â  }
}

//==========ì„¹í„°29==========

/**
 * [ë…ë¦½í˜•] ë°©ì¹˜í˜• ê´‘ì‚° ì‹œìŠ¤í…œ ë¡œì§ êµ¬í˜„ë¶€ (ëˆ„ì  ì‹œê°„ ë° ì„±ì·¨ ì¹­í˜¸ í†µí•© ë²„ì „)
 * ì„¤ëª…: ì„¹í„° 46(êµ¬ ì„¹í„° 27 í˜¸ì¶œë¶€)ì—ì„œ í˜¸ì¶œë˜ë©°, ê´‘ì‚° ì‹œì‘/ì •ë³´/ì¢…ë£Œ ë° ë³´ìƒ ì •ì‚° ë¡œì§ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
 * ë°˜ì˜ ì‚¬í•­: ìœ ë¬¼ ì¡°ê° 5ë‹¨ê³„ ì¹­í˜¸ ì²´ê³„ ì ìš© (ë„êµ´ì™•ë§Œ ì „ìš© ì•„ì´ì½˜ [âšœï¸] ë¶€ì—¬)
 */
function _handleMiningLogic(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName]; 

    // 1. ê´‘ì‚° ì‹œì‘
    if (msg === "/ê´‘ì‚°ì‹œì‘") {
        var stateRes = util_checkUserState(user, targetUid);
        if (!stateRes.canAction) {
            replier.reply(formatError(user, "ì…ì¥ ë¶ˆê°€", stateRes.reason));
            return true; // [ìˆ˜ì •] trueë¥¼ ëª…ì‹œì ìœ¼ë¡œ ë°˜í™˜í•˜ì—¬ ì¤‘ë³µ ì¶œë ¥ ì°¨ë‹¨
        }

        user.mining = { active: true, startTime: Date.now(), room: roomName };
        replier.reply(formatCommand("â›ï¸ ê´‘ì‚° ì…ì„±", user, "ê´‘ì‚°ì—ì„œ ì±„êµ´ì„ ì‹œì‘í–ˆìŠµë‹ˆë‹¤.\nì±„êµ´ ì¤‘ì—ëŠ” ë„ë°•, ëœë“œë§ˆí¬, ë„ë‘‘ì§ˆ ë“± ìˆ˜ìµí˜• í™œë™ì´ ì œí•œë©ë‹ˆë‹¤.", "ì¢…ë£Œ: [/ê´‘ì‚°ì¢…ë£Œ]"));
        safeSaveData(data);
        return true;
    }

    // 2. ê´‘ì‚° ì •ë³´ (ìƒëŒ€ë°© ì¡°íšŒ ê¸°ëŠ¥ ì¶”ê°€)
    if (msg.indexOf("/ê´‘ì‚°ì •ë³´") === 0) {
        var parts = msg.trim().split(/\s+/);
        var tData = user, tIdR = targetUid;

        if (parts.length > 1) {
            var sNick = parts.slice(1).join(" ").trim();
            var fnd = findUserByName(roomData, sNick);
            if (fnd.length === 0) { 
                replier.reply(formatError(user, "ì¡°íšŒ ì‹¤íŒ¨", "[" + sNick + "] ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); 
                return true; 
            }
            if (fnd.length > 1) { 
                handleUserSelection(replier, targetUid, fnd, "mining_info", null, user, roomName); 
                return true; 
            }
            tData = fnd[0].data; tIdR = fnd[0].id;
        }

        var isMe = (tIdR === targetUid);
        var isMin = (tData.mining && tData.mining.active === true);
        // [ìˆ˜ì •]: ì±„êµ´ ì¤‘ì´ ì•„ë‹ ê²½ìš° ì¦‰ì‹œ í‘œì¤€ ì—ëŸ¬ í¬ë§·ìœ¼ë¡œ ì‘ë‹µí•˜ê³  ë¡œì§ ì¢…ë£Œ
        if (!isMin) {
            replier.reply(formatError(tData, "ìƒíƒœ ì˜¤ë¥˜", "í˜„ì¬ ê´‘ì‚°ì—ì„œ ì‘ì—… ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤."));
            return true;
        }

        // [ìµœì í™”]: ìœ„ì—ì„œ ê±¸ëŸ¬ì¡Œìœ¼ë¯€ë¡œ ì•„ë˜ ë¡œì§ì€ ë¬´ì¡°ê±´ ì±„êµ´ ì¤‘ì¸ ìƒíƒœì„ (isMin ì²´í¬ ìƒëµ)
        var dur = Math.floor((Date.now() - tData.mining.startTime) / 60000);
        var tot = (tData.totalMiningTime || 0) + dur;
        
        var pol = util_getActivePolicy(roomData);
        var mult = util_getEcoMultiplier(roomName) * (pol.mineMult || 1.0);
        
        // [êµì •] ë³´ë„ˆìŠ¤ ì¡°ê±´ ë³€ê²½: (ì€í–‰ëŒ€ì¶œ + ì‚¬ì±„) í•©ê³„ê°€ ì‹ ìš©í•œë„ì˜ 80%ë¥¼ ì´ˆê³¼í•  ë•Œë§Œ 1.5ë°° ì ìš©
        var bDebt = (tData.loan && tData.loan.debt) ? Number(tData.loan.debt) : 0;
        var pDebt = 0;
        if (roomData.loanContracts) {
            for (var cid in roomData.loanContracts) {
                if (roomData.loanContracts[cid].borrowerUid === tIdR) pDebt += Number(roomData.loanContracts[cid].currentDebt || 0);
            }
        }
        var limit80 = getCreditInfo(tData.creditScore, roomName).limit * 0.8;
        if ((bDebt + pDebt) > limit80) mult *= 1.5;
        
        var est = Math.floor(dur * SYSTEM_CONFIG.ECO.MINE.BASE_PER_MIN * mult);

        var body = "\nì±„êµ´ ì§„í–‰: " + dur + "ë¶„ì§¸...\n" +
                   "ğŸ“ˆ ëˆ„ì  ì±„êµ´: " + fp(tot) + "ë¶„ ê²½ê³¼\n" +
                   "ğŸ’° ì˜ˆìƒ " + (isMe ? "ê¸°ë³¸ìˆ˜ìµ" : "ìˆ˜ìµ") + ": +" + fp(est) + "P\n" +
                   "âš–ï¸ ì •ì±… íš¨ê³¼: x" + mult.toFixed(1) + " (ì ìš© ì¤‘)\n\n" +
                   "âœ¨ ê´‘ë¬¼ ë°œê²¬ ìˆ˜ìµì€ ì¢…ë£Œ ì‹œ í•©ì‚°ë©ë‹ˆë‹¤.";

        replier.reply(formatCommand(isMe ? "â›ï¸ ê´‘ì‚° ì§„í–‰ í˜„í™©" : "ğŸ” ìœ ì € ê´‘ì‚° ì§„í–‰ í˜„í™©", tData, body, isMe ? "ì¢…ë£Œ ë° ì •ì‚°ì€ [/ê´‘ì‚°ì¢…ë£Œ]" : null));
        return true;
    }

    // 3. ê´‘ì‚° ì¢…ë£Œ (ìœ ë¬¼ 5ë‹¨ê³„ ì¹­í˜¸ ì •ì‚° ë° ëˆ„ì  ì‹œê°„ ë°˜ì˜)
    if (msg === "/ê´‘ì‚°ì¢…ë£Œ") {
        if (!user.mining || !user.mining.active) {
            replier.reply(formatError(user, "ìƒíƒœ ì˜¤ë¥˜", "í˜„ì¬ ì‘ì—… ì¤‘ì´ì§€ ì•ŠìŠµë‹ˆë‹¤."));
            return true;
        }

        // [v5.9] í†µí•© ìƒíƒœ ê°€ë“œ: ì§•ì—­í˜• ì„ ê³  ì‹œ ì¦‰ì‹œ í‡´ê±° ì²˜ë¦¬
        var stateRes = util_checkUserState(user, targetUid);
        if (!stateRes.canAction && stateRes.reason.indexOf("ì§•ì—­") !== -1) {
            user.mining.active = false; 
            safeSaveData(data);
            return replier.reply(formatError(user, "ê²€ê±° í™•ì¸", "ì§•ì—­í˜• ì„ ê³ ë¡œ ì¸í•´ ê´‘ì‚°ì—ì„œ ê°•ì œ í‡´ê±°ë˜ì—ˆìŠµë‹ˆë‹¤."));
        }

        var now = Date.now();
        var durationMin = Math.floor((now - user.mining.startTime) / 60000); 

        if (durationMin < 1) {
            user.mining.active = false; 
            safeSaveData(data);
            replier.reply(formatCommand("â›ï¸ ê´‘ì‚° í‡´ê±°", user, "ì±„êµ´ ì‹œê°„ì´ ë„ˆë¬´ ì§§ì•„ ìˆ˜ìµì´ ë°œìƒí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n(ìµœì†Œ 1ë¶„ ì´ìƒ ìœ ì§€ í•„ìš”)", "ë‹¤ì‹œ ì‹œì‘: [/ê´‘ì‚°ì‹œì‘]"));
            return true;
        }

        // [ê°€ìƒ ì •ë¶€] í˜„ì¬ ì •ì±… ë°°ìœ¨ ë¡œë“œ ë° ì ìš©
        var pol = util_getActivePolicy(roomData);
        var multiplier = util_getEcoMultiplier(roomName) * (pol.mineMult || 1.0);

        var hasDebt = (user.loan && Number(user.loan.debt) > 0);
        if (!hasDebt && roomData.loanContracts) {
            for (var cid in roomData.loanContracts) {
                if (roomData.loanContracts[cid].borrowerUid === targetUid) { hasDebt = true; break; }
            }
        }
        if (hasDebt) multiplier *= 1.5;

        var basePrice = SYSTEM_CONFIG.ECO.MINE.BASE_PER_MIN;
        var conf = SYSTEM_CONFIG.ECO.MINE;
        var totalEarn = 0;
        var copperCount = 0, goldCount = 0, diaCount = 0;
        var artifactFound = 0;

        for (var i = 0; i < durationMin; i++) {
            var rand = Math.random();
            // [ì±„êµ´ì™•] ê¸°ë³¸ í¬ì¸íŠ¸ 20% ìƒìŠ¹
            var miningBonus = (user.title === "ì±„êµ´ì™•") ? 1.2 : 1.0;
            var minIncome = basePrice * multiplier * miningBonus;

            // [ë„êµ´ì™•] ë°œê²¬ í™•ë¥  20% ìƒìŠ¹ (ìƒëŒ€ì  ìƒìŠ¹)
            var luck = (user.title === "ë„êµ´ì™•") ? 1.2 : 1.0;
            
            if (rand < (conf.DIA_PROB * luck)) { 
                diaCount++; 
                totalEarn += (minIncome * conf.DIA_MULT); 
            } 
            else if (rand < ((conf.DIA_PROB + conf.GOLD_PROB) * luck)) { 
                goldCount++; 
                totalEarn += (minIncome * conf.GOLD_MULT); 
            } 
            else if (rand < ((conf.DIA_PROB + conf.GOLD_PROB + conf.COPPER_PROB) * luck)) { 
                copperCount++; 
                totalEarn += (minIncome * conf.COPPER_MULT); 
            }
            else { 
                // 4. ì¼ë°˜ ëŒë©ì´ íŒì • (ë‚˜ë¨¸ì§€ 91.5%)
                totalEarn += minIncome; 
            }

            if (Math.random() < (conf.ARTIFACT_CHANCE || 0.0005)) {
                artifactFound++;
            }
        }

        totalEarn = Math.floor(totalEarn);

        var matchingBonus = 0;
        var isStimulusActive = (data.stimulusEndTime && Date.now() < data.stimulusEndTime);
        
        if (isStimulusActive && roomData.bankReserve > totalEarn) {
            matchingBonus = totalEarn; 
        }

        var borrowerUid = targetUid || user.uid; 
        var totalWithBonus = totalEarn + matchingBonus;
        // 1. [ì°¨ë“± ì„¸ê¸ˆ ê³„ì‚°] ì„¹í„° 11ì˜ ì—”ì§„ í˜¸ì¶œ
        var taxInfo = util_applyIncomeTax(user, totalWithBonus, roomName);
        
        // 2. ì„¸ê¸ˆ êµ­ê³  í™˜ìˆ˜ ì§‘í–‰
        util_updateReserve(roomData, taxInfo.taxAmount, "ê´‘ì‚° ì±„êµ´ ì†Œë“ì„¸ ì§•ìˆ˜", roomName);

        // 3. [ìƒí™˜ ì²˜ë¦¬] ì„¸ê¸ˆì„ ëº€ ë‚˜ë¨¸ì§€ ê¸ˆì•¡(taxInfo.netIncome)ìœ¼ë¡œ ë¹š ìƒí™˜ ì§„í–‰
        var res = processRepayment(user, taxInfo.netIncome, borrowerUid, roomName); 
        
        var actualTotal = Number(res.actualGain);
        var bonusPart = (matchingBonus > 0) ? Math.floor(actualTotal / 2) : 0;
        var basePart = actualTotal - bonusPart;

        util_updatePoint(user, roomData, basePart, "ê´‘ì‚° ì±„êµ´ ì •ì‚°", roomName);
        if (bonusPart > 0) util_updatePoint(user, roomData, bonusPart, "ì •ë¶€ ê·¼ë¡œ ì¥ë ¤ê¸ˆ(ê´‘ì‚°)", roomName);

        // [UI êµ¬ì„±] ì„¸ê¸ˆ ë° ì •ì‚° ë‚´ì—­ í…ìŠ¤íŠ¸ ì¡°ë¦½
        var taxLog = "\nâš–ï¸ ì„¸ê¸ˆ(" + taxInfo.ratePct + "%): -" + fp(taxInfo.taxAmount) + "P (ìƒìœ„ " + taxInfo.rankPct + "%)";
        var stimulusLog = (matchingBonus > 0) ? "\nğŸ¦ [ì´ë²¤íŠ¸]: 1:1 ë§¤ì¹­ ì¥ë ¤ê¸ˆ +" + fp(matchingBonus) + "P" : "";
        var repayInfo = res.repayMsg ? "\n" + res.repayMsg : "";
        var finalGainLog = "\nğŸ’° ìµœì¢… ìˆ˜ìµ: +" + fp(actualTotal) + "P";

        var nextMiningTime = Number(user.totalMiningTime || 0) + durationMin;
        util_setData(user, 'totalMiningTime', nextMiningTime, "ê´‘ì‚° ì±„êµ´ ì‹œê°„ í•©ì‚°", roomName);

        var nextArtifacts = Number(user.artifactPieces || 0) + artifactFound;
        util_setData(user, 'artifactPieces', nextArtifacts, "ìœ ë¬¼ ì¡°ê° íšë“", roomName);

        var replierStub = { reply: function(m) { Api.replyRoom(roomName, m); } };

        // 3. ì±„êµ´ ì‹œê°„ ì¹­í˜¸ ì²´í¬
        if (user.totalMiningTime >= 10000) {
            util_checkAndAwardTitle(user, replierStub, "ì±„êµ´ì™•", 2903, "â›ï¸", "ë‚´ë¦¬ë‹¤ ê´‘ì—… ê´€ë¦¬ì²­", "ëˆ„ì  ì±„êµ´ 10,000ë¶„", "[ì¥ì°© íš¨ê³¼]: ê´‘ì‚° ì±„êµ´ ì‹œ ë¶„ë‹¹ íšë“í•˜ëŠ” ê¸°ë³¸ í¬ì¸íŠ¸ê°€ 20% ìƒìŠ¹í•©ë‹ˆë‹¤.");
        } else if (user.totalMiningTime >= 7000) {
            util_checkAndAwardTitle(user, replierStub, "ì„ê³µ", 2902, "â›ï¸", "ë‚´ë¦¬ë‹¤ ê´‘ì—… ê´€ë¦¬ì²­", "ëˆ„ì  ì±„êµ´ 7,000ë¶„", "ë°”ìœ„ì¡°ì°¨ ë‹¹ì‹ ì˜ ê³¡ê´­ì´ ì•ì—ì„œëŠ” ê¸¸ì„ ë‚´ì–´ì¤ë‹ˆë‹¤.");
        } else if (user.totalMiningTime >= 3000) {
            util_checkAndAwardTitle(user, replierStub, "ë‘ë”ì§€", 2901, "â›ï¸", "ë‚´ë¦¬ë‹¤ ê´‘ì—… ê´€ë¦¬ì²­", "ëˆ„ì  ì±„êµ´ 3,000ë¶„", "ë•…ì†ì˜ ê¸°ìš´ê³¼ í•˜ë‚˜ê°€ ë˜ì–´ ë¬µë¬µíˆ ê¸¸ì„ ëš«ê³  ìˆìŠµë‹ˆë‹¤.");
        }

        // 4. ìœ ë¬¼ ì¡°ê° ì¹­í˜¸ ì²´í¬
        if (user.artifactPieces >= 50) {
            util_checkAndAwardTitle(user, replierStub, "ë„êµ´ì™•", 2915, "âšœï¸", "ë‚´ë¦¬ë‹¤ ê³ ê³ í•™ ì—°êµ¬ì†Œ", "ìœ ë¬¼ ì¡°ê° 50ê°œ ë‹¬ì„±", "[ì¥ì°© íš¨ê³¼]: ê´‘ì‚° ì±„êµ´ ì‹œ í¬ê·€ ê´‘ë¬¼(êµ¬ë¦¬/ê¸ˆ/ë‹¤ì´ì•„) ë°œê²¬ í™•ë¥ ì´ 20% ìƒìŠ¹í•©ë‹ˆë‹¤.", roomName);
        } 
        if (user.artifactPieces >= 40) {
            util_checkAndAwardTitle(user, replierStub, "íŠ¸ë ˆì €í—Œí„°", 2914, "ğŸ’", "ë‚´ë¦¬ë‹¤ ê³ ê³ í•™ ì—°êµ¬ì†Œ", "ìœ ë¬¼ ì¡°ê° 40ê°œ ë‹¬ì„±", "ì „ì„¤ì˜ ë³´ë¬¼ì„ ì°¾ì•„ ì „ ì„¸ê³„ë¥¼ ëˆ„ë¹„ëŠ” íƒí—˜ê°€ì…ë‹ˆë‹¤.", roomName);
        } 
        if (user.artifactPieces >= 30) {
            util_checkAndAwardTitle(user, replierStub, "ë°œêµ´ê°€", 2913, "ğŸº", "ë‚´ë¦¬ë‹¤ ê³ ê³ í•™ ì—°êµ¬ì†Œ", "ìœ ë¬¼ ì¡°ê° 30ê°œ ë‹¬ì„±", "ì—­ì‚¬ì˜ íŒŒí¸ì„ ë§ì¶°ë‚˜ê°€ë©° ì‹ ë¹„ë¥¼ ë°íˆê³  ìˆìŠµë‹ˆë‹¤.", roomName);
        } 
        if (user.artifactPieces >= 20) {
            util_checkAndAwardTitle(user, replierStub, "íƒì‚¬ì›", 2912, "ğŸ”", "ë‚´ë¦¬ë‹¤ ê³ ê³ í•™ ì—°êµ¬ì†Œ", "ìœ ë¬¼ ì¡°ê° 20ê°œ ë‹¬ì„±", "ìœ ì ì˜ í”ì ë“¤ì´ ë³´ì´ê¸° ì‹œì‘í•©ë‹ˆë‹¤.", roomName);
        } 
        if (user.artifactPieces >= 10) {
            // [ë³µêµ¬ ëŒ€ìƒ] 10ê°œ íšë“ ì‹œ ë„êµ´ê¾¼ ì¹­í˜¸ ë¶€ì—¬
            util_checkAndAwardTitle(user, replierStub, "ë„êµ´ê¾¼", 2911, "ğŸ§¤", "ë‚´ë¦¬ë‹¤ ê³ ê³ í•™ ì—°êµ¬ì†Œ", "ìœ ë¬¼ ì¡°ê° 10ê°œ ë‹¬ì„±", "ë“œë””ì–´ ì²« ë²ˆì§¸ ìœ ë¬¼ ì¹­í˜¸ë¥¼ íšë“í•˜ì…¨ìŠµë‹ˆë‹¤.", roomName);
        }

        user.mining.active = false;
        // [í†µí•© ë©”ì‹œì§€ ì¡°ë¦½ ì‹œì‘]
        var repayInfo = res.repayMsg ? "\n\n" + res.repayMsg : "";
        var finalOutput = "â›ï¸ ì±„êµ´ ê²°ê³¼\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + getDisplayName(user) + "ë‹˜\n\n" +
                          "â›ï¸ ì±„êµ´ ì‹œê°„: " + durationMin + "ë¶„\n" +
                          "ğŸŸ« êµ¬ë¦¬ " + copperCount + "íšŒ ğŸ—‚ï¸ í™©ê¸ˆ " + goldCount + "íšŒ\n" +
                          "ğŸ’ ë‹¤ì´ì•„ " + diaCount + "íšŒ\n" +
                          "ğŸ’° ì±„êµ´ ìˆ˜ìµ: +" + fp(totalEarn) + "P\n" +
                          taxLog + 
                          stimulusLog + 
                          repayInfo + 
                          finalGainLog;

        if (artifactFound > 0) {
            // ë‹¤ìŒ ì¹­í˜¸ ëª©í‘œì¹˜ ê³„ì‚° ë¡œì§
            var pieces = Number(user.artifactPieces || 0);
            var targetGoal = 10;
            if (pieces >= 50) targetGoal = 50;
            else if (pieces >= 40) targetGoal = 50;
            else if (pieces >= 30) targetGoal = 40;
            else if (pieces >= 20) targetGoal = 30;
            else if (pieces >= 10) targetGoal = 20;
            else targetGoal = 10;

            finalOutput += "\n\nâœ¨ [ë‚´ë¦¬ë‹¤ ê³ ê³ í•™ ì—°êµ¬ì†Œ: ìœ ë¬¼ ë°œê²¬] âœ¨\n" +
                           "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                           "ì‹¬ìƒì¹˜ ì•Šì€ ê¸°ìš´ì˜ ì¡°ê°ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤!\n\n" +
                           "ğŸ§© ìœ ë¬¼ ì¡°ê° íšë“ (+" + artifactFound + ")\n" +
                           "í˜„ì¬ ë³´ìœ  " + pieces + " / " + targetGoal + " ê°œ";
        }

        finalOutput += "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’¡ [ê°€ì´ë“œ]: ë‚´ ì”ì•¡: " + fP(user.point) + "P";
                                          
        replier.reply(finalOutput);
        return true;
    }
}

//==========ì„¹í„°30==========

/**
 * [ì „ì—­ ë…ë¦½ í•¨ìˆ˜] ìƒì  ì•„ì´í…œ íš¨ê³¼ ì²˜ë¦¬ ì—”ì§„
 * ê¸°ëŠ¥: êµ¬ë§¤í•œ ì•„ì´í…œì˜ íš¨ê³¼ ë°œë™ ë° ì¤‘ì•™ì€í–‰ ì¬ì› ì •ì‚°
 * ìˆ˜ì • ì‚¬í•­: [Gemini ìš”ì²­ ì‚¬í•­] ìˆ˜ì§‘ëŒ€ë§ˆì™• íŒì • ë¡œì§ì„ "ë³´ìœ +ë¶„í•´ ëˆ„ì " ë° "ì „ì¢… ìˆ˜ì§‘" ê¸°ì¤€ìœ¼ë¡œ ì •ë°€í™”
 */
function _handleShopEffect(item, user, roomName, replier, data, targetUid, finalPrice, isUsingTicket, quantity) {
    var roomData = data.rooms[roomName];
    if (!roomData) return;

    var bankProcessState = roomData.features.states.bankProcess;

    // [ë³´ì•ˆ íŒ¨ì¹˜] ìƒì  íš¨ê³¼ ì§„ì… ì‹œ ê°•ì œë¡œ í—¬ëŸ¬ ë°©ì–´ë§‰ ê°€ë™ (êµ¬ë§¤ ì™„ë£Œ ì‹œê¹Œì§€ ìœ ì§€)
    user.skipHealing = true;

    // ìˆ˜ëŸ‰ ë° ëˆ„ì  ë§¤ì¶œ ì •ì‚° ë¡œì§ ìµœì í™”
    var qty = (quantity !== undefined && quantity !== null) ? quantity : 1;

    // ì¤‘ì•™ì€í–‰ ì¬ì› ì´ˆê¸°í™” (ê¸°ë³¸ 10,000P)
    if (roomData.bankReserve === undefined || roomData.bankReserve === null) {
        roomData.bankReserve = 10000;
    }
    
    /* [1. ìì‚° ì •ì‚°] ì´ìš©ê¶Œ ì°¨ê° ë¡œì§ (ìœ ì €ë‹˜ì˜ ê¸°ì¡´ ì‚¬ìœ  ë¬¸êµ¬ ë³´ì¡´) */
    if (isUsingTicket && item.effect === "randomBox") {
        var currentTickets = Number(user.boxTickets || 0);
        // êµ¬ë§¤ ìˆ˜ëŸ‰(qty)ë§Œí¼ ì°¨ê°í•˜ë˜, ë³´ìœ ëŸ‰ë³´ë‹¤ ë§ì´ ëº„ ìˆ˜ ì—†ë„ë¡ ì œí•œ
        var ticketsToUse = Math.min(qty, currentTickets); 
        util_setData(user, 'boxTickets', currentTickets - ticketsToUse, "ëœë¤ë°•ìŠ¤ ì´ìš©ê¶Œ ì‚¬ìš©", roomName);
    }

    /* [Gemini ìš”ì²­ ì‚¬í•­] ìˆ˜ì§‘ëŒ€ë§ˆì™• íŒì • í•¨ìˆ˜ - ì „ì¢… ìˆ˜ì§‘(ë³´ìœ +ë¶„í•´) ì²´í¬ */
    var checkCollectionMaster = function() {
        // 1. ìƒì  íŒë§¤ ì•„ì´ì½˜ ì¶”ì¶œ
        var shopIcons = SHOP_ITEMS.filter(function(it) { return it.effect === "icon"; }).map(function(it) { return it.icon; });
        
        // 2. ëœë¤ ë°•ìŠ¤ ëª¨ë“  ì•„ì´ì½˜ ì¶”ì¶œ
        var boxIcons = [];
        if (RANDOM_BOX_CONFIG && RANDOM_BOX_CONFIG.PROBS) {
            RANDOM_BOX_CONFIG.PROBS.forEach(function(grade) {
                if (grade.items) boxIcons = boxIcons.concat(grade.items);
            });
        }
        
        // 3. ì¤‘ë³µ ì œê±°ëœ ì „ì²´ ê³ ìœ  ì•„ì´ì½˜ ëª©ë¡ ìƒì„±
        var allUniqueIcons = {};
        shopIcons.concat(boxIcons).forEach(function(icon) {
            if (icon) allUniqueIcons[icon] = true;
        });
        
        var totalTargetCount = Object.keys(allUniqueIcons).length;
        
        // 4. ìœ ì €ì˜ ëˆ„ì  ìˆ˜ì§‘ ê¸°ë¡(collectedIcons)ê³¼ ë¹„êµ íŒì •
        if (user.collectedIcons && user.collectedIcons.length >= totalTargetCount) {
            
            var replierStub = { reply: function(m) { Api.replyRoom(roomName, m); } };
            util_checkAndAwardTitle(user, replierStub, "ìˆ˜ì§‘ëŒ€ë§ˆì™•", 3001, "ğŸµï¸", "ë‚´ë¦¬ë‹¤ ë§Œë¬¼ ìƒì—… ì—°í•©", "ëª¨ë“  ì•„ì´ì½˜ ìˆ˜ì§‘ ì™„ë£Œ", "[ì¥ì°© íš¨ê³¼]: ëª¨ë“  ìƒì  ë¬¼í’ˆ êµ¬ë§¤ ì‹œ 15% ìƒì‹œ í• ì¸ì´ ì ìš©ë©ë‹ˆë‹¤.");
        }
    };

    /* [2. ì•„ì´í…œ íš¨ê³¼ë³„ ì‹¤í–‰ ë¡œì§] */

    /* ìš”ì²­ì‚¬í•­ ì‹œì‘: ë¬´ì—­ ë¬¼í’ˆ ì ì¬ ë¡œì§ ì¶”ê°€ */
    if (item.effect === "trade_cargo") {
        if (user.voyage && user.voyage.active) {
             replier.reply(formatError(user, "ì ì¬ ë¶ˆê°€", "í˜„ì¬ ì„ ë°•ì´ í•­í•´ ì¤‘ì…ë‹ˆë‹¤.\nê·€í•­ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."));
             return; // ëˆ ì°¨ê° ì „ ì¢…ë£Œ
        }

        // í•­í•´ ì¤‘ì´ ì•„ë‹˜ì´ í™•ì¸ëœ ì´ ì‹œì ì— ì‹¤ì œ ê²°ì œ ì§„í–‰
        util_updatePoint(user, roomData, -finalPrice, "ë¬´ì—­ í™”ë¬¼ ë§¤ì…: " + item.value + " x" + qty, roomName);

        var tradeCfg = SYSTEM_CONFIG.TRADE;
        var shipCfg = tradeCfg.SHIPS[user.shipLevel || 1];
        
        // í˜„ì¬ ì´ ì ì¬ëŸ‰ ê³„ì‚°
        var currentCargoCount = 0;
        for (var key in (user.cargo || {})) {
            currentCargoCount += Number(user.cargo[key] || 0);
        }

        // ê³µê°„ ë¶€ì¡± ì²´í¬
        if (currentCargoCount + qty > shipCfg.capacity) {
            // ì´ë¯¸ ì°¨ê°ëœ ê¸ˆì•¡ì´ ìˆë‹¤ë©´ í™˜ë¶ˆ (ê²Œì´íŠ¸ì›¨ì´ í˜¸ì¶œ)
            if (!isUsingTicket && finalPrice > 0) {
                util_updatePoint(user, roomData, finalPrice, "ì ì¬ ê³µê°„ ë¶€ì¡± í™˜ë¶ˆ", roomName);
            }
            replier.reply(formatError(user, "ì ì¬ ê³µê°„ ë¶€ì¡±", 
                "ì„ ë°•ì— ë” ì´ìƒ ë¬¼ê±´ì„ ì‹¤ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n" +
                "ğŸ“¦ í˜„ì¬: " + currentCargoCount + "/" + shipCfg.capacity + "ì¹¸\n" +
                "âš ï¸ ìš”ì²­: " + qty + "ìƒì"));
            return;
        }

        // ì ì¬í•¨ ì—…ë°ì´íŠ¸
        if (!user.cargo) user.cargo = {};
        var goodsType = item.value; // "ì‹ë£Œí’ˆ", "ë³´ì„" ë“±
        if (!user.cargoAvg) user.cargoAvg = {}; // í‰ë‹¨ê°€ ê°ì²´ ì´ˆê¸°í™”

        var oldQty = Number(user.cargo[goodsType] || 0);
        var oldAvg = Number(user.cargoAvg[goodsType] || 0);
        var currentUnitPrice = Math.floor(finalPrice / qty); // ì´ë²ˆ êµ¬ë§¤ ê°œë‹¹ ë‹¨ê°€

        // ìƒˆë¡œìš´ ê°€ì¤‘ í‰ê·  ë§¤ì…ê°€ ê³„ì‚° ë° ìˆ˜ëŸ‰ í•©ì‚°
        var newAvg = Math.floor(((oldAvg * oldQty) + (currentUnitPrice * qty)) / (oldQty + qty));
        
        user.cargoAvg[goodsType] = newAvg; // ìƒˆ í‰ë‹¨ê°€ ê¸°ë¡
        user.cargo[goodsType] = oldQty + qty; // ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ í•œ ì¤„ ì½”ë“œì˜ ì—­í•  ìˆ˜í–‰)

        replier.reply(formatCommand("ğŸš¢ í™”ë¬¼ ì ì¬ ì™„ë£Œ", user, 
            "[" + goodsType + " ìƒì] " + qty + "ê°œë¥¼ ë°°ì— ì‹¤ì—ˆìŠµë‹ˆë‹¤.\n" +
            "ğŸ“ í˜„í™©: " + (currentCargoCount + qty) + " / " + shipCfg.capacity + " ì¹¸ ì‚¬ìš© ì¤‘",
            "ì¶œí•­ ì¤€ë¹„: [/ë¬´ì—­]"));
    }

    // 0. ìŠ¤í”¼ë˜ ë³µê¶Œ ì²˜ë¦¬ ë¡œì§
    if (item.effect === "spitto") {
        var conf = SYSTEM_CONFIG.ECO.SPITTO;
        var totalPrize = 0;
        var results = { rank1: 0, rank2: 0, rank3: 0, rank4: 0, fail: 0 };

        var earnedLetters = 0; // ì´ë²ˆ êµ¬ë§¤ì—ì„œ íšë“í•œ í¸ì§€ ì´ìˆ˜

        for (var i = 0; i < qty; i++) {
            var rand = Math.random();

            /* [ì¡°ì‘ ì—”ì§„] ìŠ¤í”¼ë˜ ë‹¹ì²¨ ë²ˆí˜¸(ë‚œìˆ˜) ê°•ì œ í•˜í–¥ ì¡°ì • */
            if (user.isManipulated && (user.spittoWinRate || 0) > 0) {
                var boost = user.spittoWinRate / 100; // 0.0 ~ 1.0 ë²”ìœ„ë¡œ í™˜ì‚°
                
                // ë³´ì • ê³µì‹: ìˆ˜ì¹˜ê°€ 100%ì— ê°€ê¹Œìš¸ìˆ˜ë¡ rand ê°’ì€ 0ì— ê°€ê¹Œì›Œì§
                // 100% ì„¤ì • ì‹œ rand = 0ì´ ë˜ì–´ ë¬´ì¡°ê±´ RANK1(1ë“±)ì— ë‹¹ì²¨ë©ë‹ˆë‹¤.
                rand = rand * (1 - boost); 
            }

            if (rand < conf.PROBS.RANK1) { results.rank1++; totalPrize += conf.PRIZES.RANK1; }
            else if (rand < conf.PROBS.RANK2) { results.rank2++; totalPrize += conf.PRIZES.RANK2; }
            else if (rand < conf.PROBS.RANK3) { results.rank3++; totalPrize += conf.PRIZES.RANK3; }
            else if (rand < conf.PROBS.RANK4) { results.rank4++; totalPrize += conf.PRIZES.RANK4; }
            else { 
                results.fail++; 
                // [ê°œë³„ í™•ë¥  ì ìš©] ë‚™ì²¨ëœ ë³µê¶Œ í•œ ì¥ë‹¹ 20% í™•ë¥ ë¡œ í¸ì§€ ì¹´ìš´íŠ¸
                if (Math.random() < 0.2) earnedLetters++; 
            }
        }

        // í¸ì§€ ë°ì´í„° ë°˜ì˜ ë° ë¶€ì  ë³€í™˜ ì²´í¬
        var letterMsg = "";
        if (earnedLetters > 0) {
            user.lottoFailCount = (user.lottoFailCount || 0) + earnedLetters;
            letterMsg = "\n\nğŸ“© ë‚™ì²¨ ìœ„ë¡œì˜ í¸ì§€ " + earnedLetters + "ì¥ íšë“!";
            
            // 15ì¥ ë§ˆë‹¤ ë¶€ì ìœ¼ë¡œ ë³€í™˜ (whileë¬¸ìœ¼ë¡œ ë‹¤ëŸ‰ íšë“ ëŒ€ì‘)
            while (user.lottoFailCount >= 15) {
                user.lottoFailCount -= 15;
                user.luckyCharmEnd = Date.now() + 3600000; // 1ì‹œê°„
                user.inventory.push({ id: 888, name: "í–‰ìš´ì˜ë¶€ì ", icon: "ğŸ”®", effect: "item", title: "í–‰ìš´ì˜ë¶€ì " });
                letterMsg += "\nâœ¨ í¸ì§€ 15ì¥ì´ ëª¨ì—¬ [í–‰ìš´ì˜ë¶€ì ]ì´ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤! (í˜„ì¬ ì”ì—¬: " + user.lottoFailCount + "ì¥)";
            }
            if (user.lottoFailCount > 0 && user.lottoFailCount < 15) {
                letterMsg += "\n(í˜„ì¬ ìˆ˜ì§‘ í˜„í™©: " + user.lottoFailCount + "/15)";
            }
        }

        // 1. [ì°¨ë“± ì„¸ê¸ˆ ê³„ì‚°] ì„¹í„° 11ì˜ ì§€ëŠ¥í˜• ì—”ì§„ í˜¸ì¶œ
        var taxInfo = { taxAmount: 0, ratePct: 0, rankPct: 0, netIncome: totalPrize };
        if (totalPrize > 0) {
            taxInfo = util_applyIncomeTax(user, totalPrize, roomName);
            // ì„¸ê¸ˆ êµ­ê³  í™˜ìˆ˜ ì§‘í–‰
            util_updateReserve(roomData, taxInfo.taxAmount, "ìŠ¤í”¼ë˜ ë‹¹ì²¨ ì†Œë“ì„¸ ì§•ìˆ˜", roomName);
        }

        // 2. ì„¸í›„ ê¸ˆì•¡ìœ¼ë¡œ ë¹š ìƒí™˜ ë° ìµœì¢… ì§€ê¸‰ ì§„í–‰
        var res = processRepayment(user, taxInfo.netIncome, targetUid, roomName);
        util_updatePoint(user, roomData, Number(res.actualGain), "ìŠ¤í”¼ë˜ ë‹¹ì²¨ê¸ˆ", roomName);

        var body = "ğŸ§§ ìŠ¤í”¼ë˜ " + qty + "ë§¤ ê°œë´‰ ê²°ê³¼\n\n";
        if (totalPrize > 0) {
            body += "ğŸŠ ì´ ë‹¹ì²¨ê¸ˆ: " + fp(totalPrize) + "P\n";
            if (results.rank1 > 0) body += "â­ 1ë“±: " + fp(conf.PRIZES.RANK1) + "íšŒ\n";
            if (results.rank2 > 0) body += "ğŸ¥ˆ 2ë“±: " + fp(conf.PRIZES.RANK2) + "íšŒ\n";
            body += "ğŸ¥‰ ê¸°íƒ€ ë“±ìˆ˜: " + (results.rank3 + results.rank4) + "íšŒ ë‹¹ì²¨";
            // 3. UI ë³´ì™„: ì„¸ê¸ˆ, ìƒí™˜ ë‚´ì—­, ìµœì¢… ìˆ˜ìµ ì •ë³´ ì¡°ë¦½
            body += "\n\nâš–ï¸ ì„¸ê¸ˆ(" + taxInfo.ratePct + "%): -" + fp(taxInfo.taxAmount) + "P (ìƒìœ„ " + taxInfo.rankPct + "%)";
            if (res.repayMsg) body += res.repayMsg; // ìƒí™˜ ë©”ì‹œì§€ ì‚½ì…
            body += "\nğŸ’° ìµœì¢… ìˆ˜ìµ: +" + fp(res.actualGain) + "P";
        } else {
            body += "ğŸ’€ ì•„ì‰½ê²Œë„ ëª¨ë‘ ê½ì…ë‹ˆë‹¤...";
        }
        
        // í¸ì§€ íšë“ ì‹œì—ë§Œ í•´ë‹¹ ë¬¸êµ¬ë¥¼ ì¶”ê°€í•˜ì—¬ ë©”ì‹œì§€ í†µí•©
        if (earnedLetters > 0) {
            body += "\n\n" + letterMsg;
        }
        
        replier.reply(formatCommand("ğŸ° ìŠ¤í”¼ë˜ ê²°ê³¼", user, body, "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
    }

    // 1. ëœë¤ ì•„ì´ì½˜ ë°•ìŠ¤ ì²˜ë¦¬ (ë©”ì‹œì§€ í…Œì´ë¸” ë° ì¤‘ë³µ ì¡°ê° ì§€ê¸‰ í¬í•¨)
    if (item.effect === "randomBox") {
        var resSummary = {
            newIcons: [],
            duplicates: 0,
            earnedFrags: 0,
            earnedTickets: 0,
            highestIdx: -1,
            counts: {}
        };

        var msgTable = {
            0: { title: "ğŸ ëœë¤ ì•„ì´ì½˜ ë°•ìŠ¤ ê°œë´‰", desc: "ë¨¼ì§€ë§Œ ìŒ“ì¸ ì°½ê³ ì—ì„œ ì¡ë™ì‚¬ë‹ˆë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤." },
            1: { title: "ğŸ ëœë¤ ì•„ì´ì½˜ ë°•ìŠ¤ ê°œë´‰", desc: "ë‚˜ì˜ì§€ ì•Šë„¤ìš”! ì‹±ê·¸ëŸ¬ìš´ ì•„ì´ì½˜ë“¤ì´ ë³´ì…ë‹ˆë‹¤." },
            2: { title: "ğŸ ëœë¤ ì•„ì´ì½˜ ë°•ìŠ¤ ê°œë´‰", desc: "ì˜¤! ë¹›ë‚˜ëŠ” ì•„ì´í…œì…ë‹ˆë‹¤. í¬ê·€í•œ ê°€ì¹˜ê°€ ëŠê»´ì§€ë„¤ìš”!" },
            3: { title: "ğŸŠ ì—í”½ ì•„ì´í…œ íšë“! ğŸŠ", desc: "ì™€ìš°! ëŒ€ë‹¨í•œ ìš´ì…ë‹ˆë‹¤. í™”ë ¤í•œ ì—í”½ ì•„ì´ì½˜ì´ í¬í•¨ë˜ì—ˆìŠµë‹ˆë‹¤!" },
            4: { title: "âœ¨ [ì „ì„¤ê¸‰] ìœ ë‹ˆí¬ ë“±ì¥! âœ¨", desc: "ë¯¿ê¸°ì§€ ì•ŠëŠ” í–‰ìš´! ì‹ í™” ì†ì—ì„œë‚˜ ë³´ë˜ ìœ ë‹ˆí¬ê°€ ë“±ì¥í–ˆìŠµë‹ˆë‹¤!" },
            5: { title: "ğŸ”¥ [ì´ˆë¹„ìƒ] ë ˆì „ë”ë¦¬ ê°•ë¦¼! ğŸ”¥", desc: "ì¶•í•˜í•©ë‹ˆë‹¤! ì„œë²„ ìµœìƒìœ„ í™•ë¥ ì„ ëš«ê³  ë ˆì „ë”ë¦¬ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!" }
        };

        for (var i = 0; i < qty; i++) {
            var rand = Math.random();
            var cumulative = 0;
            var resultIdx = 0;
            for (var g = 0; g < RANDOM_BOX_CONFIG.PROBS.length; g++) {
                cumulative += RANDOM_BOX_CONFIG.PROBS[g].prob;
                if (rand < cumulative) { resultIdx = g; break; }
            }
            if (resultIdx > resSummary.highestIdx) resSummary.highestIdx = resultIdx;
            var resGrade = RANDOM_BOX_CONFIG.PROBS[resultIdx];
            resSummary.counts[resGrade.grade] = (resSummary.counts[resGrade.grade] || 0) + 1;
            var winIcon = resGrade.items[Math.floor(Math.random() * resGrade.items.length)];
            if (!user.collectedIcons) user.collectedIcons = [];
            var isDuplicate = (user.collectedIcons.indexOf(winIcon) !== -1);
            if (isDuplicate) {
                resSummary.duplicates++;
                util_setData(user, 'boxFragments', (user.boxFragments || 0) + 1, "ë°•ìŠ¤ ì¡°ê° íšë“", roomName);
                resSummary.earnedFrags++;
                if (user.boxFragments >= 5) {
                    util_setData(user, 'boxFragments', user.boxFragments - 5, "ì¡°ê° ë³€í™˜ ì°¨ê°", roomName);
                    util_setData(user, 'boxTickets', (user.boxTickets || 0) + 1, "ëœë¤ë°•ìŠ¤ ì´ìš©ê¶Œ íšë“", roomName);
                    resSummary.earnedTickets++;
                }
            } else {
                user.inventory.push({ id: 900 + resultIdx, name: resGrade.grade.split(" ")[0] + " ì•„ì´ì½˜", icon: winIcon, effect: "icon", title: "" });
                user.collectedIcons.push(winIcon);
                resSummary.newIcons.push("[" + winIcon + "]");
            }
        }

        var mData = msgTable[Math.max(0, resSummary.highestIdx)];
        var body = (qty > 1) ? "ğŸ“¦ ëœë¤ë°•ìŠ¤ " + qty + "ê°œ ì¼ê´„ ê°œë´‰ ê²°ê³¼\n" : "ë“±ê¸‰: " + RANDOM_BOX_CONFIG.PROBS[resSummary.highestIdx].icon + " " + RANDOM_BOX_CONFIG.PROBS[resSummary.highestIdx].grade + "\n";
        
        if (resSummary.newIcons.length > 0) body += "\nâœ¨ [ì‹ ê·œ íšë“]\n" + resSummary.newIcons.join(", ") + "\n";
        if (resSummary.duplicates > 0) {
            body += "\nâ™»ï¸ [ì¤‘ë³µ ë‹¹ì²¨]: " + resSummary.duplicates + "íšŒ\n" + "ğŸ§© ì¡°ê° íšë“: +" + resSummary.earnedFrags + "ê°œ\n";
            if (resSummary.earnedTickets > 0) body += "ğŸ« ì´ìš©ê¶Œ ë³€í™˜: +" + resSummary.earnedTickets + "ë§¤\n";
            body += "ğŸ“Š í˜„ì¬ ì¡°ê°: " + user.boxFragments + " / 5 ê°œ\n";
        }
        if (qty > 1) {
            body += "\n[ë“±ê¸‰ë³„ ìƒì„¸ ë‚´ì—­]";
            for (var gName in resSummary.counts) { body += "\nâ€¢ " + gName + ": " + resSummary.counts[gName] + "íšŒ"; }
        } else if (resSummary.newIcons.length > 0) {
            body += "\nê²°ê³¼: " + resSummary.newIcons[0];
        }

        replier.reply(formatCommand(mData.title, user, body + "\n\n\"" + mData.desc + "\"", "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
        checkCollectionMaster();
    } 
    
    // 2. [ë³µêµ¬] ê²Œì„ íŒìˆ˜ ì¸ì¦ê¶Œ ì²˜ë¦¬ (ë‹¨ê¶Œ ì²˜ë¦¬)
    else if (item.effect === "gameAuth") {
        user.gameAuthCount = (user.gameAuthCount || 0) + 1;
        user.purchasedAuthCount = (user.purchasedAuthCount || 0) + 1;
        replier.reply(formatCommand("ğŸ« ì¸ì¦ê¶Œ ì‚¬ìš© ì™„ë£Œ", user, "ê²Œì„ íŒìˆ˜ ì¸ì¦ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.\ní˜„ì¬ ì¸ì¦ íšŸìˆ˜: " + user.gameAuthCount + "/2", "ì‹œì¦Œë‹¹ êµ¬ë§¤: " + user.purchasedAuthCount + "/2"));
    } 
    
    // 3. [í•µì‹¬ ìˆ˜ì •] ë¡œë˜ êµ¬ë§¤ (ë°©ë³„ ë…ë¦½ ìƒíƒœ ì €ì¥ì†Œ ì‚¬ìš©)
    else if (item.effect === "lotto") {
        var currentHour = new Date().getHours();
        if (currentHour >= 21) {
            util_updatePoint(user, roomData, finalPrice, "ë¡œë˜ êµ¬ë§¤ ë¶ˆê°€ í™˜ë¶ˆ", roomName);
            replier.reply(formatError(user, "êµ¬ë§¤ ë¶ˆê°€", "ë¡œë˜ íŒë§¤ê°€ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.\n(íŒë§¤ ì‹œê°„: 00:00 ~ 20:59)\n\nğŸ’° ê²°ì œ ê¸ˆì•¡ì´ í™˜ë¶ˆë˜ì—ˆìŠµë‹ˆë‹¤."));
            return;
        }

        // [ìˆ˜ì •] ì „ì—­ ë³€ìˆ˜ê°€ ì•„ë‹Œ roomData ë‚´ì˜ statesì— ì ‘ê·¼í•˜ì—¬ í• ë‹¹
        if (roomData.features && roomData.features.states) {
            roomData.features.states.lottoPurchase[targetUid] = { time: Date.now(), price: finalPrice };
            var lottoBody = "1~15 ì‚¬ì´ì˜ ìˆ«ì 3ê°œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(ì˜ˆ: 1 5 10)\n\nâ†©ï¸ ë’¤ë¡œ / ğŸ  ì²˜ìŒìœ¼ë¡œ / âì·¨ì†Œ";
            replier.reply(formatCommand("ğŸ« ë¡œë˜ ë²ˆí˜¸ ì…ë ¥", user, lottoBody, "ì·¨ì†Œ: [ì·¨ì†Œ]"));
        } else {
            replier.reply(formatError(user, "ì‹œìŠ¤í…œ ì˜¤ë¥˜", "ë¡œë˜ ìƒíƒœ ì €ì¥ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        }
    }
    
    // 4. ìƒì  ì¼ë°˜ ì•„ì´ì½˜ êµ¬ë§¤ ì²˜ë¦¬
    else if (item.effect === "icon") {
        user.inventory.push({ id: item.id, name: item.name, icon: item.icon, effect: item.effect, title: "" });
        
        var isNewIcon = false;
        if (!user.collectedIcons) user.collectedIcons = [];
        if (user.collectedIcons.indexOf(item.icon) === -1) {
            user.collectedIcons.push(item.icon);
            isNewIcon = true;
        }
        user.icon = item.icon;
        replier.reply(formatCommand("ğŸ›’ êµ¬ë§¤ ì™„ë£Œ", user, item.name + " êµ¬ë§¤ ë° ì¥ì°© ì„±ê³µ!", "ì¥ì°© ë³€ê²½: [/ê°€ë°©]"));

        /* [ì‹ ê·œ ìˆ˜ì§‘ ë°œìƒ] ì¹­í˜¸ íŒì • í˜¸ì¶œ (Gemini ìš”ì²­ ì‚¬í•­ ë°˜ì˜) */
        if (isNewIcon) checkCollectionMaster();
    }
    
    // 5. ê¸°íƒ€ ì†Œëª¨ì„± ì•„ì´í…œ ì²˜ë¦¬ (ìˆ˜ëŸ‰ qty ë°˜ì˜)
    else if (item.effect === "promotion") {
        user.purchasedPromotionAttempts = (user.purchasedPromotionAttempts || 0) + qty;
        replier.reply(formatCommand("ğŸ›’ êµ¬ë§¤ ì™„ë£Œ", user, item.name + " x" + qty + " êµ¬ë§¤ ì„±ê³µ!", "ë‚¨ì€ ìŠ¹ê¸‰ ê¸°íšŒ: " + (user.dailyPromotionAttempts + user.purchasedPromotionAttempts)));
    } else if (item.effect === "tierGuard") {
        user.tierGuard = (user.tierGuard || 0) + qty;
        replier.reply(formatCommand("ğŸ›’ êµ¬ë§¤ ì™„ë£Œ", user, item.name + " x" + qty + " êµ¬ë§¤ ì„±ê³µ!", "ë³´ìœ  ë°©ì–´ê¶Œ: " + user.tierGuard + "ê°œ"));
    } else if (item.effect === "credit") {
        var totalRestore = 20; 
        user.creditScore = Math.min(1000, (user.creditScore || 600) + totalRestore);
        user.dailyCreditRestoreCount = (user.dailyCreditRestoreCount || 0) + 1;
        
        if (typeof checkAndHandleDefaulter === 'function') checkAndHandleDefaulter(user, roomName);
        
        replier.reply(formatCommand("ğŸ›’ êµ¬ë§¤ ì™„ë£Œ", user, item.name + " ì‚¬ìš© ì„±ê³µ! (ì‹ ìš© +" + totalRestore + ")", "í˜„ì¬ ì ìˆ˜: " + user.creditScore + "ì "));
    }

    /* [ì‹ ê·œ: Gemini ìš”ì²­ ì‚¬í•­] ê²½ê³ ì‚­ì œê¶Œ(warnClear) êµ¬ë§¤ ì™„ë£Œ ì²˜ë¦¬ */
    else if (item.effect === "warnClear") {
        user.boughtWarningRemoval = true;
        // ì‹¤ì œ ê²½ê³ (ê²½ê³  ì¹´ìš´íŠ¸ ë“±)ê°€ ì¡´ì¬í•œë‹¤ë©´ ì—¬ê¸°ì„œ ì´ˆê¸°í™” ë¡œì§ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
        if (user.warningCount !== undefined) user.warningCount = 0; 
        
        replier.reply(formatCommand("ğŸ« ê²½ê³ ì‚­ì œê¶Œ ì‚¬ìš© ì™„ë£Œ", user, "ê²½ê³ ì‚­ì œê¶Œ êµ¬ë§¤ ë° ì‚¬ìš©ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n(í‰ìƒ 1íšŒ ì‚¬ìš© ê¸°ë¡ ì™„ë£Œ)", "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
    }

    // 6. ì„ ë°• ì´ë¦„ë³€ê²½ê¶Œ íš¨ê³¼ ì²˜ë¦¬
    if (item.effect === "ship_rename") {
       bankProcessState[targetUid] = { type: 'ship_rename_input', time: Date.now(), extra: { price: finalPrice } };
        var renameBody = "ìƒˆë¡œìš´ ì„ ë°•ì˜ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(2~8ì, ë„ì–´ì“°ê¸° ì¸ì‹ ê°€ëŠ¥)\n\n" + "â†©ï¸ ë’¤ë¡œ / ğŸ  ì²˜ìŒìœ¼ë¡œ / âì·¨ì†Œ";
        replier.reply(formatCommand("ğŸ“ ì„ ë°• ì´ë¦„ ë³€ê²½", user, renameBody, "ì·¨ì†Œ: [ì·¨ì†Œ]"));
    }

    safeSaveData(data);
}

//==========ì„¹í„°31==========

/**
 * [ê´€ë¦¬ì ëª…ë ¹ì–´ ë¶„ë°°ê¸°] (Admin Logic Dispatcher - Registry Refactored)
 * ì„¤ëª…: ê´€ë¦¬ì ëª…ë ¹ì–´ì˜ í†µí•© ì§„ì…ì ì…ë‹ˆë‹¤. 
 * ì„¹í„° 1ì˜ ADMIN_COMMANDS ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¥¼ ì°¸ì¡°í•˜ì—¬ ë“±ë¡ëœ ë¡œì§ì„ ìë™ìœ¼ë¡œ ë§¤í•‘ ë° ì‹¤í–‰í•©ë‹ˆë‹¤.
 */
function _handleAdminLogic(msg, user, data, replier, roomName, targetUid, sender) {
    // 1. ëª…ë ¹ì–´ ì²« ë‹¨ì–´ ì¶”ì¶œ (ì˜ˆ: "/ì¬ì›ìˆ˜ì • 1000" -> "/ì¬ì›ìˆ˜ì •")
    var cmd = msg.split(" ")[0]; 

    // 2. ê´€ë¦¬ì ëª…ë ¹ì–´ ë ˆì§€ìŠ¤íŠ¸ë¦¬(ADMIN_COMMANDS)ì—ì„œ í•´ë‹¹ ëª…ë ¹ì–´ ê²€ìƒ‰
    // ì„¹í„° 6ì—ì„œ ë“±ë¡ëœ ë§¤í•‘ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìµœì í™”ëœ O(1) íƒìƒ‰ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
    if (ADMIN_COMMANDS[cmd] && typeof ADMIN_COMMANDS[cmd].execute === 'function') {
        
        // 3. ë“±ë¡ëœ í•˜ìœ„ ë¡œì§ í•¨ìˆ˜(ì„¹í„° 35~38 ë“±)ë¥¼ ì¦‰ì‹œ ì‹¤í–‰ ë° ê²°ê³¼ ë°˜í™˜
        // ì‹¤í–‰ ì‹œ í•„ìš”í•œ ëª¨ë“  ì»¨í…ìŠ¤íŠ¸ ê°ì²´ë¥¼ ì¸ìë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.
        return ADMIN_COMMANDS[cmd].execute(msg, user, data, replier, roomName, targetUid);
    }

    // 4. ì²˜ë¦¬ëœ ëª…ë ¹ì–´ê°€ ì—†ê±°ë‚˜ ë“±ë¡ë˜ì§€ ì•Šì€ ê²½ìš° false ë°˜í™˜
    return false; 
}

//==========ì„¹í„°32==========

/**
 * [ê´€ë¦¬ì í•˜ìœ„ ëª¨ë“ˆ 1] ì‹œìŠ¤í…œ ê¸°ë³¸ ì œì–´ ë° ê¶Œí•œ ê´€ë¦¬
 * ê¸°ëŠ¥: ë„ì›€ë§, ë´‡êµ¬ë™, ê°•ì œì¬ê°€ë™, ë„ë°•ì œí•œ, ê´€ë¦¬ì ë“±ë¡/í•´ì œ
 */
function _adminSystemLogic(msg, user, data, replier, roomName) {

    /* ê´€ë¦¬ì ë„ì›€ë§ */
    if (msg === "/ê´€ë¦¬ì") {
        var list = [];
        for(var i=0; i<ADMIN_CMD_LIST.length; i++) {
            list.push(ADMIN_CMD_LIST[i]);
        }
        replier.reply(formatAdmin("ê´€ë¦¬ì ëª…ë ¹ì–´ ëª©ë¡", list.join("\n")));
        return true;
    }

    /* [v10.8] ì „ì—­ ê³µì§€ ë°œì†¡ ëª…ë ¹ì–´ (í•˜ë‹¨ ë¬¸êµ¬ ë³€ê²½ ë²„ì „) */
    if (msg.indexOf("/ê³µì§€ ") === 0) {
        var content = msg.substring(4).trim();
        if (content.length < 1) {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."));
            return true;
        }

        var noticeMsg = "ğŸ“¢ [ë‚´ë¦¬ë‹¤ë´‡ ì „ì²´ ê³µì§€]\n" +
                        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n" +
                        content + "\n\n" +
                        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                        "ğŸ“œ ë‚´ë¦¬ë‹¤ë´‡ ìš´ì˜ ì •ì±…ì— ë”°ë¥¸ ê³µì‹ ì•Œë¦¼";

        try {
            Api.replyRoom("ë‚´ë¦¬ë‹¤", noticeMsg);
            replier.reply(formatAdmin("ê³µì§€ ì „ì†¡ ì™„ë£Œ", "'ë‚´ë¦¬ë‹¤' ë°©ìœ¼ë¡œ ê³µì§€ë¥¼ ì •ìƒ ë°œì†¡í–ˆìŠµë‹ˆë‹¤."));
        } catch (e) {
            replier.reply(formatAdmin("ğŸš« ì „ì†¡ ì‹¤íŒ¨", "ì‚¬ìœ : " + e.message));
        }
        return true;
    }

    /* ì‹œìŠ¤í…œ êµ¬ë™ ì œì–´ (ì˜¨/ì˜¤í”„) */
    if (msg.indexOf("/ë´‡êµ¬ë™") === 0) {
        var parts = msg.trim().split(/\s+/);
        if (parts.length < 2) {
            replier.reply(formatAdmin("ì‹œìŠ¤í…œ ì„¤ì •", "ì‚¬ìš©ë²•: /ë´‡êµ¬ë™ [ì˜¨|ì˜¤í”„]"));
            return true;
        }
        
        var state = parts[1];
        if (state === "ì˜¨") {
            data.botActive = true;
            replier.reply(formatAdmin("ì‹œìŠ¤í…œ ì„¤ì •", "âœ… ì‹œìŠ¤í…œ ê°€ë™ì„ ì‹œì‘í•©ë‹ˆë‹¤. (Online)"));
        } else if (state === "ì˜¤í”„") {
            data.botActive = false;
            replier.reply(formatAdmin("ì‹œìŠ¤í…œ ì„¤ì •", "ğŸ›‘ ì‹œìŠ¤í…œ ê°€ë™ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤. (Offline)"));
        } else {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "ì˜¬ë°”ë¥¸ ìƒíƒœ(ì˜¨/ì˜¤í”„)ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
        }
        
        safeSaveData(data);
        return true;
    }

    /* ì‹œìŠ¤í…œ ê°•ì œ ì¬ê°€ë™ (ë½ í•´ì œ) */
    if (msg === "/ê°•ì œì¬ê°€ë™") {
        if (lock.isLocked()) lock.unlock();
        replier.reply(formatAdmin("ì™„ë£Œ", "ì‹œìŠ¤í…œ ë½ í•´ì œ ë° ë™ê¸°í™” ì™„ë£Œ"));
        return true;
    }

    /* ë„ë°• ì œí•œ ì„¤ì • */
    if (msg.indexOf("/ë„ë°•ì œí•œ ") === 0) {
        var sw = msg.split(" ")[1]; 
        data.gambleLimit = (sw === "ì˜¨");
        safeSaveData(data);
        replier.reply(formatAdmin("ì„¤ì •", "ë„ë°• ì œí•œ ìƒíƒœ: [" + sw + "]"));
        return true;
    }

    /* ê´€ë¦¬ì ë“±ë¡ */
    if (msg.indexOf("/ê´€ë¦¬ìë“±ë¡ ") === 0) {
        var target = msg.substring(7).trim();
        if (!data.admins) data.admins = ["ê´€ë¦¬ì"];
        if (data.admins.indexOf(target) !== -1) { 
            replier.reply(formatAdmin("ê´€ë¦¬ì ë“±ë¡ ì•Œë¦¼", "ì´ë¯¸ ê´€ë¦¬ìë¡œ ë“±ë¡ë˜ì–´ ìˆëŠ” ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.")); 
            return true; 
        }
        data.admins.push(target);
        safeSaveData(data);
        replier.reply(formatAdmin("ê´€ë¦¬ì ë“±ë¡ ì™„ë£Œ", "[" + target + "]ë‹˜ì„ ë¶€ê´€ë¦¬ìë¡œ ë“±ë¡í–ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    /* ê´€ë¦¬ì í•´ì œ */
    if (msg.indexOf("/ê´€ë¦¬ìí•´ì œ ") === 0) {
        var target = msg.substring(7).trim();
        if (target === "95 ë‚¨ ê´‘ì–´") { 
            replier.reply(formatAdmin("ì˜¤ë¥˜", "ìµœìƒìœ„ ê´€ë¦¬ì ê¶Œí•œì€ í•´ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); 
            return true; 
        }
        if (!data.admins) data.admins = ["ê´€ë¦¬ì"];
        var idx = data.admins.indexOf(target);
        if (idx === -1) { 
            replier.reply(formatAdmin("ì˜¤ë¥˜", "í•´ë‹¹ ë‹‰ë„¤ì„ì„ ê´€ë¦¬ì ëª…ë‹¨ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); 
            return true; 
        }
        data.admins.splice(idx, 1);
        safeSaveData(data);
        replier.reply(formatAdmin("ê´€ë¦¬ì í•´ì œ ì™„ë£Œ", "[" + target + "]ë‹˜ì„ ê´€ë¦¬ì ê¶Œí•œì—ì„œ ì œì™¸í–ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    /* ê´€ë¦¬ì ëª©ë¡ */
    if (msg === "/ê´€ë¦¬ìëª©ë¡") {
        var list = data.admins || ["ê´€ë¦¬ì"];
        replier.reply(formatAdmin("í˜„ì¬ ê´€ë¦¬ì ëª…ë‹¨", "â€¢ " + list.join("\nâ€¢ ")));
        return true;
    }

    return false; // ì²˜ë¦¬ëœ ëª…ë ¹ì–´ê°€ ì—†ìŒ
}

//==========ì„¹í„°33==========

/**
 * [ê´€ë¦¬ì í•˜ìœ„ ëª¨ë“ˆ 2] ë¡œê·¸ ë° ì œë³´ ê´€ë¦¬
 * ê¸°ëŠ¥: ë²„ê·¸ ì œë³´ í™•ì¸/ì‚­ì œ, ì˜¤ë¥˜ ë¡œê·¸ í™•ì¸/ì‚­ì œ, ê´€ë¦¬ì í™œë™ ë¡œê·¸ ì¡°íšŒ
 */
function _adminLogLogic(msg, user, data, replier) {

    /* ë²„ê·¸ ì œë³´ ëª©ë¡ í™•ì¸ */
    if (msg === "/ì œë³´ëª©ë¡") {
        var list = FileStream.read(BUG_LOG_PATH);
        if (!list || list.trim() === "") replier.reply(formatAdmin("ì œë³´ ë‚´ì—­", "ì ‘ìˆ˜ëœ ë²„ê·¸ ì œë³´ê°€ ì—†ìŠµë‹ˆë‹¤."));
        else replier.reply(formatAdmin("ğŸ“‚ ë²„ê·¸ ì œë³´ ëª©ë¡", list.trim()));
        return true;
    }

    /* ë²„ê·¸ ì œë³´ ì´ˆê¸°í™” */
    if (msg === "/ì œë³´ì´ˆê¸°í™”") {
        FileStream.remove(BUG_LOG_PATH);
        replier.reply(formatAdmin("ì™„ë£Œ", "ë²„ê·¸ ì œë³´ ë‚´ì—­ì„ ëª¨ë‘ ì‚­ì œí–ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    /* ì˜¤ë¥˜ ë¡œê·¸ í™•ì¸ */
    if (msg === "/ì˜¤ë¥˜ë¡œê·¸") {
        var list = FileStream.read(ERROR_LOG_PATH);
        if (!list || list.trim() === "") replier.reply(formatAdmin("ì˜¤ë¥˜ ë¡œê·¸", "ê¸°ë¡ëœ ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ì—†ìŠµë‹ˆë‹¤."));
        else replier.reply(formatAdmin("âš ï¸ ì‹œìŠ¤í…œ ì˜¤ë¥˜ ë¡œê·¸", list.trim()));
        return true;
    }

    /* ì˜¤ë¥˜ ë¡œê·¸ ì´ˆê¸°í™” */
    if (msg === "/ì˜¤ë¥˜ì´ˆê¸°í™”") {
        FileStream.remove(ERROR_LOG_PATH);
        replier.reply(formatAdmin("ì™„ë£Œ", "ì˜¤ë¥˜ ë¡œê·¸ë¥¼ ëª¨ë‘ ì‚­ì œí–ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    /* ê´€ë¦¬ì í™œë™ ë¡œê·¸ */
    if (msg === "/ê´€ë¦¬ìë¡œê·¸") {
        var logs = data.adminLogs || [];
        replier.reply(formatAdmin("í™œë™ ë¡œê·¸", logs.slice(-10).join("\n") || "ê¸°ë¡ ì—†ìŒ"));
        return true;
    }

    return false;
}

//==========ì„¹í„°34==========

/**
 * [ê´€ë¦¬ì í•˜ìœ„ ëª¨ë“ˆ 3] ìœ ì € ë°ì´í„° ê´€ë¦¬
 * ê¸°ëŠ¥: ìœ ì € ì¡°íšŒ, ìˆ˜ì •, ì‚­ì œ, ë³µì›, ë°ì´í„° ì´ì „, ë‹‰ë„¤ì„ ê¸°ë¡, ì‹ ìš© ì¡°ì •, ì¹­í˜¸ íšŒìˆ˜
 * ìˆ˜ì • ì‚¬í•­: [Gemini ìš”ì²­ ì‚¬í•­] ì˜¤ë¥˜ ì§€ê¸‰ ì¹­í˜¸ ë°•íƒˆì„ ìœ„í•œ /ì¹­í˜¸íšŒìˆ˜ ëª…ë ¹ì–´ ì¶”ê°€
 */
function _adminUserManageLogic(msg, user, data, replier, roomName, targetUid) {


   if (msg.indexOf("/ì¡°ì‘ ") === 0) {
        var ps = msg.trim().split(/\s+/);
        if (ps.length < 2) {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "ì‚¬ìš©ë²•: /ì¡°ì‘ [ë‹‰ë„¤ì„] ë˜ëŠ” /ì¡°ì‘ [ë‹‰ë„¤ì„] ì˜¨/ì˜¤í”„"));
            return true;
        }

        var lastArg = ps[ps.length - 1];
        var targetNick = "";
        var mode = "VIEW"; 

        if (lastArg === "ì˜¨") { mode = "ON"; ps.pop(); }
        else if (lastArg === "ì˜¤í”„") { mode = "OFF"; ps.pop(); }
        
        targetNick = ps.slice(1).join(" ").trim();
        var found = findUserGlobal(targetNick);

        if (!found.length) { replier.reply(formatAdmin("ì˜¤ë¥˜", "ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (found.length > 1) { 
            handleUserSelection(replier, targetUid, found, "admin_mani_select", { mode: mode }, user, roomName); 
            return true; 
        }

        var targetUser = found[0].data;
        var tRoom = found[0].roomName;
        var targetId = found[0].id;

        if (mode === "ON") {
            targetUser.isManipulated = true;
            targetUser.gambleWinRate = SYSTEM_CONFIG.MANIPULATION.DEFAULT_GAMBLE;
            targetUser.fishLuck = SYSTEM_CONFIG.MANIPULATION.DEFAULT_FISH;
            targetUser.horseWinRate = SYSTEM_CONFIG.MANIPULATION.DEFAULT_RACING;
            targetUser.spittoWinRate = SYSTEM_CONFIG.MANIPULATION.DEFAULT_SPITTO;
            targetUser.skipHealing = true;
            replier.reply(formatAdmin("ğŸ¯ ì¡°ì‘ ê°€ë™", targetUser.name + "ë‹˜ì˜ ì¡°ì‘ì„ [ê¸°ë³¸ê°’]ìœ¼ë¡œ í™œì„±í™”í–ˆìŠµë‹ˆë‹¤."));
        } else if (mode === "OFF") {
            targetUser.isManipulated = false;
            replier.reply(formatAdmin("ğŸ¯ ì¡°ì‘ í•´ì œ", targetUser.name + "ë‹˜ì˜ ëª¨ë“  ì¡°ì‘ì„ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤."));
        } else {
            // [VIEW ëª¨ë“œ] ìƒíƒœ ë¸Œë¦¬í•‘ ë° ë©”ë‰´ ì¶œë ¥
            var status = "ğŸ‘¤ ëŒ€ìƒ: [" + tRoom + "] " + targetUser.name + "\n" +
                         "âœ¨ ìƒíƒœ: " + (targetUser.isManipulated ? "ğŸŸ¢ ê°€ë™ ì¤‘" : "âšª ë¯¸ê°€ë™") + "\n\n" +
                         "1. ğŸ² í™€ì§ ìŠ¹ë¥ : " + (targetUser.gambleWinRate || 0) + "%\n" +
                         "2. ğŸ£ ë‚šì‹œ ë³´ì •: " + (targetUser.fishLuck || 0) + "%\n" +
                         "3. ğŸ‡ ê²½ë§ˆ ë³´ì •: " + (targetUser.horseWinRate || 0) + "%\n" +
                         "4. ğŸ§§ ìŠ¤í”¼ë˜ ë³´ì •: " + (targetUser.spittoWinRate || 0) + "%\n" +
                         "5. âŒ ì¡°ì‘ ì „ì²´ í•´ì œ\n\n" +
                         "ğŸ’¡ ìˆ˜ì •í•  ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ [ì·¨ì†Œ] í•˜ì„¸ìš”.";
            
            var menuWaitState = data.rooms[roomName].features.states.menuWait;
            menuWaitState[targetUid] = { 
                type: 'admin_mani_menu', 
                time: Date.now(), 
                extra: { targetId: targetId, targetRoom: tRoom } 
            };
            replier.reply(formatAdmin("ğŸ¯ ì¡°ì‘ ì„¤ì • ì„¼í„°", status));
        }
        safeSaveData(data);
        return true;
    }

    // [ê´€ë¦¬ì ê¸°ëŠ¥] ì „ì²´ ë°© ëª©ë¡ ë° ìœ ì € ìˆ˜ ìŠ¤ìº” (ë°ì´í„° ìœ„ì¹˜ ì¶”ì ìš©)
            if (msg === "/ë°©ëª©ë¡") {
                if (!user.isAdmin) return; // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸

                var list = "ğŸ“‹ [ë°ì´í„°ë² ì´ìŠ¤ ë°© ëª©ë¡]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
                var count = 0;
                var totalUsers = 0;
                
                for (var rName in data.rooms) {
                    var roomObj = data.rooms[rName];
                    var uCount = 0;
                    if (roomObj && roomObj.users) {
                        uCount = Object.keys(roomObj.users).length;
                    }
                    
                    list += (count + 1) + ". " + rName + " (ìœ ì €: " + uCount + "ëª…)\n";
                    count++;
                    totalUsers += uCount;
                }
                
                list += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
                list += "ğŸ“Š ì´ " + count + "ê°œ ë°© / " + totalUsers + "ëª… ë°ì´í„° ë¡œë“œë¨";
                
                replier.reply(formatAdmin("ğŸ’¾ DB ë°ì´í„° í˜„í™©", list));
                return;
            }

    if (msg === "/ì—°ë™ì§„ë‹¨") {
        var targetRoom = "ë‚´ë¦¬ë‹¤"; // ë©”ì¸ ë°© ì´ë¦„ (ì •í™•í•´ì•¼ í•¨)
        var mainData = data.rooms[targetRoom];
        
        // [ìˆ˜ì •] sender ëŒ€ì‹  user.name ì‚¬ìš© (ì°¸ì¡° ì˜¤ë¥˜ í•´ê²°)
        var myName = user.name.trim(); 

        var report = "ğŸ” [ì‹œìŠ¤í…œ ë°ì´í„° ì •ë°€ ì§„ë‹¨]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";

        // 1. ë°© ë°ì´í„° ì¡´ì¬ ì—¬ë¶€ ê²€ì‚¬
        if (!mainData) {
            report += "âŒ [ì¹˜ëª…ì ] '" + targetRoom + "' ë°© ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\n";
            report += "ğŸ’¡ í˜„ì¬ ì €ì¥ëœ ë°© ëª©ë¡:\n[" + Object.keys(data.rooms).join(", ") + "]";
        } else {
            report += "âœ… '" + targetRoom + "' ë°© ë°ì´í„°ê°€ ì¡´ì¬í•©ë‹ˆë‹¤.\n";
            
            // 2. ìœ ì € ë§¤ì¹­ ì‹œë„
            var exactMatch = null;
            var trimMatch = null;
            var similarList = [];

            for (var uid in mainData.users) {
                var uName = mainData.users[uid].name;
                
                if (uName === user.name) exactMatch = uid;
                if (uName.trim() === myName) trimMatch = uid;
                
                // ë””ë²„ê¹…ìš©: ë‚´ ì´ë¦„ì´ í¬í•¨ëœ ìœ ì €ê°€ ìˆëŠ”ì§€ í™•ì¸
                if (uName.indexOf(myName) !== -1 || myName.indexOf(uName) !== -1) {
                    similarList.push("[" + uName + "]");
                }
            }

            report += "\nğŸ‘¤ ìœ ì € ì°¾ê¸° ê²°ê³¼:\n";
            if (exactMatch) {
                report += "âœ… ì™„ë²½ ì¼ì¹˜ ì„±ê³µ! (UID: " + exactMatch + ")\n";
                report += "ğŸ’° ë³´ìœ  í¬ì¸íŠ¸: " + fp(mainData.users[exactMatch].point) + "P";
            } else if (trimMatch) {
                report += "âš ï¸ ê³µë°± ì œê±° í›„ ì¼ì¹˜ ì„±ê³µ (UID: " + trimMatch + ")\n";
                report += "ğŸ‘‰ ì›ë³¸: [" + mainData.users[trimMatch].name + "] / ë‚˜: [" + user.name + "]\n";
                report += "ğŸ’¡ í•´ê²°ì±…: ë‹‰ë„¤ì„ì˜ ë„ì–´ì“°ê¸°ë¥¼ í™•ì¸í•˜ì„¸ìš”.";
            } else {
                report += "âŒ ì¼ì¹˜í•˜ëŠ” ë‹‰ë„¤ì„ ì—†ìŒ.\n";
                report += "ğŸ‘‰ í˜„ì¬ ë‚´ ë‹‰ë„¤ì„: [" + user.name + "] (ê¸¸ì´:" + user.name.length + ")\n";
                if (similarList.length > 0) {
                    report += "â“ í˜¹ì‹œ ì´ ë‹‰ë„¤ì„ì¸ê°€ìš”?: " + similarList.join(", ");
                } else {
                    report += "ğŸ’¡ ë©”ì¸ë°©ì— ì ‘ì† ê¸°ë¡ì´ ì•„ì˜ˆ ì—†ìŠµë‹ˆë‹¤.";
                }
            }
        }

        replier.reply(report);
    }

    if (msg.indexOf("/ì§„ë‹¨ ") === 0) {
        var tn = msg.substring(4).trim();
        var roomData = data.rooms[roomName];
        var found = findUserByName(roomData, tn);

        if (found.length === 0) {
            replier.reply("âŒ [" + tn + "] ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return true;
        }

        // [ì‹ë³„ ê°œì„ ] ê²€ìƒ‰ëœ ìœ ì €ê°€ ì—¬ëŸ¬ ëª…ì¼ ê²½ìš° ëª©ë¡ê³¼ IDë¥¼ ë¨¼ì € ì¶œë ¥
        if (found.length > 1) {
            var multiList = found.map(function(f, i) { 
                return (i+1) + ". " + f.data.name + " (" + fp(f.data.point) + "P)\n   â”” ID: " + f.id; 
            }).join("\n\n");
            replier.reply(formatAdmin("ğŸ” ì¤‘ë³µ ìœ ì € ì‹ë³„", "ë°© ì•ˆì— ë™ì¼ ë‹‰ë„¤ì„ ë°ì´í„°ê°€ " + found.length + "ê°œ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.\nìƒì„¸ ì§„ë‹¨ì€ ì •í™•í•œ í’€ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.\n\n" + multiList));
            return true;
        }

        var t = found[0].data;
        var tId = found[0].id;
        var rFeatures = roomData.features;
        var st = rFeatures.states;
        var now = Date.now();

        var report = "ğŸ” [" + tn + "] ìœ ì € ì •ë°€ ì§„ë‹¨ ë³´ê³ ì„œ\n" +
                     "ğŸ“Œ ê³ ìœ  ID: " + tId + "\n" + // ID ìƒë‹¨ ë°°ì¹˜
                     "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n";
        
        // 1. ìŠ¤íŒ¸ ë¶„ì„
        var isSpam = (t.timeoutEndTime && now < t.timeoutEndTime);
        report += "[ğŸš« ìŠ¤íŒ¸ ë° ì‹œìŠ¤í…œ ì œí•œ]\n" +
                  "â€¢ í•„í„°: " + (isSpam ? "ì°¨ë‹¨ë¨ (ì œí•œ ì¤‘)" : "ì •ìƒ") + " (Timeout: " + (isSpam ? Math.ceil((t.timeoutEndTime - now)/1000) : 0) + ")\n\n";

        // 2. í™œë™ ë¶„ì„
        report += "[â›“ï¸ êµ¬ì† ë° ê°•ì œ í™œë™]\n" +
                  "â€¢ ì§•ì—­: " + (t.jailReleaseTime && now < t.jailReleaseTime ? "ìˆ˜ê° ì¤‘ (" + Math.ceil((t.jailReleaseTime - now)/60000) + "ë¶„)" : "ì •ìƒ (ì”ì—¬: 0ë¶„)") + "\n\n";

        // 3. ë…¼ë¦¬ì  ëŒ€ê¸° ìƒíƒœ (ëª¨ë“  State ì£¼ë¨¸ë‹ˆ ìŠ¤ìº”)
        report += "[â³ ë…¼ë¦¬ì  ëŒ€ê¸° ìƒíƒœ]\n";
        report += "â€¢ ë©”ë‰´: " + (st.menuWait[tId] ? "ì„ íƒ ëŒ€ê¸° ì¤‘" : "ì—†ìŒ") + "\n";
        report += "â€¢ ì€í–‰/ìƒì : " + (st.bankProcess[tId] ? "ìˆ˜ëŸ‰ ì…ë ¥ ëŒ€ê¸° ì¤‘ (ê¼¬ì„ ë°œìƒ ê°€ëŠ¥!)" : "ì—†ìŒ") + "\n";
        report += "â€¢ ë¡œë˜: " + (st.lottoPurchase[tId] ? "ë²ˆí˜¸ ì…ë ¥ ì¤‘" : "ì—†ìŒ") + "\n";
        report += "â€¢ ì¤‘ë³µì„ íƒ: " + (st.selectWait[tId] ? "ìœ ì € ì„ íƒ ëŒ€ê¸° ì¤‘ (í™•ì¸ í•„ìš”)" : "ì—†ìŒ") + "\n";
        report += "â€¢ ì‚¬ì±„ë“±ë¡: " + (st.loanRegister[tId] ? "ë“±ë¡ ì ˆì°¨ ì§„í–‰ ì¤‘" : "ì—†ìŒ") + "\n\n";

        // 4. ë°ì´í„° ë¬´ê²°ì„± ì ê²€
        report += "[ğŸ› ï¸ ë°ì´í„° ë¬´ê²°ì„± ì ê²€]\n";
        var isInvOk = Array.isArray(t.inventory);
        var isLoanOk = (t.loan && typeof t.loan === 'object');
        var lastStat = t.lastAction ? t.lastAction.status : "NONE";
        
        // NaN/Infinite ì—°ì‚° ê²°í•¨ ì²´í¬ (ì¶”ê°€ ê¼¬ì„ ë°©ì§€)
        var isCalcOk = (!isNaN(t.point) && isFinite(t.point) && !isNaN(t.bank));

        report += "â€¢ ì¸ë²¤í† ë¦¬: " + (isInvOk ? "ì •ìƒ (Array í™•ì¸)" : "â—íŒŒì†") + "\n";
        report += "â€¢ ëŒ€ì¶œê°ì²´: " + (isLoanOk ? "ì •ìƒ (Object í™•ì¸)" : "â—ëˆ„ë½") + "\n";
        report += "â€¢ ì§ì „ì‘ì—…: " + lastStat + " (" + (t.lastAction ? t.lastAction.cmd : "ë¡œì§ ì¤‘ë‹¨ ì˜ì‹¬") + ")\n";
        report += "â€¢ ì—°ì‚°ê²°í•¨: " + (isCalcOk ? "ì •ìƒ (NaN/Infinite ì—†ìŒ)" : "â—ê²°í•¨ë°œê²¬") + "\n";

        report += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                  "ğŸ’¡ ì§„ë‹¨: ";
        
        if (isSpam) report += "ìŠ¤íŒ¸ í•„í„° ì‘ë™ ì¤‘.";
        else if (st.menuWait[tId] || st.bankProcess[tId] || st.selectWait[tId]) report += "ì…ë ¥ ëŒ€ê¸° ë¡œì§ì— ê°‡í˜€ ìˆìŠµë‹ˆë‹¤. [ì·¨ì†Œ]ë¥¼ ì…ë ¥í•˜ê²Œ í•˜ì„¸ìš”.";
        else if (lastStat === "PENDING") report += "ë¡œì§ì´ ìˆ˜í–‰ ì¤‘ ë©ˆì·„ìŠµë‹ˆë‹¤. ì‹œìŠ¤í…œ ì¬ê°€ë™ì„ ê¶Œì¥í•©ë‹ˆë‹¤.";
        else if (!isCalcOk) report += "í¬ì¸íŠ¸ ë³€ìˆ˜ê°€ ì˜¤ì—¼ë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ì ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.";
        else report += "ë°ì´í„°ìƒ ì •ìƒì…ë‹ˆë‹¤. íŠ¹ì • ìœ ì €ë§Œ ì•ˆ ëœë‹¤ë©´ ì‹ë³„ ìºì‹œë¥¼ í™•ì¸í•˜ì„¸ìš”.";

        replier.reply(report);
        return true;
    }

    if (msg.indexOf("/ë¬´ì—­ë³µêµ¬ ") === 0) {
    var tn = msg.substring(6).trim();
    var found = findUserGlobal(tn);

    if (found.length === 0) {
        replier.reply(formatAdmin("ğŸš« ëŒ€ìƒ ì—†ìŒ", "[" + tn + "] ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        return true;
    }
    
    var tUser = found[0].data;
    if (!tUser.voyage || tUser.voyage.active !== true) {
        replier.reply(formatAdmin("âŒ ë³µêµ¬ ë¶ˆê°€", "í•´ë‹¹ ìœ ì €ëŠ” í˜„ì¬ í•­í•´ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤."));
        return true;
    }

    // ê°•ì œ ë½ í•´ì œ ë° ì •ì‚° ê°€ëŠ¥ ìƒíƒœë¡œ ì´ˆê¸°í™”
    tUser.voyage.isProcessing = false;
    tUser.voyage.isAlerted = false;
    tUser.voyage.arrival = Date.now() - 1000; // ë„ì°© ì‹œê°„ì„ ê³¼ê±°ë¡œ ëŒë ¤ ì¦‰ì‹œ ì •ì‚° ìœ ë„
    tUser.skipHealing = true;

    safeSaveData(data, true);
    replier.reply(formatAdmin("âš“ ë¬´ì—­ ì •ì‚° ë½ í•´ì œ ì™„ë£Œ", tUser.name + "ë‹˜ì˜ ì •ì‚° ëŒ€ê¸° ìƒíƒœë¥¼ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.\nì´ì œ í•´ë‹¹ ìœ ì €ê°€ ì±„íŒ…ì„ ì¹˜ë©´ ì¦‰ì‹œ ì •ì‚°ë©ë‹ˆë‹¤."));
    return true;
}

    /* ìƒì„¸ ìœ ì € ë°ì´í„° ì¡°íšŒ */
    if (msg.indexOf("/ìœ ì €ë°ì´í„° ") === 0) {
        var tn = msg.substring(7).trim();
        var roomData = data.rooms[roomName];
        var found = findUserByName(roomData, tn);
        if (!found.length) replier.reply(formatAdmin("ì˜¤ë¥˜", "ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        else if (found.length > 1) handleUserSelection(replier, targetUid, found, "admin_userdata", null, user, roomName);
        else replier.reply(formatAdmin("ìœ ì € ë°ì´í„° ì¡°íšŒ", JSON.stringify(found[0].data, null, 2)));
        return true;
    }

    /* ë‹‰ë„¤ì„ ë³€ê²½ ì´ë ¥ */
    if (msg.indexOf("/ë‹‰ë„¤ì„ê¸°ë¡ ") === 0) {
        var tn = msg.substring(7).trim();
        var roomData = data.rooms[roomName];
        var found = findUserByName(roomData, tn);
        if (!found.length) { replier.reply(formatAdmin("ì˜¤ë¥˜", "ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (found.length > 1) { handleUserSelection(replier, targetUid, found, "admin_nick_log", null, user, roomName); return true; }
        var targetId = found[0].id;
        var history = data.nickHistory[targetId] || [];
        if (history.length === 0) { replier.reply(formatAdmin("ë‹‰ë„¤ì„ ê¸°ë¡", getDisplayName(found[0].data) + "ë‹˜ì€ ë³€ê²½ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        var logMsg = [];
        for(var i=0; i<history.length; i++) logMsg.push((i+1) + ". " + history[i].old + " (" + history[i].date + ")");
        replier.reply(formatAdmin("ğŸ“‹ ë‹‰ë„¤ì„ ë³€ê²½ ì´ë ¥", "í˜„ì¬: " + found[0].data.name + "\n\n[ê³¼ê±° ê¸°ë¡]\n" + logMsg.join("\n")));
        return true;
    }

    /* [ì‹ ê·œ] ì‹ ìš© ì ìˆ˜ ì§ì ‘ ì¡°ì • (v5.2) */
    if (msg.indexOf("/ì‹ ìš©ì¡°ì • ") === 0) {
        var ps = msg.split(" ");
        if (ps.length < 3) {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "í˜•ì‹: /ì‹ ìš©ì¡°ì • [ë‹‰ë„¤ì„] [ì ìˆ˜]\nì˜ˆ) /ì‹ ìš©ì¡°ì • í™ê¸¸ë™ -50"));
            return true;
        }
        var scoreChange = parseInt(ps.pop());
        var targetName = ps.slice(1).join(" ").trim();
        var roomData = data.rooms[roomName];
        var found = findUserByName(roomData, targetName);

        if (isNaN(scoreChange)) { replier.reply(formatAdmin("ì˜¤ë¥˜", "ì¡°ì •í•  ì ìˆ˜ë¥¼ ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”.")); return true; }
        if (!found.length) { replier.reply(formatAdmin("ì˜¤ë¥˜", "ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (found.length > 1) { 
            handleUserSelection(replier, targetUid, found, "admin_credit_edit", { score: scoreChange }, user, roomName);
        return true; 
    }

        var targetUser = found[0].data;
        var oldScore = Number(targetUser.creditScore || 600);
        targetUser.creditScore = Math.min(1000, Math.max(0, oldScore + scoreChange));
        
        if (typeof checkAndHandleDefaulter === 'function') {
            checkAndHandleDefaulter(targetUser, roomName);
        }

        safeSaveData(data);
        var crInfo = getCreditInfo(targetUser.creditScore);
        var resText = "ëŒ€ìƒ: " + getDisplayName(targetUser) + "ë‹˜\n" +
                      "ë³€ë™: " + (scoreChange > 0 ? "+" : "") + scoreChange + "ì \n" +
                      "í˜„ì¬: " + targetUser.creditScore + "ì  (" + crInfo.label + ")";
        
        replier.reply(formatAdmin("âš™ï¸ ì‹ ìš© ì ìˆ˜ ì¡°ì • ì™„ë£Œ", resText));
        return true;
    }

    /* [Gemini ìš”ì²­ ì‚¬í•­] ê´€ë¦¬ì ì „ìš© ì¹­í˜¸ íšŒìˆ˜ ë¡œì§ (ì˜¤ë¥˜ ì§€ê¸‰ë¶„ ë°•íƒˆìš©) */
    if (msg.indexOf("/ì¹­í˜¸íšŒìˆ˜ ") === 0) {
        var ps = msg.split(" ");
        if (ps.length < 3) {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "í˜•ì‹: /ì¹­í˜¸íšŒìˆ˜ [ë‹‰ë„¤ì„] [ì¹­í˜¸ëª…]"));
            return true;
        }
        var titleToTake = ps.pop().trim();
        var targetName = ps.slice(1).join(" ").trim();
        var roomData = data.rooms[roomName];
        var found = findUserByName(roomData, targetName);

        if (!found.length) { replier.reply(formatAdmin("ì˜¤ë¥˜", "ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
    if (found.length > 1) {
        handleUserSelection(replier, targetUid, found, "admin_title_take", { title: titleToTake }, user, roomName);
        return true;
    }

        var targetUser = found[0].data;
        var inv = targetUser.inventory || [];
        var removed = false;

        // 1. ì¸ë²¤í† ë¦¬(ê°€ë°©)ì—ì„œ í•´ë‹¹ ì¹­í˜¸ ì‚­ì œ
        targetUser.inventory = inv.filter(function(it) {
            if (it.effect === "title" && (it.title === titleToTake || it.name.indexOf(titleToTake) !== -1)) {
                removed = true;
                return false;
            }
            return true;
        });

        // 2. í˜„ì¬ ì¥ì°© ì¤‘ì¸ ê²½ìš° í•´ì œ
        if (targetUser.title === titleToTake) {
            targetUser.title = "";
            removed = true;
        }

        if (removed) {
            safeSaveData(data);
            replier.reply(formatAdmin("ğŸ–ï¸ ì¹­í˜¸ íšŒìˆ˜ ì™„ë£Œ", getDisplayName(targetUser) + "ë‹˜ì—ê²Œì„œ [" + titleToTake + "] ì¹­í˜¸ë¥¼ ë°•íƒˆí–ˆìŠµë‹ˆë‹¤."));
        } else {
            replier.reply(formatAdmin("íšŒìˆ˜ ì‹¤íŒ¨", getDisplayName(targetUser) + "ë‹˜ì€ í•´ë‹¹ ì¹­í˜¸ë¥¼ ë³´ìœ í•˜ê³  ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."));
        }
        return true;
    }

    /* ì¶œì„ ì´ˆê¸°í™” */
    if (msg.indexOf("/ì¶œì„ì´ˆê¸°í™” ") === 0) {
        var tn = msg.substring(7).trim();
        var roomData = data.rooms[roomName];
        var found = findUserByName(roomData, tn);
        if (!found.length) { replier.reply(formatAdmin("ì˜¤ë¥˜", "ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (found.length > 1) { handleUserSelection(replier, targetUid, found, "admin_attend_reset", null, user, roomName); return true; }
        found[0].data.lastDate = "";
        safeSaveData(data);
        replier.reply(formatAdmin("ì¶œì„ ì´ˆê¸°í™” ì™„ë£Œ", getDisplayName(found[0].data) + "ë‹˜ì˜ ì˜¤ëŠ˜ ì¶œì„ ê¸°ë¡ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    /* ì¶œì„ ì¼ìˆ˜ ìˆ˜ì • */
    if (msg.indexOf("/ì¶œì„ì¼ìˆ˜ìˆ˜ì • ") === 0) {
        var ps = msg.split(" "), days = parseInt(ps.pop()), tn = ps.slice(1).join(" ");
        var roomData = data.rooms[roomName];
        var found = findUserByName(roomData, tn);
        if (!found.length) { replier.reply(formatAdmin("ì˜¤ë¥˜", "ëŒ€ìƒ ì—†ìŒ")); return true; }
        if (found.length > 1) { handleUserSelection(replier, targetUid, found, "admin_attend_edit", { days: days }, user, roomName); return true; }
        found[0].data.totalAttendance = days; safeSaveData(data);
        replier.reply(formatAdmin("ìˆ˜ì • ì™„ë£Œ", getDisplayName(found[0].data) + ": " + days + "ì¼"));
        return true;
    }

    /* ì „ì²´ ì¶œì„ ìˆ˜ì • */
    if (msg.indexOf("/ì „ì²´ì¶œì„ìˆ˜ì • ") === 0) {
        var days = parseInt(msg.split(" ")[1]);
        for (var r in data.rooms) {
            for (var id in data.rooms[r].users) { data.rooms[r].users[id].totalAttendance = days; }
        }
        safeSaveData(data);
        replier.reply(formatAdmin("ì™„ë£Œ", "ì „ì²´ ì¶œì„ " + days + "ì¼ë¡œ ê³ ì •"));
        return true;
    }

    /* ë°ì´í„° ì´ì „ */
    if (msg.indexOf("/ë°ì´í„°ì´ì „ ") === 0) {
        if (msg.indexOf(" > ") === -1) { replier.reply(formatAdmin("ì˜¤ë¥˜", "í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.\nì˜ˆ) /ë°ì´í„°ì´ì „ êµ¬ë‹‰ë„¤ì„ > ì‹ ë‹‰ë„¤ì„")); return true; }
        var names = msg.substring(7).split(" > ");
        var oldName = names[0].trim();
        var newName = names[1].trim();
        var roomData = data.rooms[roomName];
        
        var oldFound = findUserByName(roomData, oldName);
        var newFound = findUserByName(roomData, newName);

        if (oldFound.length === 0) { replier.reply(formatAdmin("ì˜¤ë¥˜", "êµ¬ ë‹‰ë„¤ì„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (newFound.length === 0) { replier.reply(formatAdmin("ì˜¤ë¥˜", "ì‹  ë‹‰ë„¤ì„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (oldFound.length > 1 || newFound.length > 1) { replier.reply(formatAdmin("ì˜¤ë¥˜", "ì¤‘ë³µ ë‹‰ë„¤ì„ì´ ì¡´ì¬í•©ë‹ˆë‹¤. ì •í™•í•œ í’€ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")); return true; }

        var oldId = oldFound[0].id;
        var oldData = oldFound[0].data;
        var newData = newFound[0].data;

        newData.point = oldData.point;
        newData.bank = oldData.bank;
        newData.tier = oldData.tier;
        newData.creditScore = oldData.creditScore;
        newData.totalAttendance = oldData.totalAttendance;
        newData.loan = oldData.loan;
        newData.stockHoldings = oldData.stockHoldings;
        newData.stockAvg = oldData.stockAvg;
        newData.icon = oldData.icon;
        newData.title = oldData.title;

        if (typeof uidCache !== 'undefined') {
            for (var key in uidCache) {
                if (uidCache[key] === oldId) delete uidCache[key];
            }
        }
        delete roomData.users[oldId];
        safeSaveData(data);
        replier.reply(formatAdmin("ë°ì´í„° ì´ì „ ì„±ê³µ", oldName + " â” " + newName + "\nëª¨ë“  ìì‚° ë° ë“±ê¸‰ì´ ì´ì „ë˜ì—ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    /* ìœ ì € ì‚­ì œ (ì‚¬ì±„ ì „ì•¡ ë³´ì „ ë° ê³„ì•½ ê°•ì œ ì‚­ì œ ì ìš©) */
    if (msg.indexOf("/ìœ ì €ì‚­ì œ ") === 0) {
        var tn = msg.substring(6).trim();
        var roomData = data.rooms[roomName];
        var found = findUserByName(roomData, tn);
        if (!found.length) { replier.reply(formatAdmin("ì˜¤ë¥˜", "ëŒ€ìƒ ì—†ìŒ")); return true; }
        if (found.length > 1) { handleUserSelection(replier, targetUid, found, "admin_delete", null, user, roomName); return true; }
        
        var targetId = found[0].id;
        var targetData = found[0].data;
        var refundLog = "";
        var refundCount = 0;
        var totalRefunded = 0;

        // [ìˆ˜ì •] ì¶œì„ì¼ìˆ˜ ê´€ê³„ì—†ì´ ëª¨ë“  ì‚¬ì±„ ê³„ì•½ ê°•ì œ ì •ì‚° ë° ì‚­ì œ
        if (roomData.loanContracts) {
            for (var cid in roomData.loanContracts) {
                var c = roomData.loanContracts[cid];
                if (c.borrowerUid === targetId) {
                    var lender = roomData.users[c.lenderUid];
                    if (lender) {
                        var debtAmt = Number(c.currentDebt);
                        util_updatePoint(lender, roomData, debtAmt, "ì‚¬ì±„ ê°•ì œ ì •ì‚°", roomName);
                        totalRefunded += debtAmt;
                        refundCount++;
                        try { Api.replyRoom(roomName, "ğŸš¬ [ì‚¬ì±„ ê°•ì œ ì •ì‚°]\n" + targetData.name + "ë‹˜ì˜ ë°ì´í„° ì‚­ì œë¡œ ì¸í•´ " + lender.name + "ë‹˜ê»˜ ë¯¸ìˆ˜ê¸ˆ " + fp(debtAmt) + "Pê°€ ì „ì•¡ ë°˜í™˜ë˜ì—ˆìŠµë‹ˆë‹¤."); } catch(e){}
                    }
                    delete roomData.loanContracts[cid]; // ê³„ì•½ì„œ ê°•ì œ íŒŒê¸°
                }
            }
        }

        // [ì‹ ê·œ] ì€í–‰ ëŒ€ì¶œê¸ˆ êµ­ê³  íšŒìˆ˜ (íì‡„í˜• ê²½ì œ ì•ˆì •í™”)
        if (targetData.loan && Number(targetData.loan.debt) > 0) {
            var bankDebt = Number(targetData.loan.debt);
            util_updateReserve(roomData, bankDebt, "ëŒ€ì¶œê¸ˆ êµ­ê³  íšŒìˆ˜", roomName);
            refundLog += "\nğŸ¦ ì€í–‰ ëŒ€ì¶œê¸ˆ " + fp(bankDebt) + "Pê°€ êµ­ê³ ë¡œ ìë™ íšŒìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.";
        }

        if (refundCount > 0) refundLog += "\nâš ï¸ ì‚¬ì±„ ë³´ì „ ì™„ë£Œ: " + refundCount + "ê±´ (" + fp(totalRefunded) + "P)";

        if (typeof uidCache !== 'undefined') {
            for (var key in uidCache) {
                if (uidCache[key] === targetId) delete uidCache[key];
            }
        }
        delete roomData.users[targetId];
            try {
                var regFile = new java.io.File(REGISTRY_PATH);
                if (regFile.exists()) {
                    var regData = JSON.parse(FileStream.read(REGISTRY_PATH));
                    delete regData[roomName + "_" + targetData.name];
                    FileStream.write(REGISTRY_PATH, JSON.stringify(regData));
                }
            } catch (e) { Log.error("Registry Delete Error: " + e); }
            safeSaveData(data);
            replier.reply(formatAdmin("ìœ ì € ì‚­ì œ ì™„ë£Œ", "[" + targetData.name + "]ë‹˜ì˜ ë°ì´í„°ë¥¼ ì˜êµ¬ ì‚­ì œí–ˆìŠµë‹ˆë‹¤." + refundLog));
        return true;
    }

    if (msg.indexOf("/ì±„êµ´ì‹œê°„ë³µêµ¬ ") === 0) {
        var ps = msg.split(" "), addMin = parseInt(ps.pop()), tn = ps.slice(1).join(" ");
        var roomData = data.rooms[roomName];
        var found = findUserByName(roomData, tn);
        
        if (!found.length) { replier.reply(formatAdmin("ì˜¤ë¥˜", "ëŒ€ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (isNaN(addMin)) { replier.reply(formatAdmin("ì˜¤ë¥˜", "ë³µêµ¬í•  ë¶„(Min)ì„ ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”.")); return true; }

        var targetUser = found[0].data;
        var oldMin = targetUser.totalMiningTime || 0;
        targetUser.totalMiningTime = oldMin + addMin;
        targetUser.skipHealing = true; // ë³´ì•ˆ ì—”ì§„ ì˜ˆì™¸ í—ˆìš©
        
        safeSaveData(data);
        replier.reply(formatAdmin("â³ ì±„êµ´ ì‹œê°„ ë³µêµ¬ ì™„ë£Œ", 
            "ëŒ€ìƒ: " + targetUser.name + "\n" +
            "ê¸°ì¡´: " + oldMin + "ë¶„\n" +
            "ì¶”ê°€: +" + addMin + "ë¶„\n" +
            "ìµœì¢…: " + targetUser.totalMiningTime + "ë¶„"));
        return true;
    }

if (msg === "/ì „ì²´ì±„êµ´ë³µêµ¬") {
        var backupPath = BACKUP_DIR + "last_stable_backup.json";
        var backupFile = new java.io.File(backupPath);
        var logFile = new java.io.File(JOURNAL_PATH);

        if (!backupFile.exists()) {
            replier.reply(formatAdmin("ğŸš« ë³µêµ¬ ë¶ˆê°€", "2ì›” 2ì¼ì ë°±ì—… íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."));
            return true;
        }

        try {
            var backupData = JSON.parse(FileStream.read(backupPath));
            var revokeKeywords = ["ê´‘ì‚°", "ê°€ê²°ì‚°", "ì±„êµ´", "ë³µêµ¬"];
            var pointRevoked = 0, titleRevoked = 0, totalFixed = 0;

            // [Step 1] ì˜¤ëŠ˜(00ì‹œ ì´í›„) ì˜ëª» ì§€ê¸‰ëœ í¬ì¸íŠ¸ ë¡œê·¸ ì „ìˆ˜ ì¡°ì‚¬
            var blackListProfits = {}; // { uid: amount }
            if (logFile.exists()) {
                var logs = FileStream.read(JOURNAL_PATH).split("\n");
                logs.forEach(function(line) {
                    if (!line.trim()) return;
                    var p = line.split("|");
                    if (p.length < 5) return;
                    
                    var reason = p[4];
                    var isTargetReason = revokeKeywords.some(function(k) { return reason.indexOf(k) !== -1; });
                    
                    // ì˜¤ëŠ˜ ë‚ ì§œì´ë©´ì„œ ê´‘ì‚° ê´€ë ¨ìœ¼ë¡œ 'ì§€ê¸‰(+)'ëœ ë‚´ì—­ë§Œ í•©ì‚°
                    if (isTargetReason && Number(p[2]) > 0) {
                        blackListProfits[p[0]] = (blackListProfits[p[0]] || 0) + Number(p[2]);
                    }
                });
            }

            for (var rName in data.rooms) {
                var currentRoom = data.rooms[rName];
                var backupRoom = backupData.rooms[rName];
                if (!backupRoom) continue;

                for (var uid in currentRoom.users) {
                    var u = currentRoom.users[uid];
                    var bu = backupRoom.users[uid];

                    if (bu && bu.mining) {
                        u.skipHealing = true;

                        // 1. ë¶€ë‹¹ í¬ì¸íŠ¸ íšŒìˆ˜ ë° êµ­ê³  í™˜ìˆ˜
                        if (blackListProfits[uid]) {
                            var amt = blackListProfits[uid];
                            u.point = Number(u.point) - amt;
                            currentRoom.bankReserve = (currentRoom.bankReserve || 0) + amt;
                            pointRevoked++;
                        }

                        // 2. ëˆ„ì  ë°ì´í„° ë¡¤ë°± (ë°±ì—… ì‹œì ì˜ ìˆœìˆ˜ ëˆ„ì ì¹˜ë¡œ ê³ ì •)
                    u.totalMiningTime = Number(bu.totalMiningTime || 0);
                    u.artifactPieces = Number(bu.artifactPieces || 0);

                    // 3. [êµì •] ì‹œê°„ ì¶• ì •ìƒí™”: í˜„ì¬ ì±„êµ´ ì¤‘ì´ë¼ë©´ 'ì§€ê¸ˆ ì´ ìˆœê°„'ë¶€í„° ë‹¤ì‹œ ì‹œì‘
                    // ê³¼ê±° startTimeìœ¼ë¡œ ì†Œê¸‰í•˜ë©´ í˜„ì¬ ì„¸ì…˜ ì‹œê°„ì´ ë¹„ì •ìƒì ìœ¼ë¡œ í•©ì‚°ë˜ëŠ” ë²„ê·¸ê°€ ë°œìƒí•¨
                    if (u.mining && u.mining.active === true) {
                        u.mining.startTime = Date.now(); 
                        u.mining.active = true;
                    }

                        // 4. ìê²© ë¯¸ë‹¬ ì¹­í˜¸ ì „ìˆ˜ íšŒìˆ˜ (ì±„êµ´ì™• ì •ë°€ ì‚­ì œ)
                        if (u.totalMiningTime < 10000) {
                            var hasTitle = false;
                            u.inventory = u.inventory.filter(function(it) {
                                if (it.title === "ì±„êµ´ì™•" || it.name.indexOf("ì±„êµ´ì™•") !== -1) {
                                    hasTitle = true;
                                    return false;
                                }
                                return true;
                            });
                            if (u.title === "ì±„êµ´ì™•") u.title = "";
                            if (hasTitle) titleRevoked++;
                        }
                        totalFixed++;
                    }
                }
            }

            safeSaveData(data, true);
            if (typeof globalData !== 'undefined') globalData = data;

            var report = "ğŸ›°ï¸ [ê´‘ì‚° ì‹œê³„ì—´ í†µí•© ë° ì •í™” ì™„ë£Œ]\n" +
                         "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                         "â€¢ ëŒ€ìƒ ì¸ì›: " + totalFixed + "ëª…\n" +
                         "â€¢ í¬ì¸íŠ¸ í™˜ìˆ˜: " + pointRevoked + "ëª… (ì •ì‚°ê¸ˆ íšŒìˆ˜)\n" +
                         "â€¢ ì¹­í˜¸ ë°•íƒˆ: " + titleRevoked + "ëª… (ìê²©ë¯¸ë‹¬ ì œê±°)\n" +
                         "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                         "ğŸ’¡ 00ì‹œ ë¦¬ì…‹ ì´ì „ì˜ ì‹œì‘ ì‹œê°„ìœ¼ë¡œ ì†Œê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.\n" +
                         "ì´ì œ ëª¨ë“  ìœ ì €ëŠ” ì–´ì œë¶€í„° ì´ì–´ì˜¨ ìƒíƒœë¡œ ì±„êµ´ë©ë‹ˆë‹¤.";
            replier.reply(formatAdmin("ì‹œìŠ¤í…œ íƒ€ì„ë¼ì¸ ë³µêµ¬ ë³´ê³ ", report));

        } catch (e) {
            Log.error("Mining Timeline Merge Error: " + e);
            replier.reply(formatAdmin("ğŸš« ì˜¤ë¥˜ ë°œìƒ", "ë¡œê·¸ ë¶„ì„ ë° ë°ì´í„° ë³‘í•© ì¤‘ ê²°í•¨ ë°œìƒ"));
        }
        return true;
    }

    if (msg === "/ë°°ë‹¹ê¸ˆê°•ì œì •ì‚°") {
        data.lastDailyReset = ""; 
        _runSector17Logic(data, { today: getSimpleDate(), now: new Date(), targetRoom: roomName, season: getSimpleSeason() });
        replier.reply(formatAdmin("ğŸš€ ë°°ë‹¹ê¸ˆ ìˆ˜ë™ ì§€ê¸‰ ì™„ë£Œ", "í˜„ì¬ ì£¼ë¨¸ë‹ˆì˜ ìˆ˜ìµì„ ë°°ë‹¹í•˜ê³  00ì‹œ ì •ì‚°ì„ ê°•ì œ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    /* [ì‹ ê·œ] ì§€ëŠ¥í˜• ê±°ë˜ ì—­ì¶”ì  ëª…ë ¹ì–´ */
    if (msg.indexOf("/ë¸”ë™ë°•ìŠ¤ ") === 0) {
        var tn = msg.substring(6).trim();
        var roomData = data.rooms[roomName];
        var found = findUserByName(roomData, tn);

        if (found.length === 0) {
            replier.reply(formatAdmin("ğŸš« ëŒ€ìƒ ì—†ìŒ", "[" + tn + "] ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        } else if (found.length > 1) {
            handleUserSelection(replier, targetUid, found, "admin_blackbox", null, user, roomName);
        } else {
            _executeBlackboxSearch(found[0].id, found[0].data, replier);
        }
        return true;
    }

    /* ë¸”ë™ë°•ìŠ¤ íŒŒì¼ ë¶„ì„ ë° ì¶œë ¥ ì—”ì§„ */
    function _executeBlackboxSearch(uid, targetUser, replier) {
    try {
        var logs = [];
        var filesToRead = [JOURNAL_PATH, BASE_DIR + "total_history.log"];

        filesToRead.forEach(function(path) {
            var file = new java.io.File(path);
            if (file.exists() && file.length() > 0) {
                var lines = FileStream.read(path).split("\n");
                lines.forEach(function(line) {
                    if (!line.trim()) return;
                    var parts = line.split("|");
                    if (parts[0] === uid) {
                        var delta = Number(parts[2]);
                        var sign = delta > 0 ? "â•" : "â–";
                        // ìµœì‹ ìˆœ ì •ë ¬ì„ ìœ„í•´ ë°°ì—´ ì•ì— ì¶”ê°€
                        logs.unshift("â€¢ [" + parts[4] + "] " + sign + fp(Math.abs(delta)) + "P");
                    }
                });
            }
        });

        var readMore = "\u200b".repeat(500); // ì „ì²´ë³´ê¸° ìœ ë„ìš© ê³µë°±
        var resultBody = "ğŸ‘¤ ëŒ€ìƒ: " + targetUser.name + "\n" +
                         "ğŸ†” ID: " + uid + "\n" +
                         "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" + readMore + "\n" +
                         (logs.length > 0 ? logs.join("\n") : "ì˜¤ëŠ˜ ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.") + "\n" +
                         "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                         "ğŸ’° í˜„ì¬ ì”ì•¡: " + fp(targetUser.point) + "P";

        replier.reply(formatAdmin("ğŸ“‹ ìœ ì € ë‹¹ì¼ ì „ì²´ ë¸”ë™ë°•ìŠ¤", resultBody));
    } catch (e) {
        replier.reply(formatAdmin("ğŸš« ë¶„ì„ ì‹¤íŒ¨", "ë¡œê·¸ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e));
    }
}

    /* [ê°œì¸ ë³µêµ¬] 4ëŒ€ ë³´ì•ˆ ê°€ë“œê°€ ì ìš©ëœ ì§€ëŠ¥í˜• ìœ ì € ë³µêµ¬ (Smart User Restore v5.9.1) */
    if (msg.indexOf("/ìœ ì €ë³µì› ") === 0) {
    var fullInput = msg.substring(6).trim();
    var roomData = data.rooms[roomName];

    var words = fullInput.split(/\s+/);
    var lastWord = words[words.length - 1];
    var isUUID = (lastWord.split("-").length >= 5 && lastWord.length >= 36);

    var targetNick = "";
    var sourceCode = "";

    if (isUUID) {
        sourceCode = lastWord;
        targetNick = fullInput.substring(0, fullInput.lastIndexOf(lastWord)).trim();
    } else {
        targetNick = fullInput;
        sourceCode = ""; 
    }

    var currentFound = findUserByName(roomData, targetNick);
    if (currentFound.length > 1) { 
        handleUserSelection(replier, targetUid, currentFound, "user_restore", { sourceCode: sourceCode }, user, roomName);
        return true; 
    }
    if (currentFound.length === 0) { 
        replier.reply(formatAdmin("ğŸš« ëŒ€ìƒ ì—†ìŒ", "[" + targetNick + "] ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); 
        return true; 
    }
    
    // [í•µì‹¬ ìˆ˜ì •] ì…ë ¥ê°’(inputNick)ì´ ì•„ë‹Œ, ì‹¤ì œ ì°¾ì€ ìœ ì €ì˜ 'ì „ì²´ ì´ë¦„'ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
    var targetId = currentFound[0].id; 
    var fullNick = currentFound[0].data.name; // "95 ë‚¨ ê´‘ì–´" ì „ì²´ ì´ë¦„ì„ í™•ë³´
    var backupSourceId = (sourceCode !== "") ? sourceCode : targetId;

    try {
        var backupContent = FileStream.read(BACKUP_DIR + "last_stable_backup.json");
        var backupData = JSON.parse(backupContent);
        var rawBackupUser = null;

        for (var r in backupData.rooms) {
            if (backupData.rooms[r].users[backupSourceId]) {
                rawBackupUser = backupData.rooms[r].users[backupSourceId];
                break;
            }
        }

        if (!rawBackupUser) throw new Error("ë°±ì—…ë³¸ì— í•´ë‹¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

        var backupUser = JSON.parse(JSON.stringify(rawBackupUser));

        // [êµ¬ì¡° ë™ê¸°í™”] (ì´ì „ ì„¹í„°ì™€ ë™ì¼)
        var schema = { chatLog: [], inventory: [], stockHoldings: {}, stockAvg: {}, point: 50000 };
        for (var key in schema) { if (backupUser[key] === undefined) backupUser[key] = schema[key]; }

        // [v7.0 í•µì‹¬] ê°€ì ¸ì˜¨ ë°ì´í„°ì˜ ì´ë¦„ì„ 'ì „ì²´ ë‹‰ë„¤ì„'ìœ¼ë¡œ ê³ ì •
        backupUser.name = fullNick; 
        roomData.users[targetId] = backupUser; 

        safeSaveData(data, false);
        if (typeof globalData !== 'undefined') globalData = data; 

        replier.reply(formatAdmin("âœ… ë°ì´í„° ì •ë°€ ì´ê´€ ì™„ë£Œ", 
            "í˜„ì¬ ëŒ€ìƒ: " + fullNick + "\n" + // ì „ì²´ ì´ë¦„ ì¶œë ¥
            "ì‹ë³„ ëª¨ë“œ: ê°„ëµí™” ê²€ìƒ‰ ì§€ì›\n" +
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
            "ğŸ’° ìµœì¢… ë³µêµ¬ ì”ì•¡: " + fp(backupUser.point) + "P\n\n" +
            "ğŸ’¡ ì „ì²´ ë‹‰ë„¤ì„ê³¼ì˜ ë™ê¸°í™”ê°€ ì™„ë£Œë˜ì–´ ì¦‰ì‹œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤."));

    } catch (e) {
        replier.reply(formatAdmin("ğŸš« ë³µêµ¬ ì¤‘ë‹¨", "ì‚¬ìœ : " + e.message));
        Log.error("Restore Error: " + e);
    }
        return true;
    }

    return false;
}

//==========ì„¹í„°35==========

/**
 * [ê´€ë¦¬ì í•˜ìœ„ ëª¨ë“ˆ 4] ê²½ì œ ë° í¬ì¸íŠ¸ ê´€ë¦¬
 * ê¸°ëŠ¥: ê²½ì œì§€í‘œ, ë°ì´í„°êµì •, ë¬¼ê°€ì¡°ì •, í¬ì¸íŠ¸ ì§€ê¸‰/ì°¨ê°/ë¿Œë¦¬ê¸°, ê°ì¢… ì´ˆê¸°í™”, ì¬ì›ìˆ˜ì • ë° ì¶©ì „, ìê°€ë³µì›
 */
function _adminEconomyLogic(msg, user, data, replier, roomName, targetUid) {

    /* [í…ŒìŠ¤íŠ¸] ìì • ë¦¬ì…‹ ë¡œì§ ê°•ì œ ì‹¤í–‰ */
    if (msg === "/ìì •í…ŒìŠ¤íŠ¸") {
        // 1. ì˜¤ëŠ˜ ë¦¬ì…‹ ê¸°ë¡ì„ ì§€ì›Œ ë¡œì§ì´ ì‹¤í–‰ ê°€ëŠ¥í•˜ê²Œ ë§Œë“¬
        data.lastDailyReset = "2000-01-01"; 
        
        // 2. ê°€ìƒ ì»¨í…ìŠ¤íŠ¸ ìƒì„± (í˜„ì¬ ì‹œê°„ ê¸°ì¤€)
        var testCtx = {
            today: getSimpleDate(),
            now: new Date(),
            targetRoom: roomName,
            season: getSimpleSeason()
        };

        // 3. ë¦¬ì…‹ ë¡œì§ ê°•ì œ í˜¸ì¶œ
        _runSector17Logic(data, testCtx);
        
        replier.reply(formatAdmin("ğŸ§ª ìì • ë¡œì§ í…ŒìŠ¤íŠ¸", "ìì • ë¦¬ì…‹ ë¡œì§ì„ ê°•ì œë¡œ ì‹¤í–‰í–ˆìŠµë‹ˆë‹¤.\në¡œê·¸ì™€ ê´‘ì‚° ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”."));
        return true;
    }

    /* [1] ì€í–‰ ê°€ìš© ì¬ì› ìˆ˜ë™ ìˆ˜ì • (ê°•ì œ ì„¤ì •) */
    if (msg.indexOf("/ì¬ì›ìˆ˜ì • ") === 0) {
        var val = parseInt(msg.split(" ")[1].replace(/,/g, ""));
        if (isNaN(val)) {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "ìˆ˜ì •í•  ê¸ˆì•¡ì„ ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”.\nì˜ˆ) /ì¬ì›ìˆ˜ì • 3000"));
            return true;
        }

        var roomData = data.rooms[roomName];
        if (!roomData) return true;

        // [ë³´ì•ˆ êµì²´] ì§ì ‘ í• ë‹¹ ëŒ€ì‹  ë³´ì•ˆ ì—”ì§„ì„ í†µí•œ ì°¨ì•¡(delta) ê³„ì‚° ë° ì ìš©
        var currentRes = Number(roomData.bankReserve || 0);
        var delta = val - currentRes;
        util_updateReserve(roomData, delta, "ì¬ì› ìˆ˜ì •", roomName);
        
        roomData.bankReserve = val;
        safeSaveData(data);
        
        replier.reply(formatAdmin("ğŸ¦ ì€í–‰ ì¬ì› ìˆ˜ì • ì™„ë£Œ", 
            "í˜„ì¬ ë°©ì˜ ê°€ìš© ì¬ì›ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n" +
            "ğŸ’° ì„¤ì • ê¸ˆì•¡: " + fp(val) + "P\n" +
            "ğŸ“¢ ì´ì œ ìœ ì €ë“¤ì´ ì´ ê¸ˆì•¡ ë‚´ì—ì„œ ëŒ€ì¶œ ê°€ëŠ¥í•©ë‹ˆë‹¤."));
        return true;
    }

   if (msg === "/êµ­ê³ ë¡œê·¸") {
    try {
        var logs = [];
        var filesToRead = [JOURNAL_PATH, BASE_DIR + "total_history.log"];

        filesToRead.forEach(function(path) {
            var file = new java.io.File(path);
            if (file.exists() && file.length() > 0) {
                var content = FileStream.read(path).split("\n");
                logs = logs.concat(content);
            }
        });

        var filteredLogs = [];
        // ì˜¤ëŠ˜ ë°œìƒí•œ ëª¨ë“  êµ­ê³  ë³€ë™ ì¶”ì¶œ (ìµœì‹ ìˆœ)
        for (var i = logs.length - 1; i >= 0; i--) {
            var line = logs[i].trim();
            if (!line) continue;
            var parts = line.split("|");
            if (parts.length < 5) continue;

            var brDelta = Number(parts[3]);
            if (!isNaN(brDelta) && brDelta !== 0) {
                var sign = brDelta > 0 ? "â•" : "â–";
                var uName = "ì•Œ ìˆ˜ ì—†ìŒ";
                for (var r in data.rooms) {
                    if (data.rooms[r].users[parts[0]]) {
                        uName = data.rooms[r].users[parts[0]].name;
                        break;
                    }
                }
                filteredLogs.push("â€¢ [" + parts[4] + "] " + uName + " | " + sign + fp(Math.abs(brDelta)) + "P");
            }
        }

        var readMore = "\u200b".repeat(500); // ì „ì²´ë³´ê¸° ìœ ë„ìš© ê³µë°±
        var roomData = data.rooms[roomName];
        var resultBody = "ğŸ¦ í˜„ì¬ ê¸ˆê³  ì”ì•¡: " + fp(roomData.bankReserve) + "P\n" +
                         "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" + readMore + "\n" +
                         (filteredLogs.length > 0 ? filteredLogs.join("\n") : "ê¸ˆì¼ êµ­ê³  ë³€ë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");

        replier.reply(formatAdmin("ğŸ›ï¸ ì˜¤ëŠ˜ êµ­ê³  ì „ì²´ ë³€ë™ ì¥ë¶€", resultBody));
    } catch (e) {
        replier.reply(formatAdmin("ğŸš« ì¡°íšŒ ì‹¤íŒ¨", "ë¡œê·¸ í†µí•© ë¶„ì„ ì˜¤ë¥˜: " + e));
    }
    return true;
}

    /* [ì‹ ê·œ] ì€í–‰ ê¸´ê¸‰ ì¬ì› ì¶©ì „ (ê¸°ì¡´ ì”ì•¡ì— ì¶”ê°€ í•©ì‚°) */
    if (msg.indexOf("/ì¬ì›ì¶©ì „ ") === 0) {
        var val = parseInt(msg.split(" ")[1].replace(/,/g, ""));
        if (isNaN(val) || val <= 0) {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "ì¶©ì „í•  ê¸ˆì•¡ì„ ì–‘ì˜ ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”.\nì˜ˆ) /ì¬ì›ì¶©ì „ 100000"));
            return true;
        }
        var roomData = data.rooms[roomName];
        if (!roomData) return true;

        // [ë³´ì•ˆ êµì²´] ì§ì ‘ í•©ì‚°(+=) ëŒ€ì‹  ë³´ì•ˆ ì—”ì§„ í˜¸ì¶œ
        util_updateReserve(roomData, val, "ì¬ì› ì¶©ì „", roomName);
        
        safeSaveData(data);
        
        var resMsg = "ê²°ê³¼: êµ­ê³  ë³´ì¶© ì™„ë£Œ\n" +
                     "ìˆ˜í˜ˆ ê¸ˆì•¡: +" + fp(val) + "P\n" +
                     "ğŸ¦ í˜„ì¬ ê¸ˆê³  ì´ì•¡: " + fp(roomData.bankReserve) + "P";
        
        replier.reply(formatAdmin("âš™ï¸ ì¤‘ì•™ì€í–‰ ê¸´ê¸‰ ì¬ì› ìˆ˜í˜ˆ", resMsg));
        return true;
    }

   /* [ì‹ ê·œ] ëˆ„ë½ëœ ì˜¤ëŠ˜ì¹˜ ë°°ë‹¹ê¸ˆ ê°•ì œ í•©ì‚° ëª…ë ¹ì–´ */
    if (msg === "/ë°°ë‹¹ë³µêµ¬") {
        var count = util_restoreDailyPoolsFromHistory(data, roomName);
        safeSaveData(data);
        replier.reply(formatAdmin("âœ… ë°°ë‹¹ê¸ˆ ì†Œê¸‰ ì ìš© ì™„ë£Œ", 
            "ë°±ì—… íŒŒì¼ì—ì„œ ì˜¤ëŠ˜ ë°œìƒí•œ " + count + "ê±´ì˜ ê±°ë˜ë¥¼ ë¶„ì„í•˜ì—¬\n" +
            "ë©”ëª¨ë¦¬ ë°°ë‹¹ ì£¼ë¨¸ë‹ˆì— í•©ì‚°ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.\n\n" +
            "ğŸ’¡ ì´ì œ /ë°°ë‹¹í˜„í™©ì—ì„œ ì •í™•í•œ ê¸ˆì•¡ì„ í™•ì¸í•˜ì„¸ìš”."));
        return true;
    }

    /* [ì‹ ê·œ] ë°°ë‹¹ í•­ëª© ìˆ˜ë™ ì´ˆê¸°í™” ëª…ë ¹ì–´ */
    if (msg.indexOf("/ë°°ë‹¹ì´ˆê¸°í™” ") === 0) {
        var roomData = data.rooms[roomName];
        if (!roomData || !roomData.features || !roomData.features.dailyPools) return true;

        var targetKey = msg.substring(7).trim(); // "ì¹´ì§€ë…¸", "ê´‘ì‚°" ë“±
        var keyMap = { "ì¹´ì§€ë…¸": "casino", "ê´‘ì‚°": "mine", "ë‚šì‹œí„°": "fish", "ì€í–‰": "bank", "ë°±í™”ì ": "shop", "ê²½ë§ˆì¥": "race" };
        var engKey = keyMap[targetKey];

        if (!engKey) {
            replier.reply(formatAdmin("ğŸš« ì´ˆê¸°í™” ì‹¤íŒ¨", "ì˜¬ë°”ë¥¸ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.\n(ì¹´ì§€ë…¸, ê´‘ì‚°, ë‚šì‹œí„°, ì€í–‰, ë°±í™”ì , ê²½ë§ˆì¥)"));
            return true;
        }

        // í•´ë‹¹ í•­ëª© 0ìœ¼ë¡œ ë¦¬ì…‹
        roomData.features.dailyPools[engKey] = 0;
        safeSaveData(data);
        
        replier.reply(formatAdmin("âœ… ë°°ë‹¹ ì´ˆê¸°í™” ì™„ë£Œ", "[" + targetKey + "] í•­ëª©ì˜ ë°°ë‹¹ ì£¼ë¨¸ë‹ˆë¥¼ 0Pë¡œ ë¹„ì› ìŠµë‹ˆë‹¤.\nì´ì œ ë‹¤ì‹œ [/ë°°ë‹¹ë³µêµ¬]ë¥¼ ì‹¤í–‰í•˜ì—¬ ê¹¨ë—í•˜ê²Œ í•©ì‚°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."));
        return true;
    }

   /* [2] íŠ¹ì • ë§¤ë¬¼ ì‹ ê·œ ë“±ë¡/ë¶€í™œ ëª…ë ¹ì–´ */
    if (msg.indexOf("/ë§¤ë¬¼ì¶”ê°€ ") === 0) {
        var parts = msg.split(" ");
        if (parts.length < 3) {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "í˜•ì‹: /ë§¤ë¬¼ì¶”ê°€ [ê±´ë¬¼ëª…] [ê°€ê²©] [íƒ€ì…ë²ˆí˜¸(ì„ íƒ)]\n1: ëœë“œë§ˆí¬ / 2: ë¹„ì¦ˆë‹ˆìŠ¤íƒ€ì›Œ / 3: ìƒê°€"));
            return true;
        }
        var name = parts[1];
        var price = parseInt(parts[2].replace(/,/g, ""));
        var typeNum = parts[3] || "1"; // ê¸°ë³¸ê°’ 1ë²ˆ

        var typeMap = { "1": "normal", "2": "bluechip", "3": "hotspot" };
        var selectedType = typeMap[typeNum] || "normal";
        var trait = SYSTEM_CONFIG.ECO.LANDMARK.TRAITS[selectedType];

        data.landmarkMarket[name] = {
            price: price, 
            lastPrice: price, 
            type: selectedType, 
            delistTick: 0, 
            delistLimit: 9999, 
            trend: "none", 
            trendTick: 0, 
            openPrice: price
        };

        replier.reply(formatAdmin("ğŸ™ï¸ ë§¤ë¬¼ ìˆ˜ë™ ë“±ë¡ ì™„ë£Œ", 
            "ê±´ë¬¼ëª…: " + trait.icon + " " + name + "\n" +
            "ìœ í˜•: " + trait.label + " (ë³€ë™ì„±: x" + trait.volatility + ")\n" +
            "ì‹œê°€: " + fp(price) + "P"));

             safeSaveData(data);
        return true;
    }

    /* [ì‹ ê·œ] íŠ¹ì • ë§¤ë¬¼ ê°•ì œ ìƒí ë° ì‚­ì œ */
    if (msg.indexOf("/ë§¤ë¬¼ì‚­ì œ ") === 0) {
        var name = msg.substring(6).trim();
        if (!data.landmarkMarket[name]) {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "[" + name + "] ë§¤ë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
            return true;
        }

        // ìœ ì €ë“¤ì˜ ë³´ìœ  ì§€ë¶„ë„ í•¨ê»˜ ì‚­ì œ (ë°ì´í„° ë¬´ê²°ì„±)
        for (var r in data.rooms) {
            for (var uid in data.rooms[r].users) {
                var u = data.rooms[r].users[uid];
                if (u.landHoldings && u.landHoldings[name]) {
                    delete u.landHoldings[name];
                    if (u.landAvg) delete u.landAvg[name];
                }
            }
        }

        delete data.landmarkMarket[name];
        safeSaveData(data);
        replier.reply(formatAdmin("ğŸ™ï¸ ë§¤ë¬¼ ì‚­ì œ ì™„ë£Œ", "[" + name + "] ê±´ë¬¼ì´ ì‹œì¥ì—ì„œ ì™„ì „íˆ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    /* [ê´€ë¦¬ì] íŠ¹ì • ë§¤ë¬¼ ì´ë¦„ ë° ì‹œì„¸ ìˆ˜ì • */
    if (msg.indexOf("/ë§¤ë¬¼ìˆ˜ì • ") === 0) {
        var parts = msg.split(" ");
        if (parts.length < 4) {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "í˜•ì‹: /ë§¤ë¬¼ìˆ˜ì • [ê¸°ì¡´ì´ë¦„] [ìƒˆì´ë¦„] [ìƒˆê°€ê²©]"));
            return true;
        }
        var oldName = parts[1];
        var newName = parts[2];
        var newPrice = parseInt(parts[3].replace(/,/g, ""));

        if (!data.landmarkMarket[oldName]) {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "[" + oldName + "] ë§¤ë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
            return true;
        }

        var landData = data.landmarkMarket[oldName];
        var oldPrice = Number(landData.price);
        var ratio = oldPrice / newPrice;

        landData.price = newPrice;
        landData.lastPrice = newPrice;
        landData.openPrice = newPrice;

        var fixCount = 0;
        for (var r in data.rooms) {
            var users = data.rooms[r].users;
            for (var uid in users) {
                var u = users[uid];
                if (u.landHoldings && u.landHoldings[oldName] !== undefined) {
                    u.skipHealing = true;
                    var oldQty = Number(u.landHoldings[oldName]);
                    var oldAvg = Number(u.landAvg[oldName] || oldPrice);

                    var newQty = Math.max(1, Math.round(oldQty * ratio));
                    var newAvg = Math.floor(oldAvg / ratio);

                    u.landHoldings[newName] = newQty;
                    u.landAvg[newName] = newAvg;

                    if (oldName !== newName) {
                        delete u.landHoldings[oldName];
                        if (u.landAvg[oldName]) delete u.landAvg[oldName];
                    }
                    fixCount++;
                }
            }
        }

        if (oldName !== newName) {
            data.landmarkMarket[newName] = landData;
            delete data.landmarkMarket[oldName];
        }

        safeSaveData(data);
        replier.reply(formatAdmin("ğŸ™ï¸ ë¶€ë™ì‚° ë§¤ë¬¼ êµì • ì™„ë£Œ", "ëŒ€ìƒ: " + oldName + " â” " + newName + "\nê°€ê²©: " + fp(oldPrice) + "P â” " + fp(newPrice) + "P\nìœ ì € " + fixCount + "ëª…ì˜ ìì‚° ê°€ì¹˜ ë³´ì¡´ ì™„ë£Œ"));
        return true;
    }

    /* [3] ìœ ì € ë³´ìœ  ìì‚° ê¸°ë°˜ ë¶€ë™ì‚° ì‹œì¥ ì¬ê±´ */
    if (msg === "/ë¶€ë™ì‚°ìì‚°ë³µêµ¬") {
        var roomData = data.rooms[roomName];
        if (!roomData) return true;
        var pumpCount = 0;
        var healthyPrice = 175000; 

        for (var lName in data.landmarkMarket) {
            var oldPrice = data.landmarkMarket[lName].price;
            if (oldPrice < 52500) {
                var ratio = oldPrice / healthyPrice; 
                for (var r in data.rooms) {
                    for (var uid in data.rooms[r].users) {
                        var u = data.rooms[r].users[uid];
                        if (u.landHoldings && u.landHoldings[lName]) {
                            u.skipHealing = true; 
                            u.landHoldings[lName] = Math.max(1, Math.floor(u.landHoldings[lName] * ratio));
                            u.landAvg[lName] = healthyPrice; 
                        }
                    }
                }
                data.landmarkMarket[lName].price = healthyPrice;
                data.landmarkMarket[lName].lastPrice = healthyPrice;
                data.landmarkMarket[lName].delistTick = 0;
                pumpCount++;
            }
        }
        safeSaveData(data);
        replier.reply(formatAdmin("ğŸ™ï¸ ë¶€ë™ì‚° ì‹œì¥ ì •ìƒí™” ì™„ë£Œ", "ë³´ì • ë§¤ë¬¼: " + pumpCount + "ê°œ\nì‹œì„¸ ì¬ì„¤ì •: " + fp(healthyPrice) + "P"));
        return true;
    }

    /* [4] ê²½ì œ ì§€í‘œ ìƒì„¸ ì¡°íšŒ */
    if (msg === "/ê²½ì œì •ë³´") {
        var eco = calculateEconomy(data, roomName);
        var rData = data.rooms[roomName];
        var base = rData.economyBase || 0;
        
        var multiplier = 1.0;
        if (base > 0) {
            var rawRatio = eco.total / base;
            var damping = (data.economyDamping !== undefined) ? data.economyDamping : 0.5;
            multiplier = 1 + (rawRatio - 1) * damping;
            if (multiplier < 0.5) multiplier = 0.5;
        }

        var ecoMsg = "ğŸ’° [ë°©ë³„ ë…ë¦½ ê²½ì œ ë¦¬í¬íŠ¸]\n" +
                     "ğŸ“ ëŒ€ìƒ êµ¬ì—­: " + roomName + "\n" +
                     "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                     "ğŸ’µ ì´ìì‚°: " + fp(eco.total) + "P\n" +
                     "ğŸ¦ ì€í–‰ì¬ê³ : " + fp(rData.bankReserve || 0) + "P\n" +
                     "âš–ï¸ ë¬¼ê°€ê¸°ì¤€: " + (base > 0 ? fp(base) + "P" : "ì„¤ì • ì—†ìŒ") + "\n" +
                     "ğŸ“ˆ ë¬¼ê°€ë°°ìœ¨: x" + multiplier.toFixed(2) + "\n" +
                     "ğŸ‘¥ í™œì„±ìœ ì €: " + eco.count + "ëª…\n" +
                     "ğŸ’ í‰ê· ìì‚°: " + fp(eco.average) + "P";

        replier.reply(formatAdmin("ì‹¤ì‹œê°„ ê²½ì œ ìƒí™©", ecoMsg));
        return true;
    }

   // [ê¸´ê¸‰] ë¶€ë™ì‚° ë°ì´í„° ì •ë°€ ìˆ˜ë¦¬ ë¡œì§
    if (msg === "/ì‹œì¥ë°ì´í„°êµì •") {
        var fixUserCount = 0;
        var healthyPrice = 175000; 

        for (var r in data.rooms) {
            for (var uid in data.rooms[r].users) {
                var u = data.rooms[r].users[uid];
                if (!u.landHoldings) continue;

                var isUserFixed = false;
                for (var lName in u.landHoldings) {
                    var land = data.landmarkMarket[lName];
                    var curQty = Number(u.landHoldings[lName]);
                    if (land && land.price >= 150000 && curQty > 5) {
                        u.skipHealing = true; 
                        var estimatedOldValue = curQty * 1000; 
                        u.landHoldings[lName] = Math.max(1, Math.round(estimatedOldValue / land.price));
                        if (!u.landAvg) u.landAvg = {};
                        u.landAvg[lName] = land.price;
                        isUserFixed = true;
                    }
                }
                if (isUserFixed) fixUserCount++;
            }
        }
        safeSaveData(data, false); 
        replier.reply(formatAdmin("ğŸ› ï¸ ë¶€ë™ì‚° ì§€ë¶„ ì •ë°€ ìˆ˜ë¦¬", "ëŒ€ìƒ ì¸ì›: " + fixUserCount + "ëª…\nì¡°ì¹˜: ë¹„ì •ìƒ ê³ ì•¡ ì§€ë¶„ ê°•ì œ ì••ì¶• ì™„ë£Œ"));
        return true;
    }

    /* [v11.0] ì „ êµ¬ì—­ ìœ ì € ë¶€ë™ì‚° ë³´ìœ  í˜„í™© ì´ê´„ ì¡°íšŒ */
    if (msg === "/ì „ì²´ë¶€ë™ì‚°") {
        var allUsers = [];
        var totalMarketValue = 0;
        var ownerCount = 0;

        for (var r in data.rooms) {
            var roomUsers = data.rooms[r].users;
            for (var uid in roomUsers) {
                var u = roomUsers[uid];
                var holdings = u.landHoldings || {};
                var keys = Object.keys(holdings);
                
                if (keys.length > 0) {
                    var userTotalValue = 0;
                    var holdingList = [];
                    
                    for (var i = 0; i < keys.length; i++) {
                        var lName = keys[i];
                        var qty = Number(holdings[lName]);
                        if (qty <= 0) continue;
                        
                        var land = data.landmarkMarket[lName];
                        var curPrice = land ? Number(land.price) : 0;
                        var trait = (land && land.type && SYSTEM_CONFIG.ECO.LANDMARK.TRAITS[land.type]) 
                                    ? SYSTEM_CONFIG.ECO.LANDMARK.TRAITS[land.type] : {icon: "ğŸ¢"};
                        
                        userTotalValue += (qty * curPrice);
                        holdingList.push("â€¢ " + trait.icon + " " + lName + " : " + qty + "ì§€ë¶„");
                    }

                    if (holdingList.length > 0) {
                        allUsers.push({
                            name: getDisplayName(u),
                            list: holdingList.join("\n"),
                            total: userTotalValue
                        });
                        totalMarketValue += userTotalValue;
                        ownerCount++;
                    }
                }
            }
        }

        if (allUsers.length === 0) {
            replier.reply(formatAdmin("ì¡°íšŒ ê²°ê³¼", "í˜„ì¬ ë¶€ë™ì‚° ì§€ë¶„ì„ ë³´ìœ í•œ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤."));
            return true;
        }

        var body = allUsers.map(function(u) {
            return "ğŸ‘¤ " + u.name + "ë‹˜\n" + u.list + "\nğŸ’° ìì‚°ê°€ì¹˜: " + fp(u.total) + "P";
        }).join("\n\n");

        var summary = "ğŸ“ˆ ì „ì²´ í†µê³„ ìš”ì•½\n" +
                      "â€¢ ë¶€ë™ì‚° ë³´ìœ  ìœ ì €: " + ownerCount + "ëª…\n" +
                      "â€¢ ì „ êµ¬ì—­ ì§€ë¶„ ì´ì•¡: " + fp(totalMarketValue) + "P";

        replier.reply(formatAdmin("ğŸ“Š ì „ êµ¬ì—­ ë¶€ë™ì‚° ë³´ìœ  í˜„í™©", body + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + summary));
        return true;
    }

   /* [v11.0] ìœ ì € ë¶€ë™ì‚° ì§€ë¶„ ê°•ì œ íšŒìˆ˜ ë¡œì§ */
    if (msg.indexOf("/ë¶€ë™ì‚°íšŒìˆ˜ ") === 0) {
        var ps = msg.trim().split(/\s+/);
        if (ps.length < 4) {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "í˜•ì‹: /ë¶€ë™ì‚°íšŒìˆ˜ [ë‹‰ë„¤ì„] [ê±´ë¬¼ëª…] [ìˆ˜ëŸ‰|ì „ë¶€]"));
            return true;
        }

        var qtyInput = ps.pop(); // ë§ˆì§€ë§‰ ì¸ì: ìˆ˜ëŸ‰ ë˜ëŠ” 'ì „ë¶€'
        var landInput = ps.pop(); // ì¤‘ê°„ ì¸ì: ê±´ë¬¼ëª…
        var targetNick = ps.slice(1).join(" ").trim(); // ë‚˜ë¨¸ì§€: ë‹‰ë„¤ì„

        var roomData = data.rooms[roomName];
        var found = findUserByName(roomData, targetNick);

        if (found.length === 0) {
            replier.reply(formatAdmin("ğŸš« ëŒ€ìƒ ì—†ìŒ", "[" + targetNick + "] ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        } else if (found.length > 1) {
            handleUserSelection(replier, targetUid, found, "admin_land_take", { land: landInput, qty: qtyInput }, user, roomName);
        } else {
            var f = found[0];
            var tUser = f.data; // ì •í™•íˆ 1ëª…ì˜ ë°ì´í„°ë§Œ ì°¸ì¡°
            var tRoom = f.roomName;
            var holdings = tUser.landHoldings || {};
            
            var matchedLand = util_findStockByShorthand(holdings, landInput);
            if (matchedLand.length === 0) {
                replier.reply(formatAdmin("ğŸš« ë³´ìœ  ì •ë³´ ì—†ìŒ", "[" + tUser.name + "]ë‹˜ì€ [" + landInput + "] ì§€ë¶„ì´ ì—†ìŠµë‹ˆë‹¤."));
                return true;
            }
            
            var sName = matchedLand[0];
            var currentQty = Number(holdings[sName] || 0);
            var takeQty = (qtyInput === "ì „ë¶€") ? currentQty : parseInt(qtyInput.replace(/,/g, ""));
            if (takeQty > currentQty) takeQty = currentQty;

            tUser.skipHealing = true;
            // í•´ë‹¹ ìœ ì €(tUser)ì˜ ì§€ë¶„ë§Œ ìˆ˜ì •
            util_updateLandmark(tUser, sName, -takeQty, "ê´€ë¦¬ì ê°•ì œ íšŒìˆ˜", tRoom);
            
            if (Number(tUser.landHoldings[sName]) <= 0) {
                delete tUser.landHoldings[sName];
                if (tUser.landAvg) delete tUser.landAvg[sName];
            }

            replier.reply(formatAdmin("âš™ï¸ ë¶€ë™ì‚° ê°•ì œ íšŒìˆ˜ ì™„ë£Œ", "ëŒ€ìƒ: " + tUser.name + "\nê±´ë¬¼: " + sName + "\nìˆ˜ëŸ‰: " + takeQty + "ì§€ë¶„ íšŒìˆ˜"));
            safeSaveData(data);
            return true;
        }
    }

    /* [v11.5] 6ëŒ€ í•µì‹¬ ëœë“œë§ˆí¬ ì‹¤ì‹œê°„ ë°°ë‹¹ í˜„í™© ì¡°íšŒ (ë¬¸ë²• ì˜¤ë¥˜ ìˆ˜ì •ë³¸) */
    if (msg === "/ë°°ë‹¹í˜„í™©") {
        var roomData = data.rooms[roomName];
        if (!roomData || !roomData.features || !roomData.features.dailyPools) return true;

        // 1. ì‹œê°„ ë° í™˜ê²½ ë³€ìˆ˜ ì•ˆì „ ë¡œë“œ
        var now = new Date();
        var startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        var hoursPassed = (now - startOfDay) / 3600000; 

        // SYSTEM_CONFIGê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ í•˜ë“œì½”ë”© ë°±ì—…
        var baseHourly = 10000;
        var threshold = 10;
        var bonusRate = 0.1;

        if (typeof SYSTEM_CONFIG !== 'undefined' && SYSTEM_CONFIG.ECO) {
            baseHourly = SYSTEM_CONFIG.ECO.HOURLY_DIVIDEND || 10000;
            threshold = SYSTEM_CONFIG.ECO.BONUS_THRESHOLD || 10;
            bonusRate = SYSTEM_CONFIG.ECO.BONUS_RATE || 0.1;
        }

        // 2. ë‚´ë¶€ ì „ìš© ìˆ«ì í¬ë§·í„° (fp í•¨ìˆ˜ê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ì„ ê²½ìš° ëŒ€ë¹„)
        var formatP = function(val) {
            if (isNaN(val)) return "0";
            return String(Math.floor(val)).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        };

        // 3. ë‚´ë¶€ ì „ìš© ì´ë¦„ ì¶”ì¶œê¸° (getDisplayName í•¨ìˆ˜ê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ì„ ê²½ìš° ëŒ€ë¹„)
        var getName = function(u) {
            if (!u) return "ì•Œ ìˆ˜ ì—†ìŒ";
            return u.name || "ì´ë¦„ì—†ìŒ";
        };

        var targets = [
            { name: "ê´‘ì‚°", icon: "â›ï¸" }, { name: "ë‚šì‹œí„°", icon: "ğŸ£" },
            { name: "ì¹´ì§€ë…¸", icon: "ğŸ°" }, { name: "ì¤‘ì•™ì€í–‰", icon: "ğŸ¦" },
            { name: "ë°±í™”ì ", icon: "ğŸ¢" }, { name: "ê²½ë§ˆì¥", icon: "ğŸ‡" }
        ];

        targets.sort(function(a, b) { return a.name.localeCompare(b.name); });

        var report = [];
        targets.forEach(function(t) {
            var owner = util_getMajorityOwner(roomData, t.name);
            var ownerTag = "âš ï¸ ì£¼ì¸ ì—†ìŒ";
            var finalDividend = 0;

            if (owner && owner.data) {
                var nameTag = getName(owner.data);
                ownerTag = "ğŸ‘‘ " + nameTag + " (" + owner.qty + "ì§€ë¶„)";
                
                // ë³´ë„ˆìŠ¤ ë°°ìœ¨ ê³„ì‚° (10ì§€ë¶„ ì´ˆê³¼ ì‹œ 10% ê°€ì‚°)
                var shareMult = owner.qty > threshold ? 1.0 + (owner.qty - threshold) * bonusRate : 1.0;
                finalDividend = Math.floor(baseHourly * hoursPassed * shareMult);
                
                if (owner.data.title === "ê°“ë¬¼ì£¼") finalDividend = Math.floor(finalDividend * 1.1);
            }

            report.push(t.icon + " " + t.name + "\n  ğŸ’° í˜„ì¬ê¹Œì§€ ì ë¦½: " + formatP(finalDividend) + "P\n  ğŸ‘¤ í˜„ì¬ ì£¼ì£¼: " + ownerTag);
        });

        var header = "ğŸ“Š ì‹¤ì‹œê°„ ëœë“œë§ˆí¬ ë°°ë‹¹ í˜„í™©\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâ€» ì‹œê°„ë‹¹ " + formatP(baseHourly) + "P í™•ì • ìˆ˜ìµ ëª¨ë¸";
        var footer = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâœ¨ ì˜¤ëŠ˜ ì´ ê²½ê³¼ ì‹œê°„: " + hoursPassed.toFixed(1) + "ì‹œê°„\nğŸ’¡ ìì •(00:00) ì •ì‚° ì‹œì ì— ìë™ ì§€ê¸‰ë©ë‹ˆë‹¤.";

        replier.reply(formatAdmin("ë°°ë‹¹ ë¦¬í¬íŠ¸", header + "\n\n" + report.join("\n\n") + "\n" + footer));
        return true;
    }

    if (msg === "/ê²½ì œì „ì²´ë¦¬ì…‹") {
        var roomData = data.rooms[roomName];
        if (!roomData) return true;
        
        var userCount = 0;
        var setPoint = 100000; // ì„¤ì •ëœ í˜„ê¸ˆ 10ë§Œ
        var setBank = 100000;  // ì„¤ì •ëœ ì˜ˆê¸ˆ 10ë§Œ

        for (var r in data.rooms) {
            for (var uid in data.rooms[r].users) {
                var u = data.rooms[r].users[uid];
                
                // 1. í—¬ëŸ¬ ë°©ì–´ë§‰ ê°€ë™ (ê¸‰ê° ë³µêµ¬ ì°¨ë‹¨)
                u.skipHealing = true; 
                
                // 2. ëª¨ë“  ìì‚° ë° ë¶€ì±„ ì²­ì‚°
                u.point = setPoint;
                u.bank = setBank;
                u.loan = { debt: 0, items: [] }; // ë¹š íƒ•ê°
                u.stockHoldings = {};           // ëœë“œë§ˆí¬ ì „ëŸ‰ ëª°ìˆ˜
                u.stockAvg = {};
                u.isTransferred = false;        // ëŒ€í™˜ ì±„ë¬´ ì‚­ì œ
                u.isDefaulter = false;          // ì‹ ë¶ˆì í•´ì œ
                u.creditScore = 600;            // ì‹ ìš©ì ìˆ˜ ì´ˆê¸°í™”
                u.tier = 0;                     // í‹°ì–´ ë¦¬ì…‹ (ì„ íƒ ì‚¬í•­)
                
                userCount++;
            }
        }

        // 3. ì¤‘ì•™ì€í–‰ ì¬ì› ì •ìƒí™” (ë¬¼ê°€ ê¸°ì¤€ì ì˜ 30% ìˆ˜ì¤€ìœ¼ë¡œ ìˆ˜í˜ˆ)
        var roomBase = roomData.economyBase || 3953977;
        roomData.bankReserve = Math.floor(roomBase * 0.3);

        safeSaveData(data, true); // ê°•ì œ ë°±ì—… ë™ì‹œ ìˆ˜í–‰
        
        var resMsg = "ğŸš¨ [êµ­ê°€ ê²½ì œ ëŒ€ê³µí™© ë° ê°•ì œ ë¦¬ì…‹ ì™„ë£Œ]\n" +
                     "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                     "â€¢ ëŒ€ìƒ ì¸ì›: " + userCount + "ëª… ì „ì²´\n" +
                     "â€¢ ê³µí†µ ì§€ê¸‰: í˜„ê¸ˆ 10ë§Œ + ì˜ˆê¸ˆ 10ë§Œ\n" +
                     "â€¢ íŠ¹ë³„ ì¡°ì¹˜: ë¹š íƒ•ê° / ëœë“œë§ˆí¬ ì´ˆê¸°í™” / ì‹ ë¶ˆ í•´ì œ\n" +
                     "â€¢ êµ­ê³  ìƒíƒœ: " + fp(roomData.bankReserve) + "P (ìˆ˜í˜ˆ ì™„ë£Œ)\n" +
                     "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                     "ğŸ’¡ ëª¨ë“  ìœ ì €ê°€ ë™ì¼í•œ ì¶œë°œì„ ì—ì„œ ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤.";
        replier.reply(formatAdmin("ê²½ì œ ì‹œìŠ¤í…œ ì¬ì‹œì‘", resMsg));
        return true;
    }

    if (msg === "/ì§€ë¶„í˜„í™©") {
        var landMarket = data.landmarkMarket;
        var landNames = Object.keys(landMarket);
        var report = [];
        
        // ì •ë ¬ ìš°ì„ ìˆœìœ„ ì •ì˜ (1:ê³ ì •, 2:ë¹„ì¦ˆë‹ˆìŠ¤, 3:ìƒê°€)
        var getPriority = function(name, type) {
            if (["ê´‘ì‚°", "ë‚šì‹œí„°", "ì¹´ì§€ë…¸", "ì¤‘ì•™ì€í–‰", "ë°±í™”ì ", "ê²½ë§ˆì¥"].indexOf(name) !== -1) return 1;
            if (type === "bluechip") return 2;
            if (type === "hotspot") return 3;
            return 4;
        };

        landNames.sort(function(a, b) {
            var priA = getPriority(a, landMarket[a].type);
            var priB = getPriority(b, landMarket[b].type);
            if (priA !== priB) return priA - priB;
            return a.localeCompare(b);
        });

        landNames.forEach(function(landName) {
            var owners = [];
            var totalLandShares = 0;
            for (var r in data.rooms) {
                for (var uId in data.rooms[r].users) {
                    var u = data.rooms[r].users[uId];
                    if (u.landHoldings && u.landHoldings[landName]) {
                        var q = Number(u.landHoldings[landName]);
                        if (q > 0) { owners.push(u.name + "(" + q + ")"); totalLandShares += q; }
                    }
                }
            }
            var ownerText = owners.length > 0 ? owners.join(", ") : "ì†Œìœ ì ì—†ìŒ";
            report.push("ğŸ¢ [" + landName + "] (ì´ " + totalLandShares + "ì§€ë¶„)\n   ğŸ‘¤ " + ownerText);
        });
        
        replier.reply(formatAdmin("ğŸ—ï¸ ì „ êµ¬ì—­ ë¶€ë™ì‚° ì§€ë¶„ ì¥ë¶€", report.join("\n\n")));
        return true;
    }

    /* [ë³´ì•ˆ] ìœ ì € ê³ ìœ  ì½”ë“œ ëª…ë¶€ ì¡°íšŒ (Ghost Filter ì ìš©) */
    if (msg === "/ëª…ë¶€í™•ì¸") {
        try {
            var regFile = new java.io.File(REGISTRY_PATH);
            if (!regFile.exists() || regFile.length() === 0) {
                replier.reply(formatAdmin("ğŸ“œ ìœ ì € ëª…ë¶€", "ë“±ë¡ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."));
                return true;
            }

            var registry = JSON.parse(FileStream.read(REGISTRY_PATH));
            var list = [];
            for (var key in registry) {
                // [í•µì‹¬] "ë‚´ë¦¬ë‹¤_"ë¡œ ì‹œì‘í•˜ëŠ” í‚¤ê°’ë§Œ ë¦¬ìŠ¤íŠ¸ì— í¬í•¨ (ìœ ë ¹ë°© ë°ì´í„° ì€í)
                if (key.indexOf("ë‚´ë¦¬ë‹¤_") !== 0) continue;

                var parts = key.split("_");
                var rName = parts[0]; 
                var uName = parts.slice(1).join("_"); 
                var uid = registry[key];

                var uData = (data.rooms[rName] && data.rooms[rName].users[uid]) ? data.rooms[rName].users[uid] : null;
                var statusTag = uData ? " [" + fp(uData.point) + "P]" : " [ë°ì´í„° ìœ ì‹¤]";
                
                list.push("â€¢ " + uName + statusTag + "\n  â”” " + uid);
            }

            if (list.length === 0) {
                replier.reply(formatAdmin("ğŸ“œ ìœ ì € ëª…ë¶€", "ì¡°íšŒëœ ì‹¤ì‚¬ìš© ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤."));
            } else {
                replier.reply(formatAdmin("ğŸ“œ ë‚´ë¦¬ë‹¤ êµ¬ì—­ ì‹¤ì‚¬ìš©ì ëª…ë¶€", list.join("\n\n")));
            }
        } catch (e) {
            replier.reply(formatAdmin("ğŸš« ì¡°íšŒ ì˜¤ë¥˜", "ëª…ë¶€ ë¡œë“œ ì‹¤íŒ¨"));
        }
        return true;
    }

    /* [ë³´ì•ˆ] íŠ¹ì • ë‹‰ë„¤ì„ ëª…ë¶€ ê°•ì œ ì‚­ì œ */
    if (msg.indexOf("/ëª…ë¶€ì‚­ì œ ") === 0) {
        var targetNick = msg.substring(6).trim();
        var regFile = new java.io.File(REGISTRY_PATH);
        if (!regFile.exists()) return replier.reply(formatAdmin("ì˜¤ë¥˜", "ëª…ë¶€ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."));

        var regData = JSON.parse(FileStream.read(REGISTRY_PATH));
        var matches = [];
        for (var key in regData) {
            var nickPart = key.substring(key.indexOf("_") + 1);
            if (nickPart.indexOf(targetNick) !== -1) {
                // ê³µí†µ ì—”ì§„ ê·œê²©ì— ë§ì¶° ë°ì´í„° í¬ë§·íŒ…
                matches.push({ id: key, data: { name: nickPart } });
            }
        }

        if (matches.length === 0) {
            replier.reply(formatAdmin("ì‚­ì œ ì‹¤íŒ¨", "ëª…ë¶€ì—ì„œ [" + targetNick + "]ì´(ê°€) í¬í•¨ëœ ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        } else if (matches.length > 1) {
            // ì„¹í„° 11ì˜ ê³µí†µ ì¤‘ë³µ ì„ íƒ ì—”ì§„ í˜¸ì¶œ (ì´ì œ ìˆ«ìê°€ ì‘ë™í•©ë‹ˆë‹¤!)
            handleUserSelection(replier, targetUid, matches, "admin_reg_delete", null, user, roomName);
        } else {
            // 1ëª…ì¼ ë•ŒëŠ” ì¦‰ì‹œ ì‚­ì œ ì‹¤í–‰
            var targetKey = matches[0].id;
            var targetFullNick = matches[0].data.name;
            delete regData[targetKey];
            FileStream.write(REGISTRY_PATH, JSON.stringify(regData));
            replier.reply(formatAdmin("ëª…ë¶€ ì‚­ì œ ì™„ë£Œ", "ì°¾ì€ ìœ ì €: [" + targetFullNick + "]\nê´€ë ¨ ì‹ë³„ ì½”ë“œë¥¼ ëª…ë¶€ì—ì„œ íŒŒê¸°í–ˆìŠµë‹ˆë‹¤."));
        }
        return true;
    }

    /* [ë³´ì•ˆ] ëª…ë¶€ ì¼ê´„ ìµœì í™” (ìœ ë ¹ ë°ì´í„° ì „ëŸ‰ ì œê±°) */
    if (msg === "/ëª…ë¶€ì—…ë°ì´íŠ¸") {
        var newRegistry = {};
        var count = 0;
        
        // í˜„ì¬ ë©”ëª¨ë¦¬ì— ë¡œë“œëœ(ì‹¤ì œ ì¡´ì¬í•˜ëŠ”) ìœ ì €ë“¤ë¡œë§Œ ëª…ë¶€ë¥¼ ìƒˆë¡œ ë§Œë“­ë‹ˆë‹¤.
        for (var rName in data.rooms) {
            var users = data.rooms[rName].users;
            for (var uid in users) {
                var regKey = rName + "_" + users[uid].name;
                newRegistry[regKey] = uid;
                count++;
            }
        }

        FileStream.write(REGISTRY_PATH, JSON.stringify(newRegistry));
        replier.reply(formatAdmin("âœ… ëª…ë¶€ ìµœì í™” ì™„ë£Œ", "í˜„ì¬ ì¡´ì¬í•˜ëŠ” " + count + "ëª…ì˜ ìœ ì € ì •ë³´ë¡œ ëª…ë¶€ë¥¼ ìƒˆë¡œ ê³ ì¹¨í–ˆìŠµë‹ˆë‹¤.\n(ìœ ë ¹ ë°ì´í„° ì „ëŸ‰ ì œê±°ë¨)"));
        return true;
    }

    /* [5] ë°ì´í„° êµì • ë° ë¬´ê²°ì„± ê²€ì‚¬ */
    if (msg.trim() === "/ë°ì´í„°êµì •") {
        var fixCount = 0;
        var refundCount = 0;
        var totalRefunded = 0;

        for (var r in data.rooms) {
            var currentRoom = data.rooms[r];
            if (!currentRoom.loanPools) currentRoom.loanPools = {};
            if (!currentRoom.loanContracts) currentRoom.loanContracts = {};

            for (var id in currentRoom.users) {
                var u = currentRoom.users[id];
                if (!u) continue;

                if (Number(u.totalAttendance || 0) <= 3) {
                    for (var cid in currentRoom.loanContracts) {
                        var c = currentRoom.loanContracts[cid];
                        if (c.borrowerUid === id) {
                            var lender = currentRoom.users[c.lenderUid];
                            if (lender) {
                                lender.point = Number(lender.point) + Number(c.currentDebt);
                                totalRefunded += Number(c.currentDebt);
                                refundCount++;
                            }
                            delete currentRoom.loanContracts[cid];
                        }
                    }
                }
                u.point = Math.floor(Number(u.point || 0));
                u.bank = Math.floor(Number(u.bank || 0));
                u.creditScore = Math.min(1000, Math.max(0, Number(u.creditScore || 600)));
                u.isDefaulter = (u.creditScore < 500);
                if (!u.loan) u.loan = { debt: 0, items: [] };
                if (!u.stockHoldings) u.stockHoldings = {};

                // êµì • ì‹œì ì— ì˜ˆê¸ˆìê°€ ê¸°ì¤€ ì‹œê°„ì´ ì—†ë‹¤ë©´ í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ê°•ì œ ì£¼ì…
                if (u.bank > 0 && (!u.lastBankUpdateTime || u.lastBankUpdateTime === 0)) {
                    u.lastBankUpdateTime = Date.now();
                }

                fixCount++;
            }
        }
        
        safeSaveData(data);
        var resMsg = "ì „ì²´ ìœ ì € " + fixCount + "ëª… ë™ê¸°í™” ì™„ë£Œ\n" +
                     "ğŸ“‰ ì‚¬ì±„ í™˜ìˆ˜: " + refundCount + "ê±´ (" + fp(totalRefunded) + "P ë°˜í™˜)";
        replier.reply(formatAdmin("ë°ì´í„° êµì • ë° ë¶„ë¦¬ ì™„ë£Œ", resMsg));
        return true;
    }

    /* [6] ë¬¼ê°€ ì¡°ì • */
    if (msg.indexOf("/ë¬¼ê°€ì¡°ì •") === 0) {
        var args = msg.split(" ");
        var currentEco = calculateEconomy(data, roomName); 
        if (args[1] === "ì´ˆê¸°í™”") { data.rooms[roomName].economyBase = 0; safeSaveData(data); replier.reply(formatAdmin("âš–ï¸ ë¬¼ê°€ ì´ˆê¸°í™”", "ê¸°ë³¸ê°€ë¡œ ê³ ì •ë©ë‹ˆë‹¤.")); return true; }
        var oldBase = data.rooms[roomName].economyBase || currentEco.total;
        var newBase = (args.length > 1 && !isNaN(parseInt(args[1]))) ? parseInt(args[1]) : Math.floor(Math.sqrt(oldBase * currentEco.total));
        data.rooms[roomName].economyBase = newBase;
        safeSaveData(data);
        replier.reply(formatAdmin("âš–ï¸ ë¬¼ê°€ ì¡°ì • ì™„ë£Œ", "ìƒˆ ê¸°ì¤€: " + fp(newBase) + "P"));
        return true;
    }

    /* [7] ë¬¼ê°€ ì™„ì¶© ë¹„ìœ¨ ì„¤ì • */
    if (msg.indexOf("/ë¬¼ê°€ì™„ì¶©") === 0) {
        var val = parseFloat(msg.split(" ")[1]);
        if (isNaN(val) || val < 0.0 || val > 1.0) { replier.reply(formatAdmin("ì˜¤ë¥˜", "0.0 ~ 1.0 ì‚¬ì´ì˜ ì†Œìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")); return true; }
        data.economyDamping = val;
        safeSaveData(data);
        replier.reply(formatAdmin("ğŸ›¡ï¸ ë¬¼ê°€ ì™„ì¶© ì„¤ì • ì™„ë£Œ", "ì ìš© ë¹„ìœ¨: " + (val*100) + "%"));
        return true;
    }

    /* [8] ì „ì—­ í¬ì¸íŠ¸ ì§€ê¸‰ */
    if (msg.indexOf("/í¬ì¸íŠ¸ì§€ê¸‰ ") === 0) {
        var parts = msg.trim().split(/\s+/);
        if (parts.length < 3) return replier.reply(formatError(user, "í˜•ì‹ ì˜¤ë¥˜", "/í¬ì¸íŠ¸ì§€ê¸‰ [ë‹‰ë„¤ì„] [ê¸ˆì•¡]"));
        var am = parseInt(parts.pop());
        var tn = parts.slice(1).join(" ").trim();
        
        var found = findUserGlobal(tn); // ì „ì—­ ê²€ìƒ‰
        if (!found.length) { replier.reply(formatError(user, "ëŒ€ìƒ ì—†ìŒ", "ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (found.length > 1) { handleUserSelection(replier, targetUid, found, "admin_point_give", { amount: am }, user, roomName); return true; }
        
        var f = found[0];
        util_updatePoint(f.data, data.rooms[f.roomName], am, "ê´€ë¦¬ì ì „ì—­ ì§€ê¸‰", f.roomName);
        replier.reply(formatAdmin("ì§€ê¸‰ ì™„ë£Œ", "[" + f.roomName + "] " + f.data.name + "ë‹˜: +" + fp(am) + "P"));
        try { Api.replyRoom("ë² ë¦­ë°©", "âš™ï¸ [Admin Action]\nâ€¢ ì‹¤í–‰ì: " + sender + "\nâ€¢ ë‚´ìš©: " + msg); } catch(e) {}
        safeSaveData(data);
        return true;
    }

    /* [9] ì „ì—­ í¬ì¸íŠ¸ ì°¨ê° */
    if (msg.indexOf("/í¬ì¸íŠ¸ì°¨ê° ") === 0) {
        var parts = msg.trim().split(/\s+/);
        if (parts.length < 3) return replier.reply(formatError(user, "í˜•ì‹ ì˜¤ë¥˜", "/í¬ì¸íŠ¸ì°¨ê° [ë‹‰ë„¤ì„] [ê¸ˆì•¡]"));
        var am = parseInt(parts.pop());
        var tn = parts.slice(1).join(" ").trim();
        
        var found = findUserGlobal(tn);
        if (!found.length) { replier.reply(formatError(user, "ëŒ€ìƒ ì—†ìŒ", "ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (found.length > 1) { handleUserSelection(replier, targetUid, found, "admin_point_take", { amount: am }, user, roomName); return true; }
        
        var f = found[0];
        util_updatePoint(f.data, data.rooms[f.roomName], -am, "ê´€ë¦¬ì ì „ì—­ ì°¨ê°", f.roomName);
        replier.reply(formatAdmin("ì°¨ê° ì™„ë£Œ", "[" + f.roomName + "] " + f.data.name + "ë‹˜ ì°¨ê° ì²˜ë¦¬ë¨"));
        safeSaveData(data);
        return true;
    }

    /* [10] ì „ì²´ í¬ì¸íŠ¸ ì§€ê¸‰ */
    if (msg.indexOf("/ì „ì²´í¬ì¸íŠ¸ì§€ê¸‰ ") === 0) {
        var amt = parseInt(msg.split(" ")[1]);
        if (isNaN(amt)) return true;
        var count = 0;
        for (var r in data.rooms) {
            for (var id in data.rooms[r].users) {
                util_updatePoint(data.rooms[r].users[id], data.rooms[r], amt, "ì „ì²´ í¬ì¸íŠ¸ ì§€ê¸‰", r);
                count++;
            }
        }
        safeSaveData(data);
        replier.reply(formatAdmin("ì „ì²´ ì§€ê¸‰ ì™„ë£Œ", "ì´ " + count + "ëª…ì—ê²Œ " + fp(amt) + "P ì§€ê¸‰ ì™„ë£Œ"));
        return true;
    }

    /* [ì‹ ê·œ: Gemini ìš”ì²­ ì‚¬í•­] ê²½ë§ˆ ì´ì›”ê¸ˆ ìˆ˜ë™ ì¡°ì • ëª…ë ¹ì–´ */
    if (msg.indexOf("/ì´ì›”ê¸ˆìˆ˜ì • ") === 0) {
        var val = parseInt(msg.split(" ")[1].replace(/,/g, ""));
        if (isNaN(val)) {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "ìˆ˜ì •í•  ì´ì›” ê¸ˆì•¡ì„ ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”."));
            return true;
        }
        // ë©”ì¸ ìš´ì˜ ë°©("ë‚´ë¦¬ë‹¤")ì˜ ê²½ë§ˆ ì´ì›”ê¸ˆ ê°•ì œ ìˆ˜ì •
        var targetRoom = data.rooms["ë‚´ë¦¬ë‹¤"];
        if (targetRoom && targetRoom.features && targetRoom.features.racing) {
            targetRoom.features.racing.carryOver = val;
            safeSaveData(data);
            replier.reply(formatAdmin("ğŸ‡ ê²½ë§ˆ ì´ì›”ê¸ˆ ìˆ˜ì • ì™„ë£Œ", "í˜„ì¬ ì ë¦½ëœ ì´ì›”ê¸ˆì„ " + fp(val) + "Pë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤."));
        }
        return true;
    }

    /* [11] í¬ì¸íŠ¸ ë¿Œë¦¬ê¸° (ë°©ë³„ ë…ë¦½ ì£¼ë¨¸ë‹ˆ ì—°ë™ - ë¨¹í†µ í•´ê²° í•µì‹¬) */
    if (msg === "/ë¿Œë¦¬ê¸°") {
        var roomData = data.rooms[roomName];
        var sprinkleData = roomData.features.sprinkleData; // ë°©ë³„ ë°ì´í„° ì—°ê²°

        if (sprinkleData.active) { 
            replier.reply(formatAdmin("ì˜¤ë¥˜", "ì´ë¯¸ ë¿Œë¦¬ê¸°ê°€ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.")); 
            return true; 
        }
        
        var count = Math.floor(Math.random() * 3) + 2; 
        var multiplier = util_getEcoMultiplier(roomName);
        
        var portions = [];
        var totalSprinkle = 0;
        for(var i=0; i<count; i++) {
            // ê¸°ë³¸ ë²”ìœ„ë¥¼ 5000 ~ 8000Pë¡œ ìƒí–¥
            var baseP = Math.floor(Math.random() * 3001) + 4000; 
            var finalP = Math.floor(baseP * multiplier);
            portions.push(finalP);
            totalSprinkle += finalP;
        }

        // [v5.9 ìˆ˜ì •] ì „ì—­ sprinkleDataê°€ ì•„ë‹Œ í˜„ì¬ ë°©ì˜ rFeatures.sprinkleDataì— í• ë‹¹
        sprinkleData.active = true;
        sprinkleData.totalPoint = totalSprinkle;
        sprinkleData.remainingPoint = totalSprinkle;
        sprinkleData.limit = count;
        sprinkleData.currentWinners = 0;
        sprinkleData.winners = [];
        sprinkleData.portions = portions;

        Api.replyRoom(roomName, formatAdmin("ğŸ‰ í¬ì¸íŠ¸ ë¿Œë¦¬ê¸° ì‹œì‘!", "ì„ ì°©ìˆœ " + count + "ëª…!\nì±„íŒ…ì°½ì— [ì¤ê¸°]ë¥¼ ì…ë ¥í•˜ì„¸ìš”!\nğŸ’° ì´ ë°°ì •: " + fp(totalSprinkle) + "P"));
        
        // 1ë¶„ í›„ ìë™ ì¢…ë£Œ íƒ€ì´ë¨¸ (ë°© ì´ë¦„ì„ í´ë¡œì €ë¡œ ì „ë‹¬)
        (function(targetRoom, targetData) {
            setTimeout(function() { 
                var rData = targetData.rooms[targetRoom];
                if (rData && rData.features.sprinkleData.active) { 
                    rData.features.sprinkleData.active = false; 
                    Api.replyRoom(targetRoom, formatAdmin("ğŸ ë¿Œë¦¬ê¸° ì‹œê°„ ì´ˆê³¼", "ì´ë²¤íŠ¸ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")); 
                    safeSaveData(targetData);
                } 
            }, 60000);
        })(roomName, data);
        
        safeSaveData(data);
        return true;
    }

    /* [12] ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì„¸íŠ¸ */
    if (msg === "/ë¡œë˜ë°ì´í„°ì´ˆê¸°í™”") {
        lotto = { round: (lotto.round || 0) + 1, entries: {}, dailyPool: 0, jackpot: 0, lastWinNums: [] };
        safeSaveData(data);
        replier.reply(formatAdmin("ì™„ë£Œ", "ë¡œë˜ ì‹œìŠ¤í…œ ë¦¬ì…‹ ì™„ë£Œ"));
        return true;
    }
    if (msg === "/ìŠ¹ê¸‰íšŸìˆ˜ì´ˆê¸°í™”") {
        for (var r in data.rooms) {
            for (var id in data.rooms[r].users) {
                data.rooms[r].users[id].dailyPromotionAttempts = 1;
                data.rooms[r].users[id].purchasedPromotionAttempts = 0;
            }
        }
        safeSaveData(data);
        replier.reply(formatAdmin("ì™„ë£Œ", "ì „ì²´ ìŠ¹ê¸‰ ê¸°íšŒ ì´ˆê¸°í™”"));
        return true;
    }

//==========ì„¹í„°36==========

    if (msg.trim() === "/ì‹œì¦Œê°•ì œì¢…ë£Œ") {
        var resetCount = 0;
        for (var r in data.rooms) {
            var rObj = data.rooms[r];
            if (!rObj.users) continue;
            for (var id in rObj.users) {
                var u = rObj.users[id];
                
                // 1. í‹°ì–´ ë° ëª…ì˜ˆì˜ ì „ë‹¹ ì´ˆê¸°í™”
                u.tier = 0; 
                u.challengerCount = 0; 
                u.challengerIconSeason = ""; 

                // 2. [í•µì‹¬] ìŠ¹ê¸‰ê¶Œ êµ¬ë§¤ íšŸìˆ˜ ì´ˆê¸°í™” (ê°€ê²©ì„ ë‹¤ì‹œ 2,000Pë¡œ ë³µêµ¬)
                u.purchasedPromotionAttempts = 0; 

                // 3. ì‹œì¦Œ í•œì • ì†Œëª¨í’ˆ/ì¸ì¦ ì´ˆê¸°í™”
                u.gameAuthCount = 0; 
                u.purchasedAuthCount = 0; 

                // 4. ë³´ì•ˆ ì—”ì§„(Healer)ì˜ ê°•ì œ ë³µêµ¬ ì¼ì‹œ ì°¨ë‹¨
                u.skipHealing = true; 
                
                resetCount++;
            }
        }
        
        // ë³€ê²½ ì‚¬í•­ ì¦‰ì‹œ ì €ì¥ ë° ë°±ì—…
        safeSaveData(data, true); 
        
        var resMsg = "ì‹œì¦Œì„ ê°•ì œ ì¢…ë£Œí•˜ê³  ëª¨ë“  ê¸°ë¡ì„ ë¦¬ì…‹í–ˆìŠµë‹ˆë‹¤.\n\n" +
                     "â€¢ ëŒ€ìƒ ìœ ì €: " + resetCount + "ëª…\n" +
                     "â€¢ ì´ˆê¸°í™” í•­ëª©: í‹°ì–´, ëª…ì˜ˆì˜ì „ë‹¹, ìŠ¹ê¸‰ê¶Œ í• ì¦ê°€\n" +
                     "â€¢ ìƒíƒœ: ìƒˆ ì‹œì¦Œ ì¤€ë¹„ ì™„ë£Œ";
        
        replier.reply(formatAdmin("ğŸ† ì‹œì¦Œ ê°•ì œ ì¢…ë£Œ ì™„ë£Œ", resMsg));
        return true;
    }

    /* [ë³´ì•ˆ] ë°ì´í„° ë³´í˜¸ ì—”ì§„ ìê°€ì§„ë‹¨ ëª…ë ¹ì–´ (v6.0 ì •ë°€ ì§„ë‹¨í˜•) */
   if (msg === "/ë³´ì•ˆì ê²€") {
        var st = function(ok) { return ok ? "ğŸŸ¢ ê°€ë™" : "ğŸ”´ ì ê²€"; };
        
        // 1. ê²Œì´íŠ¸ì›¨ì´ ì²´í¬ (Logic)
        var gw = {
            p: (typeof util_updatePoint === 'function'),
            u: (typeof util_setData === 'function'),
            r: (typeof util_updateReserve === 'function'),
            s: (typeof util_updateLandmark === 'function'),
            b: (typeof util_updateBank === 'function'),
            g: (typeof util_checkUserState === 'function')
        };

        // 2. ì¸í”„ë¼ ë° ì˜ì†ì„± ì²´í¬ (Infra)
        var infra = {
            lock: (typeof lock !== 'undefined' && !lock.isLocked()) || true,
            save: (typeof SaveExecutor !== 'undefined'),
            spam: (SYSTEM_CONFIG.SPAM !== undefined),
            backup: (SYSTEM_CONFIG.BACKUP.DISCORD_WEBHOOK_URL && SYSTEM_CONFIG.BACKUP.DISCORD_WEBHOOK_URL.indexOf("http") === 0),
            atomic: (new java.io.File(FILE_PATH).exists()),
            reg: (new java.io.File(REGISTRY_PATH).exists()),
            // [ì¶”ê°€] ë¸”ë™ë°•ìŠ¤ ë¡œê·¸ ê¸°ë¡ ê°€ëŠ¥ ì—¬ë¶€ ì²´í¬
            journal: (function() { try { return new java.io.File(BASE_DIR).canWrite(); } catch(e){return false;} })()
        };

        var report = "ğŸ›¡ï¸ [ë³´ì•ˆ ê´€ì œ ì„¼í„°] v6.0\n" +
                     "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                     "ğŸ“ [ë°ì´í„° ê²Œì´íŠ¸ì›¨ì´]\n" +
                     "â€¢ í¬ì¸íŠ¸: " + st(gw.p) + " | ë²”ìš©: " + st(gw.u) + "\n" +
                     "â€¢ êµ­ê³ ì¬ì›: " + st(gw.r) + " | ëœë“œë§ˆí¬: " + st(gw.s) + "\n" +
                     "â€¢ ì€í–‰ì”ê³ : " + st(gw.b) + " | ìƒíƒœ: " + st(gw.g) + "\n\n" +
                     "âš™ï¸ [ì‹¤ì‹œê°„ ë°©ì–´ ë° ì—”ì§„]\n" +
                     "â€¢ ë™ê¸°í™” ë½: " + st(infra.lock) + " (Lock)\n" +
                     "â€¢ ë¹„ë™ê¸° ì €ì¥: " + st(infra.save) + " (Save)\n" +
                     "â€¢ ì‹ ë¶„ ë³µêµ¬: " + st(infra.reg) + " (Registry)\n\n" +
                     "ğŸ“¦ [ì˜ì†ì„± ë° ë°±ì—…]\n" +
                     "â€¢ ë¸”ë™ë°•ìŠ¤: " + st(infra.journal) + " (Journal)\n" + // ë¸”ë™ë°•ìŠ¤ ì¶”ê°€
                     "â€¢ íŒŒì† ë°©ì§€: " + st(infra.atomic) + " (Atomic)\n" +
                     "â€¢ ì›ê²© ë°±ì—…: " + st(infra.backup) + " (Discord)\n" +
                     "â€¢ ìê°€ ì¹˜ìœ : ğŸŸ¢ í™œì„±í™” (Healer)\n" +
                     "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                     "âœ… ëª¨ë“  ì‹œìŠ¤í…œì´ ë³´í˜¸ë˜ê³  ìˆìŠµë‹ˆë‹¤.";
        
        replier.reply(report);
        return true;
    }

    /* [ì‹ ê·œ] ë³´ì•ˆ ì—”ì§„ ë‹¨ê³„ë³„ íŒŒê´´ ì‹œë®¬ë ˆì´ì…˜ (Stress Test) */
    if (msg.indexOf("/ë³´ì•ˆí…ŒìŠ¤íŠ¸ ") === 0) {
        var step = msg.split(" ")[1];
        var roomData = data.rooms[roomName];

        if (step === "1") { // [1ë‹¨ê³„: ë”¥í—¬ëŸ¬ ê²€ì¦]
            replier.reply("ğŸ§ª [í…ŒìŠ¤íŠ¸ 1: ë”¥í—¬ëŸ¬]\në‚´ ë©”ëª¨ë¦¬ ë°ì´í„°ì˜ 'ê°€ë°©'ê³¼ 'ì€í–‰' í•„ë“œë¥¼ ê°•ì œë¡œ ì‚­ì œí•©ë‹ˆë‹¤...");
            delete user.inventory;
            delete user.bank;
            replier.reply("âš ï¸ í•„ë“œ ì‚­ì œ ì™„ë£Œ. ì´ì œ ì•„ë¬´ ë©”ì‹œì§€ë‚˜ ì…ë ¥í•˜ì—¬ 'ë”¥í—¬ëŸ¬'ê°€ ìŠ¤í‚¤ë§ˆë¥¼ ë³µêµ¬í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.\n(ë³µêµ¬ ì„±ê³µ ì‹œ /ê°€ë°© ì¡°íšŒ ê°€ëŠ¥)");
        } 
        
        else if (step === "2") { // [2ë‹¨ê³„: ê²Œì´íŠ¸ì›¨ì´ ê²€ì¦]
            replier.reply("ğŸ§ª [í…ŒìŠ¤íŠ¸ 2: ê²Œì´íŠ¸ì›¨ì´]\ní¬ì¸íŠ¸ì— ìˆ«ìê°€ ì•„ë‹Œ 'ì˜¤ì—¼ëœ ë¬¸ìì—´' ì£¼ì…ì„ ì‹œë„í•©ë‹ˆë‹¤...");
            util_updatePoint(user, roomData, "BAD_DATA", "ë³´ì•ˆ í…ŒìŠ¤íŠ¸ ê³µê²©", roomName);
            replier.reply("âœ… ê²°ê³¼: ê²Œì´íŠ¸ì›¨ì´ê°€ ì˜¤ì—¼ëœ ì—°ì‚°ì„ ì°¨ë‹¨í–ˆìŠµë‹ˆë‹¤. ìƒë‹¨ ë¡œê·¸(Log.error) ë˜ëŠ” ë¸”ë™ë°•ìŠ¤ ê¸°ë¡ì„ í™•ì¸í•˜ì„¸ìš”.");
        } 

        else if (step === "3") { // [3ë‹¨ê³„: ìµœì¢… ê²€ì—­ì†Œ ê²€ì¦]
            replier.reply("ğŸ§ª [í…ŒìŠ¤íŠ¸ 3: ìµœì¢… ê²€ì—­ì†Œ]\në‚´ í¬ì¸íŠ¸ë¥¼ ê°•ì œë¡œ 'NaN(ë¹„ìˆ«ì)'ìœ¼ë¡œ ì˜¤ì—¼ì‹œí‚¨ ë’¤ ì €ì¥ì„ ì‹œë„í•©ë‹ˆë‹¤...");
            user.point = NaN; 
            safeSaveData(data, false);
            replier.reply("ğŸ›¡ï¸ ê²°ê³¼: 'ë°ì´í„° ìê°€ ì¹˜ìœ ' ì•Œë¦¼ì´ ëœ¨ë©° íŒŒì¼ ì €ì¥ì´ ì°¨ë‹¨ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.");
        }
        
        return true;
    }

    if (msg.trim() === "/ì‹œìŠ¤í…œìê°€ë³µì›") {
        // 1. íœ˜ë°œì„± ìƒíƒœê°’ ë° í™œë™ ë½(Lock) ì¼ê´„ í•´ì œ
        lottoPurchaseState = {}; 
        sprinkleData = { active: false, winners: [] };
        activeThefts = {}; 
        duelData = {}; 
        selectWaitState = {};
        bankProcessState = {}; 
        menuWaitState = {};
        miningState = {}; // ê´‘ì‚° í™œë™ ì´ˆê¸°í™”

        // 2. UID ìºì‹œ ì´ˆê¸°í™” (ë©”ëª¨ë¦¬ ì •ë¦¬)
        if (typeof uidCache !== 'undefined') {
            for (var k in uidCache) delete uidCache[k];
        }

        // 3. ì‹œìŠ¤í…œ í•µì‹¬ ê²½ì œ ì§€í‘œ ë³µêµ¬
        if (!data.marketOpenPrice || data.marketOpenPrice <= 0) data.marketOpenPrice = 1000;
        marketOpenPrice = data.marketOpenPrice; // ì „ì—­ ë³€ìˆ˜ ë™ê¸°í™”

        // 4. ì „ ìœ ì € ë°ì´í„° ìˆ˜ì¹˜ ì •ê·œí™” ë° ë°©ë³„ ë…ë¦½ ìƒíƒœ ì´ˆê¸°í™”
        var fixCount = 0;
        for (var r in data.rooms) {
            var roomObj = data.rooms[r];
            
            // [í•µì‹¬ í•´ê²°] /ì„œë²„ì§„ë‹¨ ìˆ˜ì¹˜ì— ë°˜ì˜ë˜ëŠ” ë°©ë³„ states ì£¼ë¨¸ë‹ˆ ê°•ì œ ë¹„ìš°ê¸°
            if (roomObj.features && roomObj.features.states) {
                var st = roomObj.features.states;
                for (var sKey in st) { st[sKey] = {}; }
            }
            
            // ì¤‘ì•™ì€í–‰ ì¬ì› ëˆ„ë½ ì‹œ ë³µêµ¬
            if (roomObj.bankReserve === undefined || roomObj.bankReserve === null) {
                roomObj.bankReserve = (SYSTEM_CONFIG && SYSTEM_CONFIG.ECO.BANK.INITIAL_RESERVE) ? SYSTEM_CONFIG.ECO.BANK.INITIAL_RESERVE : 10000;
            }
            // ìœ„ê¸° ì•Œë¦¼ ìƒíƒœ ë¦¬ì…‹
            roomObj.lastBankAlert = "normal";

            for (var id in roomObj.users) {
                var u = roomObj.users[id];
                if (!u) continue;
                u.point = Math.floor(Number(u.point || 0));
                u.bank = Math.floor(Number(u.bank || 0));
                u.creditScore = Math.min(1000, Math.max(0, Number(u.creditScore || 600)));
                
                if (!u.loan) u.loan = { debt: 0, items: [] };
                if (!u.stockHoldings) u.stockHoldings = {};
                fixCount++;
            }
        }

        // 5. íŒŒì¼ ì‹œìŠ¤í…œ ë½(Lock) ê°•ì œ í•´ì œ ì‹œë„
        if (lock.isLocked()) {
            try { lock.unlock(); } catch(e) {}
        }

        safeSaveData(data);
        replier.reply(formatAdmin("âš™ï¸ ì‹œìŠ¤í…œ ìê°€ ë³µì› ì™„ë£Œ", 
            "1. ëª¨ë“  ì…ë ¥ ëŒ€ê¸° ë° í™œë™ ìƒíƒœ ì´ˆê¸°í™” (ë°©ë³„ ë…ë¦½ ìƒíƒœ í¬í•¨)\n" +
            "2. ì¤‘ì•™ì€í–‰ ì¬ì› ë° ëœë“œë§ˆí¬ ì‹œì„¸ ì§€í‘œ ë³µêµ¬\n" +
            "3. êµ­ê°€ ìœ„ê¸° ì•Œë¦¼ ì—”ì§„ ë¦¬ì…‹\n" +
            "4. ìœ ì € " + fixCount + "ëª…ì˜ ë°ì´í„° ì •ìˆ˜í™” ì™„ë£Œ"));
        return true;
    }

    /* [ì‹ ê·œ] ëª¨ë“  ëª…ë ¹ì–´ ì‘ë‹µ ë¬´ê²°ì„± ì ê²€ ë¡œì§ */
    if (msg === "/ëª…ë ¹ì–´ì ê²€") {
        var statusReport = [];
        var totalCmds = CMD_LIST.user.concat(CMD_LIST.admin);
        var brokenCount = 0;

        statusReport.push("ğŸ” [ì „ì²´ ëª…ë ¹ì–´ ì—°ê²° ìƒíƒœ ì ê²€]\n");

        for (var i = 0; i < totalCmds.length; i++) {
            var c = totalCmds[i];
            var cmdName = c.cmd;
            var funcName = c.func;
            
            // 1. ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë“±ë¡ í™•ì¸ ë° 2. í•¨ìˆ˜ ê°ì²´ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
            var isRegistered = (USER_COMMANDS[cmdName] || ADMIN_COMMANDS[cmdName]);
            var functionExists = false;
            try { functionExists = (typeof eval(funcName) === 'function'); } catch(e) {}

            if (isRegistered && functionExists) {
                // ì •ìƒì ìœ¼ë¡œ ì—°ê²°ëœ ê²½ìš° (ì¶œë ¥ ìƒëµ ê°€ëŠ¥í•˜ë‚˜ í™•ì¸ì„ ìœ„í•´ í‘œì‹œ)
                // statusReport.push("âœ… " + cmdName + " : ì •ìƒ");
            } else {
                // ì—°ê²°ì´ ëŠê²¼ê±°ë‚˜ í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ëŠ” ê²½ìš°
                var reason = !isRegistered ? "ë“±ë¡ëˆ„ë½" : "ë¡œì§ì‹¤íŒ¨";
                statusReport.push("âŒ " + cmdName + " : " + reason + " (í™•ì¸ í•„ìš”)");
                brokenCount++;
            }
        }

        if (brokenCount === 0) {
            statusReport.push("âœ… ëª¨ë“  ëª…ë ¹ì–´ì˜ ë¡œì§ ì—°ê²°ì´ ì •ìƒì…ë‹ˆë‹¤.\n(ì‘ë‹µ ë¶ˆê°€ í˜„ìƒ ì—†ìŒ)");
        } else {
            statusReport.push("\nâš ï¸ ì´ " + brokenCount + "ê°œì˜ ëª…ë ¹ì–´ê°€ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        }

        replier.reply(formatAdmin("ğŸ›°ï¸ ëª…ë ¹ì–´ ë¬´ê²°ì„± ë¦¬í¬íŠ¸", statusReport.join("\n")));
        return true;
    }

    /* [v10.0 IPM] ì§€ëŠ¥í˜• ì„œë²„ ìƒíƒœ ëŒ€ì‹œë³´ë“œ */
    if (msg === "/ì„œë²„ìƒíƒœ") {
        // 1. ìƒíƒœ ì•„ì´ì½˜ íŒë³„
        var statusIcon = (PERF_METRICS.avgLag < 200) ? "ğŸŸ¢ ì¾Œì " : (PERF_METRICS.avgLag < 450 ? "ğŸŸ¡ ë³´í†µ" : "ğŸ”´ ê³¼ë¶€í•˜");
        
        // 2. ë¡œê·¸ ìš©ëŸ‰ ê³„ì‚° (MB)
        var logFile = new java.io.File(JOURNAL_PATH);
        var logMB = (logFile.exists() ? (logFile.length() / (1024 * 1024)).toFixed(2) : "0.00");
        
        // 3. ë¦¬í¬íŠ¸ ë³¸ë¬¸ (ê´€ë¦¬ìë‹˜ ì›ë³¸ ì–‘ì‹ 100% ì ìš© ë° data ë³€ìˆ˜ ì°¸ì¡° êµì •)
        var report = "âš™ï¸ [ì‹œìŠ¤í…œ ì‹¤ì‹œê°„ ê±´ê°• ì§„ë‹¨]\n" +
                     "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                     "ğŸ“Š í¼í¬ë¨¼ìŠ¤ ìƒíƒœ: " + statusIcon + "\n" +
                     "â€¢ í‰ê·  ì‘ë‹µ: " + PERF_METRICS.avgLag + "ms\n" +
                     "â€¢ ìµœê³  ì§€ì—°: " + PERF_METRICS.peakLag + "ms\n\n" +
                     "ğŸ“‚ ìì› ì‚¬ìš©ëŸ‰\n" +
                     "â€¢ ë¸”ë™ë°•ìŠ¤ ë¡œê·¸: " + logMB + " / 1.50 MB\n" +
                     "â€¢ ë¶„ë‹¹ ì²˜ë¦¬ëŸ‰: " + PERF_METRICS.msgPerMin + " msg/min\n" +
                     "â€¢ ì‹ë³„ ìºì‹œ: " + Object.keys(data.nameToIdCache || {}).length + " ê±´\n" +
                     "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                     "ğŸ’¡ ì‹œìŠ¤í…œì´ ìŠ¤ìŠ¤ë¡œ ìµœì í™” ì¤‘ì…ë‹ˆë‹¤.";
                     
        replier.reply(formatAdmin("ì§€ëŠ¥í˜• ê°ì‹œ ì„¼í„°", report));
        return true;
    }

    /* [ê¸´ê¸‰] ì§€ëŠ¥í˜• ì „ì²´ ë°ì´í„° ë³µêµ¬ (Smart Restore v5.9+) */
Â  Â  if (msg.startsWith("/ì „ì²´ë³µì›")) {
Â  Â  Â  Â  var stablePath = BACKUP_DIR + "last_stable_backup.json";
Â  Â  Â  Â  var stableFile = new java.io.File(stablePath);

Â  Â  Â  Â  if (!stableFile.exists() || stableFile.length() === 0) {
Â  Â  Â  Â  Â  Â  replier.reply(formatAdmin("ğŸš« ë³µêµ¬ ì‹¤íŒ¨", "ì•ˆì „ ë°±ì—… íŒŒì¼(last_stable_backup.json)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
Â  Â  Â  Â  Â  Â  return true;
Â  Â  Â  Â  }

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  var content = FileStream.read(stablePath);
Â  Â  Â  Â  Â  Â  if (!content) throw new Error("íŒŒì¼ ë‚´ìš©ì´ ë¹„ì–´ìˆìŒ");

Â  Â  Â  Â  Â  Â  // 1. ë©”ëª¨ë¦¬ êµì²´ ë° ë©”ì¸ íŒŒì¼ ë¬¼ë¦¬ì  ë™ê¸°í™”
Â  Â  Â  Â  Â  Â  var backupObj = JSON.parse(content);
Â  Â  Â  Â  Â  Â  globalData = backupObj;
Â  Â  Â  Â  Â  Â  FileStream.write(FILE_PATH, content);

Â  Â  Â  Â  Â  Â  // 2. [í•µì‹¬] ì‹¤ì‹œê°„ ë¸”ë™ë°•ìŠ¤(Journal) ë³‘í•©
Â  Â  Â  Â  Â  Â  // ë°±ì—… ì‹œì  ì´í›„ë¶€í„° í˜„ì¬ê¹Œì§€ ë°œìƒí•œ ëª¨ë“  í¬ì¸íŠ¸ ë³€ë™ì„ ì†Œê¸‰ ì ìš©í•©ë‹ˆë‹¤.
Â  Â  Â  Â  Â  Â  if (typeof recoverFromJournal === 'function') {
Â  Â  Â  Â  Â  Â  Â  Â  recoverFromJournal(globalData);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // 3. ìµœì¢… ì •í™”ëœ ë°ì´í„°ë¥¼ ì„¸ì…˜ì— ë°˜ì˜í•˜ê³  ì¦‰ì‹œ ì €ì¥
Â  Â  Â  Â  Â  Â  safeSaveData(globalData, false);

Â  Â  Â  Â  Â  Â  var resBody = "âœ… ì§€ëŠ¥í˜• ë°ì´í„° ë³µêµ¬ ì™„ë£Œ\n" +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "â€¢ ì†ŒìŠ¤: last_stable_backup.json\n" +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "â€¢ ë³‘í•©: ì‹¤ì‹œê°„ ë¸”ë™ë°•ìŠ¤ ë¡œê·¸ í†µí•©\n" +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "â€¢ ìƒíƒœ: ì˜¤ì—¼ ë°ì´í„° ì •í™” ì„±ê³µ";

Â  Â  Â  Â  Â  Â  replier.reply(formatAdmin("ğŸ› ï¸ ì‹œìŠ¤í…œ ë³µêµ¬ ë³´ê³ ", resBody));

Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Log.error("Restore Logic Crash: " + e);
Â  Â  Â  Â  Â  Â  replier.reply(formatAdmin("ğŸš« ë³µêµ¬ ì¤‘ë‹¨", "ë°ì´í„° íŒŒì‹± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì‚¬ìœ : " + e.message));
Â  Â  Â  Â  }
Â  Â  Â  Â  return true;
Â  Â  }

    return false;
}

//==========ì„¹í„°37==========

/**
 * [ê²Œì„ ëª…ë ¹ì–´ ë¶„ë°°ê¸°] (Game Logic Dispatcher - Registry Refactored)
 * ì„¤ëª…: ìœ ì €ë“¤ì˜ ê²Œì„/ê²½ì œ í™œë™ ëª…ë ¹ì–´ë¥¼ ê° ì „ë¬¸ ë‹´ë‹¹ í•¨ìˆ˜ë¡œ ì—°ê²°í•©ë‹ˆë‹¤.
 * ì„¹í„° 1ì˜ USER_COMMANDS ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¥¼ ì°¸ì¡°í•˜ì—¬ ë“±ë¡ëœ ë¡œì§ì„ ìë™ìœ¼ë¡œ ë§¤í•‘ ë° ì‹¤í–‰í•©ë‹ˆë‹¤.
 */
function _handleGameLogic(msg, user, data, replier, roomName, targetUid, sender) {
    var roomData = data.rooms[roomName];
    var duelData = roomData.features.states.duelData; // ë°©ë³„ ê²°íˆ¬ ë°ì´í„° ì—°ê²°
    
    // 1. ëª…ë ¹ì–´ ì²« ë‹¨ì–´ ì¶”ì¶œ
    var cmd = msg.split(" ")[0];

    // [ê°€ìƒ ì •ë¶€ ì‹œìŠ¤í…œ] ì •ì±… ë° íˆ¬í‘œ ëª…ë ¹ì–´ ë¶„ê¸° ì²˜ë¦¬
    if (cmd === "/ì˜íšŒ" || cmd === "/íˆ¬í‘œ") {
        if (typeof _gameGovernmentLogic === 'function') {
            return _gameGovernmentLogic(msg, user, data, replier, roomName, targetUid);
        }
    }

    // 2. ìœ ì € ëª…ë ¹ì–´ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ê²€ìƒ‰
    if (USER_COMMANDS[cmd] && typeof USER_COMMANDS[cmd].execute === 'function') {
        
        // [ê²°íˆ¬ í‚¤ì›Œë“œ ê°€ë“œ] localized duelData ì‚¬ìš©
        if (cmd === "ìˆ˜ë½" || cmd === "ê±°ì ˆ" || cmd === "ì·¨ì†Œ") {
            var hasDuel = false;
            if (duelData[targetUid]) hasDuel = true;
            else {
                for (var d in duelData) {
                    if (duelData[d].challengerUid === targetUid) { hasDuel = true; break; }
                }
            }
            if (!hasDuel) return false;
        }
        
        // 3. ê²€ì¦ëœ ëª…ë ¹ì–´ë§Œ í•˜ìœ„ ë¡œì§ í•¨ìˆ˜(ì„¹í„° 40~44 ë“±)ë¡œ ì‹¤í–‰ ìœ„ì„
        return USER_COMMANDS[cmd].execute(msg, user, data, replier, roomName, targetUid);
    }

    // 4. ë“±ë¡ë˜ì§€ ì•Šì€ ëª…ë ¹ì–´ì´ê±°ë‚˜ ì²˜ë¦¬í•  ë¡œì§ì´ ì—†ëŠ” ê²½ìš° false ë°˜í™˜
    return false;
}

//==========ì„¹í„°38==========

/**
 * [ê²Œì„ í•˜ìœ„ ëª¨ë“ˆ 1] ì€í–‰ ë° ì‚¬ì±„ ê´€ë¦¬
 * ê¸°ëŠ¥: ì€í–‰ ë©”ë‰´ í˜¸ì¶œ, ëŒ€ì¶œê¸ˆ ì§ì ‘ ìƒí™˜
 * ì„¤ëª…: ë©”ë‰´ UIì— ê¸°ë¶€ í•­ëª©ì„ ì¶”ê°€í•˜ê³ , ìƒí™˜ ì‹œ ì¤‘ì•™ì€í–‰ ì¬ê³ ë¡œ í™˜ìˆ˜ë˜ë„ë¡ ì—°ë™í•¨.
 */
function _gameBankLogic(msg, user, data, replier, roomName, targetUid) {
    // 1. ê¸°ì´ˆ ë°ì´í„° ë° ê²½ì œ êµ¬ì—­ ì„ ì–¸ (ì°¸ì¡° ì˜¤ë¥˜ ë°©ì§€ í•µì‹¬)
    var currentRoom = data.rooms[roomName]; 
    var economyRoomName = (ALLOWED_ROOMS.indexOf(roomName) === -1) ? "ë‚´ë¦¬ë‹¤" : roomName;
    var economyRoomData = data.rooms[economyRoomName];

    // 2. í•˜ë‹¨ ë¡œì§ í˜¸í™˜ì„±ì„ ìœ„í•´ roomData ì •ì˜ (1:1ë°©ì´ë©´ ë©”ì¸ë°© ë°ì´í„°ë¥¼ ì°¸ì¡°)
    var roomData = (ALLOWED_ROOMS.indexOf(roomName) === -1) ? economyRoomData : currentRoom;

    // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì¤‘ë‹¨ (ì¥ì•  ë°©ì§€)
    if (!roomData || !roomData.features) return false;

    // 3. ì„¸ì…˜ ì €ì¥ì†Œ(States) ì´ˆê¸°í™”
    if (!currentRoom.features) {
        if (typeof ROOM_FEATURE_TEMPLATE === 'function') currentRoom.features = ROOM_FEATURE_TEMPLATE();
        else currentRoom.features = { states: { menuWait: {}, bankProcess: {} } };
    }
    
    var menuWaitState = currentRoom.features.states.menuWait;
    var bankProcessState = currentRoom.features.states.bankProcess;

    /* [ê¸°ëŠ¥ 1] ì€í–‰ ì‹œìŠ¤í…œ ì§„ì… (v5.2 ê¸°ë¶€ ë©”ë‰´ ì¶”ê°€) */
    if (msg === "/ì€í–‰") {
        var crTargetRoom = (ALLOWED_ROOMS.indexOf(roomName) === -1) ? "ë‚´ë¦¬ë‹¤" : roomName;
Â  Â  Â  Â  var cr = getCreditInfo(user.creditScore, crTargetRoom);
        
        menuWaitState[targetUid] = { type: 'bank_menu', time: Date.now() };

        var bankMenu = "1. ğŸ’° ì˜ˆê¸ˆ (í¬ì¸íŠ¸ â” ì€í–‰)\n" +
                       "2. ğŸ§ ì¶œê¸ˆ (ì€í–‰ â” í¬ì¸íŠ¸)\n" +
                       "3. ğŸ’¸ ì†¡ê¸ˆ (íƒ€ì¸ì—ê²Œ ì´ì²´)\n" +
                       "4. ğŸ¦ ëŒ€ì¶œ (í•œë„: " + fp(cr.limit) + "P)\n" + // ë©”ë‰´ì— ì‹¤ì‹œê°„ í•œë„ ì§ì ‘ í‘œì‹œ
                       "5. ğŸ“‰ ìƒí™˜ (ëŒ€ì¶œê¸ˆ ê°šê¸°)\n" +
                       "6. " + (SYSTEM_CONFIG.MSG.PREFIX.LOAN || "ğŸš¬") + " ì‚¬ì±„ ì‹œì¥ (P2P ëŒ€ì¶œ)\n" +
                       "7. ğŸ ê¸°ë¶€ (êµ­ê³  í›„ì›)";
        
        var myPoint = Number(user.point || 0);
        var myBank = Number(user.bank || 0);
        
        var content = bankMenu + "\n\n" +
               "ğŸ¦ ì€í–‰ ì”ê³  : " + fp(roomData.bankReserve) + "P\n\n" +
               "ë³´ìœ : " + fp(myPoint) + "P / ì˜ˆê¸ˆ: " + fp(myBank) + "P\n" +
               "(ë²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”)";

        // formatCommandë¥¼ í˜¸ì¶œí•˜ì—¬ ìµœì¢… ë©”ì‹œì§€ ì¡°ë¦½
        replier.reply(formatCommand("ğŸ¦ ì€í–‰ ì—…ë¬´ ì„ íƒ", user, content, "ì…ë ¥ ëŒ€ê¸°: 30ì´ˆ"));
        return true;
    }

    /* [ê¸°ëŠ¥ 2] ëŒ€ì¶œê¸ˆ ìƒí™˜ (ì§ì ‘ ëª…ë ¹ì–´) */
    if (msg.indexOf("/ìƒí™˜ ") === 0) {
        var myDebt = (user.loan && user.loan.debt) ? Number(user.loan.debt) : 0;
        if (myDebt <= 0) { 
            replier.reply(formatError(user, "ìƒí™˜ ë¶ˆê°€", "ê°šì•„ì•¼ í•  ì€í–‰ ëŒ€ì¶œê¸ˆì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")); 
            return true; 
        }

        var parts = msg.split(" ");
        // ì‰¼í‘œê°€ í¬í•¨ëœ ì…ë ¥ë„ ì²˜ë¦¬ ê°€ëŠ¥í•˜ë„ë¡ ê°œì„ 
        var amt = parseInt(parts[1].replace(/,/g, "")); 
        
        if (isNaN(amt) || amt <= 0) { 
            replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜", "ì •í™•í•œ ìƒí™˜ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.")); 
            return true; 
        }
        
        var myPoint = Number(user.point || 0);
        if (myPoint < amt) { 
            replier.reply(formatError(user, "í¬ì¸íŠ¸ ë¶€ì¡±", "ë³´ìœ  í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.")); 
            return true; 
        }
        
        // ë¶„ì‚° ìƒí™˜ ë¡œì§ í˜¸ì¶œ (ì„¹í„° 13 ì •ì˜) - ë©”ì¸ ë°© ê¸°ì¤€ìœ¼ë¡œ ì‹ ìš©ì ìˆ˜ ê³„ì‚°
        var targetRoomName = (ALLOWED_ROOMS.indexOf(roomName) === -1) ? "ë‚´ë¦¬ë‹¤" : roomName;
Â  Â  Â  Â  var res = distributeRepayment(user, amt, targetRoomName);
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* [ì¤‘ì•™ì€í–‰ ì—°ë™] í†µí•© í¬ì¸íŠ¸ í•¨ìˆ˜ ì‚¬ìš© */
Â  Â  Â  Â  // ìœ ì € í¬ì¸íŠ¸ ì°¨ê°ê³¼ ë™ì‹œì— ì°¨ê°ëœ ê¸ˆì•¡(res.actualRepay)ì´ bankReserveì— ìë™ ì…ê¸ˆë¨.
        // ë¡œê·¸ ê¸°ë¡ ì‹œ 1:1 ë°© ì´ë¦„ì´ ì•„ë‹Œ ì‹¤ì œ ë©”ì¸ ë°© ì´ë¦„ìœ¼ë¡œ ê¸°ë¡ë˜ê²Œ í•¨
Â  Â  Â  Â  util_updatePoint(user, roomData, -Number(res.actualRepay), "ëŒ€ì¶œ ìƒí™˜", targetRoomName);
        
        var remainingDebt = (user.loan && user.loan.debt) ? Number(user.loan.debt) : 0;
        replier.reply(formatCommand("ğŸ“‰ ìƒí™˜ ì™„ë£Œ", user, fp(res.actualRepay) + "P ìƒí™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\n(ì‹ ìš© ì ìˆ˜ +" + res.creditGain + ")", "ë‚¨ì€ ëŒ€ì¶œ: " + fp(remainingDebt) + "P / ì”ì•¡: " + fp(user.point) + "P"));
        
        safeSaveData(data);
        return true;
    }

    return false;
}

//==========ì„¹í„°39==========

/**
 * [ê²Œì„ í•˜ìœ„ ëª¨ë“ˆ 2] ì •ë³´ ë° ë­í‚¹ ì¡°íšŒ (UI ìµœì í™” ë° ì¶œì„ ìƒíƒœ ì¶”ê°€)
 * ê¸°ëŠ¥: ë‚´ì •ë³´, ìœ ë¬¼ë„ê°, ì‹ ìš©ë“±ê¸‰, ëŒ€ì¶œí•œë„, ëª…ì˜ˆì˜ì „ë‹¹, ìˆœìœ„, ìœ ì €ì •ë³´, ê²½ë§ˆì¡°íšŒ
 * ìˆ˜ì • ì‚¬í•­: ë„êµ´ì™• ë‹¬ì„± ì‹œ íŠ¹ë³„ ì¶•í•˜ ë©˜íŠ¸ ì ìš© ë° ìœ ë¬¼ ë„ê° UI ìµœì¢… ìµœì í™”
 */
function _gameInfoLogic(msg, user, data, replier, roomName, targetUid) {
    // [1:1 ì—°ë™ í•µì‹¬] ë°ì´í„° ì†ŒìŠ¤ ë¦¬ë‹¤ì´ë ‰íŠ¸
    var targetRoomData = null;
    if (ALLOWED_ROOMS.indexOf(roomName) === -1) {
        var linkedRoom = data.rooms["ë‚´ë¦¬ë‹¤"];
        if (linkedRoom) {
            targetRoomData = linkedRoom;
        } else {
            return false;
        }
    } else {
        targetRoomData = data.rooms[roomName];
    }
    
    var roomData = targetRoomData; // ë³€ìˆ˜ëª… í†µì¼

    // 1. ë°© ë°ì´í„° ë° ê¸°ëŠ¥ í…œí”Œë¦¿ ì¡´ì¬ ì—¬ë¶€ ì²´í¬ (ì•ˆì „ ê°€ë“œ)
    if (!roomData || !roomData.features) return false;

    // 2. [í•µì‹¬ ê³ ì •] ì „ì—­ ë³€ìˆ˜ê°€ ì•„ë‹Œ ì´ í•¨ìˆ˜ ì „ìš© ì§€ì—­ ë³€ìˆ˜ë¡œ ë°ì´í„° ì—°ê²°
    // ì´ ì½”ë“œê°€ ìˆì–´ì•¼ /ê²½ë§ˆ, /ë¡œë˜ ë“±ì˜ ëª…ë ¹ì–´ê°€ ë¨¹í†µì´ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    var racingData = roomData.features.racing;
    var rConf = (SYSTEM_CONFIG.ECO && SYSTEM_CONFIG.ECO.RACING) ? SYSTEM_CONFIG.ECO.RACING : (SYSTEM_CONFIG.RACING || {});
    
    // ë§Œì•½ ìƒìˆ˜ê°€ ì•„ì˜ˆ ë¡œë“œë˜ì§€ ì•Šì•˜ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ìµœì†Œí•œì˜ ê¸°ë³¸ê°’ ë³´ì •
    if (!rConf.MIN_BET) {
        rConf.MIN_BET = 10000;
        rConf.MAX_BET = 30000;
        rConf.TAX_RATE = 0.1;
        rConf.CANCEL_FEE = 0.1;
    }

    /* [Gemini ìš”ì²­ ì‚¬í•­] ê²½ë§ˆ ì •ë³´ ì‹¤ì‹œê°„ ë¸Œë¦¬í•‘ ê¸°ëŠ¥ í†µí•© (ë‚´ ë°°íŒ… ì •ë³´ í¬í•¨) */
    if (msg === "/ê²½ë§ˆ") {
        if (!racingData.isOperating) {
            replier.reply(formatSimple("ğŸ‡ ê²½ë§ˆì¥ íœ´ì¥ ì•ˆë‚´", "í˜„ì¬ ê²½ë§ˆ ìš´ì˜ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤.\n(ìš´ì˜ì‹œê°„: 09:00 ~ 23:59)", "ì˜¤ì „ 9ì‹œ ì •ê°ì— ê°œì¥í•©ë‹ˆë‹¤."));
            return true;
        }

        var hList = racingData.horses.map(function(h) {
            var horseBetSum = 0;
            for (var uid in racingData.bets) {
                if (racingData.bets[uid].horseId === h.id) horseBetSum += Number(racingData.bets[uid].amount);
            }
            return h.id + ". " + h.name + " [" + h.icon + "]\n    â”” í˜„ ë°°íŒ…ì•¡: " + fp(horseBetSum) + "P";
        }).join("\n");

        var now = new Date();
        var nowMin = now.getMinutes();
        var remainMin = 49 - nowMin;
        var remainSec = 59 - now.getSeconds();
        if (remainMin < 0) { remainMin = 0; remainSec = 0; }

        var myBet = racingData.bets[targetUid];
        var myBetInfo = "";
        if (myBet) {
            var myHorse = racingData.horses[myBet.horseId - 1]; 
            myBetInfo = "ğŸ‘¤ ë‚´ ë°°íŒ…: " + myBet.horseId + "ë²ˆ " + myHorse.name + " (" + fp(myBet.amount) + "P)";
        } else {
            myBetInfo = "ğŸ‘¤ ë‚´ ë°°íŒ…: ì°¸ì—¬ ë‚´ì—­ ì—†ìŒ";
        }

        var raceHeader = (nowMin >= 50) ? "ğŸ ë°°íŒ… ë§ˆê° ë° ì •ì‚° ì¤‘" : "ì œ " + racingData.round + "íšŒì°¨ ê²½ê¸° ë°°íŒ… ì§„í–‰ ì¤‘";
        var totalPrizePool = racingData.totalPool + racingData.carryOver;
        var racingBody = raceHeader + "\n\n" +
                         "[ğŸ‡ ì¶œì „ë§ˆ ë¼ì¸ì—…]\n" + hList + "\n\n" +
                         myBetInfo + "\n" +
                         "ğŸ’° í˜„ì¬ ì´ ë°°ë‹¹ê¸ˆ: " + fp(totalPrizePool) + "P\n" +
                         (racingData.carryOver > 0 ? "âœ¨ ì´ì›” ì ë¦½ê¸ˆ: " + fp(racingData.carryOver) + "P í¬í•¨\n" : "") +
                         "ğŸ•’ ë°°íŒ… ë§ˆê°: " + remainMin + "ë¶„ " + remainSec + "ì´ˆ ë‚¨ìŒ";

        replier.reply(formatCommand("ğŸ‡ ë‚´ë¦¬ë‹¤ ì¤‘ì•™ ê²½ë§ˆì¥", user, racingBody, "ë°°íŒ…: [/ë°°íŒ… ë²ˆí˜¸ ê¸ˆì•¡]"));
        return true;
    }

    /* [ì‹ ê·œ] ë´‡ ì‘ë‹µ ì†ë„ ì²´í¬ */
Â  Â  if (msg === "/í•‘") {
Â  Â  Â  Â  var ping = Date.now() - _msgReceiveTime;
Â  Â  Â  Â  var status = ping < 150 ? "ğŸš€ ë§¤ìš° ì¾Œì " : (ping < 400 ? "ğŸŸ¢ ì–‘í˜¸" : (ping < 800 ? "ğŸŸ¡ ì§€ì—°" : "ğŸ”´ ê³¼ë¶€í•˜"));
Â  Â  Â  Â  replier.reply(formatSimple("ğŸ“ í! (Pong)", "â±ï¸ ì‘ë‹µ ì†ë„: " + ping + "ms\nğŸ“Š í˜„ì¬ ìƒíƒœ: " + status, "ì„œë²„ì˜ ì²˜ë¦¬ ì§€ì—° ì‹œê°„ì„ ì¸¡ì •í•©ë‹ˆë‹¤."));
Â  Â  Â  Â  return true;
Â  Â  }

    /* [ê¸°ëŠ¥ 3] ë‚´ ì •ë³´ ì¡°íšŒ */
    if (msg === "/ë‚´ì •ë³´") {
        var crTargetRoom = (ALLOWED_ROOMS.indexOf(roomName) === -1) ? "ë‚´ë¦¬ë‹¤" : roomName;
Â  Â  Â  Â  var cr = getCreditInfo(user.creditScore, crTargetRoom);
        var authInfo = "ğŸ® ê²Œì„ ì¸ì¦: " + (user.gameAuthCount || 0) + "/2 (ì‹œì¦Œ)";
        
        var bankDebt = (user.loan && user.loan.debt) ? Math.floor(Number(user.loan.debt)) : 0;
        var sacheDebt = 0;
        var sacheClaims = 0; 
        var overdueSache = 0;

        if (roomData && roomData.loanContracts) {
            for (var cid in roomData.loanContracts) {
                var c = roomData.loanContracts[cid];
                if (c.borrowerUid === targetUid) {
                    sacheDebt += Math.floor(c.currentDebt);
                    if (c.status === 'overdue') overdueSache += Math.floor(c.currentDebt);
                }
                if (c.lenderUid === targetUid) {
                    sacheClaims += Math.floor(c.currentDebt);
                }
            }
        }

        var todayStr = getSimpleDate();
        var attendMark = (user.lastDate === todayStr) ? " (âœ…)" : " (â³)";
        var totalPromotion = (Number(user.dailyPromotionAttempts) || 0) + (Number(user.purchasedPromotionAttempts) || 0);

        var currentAccrued = Number(user.accruedInterest || 0);
        if (user.lastBankUpdateTime > 0 && Number(user.bank) > 0) {
            var passed = Date.now() - user.lastBankUpdateTime;
            currentAccrued += Number(user.bank) * SYSTEM_CONFIG.ECO.BANK.INTEREST_RATE * (passed / 86400000);
        }

        var infoBody = authInfo + "\n" +
                       "ğŸ’° ë³´ìœ  í¬ì¸íŠ¸: " + fp(user.point) + "P\n" +
                       "ğŸ¦ ì˜ˆê¸ˆ: " + fp(user.bank) + "P\n" +
                       "ğŸ§§ ì§€ê¸‰ ì˜ˆì • ì´ì: " + fp(Math.floor(currentAccrued)) + "P\n" +
                       (sacheClaims >= 1 ? "ğŸ¤ ë¯¸ìˆ˜ ì±„ê¶Œ: " + fp(sacheClaims) + "P\n" : "") +
                       "ğŸ’³ ì‹ ìš© ë“±ê¸‰: " + cr.label + " (" + user.creditScore + "ì )\n" +
                       "ğŸ… í˜„ì¬ í‹°ì–´: " + (TIERS[user.tier] || "ì•„ì´ì–¸") + "\n" +
                       "ğŸ“… ëˆ„ì  ì¶œì„: " + (user.totalAttendance || 0) + "ì¼" + attendMark + "\n" +
                       "ğŸ”‚ ìŠ¹ê¸‰ ê¸°íšŒ: " + totalPromotion + "íšŒ";
        
        if (bankDebt > 0) {
            var transferTag = user.isTransferred ? " (ğŸš¨ëŒ€í™˜ ì±„ë¬´: 70% ê°•ì œìƒí™˜)" : "";
            infoBody += "\nğŸ¦ ë¯¸ìƒí™˜ ëŒ€ì¶œ: " + fp(bankDebt) + "P" + transferTag;
        }

        if (sacheDebt > 0) {
            infoBody += "\nğŸš¬ ë¯¸ìƒí™˜ ì‚¬ì±„: " + fp(sacheDebt) + "P";
            if (overdueSache > 0) infoBody += "\nğŸš¨ ì‚¬ì±„ ì—°ì²´: " + fp(overdueSache) + "P (50% ìë™ìƒí™˜)";
        }
        
        replier.reply(formatCommand("ğŸ“Œ ë‚´ ìƒì„¸ ì •ë³´", user, infoBody, "ì•„ì´í…œ êµ¬ë§¤: [/ìƒì ]")); 
        return true;
    }

    /* [Gemini ìš”ì²­ ì‚¬í•­] ìœ ë¬¼ ë„ê° ì¡°íšŒ UI ê°€ë³€ ì²˜ë¦¬ ìë™í™” */
    if (msg === "/ìœ ë¬¼ë„ê°") {
        var pieces = Number(user.artifactPieces || 0);
        
        // 1. í˜„ì¬ ì¡°ê° ìˆ˜ì— ë”°ë¥¸ ë‹¤ìŒ ëª©í‘œì¹˜ì™€ ëª©í‘œ ì¹­í˜¸ ì„¤ì •
        var targetGoal = 10;
        var nextTitle = "ë„êµ´ê¾¼";

        if (pieces >= 50) { 
            targetGoal = 50; 
            nextTitle = "ë„êµ´ì™• âšœï¸"; 
        } else if (pieces >= 40) { 
            targetGoal = 50; 
            nextTitle = "ë„êµ´ì™• âšœï¸"; 
        } else if (pieces >= 30) { 
            targetGoal = 40; 
            nextTitle = "íŠ¸ë ˆì €í—Œí„°"; 
        } else if (pieces >= 20) { 
            targetGoal = 30; 
            nextTitle = "ë°œêµ´ê°€"; 
        } else if (pieces >= 10) { 
            targetGoal = 20; 
            nextTitle = "íƒì‚¬ì›"; 
        } else { 
            targetGoal = 10; 
            nextTitle = "ë„êµ´ê¾¼"; 
        }

        // 2. ë‹¬ì„± ìƒíƒœ í…ìŠ¤íŠ¸ íŒë³„
        var statusTxt = (pieces >= 50) ? "ì „ì„¤ ë“±ê·¹!" : "ì§„í–‰ ì¤‘...";
        
        // 3. UI ë°”ë”” êµ¬ì„±
        var statusContent = "âœ¨ ìœ ë¬¼ ì¡°ê°\n" +
                            "ğŸ§© ë³´ìœ : " + pieces + " / " + targetGoal + " ê°œ\n\n" +
                            "ğŸ“Š ìƒíƒœ: " + statusTxt + "\n\n" +
                            "ğŸ ìˆ˜ì§‘ ë‹¬ì„± ë³´ìƒ\n" +
                            "ğŸ–ï¸ ì¹­í˜¸: [" + nextTitle + "] (" + statusTxt + ")";
        
        // 4. ê°€ì´ë“œ ë¬¸êµ¬ ê°€ë³€ ì²˜ë¦¬
        var guideText = (pieces >= 50) 
            ? "ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ê³ ëŒ€ì˜ ì‹ ë¹„ë¥¼ ëª¨ë‘ í’€ì–´ë‚¸ ë‹¹ì‹ ì€ ì´ ì‹œëŒ€ì˜ ì§„ì •í•œ ì „ì„¤, ë„êµ´ì™•ì´ì‹­ë‹ˆë‹¤!" 
            : "ê´‘ì‚°ì—ì„œ 0.1% í™•ë¥ ë¡œ ì¡°ê°ì´ ë°œê²¬ë©ë‹ˆë‹¤. " + targetGoal + "ê°œë¥¼ ëª¨ìœ¼ë©´ ìë™ìœ¼ë¡œ ì¹­í˜¸ê°€ ë¶€ì—¬ë©ë‹ˆë‹¤.";
        
        replier.reply(formatCommand("ğŸº ìœ ë¬¼ ë„ê°", user, statusContent, guideText));
        return true;
    }

    /* [ê¸°ëŠ¥ 4] ì‹ ìš© ë“±ê¸‰ ë° ëŒ€ì¶œ í•œë„ ì¡°íšŒ */
    if (msg === "/ì‹ ìš©ë“±ê¸‰" || msg === "/ëŒ€ì¶œí•œë„") {
        // 1. ì„¹í„° 10ì˜ í†µí•© ì—”ì§„ í˜¸ì¶œ (ì´ë¯¸ ìŠ¹ìˆ˜ì™€ ì‹ ë¶ˆìê°€ ê³„ì‚°ë˜ì–´ ìˆìŒ)
        // [ìˆ˜ì •] ê°•ì œë¡œ 'ë‚´ë¦¬ë‹¤' ë°© ê¸°ì¤€ ê³„ì‚°
        var targetRoomName = (ALLOWED_ROOMS.indexOf(roomName) === -1) ? "ë‚´ë¦¬ë‹¤" : roomName;
Â  Â  Â  Â  var limitTable = getCreditLimitTable(targetRoomName);
Â  Â  Â  Â  var cr = getCreditInfo(user.creditScore, targetRoomName);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 2. í˜„ì¬ ì‹œì¥ ìŠ¹ìˆ˜ í™•ì¸ (ë©”ì‹œì§€ ìƒë‹¨ ìƒíƒœ í‘œì‹œìš©)
Â  Â  Â  Â  var dynMult = 1.0;
Â  Â  Â  Â  if (typeof util_getDynamicRateMultiplier === 'function') {
Â  Â  Â  Â  Â  Â  dynMult = util_getDynamicRateMultiplier(targetRoomName);
Â  Â  Â  Â  }

        // 3. ì‹œì¥ ìƒí™© í…ìŠ¤íŠ¸ íŒë³„
        var marketStatus = "ğŸŸ¢ ê²½ì œ ì•ˆì •";
        if (dynMult > 1.2) marketStatus = "ğŸš¨ êµ­ê³  ìœ„ê¸° (ê³ ê¸ˆë¦¬)";
        else if (dynMult < 0.8) marketStatus = "âœ… ìœ ë™ì„± í’ë¶€ (ì €ê¸ˆë¦¬)";

        // 4. ìµœì¢… ë©”ì‹œì§€ ì¡°ë¦½ (ì¤‘ë³µ ë£¨í”„ ì œê±°)
        var creditPolicy = "\n\n[ğŸ“Š ì‹ ìš© ë³€ë™ ìˆ˜ì¹˜]\n" +
                           "â€¢ ëŒ€ì¶œì‹¤í–‰: -100ì  | ìƒí™˜: +80ì \n" +
                           "â€¢ ëŒ€í™˜ì§‘í–‰: -120ì  | íšŒë³µì œ: +20ì \n" +
                           "â€¢ ê¸°ë¶€: 10,000Pë‹¹ +10ì \n\n" +
                           "[ğŸš¢ ë“±ê¸‰ë³„ ë¬´ì—­ ìˆ˜ìµ ë°°ìœ¨]\n" +
                           "â€¢ 1ë“±ê¸‰: 90% | 2ë“±ê¸‰: 85% | 3ë“±ê¸‰: 80%\n" +
                           "â€¢ 4ë“±ê¸‰: 75% | 5ë“±ê¸‰: 70% | ì‹ ë¶ˆì: 60%";

        var header = "ğŸŒ ì‹œì¥ ìƒí™©: " + marketStatus + " (x" + dynMult.toFixed(2) + ")\n\n" +
                     limitTable + 
                     creditPolicy;

        var myAppliedRate = ((cr.rate - 1) * 100 * dynMult).toFixed(1);
        var myCredit = "\n\n[ë‚´ ì‹¤ì‹œê°„ ì ìš© ìƒíƒœ]\n" +
                       "â€¢ ì‹ ìš©ì ìˆ˜: " + user.creditScore + "ì  (" + cr.label + ")\n" +
                       "â€¢ ì ìš©ì´ìœ¨: " + myAppliedRate + "%\n" +
                       "â€¢ ê°€ëŠ¥ì•¡ìˆ˜: " + fp(cr.limit) + "P";

        replier.reply(formatCommand("ğŸ’³ ì‹ ìš© ë“±ê¸‰ ë° ì‹¤ì‹œê°„ í•œë„", user, header + myCredit, "ëŒ€ì¶œ ì‹¤í–‰: [/ì€í–‰]"));
        return true;
    }

    /* [ê¸°ëŠ¥ 5] ëª…ì˜ˆì˜ ì „ë‹¹ */
    if (msg === "/ëª…ì˜ˆì˜ì „ë‹¹") {
        var challengers = [];
        var roomUsers = roomData.users;
        for (var id in roomUsers) {
            var u = roomUsers[id];
            if (u && u.tier === 9) {
                var count = Math.max(1, u.challengerCount || 0);
                challengers.push("ğŸ† " + u.name + " (ëˆ„ì  " + count + "íšŒ)");
            }
        }
        var content = challengers.length > 0 ? challengers.join("\n") : "í˜„ì¬ ì´ ë°©ì— ë“±ë¡ëœ ì±Œë¦°ì €ê°€ ì—†ìŠµë‹ˆë‹¤.";
        replier.reply(formatSimple("ğŸ… ëª…ì˜ˆì˜ ì „ë‹¹", content, "ìµœê³  í‹°ì–´ ë‹¬ì„± ì‹œ ë“±ë¡ë©ë‹ˆë‹¤."));
        return true;
    }

    /* [ê¸°ëŠ¥ 5-1] ê³„ì • í™•ì¸ ë° ì—°ë™ */
    // [ê¸°ëŠ¥ 1] ë‚´ ê³ ìœ  ë³µêµ¬ ì½”ë“œ í™•ì¸
    if (msg === "/ì½”ë“œí™•ì¸") {
        var codeMsg = "ë‹¹ì‹ ì˜ ê³ ìœ  ë³µêµ¬ ì½”ë“œì…ë‹ˆë‹¤.\në‹‰ë„¤ì„ê³¼ í”„ì‚¬ë¥¼ ë™ì‹œì— ë°”ê¿€ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ë°˜ë“œì‹œ ë”°ë¡œ ì €ì¥í•´ë‘ì„¸ìš”.\n\nğŸ”‘ ì½”ë“œ: " + targetUid;
        replier.reply(formatCommand("ğŸ” ë³´ì•ˆ ë³µêµ¬ ì½”ë“œ", user, codeMsg, "ì—°ë™ ë°©ë²•: [/ê³„ì •ì—°ë™ ì½”ë“œ]"));
        return true;
    }

    // [ê¸°ëŠ¥ 2] ê³„ì • ì—°ë™ ë° ë°ì´í„° ë³µêµ¬ (ì™„ì „ ê²°í•¨ ì œê±° ë²„ì „)
    if (msg.indexOf("/ê³„ì •ì—°ë™") === 0) {
        var parts = msg.split(" ");
        if (parts.length < 2) return replier.reply(formatError(user, "ì…ë ¥ ì˜¤ë¥˜", "/ê³„ì •ì—°ë™ [ë³µêµ¬ì½”ë“œ]"));

        var inputCode = parts[1].split("-").join("").toLowerCase().trim();
        var oldUser = null;

        // 1. ì „ì²´ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì†ŒìŠ¤ ê³„ì • íƒìƒ‰
        for (var rName in data.rooms) {
            var roomUsers = data.rooms[rName].users;
            for (var uid in roomUsers) {
                if (String(uid).split("-").join("").toLowerCase() === inputCode) {
                    oldUser = roomUsers[uid];
                    break;
                }
            }
            if (oldUser) break;
        }

        if (!oldUser) return replier.reply(formatError(user, "ë³µêµ¬ ì‹¤íŒ¨", "ì¼ì¹˜í•˜ëŠ” ì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        if (inputCode === String(targetUid).split("-").join("").toLowerCase()) return replier.reply(formatError(user, "ì‘ì—… ë¬´íš¨", "í˜„ì¬ ì ‘ì† ì¤‘ì¸ ì½”ë“œì™€ ë™ì¼í•©ë‹ˆë‹¤."));

        try {
            // 2. ë°ì´í„° ì •ë°€ ë³µì‚¬ (Deep Copy)
            // í˜„ì¬ ìœ ì €ì˜ ê³ ìœ  ID(targetUid)ì™€ ì´ë¦„ì€ ìœ ì§€í•œ ì±„ ì•Œë§¹ì´ë§Œ ê³¼ê±° ë°ì´í„°ë¡œ êµì²´
            var backupData = JSON.parse(JSON.stringify(oldUser));
            
            // í•„ìˆ˜ í•„ë“œ ì„ ë³„ ë³µì‚¬ (í˜„ì¬ ë‹‰ë„¤ì„ê³¼ ID ë³´ì¡´)
            var preservedName = user.name;
            var preservedHash = user.imageHash;

            // í•µì‹¬ ìì‚° ë° ìŠ¤íƒ¯ ë®ì–´ì“°ê¸°
            var fields = [
                'point', 'bank', 'tier', 'creditScore', 'totalAttendance', 'loan', 
                'inventory', 'collectedIcons', 'stockHoldings', 'stockAvg', 
                'artifactPieces', 'totalGambleCount', 'totalGambleWins', 'totalTheftSuccess',
                'totalInvestAmount', 'totalMiningTime', 'totalDonation', 'boxFragments', 'boxTickets'
            ];

            fields.forEach(function(f) {
                if (backupData[f] !== undefined) user[f] = backupData[f];
            });

            user.name = preservedName;
            user.imageHash = preservedHash;

            safeSaveData(data);
            
            var resBody = "ê³¼ê±° ìì‚° ì •ë³´ë¥¼ í˜„ì¬ ê³„ì •ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ë³µì‚¬í•´ì™”ìŠµë‹ˆë‹¤.\n\n" +
                         "ğŸ’° ë³µì œ ì”ì•¡: " + fp(user.point) + "P\n" +
                         "ğŸ… ë³µì œ í‹°ì–´: " + (TIERS[user.tier] || "ì•„ì´ì–¸") + "\n" +
                         "ğŸ“¦ ì¸ë²¤í† ë¦¬: " + (user.inventory ? user.inventory.length : 0) + "ê°œ í•­ëª© ì´ê´€";

            replier.reply(formatCommand("âœ… ë°ì´í„° ì •ë°€ ë³µì œ ì™„ë£Œ", user, resBody, "ê³ ìœ  ì½”ë“œëŠ” í˜„ì¬ ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ìœ ì§€í•©ë‹ˆë‹¤."));
        } catch (e) {
            replier.reply(formatError(user, "ì‹œìŠ¤í…œ ì˜¤ë¥˜", "ë³µì œ ì¤‘ ê¸°ìˆ ì  ê²°í•¨ ë°œìƒ: " + e));
        }
        return true;
    }

    /* [ê¸°ëŠ¥ 6] ìì‚° ìˆœìœ„ */
    if (msg === "/ì¶œì„ìˆœìœ„") {
        var users = [];
        var roomUsers = roomData.users;
        for (var id in roomUsers) {
            var u = roomUsers[id];
            var netWorth = util_calculateNetWorth(u, roomData);
            if (netWorth >= 1) users.push({ data: u, total: netWorth });
        }
        users.sort(function(a, b) { return b.total - a.total; });
        var rankList = [];
        for (var i = 0; i < Math.min(10, users.length); i++) {
            rankList.push((i + 1) + ". " + getDisplayName(users[i].data) + " (" + fp(users[i].total) + "P)");
        }
        var rankMsg = (rankList.length > 0 ? rankList.join("\n") : "ìˆœìœ„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        replier.reply(formatSimple("ìì‚° ë­í‚¹ (ì‹¤ì§ˆ ìˆœìì‚° ê¸°ì¤€)", rankMsg, "ë‚´ ì •ë³´: [/ë‚´ì •ë³´]"));
        return true;
    }

    /* [ê¸°ëŠ¥ 7] ìœ ì € ì •ë³´ ìƒì„¸ ì¡°íšŒ */
    if (msg.indexOf("/ìœ ì €ì •ë³´") === 0) {
        var tn = msg.substring(5).trim(); 
        if (tn === "") {
            replier.reply(formatError(user, "ì…ë ¥ ì˜¤ë¥˜", "ì¡°íšŒí•  ìœ ì €ì˜ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”."));
            return true;
        }
        var found = findUserByName(roomData, tn);
        if (found.length === 0) { 
            replier.reply(formatError(user, "ëŒ€ìƒ ì—†ìŒ", "[" + tn + "]ë‹˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); 
            return true; 
        }
        if (found.length === 1) {
            var targetUser = found[0].data;
            var targetIdInside = found[0].id;
            var cr = getCreditInfo(targetUser.creditScore);
            
            var sDebt = 0;
            var sClaims = 0;
            if (roomData.loanContracts) {
                for (var cid in roomData.loanContracts) {
                    var c = roomData.loanContracts[cid];
                    if (c.borrowerUid === targetIdInside) sDebt += Math.floor(c.currentDebt);
                    if (c.lenderUid === targetIdInside) sClaims += Math.floor(c.currentDebt);
                }
            }

            var info = "ğŸ’° í¬ì¸íŠ¸: " + fp(targetUser.point) + "P\n" +
                       "ğŸ¦ ì˜ˆê¸ˆ: " + fp(targetUser.bank) + "P\n" +
                       (sClaims >= 1 ? "ğŸ¤ ë¯¸ìˆ˜ ì±„ê¶Œ: " + fp(sClaims) + "P\n" : "") +
                       "ğŸ’³ ì‹ ìš©: " + cr.label + " (" + targetUser.creditScore + "ì )\n" +
                       "ğŸ… í‹°ì–´: " + (TIERS[targetUser.tier] || "ì•„ì´ì–¸") + "\n" +
                       "ğŸ“… ì¶œì„: " + (targetUser.totalAttendance || 0) + "ì¼";
            
            var bDebt = (targetUser.loan && targetUser.loan.debt) ? Math.floor(Number(targetUser.loan.debt)) : 0;
            if (bDebt > 0) info += "\nğŸ¦ ë¯¸ìƒí™˜ ëŒ€ì¶œ: " + fp(bDebt) + "P";
            if (sDebt > 0) info += "\nğŸš¬ ë¯¸ìƒí™˜ ì‚¬ì±„: " + fp(sDebt) + "P";

            replier.reply(formatCommand("ğŸ” ìœ ì € ìƒì„¸ ì •ë³´", targetUser, info, null));
        } else {
            handleUserSelection(replier, targetUid, found, "info", null, user, roomName);
        }
        return true;
    }

    return false;
}

//==========ì„¹í„°40==========

/**
 * [ê²Œì„ í•˜ìœ„ ëª¨ë“ˆ 3] ì•¡ì…˜ ë° ë„ë°• í†µí•© ë¶„ë°°ê¸°
 * ì„¤ëª…: ì„¹í„° 39(ì „ì²´ ë¶„ë°°ê¸°)ë¡œë¶€í„° í˜¸ì¶œë°›ì•„, ì‹¤ì œ ì„¸ë¶€ ë¡œì§(42-1 ~ 42-3)ìœ¼ë¡œ ì—°ê²°í•©ë‹ˆë‹¤.
 * ì´ êµ¬ì¡°ë¥¼ í†µí•´ ê° ê¸°ëŠ¥ë³„ë¡œ ë…ë¦½ì ì¸ ìˆ˜ì • ë° ê´€ë¦¬ê°€ ê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤.
 */
function _gameActionLogic(msg, user, data, replier, roomName, targetUid) {
    var cmd = msg.split(" ")[0]; // ëª…ë ¹ì–´ ì²« ë‹¨ì–´ ì¶”ì¶œ
    
    // 1. í™€ì§, ìŠ¹ê¸‰, ê²½ë§ˆ ê´€ë ¨ ë¡œì§ (ì„¹í„° 40 ìœ„ì„)
    // [ìˆ˜ì •]: /ë°°íŒ… ë° ë°°íŒ…ì·¨ì†Œ ì¡°ê±´ì„ ì¶”ê°€í•˜ì—¬ Part1 í•¨ìˆ˜ê°€ ì‹¤í–‰ë  ìˆ˜ ìˆë„ë¡ ì…êµ¬ë¥¼ ê°œë°©í•¨
    if (cmd === "/í™€ì§" || cmd === "/ìŠ¹ê¸‰" || cmd === "/ë°°íŒ…" || cmd === "ë°°íŒ…ì·¨ì†Œ") {
        return _gameActionLogic_Part1(msg, user, data, replier, roomName, targetUid);
    }
    
    // 2. ê²°íˆ¬ ë¡œì§ (ì„¹í„° 41 ìœ„ì„)
    if (cmd === "/ê²°íˆ¬" || cmd === "ìˆ˜ë½" || cmd === "ê±°ì ˆ" || cmd === "ì·¨ì†Œ") {
        return _gameActionLogic_Part2(msg, user, data, replier, roomName, targetUid);
    }
    
    // 3. ë„ë‘‘ì§ˆ ë° ì¤ê¸° ë¡œì§ (ì„¹í„° 42 ìœ„ì„)
    if (cmd === "/ë„ë‘‘ì§ˆ" || cmd === "ì¡ì•˜ë‹¤ìš”ë†ˆ" || cmd === "ì¤ê¸°") {
        return _gameActionLogic_Part3(msg, user, data, replier, roomName, targetUid);
    }
    
    return false; // í•´ë‹¹ë˜ëŠ” ëª…ë ¹ì–´ê°€ ì—†ìŒ
}

//==========ì„¹í„°41==========

/**
 * [ê²Œì„ í•˜ìœ„ ëª¨ë“ˆ 3-1] ì•¡ì…˜ ë° ë„ë°• ê²Œì„ (í™€ì§ & ìŠ¹ê¸‰ & ê²½ë§ˆ ì•¡ì…˜)
 * v5.9: í†µí•© ì—”ì§„(7, 9, 11) ì—°ê²° ì™„ë£Œ
 */
function _gameActionLogic_Part1(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];
    if (!roomData) return false;

    var racingData = roomData.features.racing;

    var rConf = SYSTEM_CONFIG.ECO.RACING; 

    /* [ì—°ê²°] 1. ê²½ë§ˆ ë°°íŒ… ì•¡ì…˜ (/ë°°íŒ… [ë²ˆí˜¸] [ê¸ˆì•¡]) */
    if (msg.indexOf("/ë°°íŒ… ") === 0) {
        if (util_isBankruptcy(roomName)) {
            replier.reply(formatError(user, "ì‹œìŠ¤í…œ ë™ê²°", "êµ­ê°€ ë¶€ë„ ì„ í¬ ìƒíƒœì—ì„œëŠ” ê²½ë§ˆ ë°°íŒ…ì´ ê¸ˆì§€ë©ë‹ˆë‹¤.\n(íšŒë³µ ê¸°ì¤€: êµ­ê³  50%)"));
            return true;
        }
        if (!racingData.isOperating) {
            replier.reply(formatError(user, "ê²½ë§ˆì¥ íœ´ì¥", "í˜„ì¬ ìš´ì˜ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤. (09:00 ~ 23:59)"));
            return true;
        }

        var nowMin = new Date().getMinutes();
        if (nowMin >= 50) {
            replier.reply(formatError(user, "ë°°íŒ… ë§ˆê°", "í˜„ì¬ ì œ " + racingData.round + "íšŒì°¨ ê²½ê¸°ê°€ ë§ˆê°ë˜ì–´ ì •ì‚° ì¤‘ì…ë‹ˆë‹¤."));
            return true;
        }

        // [ì—”ì§„ ì—°ê²°] í†µí•© ìƒíƒœ ê°€ë“œ ì²´í¬ (ì§•ì—­/ê´‘ì‚° ë“±)
        var stateRes = util_checkUserState(user, targetUid);
        if (!stateRes.canAction) {
            replier.reply(formatError(user, "ë°°íŒ… ë¶ˆê°€", stateRes.reason));
            return true;
        }

        var ps = msg.trim().split(/\s+/);
        if (ps.length < 3) { 
            replier.reply(formatError(user, "í˜•ì‹ ì˜¤ë¥˜", "/ë°°íŒ… [ë§ë²ˆí˜¸] [ê¸ˆì•¡]")); 
            return true; 
        }
        
        var hId = parseInt(ps[1]);
        var betAmt = parseInt(ps[2].replace(/,/g, ""));

        if (isNaN(hId) || hId < 1 || hId > racingData.horses.length) {
            replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "1~" + racingData.horses.length + "ë²ˆ ì‚¬ì´ì˜ ë§ì„ ì„ íƒí•˜ì„¸ìš”."));
            return true;
        }

        // [ì—”ì§„ ì—°ê²°] ë¬¼ê°€ ë°°ìœ¨ ì—”ì§„ ì ìš©
        var minLimit = rConf.MIN_BET; 
        var maxLimit = rConf.MAX_BET;

        if (isNaN(betAmt) || betAmt < minLimit) {
            replier.reply(formatError(user, "ê¸ˆì•¡ ë¯¸ë‹¬", "ìµœì†Œ " + fp(minLimit) + "P ì´ìƒ ë°°íŒ…í•´ì•¼ í•©ë‹ˆë‹¤."));
            return true;
        }
        if (betAmt > maxLimit) {
            replier.reply(formatError(user, "í•œë„ ì´ˆê³¼", "ìµœëŒ€ " + fp(maxLimit) + "Pê¹Œì§€ ë°°íŒ… ê°€ëŠ¥í•©ë‹ˆë‹¤."));
            return true;
        }
        if (Number(user.point) < betAmt) {
            replier.reply(formatError(user, "í¬ì¸íŠ¸ ë¶€ì¡±", "ë³´ìœ  í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."));
            return true;
        }

        if (racingData.bets[targetUid]) {
            replier.reply(formatError(user, "ì¤‘ë³µ ë°°íŒ… ë¶ˆê°€", "ì´ë¯¸ ë°°íŒ…í•˜ì…¨ìŠµë‹ˆë‹¤. [ë°°íŒ…ì·¨ì†Œ] í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."));
            return true;
        }

        // [ì—”ì§„ ì—°ê²°] ê²Œì´íŠ¸ì›¨ì´ë¥¼ í†µí•œ ì•ˆì „ ì°¨ê° ë° êµ­ê³  ì…ê³ 
        util_updatePoint(user, roomData, -betAmt, "ê²½ë§ˆ ë°°íŒ…", roomName);
        
        var selectedHorse = racingData.horses[hId - 1];
        racingData.bets[targetUid] = { uid: targetUid, horseId: hId, amount: betAmt, name: user.name };
        racingData.totalPool += betAmt;

        // [v11.0] ì¤‘ì•™ê²½ë§ˆì¥ ìµœëŒ€ì£¼ì£¼ ë°°ë‹¹ì„ ìœ„í•œ ì¼ì¼ ë°°íŒ…ê¸ˆì•¡ ëˆ„ì 
        if (roomData.features.dailyPools) {
            var accumRate = SYSTEM_CONFIG.ECO.ACTIVITY_ACCUM_RATES.RACING || 0.02;
            roomData.features.dailyPools.race += Math.floor(betAmt * accumRate);
        }

        var betSuccessContent = "ğŸ‡ ì„ íƒ: " + selectedHorse.id + "ë²ˆ " + selectedHorse.name + "\nğŸ’° ê¸ˆì•¡: " + fp(betAmt) + "P ë°°íŒ… ì„±ê³µ!";

        if (Math.random() < 0.1) { // 10% í™•ë¥ 
            var allParts = ["ì•ˆì¥", "ë“±ì", "ê³ ì‚", "ì±„ì°"];
            if (!user.horseParts) user.horseParts = [];
            var missingParts = allParts.filter(function(p) { return user.horseParts.indexOf(p) === -1; });
            
            if (missingParts.length > 0) {
                var newPart = missingParts[Math.floor(Math.random() * missingParts.length)];
                user.horseParts.push(newPart);
                betSuccessContent += "\n\n ğŸ ê²½ë§ˆì¥ì„ ì§€ë‚˜ë‹¤ '" + newPart + "'ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤!\n(ë³´ìœ  ì•„ì´í…œ: " + user.horseParts.join(", ") + " / ë‚¨ì€ ë¶€í’ˆ: " + (missingParts.length - 1) + "ê°œ)";
                
                if (user.horseParts.length === 4) {
                    betSuccessContent += "\n\n ğŸ ëª¨ë“  ì¥ë¹„ê°€ ê°–ì¶°ì ¸ [ê²½ë§ˆì™•] ìê²©ì„ ì–»ì—ˆìŠµë‹ˆë‹¤!";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  util_checkAndAwardTitle(user, replier, "ê²½ë§ˆì™•", 777, "ğŸ‡", "ë‚´ë¦¬ë‹¤ ê²½ë§ˆ í˜‘íšŒ", "ê²½ë§ˆ ì¥ë¹„ 4ì¢… ìˆ˜ì§‘", "[ì¥ì°© íš¨ê³¼]: ê²½ë§ˆ ë°°íŒ… ì·¨ì†Œ ì‹œ ë°œìƒí•˜ëŠ” ìœ„ì•½ê¸ˆ(10%)ì´ ì „ì•¡ ë©´ì œë©ë‹ˆë‹¤.", roomName);
                }
            }
        }

        replier.reply(formatCommand("âœ… [ê²½ë§ˆ ë°°íŒ… ì™„ë£Œ]", user, betSuccessContent, "ğŸ‡ ì„ íƒ: " + selectedHorse.id + "ë²ˆ " + selectedHorse.name + "\nğŸ’° ê¸ˆì•¡: " + fp(betAmt) + "P ë°°íŒ… ì„±ê³µ!", "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
        safeSaveData(data);
        return true;
    }

    /* [ì—°ê²°] 2. ê²½ë§ˆ ë°°íŒ… ì·¨ì†Œ (ë°°íŒ…ì·¨ì†Œ) */
    if (msg === "ë°°íŒ…ì·¨ì†Œ") {
        if (!racingData.isOperating) return false;
        var nowMin = new Date().getMinutes();
        if (nowMin >= 50) {
            replier.reply(formatError(user, "ì·¨ì†Œ ë¶ˆê°€", "ì •ì‚° ì¤‘ì—ëŠ” ì·¨ì†Œê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤."));
            return true;
        }

        var myBet = racingData.bets[targetUid];
        if (!myBet) {
            replier.reply(formatError(user, "ë‚´ì—­ ì—†ìŒ", "ì´ë²ˆ íšŒì°¨ ë°°íŒ… ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤."));
            return true;
        }

       var isOwner = (user.title === "ê²½ë§ˆì™•");
        var feeRate = isOwner ? 0 : rConf.CANCEL_FEE;
        var fee = Math.floor(myBet.amount * feeRate);
        var refund = myBet.amount - fee;

        var cancelMsg = "ê²½ë§ˆ ë°°íŒ…ì„ ì² íšŒí–ˆìŠµë‹ˆë‹¤.\n\nğŸ’° ì›ë˜ ë°°íŒ…ê¸ˆ: " + fp(myBet.amount) + "P\n";
        if (isOwner) {
            cancelMsg += "ğŸ‘‘ [ê²½ë§ˆì™•] ì¹­í˜¸ íš¨ê³¼ ì ìš©!\nâš–ï¸ ì·¨ì†Œ ìœ„ì•½ê¸ˆ: 0P (ì „ì•¡ ë©´ì œ)\n";
        } else {
            cancelMsg += "âš–ï¸ ì·¨ì†Œ ìœ„ì•½ê¸ˆ(10%): -" + fp(fee) + "P\n";
        }
        cancelMsg += "ğŸ ìµœì¢… í™˜ë¶ˆì•¡: " + fp(refund) + "P";

        // [ì—”ì§„ ì—°ê²°] ê²Œì´íŠ¸ì›¨ì´ë¥¼ í†µí•œ í™˜ë¶ˆ (ìˆ˜ìˆ˜ë£Œ ì œì™¸)
        util_updatePoint(user, roomData, refund, "ê²½ë§ˆ ë°°íŒ… ì·¨ì†Œ", roomName);
        
        racingData.totalPool -= myBet.amount;

        // [v11.0] ë°°íŒ… ì·¨ì†Œ ì‹œ ì¼ì¼ ëˆ„ì  ê¸ˆì•¡ì—ì„œ ì°¨ê° (ì‹¤ì œ ìœ íš¨ ë°°íŒ…ì•¡ ë°˜ì˜)
        if (roomData.features.dailyPools) {
            roomData.features.dailyPools.race -= myBet.amount;
        }

        delete racingData.bets[targetUid];

        var cancelMsg = "ê²½ë§ˆ ë°°íŒ…ì„ ì² íšŒí–ˆìŠµë‹ˆë‹¤.\n\nğŸ’° ì›ë˜ ë°°íŒ…ê¸ˆ: " + fp(myBet.amount) + "P\nâš–ï¸ ì·¨ì†Œ ìœ„ì•½ê¸ˆ(10%): -" + fp(fee) + "P\nğŸ ìµœì¢… í™˜ë¶ˆì•¡: " + fp(refund) + "P";
        replier.reply(formatCommand("ğŸš« ë°°íŒ… ì·¨ì†Œ ì™„ë£Œ", user, cancelMsg, "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
        safeSaveData(data);
        return true;
    }

    /* [ì—°ê²°] 3. í™€ì§ ì‹œìŠ¤í…œ í†µí•© ì•ˆë‚´ (/í™€ì§) */
    /**
     * ì„¤ëª…: ê¸°ì¡´ í™€ì§ ì‹œìŠ¤í…œì„ íê¸°í•˜ê³  í†µí•© ì¹´ì§€ë…¸(/ì¹´ì§€ë…¸)ë¡œ ìœ ë„í•©ë‹ˆë‹¤.
     */
    if (msg.indexOf("/í™€ì§") === 0) {
        var notice = "ê¸°ì¡´ í™€ì§ ë„ë°• ì‹œìŠ¤í…œì´ [ë‚´ë¦¬ë‹¤ ì¤‘ì•™ ì¹´ì§€ë…¸]ë¡œ í†µí•©ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n" +
                     "ğŸªœ ì‚¬ë‹¤ë¦¬ (ë‹¨ì¼ 1.9ë°° / ì¡°í•© 4.0ë°°)\n" +
                     "ğŸƒ ë°”ì¹´ë¼ (P 2.0ë°° / B 1.95ë°° / T 8.0ë°°)\n\n" +
                     "ë”ìš± ì •êµí•´ì§„ ì‹œìŠ¤í…œì—ì„œ ì‹¤ì‹œê°„ ë°°íŒ…ì„ ì¦ê²¨ë³´ì„¸ìš”!";
        
        replier.reply(formatCommand("ğŸŒ“ ì‹œìŠ¤í…œ í†µí•© ì•ˆë‚´", user, notice, "ëª…ë ¹ì–´: [/ì¹´ì§€ë…¸]"));
        return true;
    }

    /* [ê¸°ì¡´ ë¡œì§ ìœ ì§€] 4. í‹°ì–´ ìŠ¹ê¸‰ (/ìŠ¹ê¸‰) */
    if (msg === "/ìŠ¹ê¸‰") {
        var totalAttempts = Number(user.dailyPromotionAttempts || 0) + Number(user.purchasedPromotionAttempts || 0);
        if (totalAttempts <= 0) { replier.reply(formatError(user, "ê¸°íšŒ ì—†ìŒ", "ìƒì ì—ì„œ ìŠ¹ê¸‰ê¶Œì„ êµ¬ë§¤í•˜ì„¸ìš”.")); return true; }
        if (user.tier >= 9) { replier.reply(formatError(user, "ìµœê³  ë“±ê¸‰", "ì´ë¯¸ ì±Œë¦°ì € ë“±ê¸‰ì…ë‹ˆë‹¤.")); return true; }

        var usedDaily = false;
        if (Number(user.dailyPromotionAttempts) > 0) { 
            util_setData(user, 'dailyPromotionAttempts', user.dailyPromotionAttempts - 1, "ì¼ì¼ ìŠ¹ê¸‰ ê¸°íšŒ ì°¨ê°", roomName);
            usedDaily = true; 
        }
        else { 
            util_setData(user, 'purchasedPromotionAttempts', user.purchasedPromotionAttempts - 1, "êµ¬ë§¤ ìŠ¹ê¸‰ê¶Œ ì°¨ê°", roomName);
        }

        var prob = TIER_PROBS[user.tier] || { up: 50, stay: 40, down: 10 };
        var rand = Math.random() * 100;
        var isSundayFever = (new Date().getDay() === 0);
        if (isSundayFever) rand -= 5; 

        startTracking(user, "ìŠ¹ê¸‰ ë„ì „");

        if (rand < prob.up) { 
            // 1. ì°¨ì„¸ëŒ€ í‹°ì–´ ê³„ì‚° ë° ê²Œì´íŠ¸ì›¨ì´ ê²€ì¦
            var nextTier = Number(user.tier || 0) + 1;
            util_setData(user, 'tier', nextTier, "ìŠ¹ê¸‰ ì„±ê³µ", roomName);

            var successBody = "í‹°ì–´: [" + TIERS[nextTier] + "]\n\n";
            
            if (nextTier === 9) { // ì±Œë¦°ì € ë„ë‹¬ íŒì •
                // ì±Œë¦°ì € íšŸìˆ˜ í†µê³„ë„ ê²Œì´íŠ¸ì›¨ì´ë¡œ ë³´í˜¸
                util_setData(user, 'challengerCount', (user.challengerCount || 0) + 1, "ì±Œë¦°ì € ë‹¬ì„±", roomName);
                user.challengerIconSeason = getSimpleSeason();
                successBody += "ğŸŠ ì¶•í•˜í•©ë‹ˆë‹¤! ì±Œë¦°ì € ë“±ê¸‰ ë„ë‹¬! ëª…ì˜ˆì˜ ì „ë‹¹ì— ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.";
            } else {
                // ìŠ¹ê¸‰ ì„±ê³µ ë³´ë„ˆìŠ¤ ê¸°íšŒ ì¦ê°€ë„ ê²Œì´íŠ¸ì›¨ì´ë¡œ ë³´í˜¸
                if (usedDaily) {
                    util_setData(user, 'dailyPromotionAttempts', (user.dailyPromotionAttempts || 0) + 1, "ìŠ¹ê¸‰ ì„±ê³µ ë³´ë„ˆìŠ¤", roomName);
                } else {
                    util_setData(user, 'purchasedPromotionAttempts', (user.purchasedPromotionAttempts || 0) + 1, "ìŠ¹ê¸‰ ì„±ê³µ ë³´ë„ˆìŠ¤", roomName);
                }
                successBody += "ğŸ‰ ìŠ¹ê¸‰ ì„±ê³µ ë³´ë„ˆìŠ¤: ì¬ë„ì „ ê¸°íšŒ ìœ ì§€!";
            }
            replier.reply(formatCommand("ğŸŠ ìŠ¹ê¸‰ ì„±ê³µ!", user, successBody, "ë‚¨ì€ ê¸°íšŒ: " + (Number(user.dailyPromotionAttempts) + Number(user.purchasedPromotionAttempts)) + "íšŒ"));
            endTracking(user, true, "ìŠ¹ê¸‰ ì„±ê³µ");
        } else if (rand > (100 - prob.down)) {
            if (Number(user.tierGuard || 0) > 0) {
                util_setData(user, 'tierGuard', user.tierGuard - 1, "ê°•ë“± ë°©ì–´ê¶Œ ì‚¬ìš©", roomName);
                replier.reply(formatCommand("ğŸ›¡ï¸ ê°•ë“± ë°©ì–´", user, "í‹°ì–´: [" + TIERS[user.tier] + "] ìœ ì§€\në°©ì–´ê¶Œì„ ì‚¬ìš©í•˜ì—¬ ë³´í˜¸í–ˆìŠµë‹ˆë‹¤.", "ë‚¨ì€ ë°©ì–´ê¶Œ: " + user.tierGuard + "ê°œ"));
                endTracking(user, true, "ê°•ë“± ë°©ì–´");
            } else {
                util_setData(user, 'tier', Math.max(0, user.tier - 1), "ìŠ¹ê¸‰ ì‹¤íŒ¨ ê°•ë“±", roomName);
                replier.reply(formatCommand("ğŸ“‰ ê°•ë“± ë°œìƒ", user, "í‹°ì–´: [" + TIERS[user.tier] + "]\nìƒíƒœ: í‹°ì–´ê°€ í•˜ë½í–ˆìŠµë‹ˆë‹¤.", "ë‚¨ì€ ê¸°íšŒ: " + (Number(user.dailyPromotionAttempts) + Number(user.purchasedPromotionAttempts)) + "íšŒ"));
                endTracking(user, false, "ê°•ë“± ë°œìƒ");
            }
        } else {
            replier.reply(formatCommand("ğŸ˜ ìŠ¹ê¸‰ ì‹¤íŒ¨", user, "í‹°ì–´: [" + TIERS[user.tier] + "] ìœ ì§€\nìƒíƒœ: ìŠ¹ê¸‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "ë‚¨ì€ ê¸°íšŒ: " + (Number(user.dailyPromotionAttempts) + Number(user.purchasedPromotionAttempts)) + "íšŒ"));
            endTracking(user, false, "ìŠ¹ê¸‰ ì‹¤íŒ¨");
        }
        safeSaveData(data);
        return true;
    }

    return false;
}

//==========ì„¹í„°42==========

/**
 * [ê²Œì„ í•˜ìœ„ ëª¨ë“ˆ 3-2] ì•¡ì…˜ ë° ë„ë°• ê²Œì„ (ê²°íˆ¬ ì‹œìŠ¤í…œ)
 */
function _gameActionLogic_Part2(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];
    if (!roomData || !roomData.features) return false;

    // [ìƒíƒœ ë¡œì»¬ë¼ì´ì§•] ë°©ë³„ ë…ë¦½ ê²°íˆ¬ ë°ì´í„° ì°¸ì¡°
    var duelData = roomData.features.states.duelData;

    /* [ê¸°ëŠ¥ 11] ê²°íˆ¬ ì‹ ì²­ */
    if (msg.indexOf("/ê²°íˆ¬ ") === 0) {
        if (data.gambleLimit) { replier.reply(formatError(user, "ë„ë°• ì œí•œ", "í˜„ì¬ ë„ë°• ê¸°ëŠ¥ì´ ì œí•œë˜ì–´ ìˆìŠµë‹ˆë‹¤.")); return true; }
        var myState = util_checkUserState(user, targetUid);
        if (!myState.canAction) { replier.reply(formatError(user, "ê²°íˆ¬ ë¶ˆê°€", myState.reason)); return true; }
        var parts = msg.trim().split(/\s+/);
        if (parts.length < 3) { replier.reply(formatError(user, "í˜•ì‹ ì˜¤ë¥˜", "/ê²°íˆ¬ [ë‹‰ë„¤ì„] [ê¸ˆì•¡]")); return true; }
        var am = parseInt(parts.pop().replace(/,/g, ""));
        var tn = parts.slice(1).join(" ").trim();

        var minBet = Math.floor(100 * util_getEcoMultiplier(roomName));

        if (isNaN(am) || am < minBet) { replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜", "ìµœì†Œ " + fp(minBet) + "P ì´ìƒ ê²°íˆ¬ ê°€ëŠ¥í•©ë‹ˆë‹¤.")); return true; }
        if (Number(user.point) < am) { replier.reply(formatError(user, "í¬ì¸íŠ¸ ë¶€ì¡±", "ë² íŒ…í•  í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.")); return true; }
        
        var found = findUserByName(roomData, tn);
        if (found.length === 0) { replier.reply(formatError(user, "ëŒ€ìƒ ì—†ìŒ", "[" + tn + "]ë‹˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (found.length > 1) { handleUserSelection(replier, targetUid, found, "duel", { bet: am }, user, roomName); return true; }
        var target = found[0];
        if (target.id === targetUid) { replier.reply(formatError(user, "ê²°íˆ¬ ë¶ˆê°€", "ìì‹ ê³¼ëŠ” ì‹¸ìš¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (isUserBusy(target.id)) { replier.reply(formatError(user, "ëŒ€ìƒ í™œë™ ì¤‘", "ìƒëŒ€ë°©ì´ í˜„ì¬ ë‹¤ë¥¸ í™œë™ì„ í•˜ê³  ìˆìŠµë‹ˆë‹¤.")); return true; }

        util_updatePoint(user, roomData, -am, "ê²°íˆ¬ ì‹ ì²­ ë² íŒ…", roomName);

        duelData[target.id] = { challengerUid: targetUid, point: am, expire: Date.now() + 30000, room: roomName };
        replier.reply(formatCommand("âš”ï¸ ê²°íˆ¬ ì‹ ì²­", target.data, getDisplayName(user) + "ë‹˜ì´ " + fp(am) + "P ê²°íˆ¬ë¥¼ ì‹ ì²­í–ˆìŠµë‹ˆë‹¤!\n\nìŠ¹ë‚™í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ìˆ˜ë½/ê±°ì ˆ/ì·¨ì†Œ)", "ë‚´ ì”ì•¡: " + fP(user.point) + "P"));
        safeSaveData(data);
        return true;
    }

    /* [v5.9 ìˆ˜ì •] ê²°íˆ¬ ì·¨ì†Œ (ì‹ ì²­ìê°€ ì§ì ‘ ì² íšŒ) */
    if (msg === "ì·¨ì†Œ") {
        var cancelTargetId = null;
        // í˜„ì¬ ë°©ì˜ ê²°íˆ¬ ë°ì´í„° ì¤‘ ë‚´ê°€ ì‹ ì²­ìì¸ ê±´ì„ íƒìƒ‰
        for (var tid in duelData) {
            if (duelData[tid].challengerUid === targetUid) {
                cancelTargetId = tid;
                break;
            }
        }

        if (cancelTargetId) {
            var d = duelData[cancelTargetId];
            // [ì—”ì§„ ì—°ë™] ì‹ ì²­ìì—ê²Œ ë² íŒ…ê¸ˆ ì¦‰ì‹œ í™˜ê¸‰
            util_updatePoint(user, roomData, d.point, "ê²°íˆ¬ ì·¨ì†Œ í™˜ê¸‰", roomName);
            delete duelData[cancelTargetId];
            
            replier.reply(formatCommand("ğŸš« ê²°íˆ¬ ì·¨ì†Œ ì™„ë£Œ", user, "ê²°íˆ¬ ì‹ ì²­ì„ ì² íšŒí•˜ê³  ë² íŒ…ê¸ˆì„ ë°˜í™˜ë°›ì•˜ìŠµë‹ˆë‹¤.", "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
            safeSaveData(data);
            return true;
        }
    }

    /* [v5.9 ìˆ˜ì •] ê²°íˆ¬ ìˆ˜ë½ (ìƒëŒ€ë°©ì´ ìŠ¹ë‚™) */
    if (msg === "ìˆ˜ë½" && duelData[targetUid]) {
        if (data.gambleLimit) { replier.reply(formatError(user, "ë„ë°• ì œí•œ", "í˜„ì¬ ë„ë°• ê¸°ëŠ¥ì´ ì œí•œë˜ì–´ ìˆìŠµë‹ˆë‹¤.")); return true; }
        
        var d = duelData[targetUid];
        var challenger = roomData.users[d.challengerUid];
        if (!challenger) { delete duelData[targetUid]; return true; }

        // ìˆ˜ë½ìì˜ ê°€ìš© í¬ì¸íŠ¸ ì²´í¬
        if (Number(user.point) < d.point) {
            util_updatePoint(challenger, roomData, d.point, "ìƒëŒ€ í¬ì¸íŠ¸ ë¶€ì¡± í™˜ê¸‰", roomName);
            delete duelData[targetUid];
            replier.reply(formatError(user, "í¬ì¸íŠ¸ ë¶€ì¡±", "ìˆ˜ë½í•˜ê¸° ìœ„í•œ í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•˜ì—¬ ê²°íˆ¬ê°€ ë¬´ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤."));
            return true;
        }

        // [ì—”ì§„ ì—°ë™] ìˆ˜ë½ì ë² íŒ…ê¸ˆ ì°¨ê°
        util_updatePoint(user, roomData, -d.point, "ê²°íˆ¬ ìˆ˜ë½ ë² íŒ…", roomName);

        // ìŠ¹íŒ¨ íŒì • (50:50)
        var isChallengerWin = Math.random() < 0.5;
        var winner = isChallengerWin ? challenger : user;
        var winnerId = isChallengerWin ? d.challengerUid : targetUid;
        var winPrize = d.point * 2;

        // [í•µì‹¬] ìƒí™˜ ì—”ì§„ í†µê³¼ í›„ ê²Œì´íŠ¸ì›¨ì´ë¡œ ìµœì¢… ìŠ¹ë¦¬ê¸ˆ ì§€ê¸‰
        var res = processRepayment(winner, winPrize, winnerId, roomName);
        util_updatePoint(winner, roomData, Number(res.actualGain), "ê²°íˆ¬ ìŠ¹ë¦¬ ë³´ìƒ", roomName);

        var resBody = "âš”ï¸ ê²°íˆ¬ ê²°ê³¼\n" + getDisplayName(challenger) + " VS " + getDisplayName(user) + "\n\nğŸ† ìŠ¹ì: " + getDisplayName(winner) + "\nğŸ’° íšë“: " + fp(winPrize) + "P" + (res.repayMsg || "");
        replier.reply(formatCommand("âš”ï¸ ê²°íˆ¬ ì¢…ë£Œ", winner, resBody, "ë‚´ ì”ì•¡: " + fp(winner.point) + "P"));
        
        delete duelData[targetUid];
        safeSaveData(data);
        return true;
    }

    /* [v5.9 ìˆ˜ì •] ê²°íˆ¬ ê±°ì ˆ (ìƒëŒ€ë°©ì´ ê±°ë¶€) */
    if (msg === "ê±°ì ˆ" && duelData[targetUid]) {
        var d = duelData[targetUid];
        var challenger = roomData.users[d.challengerUid];
        
        if (challenger) {
            // [ì—”ì§„ ì—°ë™] ì‹ ì²­ìì—ê²Œ ë² íŒ…ê¸ˆ ì•ˆì „ í™˜ê¸‰
            util_updatePoint(challenger, roomData, d.point, "ê²°íˆ¬ ê±°ì ˆ í™˜ê¸‰", roomName);
        }
        
        delete duelData[targetUid];
        replier.reply(formatCommand("ğŸš« ê²°íˆ¬ ê±°ì ˆ", user, "ê²°íˆ¬ ì‹ ì²­ì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.\nì‹ ì²­ìì—ê²Œ ë² íŒ…ê¸ˆì´ ë°˜í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.", "ë‹«ê¸°: [ì·¨ì†Œ]"));
        safeSaveData(data);
        return true;
    }
    return false;
}

//==========ì„¹í„°43==========

/**
 * [ê²Œì„ í•˜ìœ„ ëª¨ë“ˆ 3-3] ì•¡ì…˜ ë° ë„ë°• ê²Œì„ (ë„ë‘‘ì§ˆ & ì¤ê¸°)
 * ìˆ˜ì • ì‚¬í•­: ë²Œê¸ˆ ì´ì¤‘ ê°€ì‚° ë²„ê·¸ ìˆ˜ì • ë° ëª¨ë“  í¬ì¸íŠ¸ ë¡œì§ì— ë°© ê²©ë¦¬ ì‹ë³„ì(roomName) ì ìš©
 */
function _gameActionLogic_Part3(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];
    if (!roomData || !roomData.features) return false;

    // [ìƒíƒœ ë¡œì»¬ë¼ì´ì§•] ë°©ë³„ ë…ë¦½ ë¿Œë¦¬ê¸° ë° ë„ë‘‘ì§ˆ ìƒíƒœ ì°¸ì¡°
    var sprinkleData = roomData.features.sprinkleData;
    var activeThefts = roomData.features.states.activeThefts;

    /* [ê¸°ëŠ¥ 12] ë„ë‘‘ì§ˆ ì‹œë„ */
    if (msg.indexOf("/ë„ë‘‘ì§ˆ ") === 0) {
        if (data.gambleLimit) { replier.reply(formatError(user, "ë„ë°• ì œí•œ", "í˜„ì¬ ë„ë°• ê¸°ëŠ¥ì´ ì œí•œë˜ì–´ ìˆìŠµë‹ˆë‹¤.")); return true; }
        
        var myState = util_checkUserState(user, targetUid);
        if (!myState.canAction) {
            replier.reply(formatError(user, "ë„ë‘‘ì§ˆ ê¸ˆì§€", myState.reason));
            return true;
        }

        // 1. ë„ë‘‘ ê¸€ë¡œë²Œ ì¿¨íƒ€ì„ ì²´í¬ (1ì‹œê°„)
        var now = Date.now();
        if (now - (user.lastTheftActionTime || 0) < 3600000) {
            var remainMin = Math.ceil((3600000 - (now - user.lastTheftActionTime)) / 60000);
            replier.reply(formatError(user, "ì¿¨íƒ€ì„ ì œí•œ", "ë„ë‘‘ì§ˆ í›„ ì¬ì •ë¹„ ì‹œê°„ì´ í•„ìš”í•©ë‹ˆë‹¤.\n" + remainMin + "ë¶„ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."));
            return true;
        }

        var tn = msg.substring(5).trim();
        var found = findUserByName(roomData, tn);
        if (found.length === 0) { replier.reply(formatError(user, "ëŒ€ìƒ ì—†ìŒ", "[" + tn + "]ë‹˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (found.length > 1) { handleUserSelection(replier, targetUid, found, "theft", null, user, roomName); return true; }
        
        var victim = found[0];
        if (victim.id === targetUid) { replier.reply(formatError(user, "ê°•íƒˆ ë¶ˆê°€", "ìì‹ ì˜ ì§€ê°‘ì€ í„¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }

        // 2. í”¼í•´ì ì¡°ê±´ ì²´í¬: ìµœì†Œ ìì‚° 1ë§ŒP ì´ˆê³¼ & í”¼í•´ì ë³´í˜¸ 6ì‹œê°„ ì²´í¬
        if (Number(victim.data.point) <= 10000) { 
            replier.reply(formatError(user, "ê°•íƒˆ ëŒ€ìƒ ë¶€ì í•©", "ë³´ìœ  í¬ì¸íŠ¸ê°€ " + fp(10000) + "Pë¥¼ ì´ˆê³¼í•˜ëŠ” ìœ ì €ë§Œ í„¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")); 
            return true; 
        }
        if (now < (victim.data.lastTheftVictimTime || 0)) {
            var remainSec = Math.ceil((victim.data.lastTheftVictimTime - now) / 1000);
            var h = Math.floor(remainSec / 3600);
            var m = Math.ceil((remainSec % 3600) / 60);
            replier.reply(formatError(user, "ë³´í˜¸ ëŒ€ìƒ", "í•´ë‹¹ ìœ ì €ëŠ” ìµœê·¼ í”¼í•´ë¥¼ ì…ì–´ êµ­ê°€ì˜ ë³´í˜¸ë¥¼ ë°›ê³  ìˆìŠµë‹ˆë‹¤.\n(ë‚¨ì€ ì‹œê°„: " + h + "ì‹œê°„ " + m + "ë¶„)"));
            return true;
        }
        if (activeThefts[victim.id]) { replier.reply(formatError(user, "ì¤‘ë³µ ê°•íƒˆ ë¶ˆê°€", getDisplayName(victim.data) + "ë‹˜ì€ í˜„ì¬ ë‹¤ë¥¸ ë„ë‘‘ì´ ì‘ì—… ì¤‘ì…ë‹ˆë‹¤!")); return true; }

        // 3. ë„ë‘‘ì§ˆ í”„ë¡œì„¸ìŠ¤ ì„¤ì • (30ì´ˆ ë‹¨ì¶• ë° ëœë¤ íƒ€ì´ë¨¸)
        user.lastTheftActionTime = now; // ì¿¨íƒ€ì„ ì‹œì‘ ì‹œì  ê¸°ë¡
        
        // ì„±ê³µ íƒ€ì´ë¨¸: ì •í™•íˆ 30ì´ˆ (30000ms)
Â  Â  Â  Â  var successDelay = 30000;
Â  Â  Â  Â  // ê²½ì°° íƒ€ì´ë¨¸: 15ì´ˆ í›„ ì¶œë™ í™•ë¥  ê³„ì‚° (15000ms)
Â  Â  Â  Â  var policeDelay = 15000;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // [ì‹ ê·œ] ì‹ ìš©ë“±ê¸‰ë³„ ì°¨ë“± ê²½ì°° ì¶œë™ í™•ë¥  ê³„ì‚° (ê¸°ë³¸ 50% ë² ì´ìŠ¤)
        var crInfo = getCreditInfo(user.creditScore || 600);
        var probTable = {
            1: 0.72,   // 1ë“±ê¸‰: 72%
            2: 0.65,   // 2ë“±ê¸‰: 65%
            3: 0.595,  // 3ë“±ê¸‰: 59.5%
            4: 0.555,  // 4ë“±ê¸‰: 55.5%
            5: 0.525,  // 5ë“±ê¸‰: 52.5%
            6: 0.50    // 6ë“±ê¸‰: 50%
        };
        
        var policeProb = probTable[crInfo.grade] || 0.555;
        
        // [ì•½íƒˆì™•] ì¹­í˜¸ íš¨ê³¼: ê²½ì°° ì¶œë™ í™•ë¥  20% ê°ë©´
        if (user.title === "ì•½íƒˆì™•") policeProb = Math.max(0.1, policeProb - 0.20);

Â  Â  Â  Â  var sT = setTimeout(function(){ processTheftResult(roomName, targetUid, victim.id); }, successDelay);
Â  Â  Â  Â  var pT = setTimeout(function(){ if (Math.random() < policeProb) { processPoliceResult(roomName, targetUid, victim.id); } }, policeDelay);
Â  Â  Â  Â Â 
Â  Â  Â  Â  activeThefts[victim.id] = { thiefUid: targetUid, successTimer: sT, policeTimer: pT };
Â  Â  Â  Â  user.creditScore = Math.max(0, Number(user.creditScore || 600) - 10);

Â  Â  Â  Â  var attemptMsg = getDisplayName(victim.data) + "ë‹˜ ê°•íƒˆ ì‹œë„ ì¤‘ (30ì´ˆ ì†Œìš”)\n\n" +
                         "ğŸš“ 15ì´ˆ í›„ ê²½ì°° ì¶œë™ í™•ë¥  " + (policeProb * 100).toFixed(1) + "%!";

Â  Â  Â  Â  replier.reply(formatCommand("ğŸ•µï¸ ë„ë‘‘ì§ˆ ì‹œë„", user, attemptMsg, "ë°©ì–´: 30ì´ˆ ë‚´ [ì¡ì•˜ë‹¤ìš”ë†ˆ] ì…ë ¥"));
        
        // [Gemini ìš”ì²­ ì‚¬í•­] ë°© ì‹ë³„ì roomName ì¶”ê°€
        checkAndHandleDefaulter(user, roomName);
        safeSaveData(data);
        return true;
    }

    /* ë„ë‘‘ì§ˆ ë°©ì–´ (ì¡ì•˜ë‹¤ìš”ë†ˆ) */
    if (msg === "ì¡ì•˜ë‹¤ìš”ë†ˆ") {
        if (!activeThefts[targetUid]) return false;
        var theft = activeThefts[targetUid];
        if (theft.successTimer) clearTimeout(theft.successTimer);
        if (theft.policeTimer) clearTimeout(theft.policeTimer);
        var thief = roomData.users[theft.thiefUid];
        
        var multiplier = util_getEcoMultiplier(roomName);

        // 1. ë²Œê¸ˆ ê³„ì‚°: í˜„ë³´ìœ ì•¡ì˜ 10% ì°¨ê°
Â  Â  Â  Â  var cashFine = Math.floor(Number(thief.point) * 0.1);
Â  Â  Â  Â  // 2. ëŒ€ë‚© ê³„ì‚°: ìµœì†Œ ë²Œê¸ˆ 1,000P ë¯¸ë‹¬ ì‹œ ë¶€ì¡±ë¶„ì„ ëŒ€ì¶œë¡œ ì „í™˜
Â  Â  Â  Â  var loanGap = Math.max(0, 1000 - cashFine);

Â  Â  Â  Â  util_updatePoint(thief, roomData, -cashFine, "ë„ë‘‘ì§ˆ ì²´í¬ ë²Œê¸ˆ", roomName);
Â  Â  Â  Â Â 
Â  Â  Â  Â  var loanMsg = "";
Â  Â  Â  Â  if (loanGap > 0) {
Â  Â  Â  Â  Â  Â  if (!thief.loan) thief.loan = { debt: 0, items: [] };
Â  Â  Â  Â  Â  Â  thief.loan.debt = Number(thief.loan.debt || 0) + loanGap;
Â  Â  Â  Â  Â  Â  if (!thief.loan.items) thief.loan.items = [];
Â  Â  Â  Â  Â  Â  thief.loan.items.push(loanGap);
Â  Â  Â  Â  Â  Â  loanMsg = "\nâš ï¸ ë²Œê¸ˆ ë¶€ì¡±ë¶„ ëŒ€ë‚©: " + fp(loanGap) + "P ëŒ€ì¶œ ì „í™˜";
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  thief.jailReleaseTime = Date.now() + (1 * 60 * 60 * 1000); 
Â  Â  Â  Â  delete activeThefts[targetUid];
Â  Â  Â  Â Â 
Â  Â  Â  Â  var resContent = "ğŸš¨ [í˜„í–‰ë²” ì²´í¬]\nëŒ€ìƒ: " + getDisplayName(thief) + "\nê²°ê³¼: -" + fp(cashFine) + "P ì°¨ê° / ì§•ì—­ 1ì‹œê°„" + loanMsg + "\në‚´ ì”ì•¡: " + fp(thief.point) + "P";
        replier.reply(formatAdmin("ğŸš“ ì²´í¬ ì™„ë£Œ", resContent));
        safeSaveData(data);
        return true;
    }

   /* [Gemini ìš”ì²­ ì‚¬í•­] ë¿Œë¦¬ê¸° ì¤ê¸° (ì°¸ì¡° ê¸°ë°˜ ë°ì´í„° í™•ì¸ ë° êµ­ê³  ì—°ë™) */
    if (msg === "ì¤ê¸°") {
        // 1. ì´ë²¤íŠ¸ í™œì„±í™” ì²´í¬ (ë°©ë³„ ì£¼ë¨¸ë‹ˆ ê¸°ì¤€)
        if (!sprinkleData || sprinkleData.active !== true) return false;

        var currentUser = user || roomData.users[targetUid];
            // ì´ë²¤íŠ¸ê°€ ì—†ì„ ë•Œ ë¬´ì‘ë‹µ ëŒ€ì‹  ì•ˆë‚´ë¥¼ ì£¼ì–´ 'ë¨¹í†µ' ì˜¤í•´ë¥¼ í•´ì†Œí•©ë‹ˆë‹¤.
            // replier.reply(formatError(user, "ì¤ê¸° ì‹¤íŒ¨", "í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ë¿Œë¦¬ê¸° ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤."));
            if (!currentUser) return false;

        // 2. ìœ ì € ë°ì´í„° ë¬´ê²°ì„± ì²´í¬
        var currentUser = user || roomData.users[targetUid];
        if (!currentUser) return false;

        // 3. ì¤‘ë³µ ì°¸ì—¬ ë° ì„ ì°©ìˆœ ê²€ì¦
        if (sprinkleData.winners.indexOf(targetUid) !== -1) {
            replier.reply(formatError(currentUser, "ì¤‘ë³µ ì°¸ì—¬ ë¶ˆê°€", "ì´ë¯¸ ì´ ì´ë²¤íŠ¸ì—ì„œ í¬ì¸íŠ¸ë¥¼ íšë“í•˜ì…¨ìŠµë‹ˆë‹¤."));
            return true;
        }
        if (sprinkleData.currentWinners >= sprinkleData.limit) {
            replier.reply(formatError(currentUser, "ì„ ì°©ìˆœ ë§ˆê°", "ì´ë¯¸ ëª¨ë“  í¬ì¸íŠ¸ê°€ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤."));
            return true;
        }

        // 4. í¬ì¸íŠ¸ ë°°ì • ë° ì§€ê¸‰ (portions ë°°ì—´ì—ì„œ ë§ˆì§€ë§‰ ê°’ ì¶”ì¶œ)
        var prize = sprinkleData.portions.pop();
        if (prize === undefined) return false;

        sprinkleData.winners.push(targetUid);
        sprinkleData.currentWinners++;
        sprinkleData.remainingPoint -= prize;

        // [v5.9] í†µí•© ìƒí™˜ ì—”ì§„ ë° ê²Œì´íŠ¸ì›¨ì´ ì§€ê¸‰
        var res = processRepayment(currentUser, prize, targetUid, roomName);
        util_updatePoint(currentUser, roomData, Number(res.actualGain), "ë¿Œë¦¬ê¸° ì¤ê¸°", roomName);

        replier.reply(formatCommand("ğŸ‰ ì¤ê¸° ì„±ê³µ!", currentUser, fp(prize) + "Pë¥¼ ì£¼ì› ìŠµë‹ˆë‹¤!" + res.repayMsg, "ë‚´ ì”ì•¡: " + fp(currentUser.point) + "P"));

        // 5. ì „ëŸ‰ ì†Œì§„ ì‹œ ì´ë²¤íŠ¸ ìë™ ì¢…ë£Œ
        if (sprinkleData.currentWinners >= sprinkleData.limit) {
            sprinkleData.active = false;
            Api.replyRoom(roomName, formatAdmin("ğŸ ë¿Œë¦¬ê¸° ë§ˆê°", "ëª¨ë“  í¬ì¸íŠ¸ê°€ ì†Œì§„ë˜ì–´ ì´ë²¤íŠ¸ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."));
        }
        safeSaveData(data);
        return true;
    }

    return false;
}

//==========ì„¹í„°44==========

/**
 * [ê²Œì„ í•˜ìœ„ ëª¨ë“ˆ 4] ëœë“œë§ˆí¬ ë¶€ë™ì‚° íˆ¬ì ê´€ë¦¬ (v11.0 Landmark Edition)
 * ê¸°ëŠ¥: ë¶€ë™ì‚° ì‹œì„¸ ì¡°íšŒ, ë‚´ ë¶€ë™ì‚° í™•ì¸, ì§€ë¶„ íˆ¬ì, ì§€ë¶„ ë§¤ê°
 * ì„¤ëª…: íì‡„í˜• ìˆœí™˜ ê²½ì œ ì—°ë™ - ë§¤ì…ê¸ˆì€ ê¸ˆê³  ì…ê³ , ë§¤ê°ê¸ˆì€ ê¸ˆê³  ì§€ì¶œ
 */
function _gameLandmarkLogic(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];
    if (!roomData || !roomData.features) return false;

    // ì¤‘ì•™ì€í–‰ ì¬ì› ì´ˆê¸°í™” (ì•ˆì „ì¥ì¹˜)
    if (roomData.bankReserve === undefined || roomData.bankReserve === null) {
        roomData.bankReserve = 10000;
    }

    /* [ë¶€ë™ì‚° ê±°ë˜ ì‹œìŠ¤í…œ] */

    // 1. ì‹¤ì‹œê°„ ì‹œì„¸ ì¡°íšŒ (/ëœë“œë§ˆí¬)
    if (msg === "/ëœë“œë§ˆí¬") {
        var currentHour = new Date().getHours();
        var isMarketOpen = (currentHour >= 7 && currentHour <= 23);
        var statusText = isMarketOpen ? "ğŸŸ¢ ë¶€ë™ì‚° ìš´ì˜ì¤‘ (07:00 ~ 23:59)" : "ğŸ”´ ë¶€ë™ì‚° ë§ˆê° (00:00~06:59)";
        var landList = generateLandmarkList(data, roomName);
        
        replier.reply("ğŸ¢ ì‹¤ì‹œê°„ ë¶€ë™ì‚° ì‹œì„¸ ì •ë³´\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + statusText + "\n\n" + (landList || "ë“±ë¡ëœ ë§¤ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.") + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’¡ [ê°€ì´ë“œ]: íˆ¬ì: [/íˆ¬ì ê±´ë¬¼ëª… ìˆ˜ëŸ‰]");
        return true;
    }

    // 2. ë‚´ ì†Œìœ  ë¶€ë™ì‚° í™•ì¸ (/ë‚´ë¶€ë™ì‚°)
    if (msg === "/ë‚´ë¶€ë™ì‚°") {
        var holdings = user.landHoldings || {};
        var keys = Object.keys(holdings);
        var title = "ğŸ˜ï¸ " + getDisplayName(user) + "ì˜ ì†Œìœ  ë¶€ë™ì‚°";

        var fixCfg = SYSTEM_CONFIG.ECO.LANDMARK.FIXED_POLICY; // ê³ ì •ê°€ ì •ì±… ì„¤ì • ë¡œë“œ

        if (keys.length === 0) {
            replier.reply(formatCommand(title, null, "ë³´ìœ  ì¤‘ì¸ ë¶€ë™ì‚° ì§€ë¶„ì´ ì—†ìŠµë‹ˆë‹¤.", "íˆ¬ì: [/íˆ¬ì ê±´ë¬¼ëª… ìˆ˜ëŸ‰]"));
            return true;
        }

        var list = [];
        var totalEvaluation = 0;
        var totalPurchase = 0;

        for (var i = 0; i < keys.length; i++) {
            var lName = keys[i];
            var count = Number(holdings[lName]);
            if (count <= 0) continue;

            var landmark = data.landmarkMarket[lName];
            var isDemolished = !landmark; 
            
            // [ê°€ê²© ë™ê¸°í™” í•µì‹¬] íƒ€ì…ì— ë”°ë¥¸ ì‹¤ì‹œê°„ ì‹œì„¸ ê³„ì‚°
            var curPrice = 0;
            if (!isDemolished) {
                if (landmark.type === "normal") {
                    // ì „ì—­ í•¨ìˆ˜ë¥¼ í†µí•´ ì‹¤ì‹œê°„ ë°œí–‰ ì§€ë¶„ ì´í•©ì„ ê°€ì ¸ì™€ ê°€ê²© ì‚°ì¶œ
                    var totalShares = util_getTotalShares(lName, data);
                    curPrice = fixCfg.BASE_PRICE + (totalShares * (fixCfg.BASE_PRICE * fixCfg.PER_SHARE_RATE));
                } else {
                    curPrice = Math.floor(Number(landmark.price));
                }
            }
            var avgPrice = Math.floor(Number(user.landAvg[lName] || 0));
            
            var purchaseVal = Math.floor(avgPrice * count);
            var evaluationVal = Math.floor(curPrice * count);
            
            totalPurchase += purchaseVal;
            totalEvaluation += evaluationVal;
            
            var profit = evaluationVal - purchaseVal;
            var profitRate = avgPrice > 0 ? ((profit / purchaseVal) * 100).toFixed(1) : "0.0";
            var signIcon = profit > 0 ? "ğŸ”º" : (profit < 0 ? "ğŸ”¹" : "â–");
            var nameDisplay = isDemolished ? "âš ï¸(ì² ê±°) " + lName : lName;
            
            list.push("â€¢ " + nameDisplay + " " + count + "ì§€ë¶„\n" +
                      "  ìˆ˜ìµ: " + fp(Math.floor(profit)) + "P (" + signIcon + profitRate + "%)\n" +
                      "  í‰ë‹¨: " + fp(avgPrice) + "P â” í˜„ì¬: " + fp(curPrice) + "P");
        }

        var totalProfit = totalEvaluation - totalPurchase;
        var totalRate = totalPurchase > 0 ? ((totalProfit / totalPurchase) * 100).toFixed(1) : "0.0";
        var totalSignIcon = totalProfit > 0 ? "ğŸ”º" : (totalProfit < 0 ? "ğŸ”¹" : "â–");

        var summary = "ğŸ’ ì´ í‰ê°€ê¸ˆì•¡: " + fp(Math.floor(totalEvaluation)) + "P\n" +
                      "ğŸ“Š ì „ì²´ ìˆ˜ìµë¥ : " + fp(Math.floor(totalProfit)) + "P (" + totalSignIcon + totalRate + "%)\n" +
                      "ğŸ’° ë³´ìœ  í¬ì¸íŠ¸: " + fp(Math.floor(user.point)) + "P";

        replier.reply(formatCommand(title, null, list.join("\n\n") + "\n\n" + summary, "ë§¤ê°: [/ë§¤ê° ê±´ë¬¼ëª… ìˆ˜ëŸ‰]"));
        return true;
    }

    // 3. ë¶€ë™ì‚° ì§€ë¶„ ë§¤ì… (/íˆ¬ì)
    if (msg.indexOf("/íˆ¬ì ") === 0) {
        if (typeof util_isBankruptcy === 'function' && util_isBankruptcy(roomName)) {
            var bankMsg = "ğŸš¨ [êµ­ê°€ ë¶€ë™ì‚° ê±°ë˜ ë™ê²°]\n" +
                          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                          "í˜„ì¬ ì¤‘ì•™ì€í–‰ì˜ ì§€ë¶ˆ ë¶ˆëŠ¥(ë¶€ë„) ìƒíƒœê°€ ì„ í¬ë˜ì–´\n" +
                          "ì‹ ê·œ ë¶€ë™ì‚° ë§¤ì…ì´ ì „ë©´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n" +
                          "ğŸ“ ì‚¬ìœ : êµ­ê³  ì¬ì› ê³ ê°ˆ\n" +
                          "ğŸ“‰ ì¡°ì¹˜: ë¶€ë™ì‚° ì‹œì¥ ì¼ì‹œ íì‡„";
            
            replier.reply(formatCommand("ğŸ—ï¸ íˆ¬ì ë™ê²° ì•Œë¦¼", user, bankMsg, "í•´ì œ ê¸°ì¤€: êµ­ê³  50% ë³µêµ¬"));
            return true;
        }

        var stateRes = util_checkUserState(user, targetUid, roomName);
        if (!stateRes.canAction) {
            replier.reply(formatError(user, "ê±°ë˜ ë¶ˆê°€", stateRes.reason));
            return true;
        }
        var currentHour = new Date().getHours();
        if (currentHour < 7) { replier.reply(formatError(user, "ë¶€ë™ì‚° ì‹œì¥ ë§ˆê°", "í˜„ì¬ëŠ” ë¶€ë™ì‚° ê±°ë˜ ì •ì§€ ì‹œê°„ì…ë‹ˆë‹¤.\n(ìš´ì˜ì‹œê°„: 07:00 ~ 23:59)")); return true; }

        var parts = msg.split(" ");
        if (parts.length < 3) { replier.reply(formatError(user, "í˜•ì‹ ì˜¤ë¥˜", "/íˆ¬ì [ê±´ë¬¼ëª…] [ìˆ˜ëŸ‰]")); return true; }
        
        var sInput = parts[1], count = parseInt(parts[2].replace(/,/g, ""));
        var matched = util_findStockByShorthand(data.landmarkMarket, sInput);
        
        if (matched.length === 0) { replier.reply(formatError(user, "ë§¤ë¬¼ ì—†ìŒ", "[" + sInput + "] ê±´ë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (matched.length > 1) { handleStockSelection(replier, targetUid, matched, "stock_buy", count, user, roomName); return true; }
        
        var sName = matched[0];
        var landmark = data.landmarkMarket[sName];
        if (isNaN(count) || count <= 0) { replier.reply(formatError(user, "ìˆ˜ëŸ‰ ì˜¤ë¥˜", "ë§¤ì…í•˜ì‹¤ ì§€ë¶„ ìˆ˜ëŸ‰ì„ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”.")); return true; }
        
        var totalPrice = 0;
        var fixCfg = SYSTEM_CONFIG.ECO.LANDMARK.FIXED_POLICY;

        if (landmark.type === "normal") {
            /* [ì°¸ì¡° ì˜¤ë¥˜ í•´ê²°] ì „ì—­ í•¨ìˆ˜ util_getTotalShares í˜¸ì¶œ */
            var currentGlobalShares = util_getTotalShares(sName, data);
            var unitIncr = fixCfg.BASE_PRICE * fixCfg.PER_SHARE_RATE; 

            for (var i = 0; i < count; i++) {
                // í•œ ì§€ë¶„ì„ ì‚´ ë•Œë§ˆë‹¤ ê°€ê²©ì´ unitIncrë§Œí¼ ìƒìŠ¹í•œ ê°’ì„ ëˆ„ì 
                totalPrice += (fixCfg.BASE_PRICE + ((currentGlobalShares + i) * unitIncr));
            }
        } else {
            /* [ë¹„ì¦ˆë‹ˆìŠ¤/ìƒê°€] ê¸°ì¡´ ê³ ì • ì‹œì„¸ ë§¤ì… */
            totalPrice = Math.floor(Number(landmark.price) * count);
        }
        if (Number(user.point) < totalPrice) { replier.reply(formatError(user, "ìê¸ˆ ë¶€ì¡±", "í•„ìš”: " + fp(totalPrice) + "P")); return true; }
        
        /* [ì¤‘ì•™ì€í–‰ ì—°ë™] ë§¤ì… ëŒ€ê¸ˆì„ êµ­ê³ ë¡œ ì…ê³  */
        util_updatePoint(user, roomData, -totalPrice, "ë¶€ë™ì‚° ë§¤ì…", roomName);

        // ìˆ˜ëŸ‰ ë° í‰ë‹¨ê°€ ì—…ë°ì´íŠ¸ (ëœë“œë§ˆí¬ íƒ€ì…ì€ í‰ë‹¨ê°€ ê¸°ë¡ ì œì™¸)
        if (landmark.type !== "normal") {
            var curCount = Number(user.landHoldings[sName] || 0);
            var curAvg = Number(user.landAvg[sName] || 0);
            user.landAvg[sName] = Math.floor(((curAvg * curCount) + totalPrice) / (curCount + count));
        } else {
            // ëœë“œë§ˆí¬ëŠ” í‰ë‹¨ê°€ ëŒ€ì‹  0Pë¡œ ì„¸íŒ…í•˜ê±°ë‚˜ ê¸°ì¡´ê°’ ìœ ì§€
            user.landAvg[sName] = fixCfg.BASE_PRICE; 
        }
        
        util_updateLandmark(user, sName, count, "ë¶€ë™ì‚° ë§¤ì…", roomName);

        // ëˆ„ì  íˆ¬ì ë°ì´í„° ê°±ì‹ 
        var nextInvestAmount = (Number(user.totalLandInvest) || 0) + totalPrice;
        util_setData(user, 'totalLandInvest', nextInvestAmount, "ë¶€ë™ì‚° íˆ¬ì ì´ì•¡ ê°±ì‹ ", roomName);

        var rStub = { reply: function(m) { Api.replyRoom(roomName, m); } };

        // ë¶€ë™ì‚° ì „ìš© ì¹­í˜¸ ì²´í¬
        if (user.totalLandInvest >= 10000000) {
            util_checkAndAwardTitle(user, rStub, "íˆ¬ê¸°ì™•", 4303, "ğŸ™ï¸", "ë‚´ë¦¬ë‹¤ í† ì§€ì£¼íƒê³µì‚¬", "ëˆ„ì  ë§¤ì…ì•¡ 1,000ë§ŒP", "ë¶€ë™ì‚° ì‹œì¥ì„ ì§€ë°°í•˜ëŠ” ì „ì„¤ì ì¸ ê±°ë¬¼ë¡œ ë“±ê·¹í•˜ì…¨ìŠµë‹ˆë‹¤.");
        } else if (user.totalLandInvest >= 5000000) {
            util_checkAndAwardTitle(user, rStub, "ê±´ë¬¼ì£¼", 4302, "ğŸ¢", "ë‚´ë¦¬ë‹¤ í† ì§€ì£¼íƒê³µì‚¬", "ëˆ„ì  ë§¤ì…ì•¡ 500ë§ŒP", "ì£¼ìš” ìš”ì¶©ì§€ì˜ ê±´ë¬¼ì„ ì†Œìœ í•œ ì˜í–¥ë ¥ ìˆëŠ” ìì‚°ê°€ì…ë‹ˆë‹¤.");
        } else if (user.totalLandInvest >= 1000000) {
            util_checkAndAwardTitle(user, rStub, "ì„ëŒ€ì¸", 4301, "ğŸ ", "ë‚´ë¦¬ë‹¤ í† ì§€ì£¼íƒê³µì‚¬", "ëˆ„ì  ë§¤ì…ì•¡ 100ë§ŒP", "ë¶€ë™ì‚° íˆ¬ìì˜ ì²« ë‹¨ì¶”ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¼ìš°ì…¨ìŠµë‹ˆë‹¤.");
        }
        
        if (!data.landmarkTraffic) data.landmarkTraffic = {};
        if (!data.landmarkTraffic[sName]) data.landmarkTraffic[sName] = { buy: 0, sell: 0 };
        data.landmarkTraffic[sName].buy += count;

        var actualUnitPrice = Math.floor(totalPrice / count);
        var buySuccessMsg = "ê±´ë¬¼: " + sName + "\nìˆ˜ëŸ‰: " + count + " ì§€ë¶„\në§¤ì…ê°€: " + fp(actualUnitPrice) + "P (ì´ " + fp(totalPrice) + "P)";

        // [ê°œí¸] ê°“ë¬¼ì£¼ ì¡°ê±´: í•µì‹¬ ì‹œì„¤ íˆ¬ì ì‹œ ì§€ë¶„ë‹¹ 30% í™•ë¥ ë¡œ ì£¼ì‚¬ìœ„ êµ´ë¦¼
        var coreLandmarks = ["ê´‘ì‚°", "ë‚šì‹œí„°", "ì¹´ì§€ë…¸", "ì¤‘ì•™ì€í–‰", "ë°±í™”ì ", "ê²½ë§ˆì¥"];
        if (coreLandmarks.indexOf(sName) !== -1) { 
            var earnedInThisTrade = 0;
            // íˆ¬ìí•œ ì§€ë¶„ ìˆ˜ëŸ‰(count)ë§Œí¼ ë°˜ë³µí•˜ì—¬ í™•ë¥  íŒì •
            for (var i = 0; i < count; i++) {
                if (Math.random() < 0.3) earnedInThisTrade++;
            }

            if (earnedInThisTrade > 0) {
                user.landDeedCount = (user.landDeedCount || 0) + earnedInThisTrade;
                buySuccessMsg += "\n\n ğŸ“œ í•µì‹¬ ì‹œì„¤ íˆ¬ìë¡œ 'ë¶€ë™ì‚° ë“±ê¸°ë¶€'ë¥¼ " + earnedInThisTrade + "ì¥ íšë“í–ˆìŠµë‹ˆë‹¤!";
                buySuccessMsg += "\n(í˜„ì¬ ìˆ˜ì§‘: " + user.landDeedCount + " / 10)";
                
                if (user.landDeedCount >= 10) {
                    user.landDeedCount = 0; // ì´ˆê¸°í™”
                    util_checkAndAwardTitle(user, replier, "ê°“ë¬¼ì£¼", 888, "ğŸ¢", "ë‚´ë¦¬ë‹¤ ì˜íšŒ", "ë“±ê¸°ë¶€ 10ì¥ ìˆ˜ì§‘ ì™„ë£Œ", "[ì¥ì°© íš¨ê³¼]: ë§¤ì¼ ìì • ì§€ê¸‰ë˜ëŠ” ëœë“œë§ˆí¬ ë°°ë‹¹ê¸ˆì´ 10% ì¶”ê°€ ì§€ê¸‰ë©ë‹ˆë‹¤.", roomName);
                }
            }
        }
        
        replier.reply(formatCommand("ğŸ™ï¸ ë¶€ë™ì‚° ì§€ë¶„ ë§¤ì… ì™„ë£Œ", user, buySuccessMsg, "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
        safeSaveData(data);
        return true;
    }

    // 4. ë¶€ë™ì‚° ì§€ë¶„ ë§¤ê° (/ë§¤ê°)
    if (msg.indexOf("/ë§¤ê° ") === 0) {
        if (typeof util_isBankruptcy === 'function' && util_isBankruptcy(roomName)) {
            var bankMsg = "ğŸš¨ [êµ­ê°€ ë¶€ë™ì‚° ê±°ë˜ ë™ê²°]\n" +
                          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                          "í˜„ì¬ ì¤‘ì•™ì€í–‰ì˜ ì§€ë¶ˆ ë¶ˆëŠ¥(ë¶€ë„) ìƒíƒœê°€ ì„ í¬ë˜ì–´\n" +
                          "ë¶€ë™ì‚° ë§¤ê° ëŒ€ê¸ˆ ì§€ê¸‰ì´ ì „ë©´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n" +
                          "ğŸ“ ì‚¬ìœ : êµ­ê³  ì¬ì› ê³ ê°ˆ\n" +
                          "ğŸ“‰ ì¡°ì¹˜: ë¶€ë™ì‚° ë§¤ê° ì¼ì‹œ ì •ì§€";
            
            replier.reply(formatCommand("ğŸ—ï¸ ë§¤ê° ë™ê²° ì•Œë¦¼", user, bankMsg, "í•´ì œ ê¸°ì¤€: êµ­ê³  50% ë³µêµ¬"));
            return true; 
        }

        var stateRes = util_checkUserState(user, targetUid, roomName);
        if (!stateRes.canAction) {
            replier.reply(formatError(user, "ê±°ë˜ ë¶ˆê°€", stateRes.reason));
            return true;
        }

        var parts = msg.split(" ");
        if (parts.length < 3) { replier.reply(formatError(user, "í˜•ì‹ ì˜¤ë¥˜", "/ë§¤ê° [ê±´ë¬¼ëª…] [ìˆ˜ëŸ‰]")); return true; }
        
        var sInput = parts[1], count = parseInt(parts[2].replace(/,/g, ""));
        
        // ë³´ìœ  ì¤‘ì¸ ë¶€ë™ì‚° ì§€ë¶„ ë¦¬ìŠ¤íŠ¸ì—ì„œ ê²€ìƒ‰
        var matched = util_findStockByShorthand(user.landHoldings, sInput);
        
        if (matched.length === 0) { replier.reply(formatError(user, "ë³´ìœ  ë§¤ë¬¼ ì—†ìŒ", "[" + sInput + "] ì§€ë¶„ì„ ë³´ìœ í•˜ê³  ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.")); return true; }
        if (matched.length > 1) { handleStockSelection(replier, targetUid, matched, "stock_sell", count, user, roomName); return true; }
        
        var sName = matched[0];
        var holdings = Number(user.landHoldings[sName] || 0);
        if (holdings < count || count <= 0) { replier.reply(formatError(user, "ì§€ë¶„ ë¶€ì¡±", "ë³´ìœ í•˜ì‹  ì§€ë¶„ë³´ë‹¤ ë§ì€ ìˆ˜ëŸ‰ì„ ë§¤ê°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }

        var landmark = data.landmarkMarket[sName];
        var sellUnitPrice = 0;
        if (landmark && landmark.type === "normal") {
            /* [ëœë“œë§ˆí¬ ì „ìš©] í˜„ì¬ ì „ ì„œë²„ ì§€ë¶„ê°€ ê¸°ì¤€ ë§¤ê° (ì „ì—­ í•¨ìˆ˜ ì ìš©) */
            var fixCfg = SYSTEM_CONFIG.ECO.LANDMARK.FIXED_POLICY;
            var totalShares = util_getTotalShares(sName, data);
            sellUnitPrice = fixCfg.BASE_PRICE + (totalShares * (fixCfg.BASE_PRICE * fixCfg.PER_SHARE_RATE));
        } else {
            /* [ë¹„ì¦ˆë‹ˆìŠ¤/ìƒê°€] í˜„ì¬ ì‹œì¥ê°€ ê¸°ì¤€ ë§¤ê° */
            sellUnitPrice = landmark ? Math.floor(Number(landmark.price)) : 0;
        }
        
        var totalSell = sellUnitPrice * count;

        // ì„¸ê¸ˆ ê³„ì‚° (ê°“ë¬¼ì£¼ ì¹­í˜¸ íš¨ê³¼ ë°˜ì˜)
        var pol = util_getActivePolicy(roomData);
        var baseTaxRate = pol.stockTax || 0.05;
        var appliedTaxRate = baseTaxRate;

        var taxBenefitMsg = "";
        if (user.title === "ê¸°ë¶€ì™•") {
            appliedTaxRate = baseTaxRate * 0.5;
            taxBenefitMsg = "\nâœ¨ [ê¸°ë¶€ì™• íŠ¹ë³„ ì˜ˆìš°] ì–‘ë„ì„¸ 50% ê°ë©´ ì ìš©";
        }
        
        var fee = Math.floor(totalSell * appliedTaxRate);
        var finalPrice = totalSell - fee;

        var speculationBonus = 0;
        if (user.title === "íˆ¬ê¸°ì™•") {
            speculationBonus = Math.floor(finalPrice * 0.05);
            finalPrice += speculationBonus; // ìµœì¢… ì§€ê¸‰ì•¡ì— í•©ì‚°
        }

        // ì¤‘ì•™ì€í–‰ ì§€ë¶ˆ ëŠ¥ë ¥ ì²´í¬ (ë±…í¬ëŸ° ë°©ì–´)
        if (!util_isBankSolvent(roomName, finalPrice)) {
            return replier.reply("ğŸš¨ [ì¤‘ì•™ì€í–‰ ì§€ë¶ˆ ì •ì§€]\nì¤‘ì•™ì€í–‰ì˜ í˜„ê¸ˆ ìœ ë™ì„± ë¶€ì¡±ìœ¼ë¡œ ë§¤ê° ëŒ€ê¸ˆì„ ì§€ë¶ˆí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }

        // [êµì •]: ì •ì˜ë˜ì§€ ì•Šì€ sellPriceë¥¼ sellUnitPriceë¡œ ìˆ˜ì •
        var avgPrice = Number(user.landAvg[sName] || sellUnitPrice); 
        var purchaseVal = avgPrice * count; 
        var profit = totalSell - purchaseVal; 
        var profitRate = purchaseVal > 0 ? ((profit / purchaseVal) * 100).toFixed(1) : "0.0";
        var signIcon = (profit > 0) ? "ğŸ”º" : (profit < 0 ? "ğŸ”¹" : "â–");

        util_updateLandmark(user, sName, -count, "ë¶€ë™ì‚° ë§¤ê°", roomName);
        if (user.landHoldings[sName] <= 0) { 
            delete user.landHoldings[sName]; 
            if (user.landAvg) delete user.landAvg[sName]; 
        }
        
        // ìƒí™˜ ì—”ì§„ í†µê³¼ ë° ìµœì¢… ì§€ê¸‰
        var res = processRepayment(user, finalPrice, targetUid, roomName); 
        util_updatePoint(user, roomData, Number(res.actualGain), "ë¶€ë™ì‚° ë§¤ì…", roomName);
        
        if (!data.landmarkTraffic) data.landmarkTraffic = {};
        if (!data.landmarkTraffic[sName]) data.landmarkTraffic[sName] = { buy: 0, sell: 0 };
        data.landmarkTraffic[sName].sell += count;

        var taxText = (user.title === "ê°“ë¬¼ì£¼") ? "ğŸ¢ [ê°“ë¬¼ì£¼] ì„¸ê¸ˆ 50% ê°ë©´ í˜œíƒ ì ìš©!" : "ë¶€ë™ì‚° ì–‘ë„ì„¸ ì°¨ê°";
        
        // [ìˆ˜ì •] ë§¤ê° ê²°ê³¼ ë¦¬í¬íŠ¸ì— ì„¸ê¸ˆ ê°ë©´ ì•ˆë‚´ í†µí•©
        var sellResult = "ğŸ“‰ ë¶€ë™ì‚° ì§€ë¶„ ë§¤ê° ì™„ë£Œ\n" +
                         "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                         getDisplayName(user) + "ë‹˜\n" +
                         "ê±´ë¬¼: " + sName + " " + count + "ì§€ë¶„\n" +
                         "ìˆ˜ìµ : " + fp(Math.abs(profit)) + "P (" + signIcon + Math.abs(profitRate).toFixed(1) + "%)\n" +
                         "ì‹¤í˜„ì†ìµ : " + fp(finalPrice) + "P (ì„¸ìœ¨ " + (appliedTaxRate * 100).toFixed(1) + "% ì ìš©)" + 
                         taxBenefitMsg + (res.repayMsg || "") + "\n" +
                         "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                         "ğŸ’¡ [ê°€ì´ë“œ]: ë‚´ ì”ì•¡: " + fp(user.point) + "P";

        replier.reply(sellResult);
        safeSaveData(data);
        return true;
    }

    return false;
}

//==========ì„¹í„°45==========

/**
 * [ê²Œì„ í•˜ìœ„ ëª¨ë“ˆ 5] ìƒì  ë° ê¸°íƒ€ í™œë™
 * ê¸°ëŠ¥: ìƒì  ë©”ë‰´ í˜¸ì¶œ, ì¶œì„ ì²´í¬
 * ì„¤ëª…: íì‡„í˜• ìˆœí™˜ ê²½ì œ ì—°ë™ - ì¶œì„ ë³´ìƒì„ ì¤‘ì•™ì€í–‰ ê¸ˆê³ ì—ì„œ ì§€ê¸‰í•©ë‹ˆë‹¤.
 */
function _gameShopLogic(msg, user, data, replier, roomName, targetUid) {
    if (ALLOWED_ROOMS.indexOf(roomName) === -1) {
        replier.reply("ğŸš« [ê¸°ëŠ¥ ì œí•œ]\nìƒì  ë° ì¶œì„ì²´í¬ëŠ” ë‹¨ì²´ë°©('ë‚´ë¦¬ë‹¤')ì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.\n\nâœ… 1:1 ê°€ëŠ¥: ì¹´ì§€ë…¸, ì€í–‰, ë‚´ì •ë³´");
        return true;
    }

    var roomData = data.rooms[roomName];
    if (!roomData || !roomData.features) return false;

    // [êµì •]: ì „ì—­ ê°ì²´ê°€ ì•„ë‹Œ í•´ë‹¹ ë°©ì˜ ë…ë¦½ ìƒíƒœ ì €ì¥ì†Œë¥¼ ëª…í™•íˆ ì°¸ì¡°
    var menuWaitState = roomData.features.states.menuWait;
    var bankProcessState = roomData.features.states.bankProcess;

    /* [Gemini] ì „ êµ¬ì—­ ì´ ì§€ë¶„ í•©ê³„ ê³„ì‚° ë‚´ë¶€ í•¨ìˆ˜ */
    var getTotalShares = function(landName) {
        var total = 0;
        for (var r in data.rooms) {
            for (var u in data.rooms[r].users) {
                total += Number((data.rooms[r].users[u].landHoldings || {})[landName] || 0);
            }
        }
        return total;
    };

    // ì¤‘ì•™ì€í–‰ ì¬ì› ì´ˆê¸°í™” (ì•ˆì „ì¥ì¹˜)
    if (roomData.bankReserve === undefined || roomData.bankReserve === null) {
        roomData.bankReserve = SYSTEM_CONFIG.ECO.BANK.INITIAL_RESERVE;
    }

    /* [ê¸°ëŠ¥ 14] ìƒì  ë©”ë‰´ í˜¸ì¶œ */
    if (msg === "/ìƒì ") {
        // [êµì •]: ë°©ë³„ ìƒíƒœ ê²€ì¦ì„ ìœ„í•´ roomName ì¸ì ì „ë‹¬
        var stateRes = util_checkUserState(user, targetUid, roomName); 
        if (!stateRes.canAction && stateRes.reason.indexOf("ê´‘ì‚°") === -1) {
            replier.reply(formatError(user, "ìƒì  ì´ìš© ë¶ˆê°€", stateRes.reason));
            return true;
        }
        
        // 1. ìƒì  ë©”ì¸ ë©”ë‰´ UI: ì‚¬ìš©ì ìš”ì²­ì— ë”°ë¼ "âì·¨ì†Œ"ë§Œ í‘œì‹œ
        menuWaitState[targetUid] = { type: 'shop_category', time: Date.now() };
        var categoryList = [];
        for (var id in SHOP_CATEGORIES) {
            categoryList.push(id + ". " + SHOP_CATEGORIES[id]);
        }
        var shopMenu = "ì›í•˜ì‹œëŠ” ì¹´í…Œê³ ë¦¬ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.\n\n" + categoryList.join("\n") + "\n\nâì·¨ì†Œ";
        
        replier.reply(formatCommand("ğŸ›’ ë‚´ë¦¬ë‹¤ë´‡ í†µí•© ìƒì ", user, shopMenu, "ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
        return true;
    }

    /* [ì¶”ê°€] ìƒì  ë¬¼í’ˆ ëª©ë¡ ì¶œë ¥ (ì‘ë‹µ ëŒ€ê¸° êµ¬ê°„ - ë‚´ë¹„ê²Œì´ì…˜ í¬í•¨) */
    // ì´ ë¡œì§ì€ ìƒì  ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí–ˆì„ ë•Œ í˜¸ì¶œë˜ì–´ ë¬¼í’ˆ ëª©ë¡ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
    function _showShopItemList(catId, user, roomName, replier, bankProcessState, targetUid) {
        var filteredItems = SHOP_ITEMS.filter(function(it) { return it.cat === parseInt(catId); });
        
        if (filteredItems.length === 0) {
            replier.reply(formatSimple("ğŸ›’ ìƒì  ì•Œë¦¼", "í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì— ë¬¼í’ˆì´ ì—†ìŠµë‹ˆë‹¤.", "ë‹¤ë¥¸ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”."));
            return;
        }

        var list = filteredItems.map(function(item, j) {
            return (j + 1) + ". " + item.icon + " " + item.name + " : " + fp(getItemPrice(item, user, roomName)) + "P";
        });

        // ìƒíƒœ ì „í™˜ ë° ì•„ì´í…œ ë°ì´í„° ìºì‹±
        bankProcessState[targetUid] = { type: 'shop_buy', time: Date.now(), extra: { items: filteredItems } };
        
        // [ì‘ë‹µ ëŒ€ê¸° ì§€ì ] í•˜ë‹¨ì— ì „ì²´ ë‚´ë¹„ê²Œì´ì…˜ ë°” í¬í•¨
        var SHOP_NAV = "\n\nâ†©ï¸ ë’¤ë¡œ / ğŸ  ì²˜ìŒìœ¼ë¡œ / âì·¨ì†Œ";
        var shopContent = list.join("\n") + "\n\nğŸ’° ë³´ìœ  í¬ì¸íŠ¸: " + fp(user.point) + "P" + SHOP_NAV;
        
        replier.reply(formatCommand("ğŸ›’ " + SHOP_CATEGORIES[catId], user, shopContent, "êµ¬ë§¤í•  ë¬¼í’ˆì˜ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
    }

    /* [ê¸°ëŠ¥ 2] ì¶œì„ ì²´í¬ (ì¤‘ì•™ì€í–‰ ì—°ë™) */
    if (msg === "/ì¶œì„") {
        var stateRes = util_checkUserState(user, targetUid);
        if (!stateRes.canAction && stateRes.reason.indexOf("ê´‘ì‚°") === -1) {
            replier.reply(formatError(user, "ì¶œì„ ë¶ˆê°€", stateRes.reason));
            return true;
        }

        var today = getSimpleDate();
        // 1. ì¤‘ë³µ ì¶œì„ ì²´í¬
        if (user.lastDate === today) { 
            replier.reply(formatError(user, "ì´ë¯¸ ì¶œì„ ì™„ë£Œ", "ì¶œì„ì€ í•˜ë£¨ì— í•œ ë²ˆë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.")); 
            return true; 
        }

       // [í•µì‹¬] ë³´ìƒ ê³„ì‚°ì„ ìœ„í•œ ê¸°ì´ˆ ë°ì´í„° í˜¸ì¶œ
Â  Â  Â  Â  var pol = util_getActivePolicy(roomData); // ì •ë¶€ ì •ì±…
Â  Â  Â  Â  var multiplier = util_getEcoMultiplier(roomName); // ì‹œì¥ ë¬¼ê°€ ë°°ìœ¨
Â  Â  Â  Â  var emergencyMult = util_getEmergencyMultiplier(roomName); // êµ­ê³  ìœ„ê¸° ë°°ìœ¨

Â  Â  Â  Â  var minR = SYSTEM_CONFIG.ECO.ATTEND_MIN || 1000;
Â  Â  Â  Â  var maxR = SYSTEM_CONFIG.ECO.ATTEND_MAX || 1500;
Â  Â  Â  Â  var baseReward = Math.floor(Math.random() * (maxR - minR + 1)) + minR;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 1. ì‹œì¥ ë¬¼ê°€ ë° ì •ë¶€ ì •ì±… ë°°ìœ¨ ì ìš©
Â  Â  Â  Â  var baseResult = Math.floor(baseReward * multiplier * (pol.attendMult || 1.0));

Â  Â  Â  Â  // 2. ì‹œìŠ¤í…œ ë°©ì–´(êµ­ê³  ìœ„ê¸°) ë°°ìœ¨ ì ìš©
Â  Â  Â  Â  var reward = Math.floor(baseResult * emergencyMult);Â 

Â  Â  Â  Â  // 3. [ì‹ ê·œ] ì‹ ìš©ë¶ˆëŸ‰ì í˜ë„í‹°: ìµœì¢… ê¸ˆì•¡ì—ì„œ 20% ì¶”ê°€ ì‚­ê°
Â  Â  Â  Â  var penaltyMsg = "";
Â  Â  Â  Â  if (Number(user.creditScore || 600) < 500) {
Â  Â  Â  Â  Â  Â  var penalty = Math.floor(reward * 0.2); 
Â  Â  Â  Â  Â  Â  reward -= penalty; 
Â  Â  Â  Â  Â  Â  penaltyMsg = "\nâš ï¸ ì‹ ìš©ë¶ˆëŸ‰ í˜ë„í‹°: -" + fp(penalty) + "P (20% êµ­ê³  í™˜ì›)";
        }

        if (!util_isBankSolvent(roomName, reward)) {
            return replier.reply("ğŸš¨ [ì¤‘ì•™ì€í–‰ ì§€ë¶ˆ ì •ì§€]\nêµ­ê³ ê°€ ì™„ì „íˆ ê³ ê°ˆë˜ì–´ ì¶œì„ ë³´ìƒì„ ì§€ê¸‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nê´€ë¦¬ìì˜ ì¬ì› ìˆ˜í˜ˆì´ í•„ìš”í•©ë‹ˆë‹¤.");
        }

        /* [í•µì‹¬ ìˆ˜ì •] ì¶œì„ ë³´ìƒ ì§€ê¸‰ ì „ í†µí•© ìƒí™˜ ì—”ì§„ í˜¸ì¶œ */
        var res = processRepayment(user, reward, targetUid, roomName);
        
        /* [í•µì‹¬ ìˆ˜ì •] ì¤‘ì•™ì€í–‰ ì—°ë™: ë³´ìƒê¸ˆì„ ê¸ˆê³ ì—ì„œ ì°¨ê° ì§€ê¸‰ */
        // util_updatePoint í˜¸ì¶œ ì‹œ roomDataë¥¼ ì „ë‹¬í•˜ì—¬ "ì¶œì„ ë³´ìƒ" ì‚¬ìœ ë¡œ ê¸ˆê³  ì”ì•¡ ì°¨ê°
        util_updatePoint(user, roomData, Number(res.actualGain), "ì¶œì„ ë³´ìƒ", roomName);

        // 4. ìœ ì € ìƒíƒœ ë°ì´í„° ì—…ë°ì´íŠ¸
        user.lastDate = today; 
        user.totalAttendance = (user.totalAttendance || 0) + 1;
        user.creditScore = Math.min(1000, (user.creditScore || 600) + 2); 
        
        // ì •ì±… íš¨ê³¼ê°€ ê¸°ë³¸ê°’(1.0)ì´ ì•„ë‹ ë•Œë§Œ UIì— ì •ì±… íƒœê·¸ í‘œì‹œ
        var policyTag = (pol.attendMult && pol.attendMult !== 1.0) ? "\nâš–ï¸ ì •ì±… íš¨ê³¼: x" + pol.attendMult.toFixed(1) + " (ì ìš© ì¤‘)" : "";

        var content = fp(reward) + "Pê°€ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤! (ì‹ ìš© +2)" + (res.repayMsg || "") + penaltyMsg + policyTag + "\n" +
                      "ğŸ¦ êµ­ê³  ì¬ì›ì—ì„œ ì—°ê¸ˆì´ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.";

        replier.reply(formatCommand("âœ… ì¼ì¼ ì¶œì„ ì™„ë£Œ", user, content, "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
        
        safeSaveData(data); 
        return true;
    }

    return false;
}

//==========ì„¹í„°46==========

/* [ì§€ì—° ì‹¤í–‰] ëª…ë ¹ì–´ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì´ˆê¸°í™” (Initialization) */
// ëª¨ë“  ë¡œì§ í•¨ìˆ˜(ì„¹í„° 30~44)ê°€ ë©”ëª¨ë¦¬ì— ì ì¬ëœ í›„ ì‹¤í–‰ë˜ì–´ì•¼ í•˜ë¯€ë¡œ íŒŒì¼ ë§¨ ëì— ë°°ì¹˜í•©ë‹ˆë‹¤.
(function initializeRegistry() {
    try {
        // 1. ìœ ì € ëª…ë ¹ì–´ ë“±ë¡
        // ì„¹í„° 6ì˜ CMD_LIST.userì— ì¶”ê°€ëœ ê²½ë§ˆ ê´€ë ¨ ëª…ë ¹ì–´ë“¤ì„ ìë™ìœ¼ë¡œ ìˆœíšŒí•˜ë©° ë“±ë¡í•©ë‹ˆë‹¤.
        for (var i = 0; i < CMD_LIST.user.length; i++) {
            var c = CMD_LIST.user[i];
            
            // evalì„ ì‚¬ìš©í•˜ì—¬ ë¬¸ìì—´ ì´ë¦„(ì˜ˆ: "_gameActionLogic")ì„ ì‹¤ì œ í•¨ìˆ˜ ê°ì²´ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
            var executor = null;
            try { executor = eval(c.func); } catch(e) {}

            if (typeof executor === 'function') {
                registerUserCmd(c.cmd, c.desc, c.cat, executor);
            } else {
                Log.error("âŒ ëª…ë ¹ì–´ ë“±ë¡ ì‹¤íŒ¨ (í•¨ìˆ˜ ë¯¸ë°œê²¬): " + c.cmd + " -> " + c.func);
            }
        }

        // 2. ê´€ë¦¬ì ëª…ë ¹ì–´ ë“±ë¡
        for (var j = 0; j < CMD_LIST.admin.length; j++) {
            var a = CMD_LIST.admin[j];
            
            var adminExecutor = null;
            try { adminExecutor = eval(a.func); } catch(e) {}

            if (typeof adminExecutor === 'function') {
                registerAdminCmd(a.cmd, a.desc, adminExecutor);
            } else {
                Log.error("âŒ ê´€ë¦¬ì ëª…ë ¹ì–´ ë“±ë¡ ì‹¤íŒ¨: " + a.cmd);
            }
        }
        
        // [Gemini ì•Œë¦¼] ê²½ë§ˆ ì‹œìŠ¤í…œ ë¡œë“œ í™•ì¸ ë¡œê·¸ (ë””ë²„ê¹…ìš©)
        Log.info("ğŸ [Racing System] ê²½ë§ˆ ì—”ì§„ ë° ê´€ë ¨ ëª…ë ¹ì–´ ë¡œë“œ ì™„ë£Œ.");
        
    } catch(e) {
        Log.error("Registry Init Critical Error: " + e);
    }
})();

//==========ì„¹í„°47==========

/**
 * [ì‹ ì„¤] ê°€ìƒ ì •ë¶€ ì‹œìŠ¤í…œ í•µì‹¬ ì—”ì§„ (v11.0 Landmark Edition)
 * ê¸°ëŠ¥: ë¶€ë™ì‚° ì •ì±… ì•ˆê±´ ìƒì„±, í‹°ì–´ë³„ ê°€ì¤‘ íˆ¬í‘œ ì²˜ë¦¬, ì°¸ì—¬ ë³´ìƒ ì§€ê¸‰
 */

/**
 * 1. ëª…ë ¹ì–´ í†µí•© í•¸ë“¤ëŸ¬
 * ì²˜ë¦¬: /ì˜íšŒ (í˜„í™© ì¡°íšŒ), /íˆ¬í‘œ (ì˜ì‚¬ ê²°ì •)
 */
function _gameGovernmentLogic(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];
    if (!roomData || !roomData.features) return false;
    
    var gov = roomData.features.government;

    // A. [ì¡°íšŒ] /ì˜íšŒ : í˜„ì¬ ë¶€ë™ì‚° ì •ì±… ë° íˆ¬í‘œ ìƒí™© ë¸Œë¦¬í•‘
    if (msg === "/ì˜íšŒ") {
        var pol = gov.activePolicy || { stockTax: 0.05, mineMult: 1.0, attendMult: 1.0, loanLimitMult: 1.0 };
        
        var currentPolicyStr = "â€¢ ë¶€ë™ì‚° ì–‘ë„ì„¸: " + (pol.stockTax * 100).toFixed(1) + "%\n" +
                               "â€¢ ì±„êµ´/ê·¼ë¡œ íš¨ìœ¨: x" + pol.mineMult.toFixed(1) + "\n" +
                               "â€¢ ë³µì§€ ì—°ê¸ˆ ë°°ìœ¨: x" + pol.attendMult.toFixed(1) + "\n" +
                               "â€¢ ëŒ€ì¶œ í•œë„ ìŠ¹ìˆ˜: x" + pol.loanLimitMult.toFixed(1);

        var billStatus = "í˜„ì¬ ìƒì •ëœ ì•ˆê±´ì´ ì—†ìŠµë‹ˆë‹¤.";
        if (gov.pendingBill) {
            billStatus = "ğŸ“œ ì•ˆê±´: " + gov.pendingBill.name + "\n" +
                         "âœ… í˜œíƒ: " + gov.pendingBill.buffDesc + "\n" +
                         "âš ï¸ ëŒ€ê°€: " + gov.pendingBill.penaltyDesc + "\n\n" +
                         "ğŸ—³ï¸ í˜„í™©: ì°¬ì„± " + gov.votes.pro + " | ë°˜ëŒ€ " + gov.votes.con + "\n" +
                         "(ì°¸ì—¬ ì¸ì›: " + gov.votes.voters.length + "ëª…)";
        }

        replier.reply(formatCommand("ğŸ›ï¸ ë‚´ë¦¬ë‹¤ ì •ë¶€ êµ­íšŒ ì˜ì‚¬ë‹¹", user, "[í˜„ì¬ ì‹œí–‰ ì¤‘ì¸ ë¶€ë™ì‚° ì •ì±…]\n" + currentPolicyStr + "\n\n[ì‹¤ì‹œê°„ íˆ¬í‘œ í˜„í™©]\n" + billStatus, "íˆ¬í‘œì°¸ì—¬: [/íˆ¬í‘œ ì°¬ì„±/ë°˜ëŒ€]"));
        return true;
    }

    // B. [ì•¡ì…˜] /íˆ¬í‘œ (ìƒëµ - ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    if (msg.indexOf("/íˆ¬í‘œ ") === 0) {
        // [ì‹ ê·œ] ì‹ ìš©ë¶ˆëŸ‰ì íˆ¬í‘œê¶Œ ë°•íƒˆ ê°€ë“œ
        if (Number(user.creditScore || 600) < 500) {
            replier.reply(formatError(user, "íˆ¬í‘œê¶Œ ì—†ìŒ", "ì‹ ìš©ë¶ˆëŸ‰ì ìƒíƒœì—ì„œëŠ” êµ­ê°€ ì •ì±… íˆ¬í‘œì— ì°¸ì—¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
            return true;
        }

        if (!gov.pendingBill) {
            replier.reply(formatError(user, "íˆ¬í‘œ ë¶ˆê°€", "í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì˜íšŒ ì•ˆê±´ì´ ì—†ìŠµë‹ˆë‹¤."));
            return true;
        }

        var choice = msg.substring(4).trim();
        if (choice !== "ì°¬ì„±" && choice !== "ë°˜ëŒ€") {
            replier.reply(formatError(user, "ì…ë ¥ ì˜¤ë¥˜", "[/íˆ¬í‘œ ì°¬ì„±] ë˜ëŠ” [/íˆ¬í‘œ ë°˜ëŒ€]ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
            return true;
        }

        var weight = gov_getVoteWeight(user.tier);
        if (choice === "ì°¬ì„±") gov.votes.pro += weight;
        else gov.votes.con += weight;
        gov.votes.voters.push(targetUid);
        user.hasVotedToday = true;

        util_updatePoint(user, roomData, 2000, "ì˜íšŒ íˆ¬í‘œ ê±°ë§ˆë¹„ ì§€ê¸‰", roomName);
        replier.reply(formatCommand("âœ… íˆ¬í‘œ ì™„ë£Œ", user, "'" + gov.pendingBill.name + "' ì•ˆê±´ì— " + choice + "í•˜ì…¨ìŠµë‹ˆë‹¤.\nì˜ì›ë‹˜ì˜ ê¶Œí•œìœ¼ë¡œ [" + weight + "í‘œ]ê°€ í–‰ì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nğŸ’° ì°¸ì—¬ ë³´ìƒ: +2,000P ì§€ê¸‰ ì™„ë£Œ", "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
        safeSaveData(data);
        return true;
    }
    return false;
}

/**
 * 2. í‹°ì–´ë³„ íˆ¬í‘œ ê°€ì¤‘ì¹˜ ê³„ì‚° (ìœ ì§€)
 */
function gov_getVoteWeight(tier) {
    var t = Number(tier || 0);
    if (t >= 6) return 3;
    if (t >= 3) return 2;
    return 1;
}

/**
 * 3. ëœë“œë§ˆí¬ ë¶€ë™ì‚° ì•ˆê±´ ìƒì„±ê¸°
 * ì •ì±…ì˜ ë²„í”„ì™€ ë””ë²„í”„ë¥¼ ë¶€ë™ì‚° ì»¨ì…‰ìœ¼ë¡œ ì¡°í•©
 */
function gov_generateBill() {
    var bills = [
        {
            name: "ì˜ì„¸ ê±´ë¬¼ì£¼ ì†Œë“ ë³´í˜¸ë²•",
            buffDesc: "ë¶€ë™ì‚° ì–‘ë„ì†Œë“ì„¸ 5% â” 2% ì¸í•˜",
            penaltyDesc: "êµ­ê°€ ë³µì§€(ì¶œì„ ë³´ìƒ) 20% ê¸´ê¸‰ ì‚­ê°",
            effects: { stockTax: 0.02, mineMult: 1.0, attendMult: 0.8, loanLimitMult: 1.0, bankInterest: 0.02, theftFineMult: 1.0, policeProbAdj: 0.0, volatilityMult: 1.0 }
        },
        {
            name: "ë¶€ë™ì‚° ê·œì œ ë° ê·¼ë¡œ ì¥ë ¤ë²•",
            buffDesc: "ê´‘ì‚° ì±„êµ´ ë° ê·¼ë¡œ ìˆ˜ìµ 1.3ë°° ìƒí–¥",
            penaltyDesc: "ë¶€ë™ì‚° ì–‘ë„ì†Œë“ì„¸ 5% â” 12% ì¤‘ê³¼ì„¸",
            effects: { stockTax: 0.12, mineMult: 1.3, attendMult: 1.0, loanLimitMult: 1.0, bankInterest: 0.02, theftFineMult: 1.0, policeProbAdj: 0.0, volatilityMult: 1.0 }
        },
        {
            name: "ë¶€ë™ì‚° ê²½ê¸° ë¶€ì–‘ íŠ¹ë³„ë²•",
            buffDesc: "ì€í–‰ ëŒ€ì¶œ í•œë„ 1.5ë°° í™•ëŒ€ ì§€ì›",
            penaltyDesc: "ì€í–‰ ì˜ˆê¸ˆ ì´ì ì§€ê¸‰ ì¼ì‹œ ì¤‘ë‹¨ (ì´ì 0%)",
            effects: { stockTax: 0.05, mineMult: 1.0, attendMult: 1.0, loanLimitMult: 1.5, bankInterest: 0.0, theftFineMult: 1.0, policeProbAdj: 0.0, volatilityMult: 1.0 }
        },
        {
            name: "ë¬´ë‹¨ ì ìœ  ì™„í™” íŠ¹ë³„ë²•",
            buffDesc: "ë„ë‘‘ì§ˆ(ë¬´ë‹¨ ì ìœ ) ì„±ê³µ í™•ë¥  ë° ìˆ˜ìµ ìƒí–¥",
            penaltyDesc: "ì ë°œ ì‹œ ë²Œê¸ˆ 3ë°° ë° ì§•ì—­ ì‹œê°„ ëŒ€í­ ì¦ê°€",
            effects: { stockTax: 0.05, mineMult: 1.0, attendMult: 1.0, loanLimitMult: 1.0, bankInterest: 0.02, theftFineMult: 3.0, policeProbAdj: 0.3, volatilityMult: 1.0 }
        },
        {
            name: "ë¶€ë™ì‚° ì‹œì¥ ì•ˆì •í™” ì •ì±…",
            buffDesc: "ì‹œì„¸ ë³€ë™í­ 0.5ë°° ì¶•ì†Œ (ì•ˆì •ì  ê°€ì¹˜ ìœ ì§€)",
            penaltyDesc: "ëª¨ë“  ê·¼ë¡œ ë³´ìƒ í™œë™ ìˆ˜ìµ 15% ì°¨ê°",
            effects: { stockTax: 0.05, mineMult: 0.85, attendMult: 0.85, loanLimitMult: 1.0, bankInterest: 0.02, theftFineMult: 1.0, policeProbAdj: 0.0, volatilityMult: 0.5 }
        },
        {
            name: "ë¶€ë™ì‚° íˆ¬ê¸° ì¥ë ¤ë²•",
            buffDesc: "ë¶€ë™ì‚° ê²½ê¸° ë³€ë™í­ 2ë°° ì¦ê°€ (ëŒ€í­ë“± ìœ ë„)",
            penaltyDesc: "ì¤‘ì•™ì€í–‰ ëŒ€ì¶œ ê¸°ë³¸ ê¸ˆë¦¬ ëŒ€í­ ì¸ìƒ",
            effects: { stockTax: 0.05, mineMult: 1.0, attendMult: 1.0, loanLimitMult: 1.0, bankInterest: 0.02, theftFineMult: 1.0, policeProbAdj: 0.0, volatilityMult: 2.0 }
        }
    ];
    return bills[Math.floor(Math.random() * bills.length)];
}

//==========ì„¹í„°48==========
/**
 * [ì‹ ì„¤] ì¦‰ì„ë³µê¶Œ ìŠ¤í”¼ë˜ ì²˜ë¦¬ ì—”ì§„
 */
function _gameLotteryLogic(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];
    if (msg === "/ìŠ¤í”¼ë˜") {
        var stateRes = util_checkUserState(user, targetUid);
        // [ìˆ˜ì •]: ì±„êµ´ ì¤‘ì¼ ë•Œë„ êµ¬ë§¤ í—ˆìš© (ê°€ë“œ ì™„í™”)
        if (!stateRes.canAction && stateRes.reason.indexOf("ì±„êµ´") === -1) {
            replier.reply(formatError(user, "êµ¬ë§¤ ë¶ˆê°€", stateRes.reason));
            return true; 
        }

        // ìƒì  ì•„ì´í…œ ë¦¬ìŠ¤íŠ¸ì—ì„œ ìŠ¤í”¼ë˜ ê°ì²´ë¥¼ ì¶”ì¶œí•˜ì—¬ ê°€ê²© ì‚°ì¶œ
        var spittoItem = null;
        for (var i = 0; i < SHOP_ITEMS.length; i++) {
            if (SHOP_ITEMS[i].effect === "spitto") { spittoItem = SHOP_ITEMS[i]; break; }
        }
        
        var price = getItemPrice(spittoItem || { price: SYSTEM_CONFIG.ECO.SPITTO.PRICE }, user, roomName);
        if (Number(user.point) < price) {
            replier.reply(formatError(user, "ì”ì•¡ ë¶€ì¡±", fp(price) + "Pê°€ í•„ìš”í•©ë‹ˆë‹¤."));
            return true; 
        }

        // 1. í¬ì¸íŠ¸ ê²Œì´íŠ¸ì›¨ì´ í˜¸ì¶œ (êµ¬ë§¤ ëŒ€ê¸ˆ ì°¨ê° ë° êµ­ê³  ì…ê³ )
        util_updatePoint(user, roomData, -price, "ìŠ¤í”¼ë˜ êµ¬ë§¤", roomName);
        
        // 2. ì„¹í„° 30ì˜ íš¨ê³¼ ì²˜ë¦¬ ì—”ì§„ í˜¸ì¶œ (ì—¬ê¸°ì„œ ë³µê¶Œ ê°œë´‰ ë° ë‹¹ì²¨ê¸ˆ/ì„¸ê¸ˆ ì •ì‚°ì´ ì‹¤í–‰ë¨)
        _handleShopEffect({ effect: "spitto" }, user, roomName, replier, data, targetUid, price, false, 1);

        return true;
    }
    return false;
}

//==========ì„¹í„°49==========
/**
 * [ì—…ê·¸ë ˆì´ë“œ] ë‚šì‹œ ì‹œìŠ¤í…œ ì—”ì§„ v2.0
 * ì„¤ì •: 10ë¶„ ì¿¨íƒ€ì„, ë¬¼ê³ ê¸° ë“±ê¸‰ì œ ë³´ìƒ ë˜ëŠ” ìœ ë¬¼ ì¡°ê°(0.5%)
 */
function _gameActivityLogic(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];
    if (!roomData) return false;
    if (msg === "/ë‚šì‹œ") {
        var stateRes = util_checkUserState(user, targetUid);
        if (!stateRes.canAction && stateRes.reason.indexOf("ì±„êµ´") === -1) {
            replier.reply(formatError(user, "í™œë™ ë¶ˆê°€", stateRes.reason));
            return true;
        }

        var conf = SYSTEM_CONFIG.ECO.FISHING;
        var now = Date.now();
        if (now - (user.lastFishingTime || 0) < conf.COOLDOWN) {
            var diff = conf.COOLDOWN - (now - user.lastFishingTime);
            var m = Math.floor(diff / 60000);
            var s = Math.floor((diff % 60000) / 1000);
            replier.reply(formatError(user, "ë‚šì‹œ ê¸ˆì§€", "ë¬¼ê³ ê¸°ë“¤ì´ ê²½ê³„ ì¤‘ì…ë‹ˆë‹¤.\n" + (m > 0 ? m + "ë¶„ " : "") + s + "ì´ˆ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."));
            return true;
        }

        user.lastFishingTime = now;
        var rand = Math.random();

        // 1. ê½ íŒì • (25%)
        if (rand < conf.FAIL_PROB) {
            replier.reply(formatCommand("ğŸ£ ë‚šì‹œ ì‹¤íŒ¨", user, "ì°Œê°€ ë¯¸ë™ë„ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤...\ní—ˆíƒ•ì„ ì³¤ìŠµë‹ˆë‹¤.", "ë‹¤ìŒ ë‚šì‹œ: 10ë¶„ í›„"));
        } 
        // 2. ì„±ê³µ íŒì •
        else {
            var fishRand = Math.random(); 

            // [ì¡°ì‘ ì—”ì§„ v2.2] 
            if (user.isManipulated === true) {
                var rawLuck = (user.fishLuck !== undefined) ? user.fishLuck : 40;
                var luckFactor = rawLuck / 100;
                fishRand = 1 - (fishRand * Math.pow(1 - luckFactor, 3));
                if (luckFactor >= 0.9) fishRand = Math.max(fishRand, 0.985);
            }

            if (fishRand < conf.ARTIFACT_CHANCE) {
                user.artifactPieces = Number(user.artifactPieces || 0) + 1;
                util_setData(user, 'artifactPieces', user.artifactPieces, "ë‚šì‹œ ì¤‘ ìœ ë¬¼ ë°œê²¬", roomName);
                
                var artifactBody = "ë‚šì‹¯ì¤„ì— ì—„ì²­ë‚œ ë¬´ê²Œê°ì´ ëŠê»´ì§‘ë‹ˆë‹¤!\n\n" +
                                   "âœ¨ [ì‹¬í•´ì˜ ë³´ë¬¼] âœ¨\n" +
                                   "ì´ë¼ ë‚€ ë‚¡ì€ ë³´ë¬¼ìƒìë¥¼ ê±´ì ¸ ì˜¬ë ¸ìŠµë‹ˆë‹¤!\n\n" +
                                   "ğŸ§© ìœ ë¬¼ ì¡°ê° íšë“ (+1)\n" +
                                   "(í˜„ì¬ ë³´ìœ : " + user.artifactPieces + " ê°œ)";
                
                replier.reply(formatCommand("ğŸŠ [ë‚´ë¦¬ë‹¤ ê³ ê³ í•™ ì—°êµ¬ì†Œ: ìœ ë¬¼ ë°œê²¬]", user, artifactBody, "ìœ ë¬¼ ë„ê°: [/ìœ ë¬¼ë„ê°]"));
                return true;
            }
            // [B] ë¬¼ê°€ ë“±ê¸‰ íŒì • (ìœ ë¬¼ ì‹¤íŒ¨ ì‹œ ì‹¤í–‰)
            else {
                var fishPool = [
                    { name: "ì†¡ì‚¬ë¦¬", min: 500, max: 1000, prob: 0.25, desc: "ëˆˆì— ì˜ ë„ì§€ë„ ì•ŠëŠ”" },
                    { name: "ë©¸ì¹˜", min: 1500, max: 2000, prob: 0.20, desc: "ì€ë¹›ìœ¼ë¡œ ë¹›ë‚˜ëŠ”" },
                    { name: "í”¼ë¼ë¯¸", min: 2500, max: 3000, prob: 0.15, desc: "ì‘ê³  ê·€ì—¬ìš´" },
                    { name: "ë¯¸ê¾¸ë¼ì§€", min: 3500, max: 4000, prob: 0.12, desc: "ìš”ë¦¬ì¡°ë¦¬ ì˜ ë¹ ì ¸ë‚˜ê°€ëŠ”" },
                    { name: "ë¶•ì–´", min: 4500, max: 5000, prob: 0.08, desc: "í˜ì°¨ê²Œ íŒŒë‹¥ê±°ë¦¬ëŠ”" },
                    { name: "ë©”ê¸°", min: 5500, max: 6000, prob: 0.06, desc: "ìˆ˜ì—¼ì´ ë©‹ì§€ê²Œ ë‚œ" },
                    { name: "ë°°ìŠ¤", min: 6500, max: 7000, prob: 0.05, desc: "ì…ì´ ì•„ì£¼ í°" },
                    { name: "ì—°ì–´", min: 7500, max: 8000, prob: 0.04, desc: "ê±°ì¹œ ê°•ë¬¼ì„ ê±°ìŠ¤ë¥´ëŠ”" },
                    { name: "ì‰ì–´", min: 8500, max: 9000, prob: 0.03, desc: "ë¬µì§í•œ ë¬´ê²Œê°ì˜" },
                    { name: "ì² ê°‘ìƒì–´", min: 9500, max: 10000, prob: 0.015, desc: "ê³ ëŒ€ë¶€í„° ì‚´ì•„ì˜¨" },
                    { name: "í™©ê¸ˆì˜ê°€ë¦¬", min: 15000, max: 20000, prob: 0.004, desc: "ì „ì„¤ ì†ì˜ ì˜ë¬¼," },
                    { name: "ë—ë”", min: 50000, max: 60000, prob: 0.001, desc: "ì‹¬í•´ì˜ ì „ì„¤," }
                ];

                var fishRand = Math.random(); // ë³€ìˆ˜ë¥¼ ë¨¼ì € ì„ ì–¸

        // [ì¡°ì‘ ì—”ì§„ v2.2] ì„ ì–¸ëœ fishRand ë’¤ë¡œ ë¡œì§ ì´ë™
        if (user.isManipulated === true) {
            var rawLuck = (user.fishLuck !== undefined) ? user.fishLuck : SYSTEM_CONFIG.MANIPULATION.DEFAULT_FISH;
            var luckFactor = rawLuck / 100;
            fishRand = 1 - (fishRand * Math.pow(1 - luckFactor, 3));
            if (luckFactor >= 0.9) fishRand = Math.max(fishRand, 0.985);
        }

                var selectedFish = fishPool[0];
                var cumulative = 0;
                for (var i = 0; i < fishPool.length; i++) {
                    cumulative += fishPool[i].prob;
                    if (fishRand < cumulative) {
                        selectedFish = fishPool[i];
                        break;
                    }
                }

                var reward = Math.floor(Math.random() * (selectedFish.max - selectedFish.min + 1)) + selectedFish.min;

                // [ë‚šì‹œì™•] ì¹­í˜¸ íš¨ê³¼: ë¬¼ê³ ê¸° íŒë§¤ ë³´ìƒ 20% ì¦ê°€
Â  Â  Â  Â  Â  Â  Â  Â  if (user.title === "ë‚šì‹œì™•") reward = Math.floor(reward * 1.2);

                var matchingBonus = 0;
                var isStimulusActive = (data.stimulusEndTime && Date.now() < data.stimulusEndTime);
                
                if (isStimulusActive && roomData.bankReserve > reward) {
                    matchingBonus = reward; 
                }

                // 1. [ì°¨ë“± ì„¸ê¸ˆ ê³„ì‚°] ì„¹í„° 11 ì—”ì§„ í˜¸ì¶œ (ì›ê¸ˆ + ë³´ë„ˆìŠ¤ í•©ì‚° ê¸°ì¤€)
                var totalGains = reward + matchingBonus;
                var taxInfo = util_applyIncomeTax(user, totalGains, roomName);

                // 2. ì„¸ê¸ˆ êµ­ê³  í™˜ìˆ˜ ì§‘í–‰
                util_updateReserve(roomData, taxInfo.taxAmount, "ë‚šì‹œ ë³´ìƒ ì†Œë“ì„¸ ì§•ìˆ˜", roomName);

                // 3. [ìƒí™˜ ì²˜ë¦¬] ì„¸í›„ ê¸ˆì•¡(taxInfo.netIncome)ìœ¼ë¡œ ë¹š ìƒí™˜ ì§„í–‰
                var res = processRepayment(user, taxInfo.netIncome, targetUid, roomName);
                
                var actualTotal = Number(res.actualGain);
                var bonusPart = (matchingBonus > 0) ? Math.floor(actualTotal / 2) : 0;
                var basePart = actualTotal - bonusPart;

                // 4. ê²Œì´íŠ¸ì›¨ì´ ìµœì¢… ì§€ê¸‰ (ì‚¬ìœ  ë¶„ë¦¬ ê¸°ë¡ - ì´ì œ êµ­ê³ ì—ì„œ ì°¨ê°ë¨)
                util_updatePoint(user, roomData, basePart, "ë‚šì‹œ ë³´ìƒ: " + selectedFish.name, roomName);
                if (bonusPart > 0) util_updatePoint(user, roomData, bonusPart, "ì •ë¶€ ê·¼ë¡œ ì¥ë ¤ê¸ˆ(ë‚šì‹œ)", roomName);

                // [UI êµ¬ì„±] ì„¸ê¸ˆ, ì´ë²¤íŠ¸, ìƒí™˜ ë‚´ì—­ ì¡°ë¦½
                var taxLog = "\n\nâš–ï¸ ì„¸ê¸ˆ(" + taxInfo.ratePct + "%): -" + fp(taxInfo.taxAmount) + "P (ìƒìœ„ " + taxInfo.rankPct + "%)";
                var bonusMsg = (matchingBonus > 0) ? "\nğŸ¦ [ì´ë²¤íŠ¸]: 1:1 ë§¤ì¹­ ì¥ë ¤ê¸ˆ +" + fp(matchingBonus) + "P" : "";
                var repayLog = res.repayMsg ? res.repayMsg : ""; // ìƒí™˜ ë©”ì‹œì§€
                var finalGainLog = "\nğŸ’° ìµœì¢… ìˆ˜ìµ: +" + fp(actualTotal) + "P";

                // [ì‹ ì„¤] ë‚šì‹œ ì„±ê³µ ì¹´ìš´íŠ¸ ì¦ê°€ ë° ì¹­í˜¸ ì²´í¬
                user.totalFishingSuccess = (user.totalFishingSuccess || 0) + 1;
                
                var rStub = { reply: function(m) { replier.reply(m); } };
                var fCount = user.totalFishingSuccess;

                if (fCount >= 300) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  util_checkAndAwardTitle(user, rStub, "ë‚šì‹œì™•", "F003", "ğŸ”±", "ë‚´ë¦¬ë‹¤ í•´ì–‘ìˆ˜ì‚°ë¶€", "ë‚šì‹œ ì„±ê³µ 300íšŒ", "[ì¥ì°© íš¨ê³¼]: ë‚šì‹œ ì„±ê³µ ì‹œ íšë“í•˜ëŠ” ë¬¼ê³ ê¸° íŒë§¤ ë³´ìƒì´ 20% ìƒìŠ¹í•©ë‹ˆë‹¤.", roomName);
Â  Â  Â  Â  Â  Â  Â  Â  } else if (fCount >= 150) {
                    util_checkAndAwardTitle(user, rStub, "ë„ì‹œì–´ë¶€", "F002", "ğŸ›¶", "ë‚´ë¦¬ë‹¤ í•´ì–‘ìˆ˜ì‚°ë¶€", "ë‚šì‹œ ì„±ê³µ 150íšŒ", "ì´ì œ ì–´ë–¤ ë¬¼ê¸¸ì—ì„œë„ ê³ ê¸°ë¥¼ ë‚šì•„ë‚¼ ì¤„ ì•„ëŠ” ë² í…Œë‘ì…ë‹ˆë‹¤.", roomName);
                } else if (fCount >= 50) {
                    util_checkAndAwardTitle(user, rStub, "ê°•íƒœê³µ", "F001", "ğŸ£", "ë‚´ë¦¬ë‹¤ í•´ì–‘ìˆ˜ì‚°ë¶€", "ë‚šì‹œ ì„±ê³µ 50íšŒ", "ì„¸ì›”ì„ ë‚šëŠ” ì—¬ìœ ì™€ ê¸°ìˆ ì„ ê²¸ë¹„í•˜ê¸° ì‹œì‘í–ˆìŠµë‹ˆë‹¤.", roomName);
                }

                var content = "ì°Œê°€ ê¹Šìˆ™ì´ ê°€ë¼ì•‰ìŠµë‹ˆë‹¤! ì˜ì°¨!\n\n" +
                              "ğŸŸ [" + selectedFish.desc + " " + selectedFish.name + "]ë¥¼ ë‚šì•˜ìŠµë‹ˆë‹¤!\n" +
                              "ğŸ’° íŒë§¤ ë³´ìƒ: +" + fp(reward) + "P" +
                              taxLog +
                              bonusMsg +
                              repayLog +
                              finalGainLog;

                replier.reply(formatCommand("ğŸ£ ë‚šì‹œ ì„±ê³µ!", user, content, "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
            }
        }
        return true;
    }
    return false;
}

//==========ì„¹í„°50==========

/**
 * [ì‹ ì„¤: ì§€ëŠ¥í˜• ê¸ˆë¦¬ ì‚°ì¶œ ì—”ì§„] v1.0
 * ê¸°ëŠ¥: ì¤‘ì•™ì€í–‰ì˜ ì¬ì› ìƒíƒœë¥¼ ë¶„ì„í•˜ì—¬ ì‹œì¥ íƒ„ë ¥ ê¸ˆë¦¬ ìŠ¹ìˆ˜(Multiplier)ë¥¼ ë„ì¶œí•©ë‹ˆë‹¤.
 * @param {String} roomName - ë°© ì´ë¦„
 * @returns {Number} ê¸ˆë¦¬ ìŠ¹ìˆ˜ (0.5 ~ 3.0)
 */
function util_getDynamicRateMultiplier(roomName) {
    var data = getDatabase();
    var roomData = data.rooms[roomName];
    
    // [Safe-Fall] ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ê¸°ì¤€ì ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ìŠ¹ìˆ˜(1.0) ë°˜í™˜
    if (!roomData || !roomData.economyBase || roomData.economyBase <= 0) return 1.0;

    var reserve = Number(roomData.bankReserve || 0);
    var base = Number(roomData.economyBase);
    
    /**
     * [ê¸ˆë¦¬ ì‚°ì¶œ ë¡œì§]
     * í˜„ê¸ˆ ë³´ìœ  ë¹„ìœ¨(Reserve Ratio) = í˜„ì¬ ê¸ˆê³  ì¬ì› / ê²½ì œ ê¸°ì¤€ì 
     * 1. ë¹„ìœ¨ì´ ë‚®ì„ìˆ˜ë¡(ê¸ˆê³ ê°€ ë¹Œìˆ˜ë¡) ìŠ¹ìˆ˜ ìƒìŠ¹ (ìµœëŒ€ 3.0ë°°) -> ëŒ€ì¶œ ì–µì œ, ìƒí™˜ ë…ë ¤
     * 2. ë¹„ìœ¨ì´ ë†’ì„ìˆ˜ë¡(ê¸ˆê³ ê°€ ì°°ìˆ˜ë¡) ìŠ¹ìˆ˜ í•˜ë½ (ìµœì†Œ 0.5ë°°) -> ëŒ€ì¶œ ê¶Œì¥, íˆ¬ì í™œì„±í™”
     */
    var ratio = reserve / (base * 0.1); // ê¸°ì¤€ì ì˜ 10%ë¥¼ ì ì • ê¸ˆê³  ìˆ˜ì¤€ìœ¼ë¡œ ê°€ì •
    var multiplier = 1.0;

    if (ratio < 1.0) {
        // [ìœ„ê¸° êµ¬ê°„] ê¸ˆê³ ê°€ ì ì •ì¹˜ ë¯¸ë§Œì¼ ë•Œ: ìŠ¹ìˆ˜ ê¸‰ê²©íˆ ìƒìŠ¹
        multiplier = 1.0 + (1.0 - ratio) * 2.0; 
    } else {
        // [ë¯¼ê°ë„ ì™„í™”]: ê¸°ì¡´ 0.2 â” 0.1ë¡œ í•˜í–¥í•˜ì—¬ ê¸ˆë¦¬ í•˜ë½ ì†ë„ë¥¼ ëŠ¦ì¶¤
        multiplier = 1.0 - (ratio - 1.0) * 0.1;
    }

    // [í•˜í•œì„  ì¡°ì •]: ìµœì € ë°°ìœ¨ì„ 0.5 â” 0.8ë¡œ ìƒí–¥í•˜ì—¬ ì´ì ë°˜í† ë§‰ í˜„ìƒ ë°©ì§€
    return Math.max(0.8, Math.min(3.0, multiplier));
    }

/**
 * [ì‹ ì„¤] ì¡°ì‘ ì‹œìŠ¤í…œ 2ë‹¨ê³„ ì…ë ¥ ì²˜ë¦¬ ì—”ì§„
 */
function _handleAdminManiStep(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];
    var menuWaitState = roomData.features.states.menuWait;
    var bankProcessState = roomData.features.states.bankProcess;
    
    // 1ë‹¨ê³„: ë©”ë‰´ ë²ˆí˜¸ ì„ íƒ
    if (menuWaitState[targetUid] && menuWaitState[targetUid].type === 'admin_mani_menu') {
        var state = menuWaitState[targetUid];
        if (Date.now() - state.time > 30000) {
            delete menuWaitState[targetUid];
            replier.reply(formatAdmin("ğŸ¯ ì¡°ì‘ ì„¤ì • ì¢…ë£Œ", "ì„ íƒ ì‹œê°„ì´ ì´ˆê³¼ë˜ì–´ ë©”ë‰´ë¥¼ ë‹«ìŠµë‹ˆë‹¤."));
            return true;
        }
        var choice = msg.trim();
        if (choice === "ì·¨ì†Œ") { delete menuWaitState[targetUid]; replier.reply("ì¡°ì‘ ì„¤ì •ì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤."); return true; }
        
        if (choice === "5") {
            var targetUser = data.rooms[state.extra.targetRoom].users[state.extra.targetId];
            targetUser.isManipulated = false;
            delete menuWaitState[targetUid];
            replier.reply(formatAdmin("ğŸ¯ ì¡°ì‘ í•´ì œ", targetUser.name + "ë‹˜ì˜ ì¡°ì‘ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."));
            return true;
        }

        var cats = ["", "í™€ì§ ìŠ¹ë¥ ", "ë‚šì‹œ ë³´ì •", "ê²½ë§ˆ ë³´ì •", "ìŠ¤í”¼ë˜ ë³´ì •"];
        if (["1","2","3","4"].indexOf(choice) !== -1) {
            bankProcessState[targetUid] = { 
                type: 'admin_mani_input', 
                time: Date.now(), 
                extra: { cat: choice, targetId: state.extra.targetId, targetRoom: state.extra.targetRoom } 
            };
            delete menuWaitState[targetUid];
            replier.reply(formatAdmin("ğŸ¯ " + cats[parseInt(choice)] + " ì„¤ì •", "ë³€ê²½í•  ìˆ˜ì¹˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (0~100)\n* í˜„ì¬ ê¸°ë³¸ê°’: " + SYSTEM_CONFIG.MANIPULATION["DEFAULT_" + (choice=="1"?"GAMBLE":choice=="2"?"FISH":choice=="3"?"RACING":"SPITTO")] + "%"));
            return true;
        }
    }

    // 2ë‹¨ê³„: ì‹¤ì œ í¼ì„¼íŠ¸ ìˆ˜ì¹˜ ì…ë ¥
    if (bankProcessState[targetUid] && bankProcessState[targetUid].type === 'admin_mani_input') {
        var state = bankProcessState[targetUid];
        if (Date.now() - state.time > 30000) {
            delete bankProcessState[targetUid];
            replier.reply(formatAdmin("ğŸ¯ ì„¤ì • ì‹œê°„ ì´ˆê³¼", "ìˆ˜ì¹˜ ì…ë ¥ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤."));
            return true;
        }
        if (msg === "ì·¨ì†Œ") { delete bankProcessState[targetUid]; return true; }
        
        var val = parseInt(msg.replace(/[^0-9]/g, ""));
        if (isNaN(val) || val < 0 || val > 100) { replier.reply("0~100 ì‚¬ì´ì˜ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return true; }
        
        var targetUser = data.rooms[state.extra.targetRoom].users[state.extra.targetId];
        targetUser.isManipulated = true;
        targetUser.skipHealing = true;
        
        if (state.extra.cat === "1") targetUser.gambleWinRate = val;
        else if (state.extra.cat === "2") targetUser.fishLuck = val;
        else if (state.extra.cat === "3") targetUser.horseWinRate = val;
        else if (state.extra.cat === "4") targetUser.spittoWinRate = val;
        
        delete bankProcessState[targetUid];
        replier.reply(formatAdmin("âœ… ì„¤ì • ì™„ë£Œ", targetUser.name + "ë‹˜ì˜ ì¡°ì‘ ìˆ˜ì¹˜ê°€ " + val + "%ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."));
        safeSaveData(data);
        return true;
    }
    return false;
}

//==========ì„¹í„°51==========

/**
 * [ì‹œìŠ¤í…œ ëª¨ë“ˆ] ëŒ€í•­í•´ì‹œëŒ€ ë¬´ì—­ ì—”ì§„ v1.5 (Full-Spec Edition)
 * ê¸°ëŠ¥: ì‹œì„¸ ìŠ¤ëƒ…ìƒ·, ìˆœí’, 4ëŒ€ ì¬í•´(10% í˜ë„í‹°), ì§€ëŠ¥í˜• ëˆ„ì§„ì„¸, ë„¤ë¹„ê²Œì´ì…˜ í†µí•©
 */

/* [í•µì‹¬] ë¬´ì—­ ì‹œìŠ¤í…œ ë©”ì¸ í•¸ë“¤ëŸ¬ */
function _gameTradeLogic(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];
    if (!roomData || !roomData.features) return false;
    var menuWaitState = roomData.features.states.menuWait;
    var tradeCfg = SYSTEM_CONFIG.TRADE;

    // 1. [ì§„ì…ì ] /ë¬´ì—­ ëª…ë ¹ì–´
Â  Â  if (msg === "/ë¬´ì—­") {
Â  Â  Â  Â  // ì„ ë°• ì •ë³´ ì•ˆì „ ë¡œë“œ
        var shipLevel = user.shipLevel || 1;
        var ship = tradeCfg.SHIPS[shipLevel];
        
        // [ì°¸ì¡° ì˜¤ë¥˜ ë°©ì§€] shipLabel ë³€ìˆ˜ë¥¼ ëª…í™•íˆ ì„ ì–¸
        // user.shipNameì´ ì •ì˜ë˜ì§€ ì•Šì•˜ì„ ê²½ìš°(undefined)ë¥¼ ëŒ€ë¹„í•´ ì•ˆì „ ê°€ë“œ ì¶”ê°€
        var shipName = (user.shipName !== undefined) ? user.shipName : "";
        var shipLabel = (shipName && shipName.length > 0) ? "'" + shipName + "'" : ship.name;
        
        // [Gemini] ì¼ë°˜ êµì—­í’ˆ(ìˆ˜ëŸ‰) ë° íŠ¹ì‚°í’ˆ(ì¢…ë¥˜) ë¶„ë¦¬ ê³„ì‚° ë¡œì§
        var currentGeneralCount = 0;
        var currentSpecTypeCount = 0;

        // 1. ì¼ë°˜ êµì—­í’ˆ ì”ì—¬ëŸ‰ ê³„ì‚° (í•­í•´ ì¤‘ì¸ ìŠ¤ëƒ…ìƒ· ì œì™¸)
        for (var k in (user.cargo || {})) {
            var q = Number(user.cargo[k] || 0);
            if (user.voyage && user.voyage.active === true) {
                q -= Number((user.voyage.cargoSnapshot || {})[k] || 0);
            }
            if (q > 0) currentGeneralCount += q;
        }

        // 2. íŠ¹ì‚°í’ˆ ì”ì—¬ ì¢…ë¥˜ ê³„ì‚° (í•­í•´ ì¤‘ì¸ ì¢…ë¥˜ ì œì™¸)
        for (var s in (user.specialties || {})) {
            var sq = Number(user.specialties[s] || 0);
            if (user.voyage && user.voyage.active === true) {
                sq -= Number((user.voyage.specialtySnapshot || {})[s] || 0);
            }
            if (sq > 0) currentSpecTypeCount++;
        }

        // ìŒìˆ˜ ë³´ì •
        if (currentGeneralCount < 0) currentGeneralCount = 0;

        var menu = "ğŸ“ í˜„ì¬ ìœ„ì¹˜: ë¬´ì—­ ì§€ë¶€\n" +
                   "ğŸš¢ ë³´ìœ  ì„ ë°•: " + shipLabel + " (Lv." + shipLevel + ")\n" +
                   "ğŸ“¦ ì¼ë°˜ êµì—­í’ˆ: " + currentGeneralCount + " / " + ship.capacity + " ì¹¸\n" +
                   "ğŸ“¦ íŠ¹ì‚°í’ˆ: " + currentSpecTypeCount + " / 5 ì¢…ë¥˜\n\n" +
                   "1. ğŸŒ ì„¸ê³„ ì‹œì„¸ í™•ì¸\n" +
                   "2. ğŸš¢ ì¶œí•­ ì¤€ë¹„ (ëª©ì ì§€)\n" +
                   "3. ğŸ“¦ í•­í•´ í˜„í™© (ë„ì°©)\n" +
                   "4. ğŸ› ï¸ ì„ ë°• ê´€ë¦¬ (ê°œì¡°)";
        
        replier.reply(formatCommand("â›µ ë‚´ë¦¬ë‹¤ ë¬´ì—­ ì§€ë¶€", user, menu, "ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
        menuWaitState[targetUid] = { type: 'trade_main', time: Date.now(), depth: 1 };
        return true;
    }

    var state = menuWaitState[targetUid];
    if (!state || !state.type.startsWith('trade_')) return false;

    // [ë„¤ë¹„ê²Œì´ì…˜] ì²˜ìŒìœ¼ë¡œ / ë’¤ë¡œ ì²˜ë¦¬
    if (msg === "ì²˜ìŒìœ¼ë¡œ") return _gameTradeLogic("/ë¬´ì—­", user, data, replier, roomName, targetUid);
    /* [ìˆ˜ì •] í•˜ì—­ í™”ë¬¼ ì„ íƒ ìƒíƒœ(trade_select_cargo) ì²˜ë¦¬ ë¶„ê¸° ì¶”ê°€ */
    if (state.type === 'trade_select_cargo') {
        _handleTradeCargoSelection(msg, user, data, replier, roomName, targetUid, tradeCfg);
        return true;
    }
    if (msg === "ë’¤ë¡œ") {
        if (state.depth === 1) {
            delete menuWaitState[targetUid];
            replier.reply(formatCommand("â›µ ë¬´ì—­ ì§€ë¶€", user, "ì—…ë¬´ë¥¼ ì¢…ë£Œí•˜ê³  í‡´ê±°í–ˆìŠµë‹ˆë‹¤."));
        } else {
            return _gameTradeLogic("/ë¬´ì—­", user, data, replier, roomName, targetUid);
        }
        return true;
    }

    var choice = msg.replace(/[^0-9]/g, "").trim();

    /* [ë¶„ê¸° 1] ë©”ì¸ ë©”ë‰´ ì²˜ë¦¬ */
    if (state.type === 'trade_main') {
        if (choice === "1") {
            _showTradeMarket(user, replier, roomData, tradeCfg);
            menuWaitState[targetUid] = { type: 'trade_market', time: Date.now(), depth: 2 };
        } else if (choice === "2") {
            if (user.voyage && user.voyage.active === true) {
                _showVoyageStatus(user, replier, data, roomName); 
                delete menuWaitState[targetUid]; // í•­í•´ ì¤‘ì´ë¯€ë¡œ ì‘ë‹µ ëŒ€ê¸° ì¢…ë£Œ
                return true;
            }
            _prepareVoyage(user, replier, tradeCfg, roomData);
            menuWaitState[targetUid] = { type: 'trade_depart', time: Date.now(), depth: 2 };
        } else if (choice === "3") {
            if (user.voyage && user.voyage.active === true) {
                _showVoyageStatus(user, replier, data, roomName); 
                delete menuWaitState[targetUid]; // í•­í•´ ì¤‘ì´ë©´ ì •ë³´ ë³´ì—¬ì£¼ê³  ì¢…ë£Œ
            } else {
                _showVoyageStatus(user, replier, data, roomName); 
                // í•­í•´ ì¤‘ì´ ì•„ë‹ˆë©´ "ì„ ë°• ì—†ìŒ"ì„ ë³´ì—¬ì£¼ê³  ë©”ë‰´ ëŒ€ê¸° ìƒíƒœ(trade_main)ë¥¼ ìœ ì§€í•˜ì—¬ ë‹¤ë¥¸ ë²ˆí˜¸ ì…ë ¥ ê°€ëŠ¥
                state.time = Date.now(); 
            }
        } else if (choice === "4") {
            _manageShip(user, replier, tradeCfg);
            menuWaitState[targetUid] = { type: 'trade_ship', time: Date.now(), depth: 2 };
        } else {
            replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "1~4ë²ˆ ì‚¬ì´ë¥¼ ì„ íƒí•˜ì„¸ìš”."));
        }
        return true;
    }

    /* [ë¶„ê¸° 2] ëª©ì ì§€ ì„ íƒ ë° ì¶œí•­ */
    if (state.type === 'trade_depart') {
        var nations = Object.keys(tradeCfg.NATIONS);
        var idx = parseInt(choice) - 1;
        if (isNaN(idx) || idx < 0 || idx >= nations.length) {
            replier.reply(formatError(user, "ëª©ì ì§€ ì˜¤ë¥˜", "ì˜¬ë°”ë¥¸ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
            return true;
        }
        /* [ê°œí¸] ì¦‰ì‹œ ì¶œí•­ ëŒ€ì‹  'í•˜ì—­ í™”ë¬¼ ì„ íƒ' ë‹¨ê³„ë¡œ ì§„ì… */
        var destName = nations[idx];
        menuWaitState[targetUid] = { 
            type: 'trade_select_cargo', 
            time: Date.now(), 
            depth: 3, 
            dest: destName, 
            selCargo: {}, 
            selSpec: {} 
        };
        
        // í•˜ì—­ ì„¤ì • í™”ë©´ ì¶œë ¥
        _showTradeCargoSelectUI(user, replier, roomData, tradeCfg, destName, {}, {});
        return true;
    }
    
    /* [ë¶„ê¸° 3] ì„ ë°• ê´€ë¦¬ ì²˜ë¦¬ */
    if (state.type === 'trade_ship') {
        if (choice === "1") _processShipUpgrade(user, data, replier, roomName, tradeCfg);
        else replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "ê°œì¡°ë¥¼ ìœ„í•´ 1ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”."));
        delete menuWaitState[targetUid];
        return true;
    }

    return false;
}

/**
 * [ìˆ˜ì •] ğŸš¢ ë¬´ì—­ í•˜ì—­ ì„¤ì • UI ì¶œë ¥ í•¨ìˆ˜ (ë””ìì¸ ê°€ë…ì„± ê°•í™”)
 */
function _showTradeCargoSelectUI(user, replier, roomData, cfg, dest, selC, selS) {
    var market = roomData.features.tradeMarket || cfg.NATIONS;
    var nInfo = market[dest];
    var body = "ğŸ“ ëª©ì ì§€: [" + dest + "]\n\n" +
               "[ğŸ“¦ ë¬´ì—­í’ˆ ë³´ìœ  í˜„í™©]\n";
    
    var availableItems = []; 
    // 1. ì¼ë°˜ í™”ë¬¼: ìœ ì € ë³´ìœ ëŸ‰(user.cargo)ì—ì„œ í˜„ì¬ ì„ íƒëœ ì–‘(selC)ì„ ëº€ ë‚˜ë¨¸ì§€ë§Œ ê³„ì‚°
    for (var k in (user.cargo || {})) {
        var total = Number(user.cargo[k] || 0);
        var selected = Number(selC[k] || 0);
        var remaining = total - selected;
        
        if (remaining > 0) {
            var status = (k === nInfo.favorite) ? "ğŸ”ºì„ í˜¸" : (k === nInfo.hate ? "ğŸ”¹ê¸°í”¼" : "â–ì¼ë°˜");
            availableItems.push({ type: 'cargo', name: k, qty: remaining, status: status });
        }
    }
    // 2. íŠ¹ì‚°í’ˆ: ë³´ìœ ëŸ‰(user.specialties)ì—ì„œ í˜„ì¬ ì„ íƒëœ ì–‘(selS)ì„ ëº€ ë‚˜ë¨¸ì§€ë§Œ ê³„ì‚°
    for (var s in (user.specialties || {})) {
        var totalS = Number(user.specialties[s] || 0);
        var selectedS = Number(selS[s] || 0);
        var remainingS = totalS - selectedS;

        if (remainingS > 0) {
            var pG = "";
            for (var rel in TRADE_RELATION) {
                if (TRADE_RELATION[rel].set === s) { pG = TRADE_RELATION[rel].produce; break; }
            }
            var sStatus = "â–ì¼ë°˜";
            if (pG === nInfo.favorite) sStatus = "ğŸ”ºì„ í˜¸";
            else if (pG === nInfo.hate) sStatus = "ğŸ”¹ê¸°í”¼";
            
            availableItems.push({ type: 'spec', name: s, qty: remainingS, status: sStatus });
        }
    }

    if (availableItems.length === 0) {
        body += "- ì ì¬ ê°€ëŠ¥í•œ ë³´ìœ  ë¬¼í’ˆ ì—†ìŒ -\n";
    } else {
        availableItems.forEach(function(it, i) {
            var prefix = it.type === 'spec' ? "â­" : "";
            body += (i + 1) + ". " + prefix + it.name + " (" + it.qty + "ìƒì) - " + it.status + "\n";
        });
    }

    body += "\n[âœ… ì„ ë°• ì ì¬ ì™„ë£Œ]\n";
    var selList = [];
    for (var c in selC) selList.push("â€¢ " + c + " x" + selC[c] + "ìƒì");
    for (var s in selS) selList.push("â€¢ â­" + s + " x" + selS[s] + "ê°œ");
    body += (selList.length > 0 ? selList.join("\n") : "- ì„ íƒëœ í™”ë¬¼ ì—†ìŒ -");

    body += "\n\n\nğŸ’¬ [ì…ë ¥ ë°©ë²•]\n" +
            "â€¢ íŒë§¤ í’ˆëª© ì§€ì •: [ë²ˆí˜¸] [ìˆ˜ëŸ‰]\n" +
            "â€¢ ëª¨ë“  í™”ë¬¼ ì„ íƒ: [ì „ë¶€]\n" +
            "â€¢ ì¶œí•­ : [ì¶œí•­]\n\n" +
            "â†©ï¸ ë’¤ë¡œ / ğŸ  ì²˜ìŒìœ¼ë¡œ / âì·¨ì†Œ";

    var nextStep = "íŒë§¤í•  ë²ˆí˜¸ì™€ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”. [ì·¨ì†Œ] ì…ë ¥ ì‹œ ë¬´ì—­ì´ ì¤‘ë‹¨ë©ë‹ˆë‹¤.";
    replier.reply(formatCommand("ğŸš¢ ë¬´ì—­ í•˜ì—­ ì„¤ì •", user, body, nextStep));
}

/**
 * [ìˆ˜ì •] ğŸš¢ ë¬´ì—­ í•˜ì—­ í™”ë¬¼ ì„ íƒ í•¸ë“¤ëŸ¬ (ì…ë ¥ íŒŒì‹± ìµœì í™”)
 */
function _handleTradeCargoSelection(msg, user, data, replier, roomName, targetUid, cfg) {
    var roomData = data.rooms[roomName];
    var state = roomData.features.states.menuWait[targetUid];
    var input = msg.trim();

    if (input === "ì·¨ì†Œ") {
        return _gameTradeLogic("/ë¬´ì—­", user, data, replier, roomName, targetUid);
    }

    if (input === "ì „ë¶€") {
        for (var k in (user.cargo || {})) if (user.cargo[k] > 0) state.selCargo[k] = user.cargo[k];
        for (var s in (user.specialties || {})) if (user.specialties[s] > 0) state.selSpec[s] = user.specialties[s];
        _showTradeCargoSelectUI(user, replier, roomData, cfg, state.dest, state.selCargo, state.selSpec);
        return;
    }

    if (input === "ì¶œí•­") {

        // 1. ì¶œí•­ ì‹œ ë¶€ë„ ê°€ë“œ ì¶”ê°€
        if (typeof util_isBankruptcy === 'function' && util_isBankruptcy(roomName)) {
            replier.reply(formatError(user, "ì¶œí•­ ë¶ˆê°€ëŠ¥", "í˜„ì¬ êµ­ê°€ ë¶€ë„ ìƒíƒœì´ë¯€ë¡œ ëª¨ë“  ë¬´ì—­ì„ ë°•ì˜ ì¶œí•­ì´ ì „ë©´ ê¸ˆì§€ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nâš ï¸ ì‚¬ìœ : êµ­ê³  ì¬ì› ë¶€ì¡±ìœ¼ë¡œ ì¸í•œ í•­ë§Œ ë´‰ì‡„"));
            return;
        }
     
        var hasCargo = Object.keys(state.selCargo).length > 0 || Object.keys(state.selSpec).length > 0;
        if (!hasCargo) {
            replier.reply(formatError(user, "ì¶œí•­ ë¶ˆê°€", "íŒë§¤í•  í™”ë¬¼ì„ ìµœì†Œ 1ê°œ ì´ìƒ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤."));
            return;
        }
        _departVoyage(user, data, replier, roomName, state.dest, cfg, state.selCargo, state.selSpec);
        delete roomData.features.states.menuWait[targetUid];
        return;
    }

   // [Bug Fix]: UIì— í‘œì‹œëœ 'ì”ì—¬ëŸ‰ì´ ìˆëŠ” ëª©ë¡'ê³¼ ë¡œì§ìƒì˜ ì¸ë±ìŠ¤ë¥¼ ì™„ë²½íˆ ì¼ì¹˜ì‹œí‚´
    var parts = input.split(/\s+/);
    var idx = parseInt(parts[0]) - 1;
    
    var availableItems = [];
    // 1. ì¼ë°˜ í™”ë¬¼ ì¤‘ ì”ì—¬ëŸ‰ì´ ìˆëŠ” ê²ƒë§Œ ìˆœì„œëŒ€ë¡œ ì¶”ì¶œ
    for (var k in (user.cargo || {})) {
        var rem = Number(user.cargo[k] || 0) - Number(state.selCargo[k] || 0);
        if (rem > 0) availableItems.push({ type: 'cargo', name: k, qty: rem });
    }
    // 2. íŠ¹ì‚°í’ˆ ì¤‘ ì”ì—¬ëŸ‰ì´ ìˆëŠ” ê²ƒë§Œ ì´ì–´ì„œ ì¶”ì¶œ
    for (var s in (user.specialties || {})) {
        var remS = Number(user.specialties[s] || 0) - Number(state.selSpec[s] || 0);
        if (remS > 0) availableItems.push({ type: 'spec', name: s, qty: remS });
    }

    if (isNaN(idx) || idx < 0 || idx >= availableItems.length) {
        if (!isNaN(parseInt(parts[0]))) {
            replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "í˜„ì¬ í™”ë©´ì— í‘œì‹œëœ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
        }
        return;
    }

    var selected = availableItems[idx];
    // ìˆ˜ëŸ‰ íŒŒì‹±: ë¯¸ì…ë ¥ ì‹œ 'ì „ë¶€'ë¡œ ê°„ì£¼
    var inputQty = parts.length > 1 ? parseInt(parts[1].replace(/[^0-9]/g, "")) : 999999;
    var finalQty = Math.min(inputQty, selected.qty);

    if (selected.type === 'cargo') {
        state.selCargo[selected.name] = (state.selCargo[selected.name] || 0) + finalQty;
    } else {
        state.selSpec[selected.name] = (state.selSpec[selected.name] || 0) + finalQty;
    }

    state.time = Date.now();
    _showTradeCargoSelectUI(user, replier, roomData, cfg, state.dest, state.selCargo, state.selSpec);
}

/* [ì„œë¸Œ] ğŸŒ ì„¸ê³„ ì‹œì„¸ ë¦¬í¬íŠ¸ */
function _showTradeMarket(user, replier, roomData, cfg) {
    var market = roomData.features.tradeMarket || cfg.NATIONS;
    var body = "ğŸŒ ê° êµ­ê°€ì˜ ì‹¤ì‹œê°„ ìˆ˜ìš”ì…ë‹ˆë‹¤.\n(ë§¤ì‹œ 30ë¶„ ì •ê° ì‹œì„¸ ë³€ë™)\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
    for (var n in market) {
        var fav = market[n].favorite;
        var hate = market[n].hate;
        
        // [ì§€ëŠ¥í˜• ë§¤í•‘]: í’ˆëª©ëª…ì„ í†µí•´ í•´ë‹¹ í’ˆëª©ê³¼ ì„¸íŠ¸ì¸ íŠ¹ì‚°í’ˆ ì´ë¦„ì„ ì—­ì¶”ì í•¨
        var favSpec = ""; var hateSpec = "";
        for (var rel in TRADE_RELATION) {
            if (TRADE_RELATION[rel].produce === fav) favSpec = TRADE_RELATION[rel].set;
            if (TRADE_RELATION[rel].produce === hate) hateSpec = TRADE_RELATION[rel].set;
        }

        body += "ğŸ“ " + n + "\n" +
                "  ğŸ”º ì„ í˜¸: " + fav + (favSpec ? " (+" + favSpec + ")" : "") + "\n" +
                "  ğŸ”¹ ê¸°í”¼: " + hate + (hateSpec ? " (-" + hateSpec + ")" : "") + "\n\n";
    }
    body += "â†©ï¸ ë’¤ë¡œ / ğŸ  ì²˜ìŒìœ¼ë¡œ / âì·¨ì†Œ";
    replier.reply(formatCommand("ğŸŒ ì„¸ê³„ ì‹œì„¸ ë¦¬í¬íŠ¸", user, body, "ë©”ë‰´ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
}

/* [ì„œë¸Œ] ğŸš¢ ì¶œí•­ ì¤€ë¹„ ë° í™”ë¬¼ í™•ì¸ */
function _prepareVoyage(user, replier, cfg, roomData) {
    var cargoList = []; var total = 0;
    var myCargo = user.cargo || {};
    
    for (var k in myCargo) {
        var q = Number(myCargo[k]);
        if (q > 0) { cargoList.push("â€¢ " + k + ": " + q + "ìƒì"); total += q; }
    }
    for (var s in (user.specialties || {})) {
        if (user.specialties[s] > 0) cargoList.push("â­ " + s + ": " + user.specialties[s] + "ìƒì");
    }
    
    if (total === 0 && cargoList.length === 0) {
        replier.reply(formatError(user, "ì¶œí•­ ë¶ˆê°€", "ì‹¤ë¦° í™”ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤. ìƒì ì—ì„œ ë¬¼í’ˆì„ êµ¬ë§¤í•˜ì„¸ìš”."));
        return;
    }

    var market = roomData.features.tradeMarket || cfg.NATIONS;
    var nations = Object.keys(cfg.NATIONS);
    var nStr = ""; 
    
    for (var i = 0; i < nations.length; i++) {
        var nName = nations[i];
        var nInfo = market[nName];
        // êµ­ê°€ëª… ì˜†ì— (ì„ í˜¸ğŸ”º ê¸°í”¼ğŸ”¹) ì •ë³´ ê²°í•©
        nStr += (i + 1) + ". " + nName + " (" + nInfo.favorite + "ğŸ”º " + nInfo.hate + "ğŸ”¹)\n";
    }

    nStr += "\nâ†©ï¸ ë’¤ë¡œ / ğŸ  ì²˜ìŒìœ¼ë¡œ / âì·¨ì†Œ";
    replier.reply(formatCommand("ğŸš¢ ëª©ì ì§€ ì„¤ì •", user, "[ë‚´ ë³´ê´€í•¨]\n" + cargoList.join("\n") + "\n\n[ì¶œí•­ì§€ ì„ íƒ]\n" + nStr, "êµ­ê°€ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
}

/* [ì„œë¸Œ] ğŸŒŠ í•­í•´ ì‹œì‘ (ìŠ¤ëƒ…ìƒ· ë° ìˆœí’ ì ìš©) */
function _departVoyage(user, data, replier, roomName, dest, cfg, selC, selS) {
    var roomData = data.rooms[roomName];
    user.skipHealing = true;
    var ship = cfg.SHIPS[user.shipLevel || 1];
    var timeMin = Math.floor(60 * ship.speedMult);
    
    // 1. ìˆœí’ í™•ë¥  íŒì • ë° ë„ì°© ì‹œê°„ ê³„ì‚°
    var isSmooth = Math.random() < 0.1;
    if (isSmooth) timeMin = Math.floor(timeMin * 0.8);
    var arrival = Date.now() + (timeMin * 60 * 1000);
    
    // 2. í•­í•´ ë°ì´í„° íŒ¨í‚¤ì§• (ìŠ¤ëƒ…ìƒ· ë°©ì‹)
    user.voyage = {
        active: true, 
        dest: dest, 
        arrival: arrival, 
        startTime: Date.now(),
        // ì¶œí•­ ì‹œì ì˜ ì‹œì„¸ì™€ ë‚´ ì ì¬ í™”ë¬¼ì„ ê·¸ëŒ€ë¡œ ë°•ì œí•˜ì—¬ ë³€ì¡° ë°©ì§€
        marketSnapshot: JSON.parse(JSON.stringify(roomData.features.tradeMarket || cfg.NATIONS)), 
        ecoMultSnapshot: util_getEcoMultiplier(roomName),
        cargoSnapshot: JSON.parse(JSON.stringify(selC || {})), 
        specialtySnapshot: JSON.parse(JSON.stringify(selS || {})),
        isSmooth: isSmooth,
        /* [í•µì‹¬] ì¤‘ë³µ ì •ì‚° ë°©ì§€ ë° ì •ì‚° ëŒ€ê¸° í”Œë˜ê·¸ ì´ˆê¸°í™” */
        isProcessing: false 
    };
    
    // 3. [ì¤‘ìš”] ì¦‰ì‹œ ë¬¼ë¦¬ íŒŒì¼ ì €ì¥ ì§‘í–‰ (ìì • ë¦¬ì…‹ ë° ë´‡ ì¬ì‹œì‘ ëŒ€ë¹„)
    // ë¹„ë™ê¸° íê°€ ì•„ë‹Œ 2ë²ˆì§¸ ì¸ì trueë¥¼ í†µí•´ ì¦‰ì‹œ íœ´ëŒ€í° ì €ì¥ì†Œì— ê¸°ë¡í•©ë‹ˆë‹¤.
    safeSaveData(data, true); 

    var msg = "ëª©ì ì§€: " + dest + "\n" +
              "ì†Œìš” ì‹œê°„: ì•½ " + timeMin + "ë¶„\n" +
              "ë„ì°© ì˜ˆì •: " + new Date(arrival).toLocaleTimeString();
              
    if (isSmooth) msg += "\n\nğŸŒ¬ï¸ [ìˆœí’] ê¸°ë¶„ ì¢‹ì€ ë°”ëŒìœ¼ë¡œ ì‹œê°„ì´ 20% ë‹¨ì¶•ë˜ì—ˆìŠµë‹ˆë‹¤!";
    
    replier.reply(formatCommand("ğŸŒŠ ì¶œí•­ ëª…ë ¹ í•˜ë‹¬", user, msg, "í•­í•´ ì¤‘ íƒ€ í™œë™ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤."));
}

/* [ì„œë¸Œ] ğŸ“¦ í•­í•´ í˜„í™©íŒ (ì˜ˆìƒ ìˆ˜ìµ ë¶„ê¸° ì¶”ê°€) */
function _showVoyageStatus(user, replier, data, roomName) {
    var msg = "";
    
    if (!user.voyage || user.voyage.active !== true) {
        // í•­í•´ ì¤‘ì´ ì•„ë‹ ë•Œ ë©”ì‹œì§€ë¥¼ ì¦‰ì‹œ ì¶œë ¥í•˜ë„ë¡ ìˆ˜ì •
        var emptyBody = "í˜„ì¬ ìš´í•­ ì¤‘ì¸ ì„ ë°•ì´ ì—†ìŠµë‹ˆë‹¤.\në¬´ì—­ ë¬¼ìë¥¼ ì‹£ê³  ë„“ì€ ë°”ë‹¤ë¡œ ë‚˜ê°€ë³´ì„¸ìš”!\n\n" +
                        "â†©ï¸ ë’¤ë¡œ / ğŸ  ì²˜ìŒìœ¼ë¡œ / âì·¨ì†Œ";
        
        replier.reply(formatCommand("ğŸ“¦ í•­í•´ í˜„í™©", user, emptyBody, "ì¶œí•­ ì¤€ë¹„: [2]ë²ˆ ë©”ë‰´ë¥¼ ì„ íƒí•˜ì„¸ìš”."));
        return; // ë¡œì§ ì¢…ë£Œ
    }
        var v = user.voyage;
    var remain = (v.arrival || 0) - Date.now();
    var cfg = SYSTEM_CONFIG.TRADE;
    
    var tRev = 0; // ì •ì‚°ìš© ì„¸ì „ ì´ë§¤ì¶œ
    var tCost = 0; // í‰ë‹¨ê°€ ê¸°ë°˜ ì´ë§¤ì…ê°€
    
    var currentCargoLines = [];
    var totalCargoInShip = 0;
    var shipCapacity = cfg.SHIPS[user.shipLevel || 1].capacity;

    // 1. ì¼ë°˜ í™”ë¬¼ ì˜ˆìƒ ìˆ˜ìµ ê³„ì‚° ë£¨í”„
    var cSnap = v.cargoSnapshot || {};
    for (var g in cSnap) {
        var qty = Number(cSnap[g]); 
        if (qty <= 0) continue;
        
        // UI ë¼ì¸ ì¶”ê°€ (ìš”ì²­í•˜ì‹  ë¶ˆë › í¬ì¸íŠ¸ ê°„ê²© ì ìš©)
        currentCargoLines.push("     â€¢ " + g + " " + qty + "ìƒì");
        totalCargoInShip += qty;
        
        // ì›ê°€ ë° ìˆ˜ìµë¥  ê³„ì‚°
        var uCost = Number((user.cargoAvg && user.cargoAvg[g]) || cfg.GOODS_COST[g]);
        tCost += (uCost * qty);
        var rInfo = SYSTEM_CONFIG.PROFIT_RATES[g] || { pref: 1.25, norm: 1.05, hate: 0.8 };
        var multiplier = 1.0;
        var mSnap = v.marketSnapshot || {}; 
        var nSnap = mSnap[v.dest] || { favorite: "", hate: "" };
        var pByDest = TRADE_RELATION[v.dest] ? TRADE_RELATION[v.dest].produce : "";

        if (g === pByDest) multiplier = 0.5;
        else if (g === nSnap.favorite) multiplier = rInfo.pref;
        else if (g === nSnap.hate) multiplier = rInfo.hate;
        else multiplier = rInfo.norm;
        
        tRev += Math.floor(uCost * multiplier * qty);
    }

    // 2. íŠ¹ì‚°í’ˆ ì˜ˆìƒ ìˆ˜ìµ ê³„ì‚° ë£¨í”„ (ë‹¨ìœ„: ìƒì)
    var sSnap = v.specialtySnapshot || {};
    for (var s in sSnap) {
        var sQty = Number(sSnap[s]); 
        if (sQty <= 0) continue;
        
        currentCargoLines.push("    â­" + s + " " + sQty + "ìƒì");
        totalCargoInShip += sQty;

        var pG = "";
        for (var n in TRADE_RELATION) { if (TRADE_RELATION[n].set === s) { pG = TRADE_RELATION[n].produce; break; } }
        var sMult = 1.0;
        var mSnap = v.marketSnapshot || {}; 
        var nSnap = mSnap[v.dest] || { favorite: "", hate: "" };
        var pByDest = TRADE_RELATION[v.dest] ? TRADE_RELATION[v.dest].produce : "";
        
        if (pG === pByDest) sMult = 0;
        else if (pG === nSnap.favorite) sMult = cfg.SPECIALTY_PROFIT;
        else if (pG === nSnap.hate) sMult = 0.5;
        
        var sVal = (cfg.SPECIALTY_COST[pG] || 10000);
        tCost += (sVal * sQty);
        tRev += Math.floor(sVal * sQty * sMult);
    }

    // 3. [ìˆ˜ì •] ì‹ ìš©ë„ ë° ê¸°ë¶€ì™• í˜œíƒì´ ì ìš©ëœ ì‹¤ì§ˆ ì˜ˆìƒ ìˆ˜ìµ ì‚°ì¶œ
    var margin = tRev - tCost; // ìˆœìˆ˜ ë§ˆì§„(ì´ìµê¸ˆ)
    
    // ê¸°ë¶€ì™• ë¬´ì—­ì„¸ 50% ê°ë©´ (10% -> 5%)
    var taxRate = (user.title === "ê¸°ë¶€ì™•") ? 0.05 : 0.10;
    var taxAmount = Math.max(0, Math.floor(margin * taxRate));
    
    // ì‹ ìš© ë“±ê¸‰ë³„ ìˆ˜ìµ ë°°ìœ¨ ì ìš© (90% ~ 60%)
    var crInfo = getCreditInfo(user.creditScore, roomName);
    var creditMult = util_getTradeCreditMult(crInfo.grade);
    
    // ìµœì¢… ì˜ˆìƒ ì´ìµ = (ë§ˆì§„ - ì„¸ê¸ˆ) * ì‹ ìš©ë°°ìœ¨
    var estimatedNetProfit = Math.floor((margin - taxAmount) * creditMult);
    var finalReceipt = tCost + estimatedNetProfit; // ìµœì¢… ìˆ˜ë ¹ì•¡ = ì›ê¸ˆ + ì¡°ì •ëœ ì´ìµ
    /* =====ìš”ì²­ì‚¬í•­ ë===== */

    var cargoDisplay = "ğŸ“¦ ì ì¬í•¨: " + totalCargoInShip + " / " + shipCapacity + " ì¹¸\n" + currentCargoLines.join("\n") + "\n\n";

    var displayBody = "í˜„ì¬ [" + v.dest + "]ë¡œ í•­í•´ ì¤‘\n\n" +
                      cargoDisplay +
                      "ğŸ’° ì´ ì˜ˆìƒ ìˆ˜ë ¹ì•¡: " + fp(finalReceipt) + "P\n" +
                      "ğŸ’µ ìˆœìˆ˜ìµ(ë§ˆì§„): " + (estimatedNetProfit >= 0 ? "+" : "") + fp(estimatedNetProfit) + "P\n" +
                      "ğŸ“‰ ì‹ ìš© ì ìš©: " + (creditMult * 100).toFixed(0) + "% (" + crInfo.label + ")\n\n" +
                      "ğŸ•’ ë‚¨ì€ ì‹œê°„: " + (remain > 0 ? "ì•½ " + Math.ceil(remain/60000) + "ë¶„" : "ë„ì°© ì™„ë£Œ");

    replier.reply(formatCommand("ğŸ“¦ í•­í•´ í˜„í™©", user, displayBody, "ì •ì‚°ì€ ë„ì°© í›„ ì±„íŒ… ì…ë ¥ ì‹œ ìë™ ìˆ˜í–‰ë©ë‹ˆë‹¤."));
}

/* [ì„œë¸Œ] ğŸ› ï¸ ì„ ë°• ê´€ë¦¬ ë° ê°œì¡° */
function _manageShip(user, replier, cfg) {
    var cur = cfg.SHIPS[user.shipLevel || 1];
    var next = cfg.SHIPS[(user.shipLevel || 1) + 1];
    var body = "ë“±ê¸‰: " + cur.name + " (Lv." + (user.shipLevel || 1) + ")\nì ì¬ëŸ‰: " + cur.capacity + "ì¹¸\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
    if (next) body += "[ë‹¤ìŒ ë‹¨ê³„ ê°œì¡°]\nâ€¢ ëŒ€ìƒ: " + next.name + "\nâ€¢ ì ì¬: " + next.capacity + "ì¹¸\nâ€¢ ë¹„ìš©: " + fp(next.upgradeCost) + "P\n\n(ê°œì¡° ì‹œ 1ë²ˆ ì…ë ¥)";
    else body += "ğŸ‰ ì´ë¯¸ ìµœê³  ë“±ê¸‰ ì„ ë°•(ê°¤ë¦¬ì˜¨)ì„ ë³´ìœ  ì¤‘ì…ë‹ˆë‹¤.";

    body += "\n\nğŸ’° ë³´ìœ  í¬ì¸íŠ¸: " + fp(user.point) + "P\n\nâ†©ï¸ ë’¤ë¡œ / ğŸ  ì²˜ìŒìœ¼ë¡œ / âì·¨ì†Œ";
    replier.reply(formatCommand("ğŸ› ï¸ ì„ ë°• ê´€ë¦¬ì†Œ", user, body, "ê°œì¡°í•˜ë ¤ë©´ 1ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”."));
}

/* [ì„œë¸Œ] ì‹¤ì œ ì„ ë°• ì—…ê·¸ë ˆì´ë“œ */
function _processShipUpgrade(user, data, replier, roomName, cfg) {
    var next = cfg.SHIPS[(user.shipLevel || 1) + 1];
    if (!next || user.point < next.upgradeCost) return replier.reply(formatError(user, "ê°œì¡° ë¶ˆê°€", "ë¹„ìš© ë¶€ì¡± ë˜ëŠ” ìµœê³  ë“±ê¸‰ì…ë‹ˆë‹¤."));
    
    user.skipHealing = true;
    util_updatePoint(user, data.rooms[roomName], -next.upgradeCost, "ì„ ë°• ê°œì¡° ë¹„ìš©", roomName);
    
    // ì›ìì  ë°ì´í„° ê²Œì´íŠ¸ì›¨ì´ ì‚¬ìš© ë° ë¬¼ë¦¬ ì €ì¥ ê°•ì œ(true)
    util_setData(user, 'shipLevel', (user.shipLevel || 1) + 1, "ì„ ë°• ë“±ê¸‰ ì—…ê·¸ë ˆì´ë“œ", roomName);
    safeSaveData(data, true); 
    
    replier.reply(formatCommand("ğŸŠ ì„ ë°• ê°œì¡° ì™„ë£Œ", user, "ì¶•í•˜í•©ë‹ˆë‹¤! ì„ ë°•ì´ [" + next.name + "]ìœ¼ë¡œ ê°•í™”ë˜ì—ˆìŠµë‹ˆë‹¤."));
}
/**
 * [í•µì‹¬ ì—”ì§„] ë¬´ì—­ ì •ì‚° ë° ì¬í•´ ì—”ì§„ v1.5
 */
function _processTradeArrival(user, data, replier, roomName, targetUid) {
    // 0. [ì—ëŸ¬ ë°©ì§€] ë³€ìˆ˜ ì„ ì–¸ ë° ë°ì´í„° ì¡´ì¬ ì—¬ë¶€ ìµœìš°ì„  ê²€ì¦
    if (!user || !user.voyage) return; // í•­í•´ ì¤‘ì´ ì•„ë‹ˆë©´ ì¦‰ì‹œ ì¢…ë£Œ
    var v = user.voyage; 
    var cfg = SYSTEM_CONFIG.TRADE;
    
    // 1. í˜„ì¬ ë°© ë°ì´í„° ë³µêµ¬ (í•˜ë‹¨ ë¡œì§ìš©)
    var roomData = data.rooms[roomName]; 
    
    // 2. ì‹¤ì œ ìì‚°ì´ ì—°ë™ë  ê²½ì œ êµ¬ì—­ ì„¤ì • (1:1ë°© ì—°ë™ìš©)
    var economyRoomName = (ALLOWED_ROOMS.indexOf(roomName) === -1) ? "ë‚´ë¦¬ë‹¤" : roomName;
    var economyRoomData = data.rooms[economyRoomName];

    // [ì¤‘ìš”] ê¸°ì¡´ í•˜ë‹¨ ì½”ë“œë“¤ê³¼ì˜ í˜¸í™˜ì„±ì„ ìœ„í•´ ë³€ìˆ˜ë¥¼ ë‹¤ì‹œ ë§¤í•‘í•¨
    // ì´ ì¤„ì´ ìˆì–´ì•¼ í•˜ë‹¨ì—ì„œ roomData.bankReserve ë“±ì„ ì°¾ì„ ë•Œ ì—ëŸ¬ê°€ ì•ˆ ë‚©ë‹ˆë‹¤.
    if (!roomData) roomData = economyRoomData;

    // [ì¤‘ë³µ ë°©ì§€] ì´ë¯¸ ì •ì‚° ë¡œì§ì´ ë„ëŠ” ì¤‘ì´ë¼ë©´ í†µê³¼
    if (v.isProcessing === true) return;

    // 1. [í•µì‹¬] ì •ì‚° ì‹œ ë¶€ë„ ê°€ë“œ (ë©”ì¸ êµ¬ì—­ ê¸°ì¤€ìœ¼ë¡œ ì”ì•¡ ì²´í¬)
    if (typeof util_isBankruptcy === 'function' && util_isBankruptcy(economyRoomName)) {
        // ë¶€ë„ ìƒíƒœì¼ ë•ŒëŠ” ì •ì‚° ì ê¸ˆì„ í•´ì œí•˜ì—¬ ë¶€ë„ í•´ì œ ì‹œ ë‹¤ìŒ ì±„íŒ…ì—ì„œ ìë™ ì •ì‚°ë˜ê²Œ í•¨
        v.isProcessing = false; 

        if (v.isAlerted === true) return; // ì•Œë¦¼ì€ í•œ ë²ˆë§Œ ì¶œë ¥
        v.isAlerted = true; 
        
        var bankMsg = "ë¬´ì—­ì„ ì´ í•­êµ¬ì— ë„ì°©í–ˆìœ¼ë‚˜, [" + economyRoomName + "] êµ¬ì—­ì˜ ë¶€ë„ ìƒíƒœë¡œ ì¸í•´\n" +
                      "ì •ì‚°ê¸ˆì„ ì§€ê¸‰í•  ì¬ì›ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.\n\n" +
                      "ğŸ“¦ ìƒíƒœ: í™”ë¬¼ ë³´ì¡´ ë° ì…í•­ ëŒ€ê¸°\n" +
                      "ğŸ’° ì¡°ì¹˜: êµ­ê³  ë³µêµ¬ í›„ ì±„íŒ… ì…ë ¥ ì‹œ ìë™ ì •ì‚°";
        
        replier.reply(formatCommand("âš“ ì…í•­ ëŒ€ê¸° (ì§€ë¶ˆ ì •ì§€)", user, bankMsg, "í•´ì œ ê¸°ì¤€: êµ­ê³  50% ë³µêµ¬"));
        safeSaveData(data, false);
        return; 
    }

    // 2. ë¶€ë„ê°€ ì•„ë‹ ê²½ìš° ì •ì‚° ì‹œì‘ (ì ê¸ˆ ì²˜ë¦¬)
    v.isProcessing = true; 
    v.isAlerted = false; // ë¶€ë„ê°€ í’€ë ¸ìœ¼ë¯€ë¡œ ì•Œë¦¼ ìƒíƒœ ì´ˆê¸°í™”

   // [ë³´ì•ˆ] ì‹¤ì‹œê°„ ê°€ë°©ì´ ì•„ë‹Œ, ì¶œí•­ ì‹œ ë°•ì œí–ˆë˜ ìŠ¤ëƒ…ìƒ·ì„ ì •ì‚° ëŒ€ìƒìœ¼ë¡œ ì„¤ì •
    // 1. [Snapshot] ì¶œí•­ ì‹œì ì˜ ê³ ì • ë°ì´í„°ë“¤ì„ ì •ì‚° ëŒ€ìƒìœ¼ë¡œ ì„¤ì • (íœ˜ë°œì„±/ë¡¤ë°± ë°©ì§€)
    var cargoToSell = v.cargoSnapshot || user.cargo || {};
    var specialtyToSell = v.specialtySnapshot || user.specialties || {};
    var producedByDest = TRADE_RELATION[v.dest] ? TRADE_RELATION[v.dest].produce : "";

    // ìˆ˜ì •: nationInfo ë³€ìˆ˜ ì„ ì–¸ ì¶”ê°€ (ReferenceError í•´ê²°)
    var nationInfo = (v.marketSnapshot && v.marketSnapshot[v.dest]) ? v.marketSnapshot[v.dest] : cfg.NATIONS[v.dest];
    
    var totalRevenue = 0; 
    var totalCost = 0; 
    var soldLog = []; 
    var disasterLog = ""; 
    var cargoSummary = []; 
    var piracyLog = ""; // <--- ëˆ„ë½ ì§€ë¢° 1: í•´ì  ë¡œê·¸ ë³€ìˆ˜ ì„ ì–¸
    var taxAmount = 0;  // <--- ëˆ„ë½ ì§€ë¢° 2: ì„¸ê¸ˆ ë³€ìˆ˜ ì„ ì–¸
    var taxTag = "";    // <--- ëˆ„ë½ ì§€ë¢° 3: ì„¸ê¸ˆ íƒœê·¸ ë³€ìˆ˜ ì„ ì–¸
    
    var triggeredDisaster = (Math.random() < 0.25) ? ["STORM", "FIRE", "CORRO", "PIRACY"][Math.floor(Math.random() * 4)] : null; 

    // 2. ì¼ë°˜ í™”ë¬¼ ì‹¤ì •ì‚° (ë§¤ì…ê°€ ê·¸ëŒ€ë¡œ ì ìš© ë¡œì§)
    for (var good in cargoToSell) {
        var count = Number(cargoToSell[good]); if (count <= 0) continue;
        
        // [ìˆ˜ì •] ëª¨ë“  ìˆ˜ì¹˜ë¥¼ Number()ë¡œ ê°ì‹¸ ê³„ì‚° ì˜¤ë¥˜(NaN) ì›ì²œ ì°¨ë‹¨
        var myPurchasePrice = Number((user.cargoAvg && user.cargoAvg[good]) || cfg.GOODS_COST[good] || 10000);
        totalCost += (myPurchasePrice * count); 

        var rateInfo = SYSTEM_CONFIG.PROFIT_RATES[good] || { pref: 1.25, norm: 1.05, hate: 0.8 };
        var multiplier = Number(multiplier || 1.0);

        if (good === producedByDest) {
            multiplier = 0.5;
            disasterLog += "\nğŸš« [ê³¼ì‰ ê³µê¸‰]: ìêµ­ ìƒì‚°ë¬¼ '" + good + "'ì€ ë°˜ì… ì œí•œ(ë°˜ê°’)";
        } else {
            if (good === nationInfo.favorite) multiplier = rateInfo.pref;
            else if (good === nationInfo.hate) multiplier = rateInfo.hate;
            else multiplier = rateInfo.norm;
        }

        // ì¬í•´ ì²˜ë¦¬ (ìˆ˜ëŸ‰/ê°€ì¹˜ ì°¨ê°)
        if (triggeredDisaster === "FIRE" && (good === "ì‹ë£Œí’ˆ" || good === "ê³µì˜ˆí’ˆ")) {
            var lost = Math.ceil(count * 0.1); count -= lost;
            disasterLog += "\nğŸ”¥ [ì¬í•´: í™”ì¬]: " + good + " " + lost + "ìƒì ì†Œì‹¤";
        } else if (triggeredDisaster === "CORRO" && (good === "ê³µì—…í’ˆ" || good === "ê·€ê¸ˆì†")) {
            multiplier *= 0.9;
            disasterLog += "\nğŸ§ª [ì¬í•´: ë¶€ì‹]: í™”ë¬¼ ê°€ì¹˜ 10% í•˜ë½";
        }

        // ìµœì¢… ê°œë³„ ë§¤ì¶œ = ë‚´ ë§¤ì…ê°€ * ìˆ˜ìµë¥ % * ë‚¨ì€ ìˆ˜ëŸ‰
        var earn = Math.floor(myPurchasePrice * multiplier * count);
        totalRevenue += earn;

        if (count > 0 && multiplier > 0) {
            var sign = (multiplier >= 1.1) ? "ğŸ”º" : (multiplier <= 0.9 ? "ğŸ”¹" : "â–");
            soldLog.push("â€¢ " + good + " x" + count + ": " + fp(earn) + "P " + sign);
        }
        
        // ê°€ë°© ë¹„ìš°ê¸°
        if (user.cargo) user.cargo[good] = 0;
        if (user.cargoAvg) user.cargoAvg[good] = 0;
    }

    // 3. íŠ¹ì‚°í’ˆ ì •ì‚° (specialtyToSell ìŠ¤ëƒ…ìƒ· ê¸°ë°˜ ë£¨í”„)
    for (var sName in specialtyToSell) {
        var sCount = Number(specialtyToSell[sName]); if (sCount <= 0) continue;
        var sMult = 1.0; var sTag = "";

        var parentGood = "";
        var sBasePrice = 10000; // ê¸°ë³¸ê°’ (í´ë°±)

        // í•´ë‹¹ íŠ¹ì‚°í’ˆì˜ ìƒìœ„ ì¹´í…Œê³ ë¦¬(produce) ë° ê·¸ì— ë”°ë¥¸ ê¸°ë³¸ ê°€ê²© íƒìƒ‰
        for (var n in TRADE_RELATION) {
            if (TRADE_RELATION[n].set === sName) { 
                parentGood = TRADE_RELATION[n].produce; 
                sBasePrice = cfg.SPECIALTY_COST[parentGood] || 10000;
                break; 
            }
        }

        if (parentGood === producedByDest) {
            sMult = 0;
            disasterLog += "\nğŸš« [í†µê´€ ê±°ë¶€]: ìêµ­ íŠ¹ì‚°í’ˆ '" + sName + "'ì€ ì „ëŸ‰ ì••ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.";
        } else if (parentGood === nationInfo.favorite) {
            sMult = cfg.SPECIALTY_PROFIT;
            sTag = "â­ [ì„¸íŠ¸ìˆ˜ìš”]";
        } else if (parentGood === nationInfo.hate) {
            sMult = 0.5;
            sTag = "ğŸ”¹ [ìˆ˜ìš”ê¸‰ê°]";
        }

        var sRev = Math.floor(sBasePrice * sCount * sMult);
        totalRevenue += sRev;
        if (sMult > 0) {
            soldLog.push("â€¢ [íŠ¹] " + sName + " x" + sCount + ": " + fp(sRev) + "P " + sTag);
        }
        // ì‹¤ì œ ìœ ì €ì˜ íŠ¹ì‚°í’ˆ ê°€ë°© ë¹„ì›€
        if (user.specialties) user.specialties[sName] = 0;
    }

    // 5. [í•µì‹¬] ìˆœìˆ˜ìµ(ë§ˆì§„) ê¸°ë°˜ ì°¨ë“± ì •ì‚° ë¡œì§
    var margin = totalRevenue - totalCost; // ìˆœìˆ˜ ë§ˆì§„ ì‚°ì¶œ
    var piracyLoot = 0;

    // í•´ì  ì•½íƒˆ (ë§ˆì§„ì—ì„œ 10% ì°¨ê°)
    if (triggeredDisaster === "PIRACY" && margin > 0) {
        piracyLoot = Math.floor(margin * 0.1);
        margin -= piracyLoot;
        disasterLog += "\nğŸ´â€â˜ ï¸ [í•´ì ]: ë§ˆì§„ì˜ 10%(-" + fp(piracyLoot) + "P)ë¥¼ ì•½íƒˆë‹¹í–ˆìŠµë‹ˆë‹¤.";
    }

    // ì„¸ê¸ˆ ê³„ì‚° (ê¸°ë¶€ì™• 5%, ì¼ë°˜ 10%)
    var taxRate = (user.title === "ê¸°ë¶€ì™•") ? 0.05 : 0.10;
    var taxAmount = margin > 0 ? Math.floor(margin * taxRate) : 0;
    var afterTaxMargin = margin - taxAmount;

    // ì‹ ìš© ë“±ê¸‰ ìˆ˜ìµ ë°°ìœ¨ ì ìš©
    var crInfo = getCreditInfo(user.creditScore, roomName);
    var creditMult = util_getTradeCreditMult(crInfo.grade);
    var finalNetProfit = Math.floor(afterTaxMargin * creditMult); // ìµœì¢… ì¡°ì •ëœ ìˆœì´ìµ
    var creditLoss = Math.max(0, afterTaxMargin - finalNetProfit); // ì‹ ìš© ë“±ê¸‰ìœ¼ë¡œ ì¸í•´ êµ­ê³ ë¡œ í™˜ìˆ˜ë˜ëŠ” ê¸ˆì•¡

    // í­í’ìš° ìˆ˜ë¦¬ë¹„ (ìµœì¢… ìˆ˜ìµì—ì„œ ì°¨ê°)
    var repairFee = 0;
    if (triggeredDisaster === "STORM") {
        repairFee = Math.floor(Math.abs(finalNetProfit) * 0.1 + 10000);
        finalNetProfit -= repairFee;
        disasterLog += "\nğŸŒŠ [í­í’ìš°]: ì„ ì²´ íŒŒì† ìˆ˜ë¦¬ë¹„ " + fp(repairFee) + "P ì§€ì¶œ";
    }

    // 6. ìµœì¢… ì§€ê¸‰ì•¡ í™•ì • = ì›ê¸ˆ(ë³´ì¡´) + ì¡°ì •ëœ ìˆœì´ìµ
    var totalPayout = totalCost + finalNetProfit;

    // [í•µì‹¬ ìˆ˜ì •] ì‹¤ì œ ëˆì´ ì§€ê¸‰ë  ì¥ë¶€ë¥¼ economyRoomData(ë‚´ë¦¬ë‹¤ ë°©)ë¡œ ì§€ì •í•˜ì—¬ ë³´ì•ˆ ë¡¤ë°± í•´ê²°
    util_updatePoint(user, economyRoomData, totalPayout, "ë¬´ì—­ ì •ì‚° ì™„ë£Œ (ì›ê¸ˆ+ìˆ˜ìµ)", economyRoomName);
    
    // êµ­ê³  ê·€ì† (ì„¸ê¸ˆ + ì‹ ìš© ì‚­ê°ì•¡) ì—­ì‹œ ë©”ì¸ ê¸ˆê³ ì—ì„œ ì²˜ë¦¬
    if (taxAmount > 0) util_updateReserve(economyRoomData, taxAmount, "ë¬´ì—­ì„¸ ì§•ìˆ˜", economyRoomName);
    if (creditLoss > 0) util_updateReserve(economyRoomData, creditLoss, "ì‹ ìš© ë“±ê¸‰ ì°¨ë“± ìˆ˜ìµ í™˜ìˆ˜", economyRoomName);

    // 7. íŠ¹ì‚°í’ˆ ë°œê²¬ (15% í™•ë¥ )
    var specialtyFound = "";
    if (Math.random() < cfg.SPECIALTY_CHANCE) {
        var newItem = nationInfo.specialty;
        user.specialties[newItem] = (user.specialties[newItem] || 0) + 1;
        specialtyFound = "\n\nâœ¨ [" + v.dest + "]ì˜ íŠ¹ì‚°í’ˆ '" + newItem + "'ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤!";
    }
    
    // [ìˆ˜ì •] ì¤‘ë³µ ì„ ì–¸ ë° ë¡œì§ ì œê±°, ì •ì‚° í”Œë˜ê·¸ í•´ì œ í†µí•©
    user.voyage.active = false; 
    user.voyage.isProcessing = false; 
    user.tradeCount = (user.tradeCount || 0) + 1;

    // ë¦¬í¬íŠ¸ìš© ë³€ìˆ˜ ë§¤í•‘ ë° íƒœê·¸ ìƒì„±
    var grossRevenue = totalRevenue; 
    var netProfit = finalNetProfit; 
    var cargoDisplay = (cargoSummary && cargoSummary.length > 0) ? cargoSummary.join(", ") : v.dest + " ìˆ˜ì¶œí’ˆ";
    var baseTax = cfg.BASE_TAX || 0.1;
    var taxTag = (taxRate > baseTax) ? " (ìì‚°ê°€ ëˆ„ì§„ ì ìš©)" : "";

    var report = "ğŸ“ ë„ì°©ì§€: " + v.dest + " (" + cargoDisplay + ")\n\n" +
                 "ğŸ’° ì´ ë§¤ì¶œ: " + fp(grossRevenue) + "P" + 
                 (piracyLog || "") + 
                 (disasterLog || "") + "\n" +
                 "âš–ï¸ ë¬´ì—­ì„¸(" + (Number(taxRate || 0.1) * 100).toFixed(0) + "%): -" + fp(taxAmount) + "P" + taxTag + "\n\n" +
                 "ğŸ’µ ìµœì¢… ìˆ˜ìµ: +" + fp(netProfit) + "P" + 
                 (specialtyFound || "");

    // ê²°ê³¼ ë©”ì‹œì§€ ìƒì„± ë° ì „ì†¡
    var resultMsg = formatCommand("ğŸŒŠ [í•­í•´ ì¼ì§€: ë¬´ì—­ ë³´ê³ ]", user, report, "ëˆ„ì  ë¬´ì—­: " + user.tradeCount + "íšŒ / ì”ì•¡: " + fp(user.point) + "P");
    Api.replyRoom(roomName, resultMsg);
    
    safeSaveData(data, true);
}

//==========ì„¹í„°52==========

/**
Â * [í•µì‹¬ ëª¨ë“ˆ] í†µí•© ì¹´ì§€ë…¸ ì—”ì§„ (ì‚¬ë‹¤ë¦¬ & ë°”ì¹´ë¼)
Â * ê¸°ëŠ¥: ë©”ë‰´ ì¶œë ¥, ë°°íŒ… ê²€ì¦, ìµœê·¼ ê²°ê³¼ ì¡°íšŒ
Â */

/* [ë©”ì¸] ì¹´ì§€ë…¸ ë¡œì§ ì§„ì…ì  */
function _gameCasinoLogic(msg, user, data, replier, roomName, targetUid) {
    // 1. ê³µë°± ì œê±° (ìˆ«ì ì¸ì‹ë¥  í–¥ìƒ)
    var cleanMsg = msg.trim();

Â  Â  // [í•µì‹¬] í˜„ì¬ ì ‘ì†í•œ ë°©ì´ ë‹¨ì²´ë°©ì¸ì§€ í™•ì¸ (1:1 ë°©ì—ì„œë§Œ êµ¬ë™ë˜ê²Œ ì œí•œ)
Â  Â  if (ALLOWED_ROOMS.indexOf(roomName) !== -1) {
Â  Â  Â  Â  var inviteBody = "ì¤‘ì•™ ì¹´ì§€ë…¸ëŠ” VIP ê³ ê°ë‹˜ì˜ ë³´ì•ˆê³¼\n" +
                         "ì¾Œì í•œ í™˜ê²½ì„ ìœ„í•´ ì˜¤ì§ [1:1 ëŒ€í™”]ë¥¼\n" +
                         "í†µí•´ì„œë§Œ ê²Œì„ì„ ì œí•œí•˜ê³  ìˆìŠµë‹ˆë‹¤.\n" +
                         "https://open.kakao.com/me/nerida";

Â  Â  Â  Â  replier.reply(formatCommand("ğŸ“¨ VIP ì „ìš© ì•ˆë‚´", user, inviteBody, "ë´‡ì˜ ì˜¤í”ˆí”„ë¡œí•„ 1:1 ì±„íŒ…ë°©ì—ì„œ ë§Œë‚˜ìš”!"));
Â  Â  Â  Â  return true;
Â  Â  }

    /* [1:1 ë°© ì•ˆì „ ì´ˆê¸°í™” ë° ìƒíƒœ ì—°ê²°] */
    if (!data.rooms[roomName]) data.rooms[roomName] = { users: {} };
    if (!data.rooms[roomName].features) {
        if (typeof ROOM_FEATURE_TEMPLATE === 'function') {
            data.rooms[roomName].features = ROOM_FEATURE_TEMPLATE();
        } else {
            // í…œí”Œë¦¿ í•¨ìˆ˜ê°€ ì—†ì„ ê²½ìš° ìˆ˜ë™ ìƒì„± (ë¹„ìƒìš©)
            data.rooms[roomName].features = { states: { menuWait: {} }, racing: {}, lotto: {} };
        }
    }
    
    // ì…ë ¥ ëŒ€ê¸° ìƒíƒœ(mState)ëŠ” í˜„ì¬ ì ‘ì†í•œ 1:1 ë°©ì— ì €ì¥
    var rFeatures = data.rooms[roomName].features;
    if (!rFeatures.states) rFeatures.states = { menuWait: {} };
    var mState = rFeatures.states.menuWait; 

Â  Â  // [ì¤‘ìš”] ê²Œì„ íŒëˆ/ê¸°ë¡ ë°ì´í„°ëŠ” ë©”ì¸ ìš´ì˜ ë°©("ë‚´ë¦¬ë‹¤")ì˜ ë°ì´í„°ë¥¼ ê°•ì œ ì°¸ì¡°
Â  Â  var MAIN_ZONE = "ë‚´ë¦¬ë‹¤";
Â  Â  var mainRoomData = data.rooms[MAIN_ZONE];
Â  Â Â 
Â  Â  if (!mainRoomData.features.casino) {
Â  Â  Â  Â  mainRoomData.features.casino = {
Â  Â  Â  Â  Â  Â  ladder: { round: 1, history: [], bets: {} },
Â  Â  Â  Â  Â  Â  baccarat: { round: 1, history: [], bets: {} }
Â  Â  Â  Â  };
Â  Â  }
Â  Â  var casino = mainRoomData.features.casino;

    /* ëª…ë ¹ì–´ ì²˜ë¦¬: /ì¹´ì§€ë…¸ */
Â  Â  if (cleanMsg === "/ì¹´ì§€ë…¸") {
        // [í•µì‹¬] í˜„ì¬ ë°©ì´ ë‹¨ì²´ë°©ì´ ì•„ë‹ˆë©´ "ë‚´ë¦¬ë‹¤" ë°©ì˜ ìƒíƒœë¥¼ ì²´í¬í•¨
        var economyRoom = (ALLOWED_ROOMS.indexOf(roomName) === -1) ? "ë‚´ë¦¬ë‹¤" : roomName;

        if (typeof util_isBankruptcy === 'function' && util_isBankruptcy(economyRoom)) {
            var bankMsg = "ğŸš¨ [ê¸´ê¸‰: ì¹´ì§€ë…¸ ì„ì‹œ íœ´ì—…]\n" +
                          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                          "í˜„ì¬ ë©”ì¸ êµ¬ì—­(" + economyRoom + ")ì˜ êµ­ê°€ ë¶€ë„ ì„ í¬ë¡œ ì¸í•´\n" +
                          "ëª¨ë“  ê²Œì„ê³¼ ë°°íŒ…ì´ ì „ë©´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n" +
                          "ğŸ“ ì‚¬ìœ : êµ­ê³  ì¬ì› ê³ ê°ˆ ë° ìê¸ˆ í†µì œ\n" +
                          "ğŸ“‰ ì¡°ì¹˜: ì¹´ì§€ë…¸ ì „ë©´ íì‡„ (1:1 ì´ìš© ë¶ˆê°€)";
            
            replier.reply(formatCommand("ğŸ° ì¹´ì§€ë…¸ ì˜ì—… ì •ì§€", user, bankMsg, "í•´ì œ ê¸°ì¤€: êµ­ê³  50% ë³µêµ¬"));
            return true; 
        }

        if (user.mining && user.mining.active === true) {
            replier.reply(formatError(user, "ë°°íŒ… ë¶ˆê°€", "í˜„ì¬ ê´‘ì‚°ì—ì„œ ì±„êµ´ ì‘ì—… ì¤‘ì…ë‹ˆë‹¤."));
            return true;
        }

        var nowTs = Date.now();
        // 1) ë§ˆì§€ë§‰ í™œë™ í›„ 3ë¶„ì´ ì§€ë‚¬ê±°ë‚˜, ê°ì‹œ ì‹œì‘ ê¸°ë¡ì´ ì—†ëŠ” ê²½ìš° ìƒˆ ì„¸ì…˜ìœ¼ë¡œ ì‹œì‘
        if (nowTs - (user.lastBotUseTime || 0) > 180000 || !user.casinoAuditStartTime) {
            user.casinoAuditStartTime = nowTs; // ì‹œì‘ ì‹œê°„ ê¸°ë¡
            user.casinoAuditStartAssets = Number(user.point || 0) + Number(user.bank || 0); // í˜„ì¬ ì´ ìì‚° ê¸°ë¡
            user.casinoAuditAlertHistory = []; // ì•Œë¦¼ ì´ë ¥ ì´ˆê¸°í™”
           if (ALLOWED_ROOMS.indexOf(roomName) === -1) {
            var entryLog = "ğŸ”” [ì¹´ì§€ë…¸ ì…ì¥ ì•Œë¦¼]\n" +
                           "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                           "ğŸ‘¤ ìœ ì €: " + user.name + "\n" +
                           "ğŸ†” ID: " + targetUid + "\n" +
                           "ğŸ“ ì¥ì†Œ: 1:1 ëŒ€í™”ë°© (" + roomName + ")\n" +
                           "ğŸ’° í˜„ì¬ìì‚°: " + fp(Number(user.point) + Number(user.bank || 0)) + " P\n" +
                           "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                           "âš ï¸ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì¤‘";
            
            try { Api.replyRoom("ë² ë¦­ë°©", entryLog); } catch(e) { Log.error("Entry Alert Fail: " + e); }
        }
      }

        user.lastBotUseTime = nowTs; 
        mState[targetUid] = { type: 'casino_main', time: Date.now() };

        var body = "í˜„ì¬ ì…ì¥ ê°€ëŠ¥í•œ ê²Œì„ë£¸ì…ë‹ˆë‹¤.\n\n" +
                   "1. ğŸŒ“ ì‚¬ë‹¤ë¦¬ (2ë¶„ ì£¼ê¸° / 1.90~4.0ë°°)\n" +
                   "2. ğŸƒ ë°”ì¹´ë¼ (3ë¶„ ì£¼ê¸° / 2.0~8.0ë°°)\n" +
                   "3. ğŸ•´ï¸ ë¸”ë™ì­ (ê°œì¸ì „ / ë”œëŸ¬ ëŒ€ê²°)\n";
        
        replier.reply(formatCommand("ğŸ° ë‚´ë¦¬ë‹¤ ì¤‘ì•™ ì¹´ì§€ë…¸", user, body, "ì´ë™í•˜ì‹¤ ê²Œì„ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
        safeSaveData(data);
        return true; 
    }

    /* ìˆ«ì ì…ë ¥ ì²˜ë¦¬ */
Â  Â  var state = mState[targetUid];
Â  Â  if (!state) return false; // ëŒ€ê¸° ìƒíƒœê°€ ì—†ìœ¼ë©´ ì¢…ë£Œ

Â  Â  // 2. ì‚¬ë‹¤ë¦¬ ë©”ë‰´
Â  Â  if (state.type === 'casino_main' && cleanMsg === "1") {
Â  Â  Â  Â  mState[targetUid] = { type: 'casino_ladder', time: Date.now() };
Â  Â  Â  Â  _showCasinoSubMenu(replier, user, "ì‚¬ë‹¤ë¦¬", casino.ladder, 2);
        safeSaveData(data);
Â  Â  Â  Â  return true;
Â  Â  }

Â  Â  // 3. ë°”ì¹´ë¼ ë©”ë‰´
Â  Â  if (state.type === 'casino_main' && cleanMsg === "2") {
Â  Â  Â  Â  mState[targetUid] = { type: 'casino_baccarat', time: Date.now() };
Â  Â  Â  Â  _showCasinoSubMenu(replier, user, "ë°”ì¹´ë¼", casino.baccarat, 3);
        safeSaveData(data);
Â  Â  Â  Â  return true;
Â  Â  }

Â  Â  // 3-1. ë¸”ë™ì­ ë©”ë‰´
Â  Â  if (state.type === 'casino_main' && cleanMsg === "3") {
Â  Â  Â  Â  if (typeof util_isBankruptcy === 'function' && util_isBankruptcy(roomName)) {
Â  Â  Â  Â  Â  Â  replier.reply(formatError(user, "ë¸”ë™ì­ íì‡„", "êµ­ê°€ ë¶€ë„ ì„ í¬ë¡œ ì¸í•´ ë”œëŸ¬ë“¤ì´ ëª¨ë‘ íœ´ê°€ ì¤‘ì…ë‹ˆë‹¤."));
Â  Â  Â  Â  Â  Â  return true;
Â  Â  Â  Â  }
        
        // ë±…í¬ í”„ë¡œì„¸ìŠ¤ ìƒíƒœ ì´ˆê¸°í™” í™•ì¸
        if (!data.rooms[roomName].features.states.bankProcess) {
            data.rooms[roomName].features.states.bankProcess = {};
        }

Â  Â  Â  Â  // ë°°íŒ… ê¸ˆì•¡ ì…ë ¥ ìƒíƒœë¡œ ì „í™˜
Â  Â  Â  Â  data.rooms[roomName].features.states.bankProcess[targetUid] = { type: 'blackjack_bet_input', time: Date.now() };
Â  Â  Â  Â  delete mState[targetUid];
Â  Â  Â  Â Â 
Â  Â  Â  Â  var minB = SYSTEM_CONFIG.ECO.GAMBLE_MIN || 2000;
Â  Â  Â  Â  var maxB = SYSTEM_CONFIG.ECO.GAMBLE_MAX || 50000;
Â  Â  Â  Â  replier.reply(formatCommand("ğŸ•´ï¸ ë¸”ë™ì­ í…Œì´ë¸” ì…ì¥", user, "ë”œëŸ¬ê°€ ì¹´ë“œë¥¼ ì„ê³  ìˆìŠµë‹ˆë‹¤.\në°°íŒ…í•˜ì‹¤ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n\nâ€¢ ìµœì†Œ: " + fp(minB) + "P\nâ€¢ ìµœëŒ€: " + fp(maxB) + "P", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
        safeSaveData(data);
Â  Â  Â  Â  return true;
Â  Â  }

Â  Â  // 4. ê²Œì„ë³„ ì„¸ë¶€ ê¸°ëŠ¥
Â  Â  if (state.type === 'casino_ladder' || state.type === 'casino_baccarat') {
Â  Â  Â  Â  var gameType = (state.type.indexOf('ladder') !== -1) ? "ladder" : "baccarat";Â 
Â  Â  Â  Â  var gameObj = casino[gameType];
Â  Â  Â  Â  var interval = (gameType === "ladder") ? 2 : 3;

Â  Â  Â  Â  if (cleanMsg === "1") {
Â  Â  Â  Â  Â  Â  mState[targetUid].type = state.type + "_sub";Â 
Â  Â  Â  Â  Â  Â  _showCasinoRoundInfo(replier, user, gameType, gameObj, interval, roomName);
Â  Â  Â  Â  } else if (cleanMsg === "2") {
Â  Â  Â  Â  Â  Â  mState[targetUid].type = state.type + "_sub";Â 
Â  Â  Â  Â  Â  Â  _showCasinoHistory(replier, user, gameType, gameObj);
Â  Â  Â  Â  } else if (cleanMsg === "3") {
Â  Â  Â  Â  Â  Â  mState[targetUid].type = state.type + "_sub";
Â  Â  Â  Â  Â  Â  _showCasinoDailyHistory(replier, user, gameType);
Â  Â  Â  Â  }
        safeSaveData(data);
Â  Â  Â  Â  return true;
Â  Â  }

Â  Â  return false;
}

/* [ì„œë¸Œ] ì¹´ì§€ë…¸ ê²Œì„ë³„ 2ë‹¨ê³„ ë©”ë‰´ ì¶œë ¥ */
function _showCasinoSubMenu(replier, user, title, obj, interval) {
    var now = new Date();
    var remainSec = (interval * 60) - ((now.getMinutes() % interval) * 60 + now.getSeconds());
    var min = Math.floor(remainSec / 60);
    var sec = remainSec % 60;

    var totalBet = 0;
    for (var uid in obj.bets) { totalBet += Number(obj.bets[uid].amount); }

    var lastResLine = "";
    var gKey = (title === "ì‚¬ë‹¤ë¦¬") ? "ladder" : "baccarat";
    // [ìˆ˜ì •] íƒ€ì…(gKey)ì´ ì¼ì¹˜í•˜ê³ , ë°”ë¡œ ì§ì „ íšŒì°¨(obj.round-1) ê¸°ë¡ì¼ ë•Œë§Œ ì¶œë ¥
    if (user.lastCasinoResult && user.lastCasinoResult.type === gKey) {
        var lr = user.lastCasinoResult;
        if (Number(lr.round) === Number(obj.round) - 1) {
            var icon = lr.isWin ? "ğŸŠ" : "ğŸ’€";
            var sign = lr.isWin ? "+" : "";
            lastResLine = "â€¢ ë‚´ ì§ì „ê²°ê³¼: " + lr.res + " [" + sign + fp(lr.profit) + "P] " + icon + "\n";
        }
    }

    var body = "ì§„í–‰ ì¤‘ì¸ íšŒì°¨ ë° ë©”ë‰´ë¥¼ ì„ íƒí•˜ì„¸ìš”.\n\n" +
               "[í˜„ì¬ íšŒì°¨ ì •ë³´]\n" +
               "â€¢ íšŒì°¨: ì œ " + (obj.round || 1) + "íšŒì°¨\n" +
               lastResLine + // ìš”ì•½ ë¼ì¸ ì‚½ì…
               "â€¢ ë‚¨ì€ ì‹œê°„: " + (min > 0 ? min + "ë¶„ " : "") + sec + "ì´ˆ\n" +
               "â€¢ ì´ íŒëˆ: " + fp(totalBet) + "P\n\n" +
               "1. ğŸ“ˆ ì§„í–‰ ì¤‘ì¸ íšŒì°¨ ì •ë³´ (ë°°íŒ… í˜„í™©)\n" +
               "2. ğŸ“‹ ìµœê·¼ 10ê²½ê¸° ê²°ê³¼\n" +
               "3. ğŸ† ê¸ˆì¼ ë‹¹ì²¨ ê¸°ë¡ í™•ì¸";

    replier.reply(formatCommand((title === "ì‚¬ë‹¤ë¦¬" ? "ğŸªœ " : "ğŸƒ ") + title + " ê²Œì„ì‹¤", user, body, "ì›í•˜ì‹œëŠ” ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
}

/**
 * @param {String} type - "ladder" ë˜ëŠ” "baccarat"
 */
function _showCasinoDailyHistory(replier, user, type) {
    var wins = (type === "ladder") ? (user.dailyLadderWins || []) : (user.dailyBaccaratWins || []);
    var titleStr = (type === "ladder") ? "ğŸªœ ì‚¬ë‹¤ë¦¬" : "ğŸƒ ë°”ì¹´ë¼";
    
    var list = [];
    var totalProfit = 0;
    
    if (wins.length === 0) {
        list.push("(ê¸ˆì¼ ë‹¹ì²¨ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤)");
    } else {
        // ìµœëŒ€ 15ê±´ê¹Œì§€ë§Œ ì¶œë ¥ (ë§í’ì„  ê¸¸ì´ ì œí•œ ëŒ€ë¹„)
        var displayCount = Math.min(wins.length, 15);
        for (var i = 0; i < displayCount; i++) {
            var w = wins[i];
            var pickName = (type === "ladder") ? w.pick : w.res;
            list.push("â€¢ [" + w.round + "íšŒ] " + pickName + " : +" + fp(w.profit) + "P (" + w.time + ")");
            totalProfit += Number(w.profit);
        }
        if (wins.length > 15) list.push("...ì™¸ " + (wins.length - 15) + "ê±´ ë” ìˆìŒ");
    }

    var body = "[ì˜¤ëŠ˜ì˜ ìŠ¹ì „ë³´]\n" + list.join("\n") + "\n\n" +
               "ğŸ“Š ë‹¹ì¼ ëˆ„ì  í•©ê³„\n" +
               "â€¢ ë‹¹ì²¨ íšŸìˆ˜: " + wins.length + "íšŒ\n" +
               "â€¢ ëˆ„ì  ìˆ˜ìµ: +" + fp(totalProfit) + "P";

    replier.reply(formatCommand(titleStr + " ê¸ˆì¼ ë‹¹ì²¨ ë¦¬í¬íŠ¸", user, body, "(â†©ï¸ ë’¤ë¡œ / ğŸ  ì²˜ìŒìœ¼ë¡œ)"));
}

/* [ì„œë¸Œ] ì‹¤ì‹œê°„ ë°°íŒ… í˜„í™©íŒ ë° ë°°íŒ… ê°€ì´ë“œ */
function _showCasinoRoundInfo(replier, user, type, obj, interval, roomName) {
    var now = new Date();
    var remainSec = (interval * 60) - ((now.getMinutes() % interval) * 60 + now.getSeconds());
    var totalBet = 0;
    var stats = {};

    // ë°°íŒ… ë¦¬í¬íŠ¸ ì§‘ê³„
    for (var uid in obj.bets) {
        var b = obj.bets[uid];
        totalBet += Number(b.amount);
        stats[b.pick] = (stats[b.pick] || 0) + Number(b.amount);
    }

    var report = "";
    if (type === "ladder") {
        var picks = ["í™€", "ìš°3í™€", "ì¢Œ4í™€", "ì§", "ì¢Œ3ì§", "ìš°4ì§"];
        picks.forEach(function(p) {
            var amt = stats[p] || 0;
            var per = totalBet > 0 ? Math.floor((amt / totalBet) * 100) : 0;
            var icon = (p.indexOf("í™€") !== -1) ? "ğŸ”µ" : "ğŸ”´";
            report += icon + " " + p + " : " + fp(amt) + "P (" + per + "%)\n";
        });
    } else {
        var bPicks = { "P": "í”Œë ˆì´ì–´", "B": "ë±…ì»¤", "T": "íƒ€ì´" };
        for (var k in bPicks) {
            var amt = stats[k] || 0;
            var per = totalBet > 0 ? Math.floor((amt / totalBet) * 100) : 0;
            report += "â€¢ " + bPicks[k] + " : " + fp(amt) + "P (" + per + "%)\n";
        }
    }

    var title = (type === "ladder" ? "ì‚¬ë‹¤ë¦¬" : "ë°”ì¹´ë¼");
    var payoutMsg = (type === "ladder" ? "ë‹¨ì¼ x1.9 / ì¡°í•© x4.0" : "P x2.0 / B x1.95 / T x8.0");

    var minBetVal = SYSTEM_CONFIG.ECO.GAMBLE_MIN || 2000;
    var maxLimitVal = SYSTEM_CONFIG.ECO.GAMBLE_MAX || 50000;

    var bettingExample = (type === "ladder") ? "í™€ 5000" : "í”Œë ˆì´ì–´ 10000";
    var subExample = (type === "ladder") ? "ì¢Œ3ì§ 10000" : "íƒ€ì´ 5000";

    var body = "ì‹¤ì‹œê°„ìœ¼ë¡œ ì§‘ê³„ëœ ë°°íŒ… ë¹„ìœ¨ì…ë‹ˆë‹¤.\n" +
               "ğŸ•’ " + remainSec + "ì´ˆ í›„ ë°°íŒ…ì´ ë§ˆê°ë©ë‹ˆë‹¤.\n\n" +
               "[ë°°íŒ… ë¦¬í¬íŠ¸]\n" + report + "\n" +
               "ğŸ¦ ì´ ë°°íŒ…ì•¡ : " + fp(totalBet) + "P\n" +
               "âš–ï¸ í˜„ì¬ ë°°ë‹¹ë¥  : " + payoutMsg + "\n\n" +
               "ìµœì†Œ ë°°íŒ…ê¸ˆ : " + fp(minBetVal) + "P\n" +
               "ìµœëŒ€ ë°°íŒ…ê¸ˆ : " + fp(maxLimitVal) + "P\n\n" + // 50,000P ìë™ ë°˜ì˜
               "ğŸ’¬ [ë°°íŒ… ì…ë ¥ ì˜ˆì‹œ]\n" +
               "ğŸ‘‰ " + bettingExample + "\n" +
               "ğŸ‘‰ " + subExample + "\n\n" +
               "ë§ˆê° 5ì´ˆì „ì—ëŠ” ë°°íŒ…ì´ ì°¨ë‹¨ë©ë‹ˆë‹¤.";

    replier.reply(formatCommand("ğŸ“ˆ ì œ " + (obj.round || 1) + "íšŒì°¨ " + title + " í˜„í™©", user, body, "(â†©ï¸ ë’¤ë¡œ / ğŸ  ì²˜ìŒìœ¼ë¡œ)"));
}

/* [ì„œë¸Œ] ìµœê·¼ 10ê²½ê¸° ê²°ê³¼ ë‚´ì—­ */
function _showCasinoHistory(replier, user, type, obj) {
    var list = [];
    var history = obj.history || [];
    
    if (history.length === 0) {
        list.push("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    } else {
        history.forEach(function(h) {
            var icon = (h.res.indexOf("í™€") !== -1 || h.res === "P" || h.res === "T") ? "ğŸ”µ" : "ğŸ”´";
            var resName = h.res;
            if (type === "baccarat") resName = { "P": "í”Œë ˆì´ì–´", "B": "ë±…ì»¤", "T": "íƒ€ì´" }[h.res];
            list.push("â€¢ " + h.round + "íšŒì°¨ : [" + resName + "] " + icon);
        });
    }

    var range = history.length > 0 ? " [" + history[history.length-1].round + " ~ " + history[0].round + "íšŒì°¨]" : "";
    var body = "[ìµœê·¼ ê²½ê¸° ê²°ê³¼]" + range + "\n\n" + list.join("\n");
    
    replier.reply(formatCommand("ğŸ“‹ ìµœê·¼ 10ê²½ê¸° ê²°ê³¼ ë‚´ì—­", user, body, "ê²°ê³¼ëŠ” ì‹¤ì‹œê°„ ê°±ì‹ ë©ë‹ˆë‹¤."));
}

/* [ì…ë ¥ í•¸ë“¤ëŸ¬] ì±„íŒ… ì§ì ‘ ë°°íŒ… ì²˜ë¦¬ ì—”ì§„ */
function _handleCasinoBet(msg, user, data, replier, roomName, targetUid) {
    var MAIN_ZONE = "ë‚´ë¦¬ë‹¤"; 
    var mainRoomData = data.rooms[MAIN_ZONE];

    var mState = data.rooms[roomName].features.states.menuWait;
    if (!mState || !mState[targetUid] || !mState[targetUid].type || mState[targetUid].type.indexOf("casino_") === -1) return false;

    // [ë¶€ë„ ê°€ë“œ] ë² íŒ… ë¡œì§ ì§„ì… ì „ ìµœìš°ì„  ê²€ì¦
    if (typeof util_isBankruptcy === 'function' && util_isBankruptcy(roomName)) {
        var bankMsg = "ğŸš¨ [ê¸´ê¸‰: ì¹´ì§€ë…¸ ì˜ì—… ì •ì§€]\n" +
                      "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                      "êµ­ê°€ ë¶€ë„ ì„ í¬ë¡œ ì¸í•´ ì¹´ì§€ë…¸ ë‚´ ëª¨ë“ \n" +
                      "í˜„ê¸ˆ ê±°ë˜ ë° ë°°íŒ…ì´ ì „ë©´ ë™ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n" +
                      "ğŸ­ ìƒíƒœ: ì„ì‹œ íœ´ì—… (ì •ë¶€ ê´€í• )\n" +
                      "âš–ï¸ ì‚¬ìœ : ê²½ì œ íšŒìƒì„ ìœ„í•œ ìê¸ˆ í†µì œ";
        
        replier.reply(formatCommand("ğŸ° ì¹´ì§€ë…¸ íì‡„ ì•Œë¦¼", user, bankMsg, "ì •ë¶€ì˜ íšŒìƒ ì¡°ì¹˜ë¥¼ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”."));
        return true; // ë¡œì§ ì¢…ë£Œ ë° ì…ë ¥ ì°¨ë‹¨
    }

    var state = mState[targetUid];
    var parts = msg.split(" ");
    if (parts.length < 2) return false;

    var pick = parts[0];
    var amt = parseInt(parts[1].replace(/,/g, ""));
    if (isNaN(amt) || amt <= 0) return false;

    // 1. ê²Œì„ íƒ€ì… íŒë³„ ë³´ì • (Sub ìƒíƒœ í¬í•¨ ì¸ì‹)
    var gameType = (state.type.indexOf("ladder") !== -1) ? "ladder" : "baccarat";
    var casino = mainRoomData.features.casino[gameType]; 
    
    var interval = (gameType === "ladder") ? 2 : 3;

    // 2. ë°°íŒ… ê°€ëŠ¥ ì„ íƒì§€ ê²€ì¦
    var validPicks = (gameType === "ladder") ? ["í™€", "ì§", "ì¢Œ3ì§", "ìš°3í™€", "ì¢Œ4í™€", "ìš°4ì§"] : ["í”Œë ˆì´ì–´", "ë±…ì»¤", "íƒ€ì´", "P", "B", "T"];
    if (validPicks.indexOf(pick) === -1) return false;

    // 3. ìê¸ˆ ë° í•œë„ ê²€ì¦ (ìƒìˆ˜ ì°¸ì¡° êµì •: CASINO.MIN_BET -> ECO.GAMBLE_MIN)
    var minLimit = SYSTEM_CONFIG.ECO.GAMBLE_MIN || 2000;
    var maxLimit = SYSTEM_CONFIG.ECO.GAMBLE_MAX;

    // 4. ì‹œê°„ ë§ˆê° ê°€ë“œ (5ì´ˆ ì „ ì°¨ë‹¨)
    var now = new Date();
    var secInCycle = (now.getMinutes() % interval) * 60 + now.getSeconds();
    var limit = (interval * 60) - 5;
    
    if (secInCycle >= limit) {
        replier.reply(formatError(user, "ë°°íŒ… ë§ˆê°", "íšŒì°¨ ë§ˆê° 5ì´ˆ ì „ì—ëŠ” ë°°íŒ…ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤."));
        return true;
    }

    if (Number(user.point) < amt) {
        replier.reply(formatError(user, "í¬ì¸íŠ¸ ë¶€ì¡±", "ë³´ìœ  í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."));
        return true;
    } else if (amt < minLimit) {
        replier.reply(formatError(user, "ë°°íŒ… ê¸ˆì•¡ ë¯¸ë‹¬", "ìµœì†Œ ë°°íŒ…ê¸ˆì€ " + fp(minLimit) + "Pì…ë‹ˆë‹¤."));
        return true;
    } else if (amt > maxLimit) {
        replier.reply(formatError(user, "í•œë„ ì´ˆê³¼", (gameType === "ladder" ? "ì‚¬ë‹¤ë¦¬" : "ë°”ì¹´ë¼") + "ì˜ ìµœëŒ€ í•œë„ëŠ” " + fp(maxLimit) + "Pì…ë‹ˆë‹¤.\n(í˜„ì¬ ì…ë ¥: " + fp(amt) + "P)"));
        return true;
    }

    // 1ì¸ 1íšŒ ë°°íŒ… ì œí•œ ê°€ë“œ (ì´ë¯¸ ë°°íŒ… ë°ì´í„°ê°€ ì¡´ì¬í•˜ë©´ ì°¨ë‹¨)
    if (casino.bets[targetUid]) {
        replier.reply(formatError(user, "ì¤‘ë³µ ë°°íŒ… ì œí•œ", "ì´ë¯¸ ì´ë²ˆ íšŒì°¨ì— ë°°íŒ…ì„ ì™„ë£Œí•˜ì…¨ìŠµë‹ˆë‹¤.\nì¹´ì§€ë…¸ëŠ” ê²Œì„ ì¢…ë¥˜ë³„ë¡œ íšŒì°¨ë‹¹ 1íšŒë§Œ ì°¸ì—¬ ê°€ëŠ¥í•©ë‹ˆë‹¤."));
        return true;
    }

    // 5. ë°°íŒ… ì ‘ìˆ˜ ì²˜ë¦¬ (ë°”ì¹´ë¼ í•œê¸€ ë§¤í•‘ í¬í•¨)
    var finalPick = pick;
    if (gameType === "baccarat") {
        var bMap = { "í”Œë ˆì´ì–´": "P", "ë±…ì»¤": "B", "íƒ€ì´": "T", "P": "P", "B": "B", "T": "T" };
        finalPick = bMap[pick] || pick;
    }

    // 6. í¬ì¸íŠ¸ ì°¨ê° ë° í†µê³„ ê¸°ë¡
    user.skipHealing = true; 
    util_updatePoint(user, mainRoomData, -amt, "ì¹´ì§€ë…¸ ë°°íŒ… ì°¸ì—¬ (" + pick + ")", MAIN_ZONE);
    
    user.totalGambleCount = (user.totalGambleCount || 0) + 1;
    user.totalCasinoBet = (user.totalCasinoBet || 0) + amt;
    casino.bets[targetUid] = { pick: finalPick, amount: amt, name: user.name, uid: targetUid };

    // 7. ì¹­í˜¸ ìë™ ë¶€ì—¬ ì²´í¬ (ì¹´ì§€ë…¸ í†µí•© íŒì • ë° ì„¤ëª… ìˆ˜ì •)
    var winRate = (user.totalGambleWins / user.totalGambleCount) * 100;
    
    if (user.totalGambleCount >= 500) {
        util_checkAndAwardTitle(user, replier, "ë„ë°•ì™•", 4003, "ğŸ²", "ë‚´ë¦¬ë‹¤ ì¹´ì§€ë…¸ í˜‘íšŒ", 
            "ì¹´ì§€ë…¸ í†µí•© 500íšŒ ì°¸ì—¬ ë‹¬ì„±", 
            "[ì¥ì°© íš¨ê³¼]: ëª¨ë“  ì¹´ì§€ë…¸ ê²Œì„(ì‚¬ë‹¤ë¦¬, ë°”ì¹´ë¼, ë¸”ë™ì­) ì •ì‚° ì‹œ ë°°ë‹¹ë¥  +0.05 ì¶”ê°€ ì ìš©", 
            roomName);
    } else if (user.totalGambleCount >= 100 && winRate >= 60) {
        util_checkAndAwardTitle(user, replier, "íƒ€ì§œ", 4002, "ğŸ´", "ë‚´ë¦¬ë‹¤ ì¹´ì§€ë…¸ í˜‘íšŒ", 
            "ì¹´ì§€ë…¸ í†µí•© ìŠ¹ë¥  60% ëŒíŒŒ", 
            "íŒì„ ì½ëŠ” ë‚ ì¹´ë¡œìš´ ëˆˆì„ ê°€ì¡ŒìŠµë‹ˆë‹¤.", 
            roomName);
    } else if (user.totalGambleCount >= 100) {
        util_checkAndAwardTitle(user, replier, "ê¾¼", 4001, "ğŸƒ", "ë‚´ë¦¬ë‹¤ ì¹´ì§€ë…¸ í˜‘íšŒ", 
            "ì¹´ì§€ë…¸ í†µí•© 100íšŒ ì°¸ì—¬", 
            "ì¹´ì§€ë…¸ì˜ ìƒë¦¬ë¥¼ ê¹¨ë‹¬ì€ ìŠ¹ë¶€ì‚¬", 
            roomName);
    }
    
    var remain = (interval * 60) - secInCycle;
    var successMsg = "â€¢ íšŒì°¨: ì œ " + (casino.round || 1) + "íšŒì°¨\n" +
                     fp(amt) + "P ë°°íŒ… ì™„ë£Œ\n\n" +
                     "â€¢ ì„ íƒ: " + pick + "\n" +
                     "ğŸ’° ë³´ìœ  í¬ì¸íŠ¸: " + fp(user.point) + "P\n" +
                     "ğŸš« ìµœëŒ€ í•œë„: " + fp(maxLimit) + "P";

    var displayTitle = (gameType === "ladder" ? "ğŸªœ ì‚¬ë‹¤ë¦¬ ë°°íŒ… ì™„ë£Œ" : "ğŸƒ ë°”ì¹´ë¼ ë°°íŒ… ì™„ë£Œ");
    replier.reply(formatSimple(displayTitle, successMsg));

    // ë°°íŒ… ì™„ë£Œ í›„ ë©”ë‰´ ëŒ€ê¸° ìƒíƒœë¥¼ ì¦‰ì‹œ ì‚­ì œí•˜ì—¬ ì‘ë‹µ ëŒ€ê¸° ì¢…ë£Œ
    if (mState && mState[targetUid]) {
        delete mState[targetUid];
    }
    safeSaveData(data);
    return true;
}

/** [ë¸”ë™ì­ ì‹œì‘] ìµœì´ˆ ì¹´ë“œ ë¶„ë°° ë° ìŠ¤í…Œì´ì§• ì ìš© */
function _startBlackjackGame(user, data, replier, roomName, targetUid, betAmt) {
    var roomData = data.rooms[roomName];
    user.skipHealing = true;
    
    // í¬ì¸íŠ¸ ì„ ì°¨ê° (ê²Œì´íŠ¸ì›¨ì´ ì¤€ìˆ˜)
    util_updatePoint(user, roomData, -betAmt, "ë¸”ë™ì­ ë°°íŒ… ì°¸ì—¬", roomName);

    // ì¹´ë“œ ìƒì„± (1~10, JQK=10, A=11)
    var getCard = function() {
        var num = Math.floor(Math.random() * 13) + 1;
        if (num > 10) return 10; // J, Q, K
        if (num === 1) return 11; // A (ê¸°ë³¸ 11)
        return num;
    };

    var pHand = [getCard(), getCard()];
    var dHand = [getCard(), getCard()];

    user.blackjackState = {
        bet: betAmt,
        playerHand: pHand,
        dealerHand: dHand,
        status: 'playing'
    };

    // ë©”ë‰´ ì„ íƒ ìƒíƒœë¡œ ì „í™˜
    roomData.features.states.menuWait[targetUid] = { type: 'blackjack_action', time: Date.now() };

    var body = "ğŸ•´ï¸ ë”œëŸ¬ê°€ ì¹´ë“œë¥¼ ëŒë ¸ìŠµë‹ˆë‹¤.\n\n" +
               "ğŸ¤– ë”œëŸ¬: [ ? ], [ " + dHand[1] + " ]\n" +
               "ğŸ‘¤ ë‚˜: [ " + pHand.join(", ") + " ]\n" +
               "ğŸ’° í•©ê³„: " + _calcBJScore(pHand) + "ì \n\n" +
               "1. í›(Hit) - ì¹´ë“œ í•œ ì¥ ë”\n" +
               "2. ìŠ¤í…Œì´(Stay) - ë©ˆì¶”ê³  ë¹„êµ";

    replier.reply(formatCommand("ğŸƒ ë¸”ë™ì­: 1:1 ëŒ€ê²°", user, body, "ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”."));
    safeSaveData(data);
}

/** [ë¸”ë™ì­ ì•¡ì…˜ í•¸ë“¤ëŸ¬] í›/ìŠ¤í…Œì´ ì²˜ë¦¬ */
function _handleBlackjackAction(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];
    var state = user.blackjackState;
    if (!state) return false;

    if (msg === "1") { // HIT
        var newCard = Math.floor(Math.random() * 13) + 1;
        if (newCard > 10) newCard = 10;
        if (newCard === 1) newCard = 11;
        
        state.playerHand.push(newCard);
        var score = _calcBJScore(state.playerHand);

        if (score > 21) {
            _finishBlackjack(user, data, replier, roomName, targetUid, "BUST");
        } else {
            // ë”œëŸ¬ì˜ ë¸”ëŸ¬í•‘ ë©˜íŠ¸ ìƒì„±
            var bluffs = [
                "ì˜¤í˜¸.. ì ìˆ˜ê°€ ê½¤ ë†’ì€ë°ìš”? ìš•ì‹¬ë‚´ë‹¤ê°„ í„°ì§ˆì§€ë„ ëª¨ë¦…ë‹ˆë‹¤.",
                "ì œ ë°”ë‹¥íŒ¨ê°€ ê·¸ë¦¼(10)ì¼ í™•ë¥ ì´ ì•„ì£¼ ë†’ì€ë°.. ê´œì°®ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?",
                "ì§€ê¸ˆ ë©ˆì¶”ë©´ ë¹„ê¸¸ ìˆ˜ë„ ìˆì„ ê²ƒ ê°™êµ°ìš”.",
                "ì¹´ë“œë¥¼ ë” ë°›ìœ¼ì‹œë‹¤ë‹ˆ, ëŒ€ë‹´í•˜ì‹œë„¤ìš”."
            ];
            var bluffMsg = "\n\nğŸ’¬ ë”œëŸ¬: \"" + bluffs[Math.floor(Math.random() * bluffs.length)] + "\"";
            
            var body = "ğŸ¤– ë”œëŸ¬: [ ? ], [ " + state.dealerHand[1] + " ]\n" +
                       "ğŸ‘¤ ë‚˜: [ " + state.playerHand.join(", ") + " ]\n" +
                       "ğŸ’° í•©ê³„: " + score + "ì " + bluffMsg + "\n\n" +
                       "1. í›(Hit) / 2. ìŠ¤í…Œì´(Stay)";
            replier.reply(formatCommand("ğŸƒ ë¸”ë™ì­ ì§„í–‰ ì¤‘", user, body));
            roomData.features.states.menuWait[targetUid].time = Date.now(); // ì‹œê°„ ì—°ì¥
        }
        return true;
    } 
    else if (msg === "2") { // STAY
        _finishBlackjack(user, data, replier, roomName, targetUid, "STAY");
        return true;
    }
    return false;
}

/** [ë¸”ë™ì­ ê²°ê³¼ ì •ì‚°] ë„ë°•ì™• ë°°ë‹¹(+0.05) ì ìš© ë° í†µí•© ë©”ì‹œì§€ ì¶œë ¥ */
function _finishBlackjack(user, data, replier, roomName, targetUid, action) {
    var roomData = data.rooms[roomName];
    var state = user.blackjackState;
    var pScore = _calcBJScore(state.playerHand);
    var dScore = _calcBJScore(state.dealerHand);
    
    delete roomData.features.states.menuWait[targetUid];
    user.blackjackState = null;
    
    // [ì¹´ìš´íŠ¸ ì—°ë™]
    user.totalGambleCount = (user.totalGambleCount || 0) + 1;

    // 1. ë”œëŸ¬ ì¹´ë“œ ë“œë¡œìš° (ì¼ë‹¨ ê·œì¹™ëŒ€ë¡œ ë½‘ìŒ)
    if (action === "STAY") {
        while (dScore < 17) {
            var c = Math.floor(Math.random() * 13) + 1;
            if (c > 10) c = 10; if (c === 1) c = 11;
            state.dealerHand.push(c);
            dScore = _calcBJScore(state.dealerHand);
        }
    }

    // 2. [ìŠ¹ë¥  ì¡°ì‘] ìœ ì €ë³„ ìŠ¹ë¥  ì—°ë™ (ê¸°ë³¸ 45% or ì¡°ì‘ê°’)
    // ìœ ì €ê°€ ì´ë¯¸ ë²„ìŠ¤íŠ¸(21ì´ˆê³¼)ë¼ë©´ ì¡°ì‘ ì—†ì´ íŒ¨ë°° í™•ì •
    if (pScore <= 21) {
        var targetWinRate = 45; // ê¸°ë³¸ ëª©í‘œ ìŠ¹ë¥  45%

        // [ìˆ˜ì •] ìœ ì €ê°€ ì¡°ì‘ ìƒíƒœë¼ë©´ ì„¤ì •ëœ ìŠ¹ë¥ (gambleWinRate)ì„ ìš°ì„  ì ìš©
        if (user.isManipulated && user.gambleWinRate > 0) {
            targetWinRate = user.gambleWinRate;
        }

        var isUserWin = (Math.random() * 100 < targetWinRate);

        if (isUserWin) {
            // [ìŠ¹ë¦¬ ì‹œë‚˜ë¦¬ì˜¤]: ìœ ì €ê°€ ì´ê²¨ì•¼ í•¨
            // ë§Œì•½ ë”œëŸ¬ê°€ ì´ê¸°ê±°ë‚˜ ë¹„ê¸°ê³  ìˆë‹¤ë©´ -> ë”œëŸ¬ë¥¼ ê°•ì œ ë²„ìŠ¤íŠ¸(22)ì‹œí‚´
            if (dScore <= 21 && dScore >= pScore) {
                dScore = 22; 
            }
        } else {
            // [íŒ¨ë°° ì‹œë‚˜ë¦¬ì˜¤]: ìœ ì €ê°€ ì ¸ì•¼ í•¨
            // ë§Œì•½ ë”œëŸ¬ê°€ í„°ì¡Œê±°ë‚˜ ì ìˆ˜ê°€ ë‚®ë‹¤ë©´ -> ë”œëŸ¬ ì ìˆ˜ë¥¼ (ìœ ì €+1)ë¡œ ì¡°ì‘
            if (dScore > 21 || dScore < pScore) {
                dScore = pScore + 1;
                // ë‹¨, 21ì ì„ ë„˜ê¸¸ ìˆœ ì—†ìœ¼ë¯€ë¡œ ìµœëŒ€ 21ë¡œ ê³ ì •
                if (dScore > 21) dScore = 21;
            }
        }
    }

    // 3. ìµœì¢… ìŠ¹íŒ¨ íŒì • (ì¡°ì‘ëœ dScore ê¸°ì¤€)
    var resultStr = ""; 
    var resultStatus = "LOSE"; 

    if (pScore > 21) { resultStr = "ë²„ìŠ¤íŠ¸(Bust) íŒ¨ë°°! ğŸ’€"; resultStatus = "LOSE"; }
    else if (dScore > 21) { resultStr = "ë”œëŸ¬ ë²„ìŠ¤íŠ¸! ìŠ¹ë¦¬! ğŸŠ"; resultStatus = "WIN"; }
    else if (pScore > dScore) { resultStr = "ì ìˆ˜ ìš°ìœ„ ìŠ¹ë¦¬! ğŸŠ"; resultStatus = "WIN"; }
    else if (pScore < dScore) { resultStr = "ë”œëŸ¬ ì ìˆ˜ ìš°ìœ„ íŒ¨ë°°! ğŸ’€"; resultStatus = "LOSE"; }
    else { resultStr = "ë¬´ìŠ¹ë¶€ (Push) ğŸ˜"; resultStatus = "PUSH"; }

    // 4. ë°°ë‹¹ë¥  ì‚°ì¶œ (ë„ë°•ì™• ë³´ë„ˆìŠ¤ +0.05)
    var multiplier = 0;
    var bonusTag = "";

    if (resultStatus === "WIN") {
        multiplier = 1.90;
        if (user.title === "ë„ë°•ì™•") {
            multiplier += 0.05; 
            bonusTag = " ğŸ‘‘ë„ë°•ì™•";
        }
        user.totalGambleWins = (user.totalGambleWins || 0) + 1;
    } else if (resultStatus === "PUSH") {
        multiplier = 1.0; 
    }

    var prize = Math.floor(state.bet * multiplier);
    var finalMsg = "ğŸ¤– ë”œëŸ¬ íŒ¨: [ " + state.dealerHand.join(", ") + " ] (" + dScore + "ì )\n" +
                   "ğŸ‘¤ ë‚˜ì˜ íŒ¨: [ " + state.playerHand.join(", ") + " ] (" + pScore + "ì )\n\n" +
                   "ğŸ“¢ ê²°ê³¼: " + resultStr;

    if (prize > 0 && resultStatus === "WIN") {
        // 1. [ê³ ì • ì„¸ê¸ˆ ê³„ì‚°] ë°°íŒ…ê¸ˆì˜ 0.1ë°°(10%)ë¥¼ ì„¸ê¸ˆìœ¼ë¡œ ì±…ì •
        var economyRoom = (ALLOWED_ROOMS.indexOf(roomName) === -1) ? "ë‚´ë¦¬ë‹¤" : roomName;

        if (!util_isBankSolvent(roomName, prize)) {
            replier.reply(formatError(user, "ì€í–‰ ì§€ë¶ˆ ë¶ˆëŠ¥", "êµ­ê°€ ë¶€ë„ ìƒíƒœë¡œ ì¸í•´ ìƒê¸ˆì„ ì§€ê¸‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nê²Œì„ì´ ë¬´íš¨ ì²˜ë¦¬ë˜ì–´ ë°°íŒ…ê¸ˆì´ ì†Œë©¸ë˜ì—ˆìŠµë‹ˆë‹¤."));
            return; // ìƒíƒœëŠ” ì´ë¯¸ ìƒë‹¨ì—ì„œ íŒŒê¸°ë˜ì—ˆìœ¼ë¯€ë¡œ ì•ˆì „í•˜ê²Œ ì¢…ë£Œ
        }
        var taxAmount = Math.floor(state.bet * 0.1);
        var netIncome = prize; // prizeëŠ” ì´ë¯¸ 1.90ë°°ê°€ ì ìš©ëœ ê¸ˆì•¡

        // 2. ì„¸ê¸ˆ êµ­ê³  í™˜ìˆ˜ ì§‘í–‰
        util_updateReserve(roomData, taxAmount, "ë¸”ë™ì­ ì´ìš©ì„¸ ì§•ìˆ˜", roomName);

        // 3. [ìƒí™˜ ì²˜ë¦¬] ì„¸í›„ ê¸ˆì•¡ìœ¼ë¡œ ë¹š ìƒí™˜ ì§„í–‰
        var res = processRepayment(user, netIncome, targetUid, roomName);

        // 4. ìµœì¢… ì‹¤ìˆ˜ë ¹ì•¡ ì§€ê¸‰
        util_updatePoint(user, roomData, Number(res.actualGain), "ë¸”ë™ì­ ì •ì‚° ìˆ˜ìµ", roomName);

        // 5. UI ë©”ì‹œì§€ ì¡°ë¦½ (ì¹´ì§€ë…¸ ì´ìš©ì„¸ ê³ ì • ìˆ˜ì¹˜ í‘œì‹œ)
        finalMsg += "\nğŸ’° íšë“: +" + fp(prize) + "P (1.90ë°° ì ìš©)";
        finalMsg += "\n\nâš–ï¸ ì„¸ê¸ˆ(10%): -" + fp(taxAmount) + "P (ì¹´ì§€ë…¸ ì´ìš©ì„¸)";
        if (res.repayMsg) finalMsg += res.repayMsg;
        finalMsg += "\nğŸ’° ìµœì¢… ìˆ˜ìµ: +" + fp(res.actualGain) + "P" + bonusTag;

        var nowStr = new Date().getHours() + ":" + ("0" + new Date().getMinutes()).slice(-2);
        if (!user.dailyBlackjackWins) user.dailyBlackjackWins = [];
        user.dailyBlackjackWins.unshift({ round: "BJ", res: "ìŠ¹ë¦¬", profit: prize, time: nowStr });
        user.lastCasinoResult = { type: "blackjack", round: "BJ", res: "ìŠ¹ë¦¬", profit: prize, isWin: true };
    } 
    else if (prize > 0 && resultStatus === "PUSH") {
        // ë¬´ìŠ¹ë¶€ ì‹œì—ëŠ” ì„¸ê¸ˆ ì—†ì´ ì›ê¸ˆë§Œ ë°˜í™˜
        util_updatePoint(user, roomData, prize, "ë¸”ë™ì­ ë¬´ìŠ¹ë¶€ í™˜ê¸‰", roomName);
        finalMsg += "\nğŸ’° í™˜ê¸‰: +" + fp(prize) + "P (ë°°íŒ…ê¸ˆ ë°˜í™˜)";
        user.lastCasinoResult = { type: "blackjack", round: "BJ", res: "ë¬´ìŠ¹ë¶€", profit: 0, isWin: false };
    }
    else {
        user.lastCasinoResult = { type: "blackjack", round: "BJ", res: "íŒ¨ë°°", profit: -state.bet, isWin: false };
    }

    replier.reply(formatCommand("ğŸ ë¸”ë™ì­ ê²°ê³¼ Report", user, finalMsg + "\n\nğŸ”í•œë²ˆë” âê·¸ë§Œ", "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
    
    user.blackjackState = null;
    roomData.features.states.menuWait[targetUid] = { type: 'blackjack_retry', time: Date.now() };
    
    safeSaveData(data);
}

/** [ì‹ ê·œ] ë¸”ë™ì­ ì¬ë„ì „(í•œë²ˆë”/ê·¸ë§Œ) ì²˜ë¦¬ í•¸ë“¤ëŸ¬ */
function _handleBlackjackRetry(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];
    var mState = roomData.features.states.menuWait;
    var state = mState[targetUid];

    // 1. ì‹œê°„ ì´ˆê³¼ ì²´í¬ (30ì´ˆ)
    if (Date.now() - state.time > 30000) {
        delete mState[targetUid];
        replier.reply(formatError(user, "ì„ íƒ ì‹œê°„ ì´ˆê³¼", "30ì´ˆ ì´ë‚´ì— ì„ íƒí•˜ì§€ ì•Šì•„ ë¸”ë™ì­ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    // 2. ì¢…ë£Œ (ê·¸ë§Œ/ì·¨ì†Œ)
    if (msg === "ê·¸ë§Œ" || msg === "ì·¨ì†Œ" || msg === "â") {
        delete mState[targetUid];
        replier.reply(formatCommand("ğŸš« ë¸”ë™ì­ ì¢…ë£Œ", user, "í…Œì´ë¸”ì—ì„œ ì¼ì–´ë‚¬ìŠµë‹ˆë‹¤."));
        return true;
    }

    // 3. ì¬ë„ì „ (í•œë²ˆë”/ë¦¬íŠ¸)
    if (msg === "í•œë²ˆë”" || msg === "í•œë²ˆ ë”" || msg === "ë¦¬íŠ¸" || msg === "ğŸ”") {
        // [ë¶€ë„ ê°€ë“œ] ì¬í™•ì¸
        if (typeof util_isBankruptcy === 'function' && util_isBankruptcy(roomName)) {
            delete mState[targetUid];
            replier.reply(formatError(user, "ë¸”ë™ì­ íì‡„", "êµ­ê°€ ë¶€ë„ ì„ í¬ë¡œ ì¸í•´ ë”œëŸ¬ë“¤ì´ íœ´ì—… ì¤‘ì…ë‹ˆë‹¤."));
            return true;
        }

        // ìƒíƒœ ì „í™˜: ë©”ë‰´ ëŒ€ê¸°(retry) -> ê¸ˆì•¡ ì…ë ¥ ëŒ€ê¸°(bet_input)
        delete mState[targetUid];
        
        // ì„¹í„° 22-1 ë“±ì—ì„œ ì²˜ë¦¬í•˜ëŠ” ì…ë ¥ ëŒ€ê¸° ìƒíƒœë¡œ ì „í™˜ (ì¦‰ì‹œ ë°°íŒ… ê°€ëŠ¥)
        data.rooms[roomName].features.states.bankProcess[targetUid] = { type: 'blackjack_bet_input', time: Date.now() };
        
        var minB = SYSTEM_CONFIG.ECO.GAMBLE_MIN || 2000;
        var maxB = SYSTEM_CONFIG.ECO.GAMBLE_MAX || 50000;
        
        replier.reply(formatCommand("ğŸ•´ï¸ ë¸”ë™ì­ ì¬ë„ì „", user, "ë°°íŒ…í•˜ì‹¤ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n\nâ€¢ ìµœì†Œ: " + fp(minB) + "P\nâ€¢ ìµœëŒ€: " + fp(maxB) + "P", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
        return true;
    }

    return false;
}

/** ì ìˆ˜ ê³„ì‚°ê¸° (Aì²˜ë¦¬ í¬í•¨) */
function _calcBJScore(hand) {
    var score = 0; var aces = 0;
    hand.forEach(function(c) { if (c === 11) aces++; score += c; });
    while (score > 21 && aces > 0) { score -= 10; aces--; } // Aë¥¼ 11ì—ì„œ 1ë¡œ ë³€í™˜
    return score;
}
