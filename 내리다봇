//==========ì„¹í„°1==========

/* [ì‹ ê·œ] ëª…ë ¹ì–´ ìë™ ë“±ë¡ ì‹œìŠ¤í…œ (Command Registry) */
var USER_COMMANDS = {};
var ADMIN_COMMANDS = {};

function registerUserCmd(cmd, desc, cat, func) {
    USER_COMMANDS[cmd] = { desc: desc, cat: cat, execute: func };
}

function registerAdminCmd(cmd, desc, func) {
    ADMIN_COMMANDS[cmd] = { desc: desc, execute: func };
}

/* íŒŒì¼ ë° ë°ì´í„° ë™ê¸°í™” ê°ì²´ */
var Lock = java.util.concurrent.locks.ReentrantLock; 
var lock = new Lock(); 
var logLock = new Lock(); // [v5.8] ì €ë„ë§(ë¸”ë™ë°•ìŠ¤) ì „ìš© ë…ë¦½ ë½ ì¶”ê°€
var SD_PATH = android.os.Environment.getExternalStorageDirectory().getAbsolutePath(); 
var BASE_DIR = SD_PATH + "/kakaobot/data/"; 
var FILE_PATH = BASE_DIR + "attendance.json"; 
var JOURNAL_PATH = BASE_DIR + "transaction.log"; // [v5.8] ì‹¤ì‹œê°„ ê±°ë˜ ê¸°ë¡ìš© ë¸”ë™ë°•ìŠ¤ ê²½ë¡œ
var BACKUP_DIR = BASE_DIR + "backup/"; 

/* [ìµœì í™”] ì „ì—­ UID ìºì‹œ ì‹œìŠ¤í…œ */
var uidCache = uidCache || {}; 

/* [ìµœì í™”] ë³‘ë ¬ ì²˜ë¦¬ ì—”ì§„ ë¶„ë¦¬ */
// 1. ëª…ë ¹ì–´ ì²˜ë¦¬ ì—”ì§„: 8ê°œì˜ ìŠ¤ë ˆë“œê°€ ìœ ì €ì™€ ì†Œí†µ (ì‘ë‹µ ì†ë„ ë‹´ë‹¹)
var Executor = java.util.concurrent.Executors.newFixedThreadPool(6);
// 2. [ì‹ ê·œ] ì €ì¥ ì „ë‹´ ì—”ì§„: ë‹¨ 1ê°œì˜ ìŠ¤ë ˆë“œê°€ ìˆœì°¨ì ìœ¼ë¡œ íŒŒì¼ ê¸°ë¡ (ì•ˆì „ì„± ë‹´ë‹¹)
var SaveExecutor = java.util.concurrent.Executors.newSingleThreadExecutor();

/* ë¡œê·¸ ì €ì¥ ê²½ë¡œ ë° ë””ë ‰í† ë¦¬ ì„¤ì • */ 
var BUG_LOG_PATH = BASE_DIR + "logs/bug_report.txt"; 
var ERROR_LOG_PATH = BASE_DIR + "logs/error_log.txt"; 
var logDir = new java.io.File(BASE_DIR + "logs/"); 
if (!logDir.exists()) logDir.mkdirs(); 
var dir = new java.io.File(BACKUP_DIR); 
if (!dir.exists()) dir.mkdirs(); 

/* ì „ì—­ ìƒíƒœ ë³€ìˆ˜ */ 
var globalData = null; 
var isRecovering = false; // [v5.8] ë¶€íŒ… ì‹œ ë³µêµ¬ í”„ë¡œì„¸ìŠ¤ ì§„í–‰ ì—¬ë¶€ í”Œë˜ê·¸

/**
 * [Gemini ìš”ì²­ ì‚¬í•­] ë°©ë³„ ë…ë¦½í™”ë¥¼ ìœ„í•œ ë°ì´í„° í…œí”Œë¦¿
 * ì„¤ëª…: ì•„ë˜ì˜ êµ¬ì¡°ê°€ ê° ë°©(Room)ì´ ìƒì„±ë  ë•Œë§ˆë‹¤ ë…ë¦½ì ìœ¼ë¡œ ë³µì œë˜ì–´ í• ë‹¹ë©ë‹ˆë‹¤.
 */
var ROOM_FEATURE_TEMPLATE = function() {
    return {
        /* [Gemini ìš”ì²­ ì‚¬í•­] ê²½ë§ˆ ì‹œìŠ¤í…œ ì‹¤ì‹œê°„ ìƒíƒœ ë° ìƒìˆ˜ ì„¤ëª… í†µí•© */
        racing: {
            round: 1,           // [íšŒì°¨]: ê²½ë§ˆì˜ ì§„í–‰ ì°¨ìˆ˜ë¥¼ ê¸°ë¡ (ë´‡ ì¬ì‹œì‘ ì‹œ 1ë¡œ ì´ˆê¸°í™”ë¨)
            horses: [           // [ì¶œì „ë§ˆ ì •ë³´]: ê° ë§ì˜ ê³ ìœ  ID, ì´ë¦„, ìš°ìŠ¹ ê°€ì¤‘ì¹˜(weight), ìƒíƒœ ì•„ì´ì½˜ ì €ì¥
                { id: 1, name: "ì–´ë§ˆì–´ë§ˆ", weight: 1.0, icon: "â˜ï¸ ë³´í†µ" },
                { id: 2, name: "ì–´ì„œë§ì„í•´", weight: 1.0, icon: "â˜ï¸ ë³´í†µ" },
                { id: 3, name: "ë§ˆì˜ì›¨ì´", weight: 1.0, icon: "â˜ï¸ ë³´í†µ" },
                { id: 4, name: "í•µíƒ„ë‘", weight: 1.0, icon: "â˜ï¸ ë³´í†µ" },
                { id: 5, name: "ëŒê²©ì•ìœ¼ë¡œ", weight: 1.0, icon: "â˜ï¸ ë³´í†µ" }
            ],
            bets: {},           // [ë°°íŒ… ê¸°ë¡]: { UID: {horseId, amount, name} } í˜•ì‹ìœ¼ë¡œ í˜„ì¬ íšŒì°¨ ë°°íŒ… ì •ë³´ë¥¼ ì €ì¥
            totalPool: 0,       // [ë‹¹ê¸° ëˆ„ì ê¸ˆ]: ì´ë²ˆ íšŒì°¨ì— ìœ ì €ë“¤ì´ ë°°íŒ…í•œ ìˆœìˆ˜ í¬ì¸íŠ¸ í•©ê³„
            carryOver: 0,       // [ì´ì›”ê¸ˆ/Jackpot]: ì´ì „ íšŒì°¨ì—ì„œ ë‹¹ì²¨ìê°€ ì—†ì–´ ë„˜ì–´ì˜¨ í¬ì¸íŠ¸ (70% ë¹„ìœ¨ ì ìš©ì•¡)
            // [ìš´ì˜ í”Œë˜ê·¸]: ë´‡ ë¡œë“œ ì‹œ í˜„ì¬ ì‹œê°„ì„ ì¦‰ì‹œ íŒë³„í•˜ì—¬ 09:00~23:59 ì‚¬ì´ë©´ ìë™ìœ¼ë¡œ ê°€ë™ ìƒíƒœ(true)ë¡œ ì„¤ì •
            isOperating: (function() {
                var h = new Date().getHours();
                return h >= 9 && h <= 23; 
            })(),
            isDeadlineNotified: false, // [ì•Œë¦¼ ì œì–´]: 49ë¶„ 59ì´ˆ ë§ˆê° ê³µì§€ê°€ ì¤‘ë³µ ë°œì†¡ë˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ëŠ” ìŠ¤ìœ„ì¹˜
            isResultProcessed: false   // [ì •ì‚° ì œì–´]: ì •ê°(00ë¶„) ê²°ê³¼ ì •ì‚° ë¡œì§ì´ ì¤‘ë³µ ì‹¤í–‰ë˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ëŠ” ìŠ¤ìœ„ì¹˜
        },
        /* ë°©ë³„ ì£¼ì‹ ì‹œì¥ ë° ê¸°íƒ€ ë°ì´í„° */
        stockMarket: {},
        stockTraffic: {},
        marketOpenPrice: 0,
        feverData: { active: false, endTime: 0, scheduled: [] },
        sprinkleData: { active: false, winners: [], portions: [] },
        lotto: { round: 1, entries: {}, dailyPool: 0, jackpot: 0, lastWinNums: [] },
        /* ë°©ë³„ ë…ë¦½ ì…ë ¥ ëŒ€ê¸° ìƒíƒœ */
        states: {
            menuWait: {}, bankProcess: {}, selectWait: {}, lottoPurchase: {},
            activeThefts: {}, duelData: {}, mining: {},
            loanRegister: {}, loanContractWait: {}
        }
    };
};

/* ê´€ë¦¬ì UID ê¸°ë°˜ ì¸ì¦ */ 
var adminUIDs = ["fixed-uuid-ê´€ë¦¬ì1", "fixed-uuid-ê´€ë¦¬ì2"]; 

/* ê´€ë¦¬ì ëª…ë ¹ì–´ ëª©ë¡ */ 
var ADMIN_CMD_LIST = [ 
    "1. /ë´‡êµ¬ë™ [ì˜¨|ì˜¤í”„]", "2. /ìœ ì €ë°ì´í„° [ë‹‰ë„¤ì„]", "3. /ë°ì´í„°êµì • (ë¡œì§ë™ê¸°í™”)", 
    "4. /ë°ì´í„°ì´ì „ [êµ¬ë‹‰ > ì‹ ë‹‰]", "5. /ë‹‰ë„¤ì„ê¸°ë¡ [ë‹‰ë„¤ì„]", "6. /ì¶œì„ì´ˆê¸°í™” [ë‹‰ë„¤ì„]", 
    "7. /ì „ì²´í¬ì¸íŠ¸ì§€ê¸‰ [ê¸ˆì•¡]", "8. /í¬ì¸íŠ¸ì°¨ê° [ë‹‰] [ê¸ˆì•¡]", "9. /ë¿Œë¦¬ê¸° (ëœë¤ í¬ì¸íŠ¸)", 
    "10. /ê´€ë¦¬ìë“±ë¡/í•´ì œ/ëª©ë¡", "11. /ê´€ë¦¬ìë¡œê·¸", "12. /ìŠ¹ê¸‰íšŸìˆ˜ì´ˆê¸°í™”", 
    "13. /ì‹œì¦Œê°•ì œì¢…ë£Œ", "14. /ì¶œì„ì¼ìˆ˜ìˆ˜ì • [ë‹‰] [ì¼]", "15. /ì „ì²´ì¶œì„ìˆ˜ì • [ì¼ìˆ˜]", 
    "16. /ë¡œë˜ë°ì´í„°ì´ˆê¸°í™”", "17. /ë„ë°•ì œí•œ [ì˜¨|ì˜¤í”„]", "18. /ê°•ì œì¬ê°€ë™", 
    "19. /ìœ ì €ì‚­ì œ [ë‹‰ë„¤ì„]", "20. /ì‹œìŠ¤í…œìê°€ë³µì› (ìµœì í™”)", "21. /ì „ì²´ë³µì› (ë°ì´í„° ë¡¤ë°±)", 
    "22. /ìœ ì €ë³µì› [ë‹‰ë„¤ì„] (ë¶€ë¶„ë³µêµ¬)", "23. /ì œë³´ëª©ë¡ (ë²„ê·¸í™•ì¸)", "24. /ì˜¤ë¥˜ë¡œê·¸ (ë¡œì§ê²€ì¦)", 
    "25. /ì œë³´ì´ˆê¸°í™”", "26. /ì˜¤ë¥˜ì´ˆê¸°í™”", "27. /í¬ì¸íŠ¸ì§€ê¸‰ [ë‹‰ë„¤ì„] [ìˆ˜ëŸ‰]", 
    "28. /ë¬¼ê°€ì¡°ì • [ê¸°ì¤€ê°’|ì´ˆê¸°í™”]", "29. /ê´€ë¦¬ìí•´ì œ [ë‹‰ë„¤ì„]", "30. /ê´€ë¦¬ìëª©ë¡", 
    "31. /ë¬¼ê°€ì™„ì¶© [0.0~1.0]", "32. /ì¬ì›ìˆ˜ì • [ê¸ˆì•¡] (ì€í–‰ê¸ˆê³ ìˆ˜ì •)", "33. /ê²½ì œì •ë³´(í†µí•©ì§€í‘œí™•ì¸)",
    "34. /ì‹œì¥ìì‚°ë³µêµ¬ (ì£¼ê°€ë³µêµ¬)", "35. /ì¢…ëª©ì¶”ê°€ [ì´ë¦„] [ê°€ê²©]", "36. /ì¢…ëª©ìˆ˜ì • [ê¸°ì¡´] [ì‹ ê·œ] [ê°€ê²©]",
    "37. /ì¬ì›ì¶©ì „ [ê¸ˆì•¡]", "38. /ì‹ ìš©ì¡°ì • [ë‹‰ë„¤ì„] [ì ìˆ˜]"
];

/* ì‹œìŠ¤í…œ í•µì‹¬ ìƒìˆ˜ ì„¤ì • */
var SYSTEM_CONFIG = {
    ECO: {
        /* [ê¸°ì´ˆ ê²½ì œ ì„¤ì •] */
        ATTEND_MIN: 1000, // [ì¶œì„ ìµœì†Œ ì§€ê¸‰]: ì¶œì„ ì²´í¬ ì‹œ ë¬´ì‘ìœ„ë¡œ ì§€ê¸‰ë˜ëŠ” í¬ì¸íŠ¸ì˜ í•˜í•œì„ 
        ATTEND_MAX: 1500, // [ì¶œì„ ìµœëŒ€ ì§€ê¸‰]: ì¶œì„ ì²´í¬ ì‹œ ë¬´ì‘ìœ„ë¡œ ì§€ê¸‰ë˜ëŠ” í¬ì¸íŠ¸ì˜ ìƒí•œì„ 
        GAMBLE_MIN: 300,  // [í™€ì§ ìµœì†Œ ë² íŒ…]: í™€ì§ ê²Œì„ ì§„í–‰ ì‹œ ì…ë ¥ ê°€ëŠ¥í•œ ìµœì†Œ í¬ì¸íŠ¸ ë‹¨ìœ„
        GAMBLE_MAX: 2000, // [í™€ì§ ìµœëŒ€ ë² íŒ…]: í™€ì§ ê²Œì„ì˜ 1íšŒë‹¹ ìµœëŒ€ ë² íŒ… í•œë„ (ì‚¬í–‰ì„± ì¡°ì ˆ)
        
        /* [ì‹ ê·œ] ì¤‘ì•™ì€í–‰ ì§€ê¸‰ì¤€ë¹„ì œë„ ì„¤ì • */
        BANK: {
            RESERVE_RATIO: 0.20, // [ì§€ê¸‰ì¤€ë¹„ìœ¨]: ì€í–‰ ì´ ì˜ˆê¸ˆì•¡ ì¤‘ ëŒ€ì¶œí•´ì¤„ ìˆ˜ ì—†ëŠ” ìµœì†Œ í˜„ê¸ˆ ë³´ìœ  ë¹„ì¤‘ (20%)
            INITIAL_RESERVE: 10000 // [ì´ˆê¸° ì¬ì›]: ë°ì´í„° ì´ˆê¸°í™” ì‹œ ì€í–‰ ê¸ˆê³ ì— ê¸°ë³¸ìœ¼ë¡œ ë“¤ì–´ìˆëŠ” í¬ì¸íŠ¸
        },

        /* [ì‹ ê·œ] ê²½ë§ˆ ì‹œìŠ¤í…œ ì„¸ë¶€ ì„¤ì • ìƒìˆ  */
        RACING: {
            MIN_BET: 1000,       // [ìµœì†Œ ë°°íŒ…ì•¡]: ê²½ë§ˆ ì°¸ì—¬ë¥¼ ìœ„í•œ ìµœì†Œ í¬ì¸íŠ¸
            MAX_BET: 30000,      // [ìµœëŒ€ ë°°íŒ…ì•¡]: í•œ íšŒì°¨ì— ê±¸ ìˆ˜ ìˆëŠ” ìµœëŒ€ í¬ì¸íŠ¸ ìƒí•œì„ 
            TAX_RATE: 0.1,       // [ê¸°ë³¸ ìˆ˜ìˆ˜ë£Œ]: ë‹¹ì²¨ê¸ˆ ì •ì‚° ì „ ì „ì²´ íŒëˆì—ì„œ êµ­ê³ ë¡œ í™˜ìˆ˜ë˜ëŠ” ë¹„ìœ¨ (10%)
            CANCEL_FEE: 0.1,     // [ì·¨ì†Œ ìœ„ì•½ê¸ˆ]: ë°°íŒ… ì·¨ì†Œ ì‹œ ì›ê¸ˆì—ì„œ ì°¨ê°ë˜ì–´ êµ­ê³ ë¡œ ê·€ì†ë˜ëŠ” ìˆ˜ìˆ˜ë£Œ (10%)
            WINLESS_BANK_RATE: 0.3,   // [ë¬´ìŠ¹ì êµ­ê³ í–‰]: ìš°ìŠ¹ì ì—†ì„ ì‹œ íŒëˆì˜ 30%ë¥¼ ì€í–‰ ê¸ˆê³ ë¡œ ì¦‰ì‹œ íšŒìˆ˜
            WINLESS_JACKPOT_RATE: 0.7, // [ë¬´ìŠ¹ì ì´ì›”ì•¡]: ìš°ìŠ¹ì ì—†ì„ ì‹œ íŒëˆì˜ 70%ë¥¼ ë‹¤ìŒ íšŒì°¨ carryOverë¡œ ëˆ„ì 
            OPEN_HOUR: 9,        // ê²½ë§ˆì¥ ìë™ ê°œì¥ ì‹œê° (ì˜¤ì „ 9ì‹œ)
            CLOSE_HOUR: 23,       // ê²½ë§ˆì¥ ë§ˆì§€ë§‰ ë°°íŒ… ë§ˆê° ì‹œê° (ì˜¤í›„ 11ì‹œ 59ë¶„)
            MAX_PAYOUT_MULT: 10   // [ì‹ ê·œ: ë°°ë‹¹ ìƒí•œì„ ]: ë°°íŒ… ê¸ˆì•¡ì˜ ìµœëŒ€ 10ë°°ê¹Œì§€ë§Œ ë‹¹ì²¨ê¸ˆ ìˆ˜ë ¹ ê°€ëŠ¥ (ë…ì‹ ë°©ì§€)
        },
        
        STOCK: {
            PREFIXES: ["ë¡¯ë°", "ì—˜ì§€", "í•œí™”", "ì‚¼ì„±", "ë‘ë°”ì´ì«€ë“", "í˜„ëŒ€", "ì¹´ì¹´ì˜¤", "ë„¤ì´ë²„", "ì• í”Œ", "í…ŒìŠ¬ë¼", "ê´‘ì–´", "ë„ë‹¤ë¦¬", "ë‘ìœ ë…¸"], 
            SUFFIXES: ["ì „ì", "ìƒëª…", "í™”í•™", "ê±´ì„¤", "ì¤‘ê³µì—…", "ë°”ì´ì˜¤", "ì œì•½", "ì—”í„°", "ì‹í’ˆ", "ëª¨í„°ìŠ¤", "ì¿ í‚¤", "ì—ë„ˆì§€", "ë³´í—˜", "í†µì‹ ", "ì¦ê¶Œ"], 
            TRAITS: { // [ì¢…ëª© íŠ¹ì„±]: ê° ì£¼ì‹ íƒ€ì…ë³„ ë³€ë™ì„± ë° ìƒì„± í™•ë¥  ì •ì˜
                "normal": { label: "ì¼ë°˜", volatility: 1.5, prob: 44, icon: "ğŸŒ±" }, 
                "bluechip": { label: "ìš°ëŸ‰ì£¼", volatility: 1, prob: 28, icon: "ğŸ›¡ï¸" }, 
                "scam": { label: "ì‘ì „ì£¼", volatility: 2, prob: 28, icon: "ğŸ”¥" } 
            },
            MANIPULATION: { // [ì£¼ê°€ ì¡°ì‘ í”„ë¦¬ì…‹]: ê´€ë¦¬ìê°€ íŠ¹ì • ì¢…ëª©ì˜ ì‹œì„¸ë¥¼ ê°•ì œë¡œ ì œì–´í•  ë•Œ ì°¸ì¡°
                TARGET: "ë„¤ì´ë²„í†µì‹ ", // ì¡°ì‘ ëŒ€ìƒ ì¢…ëª©ëª…
                IS_UP: true,       // ìƒìŠ¹(true) ë˜ëŠ” í•˜ë½(false) ì—¬ë¶€
                RATE: 0.23,        // ì¡°ì‘ ì‹œ ë³€ë™ë¥  (0.25 = 25%)
                ACTIVE: false      // ì¡°ì‘ ì‹œìŠ¤í…œ í™œì„±í™” ìƒíƒœ (í‰ì†Œì—” false)
            },
            SETTINGS: { // [ì£¼ì‹ ì‹œì¥ ì„¸ë¶€ ì„¤ì •]
                MAX_COUNT: 10,     // ì‹œì¥ì— ë™ì‹œ ìƒì¥ ê°€ëŠ¥í•œ ìµœëŒ€ ì¢…ëª© ìˆ˜
                OPEN_HOUR: 7,      // ì£¼ì‹ ì¥ ê°œì¥ ì‹œê°„
                CLOSE_HOUR: 23,    // ì£¼ì‹ ì¥ ë§ˆê° ì‹œê°„
                MANI_RATE: 0.25,   // ê¸°ë³¸ íŠ¹ìˆ˜ ì´ë²¤íŠ¸(í­ë“±/í­ë½) ë³€ë™í­
                DELIST_LIMIT: 0.03, // [ìƒí ê¸°ì¤€]: ì‹œì¥ í‰ê· ê°€ ëŒ€ë¹„ í•´ë‹¹ ë¹„ìœ¨ ì´í•˜ë¡œ ë–¨ì–´ì§€ë©´ ìƒì¥íì§€ ê²€í† 
                CLOSING_LIMIT: 1.20, // [ì¢…ê°€ ì œí•œ]: ë‹¹ì¼ ì‹œê°€ ëŒ€ë¹„ ìµœëŒ€ ìƒìŠ¹í­ (+20%)
                RESISTANCE_START: 1.15, // [ì €í•­ ì‹œì‘]: ê°€ê²©ì´ ì‹œê°€ ëŒ€ë¹„ 15% ìƒìŠ¹ ì‹œ í•˜ë½ ì••ë ¥ ë°œìƒ
                GRAVITY: 0.05      // [ì¤‘ë ¥ ê³„ìˆ˜]: ì €í•­ êµ¬ê°„ì—ì„œ ê°€ê²©ì„ ì•„ë˜ë¡œ ëŒì–´ë‚´ë¦¬ëŠ” í˜ì˜ ì„¸ê¸°
            }
        },
        MINE: { // [ê´‘ì‚° ì±„êµ´ ì„¤ì •]
            BASE_PER_MIN: 3, // ë¶„ë‹¹ íšë“í•˜ëŠ” ê¸°ë³¸ ì±„êµ´ í¬ì¸íŠ¸ (ë¬¼ê°€ ë°°ìœ¨ ì ìš© ì „)
            COPPER_PROB: 0.05, // êµ¬ë¦¬ ë°œê²¬ í™•ë¥  (5%)
            GOLD_PROB: 0.03,   // ê¸ˆ ë°œê²¬ í™•ë¥  (3%)
            DIA_PROB: 0.005,   // ë‹¤ì´ì•„ëª¬ë“œ ë°œê²¬ í™•ë¥  (0.5%)
            COPPER_MULT: 1.5,  // êµ¬ë¦¬ ë°œê²¬ ì‹œ ìˆ˜ìµ ë°°ìœ¨
            GOLD_MULT: 2.0,    // ê¸ˆ ë°œê²¬ ì‹œ ìˆ˜ìµ ë°°ìœ¨
            DIA_MULT: 10.0,    // ë‹¤ì´ì•„ëª¬ë“œ ë°œê²¬ ì‹œ ìˆ˜ìµ ë°°ìœ¨
            ARTIFACT_CHANCE: 0.001, // [ìœ ë¬¼ ì¡°ê°]: ë§¤ ë¶„ë§ˆë‹¤ ìœ ë¬¼ì„ ì°¾ì„ í™•ë¥  (0.1%)
            ARTIFACT_GOAL: 10  // [ë„êµ´ì™• ì¹­í˜¸]: ìœ ë¬¼ ì¡°ê°ì„ ì´ ê°¯ìˆ˜ë§Œí¼ ëª¨ìœ¼ë©´ ìë™ ë¶€ì—¬
        },
        PRIVATE_LOAN: { // [ì‚¬ì±„(P2P) ì‹œì¥ ì„¤ì •]
            MIN_AMOUNT: 1000,       // ì‚¬ì±„ ë§¤ë¬¼ ë“±ë¡ ì‹œ ìµœì†Œ ë‹¨ìœ„
            MAX_RATE: 15,           // ë²•ì • ìµœê³  ì´ìœ¨ (3ì‹œê°„ë‹¹ ìµœëŒ€ 15%)
            COLLECTION_LIMIT: 24,   // [ì¶”ì‹¬ ì‹œì‘]: ëŒ€ì¶œ í›„ 24ì‹œê°„ ê²½ê³¼ ì‹œ ìˆ˜ìµ ì••ë¥˜(50%) ì‹œì‘
            INTEREST_PERIOD: 3,     // ì´ìê°€ ë³µë¦¬ë¡œ ê³„ì‚°ë˜ì–´ ë¶™ëŠ” ì£¼ê¸° (3ì‹œê°„)
            MIN_BORROW: 1000,       // ìœ ì €ê°€ ì‚¬ì±„ë¥¼ ë¹Œë¦´ ë•Œ ìµœì†Œ ë‹¨ìœ„
            DAILY_LIMIT: 1          // ì€í–‰ ëŒ€ì¶œ ì¼ì¼ ì´ìš© ì œí•œ íšŸìˆ˜
        },
        CREDIT: { // [ì€í–‰ ì‹ ìš© ë“±ê¸‰ ì²´ê³„]
            SCORES: [900, 800, 700, 600, 500], // ê° ë“±ê¸‰ì„ ë‚˜ëˆ„ëŠ” ê¸°ì¤€ ì ìˆ˜
            LIMITS: [30000, 20000, 15000, 10000, 8000, 3000], // ë“±ê¸‰ë³„ ëŒ€ì¶œ ê°€ëŠ¥ í•œë„
            RATES: [1.03, 1.05, 1.13, 1.17, 1.20, 1.35], // ë“±ê¸‰ë³„ ëŒ€í™˜ ì´ìœ¨ (ì›ê¸ˆ ëŒ€ë¹„ ìƒí™˜ì•¡)
            LABELS: ["1ë“±ê¸‰", "2ë“±ê¸‰", "3ë“±ê¸‰", "4ë“±ê¸‰", "5ë“±ê¸‰", "ì‹ ìš©ë¶ˆëŸ‰ì"], 
            ICONS: ["ğŸ‘‘", "ğŸ’", "ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰", "ğŸš«"] 
        }
    },

    SPAM: { // [ë„ë°° ë°©ì§€ ì—”ì§„ ì„¤ì •]
        LIMIT_COUNT: 5,        // ì œí•œ ì‹œê°„ ë‚´ í—ˆìš©ë˜ëŠ” ìµœëŒ€ ë©”ì‹œì§€ ìˆ˜
        LIMIT_WINDOW: 3000,    // ë„ë°° íŒì • ì‹œê°„ ë²”ìœ„ (3000ms = 3ì´ˆ)
        TIMEOUT_MS: 300000     // ë„ë°° ì ë°œ ì‹œ ë´‡ ì´ìš©ì´ ì œí•œë˜ëŠ” ì‹œê°„ (5ë¶„)
    },

    PROB: { // [í•µì‹¬ ê²Œì„ í™•ë¥  ì—”ì§„]
        ODD_EVEN_WIN: 0.47,        // í™€ì§ ê¸°ë³¸ ìŠ¹ë¥  (47%)
        ODD_EVEN_FEVER: 0.52,      // í”¼ë²„íƒ€ì„ ì‹œ í™€ì§ ìŠ¹ë¥  (52%)
        STOCK_NEW_LISTING: 0.5,    // ë§¤ ë³€ë™ íƒ€ì„ë§ˆë‹¤ ì‹ ê·œ ì¢…ëª©ì´ ìƒì¥ë  í™•ë¥  (50%)
        STOCK_SPECIAL: 0.5,        // íŠ¹ì • ì¢…ëª©ì— íŠ¹ìˆ˜ ì´ë²¤íŠ¸(í­ë“±/í­ë½)ê°€ ë°œìƒí•  í™•ë¥  (50%)
        STOCK_UP_CHANCE: 0.45      // íŠ¹ìˆ˜ ì´ë²¤íŠ¸ ë°œìƒ ì‹œ 'ìƒìŠ¹'ì¼ í™•ë¥  (45%, í•˜ë½ì´ ì¡°ê¸ˆ ë” ë†’ìŒ)
    },
    
    MSG: { // [ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì„¤ì •]
        PREFIX: {
            INFO: "â„¹ï¸", ERROR: "ğŸš«", ADMIN: "âš™ï¸", SUCCESS: "âœ…", 
            WARN: "âš ï¸", GAMBLE_WIN: "ğŸŠ", GAMBLE_LOSE: "ğŸ’€", LOAN: "ğŸš¬", MINE: "â›ï¸", TIMEOUT: "ğŸ”‡"
        }, 
        ERR_FORM: "í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.", 
        ERR_MONEY: "í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.", 
        ERR_USER: "ëŒ€ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", 
        ERR_TIMEOUT: "ë„ë°°ë¡œ ì¸í•´ ì´ìš©ì´ ì¼ì‹œ ì œí•œë˜ì—ˆìŠµë‹ˆë‹¤." 
    }
};

//==========ì„¹í„°2==========

/**
 * [v5.8 ì‹ ê·œ] ë¸”ë™ë°•ìŠ¤ ë³µêµ¬ ì—”ì§„ (Replay Journal)
 * ê¸°ëŠ¥: ë´‡ ì¬ì‹œì‘ ì‹œ JSONì— ë¯¸ì²˜ ì €ì¥ë˜ì§€ ëª»í•œ ìµœì‹  ê±°ë˜ ë‚´ì—­ì„ ë¡œê·¸ íŒŒì¼ì—ì„œ ì½ì–´ ë³µêµ¬í•¨.
 * ì´ ë¡œì§ ë•ë¶„ì— "10ì´ˆ ì˜¤ì°¨ ì—†ëŠ” ë³µêµ¬"ê°€ ì‹¤í˜„ë©ë‹ˆë‹¤.
 */
function recoverFromJournal(data) {
    try {
        var journalFile = new java.io.File(JOURNAL_PATH);
        if (!journalFile.exists() || journalFile.length() === 0) return;

        var logs = FileStream.read(JOURNAL_PATH).split("\n");
        var recoveryCount = 0;

        logs.forEach(function(line) {
            if (!line.trim()) return;
            var parts = line.split("|"); // í˜•ì‹: UID|RoomName|Delta|BankReserveDelta
            if (parts.length < 3) return;

            var uid = parts[0];
            var room = parts[1];
            var delta = Number(parts[2]);
            var brDelta = Number(parts[3] || 0);

            // [ë°©ë³„ ê²©ë¦¬ ëŒ€ì‘] í•´ë‹¹ ë°©ê³¼ ìœ ì €ë¥¼ ì°¾ì•„ ë©”ëª¨ë¦¬ ë°ì´í„°ì— ì¦‰ì‹œ í•©ì‚°
            if (data.rooms[room] && data.rooms[room].users[uid]) {
                data.rooms[room].users[uid].point += delta;
                data.rooms[room].bankReserve += brDelta;
                recoveryCount++;
            }
        });

        if (recoveryCount > 0) {
            Log.info("[Recovery] ë¸”ë™ë°•ìŠ¤ ì—”ì§„ì´ " + recoveryCount + "ê±´ì˜ ëˆ„ë½ëœ ìµœì‹  ê±°ë˜ë¥¼ ë³µêµ¬í–ˆìŠµë‹ˆë‹¤.");
        }
    } catch (e) {
        Log.error("Journal Recovery Error: " + e);
    }
}

/**
 * [Gemini ìš”ì²­ ì‚¬í•­] ë°ì´í„°ë² ì´ìŠ¤ ë¡œë“œ í•¨ìˆ˜ (ë°©ë³„ ë…ë¦½ êµ¬ì¡° ìë™ ë§ˆì´ê·¸ë ˆì´ì…˜ í†µí•©)
 * ê¸°ëŠ¥: JSON íŒŒì¼ì„ ë¡œë“œí•˜ê³ , ëª¨ë“  ë°©ì´ ë…ë¦½ëœ ê²Œì„ ë°ì´í„°(features)ë¥¼ ê°–ë„ë¡ ê°•ì œ ì •ê·œí™”í•©ë‹ˆë‹¤.
 */
function getDatabase() {
    if (globalData !== null) return globalData; 
    try {
        var file = new java.io.File(FILE_PATH);
        var initialData;
        
        if (!file.exists()) {
            // ì´ˆê¸° ë°ì´í„° êµ¬ì¡°: ë°©ë³„ ë¶„ë¦¬ë¥¼ ìœ„í•´ ìµœìƒìœ„ ê²Œì„ ë°ì´í„°ë¥¼ ì œê±°í•¨
            initialData = {
                rooms: {}, 
                admins: ["ê´€ë¦¬ì"], 
                botActive: true,
                nickHistory: {}, 
                adminLogs: [],
                economyDamping: 0.5,
                lastDailyReset: "",
                isRecovering: false
            };
        } else {
            var content = FileStream.read(FILE_PATH);
            if (!content) throw new Error("Empty File");
            initialData = JSON.parse(content);
        }

        // [v5.8 í•µì‹¬] JSON ë¡œë“œ ì§í›„, ì•„ì§ íŒŒì¼ì— ì•ˆ ì íŒ 'ë¸”ë™ë°•ìŠ¤ ë¡œê·¸'ë¥¼ ì½ì–´ ë°ì´í„° ì •ë°€ ë³´ì •
        recoverFromJournal(initialData);
        
        // [Gemini ìš”ì²­ ì‚¬í•­] ë°©ë³„ ë…ë¦½í™” ì—”ì§„ (Feature Injection)
        // ë¡œë“œëœ ëª¨ë“  ë°©ì„ ìˆœíšŒí•˜ë©° ë…ë¦½ëœ ê²Œì„ ë°ì´í„° íŒ¨í‚¤ì§€ê°€ ì—†ëŠ” ê²½ìš° ìƒì„±í•´ì¤ë‹ˆë‹¤.
        if (initialData.rooms) {
            for (var rName in initialData.rooms) {
                var targetRoom = initialData.rooms[rName];
                
                // 1. ë°©ë³„ ë…ë¦½ ê²Œì„ ë°ì´í„°(features)ê°€ ì—†ìœ¼ë©´ ì„¹í„° 1ì˜ í…œí”Œë¦¿ìœ¼ë¡œ ìƒì„±
                if (!targetRoom.features) {
                    if (typeof ROOM_FEATURE_TEMPLATE === 'function') {
                        targetRoom.features = ROOM_FEATURE_TEMPLATE();
                        Log.info("[" + rName + "] ë°©ì— ë…ë¦½ ê²Œì„ ì—”ì§„ì„ í• ë‹¹í–ˆìŠµë‹ˆë‹¤.");
                    }
                }

                // 2. í•„ìˆ˜ ê¸°ë³¸ êµ¬ì¡° ë³´ì•ˆ ê°•í™”
                if (!targetRoom.loanPools) targetRoom.loanPools = {};
                if (!targetRoom.loanContracts) targetRoom.loanContracts = {};
                if (targetRoom.bankReserve === undefined) {
                    targetRoom.bankReserve = (SYSTEM_CONFIG && SYSTEM_CONFIG.ECO.BANK.INITIAL_RESERVE) ? SYSTEM_CONFIG.ECO.BANK.INITIAL_RESERVE : 10000; 
                }
            }
        }
        
        globalData = initialData;
        return globalData;
    } catch (e) {
        Log.error("DB Load Error: " + e);
        var stableFile = new java.io.File(BACKUP_DIR + "last_stable_backup.json");
        if (stableFile.exists()) {
            globalData = JSON.parse(FileStream.read(BACKUP_DIR + "last_stable_backup.json"));
            return globalData;
        }
        return null;
    }
}

/* ë¡œì§ ì¶”ì  ì‹œì‘ */
function startTracking(user, commandName) {
    if (!user) return;
    user.lastAction = { cmd: commandName, status: "PENDING", time: Date.now(), msg: "ìˆ˜í–‰ ì‹œì‘" };
}

/**
 * [v5.8 ì—…ê·¸ë ˆì´ë“œ] í¬ì¸íŠ¸ ë³€ë™ ê²€ì¦ ë° ì‹¤ì‹œê°„ ë¸”ë™ë°•ìŠ¤ ê¸°ë¡
 * ê¸°ëŠ¥: ì „ì²´ íŒŒì¼ì„ ì €ì¥(safeSaveData)í•˜ê¸° ì „, í…ìŠ¤íŠ¸ í•œ ì¤„ì„ ë¨¼ì € ì¨ì„œ 'ë¬´ì¡°ê±´ì ì¸ ìœ ì‹¤ ë°©ì§€' ë‹¬ì„±
 */
function verifyPointTransaction(user, prePoint, changeAmount, reason, roomName, brDelta) {
    try {
        var expected = Number(prePoint) + Number(changeAmount);
        var actual = Number(user.point);
        
        if (actual !== expected) {
            var errorMsg = "[" + new Date().toLocaleString() + "] [ë¶ˆì¼ì¹˜] " + (user.name||"") + ": " + reason + " (ì˜ˆìƒ:" + fp(expected) + "/ì‹¤ì œ:" + fp(actual) + ")\n";
            FileStream.append(ERROR_LOG_PATH, errorMsg);
            try { Api.replyRoom("ë‚´ë¦¬ë‹¤", "âš ï¸ í¬ì¸íŠ¸ ë¶ˆì¼ì¹˜ ë°œìƒ\n" + errorMsg); } catch(e){}
            user.lastAction = { cmd: reason, status: "FAIL", amount: changeAmount, time: Date.now(), msg: "ë°ì´í„° ë¶ˆì¼ì¹˜" };
        } else {
            // [v5.8 í•µì‹¬] ê³ ì† ì €ë„ë§(Journaling) ê¸°ë¡
            // ë°© ì´ë¦„(roomName)ê³¼ ì€í–‰ì¬ì›ë³€ë™(brDelta)ì´ ìˆì„ ê²½ìš°ì—ë§Œ ë¸”ë™ë°•ìŠ¤ì— ë‚¨ê¹€
            if (roomName) {
                logLock.lock();
                try {
                    // í˜•ì‹: UID|ë°©ì´ë¦„|ë³€ë™ëŸ‰|ì€í–‰ë³€ë™ëŸ‰
                    var journalEntry = user.uid + "|" + roomName + "|" + changeAmount + "|" + (brDelta || 0) + "\n";
                    FileStream.append(JOURNAL_PATH, journalEntry);
                } finally {
                    logLock.unlock();
                }
            }

            if (user.lastAction && user.lastAction.status !== "FAIL") {
                user.lastAction = { cmd: reason, status: "SUCCESS", amount: changeAmount, time: Date.now(), msg: "ì •ìƒ ì™„ë£Œ" };
            }
        }
    } catch(e) { 
        FileStream.append(ERROR_LOG_PATH, "ê²€ì¦ì˜¤ë¥˜: " + e + "\n"); 
        try { Api.replyRoom("ë‚´ë¦¬ë‹¤", "âš ï¸ í¬ì¸íŠ¸ ê²€ì¦ ì˜¤ë¥˜\n" + e); } catch(err){}
    }
}

/* ë¡œì§ ì¶”ì  ì¢…ë£Œ */
function endTracking(user, isSuccess, resultMsg) {
    if (!user || !user.lastAction) return;
    if (user.lastAction.status === "FAIL") return; 
    user.lastAction.status = isSuccess ? "SUCCESS" : "CRASH";
    user.lastAction.msg = resultMsg;
    user.lastAction.endTime = Date.now();
}

//==========ì„¹í„°3==========

/* [ìµœì í™”] í•˜ì´ë¸Œë¦¬ë“œ ë¹„ë™ê¸° ì˜ì†í™”(Asynchronous Persistence) ì—”ì§„ v5.8 */
/**
 * @param {Object} data - ì €ì¥í•  ë°ì´í„° ê°ì²´
 * @param {Boolean} isForceBackup - trueì¼ ê²½ìš° ë°±ì—… íŒŒì¼ê¹Œì§€ ë¬¼ë¦¬ì ìœ¼ë¡œ ê¸°ë¡
 */
function safeSaveData(data, isForceBackup) {
    if (!data) return;

    globalData = data; // ë©”ëª¨ë¦¬ ë°ì´í„° ì¦‰ì‹œ ë™ê¸°í™” (ì‘ë‹µ ì†ë„ ìµœìš°ì„ )

    // [ë°©ì–´í˜• ë¡œì§] ë¬´ê±°ìš´ ì§ë ¬í™” ë° ë¬´ê²°ì„± ê²€ì¦ì€ ë©”ì¸ ìŠ¤ë ˆë“œì—ì„œ ë¨¼ì € ìˆ˜í–‰
    var content;
    try {
        content = JSON.stringify(data);
        var check = JSON.parse(content);
        if (!check || !check.rooms) {
            throw new Error("ë°ì´í„° êµ¬ì¡° ë¶ˆì™„ì „ (rooms ëˆ„ë½)");
        }
    } catch (e) {
        // [ë³µêµ¬] ê¸°ì¡´ ì‹œìŠ¤í…œì˜ ì•Œë¦¼ ê¸°ëŠ¥ ìœ ì§€
        Log.error("Save Guard Blocked: " + e.message);
        try {
            Api.replyRoom("ë‚´ë¦¬ë‹¤", "âš ï¸ ë°ì´í„° ë³´í˜¸ ì‘ë™: ì˜¤ì—¼ëœ ë°ì´í„°ì˜ ì“°ê¸° ì‹œë„ë¥¼ ì°¨ë‹¨í–ˆìŠµë‹ˆë‹¤.\nì‚¬ìœ : " + e.message);
        } catch (err) {}
        return; // ì˜¤ì—¼ëœ ë°ì´í„°ëŠ” ë°°ê²½ ì¼ê¾¼ì—ê²Œ ë„˜ê¸°ì§€ ì•Šê³  ì¦‰ì‹œ ì°¨ë‹¨
    }

    // [ë¹„ë™ê¸° ì²˜ë¦¬] ì‹¤ì œ íŒŒì¼ ì“°ê¸°ëŠ” ì €ì¥ ì „ë‹´ ì¼ê¾¼(SaveExecutor)ì—ê²Œ ìœ„ì„
    SaveExecutor.execute(new java.lang.Runnable({
        run: function() {
            // [ì•ˆì •ì„±] ì‹±ê¸€ ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œ ë½ì„ í†µí•œ ìˆœì°¨ì  ê¸°ë¡ ë³´ì¥
            lock.lock(); 
            try {
                var targetPath = FILE_PATH;
                var tempPath = FILE_PATH + ".tmp";
                var tempFile = new java.io.File(tempPath);
                
                FileStream.write(tempPath, content);

                // ì›ìì  êµì²´ (Atomic Rename)
                if (tempFile.exists() && tempFile.length() > 0) {
                    var orgFile = new java.io.File(targetPath);
                    if (orgFile.exists()) orgFile.delete();
                    tempFile.renameTo(orgFile);

                    // [v5.8 í•µì‹¬] ì „ì²´ ì €ì¥ì´ ì„±ê³µí–ˆìœ¼ë¯€ë¡œ ë¸”ë™ë°•ìŠ¤(Journal) ë¡œê·¸ ì´ˆê¸°í™”
                    // ë°ì´í„°ê°€ ì˜êµ¬ íŒŒì¼ì— ì•ˆì°©í–ˆìœ¼ë¯€ë¡œ ì„ì‹œ ê¸°ë¡ëœ ë¡œê·¸ë“¤ì€ ë” ì´ìƒ í•„ìš” ì—†ìŒ
                    logLock.lock();
                    try {
                        var jFile = new java.io.File(JOURNAL_PATH);
                        if (jFile.exists()) jFile.delete();
                    } finally {
                        logLock.unlock();
                    }
                } else {
                    throw new Error("ì„ì‹œ íŒŒì¼ ìƒì„± ì‹¤íŒ¨ ë˜ëŠ” ë°ì´í„° ìœ ì‹¤");
                }

                // ì£¼ê¸°ì  ë°±ì—… ì²˜ë¦¬
                if (isForceBackup) {
                    var backupPath = BACKUP_DIR + "last_stable_backup.json";
                    FileStream.write(backupPath + ".tmp", content);
                    var bTemp = new java.io.File(backupPath + ".tmp");
                    if (bTemp.exists() && bTemp.length() > 0) {
                        var oldB = new java.io.File(backupPath);
                        if (oldB.exists()) oldB.delete();
                        bTemp.renameTo(oldB);
                    }
                }
            } catch (e) {
                Log.error("Async File Write Error: " + e);
                try {
                    Api.replyRoom("ë‚´ë¦¬ë‹¤", "âš ï¸ ì‹œìŠ¤í…œ ì˜¤ë¥˜: ë°°ê²½ ì €ì¥ ì‹¤íŒ¨\n" + e.message);
                } catch (err) {}
            } finally {
                lock.unlock(); // ì‘ì—… ì™„ë£Œ í›„ ë½ í•´ì œ
            }
        }
    }));
}

//==========ì„¹í„°4==========

/* ê´€ë¦¬ì ë° ì‹œìŠ¤í…œ ì„¤ì • */
var FIXED_ADMINS = ["95 ë‚¨ ê´‘ì–´"]; // ì—¬ê¸°ì— ë³¸ì¸ì˜ ì •í™•í•œ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”
var TIERS = ["ì•„ì´ì–¸", "ë¸Œë¡ ì¦ˆ", "ì‹¤ë²„", "ê³¨ë“œ", "í”Œë ˆí‹°ë„˜", "ì—ë©”ë„ë“œ", "ë‹¤ì´ì•„ëª¬ë“œ", "ë§ˆìŠ¤í„°", "ê·¸ëœë“œë§ˆìŠ¤í„°", "ì±Œë¦°ì €"];
var ALLOWED_ROOMS = ["ë‚´ë¦¬ë‹¤", "í…ŒìŠ¤íŠ¸"]; 

//==========ì„¹í„°5==========

/* ê³ í‹°ì–´ ìŠ¹ê¸‰ í™•ë¥  ì„¤ì • */
var TIER_PROBS = {
    0: { up: 95, stay: 5, down: 0 },
    1: { up: 85, stay: 15, down: 0 },
    2: { up: 70, stay: 25, down: 5 },
    3: { up: 50, stay: 40, down: 10 },
    4: { up: 35, stay: 50, down: 15 },
    5: { up: 20, stay: 60, down: 20 },
    6: { up: 12, stay: 68, down: 20 },
    7: { up: 8, stay: 67, down: 25 },  
    8: { up: 5, stay: 70, down: 25 }  
};

/* ìƒì  ì¹´í…Œê³ ë¦¬ ì •ì˜ */
var SHOP_CATEGORIES = {
    1: "ğŸ¨ ì¥ì°©/ê¾¸ë¯¸ê¸° (ì•„ì´ì½˜)",
    2: "ğŸ”‚ ì„±ì¥/ê²Œì„ (ìŠ¹ê¸‰, ë°©ì–´)",
    3: "ğŸ’³ ê²½ì œ/ì§€ì› (ì‹ ìš©, ì¸ì¦, ê¸°íƒ€)",
    4: "ğŸ ëœë¤ ë½‘ê¸° (ì•„ì´ì½˜ ë°•ìŠ¤)",
    5: "ğŸ« íŠ¹ìˆ˜/ë³µê¶Œ (ë¡œë˜)"
};

/* [ìˆ˜ì •] ìƒì  ì•„ì´í…œ ë°ì´í„° (ê²½ê³ ì‚­ì œê¶Œ ì¶”ê°€) */
var SHOP_ITEMS = [
    { id: 1, name: "í™œë™ê°€ ì•„ì´ì½˜", icon: "ğŸŒ±", price: 500, effect: "icon", title: "", cat: 1 },
    { id: 2, name: "ìˆ™ë ¨ì ì•„ì´ì½˜", icon: "âš”ï¸", price: 2000, effect: "icon", title: "", cat: 1 },
    { id: 3, name: "ëŸ¬ë¸”ë¦¬ ì•„ì´ì½˜", icon: "â£ï¸", price: 5000, effect: "icon", title: "", cat: 1 },
    { id: 4, name: "ë² í…Œë‘ ì•„ì´ì½˜", icon: "ğŸ’", price: 9000, effect: "icon", title: "", cat: 1 },
    { id: 5, name: "ì—ì´ë¦¬ì–¸ ì•„ì´ì½˜", icon: "ğŸ‘¾", price: 12000, effect: "icon", title: "", cat: 1 },
    { id: 6, name: "ë„¤ì„ë“œ ì•„ì´ì½˜", icon: "ğŸ‘‘", price: 15000, effect: "icon", title: "", cat: 1 },
    { id: 8, name: "ìŠ¹ê¸‰ ê¸°íšŒ êµ¬ë§¤", icon: "ğŸ”‚", price: 150, effect: "promotion", cat: 2 },  
    { id: 9, name: "ê°•ë“± ë°©ì–´ê¶Œ", icon: "ğŸ›¡ï¸", price: 2000, effect: "tierGuard", cat: 2 },
    { id: 10, name: "ì‹ ìš© ì ìˆ˜ íšŒë³µ", icon: "ğŸ’Š", price: 1500, effect: "credit", value: 50, cat: 3 },
    { id: 11, name: "[ì‹œì¦Œ] ë¡¤ íŒìˆ˜ ì¸ì¦ê¶Œ", icon: "ğŸ«", price: 15000, effect: "gameAuth", cat: 3 },
    /* [ì‹ ê·œ] ê²½ê³ ì‚­ì œê¶Œ: ê¸°ë³¸ê°€ 500,000P ì„¤ì • */
    { id: 13, name: "ê²½ê³ ì‚­ì œê¶Œ", icon: "ğŸ«", price: 500000, effect: "warnClear", cat: 3 },
    { id: 12, name: "ëœë¤ ì•„ì´ì½˜ ë°•ìŠ¤", icon: "ğŸ", price: 3000, effect: "randomBox", cat: 4 },
    { id: 7, name: "ë¡œë˜ êµ¬ë§¤", icon: "ğŸŸï¸", price: 1000, effect: "lotto", cat: 5 }
];

/* [ì‹ ê·œ] ëœë¤ ì•„ì´ì½˜ ë°•ìŠ¤ ìƒì„¸ êµ¬ì„± ë° í™•ë¥  ì„¤ì • */
var RANDOM_BOX_CONFIG = {
    PROBS: [
        { grade: "ê½ (Trash)", icon: "ğŸ’©", prob: 0.60, items: ["ğŸ’©", "ğŸ¤¡", "ğŸ§¤", "ğŸ‘", "ğŸŒ‚", "ğŸª ", "ğŸš½", "ğŸ¦´", "ğŸ§±", "ğŸ§¹", "ğŸ§º", "ğŸ§»", "ğŸ§¼", "ğŸ¦¶", "ğŸ¦Ÿ"] },
        { grade: "ë…¸ë§ (Normal)", icon: "ğŸŒ±", prob: 0.20, items: ["ğŸŒ±", "âš”ï¸", "â£ï¸", "ğŸ€", "ğŸ€", "ğŸˆ", "ğŸ§¸", "ğŸª", "ğŸ­", "ğŸ", "ğŸ„", "ğŸŒ»", "ğŸ±", "ğŸ¶", "ğŸ"] },
        { grade: "ë ˆì–´ (Rare)", icon: "ğŸ’", prob: 0.10, items: ["ğŸ’", "ğŸ‘¾", "ğŸ›¡ï¸", "ğŸ°", "ğŸ”±", "ğŸ§¿", "ğŸ­", "ğŸ¨", "ğŸ§ª", "ğŸ”­", "ğŸ¸", "ğŸ¹", "ğŸ•¯ï¸", "â›“ï¸", "ğŸ§¬"] },
        { grade: "ì—í”½ (Epic)", icon: "ğŸ”®", prob: 0.05, items: ["ğŸ‘‘", "â˜„ï¸", "ğŸ§¨", "ğŸ”®", "â›©ï¸", "ğŸ¡", "ğŸš", "ğŸŒ‹", "ğŸ…", "ğŸ¦…", "ğŸ¹", "ğŸ°", "ğŸ›¥ï¸", "ğŸ§¿"] },
        { grade: "ìœ ë‹ˆí¬ (Unique)", icon: "ğŸ¦„", prob: 0.03, items: ["ğŸª", "ğŸ®", "ğŸ²", "ğŸ¦¾", "ğŸ›°ï¸", "ğŸ¦„", "ğŸ§", "ğŸ¦", "ğŸ‹", "ğŸ¦œ", "ğŸ•¸ï¸", "ğŸƒ", "ğŸ…", "ğŸ§œ"] },
        { grade: "ë ˆì „ë”ë¦¬ (Legendary)", icon: "ğŸ°", prob: 0.02, items: ["ğŸ”¥", "ğŸ’«", "ğŸŒŒ", "âš¡", "ğŸ›¸", "ğŸŒˆ", "â˜€ï¸", "â„ï¸", "ğŸŒ‘", "ğŸ”±", "ğŸ’®", "ğŸ’ ", "ğŸ–ï¸" ] }
    ],
    PAYBACK: 2000 // ì¤‘ë³µ ì•„ì´ì½˜ ë‹¹ì²¨ ì‹œ í™˜ê¸‰ê¸ˆ
};

//==========ì„¹í„°6==========

/**
 * [ì‹œìŠ¤í…œ ëª¨ë“ˆ] ëª…ë ¹ì–´ ìë™ ë“±ë¡ ë° ë„ì›€ë§ ê´€ë¦¬
 * ê¸°ëŠ¥: CMD_LISTì˜ ë°ì´í„°ë¥¼ USER_COMMANDS/ADMIN_COMMANDS ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— ë§¤í•‘í•˜ê³  ë„ì›€ë§ ìƒì„±
 */

/* [1] ë„ì›€ë§ ìƒì„± í•¨ìˆ˜ (ë™ì  ë Œë”ë§) */
function generateHelpMenu(category) {
    var list = [];
    for (var cmd in USER_COMMANDS) {
        var item = USER_COMMANDS[cmd];
        if (item.cat === category) {
            list.push("â€¢ " + cmd + ": " + item.desc);
        }
    }
    return list.length > 0 ? list.join("\n") : "í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì— ì¤€ë¹„ëœ ëª…ë ¹ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.";
}

function generateAdminHelp() {
    var list = [];
    var idx = 1;
    for (var cmd in ADMIN_COMMANDS) {
        list.push(idx + ". " + cmd + " (" + ADMIN_COMMANDS[cmd].desc + ")");
        idx++;
    }
    return "âš™ï¸ [ê´€ë¦¬ì ì „ìš© ëª…ë ¹ì–´]\n" + list.join("\n");
}

/* [2] ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸ ë°ì´í„° (ìˆ˜ì •ë¨: ê²°íˆ¬ ì‘ë‹µ ë° ê²½ë§ˆ ëª…ë ¹ì–´ í†µí•© ì¶”ê°€) */
var CMD_LIST = {
    user: [
        { cmd: "/ì¶œì„", desc: "ë§¤ì¼ í¬ì¸íŠ¸ íšë“", cat: "ì¡°íšŒ", func: "_gameShopLogic" },
        { cmd: "/ë‚´ì •ë³´", desc: "ë‚´ ìŠ¤íƒ¯ í™•ì¸", cat: "ì¡°íšŒ", func: "_gameInfoLogic" },
        { cmd: "/ê°€ì´ë“œ", desc: "ì‹¬í™” ì‹œìŠ¤í…œ ê°€ì´ë“œ í™•ì¸", cat: "ì¡°íšŒ", func: "response" },
        { cmd: "/ì‹ ìš©ë“±ê¸‰", desc: "ì‹ ìš© ì ìˆ˜ì™€ ë“±ê¸‰ í™•ì¸", cat: "ì¡°íšŒ", func: "_gameInfoLogic" },
        { cmd: "/ì¶œì„ìˆœìœ„", desc: "í¬ì¸íŠ¸ ë­í‚¹ í™•ì¸", cat: "ì¡°íšŒ", func: "_gameInfoLogic" },
        { cmd: "/ìœ ì €ì •ë³´", desc: "[ë‹‰ë„¤ì„] ìƒì„¸ì •ë³´ ë³´ê¸°", cat: "ì¡°íšŒ", func: "_gameInfoLogic" },
        { cmd: "/ëª…ì˜ˆì˜ì „ë‹¹", desc: "ì±Œë¦°ì € ëª…ë‹¨ í™•ì¸", cat: "ì¡°íšŒ", func: "_gameInfoLogic" },
        { cmd: "/ë²„ê·¸ì œë³´", desc: "[ë‚´ìš©] ì˜¤ë¥˜ ë° ë²„ê·¸ ì‹ ê³ ", cat: "ì¡°íšŒ", func: "response" }, 
        { cmd: "/ê²½ë§ˆ", desc: "í˜„ì¬ ì¶œì „ë§ˆ ì •ë³´ ë° ë°°ë‹¹ í™•ì¸", cat: "ì¡°íšŒ", func: "_gameInfoLogic" }, // [ì‹ ê·œ ê²½ë§ˆ ì¡°íšŒ]
        { cmd: "/í™€ì§", desc: "[í™€|ì§] [í¬ì¸íŠ¸] ë„ë°•", cat: "ê²Œì„", func: "_gameActionLogic" },
        { cmd: "/ìŠ¹ê¸‰", desc: "í‹°ì–´ ìŠ¹ê¸‰ ë„ì „", cat: "ê²Œì„", func: "_gameActionLogic" },
        { cmd: "/ë°°íŒ…", desc: "[ë§ë²ˆí˜¸] [í¬ì¸íŠ¸] ê²½ë§ˆ ì°¸ì—¬", cat: "ê²Œì„", func: "_gameActionLogic" }, // [ì‹ ê·œ ê²½ë§ˆ ë°°íŒ…]
        { cmd: "ë°°íŒ…ì·¨ì†Œ", desc: "í˜„ì¬ íšŒì°¨ ë°°íŒ… ì² íšŒ (ìˆ˜ìˆ˜ë£Œ 10%)", cat: "ê²Œì„", func: "_gameActionLogic" }, // [ì‹ ê·œ ê²½ë§ˆ ì·¨ì†Œ]
        { cmd: "/ê²°íˆ¬", desc: "[ë‹‰ë„¤ì„] [í¬ì¸íŠ¸] ì‹ ì²­", cat: "ê²Œì„", func: "_gameActionLogic" },
        { cmd: "ìˆ˜ë½", desc: "ê²°íˆ¬ ì‹ ì²­ ìŠ¹ë‚™", cat: "ê²Œì„", func: "_gameActionLogic" },
        { cmd: "ê±°ì ˆ", desc: "ê²°íˆ¬ ì‹ ì²­ ê±°ì ˆ", cat: "ê²Œì„", func: "_gameActionLogic" },
        { cmd: "ì·¨ì†Œ", desc: "ê²°íˆ¬ ì‹ ì²­ ì² íšŒ", cat: "ê²Œì„", func: "_gameActionLogic" },
        { cmd: "/ë„ë‘‘ì§ˆ", desc: "[ë‹‰ë„¤ì„] í¬ì¸íŠ¸ íƒˆì·¨ ì‹œë„", cat: "ê²Œì„", func: "_gameActionLogic" },
        { cmd: "ì¡ì•˜ë‹¤ìš”ë†ˆ", desc: "ë„ë‘‘ì§ˆ ë°©ì–´ (1ë¶„ ì´ë‚´)", cat: "ê²Œì„", func: "_gameActionLogic" },
        { cmd: "ì¤ê¸°", desc: "ë°”ë‹¥ì— ë–¨ì–´ì§„ í¬ì¸íŠ¸ íšë“", cat: "ê²Œì„", func: "_gameActionLogic" },
        { cmd: "/ìƒì ", desc: "ì•„ì´ì½˜ ë° ë°©ì–´ê¶Œ êµ¬ë§¤", cat: "ìƒì ", func: "_gameShopLogic" },
        { cmd: "/êµ¬ë§¤", desc: "[ë²ˆí˜¸] ìƒì  ë¬¼í’ˆ êµ¬ë§¤", cat: "ìƒì ", func: "_gameShopLogic" },
        { cmd: "/ê°€ë°©", desc: "ë³´ìœ  ì¤‘ì¸ ì•„ì´ì½˜/ì¹­í˜¸ í™•ì¸", cat: "ìƒì ", func: "_handleInventoryLogic" },
        { cmd: "/ì¥ì°©", desc: "[ë²ˆí˜¸] ë³´ìœ  ì•„ì´í…œ ì¥ì°©", cat: "ìƒì ", func: "_handleInventoryLogic" },
        { cmd: "/ë¶„í•´", desc: "[ë²ˆí˜¸] ì•„ì´ì½˜ ë¶„í•´ ë° í¬ì¸íŠ¸ íšŒìˆ˜", cat: "ìƒì ", func: "_handleInventoryLogic" },
        { cmd: "/ë¡œë˜ì •ë³´", desc: "ë‚´ ë¡œë˜ ë²ˆêµ¬ ë° ê²°ê³¼ í™•ì¸", cat: "ìƒì ", func: "_handleLottoLogic" },
        { cmd: "/ì•„ì´ì½˜ì´ˆê¸°í™”", desc: "ì„¤ì •í•œ ì•„ì´ì½˜ ì‚­ì œ", cat: "ìƒì ", func: "_handleLottoLogic" },
        { cmd: "/ì€í–‰", desc: "ì˜ˆê¸ˆ/ì¶œê¸ˆ/ì†¡ê¸ˆ/ëŒ€ì¶œ/ì‚¬ì±„ ì¢…í•© ê´€ë¦¬", cat: "ê²½ì œ", func: "_gameBankLogic" },
        { cmd: "/ëŒ€ì¶œí•œë„", desc: "ì‹ ìš© ë“±ê¸‰ë³„ í•œë„ í™•ì¸", cat: "ê²½ì œ", func: "_gameInfoLogic" },
        { cmd: "/ìƒí™˜", desc: "[ê¸ˆì•¡] ëŒ€ì¶œê¸ˆ ì§ì ‘ ìƒí™˜", cat: "ê²½ì œ", func: "_gameBankLogic" },
        { cmd: "/ì£¼ì‹", desc: "ì‹¤ì‹œê°„ ì£¼ê°€ í™•ì¸", cat: "ì£¼ì‹", func: "_gameStockLogic" },
        { cmd: "/ë‚´ì£¼ì‹", desc: "ë³´ìœ  ì£¼ì‹ ë° ìˆ˜ìµë¥  í™•ì¸", cat: "ì£¼ì‹", func: "_gameStockLogic" },
        { cmd: "/ë§¤ìˆ˜", desc: "[ì¢…ëª©ëª…] [ìˆ˜ëŸ‰] ì£¼ì‹ êµ¬ë§¤", cat: "ì£¼ì‹", func: "_gameStockLogic" },
        { cmd: "/ë§¤ë„", desc: "[ì¢…ëª©ëª…] [ìˆ˜ëŸ‰] ì£¼ì‹ íŒë§¤", cat: "ì£¼ì‹", func: "_gameStockLogic" },
        { cmd: "/ê´‘ì‚°ì‹œì‘", desc: "ë°©ì¹˜í˜• í¬ì¸íŠ¸ ì±„êµ´ ì‹œì‘", cat: "ê´‘ì‚°", func: "_handleMiningLogic" },
        { cmd: "/ê´‘ì‚°ì •ë³´", desc: "í˜„ì¬ ì±„êµ´ í˜„í™© ë° ì˜ˆìƒ ìˆ˜ìµ í™•ì¸", cat: "ê´‘ì‚°", func: "_handleMiningLogic" },
        { cmd: "/ê´‘ì‚°ì¢…ë£Œ", desc: "ì±„êµ´ ì™„ë£Œ ë° í¬ì¸íŠ¸ ì •ì‚°", cat: "ê´‘ì‚°", func: "_handleMiningLogic" },
        { cmd: "/ìœ ë¬¼ë„ê°", desc: "ìœ ë¬¼ ì¡°ê° ìˆ˜ì§‘ í˜„í™© í™•ì¸", cat: "ê´‘ì‚°", func: "_gameInfoLogic" }
    ],
    admin: [
        { cmd: "/ë´‡êµ¬ë™", desc: "[ì˜¨|ì˜¤í”„] ì‹œìŠ¤í…œ ì œì–´", func: "_adminSystemLogic" },
        { cmd: "/ì‹œì¥ìì‚°ë³µêµ¬", desc: "ìœ ì € í‰ë‹¨ê°€ ê¸°ë°˜ ì£¼ê°€ ê¸´ê¸‰ ë³µêµ¬", func: "_adminEconomyLogic" },
        { cmd: "/ì¢…ëª©ì¶”ê°€", desc: "[ì´ë¦„] [ê°€ê²©] ì‹ ê·œ ìƒì¥", func: "_adminEconomyLogic" },
        { cmd: "/ì¢…ëª©ìˆ˜ì •", desc: "[ê¸°ì¡´] [ìƒˆì´ë¦„] [ê°€ê²©] ìˆ˜ì •", func: "_adminEconomyLogic" },
        { cmd: "/ê²½ì œì •ë³´", desc: "ì€í–‰ ì¬ì› ë° ê²½ì œ ì§€í‘œ í™•ì¸", func: "_adminEconomyLogic" },
        { cmd: "/ì¬ì›ìˆ˜ì •", desc: "[ê¸ˆì•¡] ì€í–‰ ê¸ˆê³  ìë³¸ ì¡°ì •", func: "_adminEconomyLogic" },
        { cmd: "/ë°ì´í„°êµì •", desc: "ì€í–‰ ì¬ì› ë° ìœ ì € ë°ì´í„° ë™ê¸°í™”", func: "_adminEconomyLogic" },
        { cmd: "/ë¬¼ê°€ì¡°ì •", desc: "[ê¸°ì¤€ê°’] ì¸í”Œë ˆ ë°˜ì˜ ìƒì ê°€ ì¡°ì ˆ", func: "_adminEconomyLogic" },
        { cmd: "/ë¬¼ê°€ì™„ì¶©", desc: "[0.0~1.0] ë¬¼ê°€ ë³€ë™í­ ì¡°ì ˆ", func: "_adminEconomyLogic" },
        { cmd: "/ê°•ì œì¬ê°€ë™", desc: "ì‹œìŠ¤í…œ ë½ í•´ì œ ë° ë¦¬ì…‹", func: "_adminSystemLogic" },
        { cmd: "/ìœ ì €ì‚­ì œ", desc: "[ë‹‰ë„¤ì„] ë°ì´í„° ì˜êµ¬ ì‚­ì œ", func: "_adminUserManageLogic" },
        { cmd: "/ìœ ì €ë°ì´í„°", desc: "ìƒì„¸ JSON ë°ì´í„° í™•ì¸", func: "_adminUserManageLogic" },
        { cmd: "/ë°ì´í„°ì´ì „", desc: "[êµ¬ë‹‰] > [ì‹ ë‹‰] ìì‚° ì´ì „", func: "_adminUserManageLogic" },
        { cmd: "/ë‹‰ë„¤ì„ê¸°ë¡", desc: "[ë‹‰ë„¤ì„] ë³€ê²½ ì´ë ¥ ì¡°íšŒ", func: "_adminUserManageLogic" },
        { cmd: "/ì¶œì„ì´ˆê¸°í™”", desc: "[ë‹‰ë„¤ì„] ì˜¤ëŠ˜ ê¸°ë¡ ì‚­ì œ", func: "_adminUserManageLogic" },
        { cmd: "/í¬ì¸íŠ¸ì§€ê¸‰", desc: "[ë‹‰ë„¤ì„] [ìˆ˜ëŸ‰] ì§ì ‘ ì§€ê¸‰", func: "_adminEconomyLogic" },
        { cmd: "/ì „ì²´í¬ì¸íŠ¸ì§€ê¸‰", desc: "[ìˆ˜ëŸ‰] ì „ì› ì§€ê¸‰", func: "_adminEconomyLogic" },
        { cmd: "/í¬ì¸íŠ¸ì°¨ê°", desc: "[ë‹‰ë„¤ì„] [ìˆ˜ëŸ‰] ì°¨ê°", func: "_adminEconomyLogic" },
        { cmd: "/ë„ë°•ì œí•œ", desc: "[ì˜¨|ì˜¤í”„] ì‹œìŠ¤í…œ ì œì–´", func: "_adminSystemLogic" },
        { cmd: "/ë¿Œë¦¬ê¸°", desc: "ëœë¤ í¬ì¸íŠ¸ ì„ ì°©ìˆœ ì´ë²¤íŠ¸", func: "_adminEconomyLogic" },
        { cmd: "/ê´€ë¦¬ìë“±ë¡", desc: "[ë‹‰ë„¤ì„] ë¶€ê´€ë¦¬ì ì¶”ê°€", func: "_adminSystemLogic" },
        { cmd: "/ê´€ë¦¬ìí•´ì œ", desc: "[ë‹‰ë„¤ì„] ê´€ë¦¬ì ê¶Œí•œ ë°•íƒˆ", func: "_adminSystemLogic" },
        { cmd: "/ê´€ë¦¬ìëª©ë¡", desc: "ê¶Œí•œ ë³´ìœ ì ëª…ë‹¨ ì¡°íšŒ", func: "_adminSystemLogic" },
        { cmd: "/ê´€ë¦¬ìë¡œê·¸", desc: "ìµœê·¼ ê´€ë¦¬ í™œë™ ë‚´ì—­", func: "_adminLogLogic" },
        { cmd: "/ì œë³´ëª©ë¡", desc: "ë²„ê·¸ ì œë³´ í™•ì¸", func: "_adminLogLogic" },
        { cmd: "/ì œë³´ì´ˆê¸°í™”", desc: "ì œë³´ ë‚´ì—­ ì „ì²´ ì‚­ì œ", func: "_adminLogLogic" },
        { cmd: "/ì˜¤ë¥˜ë¡œê·¸", desc: "ì‹œìŠ¤í…œ ì—ëŸ¬ ë¡œê·¸ í™•ì¸", func: "_adminLogLogic" },
        { cmd: "/ì˜¤ë¥˜ì´ˆê¸°í™”", desc: "ì‹œìŠ¤í…œ ì—ëŸ¬ ë¡œê·¸ ì‚­ì œ", func: "_adminLogLogic" },
        { cmd: "/ìŠ¹ê¸‰íšŸìˆ˜ì´ˆê¸°í™”", desc: "ì „ì²´ ìŠ¹ê¸‰ ê¸°íšŒ ë¦¬ì…‹", func: "_adminEconomyLogic" },
        { cmd: "/ì‹œì¦Œê°•ì œì¢…ë£Œ", desc: "ëª¨ë“  í‹°ì–´ ì´ˆê¸°í™”", func: "_adminEconomyLogic" },
        { cmd: "/ì¶œì„ì¼ìˆ˜ìˆ˜ì •", desc: "[ë‹‰ë„¤ì„] [ìˆ˜ì¹˜] ìˆ˜ì •", func: "_adminUserManageLogic" },
        { cmd: "/ì „ì²´ì¶œì„ìˆ˜ì •", desc: "ëª¨ë“  ìœ ì € ì¶œì„ì¼ ê³ ì •", func: "_adminUserManageLogic" },
        { cmd: "/ë¡œë˜ë°ì´í„°ì´ˆê¸°í™”", desc: "ë¡œë˜ ì‹œìŠ¤í…œ ë¦¬ì…‹", func: "_adminEconomyLogic" },
        { cmd: "/ì „ì²´ë³µì›", desc: "ë°ì´í„° ë¡¤ë°± (ì•ˆì „ ì§€ì )", func: "_adminEconomyLogic" },
        { cmd: "/ìœ ì €ë³µì›", desc: "[ë‹‰ë„¤ì„] ë¶€ë¶„ ë³µêµ¬", func: "_adminUserManageLogic" },
        { cmd: "/ì‹œìŠ¤í…œìê°€ë³µì›", desc: "ë©”ëª¨ë¦¬ ìµœì í™” ë° ë³€ìˆ˜ ì´ˆê¸°í™”", func: "_adminEconomyLogic" },
        { cmd: "/ì¬ì›ì¶©ì „", desc: "[ê¸ˆì•¡] ì€í–‰ ê¸ˆê³  ìë³¸ ê¸´ê¸‰ ìˆ˜í˜ˆ", func: "_adminEconomyLogic" },
        { cmd: "/ì‹ ìš©ì¡°ì •", desc: "[ë‹‰ë„¤ì„] [ì ìˆ˜] ì‹ ìš©ì ìˆ˜ ì§ì ‘ ê°€ê°", func: "_adminUserManageLogic" }
    ]
};

//==========ì„¹í„°7==========

/* ì „ì—­ ìƒíƒœ ë³€ìˆ˜ë“¤ (ì„¹í„°1ê³¼ ì¤‘ë³µ ë°©ì§€ ì²˜ë¦¬) */ 
var sprayData = { 
    totalPoint: 0, 
    remainingPoint: 0, 
    maxWinners: 0, 
    currentWinners: 0, 
    winnersList: [], 
    isActive: false, 
    timer: null 
};

/* ì„¹í„°1ì— ì—†ëŠ” ë³€ìˆ˜ë§Œ ì‹ ê·œ ì„ ì–¸ */ 
var selectWaitState = {}; 
var bankProcessState = {};

/**
 * [Gemini ìš”ì²­ ì‚¬í•­] í†µí•© ìˆœìì‚° ê³„ì‚° ì—”ì§„
 */
function util_calculateNetWorth(user, roomData) {
    if (!user) return 0;
    var data = getDatabase(); 
    var liquidAssets = Number(user.point || 0) + Number(user.bank || 0);
    var stockAssets = 0;
    if (user.stockHoldings && data.stockMarket) {
        for (var sName in user.stockHoldings) {
            var count = Number(user.stockHoldings[sName] || 0);
            var stock = data.stockMarket[sName];
            var currentPrice = stock ? Number(stock.price) : 0;
            if (!isNaN(count) && !isNaN(currentPrice)) stockAssets += (count * currentPrice);
        }
    }
    var bankDebt = (user.loan && user.loan.debt) ? Number(user.loan.debt) : 0;
    var sacheDebt = 0;
    var sacheClaims = 0; 
    if (roomData && roomData.loanContracts) {
        for (var cid in roomData.loanContracts) {
            var c = roomData.loanContracts[cid];
            if (c.borrowerUid === user.uid || (user.name && c.borrowerName === user.name)) {
                sacheDebt += Number(c.currentDebt);
            }
            if (c.lenderUid === user.uid || (user.name && c.lenderName === user.name)) {
                sacheClaims += Number(c.currentDebt);
            }
        }
    }
    var netWorth = (liquidAssets + stockAssets + sacheClaims) - (bankDebt + sacheDebt);
    return Math.max(0, Math.floor(netWorth));
}

/**
 * [í•µì‹¬: í¬ì¸íŠ¸ ì „ì—­ ì•ˆì „ ì¥ì¹˜]
 * ê¸°ëŠ¥: ëª¨ë“  í¬ì¸íŠ¸ ì°¨ê° ì‹œ ë³´ìœ ì•¡ë³´ë‹¤ í´ ê²½ìš° ìë™ìœ¼ë¡œ ë³´ìœ ì•¡ë§Œí¼ë§Œ ì°¨ê°(0ì› ê³ ì •)
 */
function util_updatePoint(user, roomData, delta, reason, roomName) {
    if (!user || isNaN(delta) || delta === 0) return;
    
    var prePoint = Number(user.point || 0);

    /* [ì „ êµ¬ê°„ ë§ˆì´ë„ˆìŠ¤ ë°©ì§€ ì¥ì¹˜] */
    var actualDelta = delta;
    if (delta < 0 && (prePoint + delta) < 0) {
        actualDelta = -prePoint; // ê°€ì§„ ëˆì´ ë¶€ì¡±í•˜ë©´ ê°€ì§„ ë§Œí¼ë§Œ ëºŒ (ê²°ê³¼ëŠ” í•­ìƒ 0)
    }

    var bankOutputReasons = ["ì¶œì„ ë³´ìƒ", "ë¯¼ìƒì§€ì›ê¸ˆ ì§€ê¸‰", "í™€ì§ ì ì¤‘", "ì£¼ì‹ ë§¤ë„", "ê´‘ì‚° ì±„êµ´", "ë¡œë˜ 1ë“± ë‹¹ì²¨", "ë¡œë˜ 2ë“± ë‹¹ì²¨", "ë¡œë˜ 3ë“± ë‹¹ì²¨", "ì•„ì´í…œ ë¶„í•´ íšŒìˆ˜", "ëœë¤ë°•ìŠ¤ ì¤‘ë³µ í™˜ê¸‰", "ê²°íˆ¬ ìŠ¹ë¦¬ ë³´ìƒ", "ë¿Œë¦¬ê¸° ì¤ê¸°", "ê²½ë§ˆ ë‹¹ì²¨ê¸ˆ"];
    var bankInputReasons = ["ì£¼ì‹ ë§¤ìˆ˜", "í™€ì§ ë¯¸ì ì¤‘", "ë„ë‘‘ì§ˆ ì²´í¬ ë²Œê¸ˆ", "ëŒ€ì¶œ ìƒí™˜", "ìƒì  êµ¬ë§¤: ", "ê²½ì°° ì²´í¬ ë²Œê¸ˆ", "ê²½ì°° ë²Œê¸ˆ", "ë„ë‘‘ì§ˆ ì„±ê³µ", "ì€í–‰ ê¸°ë¶€", "ê²½ë§ˆ ë°°íŒ…", "ë°°íŒ… ì·¨ì†Œ ìˆ˜ìˆ˜ë£Œ", "ì†¡ê¸ˆ ë³´ëƒ„", "ì€í–‰ ì˜ˆê¸ˆ", "ì‚¬ì±„"];

    var brDelta = 0; 

    if (roomData) {
        if (roomData.bankReserve === undefined) roomData.bankReserve = SYSTEM_CONFIG.ECO.BANK.INITIAL_RESERVE;
        
        // ì‹¤ì œë¡œ ìœ ì €ì—ê²Œì„œ ë¹ ì ¸ë‚˜ê°„ 'actualDelta'ë§Œí¼ë§Œ êµ­ê³ (bankReserve)ì— ë°˜ì˜
        if (actualDelta > 0) {
            if (bankOutputReasons.some(function(r){ return reason.indexOf(r) !== -1; })) brDelta = -actualDelta;
        } else {
            if (bankInputReasons.some(function(r){ return reason.indexOf(r) !== -1; }) || reason.indexOf("ë²Œê¸ˆ") !== -1 || reason.indexOf("ìƒí™˜") !== -1) {
                brDelta = Math.abs(actualDelta);
            }
        }
        roomData.bankReserve += brDelta;
    }

    user.point = prePoint + actualDelta; // ë°ì´í„° ê°±ì‹  (ìŒìˆ˜ ì €ì¥ ì›ì²œ ë´‰ì‡„)

    /* ìì‚°ê°€ ì¹­í˜¸ ì—”ì§„ */
    var totalNetWorth = util_calculateNetWorth(user, roomData);
    var assetTitles = [
        { name: "ëŒ€ë¶€í˜¸", limit: 1000000, id: 703 },
        { name: "ë¶€í˜¸", limit: 500000, id: 702 },
        { name: "ê±°ìƒ", limit: 300000, id: 701 },
        { name: "ì¬ë²Œ", limit: 100000, id: 700 }
    ];

    if (!user.inventory) user.inventory = [];

    for (var i = 0; i < assetTitles.length; i++) {
        var t = assetTitles[i];
        if (totalNetWorth >= t.limit) {
            var isAlreadyOwned = user.inventory.some(function(it) { 
                return it.effect === "title" && it.title === t.name; 
            });

            if (!isAlreadyOwned) {
                user.inventory.push({ 
                    id: t.id, name: "[" + t.name + "] ì¹­í˜¸", icon: "ğŸ’°", effect: "title", title: t.name 
                });
                user.title = t.name;
                var targetRoom = roomName || (roomData && roomData.roomName ? roomData.roomName : "ë‚´ë¦¬ë‹¤");
                var winMsg = "[ğŸ–ï¸ ì‹ ê·œ ì¹­í˜¸ íšë“]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + (user.name || "ìœ ì €") + "ë‹˜\n\nì¶•í•˜í•©ë‹ˆë‹¤! ì‹¤ì§ˆ ìˆœìì‚°ì´ " + fp(t.limit) + "Pë¥¼ ëŒíŒŒí•˜ì—¬ [" + t.name + "] ì¹­í˜¸ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!\n\nâœ¨ ìƒíƒœ: [" + t.name + "] ì¹­í˜¸ ìë™ ì¥ì°© ì™„ë£Œ\nğŸ’¼ ë³´ê´€: ê°€ë°©ì— ì˜êµ¬ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’¡ ì´ì œ ìì‚°ì´ í•˜ë½í•´ë„ ì¹­í˜¸ëŠ” ì‚¬ë¼ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.";
                try { Api.replyRoom(targetRoom, winMsg); } catch(e){}
                break;
            }
        }
    }

    if (typeof verifyPointTransaction === 'function') {
        // ì €ë„ë§ì—ë„ 'ì‹¤ì œ ë³€ë™ì•¡'ì„ ê¸°ë¡í•˜ì—¬ ë³µêµ¬ ì‹œ ì˜¤ì°¨ ë°œìƒ ì°¨ë‹¨
        verifyPointTransaction(user, prePoint, actualDelta, reason, roomName, brDelta);
    }
}

/* í¬ì¸íŠ¸ ë‹¨ìœ„ ì‰¼í‘œ í¬ë§·íŒ… */
function fp(val) {
    if (val === undefined || val === null || isNaN(val)) return "0";
    return String(Math.floor(Number(val))).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}
var fP = fp;

function formatCommand(title, user, content, nextStep) { 
    var msg = title + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"; 
    if (user !== null) { 
        var nameTag = (typeof user === "string") ? user : getDisplayName(user); 
        msg += nameTag + "ë‹˜\n"; 
    } 
    msg += content + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"; 
    if (nextStep) msg += "\nğŸ’¡ [ê°€ì´ë“œ]: " + nextStep; 
    return msg; 
}

function formatSimple(title, content, nextStep) {
    var msg = "â„¹ï¸ " + title + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + content + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”";
    if (nextStep) msg += "\nğŸ’¡ [ê°€ì´ë“œ]: " + nextStep;
    return msg;
}

function formatAdmin(title, content) { 
    return "âš™ï¸ " + title + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + content + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"; 
}

function formatError(user, content, nextStep) { 
    var nameTag = (typeof user === "string") ? user : getDisplayName(user); 
    var msg = "ğŸš« ì˜¤ë¥˜ ë°œìƒ\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + nameTag + "ë‹˜\nì‚¬ìœ : " + content + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"; 
    if (nextStep) msg += "\nğŸ’¡ [ê°€ì´ë“œ]: " + nextStep; 
    return msg; 
}

/**
 * [ì‹ ê·œ] ì£¼ì‹ ê°€ê²© ë³€ë™ ì—”ì§„
 */
function stock_calculateNextPrice(currentPrice) {
    if (!marketOpenPrice || marketOpenPrice <= 0) return currentPrice;
    var cfg = SYSTEM_CONFIG.ECO.STOCK.SETTINGS;
    var growthRate = (currentPrice - marketOpenPrice) / marketOpenPrice;
    var change = (Math.random() * 2.4 - 1.2) / 100;
    if (growthRate > cfg.RESISTANCE_START) {
        var now = new Date();
        var elapsed = (now.getHours() - cfg.OPEN_HOUR) * 60 + now.getMinutes();
        var total = (cfg.CLOSE_HOUR - cfg.OPEN_HOUR) * 60;
        var timeWeight = Math.min(Math.max(elapsed / total, 0), 1.0); 
        var resistance = (growthRate - cfg.RESISTANCE_START) * cfg.GRAVITY * (1 + timeWeight);
        change -= resistance;
        if (growthRate >= (cfg.CLOSING_LIMIT - 0.01) && change > 0) {
            if (Math.random() < 0.8) change = -Math.abs(change) * 0.5;
        }
    }
    return Math.max(10, currentPrice + (currentPrice * change));
}

/**
 * [ì‹ ê·œ] ì¥ ë§ˆê° ë³´ì • ë¡œì§
 */
function stock_applyClosingCorrection(currentPrice) {
    if (!marketOpenPrice || marketOpenPrice <= 0) return currentPrice;
    var cfg = SYSTEM_CONFIG.ECO.STOCK.SETTINGS;
    var growthRate = (currentPrice - marketOpenPrice) / marketOpenPrice;
    if (growthRate >= cfg.CLOSING_LIMIT) {
        var safeRate = (cfg.CLOSING_LIMIT - 0.01) + (Math.random() * 0.008);
        var correctedPrice = marketOpenPrice * safeRate;
        return Math.max(10, Math.round(correctedPrice));
    }
    return currentPrice;
}

//==========ì„¹í„°8==========

/**
 * [Gemini ìš”ì²­ ì‚¬í•­] ê²½ì œ ì§€í‘œ ê³„ì‚° í•¨ìˆ˜ (ì¤‘ì•™ì€í–‰ ì¬ì› í¬í•¨ ë° ì‹¤ì§ˆ ìˆœìì‚° ê¸°ì¤€)
 * ê¸°ëŠ¥: ì„¹í„° 7ì˜ util_calculateNetWorthë¥¼ í˜¸ì¶œí•˜ê³  ì¤‘ì•™ì€í–‰ ê¸ˆê³  ì”ì•¡ì„ í•©ì‚°í•˜ì—¬ êµ­ê°€ ì „ì²´ ìì‚°ì„ ì§‘ê³„í•©ë‹ˆë‹¤.
 * ë°˜ì˜: 
 * 1. ì‹œìŠ¤í…œ ë‚´ ì´ í†µí™”ëŸ‰ ìœ ì§€ë¥¼ ìœ„í•´ ìœ ì € ìì‚° ì™¸ì— 'ì¤‘ì•™ì€í–‰ ì¬ì›'ì„ ì§€í‘œì— í¬í•¨í•¨.
 * 2. ì±„ê¶Œ(ë¹Œë ¤ì¤€ ëˆ)ì„ í¬í•¨í•œ ì‹¤ì§ˆ ìˆœìì‚°ì„ ê¸°ì¤€ìœ¼ë¡œ í†µê³„ ëˆ„ë½ì„ ë°©ì§€í•¨.
 */
function calculateEconomy(data, roomName) {
    var totalAssets = 0;
    var userCount = 0;
    if (!data || !data.rooms) return { total: 0, count: 0, average: 0 };

    // íŠ¹ì • ë°©ë§Œ ìŠ¤ìº”í• ì§€, ì „ì²´ ë°©ì„ ìŠ¤ìº”í• ì§€ ê²°ì •
    var roomsToScan = roomName ? [roomName] : Object.keys(data.rooms);
    
    for (var i = 0; i < roomsToScan.length; i++) {
        var r = roomsToScan[i];
        var roomData = data.rooms[r];
        if (!roomData) continue;

        // 1. [í•µì‹¬ ì¶”ê°€] ì¤‘ì•™ì€í–‰ ê¸ˆê³  ìì‚° í•©ì‚°
        // ìœ ì €ê°€ ìƒì  ì´ìš© ë“±ìœ¼ë¡œ ì§€ì¶œí•œ í¬ì¸íŠ¸ê°€ ê¸ˆê³ ì— ìˆì„ ë•Œ, ì´ë¥¼ êµ­ê°€ ìì‚°ìœ¼ë¡œ í•©ì‚°í•˜ì—¬ ë¬¼ê°€ í­ë½ì„ ë°©ì§€í•©ë‹ˆë‹¤.
        if (roomData.bankReserve !== undefined) {
            totalAssets += Number(roomData.bankReserve);
        }

        // 2. ìœ ì €ë³„ ìˆœìì‚° í•©ì‚°
        for (var uid in roomData.users) {
            var u = roomData.users[uid];
            if (!u) continue;

            /* [í•µì‹¬] ì„¹í„° 7ì˜ í†µí•© ê³„ì‚° ì—”ì§„ í˜¸ì¶œ */
            // ê° ìœ ì €ì˜ (í˜„ê¸ˆ + ì˜ˆê¸ˆ + ì£¼ì‹í˜„ì¬ê°€ì¹˜ + ì±„ê¶Œ) - (ë¶€ì±„)ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
            // ì„¹í„° 7ì—ì„œ ì´ë¯¸ ë§ˆì´ë„ˆìŠ¤ ìì‚°ì€ 0Pë¡œ ë³´ì •ë˜ì–´ ë°˜í™˜ë©ë‹ˆë‹¤.
            var userNetWorth = 0;
            if (typeof util_calculateNetWorth === 'function') {
                userNetWorth = util_calculateNetWorth(u, roomData);
            } else {
                // ì˜ˆì™¸ ì²˜ë¦¬: í•¨ìˆ˜ê°€ ì—†ì„ ê²½ìš° ê¸°ë³¸ í¬ì¸íŠ¸ ê¸°ë°˜ (ì•ˆì „ì¥ì¹˜)
                userNetWorth = Number(u.point || 0) + Number(u.bank || 0);
            }

            totalAssets += userNetWorth;
            userCount++;
        }
    }

    return {
        total: totalAssets,
        count: userCount,
        average: userCount > 0 ? Math.floor(totalAssets / userCount) : 0
    };
}

//==========ì„¹í„°9==========

/**
 * [ì‹œìŠ¤í…œ] ì•„ì´í…œ ê°€ê²© ê³„ì‚° í•¨ìˆ˜
 * ê¸°ëŠ¥: êµ­ê°€ ê²½ì œ ì§€í‘œ(Ecobase) ë°°ìœ¨ì„ ì ìš©í•˜ì—¬ ì‹¤ì‹œê°„ ìƒì ê°€ë¥¼ ì‚°ì¶œí•©ë‹ˆë‹¤.
 */
function getItemPrice(item, user, roomName) {
    var data = getDatabase();
    var multiplier = 1.0;
    var roomData = data.rooms[roomName];

    if (roomData && roomData.economyBase && roomData.economyBase > 0) {
        // [ì—°ë™] ì„¹í„° 8ì˜ í†µí•© ê²½ì œ ì§€í‘œë¥¼ í˜¸ì¶œ (ì´ë¯¸ ì±„ê¶Œ/ë¶€ì±„ê°€ ë°˜ì˜ëœ ìˆ˜ì¹˜)
        var currentEco = calculateEconomy(data, roomName);
        var rawRatio = currentEco.total / roomData.economyBase;
        
        var damping = (data.economyDamping !== undefined) ? data.economyDamping : 0.5;
        multiplier = 1 + (rawRatio - 1) * damping;
        
        if (multiplier < 0.5) multiplier = 0.5; 
    }

    var basePrice = Math.floor(Number(item.price) * multiplier);

    // ìŠ¹ê¸‰ê¶Œ(id:8)ì€ êµ¬ë§¤ íšŸìˆ˜ì— ë”°ë¥¸ í• ì¦ ë¡œì§ ìœ ì§€
    if (item.id === 8) { 
        var boughtCount = Number(user.purchasedPromotionAttempts || 0);
        return basePrice + (boughtCount * 50);
    }
    return basePrice;
}

/**
 * [Gemini ìš”ì²­ ì‚¬í•­] ê²½ì œ ë¶€ì–‘ ì§€ì›ê¸ˆ ì²´í¬ í•¨ìˆ˜ (ì‹¤ì§ˆ ìˆœìì‚° ê¸°ì¤€ ì¼ì›í™”)
 * ê¸°ëŠ¥: ì„¹í„° 7ì˜ í†µí•© ì—”ì§„ì„ ì‚¬ìš©í•˜ì—¬ 'ë¶€ì ì—°ì²´ì'ë¥¼ ê±¸ëŸ¬ë‚´ê³  ê³µì •í•œ ë³µì§€ë¥¼ ì‹¤í˜„í•©ë‹ˆë‹¤.
 * ë°˜ì˜: ìœ ì €ì˜ ì±„ê¶Œ(ë¹Œë ¤ì¤€ ëˆ)ì´ ë§ìœ¼ë©´ ì§€ì› ëŒ€ìƒì—ì„œ ì œì™¸ë©ë‹ˆë‹¤.
 */
function checkEconomicStimulus(user, roomName, isManual) {
    if ((user.totalAttendance || 0) < 2) return;
    
    var currentCount = user.dailyStimulusCount || 0;
    if (currentCount >= 1) return;

    var data = getDatabase();
    if (!data) return;
    
    var eco = calculateEconomy(data, roomName);
    var avgAsset = eco.average;
    var roomData = data.rooms[roomName];

    /* [ìˆ˜ì •] ìˆ˜ë™ ìì‚°/ë¶€ì±„ ê³„ì‚° ë¡œì§ì„ ì„¹í„° 7 í†µí•© ì—”ì§„ í˜¸ì¶œë¡œ ëŒ€ì²´ */
    // ì´ í•œ ì¤„ë¡œ (ì§€ê°‘ + í†µì¥ + ì£¼ì‹ + ë¹Œë ¤ì¤€ëˆ) - (ì€í–‰ë¹š + ì‚¬ì±„ë¹š)ì´ ëª¨ë‘ ê³„ì‚°ë©ë‹ˆë‹¤.
    var myNetWorth = 0;
    if (typeof util_calculateNetWorth === 'function') {
        myNetWorth = util_calculateNetWorth(user, roomData);
    } else {
        myNetWorth = Number(user.point || 0) + Number(user.bank || 0);
    }

    // ì§€ê¸‰ ê¸°ì¤€ì„ : í‰ê·  ìˆœìì‚°ì˜ 40% ë¯¸ë§Œì¼ ë•Œ
    var targetLine = Math.floor(avgAsset * 0.4);
    
    if (myNetWorth < targetLine) {
        var multiplier = 1.0;
        if (roomData.economyBase && roomData.economyBase > 0) {
            var rawRatio = eco.total / roomData.economyBase;
            var damping = (data.economyDamping !== undefined) ? data.economyDamping : 0.5;
            multiplier = 1 + (rawRatio - 1) * damping;
            if (multiplier < 0.5) multiplier = 0.5;
        }

        var gap = targetLine - myNetWorth;
        var baseGive = Math.floor(2000 * multiplier);
        var giveAmount = Math.min(baseGive, gap); 
        
        if (giveAmount < 100) return;

        /* [ì—°ë™] ì¤‘ì•™ì€í–‰ ê¸ˆê³  ì°¨ê° ë° í¬ì¸íŠ¸ ì§€ê¸‰ */
        util_updatePoint(user, roomData, giveAmount, "ë¯¼ìƒì§€ì›ê¸ˆ ì§€ê¸‰", roomName);
        
        user.dailyStimulusCount = currentCount + 1;

        var msg = "\nê²½ì œ í™œì„±í™”ë¥¼ ìœ„í•œ ë¯¼ìƒì§€ì›ê¸ˆì´ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.\n" +
                  "ğŸ’° ì§€ì›ê¸ˆ ì§€ê¸‰: +" + fp(giveAmount) + "P";

        Api.replyRoom(roomName, formatCommand("ğŸ ë¯¼ìƒì§€ì›ê¸ˆ ì•ˆë‚´", user, msg, "ë‚´ ì”ì•¡: " + fP(user.point) + "P"));
        safeSaveData(data);
    }
}

//==========ì„¹í„°10==========

/* ì‹ ìš© ì •ë³´ ê³„ì‚° í•¨ìˆ˜ (ìƒìˆ˜ ì—°ë™) */
function getCreditInfo(score) {
    var s = Number(score || 600);
    var conf = SYSTEM_CONFIG.ECO.CREDIT;
    
    for(var i=0; i<conf.SCORES.length; i++) {
        if(s >= conf.SCORES[i]) {
            return { grade: i+1, limit: conf.LIMITS[i], label: conf.LABELS[i], rate: conf.RATES[i], icon: conf.ICONS[i] };
        }
    }
    // ë§ˆì§€ë§‰ ë“±ê¸‰ (ì‹ ìš©ë¶ˆëŸ‰)
    var lastIdx = conf.SCORES.length;
    return { grade: lastIdx+1, limit: conf.LIMITS[lastIdx], label: conf.LABELS[lastIdx], rate: conf.RATES[lastIdx], icon: conf.ICONS[lastIdx] };
}

/* ì‹ ìš© í•œë„ í‘œ ìƒì„± í•¨ìˆ˜ (ìˆ˜ì •: ì‹ ìš©ë¶ˆëŸ‰ì ëŒ€ì¶œ ê¸ˆì•¡ ë™ì  í‘œì‹œ) */
function getCreditLimitTable() {
    var conf = SYSTEM_CONFIG.ECO.CREDIT;
    var list = [];
    for(var i=0; i<conf.SCORES.length; i++) {
        var ratePct = Math.round((conf.RATES[i] - 1) * 100);
        list.push(conf.ICONS[i] + " " + conf.LABELS[i] + " (" + conf.SCORES[i] + "ì ~): " + fp(conf.LIMITS[conf[i]]) + "P (ì´ìœ¨ " + ratePct + "%)");
    }
    var lastIdx = conf.SCORES.length;
    var lastRate = Math.round((conf.RATES[lastIdx] - 1) * 100);
    list.push(conf.ICONS[lastIdx] + " " + conf.LABELS[lastIdx] + " (<" + conf.SCORES[lastIdx-1] + "): " + fp(conf.LIMITS[lastIdx]) + "P (ì´ìœ¨ " + lastRate + "%)");
    
    return list.join("\n");
}

/**
 * [ìˆ˜ì •] ë‹‰ë„¤ì„ í‘œì‹œ ìƒì„± í•¨ìˆ˜ (ì¹­í˜¸ ì „ìš© ì•„ì´ì½˜ ìë™ ë…¸ì¶œ ì‹œìŠ¤í…œ)
 * [Gemini ìš”ì²­ ì‚¬í•­ ë°˜ì˜]: ì¹­í˜¸ ì¥ì°© ì‹œ ì¸ë²¤í† ë¦¬ì—ì„œ í•´ë‹¹ ì¹­í˜¸ì˜ ì•„ì´ì½˜ì„ ì°¾ì•„ ìë™ìœ¼ë¡œ ì ‘ë‘ì‚¬ì— ë¶™ì…ë‹ˆë‹¤.
 */
function getDisplayName(user) {
    if (!user) return "ì•Œ ìˆ˜ ì—†ìŒ";
    var userIcon = user.icon || "";
    var tierIcon = (user.tier === 9 ? "ğŸ†" : ""); 
    var credit = getCreditInfo(user.creditScore || 600);
    
    var titleStr = "";
    
    // 1ìˆœìœ„: ì‹ ìš©ë¶ˆëŸ‰ìì¼ ê²½ìš° ë¬´ì¡°ê±´ [ì‹ ìš©ë¶ˆëŸ‰ì] í‘œì‹œ
    if (credit.label === "ì‹ ìš©ë¶ˆëŸ‰ì") {
        titleStr = "[ì‹ ìš©ë¶ˆëŸ‰ì] ";
    } 
    // 2ìˆœìœ„: ì¼ë°˜ ìƒíƒœì¼ ë•Œ ì¥ì°© ì¤‘ì¸ ì¹­í˜¸ í‘œì‹œ (ì•„ì´ì½˜ ìë™ íƒìƒ‰)
    else if (user.title && user.title.length > 0) {
        var titleIcon = "";
        
        // ì¸ë²¤í† ë¦¬ë¥¼ ìˆœíšŒí•˜ì—¬ í˜„ì¬ ì¥ì°©ëœ ì¹­í˜¸ëª…ê³¼ ì¼ì¹˜í•˜ëŠ” ì•„ì´í…œì˜ ì•„ì´ì½˜ì„ ê°€ì ¸ì˜´
        if (user.inventory && user.inventory.length > 0) {
            for (var i = 0; i < user.inventory.length; i++) {
                var item = user.inventory[i];
                if (item.effect === "title" && item.title === user.title) {
                    titleIcon = item.icon || ""; // ì•„ì´ì½˜ì´ ìˆì„ ê²½ìš°ì—ë§Œ í• ë‹¹
                    break;
                }
            }
        }
        
        // ì˜ˆì‹œ: [ğŸµï¸ìˆ˜ì§‘ëŒ€ë§ˆì™•] 
        titleStr = "[" + titleIcon + user.title + "] ";
    }
    
    return titleStr + tierIcon + userIcon + (user.name || "ì•Œ ìˆ˜ ì—†ìŒ");
}

/* [ìˆ˜ì •] ê´€ë¦¬ì ì—¬ë¶€ í™•ì¸ í•¨ìˆ˜ (FIXED_ADMINS ì²´í¬ ì¶”ê°€) */
function isAdmin(sender, data, uid) {
    if (FIXED_ADMINS.indexOf(String(sender).trim()) !== -1) return true;
    if (adminUIDs.indexOf(uid) !== -1) return true;
    var name = String(sender).trim();
    if (data && data.admins && data.admins.indexOf(name) !== -1) return true;

    return false;
}

//==========ì„¹í„°11==========

/* ìœ ì € ìƒíƒœ ì²´í¬ í•¨ìˆ˜ */
function isUserBusy(uid) {
    if (activeThefts[uid]) return true;
    for (var vKey in activeThefts) {
        if (activeThefts[vKey].thiefUid === uid) return true;
    }
    if (duelData[uid]) return true;
    for (var dKey in duelData) {
        if (duelData[dKey].challengerUid === uid) return true;
    }
    /* [ì¶”ê°€] ê´‘ì‚° ì±„êµ´ ì¤‘ì¸ ìœ ì €ë„ 'í™œë™ ì¤‘'ìœ¼ë¡œ ì²˜ë¦¬í•˜ì—¬ ì¤‘ë³µ í™œë™ ë°©ì§€ */
    if (miningState[uid]) return true;
    
    return false;
}

/* ìœ ì € ì´ë¦„ ê²€ìƒ‰ í•¨ìˆ˜ */
function findUserByName(roomData, name) {
    var res = [];
    var searchName = name.trim();
    if (searchName === "") return res; 
    for (var id in roomData.users) {
        var u = roomData.users[id];
        if (u.name === searchName) {
            return [{ id: id, data: u }];
        }
        if (u.name.indexOf(searchName) !== -1) {
            res.push({ id: id, data: u });
        }
    }
    return res;
}

/* ì¤‘ë³µ ìœ ì € ì„ íƒ í•¸ë“¤ëŸ¬ í•¨ìˆ˜ */
function handleUserSelection(replier, targetUid, found, type, extra, user) {
    selectWaitState[targetUid] = { 
        timestamp: Date.now(), 
        results: found, 
        type: type, 
        extra: extra 
    };
    var list = [];
    for(var i=0; i<found.length; i++) {
        list.push((i + 1) + ". " + found[i].data.name);
    }
    
    setTimeout(function() {
        if (selectWaitState[targetUid]) {
            delete selectWaitState[targetUid];
            replier.reply(formatError(user, "ì„ íƒ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤."));
        }
    }, 30000);

    replier.reply(formatCommand("ğŸ” ì¤‘ë³µ ë‹‰ë„¤ì„ ì„ íƒ", user, "ì—¬ëŸ¬ ìœ ì €ê°€ ê²€ìƒ‰ë˜ì—ˆìŠµë‹ˆë‹¤.\në²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.\n\n" + list.join("\n") + "\n\n(ì·¨ì†Œ: [ì·¨ì†Œ])", "ì…ë ¥ ëŒ€ê¸°: 30ì´ˆ"));
}

/* ë‚ ì§œ ë° ì‹œì¦Œ ìœ í‹¸ í•¨ìˆ˜ */
function getSimpleDate() { var d = new Date(); return d.getFullYear() + "-" + ("0" + (d.getMonth() + 1)).slice(-2) + "-" + ("0" + d.getDate()).slice(-2); }
function getSimpleSeason() { var d = new Date(); return d.getFullYear().toString().slice(-2) + "-" + (d.getMonth() + 1) + "ì‹œì¦Œ"; }
function generateUUID() { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) { var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); }); }

/**
 * [ì‹ ê·œ] ì„±ì·¨ ê¸°ë°˜ ì¹­í˜¸ ìë™ ë¶€ì—¬ ë° ì•Œë¦¼ í†µí•© í•¨ìˆ˜ (v5.5)
 * @param {Object} user - ìœ ì € ê°ì²´
 * @param {Object} replier - ì‘ë‹µ ê°ì²´
 * @param {String} titleName - ë¶€ì—¬í•  ì¹­í˜¸ ì´ë¦„
 * @param {Number} titleId - ì¹­í˜¸ ê³ ìœ  ID (ì¸ë²¤í† ë¦¬ ê´€ë¦¬ìš©)
 * @param {String} icon - ì¹­í˜¸ ì•„ì´ì½˜
 * @param {String} condDesc - ë‹¬ì„± ì¡°ê±´ ë¬¸êµ¬ (ì˜ˆ: "ë„ë°• íšŸìˆ˜ 100íšŒ")
 * @param {String} guideText - í•˜ë‹¨ ê°€ì´ë“œ ë©˜íŠ¸
 */
function util_checkAndAwardTitle(user, replier, titleName, titleId, icon, condDesc, guideText) {
    if (!user.inventory) user.inventory = [];
    
    // 1. ì¤‘ë³µ íšë“ ë°©ì§€ (ì´ë¯¸ ê°€ë°©ì— ë™ì¼í•œ ì¹­í˜¸ê°€ ìˆìœ¼ë©´ ì¢…ë£Œ)
    var hasTitle = false;
    for (var i = 0; i < user.inventory.length; i++) {
        if (user.inventory[i].title === titleName) {
            hasTitle = true;
            break;
        }
    }
    if (hasTitle) return false;

    // 2. ê°€ë°©(ì¸ë²¤í† ë¦¬)ì— ì¹­í˜¸ ì•„ì´í…œ ì¶”ê°€
    user.inventory.push({ 
        id: titleId, 
        name: "[" + titleName + "] ì¹­í˜¸", 
        icon: icon, 
        effect: "title", 
        title: titleName 
    });

    // 3. ì¹­í˜¸ ì¦‰ì‹œ ìë™ ì¥ì°©
    user.title = titleName;

    // 4. ìš”ì²­ëœ í¬ë§·ì˜ ì¹­í˜¸ íšë“ ì•Œë¦¼ ë°œì†¡ (ê°•ì¡° ê¸°í˜¸ ì œê±° ì™„ë£Œ)
    var msg = "[ğŸ–ï¸ ì‹ ê·œ ì¹­í˜¸ íšë“]\n" +
              "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
              (user.name || "ìœ ì €") + "ë‹˜\n\n" +
              condDesc + "ë¥¼ ë‹¬ì„±í•˜ì—¬ [" + titleName + "] ì¹­í˜¸ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!\n\n" +
              "âœ¨ ìƒíƒœ: [" + titleName + "] ì¹­í˜¸ ìë™ ì¥ì°© ì™„ë£Œ\n" +
              "ğŸ’¼ ë³´ê´€: ê°€ë°©ì— ì˜êµ¬ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n" +
              "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
              "ğŸ’¡ " + guideText;

    replier.reply(msg);
    return true;
}

//==========ì„¹í„°12==========

/* ê²½ì°° ì¶œë™ ê²°ê³¼ ì²˜ë¦¬ í•¨ìˆ˜ (ì¤‘ì•™ì€í–‰ ì—°ë™ ë° ë°©ë³„ ê²©ë¦¬ ë³´ì •) */
function processPoliceResult(roomName, thiefUid, victimUid) {
    var theftData = activeThefts[victimUid];
    if (!theftData) return;
    
    var data = getDatabase();
    if (!data) return;
    var room = data.rooms[roomName];
    if (!room) return;
    var thief = room.users[thiefUid];
    
    if (activeThefts[victimUid].successTimer) clearTimeout(activeThefts[victimUid].successTimer);
    delete activeThefts[victimUid]; 
    
    /* [ìˆ˜ì •] ë²Œê¸ˆ ë¬¼ê°€ ë°°ìœ¨ (ì™„ì¶© ì„¤ì • ì ìš©) */
    var multiplier = 1.0;
    if (room.economyBase && room.economyBase > 0) {
        var eco = calculateEconomy(data, roomName);
        var rawRatio = eco.total / room.economyBase;
        var damping = (data.economyDamping !== undefined) ? data.economyDamping : 0.5;
        multiplier = 1 + (rawRatio - 1) * damping;
        if (multiplier < 0.5) multiplier = 0.5;
    }

    var basePenalty = Math.floor(Math.random() * 81) + 20; 
    var penalty = Math.floor(basePenalty * multiplier);
    var actualPenalty = Math.min(penalty, Number(thief.point));
    
    // [Gemini ìš”ì²­ ì‚¬í•­] ì§ì ‘ ìˆ˜ì • ëŒ€ì‹  util_updatePoint í˜¸ì¶œí•˜ì—¬ í•´ë‹¹ ë°© ì¤‘ì•™ì€í–‰ ì¬ì›ê³¼ ë™ê¸°í™”
    // ë²Œê¸ˆì€ êµ­ê³ ë¡œ í™˜ìˆ˜ë˜ì–´ì•¼ í•˜ë¯€ë¡œ util_updatePoint ë‚´ë¶€ì˜ bankInputReasons ë¡œì§ì„ íƒœì›ë‹ˆë‹¤.
    util_updatePoint(thief, room, -actualPenalty, "ê²½ì°° ì²´í¬ ë²Œê¸ˆ", roomName);
    
    var jailTime = 1 * 60 * 60 * 1000;
    thief.jailReleaseTime = Date.now() + jailTime;
    
    /* [ìˆ˜ì •] ë¬¼ê°€/ì™„ì¶© ë©˜íŠ¸ ì‚­ì œ ì™„ë£Œ */
    var msg = "ğŸš¨ [ê²½ì°° ì¶œë™]\nëŒ€ìƒ: " + getDisplayName(thief) + "\në‚´ìš©: ë„ë‘‘ì§ˆ í˜„í–‰ë²” ì²´í¬\níŒ¨ë„í‹°: -" + fp(actualPenalty) + "P / ê°ì˜¥ 1ì‹œê°„\në‚´ ì”ì•¡: " + fp(thief.point) + "P";
    Api.replyRoom(roomName, formatAdmin("ğŸš“ ì²´í¬ ì™„ë£Œ", msg));
    safeSaveData(data);
}

/* ë„ë‘‘ì§ˆ ì„±ê³µ ê²°ê³¼ ì²˜ë¦¬ í•¨ìˆ˜ (ì¤‘ì•™ì€í–‰ ì—°ë™ ë° ë°©ë³„ ê²©ë¦¬ ë³´ì •) */
function processTheftResult(roomName, thiefUid, victimUid) {
    var data = getDatabase();
    if (!data) return;
    var room = data.rooms[roomName];
    if (!room) return;
    
    if (!room.users[thiefUid] || !room.users[victimUid]) { delete activeThefts[victimUid]; return; }
    
    if (activeThefts[victimUid] && activeThefts[victimUid].policeTimer) clearTimeout(activeThefts[victimUid].policeTimer);

    var thief = room.users[thiefUid];
    var victim = room.users[victimUid];
    
    var maxSteal = Math.floor(Number(victim.point) * 0.1);
    if (maxSteal < 1) maxSteal = 1;
    var stealAmount = Math.floor(Math.random() * maxSteal) + 1;
    if (Number(victim.point) < stealAmount) stealAmount = Number(victim.point); 
    
    // [Gemini ìš”ì²­ ì‚¬í•­] í”¼í•´ì ì°¨ê° ë° ë„ë‘‘ íšë“ ì‹œ util_updatePoint ì‚¬ìš©í•˜ì—¬ ë°©ë³„ ê²½ì œ ì§€í‘œ ìœ ì§€
    // í”¼í•´ìì˜ í¬ì¸íŠ¸ ì°¨ê° (ì´ ëˆì€ ë„ë‘‘ì—ê²Œ ê°€ë¯€ë¡œ ì€í–‰ ì¬ì› ë³€ë™ 0)
    util_updatePoint(victim, room, -stealAmount, "ë„ë‘‘ì§ˆ ë‹¹í•¨", roomName);

    var res = processRepayment(thief, stealAmount, thiefUid, roomName); 
    
    // ë„ë‘‘ì˜ í¬ì¸íŠ¸ ì¦ê°€ (ì´ ëˆì€ í”¼í•´ìì—ê²Œì„œ ì™”ìœ¼ë¯€ë¡œ ì€í–‰ ì¬ì› ë³€ë™ 0)
    util_updatePoint(thief, room, Number(res.actualGain), "ë„ë‘‘ì§ˆ ì„±ê³µ", roomName);
    
    /* [ì‹ ê·œ] ë„ë‘‘ì§ˆ ëˆ„ì  í†µê³„ ë° ì¹­í˜¸ ì²´í¬ */
    if (thief.totalTheftSuccess === undefined) thief.totalTheftSuccess = 0;
    thief.totalTheftSuccess++;

    // ì¹­í˜¸ ë¶€ì—¬ ë¡œì§ (ì„¹í„° 11ì˜ util_checkAndAwardTitle ì‚¬ìš©)
    var replierStub = { reply: function(m) { Api.replyRoom(roomName, m); } };
    if (thief.totalTheftSuccess >= 50) {
        util_checkAndAwardTitle(thief, replierStub, "ê´´ë„", 1203, "ğŸ‘¤", "ë„ë‘‘ì§ˆ ì„±ê³µ 50íšŒ", "í”ì ë„ ì—†ì´ ì‚¬ë¼ì§€ëŠ” ì „ì„¤ì˜ ë„ë‘‘ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.");
    } else if (thief.totalTheftSuccess >= 30) {
        util_checkAndAwardTitle(thief, replierStub, "ëŒ€ë„", 1202, "ğŸ‘º", "ë„ë‘‘ì§ˆ ì„±ê³µ 30íšŒ", "50íšŒ ì„±ê³µ ì‹œ ì „ì„¤ì˜ [ê´´ë„]ê°€ ë©ë‹ˆë‹¤.");
    } else if (thief.totalTheftSuccess >= 10) {
        util_checkAndAwardTitle(thief, replierStub, "ì¢€ë„ë‘‘", 1201, "ğŸ§¤", "ë„ë‘‘ì§ˆ ì„±ê³µ 10íšŒ", "30íšŒ ì„±ê³µ ì‹œ [ëŒ€ë„]ì— ë„ì „í•˜ì„¸ìš”!");
    }
    
    delete activeThefts[victimUid]; 
    
    var content = "ğŸ•µï¸ ë„ë‘‘ì§ˆ ì„±ê³µ!\n" + getDisplayName(victim) + "ë‹˜ì˜ ì§€ê°‘ì—ì„œ\n" + fp(stealAmount) + "Pë¥¼ í›”ì³¤ìŠµë‹ˆë‹¤!" + res.repayMsg;
    // [ìˆ˜ì •] ë„ë‘‘ì§ˆ ê²°ê³¼ì— ë³´ìœ  í¬ì¸íŠ¸ í‘œì‹œ ì¶”ê°€
    Api.replyRoom(roomName, formatCommand("ğŸ’° ë„ë‘‘ì§ˆ ê²°ê³¼", thief, content, "ë‚´ ì”ì•¡: " + fp(thief.point) + "P"));
    safeSaveData(data);
}

//==========ì„¹í„°13==========

/**
 * [ê²½ì œ ì‹œìŠ¤í…œ ëª¨ë“ˆ] í†µí•© ìë™ ìƒí™˜ ë° ì‹ ìš© ê´€ë¦¬ (ìˆ˜ì •ëœ ì°¨ë“± ë¹„ìœ¨ ë²„ì „)
 * ìˆ˜ì • ë‚´ìš©: 
 * 1. ì¼ë°˜ ì€í–‰ ë¹š ìƒí™˜: 30%
 * 2. ì‹ ìš©ë¶ˆëŸ‰ì/ì‚¬ì±„ ê°•ì œì¶”ì‹¬: 50%
 * 3. ì€í–‰ ëŒ€í™˜ ì±„ë¬´(ëŒ€ë‚©ê±´): 70%
 */

/* [ê¸°ëŠ¥ 1] ì‹ ìš©ë¶ˆëŸ‰ì ìƒíƒœ ì œì–´ */
function checkAndHandleDefaulter(user, roomName) {
    var currentScore = Number(user.creditScore || 600);
    if (currentScore < 500) {
        if (!user.isDefaulter) {
            user.isDefaulter = true;
            user.icon = ""; 
            var msg = "ì‹ ìš© ì ìˆ˜ 500ì  ë¯¸ë§Œ í•˜ë½\n\n1. ë³´ìœ  ì•„ì´ì½˜ ëª°ìˆ˜\n2. íšë“ í¬ì¸íŠ¸ 50% ìë™ ìƒí™˜ ì ìš©";
            try { Api.replyRoom(roomName, formatCommand("ğŸ“‰ ì‹ ìš©ë¶ˆëŸ‰ì ì§€ì •", user, msg, "ëŒ€ì¶œ ìƒí™˜ì„ ê¶Œì¥í•©ë‹ˆë‹¤.")); } catch(e){}
        }
    } else {
        if (user.isDefaulter) { user.isDefaulter = false; }
    }
}

/* [ê¸°ëŠ¥ 2] ì€í–‰ ëŒ€ì¶œê¸ˆ ë¶„ì‚° ìƒí™˜ ì—”ì§„ */
function distributeRepayment(user, amount) {
    if (!user.loan || Number(user.loan.debt) < 1) {
        if (user.loan) { user.loan.debt = 0; user.loan.items = []; user.isTransferred = false; }
        return { actualRepay: 0, creditGain: 0, clearedCount: 0 };
    }
    
    var remainingRepay = Math.floor(Number(amount));
    var initialAmount = remainingRepay;
    var clearedCount = 0;
    
    if (!user.loan.items) user.loan.items = [];
    user.loan.items.sort(function(a, b) { return a - b; });
    
    var newItems = [];
    for (var i = 0; i < user.loan.items.length; i++) {
        var loanItem = Number(user.loan.items[i]);
        if (loanItem > 0 && remainingRepay >= loanItem) {
            remainingRepay -= loanItem;
            clearedCount++;
        } else {
            loanItem -= remainingRepay;
            remainingRepay = 0;
            if (loanItem > 0) newItems.push(loanItem);
        }
    }
    
    var actualRepayed = initialAmount - remainingRepay;
    user.loan.items = newItems;
    user.loan.debt = 0;
    for(var i=0; i<newItems.length; i++) user.loan.debt += Number(newItems[i]);

    user.creditScore = Math.min(1000, Number(user.creditScore || 600) + (clearedCount * 15));
    if (user.loan.debt <= 0) { user.loan.debt = 0; user.loan.items = []; user.isTransferred = false; }
    
    return { actualRepay: actualRepayed, creditGain: clearedCount * 15, clearedCount: clearedCount };
}

/* [ê¸°ëŠ¥ 3] ì‚¬ì±„(P2P) ìë™ ì¶”ì‹¬ ì²˜ë¦¬ (ìˆ˜ì •: ì¶”ì‹¬ ë¹„ìœ¨ 50% ì ìš©) */
function processPrivateCollection(user, userUid, amount, roomName) {
    var data = getDatabase();
    if (!roomName || !data.rooms[roomName]) return { collected: 0, msg: "" };

    var roomData = data.rooms[roomName];
    
    // [ì„¤ì • ìˆ˜ì •] ì§ì ‘ ì¶”ì‹¬ í•œë„ë¥¼ ìˆ˜ìµì˜ 50%ë¡œ ë³€ê²½
    var totalLimit = Math.floor(Number(amount) * 0.5); 
    var remainingAmount = totalLimit; 
    
    var totalCollected = 0;
    var collectionLog = "";

    if (roomData.loanContracts) {
        for (var cid in roomData.loanContracts) {
            var c = roomData.loanContracts[cid];
            if (c.borrowerUid === userUid && c.status === 'overdue' && remainingAmount > 0) {
                var collectTarget = Math.min(remainingAmount, c.currentDebt);
                
                var lender = roomData.users[c.lenderUid];
                if (lender) {
                    var preL = Number(lender.point);
                    lender.point += collectTarget;
                    verifyPointTransaction(lender, preL, collectTarget, "ì‚¬ì±„ ì¶”ì‹¬ ìˆ˜ìµ (" + c.borrowerName + ")");
                }

                c.currentDebt -= collectTarget;
                totalCollected += collectTarget;
                remainingAmount -= collectTarget;
                collectionLog += "\n- " + c.lenderName + "ë‹˜ê»˜ " + fp(collectTarget) + "P ì†¡ê¸ˆ";

                if (c.currentDebt <= 0) {
                    delete roomData.loanContracts[cid];
                    collectionLog += " (ì™„ë‚© ì¢…ë£Œ)";
                }
            }
        }
    }

    if (totalCollected > 0) {
        var msg = "\n\nğŸš¨ [ì‚¬ì±„ ê°•ì œ ì¶”ì‹¬ ì•ˆë‚´]\nì‚¬ì±„ ì—°ì²´ë¡œ ì¸í•´ ìˆ˜ìµì˜ 50%ê°€ ì±„ê¶Œìì—ê²Œ ìë™ ê·€ì†ë˜ì—ˆìŠµë‹ˆë‹¤." + collectionLog;
        return { collected: totalCollected, msg: msg };
    }
    return { collected: 0, msg: "" };
}

/* [ê¸°ëŠ¥ 4] í†µí•© ìë™ ìƒí™˜ í”„ë¡œì„¸ìŠ¤ (ìˆ˜ì •: ë¹„ìœ¨ ì²´ê³„ ì „ë©´ ê°œí¸) */
function processRepayment(user, amount, userUid, roomName) {
    var amt = Number(amount) || 0;
    var currentGain = amt;
    var totalRepayMsg = "";
    var data = getDatabase();

    if (!user.loan || Number(user.loan.debt || 0) <= 0) {
        user.isTransferred = false;
    }

    // 1. ì‚¬ì±„ ì§ì ‘ ì¶”ì‹¬ (50% ë¹„ìœ¨ ì‘ë™)
    var privateRes = processPrivateCollection(user, userUid, currentGain, roomName);
    if (privateRes.collected > 0) {
        currentGain -= privateRes.collected;
        totalRepayMsg += privateRes.msg;
    }

    // 2. ì€í–‰ ëŒ€ì¶œ ìë™ ìƒí™˜
    if (currentGain > 0 && user.loan && Number(user.loan.debt) > 0) {
        // [ê¸°ë³¸ê°’] ì¼ë°˜ ìœ ì € ìƒí™˜ ë¹„ìœ¨ 30%
        var repaymentRate = 0.3; 
        var typeLabel = "ì¼ë°˜ ìƒí™˜";

        // [ì¡°ê±´ 1] ëŒ€í™˜ ì±„ë¬´(ì€í–‰ì´ ì‚¬ì±„ë¥¼ ëŒ€ì‹  ê°šì•„ì¤€ ê²½ìš°)ëŠ” 70% ì••ë¥˜
        if (user.isTransferred === true || user.isTransferred === "true") {
            repaymentRate = 0.7; 
            typeLabel = "ğŸš¨ ëŒ€í™˜ ì±„ë¬´ ê°•ì œ ì¶”ì‹¬";
        } 
        // [ì¡°ê±´ 2] ì‹ ìš©ë¶ˆëŸ‰ì(500ì  ë¯¸ë§Œ)ëŠ” 50% ì••ë¥˜
        else if (Number(user.creditScore || 600) < 500) {
            repaymentRate = 0.5; 
            typeLabel = "ì‹ ìš©ë¶ˆëŸ‰ ì œí•œ ìƒí™˜";
        }

        var intendedRepay = Math.floor(currentGain * repaymentRate);
        if (intendedRepay > Number(user.loan.debt)) intendedRepay = Number(user.loan.debt);
        
        var res = distributeRepayment(user, intendedRepay);
        currentGain -= res.actualRepay;
        
        if (roomName && data.rooms[roomName]) {
            var rData = data.rooms[roomName];
            if (rData.bankReserve === undefined || rData.bankReserve === null) rData.bankReserve = 10000;
            rData.bankReserve += res.actualRepay;
        }

        totalRepayMsg += "\n\nğŸ¦ [ì€í–‰ " + typeLabel + "]\nğŸ’° " + fp(res.actualRepay) + "P ìƒí™˜ë¨ (" + Math.floor(repaymentRate * 100) + "%)\n(ë‚¨ì€ ëŒ€ì¶œ: " + fp(user.loan.debt) + "P)";
        if (res.creditGain > 0) totalRepayMsg += "\nğŸ“ˆ ì‹ ìš© ì ìˆ˜ +" + res.creditGain + " ìƒìŠ¹";
    }
    
    return { actualGain: currentGain, repayMsg: totalRepayMsg };
}

//==========ì„¹í„°14==========

/* ì£¼ì‹ ì´ë¦„ ìƒì„± í•¨ìˆ˜ */
function generateStockName(data) {
    var conf = SYSTEM_CONFIG.ECO.STOCK; // [ìˆ˜ì •] ê²½ë¡œ ì°¸ì¡° ë³´ì •
    var name = "";
    for (var i = 0; i < 10; i++) {
        var pre = conf.PREFIXES[Math.floor(Math.random() * conf.PREFIXES.length)];
        var suf = conf.SUFFIXES[Math.floor(Math.random() * conf.SUFFIXES.length)];
        name = pre + suf;
        if (!data.stockMarket[name]) break;
    }
    return name;
}

/* ì£¼ì‹ íƒ€ì… í• ë‹¹ í•¨ìˆ˜ */
function assignStockType() {
    var conf = SYSTEM_CONFIG.ECO.STOCK; // [ìˆ˜ì •] ê²½ë¡œ ì°¸ì¡° ë³´ì •
    var rand = Math.random() * 100;
    var cumulative = 0;
    for (var type in conf.TRAITS) {
        cumulative += conf.TRAITS[type].prob;
        if (rand < cumulative) return type;
    }
    return "normal";
}

/* ì£¼ì‹ ë¦¬ìŠ¤íŠ¸ ìƒì„± í•¨ìˆ˜ (ì•„ì´ì½˜ ìš°ì¸¡ ë°°ì¹˜ ë° í•˜ë‹¨ ê²½ê³  ì¶”ê°€) */
function generateStockList(data) {
    var list = [];
    var dangerStocks = [];
    var keys = Object.keys(data.stockMarket || {});
    if (keys.length === 0) return null;

    // [ìˆ˜ì •] SYSTEM_CONFIG ì°¸ì¡°ë¡œ ê²½ë¡œ ë³´ì • (ì „ì—­ ë³€ìˆ˜ STOCK_TRAITS ì œê±° ëŒ€ì‘)
    var stockTraits = SYSTEM_CONFIG.ECO.STOCK.TRAITS;

    for (var i = 0; i < keys.length; i++) {
        var name = keys[i];
        var stock = data.stockMarket[name];
        var trait = stockTraits[stock.type] || stockTraits.normal;
        
        var diff = Number(stock.price) - Number(stock.lastPrice);
        var rate = stock.lastPrice > 0 ? ((diff / stock.lastPrice) * 100).toFixed(1) : "0.0";
        var sign = diff > 0 ? "ğŸ”º" : (diff < 0 ? "ğŸ”¹" : "â–");
        
        // [ìˆ˜ì •] ì •ë¦¬ë§¤ë§¤ ì•„ì´ì½˜ ë¡œì§ (ìš°ì¸¡ í‘œì‹œìš©)
        var warningMark = "";
        if (stock.delistTick && stock.delistTick > 0) {
            warningMark = " âš ï¸";
            dangerStocks.push(name);
        }
        
        // [ìˆ˜ì •] ì£¼ê°€ í¬ì¸íŠ¸ ìˆ˜ì¹˜ì— .toLocaleString() ì ìš© ë° ì•„ì´ì½˜ ë°°ì¹˜ ìœ ì§€
        list.push(trait.icon + " " + name + ": " + fp(stock.price) + "P (" + sign + " " + Math.abs(rate) + "%)" + warningMark);
    }

    var result = list.join("\n");

    // [ìˆ˜ì •] í•˜ë‹¨ ê²½ê³  ì„¹ì…˜ ìƒì„±
    if (dangerStocks.length > 0) {
        result += "\n\nâš ï¸ ì£¼ê°€ í­ë½ìœ¼ë¡œ ì •ë¦¬ë§¤ë§¤ ë‹¨ê³„ ì§„ì…!\ní•´ë‹¹ ì¢…ëª© : " + dangerStocks.join(", ");
    }
    
    return result;
}

//==========ì„¹í„°15==========

/* ì£¼ì‹ ì´ë¦„ ìƒì„± í•¨ìˆ˜ (ìƒìˆ˜ ì°¸ì¡° ê²½ë¡œ ìˆ˜ì •) */
function generateStockName(data) {
    var conf = SYSTEM_CONFIG.ECO.STOCK;
    var name = "";
    for (var i = 0; i < 20; i++) {
        var pre = conf.PREFIXES[Math.floor(Math.random() * conf.PREFIXES.length)];
        var suf = conf.SUFFIXES[Math.floor(Math.random() * conf.SUFFIXES.length)];
        name = pre + suf;
        if (!data.stockMarket || !data.stockMarket[name]) break;
    }
    return name;
}

/* ì£¼ì‹ íƒ€ì… í• ë‹¹ í•¨ìˆ˜ */
function assignStockType() {
    var conf = SYSTEM_CONFIG.ECO.STOCK;
    var rand = Math.random() * 100;
    var cumulative = 0;
    for (var type in conf.TRAITS) {
        cumulative += conf.TRAITS[type].prob;
        if (rand < cumulative) return type;
    }
    return "normal";
}

/* ì£¼ì‹ ì‹œì„¸ ë³€ë™ ë¡œì§ í•¨ìˆ˜ (ì •ë°€ë„ ë³´ì • ë° ì¡°ì‘ ì—°ë™) */
function updateStockPrices(data) {
    var conf = SYSTEM_CONFIG.ECO.STOCK;
    if (!data.stockMarket) data.stockMarket = {};
    if (!data.stockTraffic) data.stockTraffic = {}; 

    var now = new Date();
    var currentHour = now.getHours();
    var currentMin = now.getMinutes();
    var isMarketOpen = (currentHour >= conf.SETTINGS.OPEN_HOUR && currentHour <= conf.SETTINGS.CLOSE_HOUR);
    
    var totalSum = 0;
    var count = 0;
    for (var k in data.stockMarket) { totalSum += Number(data.stockMarket[k].price); count++; }
    var marketAvg = count > 0 ? (totalSum / count) : 1000;

    /* [ìˆ˜ì •] ê²½ì œ ì§€í‘œ ê³„ì‚° ì‹œ 'ë‚´ë¦¬ë‹¤' ë°©ì˜ ë°ì´í„°ë§Œ ë…ë¦½ì ìœ¼ë¡œ ì°¸ì¡° (ë°© ê²©ë¦¬) */
    var eco = calculateEconomy(data, "ë‚´ë¦¬ë‹¤");
    var activeUserCount = Math.max(1, eco.count); 

    /* [ìˆ˜ì •] ìƒí í•˜í•œì„ (Floor) ë¡œì§ ì•ˆì •í™”: í‰ê·  ìì‚°ì˜ 1%ë¥¼ ë”°ë¥´ë˜, ìµœëŒ€ 400Pë¥¼ ë„˜ì§€ ì•Šë„ë¡ ìº¡(Cap) ì ìš© */
    var ecoBaseFloor = Math.min(400, Math.floor(eco.average * 0.01)); 
    if (ecoBaseFloor < 50) ecoBaseFloor = 50; 

    var eventNews = [];

    /* [1] ì‹ ê·œ ìƒì¥ ì²˜ë¦¬ */
    if (data.pendingNewStock && isMarketOpen) {
        if (Object.keys(data.stockMarket).length < conf.SETTINGS.MAX_COUNT) {
            var newName = generateStockName(data);
            var newType = assignStockType();
            var startPrice = Math.floor(marketAvg * ((Math.random() * 0.3) + 0.8));
            var randomLimit = Math.floor(Math.random() * 4) + 2; 
            
            data.stockMarket[newName] = { 
                price: Number(startPrice), lastPrice: Number(startPrice), 
                type: newType, delistTick: 0, delistLimit: randomLimit,
                trend: "none", trendTick: 0, lastTrafficImpact: 0 
            };
            eventNews.push("ğŸ“¢ ì‹ ê·œ ìƒì¥: " + conf.TRAITS[newType].icon + " " + newName + " (" + fp(startPrice) + "P)");
        }
        data.pendingNewStock = false;
    }

    /* [2] ì¡°ì‘ í”„ë¦¬ì…‹ ì„¤ì • ë¡œë“œ */
    var mani = conf.MANIPULATION;
    var specStock = (mani && mani.ACTIVE) ? mani.TARGET : null;
    var specFactor = (mani && mani.ACTIVE) ? (mani.IS_UP ? Math.abs(mani.RATE) : -Math.abs(mani.RATE)) : 0;

    if (!specStock && data.pendingSpecialEffect && isMarketOpen) {
        specStock = data.pendingSpecialEffect.stock;
        specFactor = data.pendingSpecialEffect.factor;
    }

    /* [3] ì‹œì„¸ ë³€ë™ ê³„ì‚° ë£¨í”„ */
    for (var name in data.stockMarket) {
        var stock = data.stockMarket[name];
        var trait = conf.TRAITS[stock.type] || conf.TRAITS.normal;
        var changePercent = 0;
        
        stock.lastPrice = Number(stock.price);

        // [í•µì‹¬] ìƒì¥íì§€ ì¡°ê±´ íŒë³„ ë° ìŠ¤íƒ ê°€ê°
        if (stock.price < marketAvg * 0.20 || stock.price < ecoBaseFloor) { 
            stock.delistTick++; 
        } else { 
            // ì¡°ê±´ì—ì„œ ë²—ì–´ë‚˜ë©´ ê²½ê³  ìŠ¤íƒì„ ì¦‰ì‹œ ì´ˆê¸°í™”í•˜ì—¬ 'âš ï¸' í‘œì‹œ ì œê±°
            stock.delistTick = 0; 
        }

        if (isMarketOpen) {
            if (name === specStock) { 
                changePercent = specFactor;
                eventNews.push("ğŸš¨ [ë³€ë™ì„± ì•Œë¦¼]\nì¢…ëª©: " + name + "\në‚´ìš©: " + (specFactor > 0 ? "ğŸš€ í­ë“±" : "ğŸ“‰ í­ë½") + " (" + (Math.abs(specFactor * 100)).toFixed(0) + "%)");
            } else {
                if (stock.trendTick <= 0) {
                    stock.trendTick = Math.floor(Math.random() * 4) + 2;
                    var p = Math.random(); stock.trend = (p < 0.35) ? "up" : (p < 0.70 ? "down" : "volatile");
                }
                var baseRate = (stock.trend === "up" ? 0.025 : (stock.trend === "down" ? -0.025 : (Math.random()*0.08-0.04)));
                changePercent = baseRate * trait.volatility;
                if (stock.trendTick > 0) stock.trendTick--;
            }
            
            var traffic = data.stockTraffic[name] || { buy: 0, sell: 0 };
            var trafficImpact = Math.max(-0.15, Math.min(0.15, ((traffic.buy - traffic.sell) / (activeUserCount * 5)) * 0.01));
            changePercent += trafficImpact;

            if (marketOpenPrice > 0) {
                var growthRate = (stock.price - marketOpenPrice) / marketOpenPrice;
                var sConf = conf.SETTINGS;

                if (growthRate > sConf.RESISTANCE_START) {
                    var elapsed = (currentHour - sConf.OPEN_HOUR) * 60 + currentMin;
                    var totalTime = (sConf.CLOSE_HOUR - sConf.OPEN_HOUR) * 60;
                    var timeWeight = Math.min(Math.max(elapsed / totalTime, 0), 1.0);
                    var resistance = (growthRate - sConf.RESISTANCE_START) * sConf.GRAVITY * (1 + timeWeight);
                    changePercent -= resistance;

                    if (growthRate >= (sConf.CLOSING_LIMIT - 0.01) && changePercent > 0) {
                        if (Math.random() < 0.85) {
                            changePercent = -Math.abs(changePercent) * 0.4;
                        }
                    }
                }
            }
        }
        
        var nextPrice = stock.price * (1 + changePercent);
        stock.price = Math.max(10, Math.round(nextPrice)); 
    }

    /* ìƒì¥íì§€ ì§‘í–‰ */
    var delisted = [];
    for (var name in data.stockMarket) {
        if (data.stockMarket[name].delistTick >= data.stockMarket[name].delistLimit) delisted.push(name);
    }
    
    for (var i=0; i<delisted.length; i++) { 
        var delName = delisted[i];
        for (var r in data.rooms) {
            var users = data.rooms[r].users;
            for (var uid in users) {
                if (users[uid].stockHoldings) {
                    delete users[uid].stockHoldings[delName];
                    if (users[uid].stockAvg) delete users[uid].stockAvg[delName];
                }
            }
        }
        delete data.stockMarket[delName]; 
        eventNews.push("ğŸš¨ [ìƒì¥íì§€] " + delName + "\nì‚¬ìœ : ì£¼ê°€ ìš”ê±´ ë¯¸ë‹¬ (í•˜í•œì„ : " + fp(ecoBaseFloor) + "P)"); 
    }

    data.stockTraffic = {}; 
    data.pendingSpecialEffect = null; 
    
    return eventNews;
}

/* ì£¼ì‹ ì‹œì¥ ìˆ˜ë™ ì œì–´ ì—”ì§„ */
function market_forceNewListing() {
    var data = getDatabase();
    data.pendingNewStock = true;
    return "âœ… ë‹¤ìŒ ë³€ë™ íƒ€ì„ì— ì‹ ê·œ ìƒì¥ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.";
}

function market_setSpecialEffect(stockName, isUp, factor) {
    var data = getDatabase();
    var conf = SYSTEM_CONFIG.ECO.STOCK.SETTINGS;
    if (!data.stockMarket[stockName]) return "âŒ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì¢…ëª©ì…ë‹ˆë‹¤.";
    var useFactor = (factor !== undefined) ? factor : conf.MANI_RATE;
    var finalFactor = isUp ? Math.abs(useFactor) : -Math.abs(useFactor);
    data.pendingSpecialEffect = { stock: stockName, factor: finalFactor };
    return "âœ… [" + stockName + "] " + (Math.abs(useFactor*100)).toFixed(0) + "% " + (isUp ? "í­ë“±" : "í­ë½") + " ì˜ˆì•½ ì™„ë£Œ.";
}

function market_updateNow(roomName) {
    var data = getDatabase();
    var result = updateStockPrices(data);
    var body = "ğŸ“‰ ì£¼ì‹ ì‹œì„¸ ë³€ë™\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸŸ¢ ì¥ ìš´ì˜ ì¤‘\n\n" + (generateStockList(data) || "ì‹œì„¸ ì •ë³´ ì—†ìŒ");
    if (result.length > 0) body += "\n\n" + result.join("\n");
    body += "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"; 
    Api.replyRoom(roomName || "ë‚´ë¦¬ë‹¤", body);
    safeSaveData(data);
    return "âœ… ì‹œì¥ ê°±ì‹  ì™„ë£Œ.";
}

//==========ì„¹í„°16-1==========

/* í†µí•© ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰ í•¨ìˆ˜ (ë…ë¦½ ëª¨ë“ˆí˜• ì—”ì§„ + ëŒ€ì‹œë³´ë“œ ì—°ë™) */
function runScheduler() {
    var SCHEDULER_KEY = "kakaobot_scheduler_v5";
    var oldTimer = java.lang.System.getProperty(SCHEDULER_KEY);
    if (oldTimer) try { clearInterval(parseInt(oldTimer)); } catch (e) {}
    
    var newTimer = setInterval(function() {
        try {
            var data = getDatabase(); 
            if (!data) return; 

            // ëª¨ë“  ì„¹í„°ê°€ ê³µìœ í•  ìƒíƒœ ê°ì²´ (Context)
            var ctx = {
                isUpdated: false,
                isForceBackup: false,
                now: new Date(),
                today: getSimpleDate(),
                season: getSimpleSeason(),
                /* [Gemini ìš”ì²­ ì‚¬í•­] í•˜ë“œì½”ë”© ìœ ì§€: ë©”ì¸ ìš´ì˜ ë°© ì§€ì • */
                targetRoom: "ë‚´ë¦¬ë‹¤",
                // ì•„ë˜ URLì— ë³¸ì¸ì˜ êµ¬ê¸€ ì›¹ ì•± URLì„ ì…ë ¥í•˜ì„¸ìš”.
                dashboardUrl: "https://script.google.com/macros/s/AKfycbyoURblg3-nLNgSE57Pb9RmjqK3wXyMSRpm9WrkWe3z2kyE_q_wmoabNECLNXWQ2SBZ/exec"
            };

            /* [ëª¨ë“ˆ ì‹¤í–‰] ì„¹í„° 16-2 ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ */
            if (typeof _runSector16Logic === 'function') {
                _runSector16Logic(data, ctx);
            }

            /* [ëª¨ë“ˆ ì‹¤í–‰] ì„¹í„° 17, 18 ë¡œì§ ì•ˆì „ í˜¸ì¶œ */
            if (typeof _runSector17Logic === 'function') _runSector17Logic(data, ctx);
            if (typeof _runSector18Logic === 'function') _runSector18Logic(data, ctx);

            /* [ì‹ ê·œ] 10ë¶„ ì£¼ê¸° êµ¬ê¸€ ì‹œíŠ¸ ëŒ€ì‹œë³´ë“œ ë™ê¸°í™” */
            var currentMin = ctx.now.getMinutes();
            if (currentMin % 10 === 0 && data.lastWebSyncMin !== currentMin && ctx.dashboardUrl.indexOf("http") === 0) {
                data.lastWebSyncMin = currentMin;
                _sendToDashboard(data, ctx);
            }

            /* [ìµœì¢… ì €ì¥] í•˜ì´ë¸Œë¦¬ë“œ ë¹„ë™ê¸° ì €ì¥ ì²˜ë¦¬ */
            if (ctx.isUpdated) {
                SaveExecutor.execute(new java.lang.Runnable({
                    run: function() { safeSaveData(data, ctx.isForceBackup); }
                }));
            }

        } catch (e) { Log.error("Scheduler Error: " + e); }
    }, 1000);
    java.lang.System.setProperty(SCHEDULER_KEY, String(newTimer));
}

/** * [Gemini ìš”ì²­ ì‚¬í•­] ëŒ€ì‹œë³´ë“œ ë°ì´í„° ì „ì†¡ í•¨ìˆ˜ (ë°©ë³„ ë°ì´í„° ë¶„ë¦¬ ë° ê²©ë¦¬)
 * ìˆ˜ì • ë‚´ìš©: í…ŒìŠ¤íŠ¸ ë°©ì˜ ìì‚°ì´ ëŒ€ì‹œë³´ë“œ ë° ì „ì²´ ê²½ì œ ì§€í‘œì— í•©ì‚°ë˜ì§€ ì•Šë„ë¡ 
 * ctx.targetRoom("ë‚´ë¦¬ë‹¤")ì˜ ë°ì´í„°ë§Œ í•„í„°ë§í•˜ì—¬ ì§‘ê³„í•©ë‹ˆë‹¤.
 */
function _sendToDashboard(data, ctx) {
    var totalPoints = 0;
    var userCount = 0;
    
    // [ìˆ˜ì •] ëª¨ë“  ë°©(data.rooms)ì„ ìˆœíšŒí•˜ëŠ” ëŒ€ì‹  ì§€ì •ëœ ë©”ì¸ ë°©ë§Œ ì°¸ì¡°í•˜ì—¬ 'ì§€í‘œ ì˜¤ì—¼' ë°©ì§€
    var mainRoomData = data.rooms[ctx.targetRoom];
    
    if (mainRoomData && mainRoomData.users) {
        for (var u in mainRoomData.users) {
            var userObj = mainRoomData.users[u];
            // í•´ë‹¹ ë°©ì˜ ìœ ì € í¬ì¸íŠ¸ì™€ ì˜ˆê¸ˆë§Œ í•©ì‚°
            totalPoints += (Number(userObj.point || 0) + Number(userObj.bank || 0));
            userCount++;
        }
        
        // í•´ë‹¹ ë°©ì˜ ì¤‘ì•™ì€í–‰ ì¬ì›(bankReserve)ë„ ê²½ì œ ì§€í‘œì— í¬í•¨
        if (mainRoomData.bankReserve !== undefined) {
            totalPoints += Number(mainRoomData.bankReserve);
        }
    }

    var payload = {
        total_money: totalPoints,
        user_count: userCount,
        stocks: data.stockMarket || {}
    };

    Executor.execute(new java.lang.Runnable({
        run: function() {
            try {
                org.jsoup.Jsoup.connect(ctx.dashboardUrl)
                    .header("Content-Type", "application/json")
                    .requestBody(JSON.stringify(payload))
                    .ignoreContentType(true)
                    .ignoreHttpErrors(true)
                    .method(org.jsoup.Connection.Method.POST)
                    .execute();
            } catch (e) { Log.error("Dashboard Sync Error: " + e); }
        }
    }));
}

//==========ì„¹í„°16-2==========

/* ë…ë¦½ ë¡œì§ í•¨ìˆ˜: ì‚¬ì±„ ë° ì‹œìŠ¤í…œ ê´€ë¦¬ + ê²½ë§ˆ ìŠ¤ì¼€ì¤„ëŸ¬ í†µí•© ì—”ì§„ */
function _runSector16Logic(data, ctx) {
    var nowTs = ctx.now.getTime();
    var currentHour = ctx.now.getHours();
    var currentMin = ctx.now.getMinutes();
    var currentSec = ctx.now.getSeconds();
    var conf = SYSTEM_CONFIG.ECO.STOCK;
    var rConf = SYSTEM_CONFIG.ECO.RACING; // ì„¹í„°1ì—ì„œ ì„¤ì •í•œ ê²½ë§ˆ ìƒìˆ˜ ì°¸ì¡°

    var DASHBOARD_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQWUH4iH7iLI2ZAR1MC3OERD4I2LcJVX23waSW7MLhjgGwjr6hTXKSNiAD048B9K4dtr8OosHqbTsrb/pubchart?oid=121239500&format=interactive";

    /* [ì‹ ê·œ] 5ë¶„ ì£¼ê¸° ì˜¤í† ì„¸ì´ë¸Œ ì—”ì§„ */
    if (currentMin % 5 === 0 && data.lastAutoSaveMin !== currentMin) {
        data.lastAutoSaveMin = currentMin;
        ctx.isUpdated = true;
        ctx.isForceBackup = true; 
    }

    /* [ìˆ˜ì •] ì£¼ì‹ ì¥ ì˜¤í”ˆ ì‹œê°€ ê¸°ë¡ ë° DB ì €ì¥ */
    if (currentHour === conf.SETTINGS.OPEN_HOUR && currentMin === 0 && data.lastMarketOpenMin !== currentMin) {
        data.lastMarketOpenMin = currentMin;
        if (data.stockMarket) {
            var stocks = Object.keys(data.stockMarket);
            if (stocks.length > 0) {
                marketOpenPrice = data.stockMarket[stocks[0]].price; 
                data.marketOpenPrice = marketOpenPrice;
                ctx.isUpdated = true;
            }
        }
    }

    /* 1. ë°©ë³„ ìœ ì € ê°„ ì‚¬ì±„ ì‹œìŠ¤í…œ ë° ê²½ì œ ê°ì‹œ ì—”ì§„ (ë¬´ê²°ì„± ìœ ì§€) */
    for (var rName in data.rooms) {
        var roomData = data.rooms[rName];
        if (!roomData.loanContracts) roomData.loanContracts = {};

        if (roomData.bankReserve !== undefined) {
            var reserve = roomData.bankReserve;
            if (!roomData.lastBankAlert) roomData.lastBankAlert = "normal";

            var roomBase = roomData.economyBase || 1000000;
            var warningLimit = Math.floor(roomBase * 0.1);
            var disasterLimit = Math.floor(roomBase * 0.01);
            var normalLimit = warningLimit * 2;

            if (reserve < disasterLimit && roomData.lastBankAlert !== "disaster") {
                roomData.lastBankAlert = "disaster";
                var disasterMsg = "ğŸš¨ [êµ­ê°€ ê²½ì œ ì¬ë‚œ ì„ í¬] ğŸš¨\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\ní˜„ ì‹œê°ë¶€ë¡œ êµ­ê°€ ê²½ì œ ì¬ë‚œ ìƒíƒœë¥¼ ì„ í¬í•©ë‹ˆë‹¤.\nì¤‘ì•™ì€í–‰ ê¸ˆê³  ìì‚°ì´ ì„ê³„ì¹˜(" + fp(disasterLimit) + "P) ì•„ë˜ë¡œ ê¸‰ë½í•˜ì—¬ ëª¨ë“  ë³´ìƒ ë° ì¶œê¸ˆì´ ì •ì§€ë  ìœ„í—˜ì´ í½ë‹ˆë‹¤.\n\nğŸ¦ í˜„ì¬ ê¸ˆê³ : " + fp(reserve) + "P\nâš ï¸ ì¡°ì¹˜: ê´€ë¦¬ìì˜ ì¦‰ê°ì ì¸ ì¬ì› ìˆ˜í˜ˆì´ í•„ìš”í•©ë‹ˆë‹¤.";
                Api.replyRoom(rName, disasterMsg);
                ctx.isUpdated = true;
            }
            else if (reserve < warningLimit && reserve >= disasterLimit && roomData.lastBankAlert === "normal") {
                roomData.lastBankAlert = "warning";
                var warningMsg = "âš ï¸ [êµ­ê°€ ê²½ì œ ë§ˆë¹„ ì˜ˆë¹„ ê²½ë³´]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nì¤‘ì•™ì€í–‰ ê¸ˆê³  ì”ì•¡ì´ " + fp(warningLimit) + "P ë¯¸ë§Œìœ¼ë¡œ í•˜ë½í–ˆìŠµë‹ˆë‹¤.\nì§€ì†ì ì¸ ë³´ìƒ ìœ ì§€ë¥¼ ìœ„í•´ ê²½ì œ í™œë™ í™œì„±í™” ë˜ëŠ” ì¬ì› ë³´ì¶©ì´ ê¶Œê³ ë©ë‹ˆë‹¤.\n\nğŸ¦ í˜„ì¬ ê¸ˆê³ : " + fp(reserve) + "P";
                Api.replyRoom(rName, warningMsg);
                ctx.isUpdated = true;
            }
            else if (reserve >= normalLimit && (roomData.lastBankAlert === "warning" || roomData.lastBankAlert === "disaster")) {
                roomData.lastBankAlert = "normal";
                var normalMsg = "âœ… [êµ­ê°€ ê²½ì œ ì •ìƒí™” ì•Œë¦¼]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nì¬ì› ìˆ˜í˜ˆ ë° ìœ ë™ì„± í™•ë³´ë¥¼ í†µí•´ ê¸ˆê³ ê°€ ë‹¤ì‹œ ì•ˆì •ê¶Œ(" + fp(normalLimit) + "P ì´ìƒ)ì— ì§„ì…í–ˆìŠµë‹ˆë‹¤.\nì¤‘ë‹¨ë˜ì—ˆë˜ ê°ì¢… ê²½ì œ ë¡œì§ì´ ì •ìƒí™”ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nğŸ¦ í˜„ì¬ ê¸ˆê³ : " + fp(reserve) + "P";
                Api.replyRoom(rName, normalMsg);
                ctx.isUpdated = true;
            }
        }

        for (var cid in roomData.loanContracts) {
            var c = roomData.loanContracts[cid];
            var periodsPassed = Math.floor((nowTs - c.startTime) / 10800000); 
            
            if (c.appliedPeriods === undefined) c.appliedPeriods = 0;
            if (periodsPassed > c.appliedPeriods) {
                var pendingPeriods = periodsPassed - c.appliedPeriods;
                var totalNewInterest = 0;
                for (var i = 0; i < pendingPeriods; i++) {
                    var interest = Math.floor(c.currentDebt * (c.rate / 100));
                    c.currentDebt += interest;
                    totalNewInterest += interest;
                }
                c.appliedPeriods = periodsPassed;
                ctx.isUpdated = true;
                try {
                    var interestMsg = "ğŸš¬ [ì‚¬ì±„ ì´ì ê°±ì‹ ]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                                      "ğŸ‘¤ ëŒ€ìƒ: " + c.borrowerName + "ë‹˜\n" +
                                      "ğŸ¤ ì±„ê¶Œì: " + c.lenderName + "\n" +
                                      "ğŸ•’ ê²½ê³¼: " + (periodsPassed * 3) + "ì‹œê°„\n" +
                                      "ğŸ’° ì¶”ê°€ ì´ì: +" + fp(totalNewInterest) + "P\n" +
                                      "ğŸ“‰ í˜„ì¬ ì±„ë¬´: " + fp(c.currentDebt) + "P\n" +
                                      "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”";
                    Api.replyRoom(rName, interestMsg);
                } catch(e) {}
            }

            var duration = nowTs - c.startTime;
            var overdueLimit = 24 * 60 * 60 * 1000;
            var bankTakeoverLimit = 36 * 60 * 60 * 1000;

            if (c.status === 'active' && duration > overdueLimit && duration <= bankTakeoverLimit) {
                c.status = 'overdue'; 
                ctx.isUpdated = true;
                try {
                    var collectionMsg = "ğŸš¨ [ê°•ì œ ì¶”ì‹¬ ì§‘í–‰ ì•Œë¦¼]\nëŒ€ìƒ: " + c.borrowerName + "ë‹˜\nì‚¬ìœ : ìƒí™˜ ê¸°í•œ(24ì‹œê°„) ì´ˆê³¼\n\nì§€ê¸ˆë¶€í„° ìˆ˜ìµì˜ 50%ê°€ ì±„ê¶Œìì—ê²Œ ìë™ ê·€ì†ë©ë‹ˆë‹¤.";
                    Api.replyRoom(rName, collectionMsg);
                } catch(e) {}
            }
            else if (duration > bankTakeoverLimit) {
                var amountToPay = Number(c.currentDebt);
                var lender = roomData.users[c.lenderUid];
                var borrower = roomData.users[c.borrowerUid];

                if (lender && borrower) {
                    if (roomData.bankReserve === undefined) roomData.bankReserve = 10000;
                    roomData.bankReserve -= amountToPay;
                    var preLenderPoint = Number(lender.point);
                    lender.point = preLenderPoint + amountToPay;
                    verifyPointTransaction(lender, preLenderPoint, amountToPay, "ì‚¬ì±„ ì€í–‰ ëŒ€ë‚© íšŒìˆ˜ (" + c.borrowerName + ")");
                    if (!borrower.loan) borrower.loan = { debt: 0, items: [] };
                    borrower.loan.debt = Number(borrower.loan.debt) + amountToPay;
                    borrower.loan.items.push(amountToPay);
                    borrower.isTransferred = true; 
                    borrower.creditScore = Math.max(0, (borrower.creditScore || 600) - 50);
                    checkAndHandleDefaulter(borrower, rName);
                    var takeoverMsg = "ğŸ›ï¸ [ì¤‘ì•™ì€í–‰ ëŒ€í™˜ ì§‘í–‰]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ‘¤ ëŒ€ìƒ: " + c.borrowerName + "ë‹˜\n\në‚´ìš©: ì‚¬ì±„ ì—°ì²´ 36ì‹œê°„ ê²½ê³¼ë¡œ ì¸í•´ ì€í–‰ì´ " + fp(amountToPay) + "Pë¥¼ ëŒ€ë‚© ì²˜ë¦¬í•˜ì˜€ìŠµë‹ˆë‹¤.\n\nâš ï¸ [í˜ë„í‹°]: ì‹ ìš©ì ìˆ˜ -50ì  ê°•ë“±\nâš ï¸ í•´ë‹¹ ì±„ë¬´ëŠ” [ì€í–‰ ëŒ€í™˜ ëŒ€ì¶œ]ë¡œ ì „í™˜ë˜ì—ˆìœ¼ë©°, ì™„ë‚© ì‹œê¹Œì§€ ëª¨ë“  ìˆ˜ìµì˜ 70%ê°€ ê°•ì œ ìƒí™˜ë©ë‹ˆë‹¤.\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”";
                    Api.replyRoom(rName, takeoverMsg);
                    delete roomData.loanContracts[cid];
                    ctx.isUpdated = true;
                }
            }
        }
    }

    /* 2. ì£¼ì‹ ì£¼ê¸°ì  ë³€ë™ ì²˜ë¦¬ (ë¬´ê²°ì„± ìœ ì§€) */
    if (currentHour >= conf.SETTINGS.OPEN_HOUR && currentHour <= conf.SETTINGS.CLOSE_HOUR && currentMin % 10 === 0 && data.lastStockUpdateMin !== currentMin) {
        data.lastStockUpdateMin = currentMin; 
        var mani = conf.MANIPULATION;
        if (mani && mani.ACTIVE === true) {
            data.pendingSpecialEffect = { stock: mani.TARGET, factor: mani.IS_UP ? Math.abs(mani.RATE) : -Math.abs(mani.RATE), forceMani: true };
        } else {
            var currentStockCount = Object.keys(data.stockMarket || {}).length;
            if (currentStockCount < 10 && Math.random() < SYSTEM_CONFIG.PROB.STOCK_NEW_LISTING) { 
                data.pendingNewStock = true;
            } else if (Math.random() < SYSTEM_CONFIG.PROB.STOCK_SPECIAL) {
                var stocks = Object.keys(data.stockMarket || {});
                if (stocks.length > 0) {
                    var target = stocks[Math.floor(Math.random() * stocks.length)];
                    var isUp = Math.random() < SYSTEM_CONFIG.PROB.STOCK_UP_CHANCE;
                    var randFactor = (Math.random() * 0.10) + 0.15; 
                    data.pendingSpecialEffect = { stock: target, factor: isUp ? randFactor : -randFactor };
                }
            }
        }
        try { java.lang.Thread.sleep(1000); } catch(e){}
        if (currentHour === conf.SETTINGS.CLOSE_HOUR && currentMin === 50 && typeof stock_applyClosingCorrection === 'function') {
            for (var sName in data.stockMarket) { data.stockMarket[sName].price = stock_applyClosingCorrection(data.stockMarket[sName].price); }
        }
        var stockResult = updateStockPrices(data); 
        var isMarketOpen = (currentHour >= conf.SETTINGS.OPEN_HOUR && currentHour <= conf.SETTINGS.CLOSE_HOUR);
        var statusText = isMarketOpen ? "ğŸŸ¢ ì¥ ìš´ì˜ ì¤‘ (07:00 ~ 23:59)" : "ğŸ”´ ì¥ ë§ˆê°";
        var body = "ğŸ“‰ ì£¼ì‹ ì‹œì„¸ ë³€ë™\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + statusText + "\n\n" + (generateStockList(data) || "ì‹œì„¸ ì •ë³´ ì—†ìŒ"); 
        if (stockResult.length > 0) body += "\n\n" + stockResult.join("\n");
        body += "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”";
        try { Api.replyRoom(ctx.targetRoom, body); } catch(err) {}
        ctx.isUpdated = true;
    }

    /* [ìˆ˜ì •] 3. ê²½ë§ˆ ì‹œìŠ¤í…œ í†µí•© ìŠ¤ì¼€ì¤„ëŸ¬ (ë°°ë‹¹ ë³´ì „ ë° 3ë°° ë³´ì¥ ë¡œì§ ë°˜ì˜) */
    
    // A. ê°œì¥ ì•Œë¦¼ (09:00:00)
    if (currentHour === rConf.OPEN_HOUR && currentMin === 0 && currentSec === 0) {
        racingData.isOperating = true;
        racingData.isResultProcessed = true; 
        var startMsg = "ğŸ‡ [ë‚´ë¦¬ë‹¤ ê²½ë§ˆì¥ ê°œì¥ ì•Œë¦¼]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nì§€ê¸ˆë¶€í„° ì œ " + racingData.round + "íšŒì°¨ ê²½ë§ˆ ë°°íŒ…ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤!\n\nğŸ•’ ë°°íŒ… ì‹œê°„: ë§¤ì‹œ 00ë¶„ ~ 49ë¶„ 59ì´ˆ\nğŸ ê²°ê³¼ ë°œí‘œ: ë§¤ì‹œ 00ë¶„ 00ì´ˆ\nğŸš« ìš´ì˜ ì¢…ë£Œ: 23:59 (00:00 ìµœì¢… ê²°ê³¼)\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’¡ í˜„í™© í™•ì¸: [/ê²½ë§ˆ] ì…ë ¥";
        Api.replyRoom(ctx.targetRoom, startMsg);
    }

    // B. ë°°íŒ… ë§ˆê° ì•Œë¦¼ (ë§¤ì‹œ 49:59)
    if (racingData.isOperating && currentMin === 49 && currentSec === 59 && !racingData.isDeadlineNotified) {
        racingData.isDeadlineNotified = true;
        var deadlineMsg = "ğŸ“¢ [ê²½ë§ˆ ë°°íŒ… ë§ˆê° ì•Œë¦¼]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nì œ " + racingData.round + "íšŒì°¨ ë°°íŒ…ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\nğŸ¦ ìµœì¢… ì§‘ê³„ í¬ì¸íŠ¸: " + fp(racingData.totalPool) + "P\nğŸ ìš°ìŠ¹ë§ˆ íŒë… ë° ì •ì‚° ì§„í–‰ ì¤‘...\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ‡ ì ì‹œ í›„ ì •ê°(00ë¶„)ì— ê²°ê³¼ê°€ ë°œí‘œë©ë‹ˆë‹¤!";
        Api.replyRoom(ctx.targetRoom, deadlineMsg);
    }

    // C. ê²°ê³¼ ë°œí‘œ ë° ìƒˆ ë¼ìš´ë“œ ì‹œì‘ (ë§¤ì‹œ 00:00:00)
    if ((racingData.isOperating || currentHour === 0) && currentMin === 0 && currentSec === 0 && currentHour !== rConf.OPEN_HOUR && !racingData.isResultProcessed) {
        racingData.isResultProcessed = true;
        
        var totalW = 0; racingData.horses.forEach(function(h){ totalW += h.weight; });
        var rVal = Math.random() * totalW; var accum = 0; var winner = racingData.horses[0];
        for(var i=0; i<racingData.horses.length; i++){ accum += racingData.horses[i].weight; if(rVal < accum){ winner = racingData.horses[i]; break; } }

        var tax = Math.floor(racingData.totalPool * rConf.TAX_RATE);
        var basePool = racingData.totalPool - tax + racingData.carryOver;
        var winPool = 0; var winnerUids = [];
        for(var uid in racingData.bets){ if(racingData.bets[uid].horseId === winner.id){ winPool += racingData.bets[uid].amount; winnerUids.push(uid); } }

        var mainRoom = data.rooms[ctx.targetRoom];
        if(mainRoom) mainRoom.bankReserve = (mainRoom.bankReserve || 0) + tax;

        var resultHeader = "ğŸ [ì œ " + racingData.round + "íšŒ ê²½ë§ˆ ê²°ê³¼ ë° ìƒˆ ê²½ê¸° ì•ˆë‚´]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n[ğŸ† ì§€ë‚œ ê²½ê¸° ê²°ê³¼]\n\"ë§ˆì§€ë§‰ ì§ì„  ì£¼ë¡œì—ì„œ " + winner.id + "ë²ˆ " + winner.name + "ê°€ ê³¨ì¸!\"\n\nğŸ¥‡ ìš°ìŠ¹ë§ˆ: [" + winner.id + "ë²ˆ " + winner.name + "]\n";
        var resultBody = "";
        
        if(winnerUids.length > 0) {
            /* [í•µì‹¬] 3ë°° ë³´ì „ ë° ì§€ì›ê¸ˆ ê³„ì‚° ë¡œì§ */
            var minDiv = 3.0; // ìµœì†Œ 3ë°° ë³´ì¥
            var totalRequiredFor3x = Math.floor(winPool * minDiv);
            var subsidyNeeded = Math.max(0, totalRequiredFor3x - basePool);
            
            var actualSubsidy = 0;
            if (subsidyNeeded > 0 && mainRoom) {
                actualSubsidy = Math.min(subsidyNeeded, mainRoom.bankReserve || 0);
                mainRoom.bankReserve -= actualSubsidy;
            }

            var finalDistributePool = basePool + actualSubsidy;
            var totalActuallyPaid = 0;

            resultBody += "ğŸ›ï¸ êµ­ê³  ìˆ˜ìˆ˜ë£Œ(10%): " + fp(tax) + "P ì…ê³ \n";
            if (actualSubsidy > 0) resultBody += "ğŸ›¡ï¸ 3ë°° ë°°ë‹¹ ë³´ì „ ì§€ì›: " + fp(actualSubsidy) + "P\n";
            else if (racingData.carryOver > 0) resultBody += "ğŸ’° ì­íŒŸ ì´ì›”ê¸ˆ í¬í•¨: " + fp(racingData.carryOver) + "P ë°©ì¶œ!\n";
            
            resultBody += "\n[ğŸ–ï¸ ì£¼ìš” ë‹¹ì²¨ì]";

            winnerUids.forEach(function(uId){
                var b = racingData.bets[uId]; var u = null;
                for(var r in data.rooms){ if(data.rooms[r].users[uId]){ u = data.rooms[r].users[uId]; break; } }
                if(u){
                    var share = b.amount / winPool;
                    var prize = Math.floor(share * finalDistributePool);
                    var maxLimit = b.amount * (rConf.MAX_PAYOUT_MULT || 10);
                    if (prize > maxLimit) prize = maxLimit;

                    var res = processRepayment(u, prize, uId, ctx.targetRoom);
                    u.point += res.actualGain; 
                    totalActuallyPaid += prize;

                    var tag = (prize === maxLimit) ? " âš ï¸ìµœëŒ€ë°°ë‹¹" : (actualSubsidy > 0 ? " âœ¨3ë°°ë³´ì „" : "");
                    resultBody += "\nâ€¢ " + b.name + " (+" + fp(res.actualGain) + "P)" + tag;
                }
            });
            
            racingData.carryOver = Math.max(0, finalDistributePool - totalActuallyPaid);
            if (racingData.carryOver > 10) {
                resultBody += "\n\nğŸ’° ìƒí•œ ì´ˆê³¼ë¶„ " + fp(racingData.carryOver) + "PëŠ”\në‹¤ìŒ íšŒì°¨ ì­íŒŸìœ¼ë¡œ ì´ì›”ë˜ì—ˆìŠµë‹ˆë‹¤!";
            }
        } else {
            /**
             * [Gemini ìš”ì²­ ì‚¬í•­: ì´ì›”ê¸ˆ ì „ì•¡ ë³´ì „ ë¡œì§ ì ìš©]
             * ë‹¹ì²¨ì ì—†ì„ ì‹œ:
             * 1. í˜„ì¬ íŒëˆ(racingData.totalPool - tax)ì—ì„œë§Œ 30% êµ­ê³  íšŒìˆ˜
             * 2. ê¸°ì¡´ ì´ì›”ê¸ˆ(carryOver)ì€ 100% ë³´ì¡´í•˜ì—¬ í•©ì‚° ì´ì›”
             */
            var currentRoundNetPool = racingData.totalPool - tax; // ë‹¹ê¸° ìˆœìˆ˜ íŒëˆ
            var toBank = Math.floor(currentRoundNetPool * rConf.WINLESS_BANK_RATE); // ë‹¹ê¸° íŒëˆì˜ 30%ë§Œ íšŒìˆ˜
            
            // (ë‹¹ê¸° íŒëˆ 70%) + (ê¸°ì¡´ ì´ì›”ê¸ˆ 100%) = í•©ê³„ ì´ì›”
            racingData.carryOver = (currentRoundNetPool - toBank) + racingData.carryOver;
            
            if(mainRoom) mainRoom.bankReserve += toBank;
            
            resultBody += "ğŸ’€ ë‹¹ì²¨ ìœ ì € ì—†ìŒ\nğŸ’° ì´ì›”ê¸ˆ ë³´ì „ ì™„ë£Œ: " + fp(racingData.carryOver) + "P\nğŸ›ï¸ ê¸ˆê¸° íŒëˆ êµ­ê³  ê·€ì†(30%): " + fp(toBank) + "P";
        }

        var isClosing = (currentHour === 0);
        if (isClosing) {
            racingData.isOperating = false;
            resultBody += "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’¤ ê¸ˆì¼ ê²½ë§ˆ ìš´ì˜ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\në‹¤ìŒ ê²½ê¸°ëŠ” ë‚´ì¼ ì˜¤ì „ 09:00ì— ì‹œì‘ë©ë‹ˆë‹¤.";
        } else {
            resultBody += "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâœ¨ [ì œ " + (racingData.round + 1) + "íšŒ ê²½ê¸° ì‹œì‘] âœ¨\nì§€ê¸ˆë¶€í„° ë‹¤ìŒ ê²½ê¸° ë°°íŒ…ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.";
        }

        Api.replyRoom(ctx.targetRoom, resultHeader + resultBody);

        racingData.round++; racingData.bets = {}; racingData.totalPool = 0;
        racingData.isDeadlineNotified = false; racingData.isResultProcessed = false;
        var conds = [{l:"ğŸš€ ìµœìƒ",w:1.5},{l:"â˜€ï¸ ì–‘í˜¸",w:1.2},{l:"â˜ï¸ ë³´í†µ",w:1.0},{l:"ğŸ’§ ë¶€ì§„",w:0.7}];
        racingData.horses.forEach(function(h){ var c=conds[Math.floor(Math.random()*conds.length)]; h.icon=c.l; h.weight=c.w; });
        ctx.isUpdated = true;
    }

    /* 4. í™€ì§ í”¼ë²„íƒ€ì„ ë° ê²°íˆ¬ ì²´í¬ (ê¸°ì¡´ ë¡œì§ ìœ ì§€) */
    if (!data.feverData) data.feverData = { active: false, endTime: 0, scheduled: [] };
    var timeKey = (currentHour < 10 ? "0"+currentHour : currentHour) + ":" + (currentMin < 10 ? "0"+currentMin : currentMin);
    if (data.feverData.scheduled.indexOf(timeKey) !== -1 && !data.feverData.active) {
        data.feverData.active = true; data.feverData.endTime = nowTs + (5 * 60 * 1000);
        data.feverData.scheduled.splice(data.feverData.scheduled.indexOf(timeKey), 1);
        try { Api.replyRoom(ctx.targetRoom, "ğŸ”¥ í™€ì§ í”¼ë²„íƒ€ì„ ì‹œì‘\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nì§€ê¸ˆë¶€í„° 5ë¶„ê°„ í™€ì§ ìŠ¹ë¥ ì´ ìƒìŠ¹í•©ë‹ˆë‹¤!"); } catch(e){}
        ctx.isUpdated = true;
    }
    if (data.feverData.active && data.feverData.endTime > 0 && nowTs > Number(data.feverData.endTime)) {
        data.feverData.active = false; data.feverData.endTime = 0;
        try { Api.replyRoom(ctx.targetRoom, "â„ï¸ í™€ì§ í”¼ë²„íƒ€ì„ ì¢…ë£Œ\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nì´ë²¤íŠ¸ ì‹œê°„ì´ ë§ˆê°ë˜ì–´ ìŠ¹ë¥ ì´ ì •ìƒí™”ë˜ì—ˆìŠµë‹ˆë‹¤."); } catch(e){}
        ctx.isUpdated = true;
    }

    for (var dKey in duelData) {
        var d = duelData[dKey];
        if (nowTs > d.expire) {
            var room = data.rooms[d.room];
            if (room && room.users[d.challengerUid]) {
                room.users[d.challengerUid].point += Number(d.point);
                try { Api.replyRoom(d.room, "â° ê²°íˆ¬ ë§Œë£Œ\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nìƒëŒ€ë°© ì‘ë‹µ ì—†ìŒìœ¼ë¡œ " + fp(d.point) + "P í™˜ê¸‰ ì™„ë£Œ\në‚´ ì”ì•¡: " + fp(room.users[d.challengerUid].point) + "P"); } catch(err) {}
            }
            delete duelData[dKey]; ctx.isUpdated = true; 
        }
    }
}

// ì—”ì§„ ê°€ë™
runScheduler();

//==========ì„¹í„°17==========

/**
 * ì„¹í„° 17 ë¡œì§ í•¨ìˆ˜: ì£¼ì‹ ì¥ ë§ˆê°, ì¼ì¼ ë°ì´í„° ì´ˆê¸°í™” ë° ì‹œì¦Œ ë¦¬ì…‹ ê´€ë¦¬
 * ë°˜ì˜ ì‚¬í•­: ë°©ë³„ ë…ë¦½ ì—”ì§„(Features) ì—°ë™ ë° ë£¨í”„ ê¸°ë°˜ ë°ì´í„° ì •ê·œí™” ì ìš©
 */
function _runSector17Logic(data, ctx) {
    var currentHour = ctx.now.getHours();
    var currentMin = ctx.now.getMinutes();

    if (currentHour === 0 && currentMin === 0) {
        /* [1] ì£¼ì‹ ì‹œì¥ ì¢…ë£Œ ì²˜ë¦¬ (ì „ì—­ ê³µì§€) */
        if (data.lastStockClose !== ctx.today) {
            data.lastStockClose = ctx.today;
            try { 
                // ì£¼ì‹ ì‹œì¥ì€ ì „ì—­ ì‹œìŠ¤í…œì´ë¯€ë¡œ ë©”ì¸ ìš´ì˜ ë°©ì— ê³µì§€
                Api.replyRoom(ctx.targetRoom, formatAdmin("ğŸ“‰ ì¥ ë§ˆê° ì•Œë¦¼", "ê¸ˆì¼ ì£¼ì‹ ì‹œì¥ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")); 
            } catch(e) {}
            ctx.isUpdated = true;
        }

        /* [2] ì¼ì¼ ë°ì´í„° ì´ˆê¸°í™” (ë°©ë³„ ë…ë¦½ ê²©ë¦¬ ë¡œì§) */
        if (data.lastDailyReset !== ctx.today) {
            data.lastDailyReset = ctx.today; 
            
            // A. ì „ì—­ í”¼ë²„íƒ€ì„ ìŠ¤ì¼€ì¤„ ìƒì„± (ëª¨ë“  ë°© ê³µí†µ ì°¸ì¡°)
            data.feverData.scheduled = [];
            while(data.feverData.scheduled.length < 5) {
                var h = Math.floor(Math.random() * 15) + 9; 
                var m = Math.floor(Math.random() * 60);
                var tStr = (h < 10 ? "0"+h : h) + ":" + (m < 10 ? "0"+m : m);
                if (data.feverData.scheduled.indexOf(tStr) === -1) data.feverData.scheduled.push(tStr);
            }
            data.feverData.active = false; 

            // B. í”¼ë²„íƒ€ì„ ìš”ì¼ë³„ ê³µì§€ ì„¤ì • (ì¼ìš”ì¼/ì›”ìš”ì¼)
            var dayOfWeek = ctx.now.getDay(); 
            if (dayOfWeek === 0) {
                try { Api.replyRoom(ctx.targetRoom, formatAdmin("ğŸ”¥ í”¼ë²„íƒ€ì„ ì‹œì‘", "ì¼ìš”ì¼ í•œì • ì´ë²¤íŠ¸!\nìŠ¹ê¸‰ í™•ë¥  +5% ìƒìŠ¹ì´ ì ìš©ë©ë‹ˆë‹¤.")); } catch(e){}
            } else if (dayOfWeek === 1) {
                try { Api.replyRoom(ctx.targetRoom, formatAdmin("â„ï¸ í”¼ë²„íƒ€ì„ ì¢…ë£Œ", "ì´ë²¤íŠ¸ê°€ ì¢…ë£Œë˜ì–´\nìŠ¹ê¸‰ í™•ë¥ ì´ ì •ìƒí™”ë˜ì—ˆìŠµë‹ˆë‹¤.")); } catch(e){}
            }

            // C. [í•µì‹¬] ëª¨ë“  ë°©ì„ ìˆœíšŒí•˜ë©° ë…ë¦½ ë°ì´í„° ë° ìœ ì € ì •ë³´ ì´ˆê¸°í™”
            for (var rName in data.rooms) {
                var roomObj = data.rooms[rName];
                if (!roomObj.features) continue;

                // í•´ë‹¹ ë°©ì˜ ë¡œë˜ ë°ì´í„° ì´ˆê¸°í™” (Reference Error ë°©ì§€)
                if (roomObj.features.lotto) {
                    roomObj.features.lotto.entries = {}; 
                    roomObj.features.lotto.dailyPool = 0;
                }

                // í•´ë‹¹ ë°©ì˜ ëª¨ë“  ìœ ì € ìŠ¤íƒ¯ ì´ˆê¸°í™” ë° ì´ì ê³„ì‚°
                for (var id in roomObj.users) {
                    var u = roomObj.users[id];
                    u.dailyLoanCount = 0; 
                    u.dailyGambleCount = 0; 
                    u.dailyPromotionAttempts = 1; 
                    u.dailyStimulusCount = 0; 
                    u.dailyCreditRestoreCount = 0; 
                    
                    // ì€í–‰ ì˜ˆê¸ˆ ì´ì ì§€ê¸‰ (ë³µë¦¬ 2%)
                    if (Number(u.bank) > 0) {
                        u.bank = Number(u.bank) + Math.floor(Number(u.bank) * 0.02);
                    }
                    
                    // ëŒ€ì¶œ ì±„ë¬´ ì´ì ê°€ì‚° (ì¼ì¼ 5%) ë° ì—°ì²´ ê´€ë¦¬
                    if (u.loan && Number(u.loan.debt) > 0) { 
                        u.creditScore = Math.max(0, Number(u.creditScore) - 5); 
                        var dailyInterest = Math.floor(Number(u.loan.debt) * 0.05);
                        u.loan.debt = Number(u.loan.debt) + dailyInterest;
                        if (typeof checkAndHandleDefaulter === 'function') checkAndHandleDefaulter(u, rName); 
                    }
                }

                // D. ê° ë°©ì— ê°œë³„ ë¡œë˜ íŒë§¤ ê³µì§€ (ì¤‘ë³µ ë°œì†¡ ë°©ì§€ ë° ê²©ë¦¬ ê³µì§€)
                try { 
                    Api.replyRoom(rName, formatAdmin("ğŸ« ë¡œë˜ íŒë§¤ ì‹œì‘", "ìƒˆë¡œìš´ ë¡œë˜ íŒë§¤ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.\në§¤ì¼ ë°¤ 22ì‹œ ì¶”ì²¨!")); 
                } catch(e) {}
            }
            ctx.isUpdated = true;
        }

        /* [3] ì‹œì¦Œ ë¦¬ì…‹ ì²˜ë¦¬ (ë§¤ì›” 1ì¼) */
        if (ctx.now.getDate() === 1 && data.lastSeasonReset !== ctx.season) {
            data.lastSeasonReset = ctx.season;
            for (var r in data.rooms) { 
                for (var id in data.rooms[r].users) { 
                    var u = data.rooms[r].users[id];
                    u.tier = 0;
                    u.gameAuthCount = 0; 
                    u.purchasedAuthCount = 0; 
                } 
            }
            try { 
                Api.replyRoom(ctx.targetRoom, formatAdmin("ğŸ† ì‹œì¦Œ ë¦¬ì…‹", "ìƒˆë¡œìš´ ì‹œì¦Œì´ ì‹œì‘ë˜ì–´ ëª¨ë“  í‹°ì–´ ë° ê²Œì„ ì¸ì¦ ê¸°ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.")); 
            } catch(e) {}
            ctx.isUpdated = true;
        }
    }
}

//==========ì„¹í„°18==========

/**
 * ì„¹í„° 18 ë¡œì§ í•¨ìˆ˜: ë¡œë˜ íŒë§¤ ë§ˆê° ì•Œë¦¼ ë° ë‹¹ì²¨ ì¶”ì²¨ í”„ë¡œì„¸ìŠ¤
 * ìˆ˜ì • ì‚¬í•­: ë°©ë³„ ê²©ë¦¬ëœ ë¡œë˜ ë°ì´í„°(Features) í†µí•© ì¶”ì²¨ ë° ìƒê¸ˆ ì§€ê¸‰
 */
function _runSector18Logic(data, ctx) {
    var currentHour = ctx.now.getHours();
    var currentMin = ctx.now.getMinutes();
    
    // ì¤‘ì•™ì€í–‰ ì¬ì› ì°¸ì¡° (ë©”ì¸ ìš´ì˜ ë°© ê¸°ì¤€)
    var mainRoomData = data.rooms[ctx.targetRoom]; 

    /* 7. ë¡œë˜ íŒë§¤ ë§ˆê° ì•Œë¦¼ (21:00) */
    if (currentHour === 21 && currentMin === 0) {
        if (!data.lotto_flags) data.lotto_flags = {};
        if (data.lotto_flags.lastCloseNotify !== ctx.today) {
            data.lotto_flags.lastCloseNotify = ctx.today;

            // [í•µì‹¬] ëª¨ë“  ë°©ì˜ íŒë§¤ê¸ˆ(dailyPool)ì„ í•©ì‚°í•˜ì—¬ ì´ì•¡ ê³„ì‚°
            var totalDailyPool = 0;
            for (var r in data.rooms) {
                if (data.rooms[r].features && data.rooms[r].features.lotto) {
                    totalDailyPool += Number(data.rooms[r].features.lotto.dailyPool || 0);
                }
            }
            var totalJackpot = Number(data.lotto_jackpot_pool || 0); 
            var displayPool = totalDailyPool + totalJackpot;

            // ëª¨ë“  ë°©ì— ë§ˆê° ì•Œë¦¼ ì „ì†¡ (ê²©ë¦¬ ë°œì†¡)
            for (var i = 0; i < ALLOWED_ROOMS.length; i++) {
                try { 
                    Api.replyRoom(ALLOWED_ROOMS[i], formatAdmin("ğŸ ë¡œë˜ íŒë§¤ ë§ˆê°", "ì ì‹œ í›„ 22ì‹œ ì¶”ì²¨!\ní˜„ì¬ ëˆ„ì  ìƒê¸ˆ: " + fp(displayPool) + "P")); 
                } catch(e) {}
            }
            ctx.isUpdated = true;
        }
    }

    /* 8. ë¡œë˜ ë‹¹ì²¨ ë²ˆí˜¸ ì¶”ì²¨ ë° ìƒê¸ˆ ì§€ê¸‰ (22:00) */
    if (currentHour === 22 && currentMin === 0) {
        if (!data.lotto_flags) data.lotto_flags = {};
        if (data.lotto_flags.lastDrawNotify !== ctx.today) {
            data.lotto_flags.lastDrawNotify = ctx.today;
            
            // ë‹¹ì²¨ ë²ˆí˜¸ ìƒì„±
            var win = []; 
            while(win.length < 3) { 
                var n = Math.floor(Math.random() * 15) + 1; 
                if(win.indexOf(n) === -1) win.push(n); 
            }
            win.sort(function(a,b){return a-b}); 
            data.last_win_nums = win; 

            var totalDailyPool = 0;
            var w1 = [], w2 = [], w3 = [];

            // [í•µì‹¬] ëª¨ë“  ë°©ì„ ëŒë©° ë…ë¦½ëœ ì‘ëª¨ ë‚´ì—­(entries) ìˆ˜ì§‘ ë° ë‹¹ì²¨ì ë¶„ë¥˜
            for (var rName in data.rooms) {
                var roomObj = data.rooms[rName];
                if (!roomObj.features || !roomObj.features.lotto) continue;
                
                var rLotto = roomObj.features.lotto;
                totalDailyPool += Number(rLotto.dailyPool || 0);

                for (var uid in rLotto.entries) {
                    var userFound = roomObj.users[uid];
                    if (!userFound) continue;

                    rLotto.entries[uid].forEach(function(tk) {
                        var match = 0; 
                        tk.forEach(function(n){ if(win.indexOf(n) !== -1) match++; });
                        if(match === 3) w1.push({u: userFound, id: uid, rm: rName}); 
                        else if(match === 2) w2.push({u: userFound, id: uid, rm: rName}); 
                        else if(match === 1) w3.push({u: userFound, id: uid, rm: rName});
                    });
                }
                // ì •ì‚° í›„ í•´ë‹¹ ë°©ì˜ íŒëˆ ì´ˆê¸°í™”
                rLotto.dailyPool = 0;
            }

            var baseJackpot = Number(data.lotto_jackpot_pool || 0);
            var totalPrizePool = totalDailyPool + baseJackpot;
            var totalPayout = 0;
            var resM = "ë‹¹ì²¨ ë²ˆí˜¸: [" + win.join(", ") + "]\n";

            // 1ë“± ì§€ê¸‰ (ì „ì•¡ në¹µ)
            if(w1.length > 0) { 
                var p1 = Math.floor(totalPrizePool / w1.length); 
                w1.forEach(function(obj){ 
                    var res = processRepayment(obj.u, p1, obj.id, obj.rm);
                    var preP = Number(obj.u.point);
                    obj.u.point = preP + Number(res.actualGain); 
                    verifyPointTransaction(obj.u, preP, Number(res.actualGain), "ë¡œë˜ 1ë“± ë‹¹ì²¨", obj.rm, 0);
                    totalPayout += p1;
                }); 
                resM += "ğŸ¥‡ 1ë“±: " + w1.length + "ëª… (ê° " + fp(p1) + "P)\n"; 
                data.lotto_jackpot_pool = 0; 
            } else { 
                resM += "ğŸ¥‡ 1ë“± ì—†ìŒ (ì „ì•¡ ì´ì›”)\n"; 
                data.lotto_jackpot_pool = totalPrizePool; 
            }

            // 2ë“±/3ë“± ì§€ê¸‰ (ê³ ì • ìƒê¸ˆ)
            w2.forEach(function(obj){ 
                var res = processRepayment(obj.u, 5000, obj.id, obj.rm);
                var preP = Number(obj.u.point);
                obj.u.point = preP + Number(res.actualGain); 
                verifyPointTransaction(obj.u, preP, Number(res.actualGain), "ë¡œë˜ 2ë“± ë‹¹ì²¨", obj.rm, 0);
                totalPayout += 5000;
            }); 
            if(w2.length > 0) resM += "ğŸ¥ˆ 2ë“±: " + w2.length + "ëª… (ê° 5,000P)\n";

            w3.forEach(function(obj){ 
                var res = processRepayment(obj.u, 1000, obj.id, obj.rm);
                var preP = Number(obj.u.point);
                obj.u.point = preP + Number(res.actualGain); 
                verifyPointTransaction(obj.u, preP, Number(res.actualGain), "ë¡œë˜ 3ë“± ë‹¹ì²¨", obj.rm, 0);
                totalPayout += 1000;
            }); 
            if(w3.length > 0) resM += "ğŸ¥‰ 3ë“±: " + w3.length + "ëª… (ê° 1,000P)";

            // êµ­ê³ (ì¤‘ì•™ì€í–‰) ì¬ì› ì •ì‚°
            if (mainRoomData && totalPayout > 0) {
                if (mainRoomData.bankReserve === undefined) mainRoomData.bankReserve = 10000;
                mainRoomData.bankReserve -= totalPayout;
                resM += "\n\nğŸ¦ ìƒê¸ˆ ì´ì•¡ " + fp(totalPayout) + "P êµ­ê³  ì§€ê¸‰ ì™„ë£Œ";
            }

            // ëª¨ë“  ë°©ì— ê²°ê³¼ ë°œí‘œ
            for (var j = 0; j < ALLOWED_ROOMS.length; j++) {
                try {
                    java.lang.Thread.sleep(200); 
                    Api.replyRoom(ALLOWED_ROOMS[j], formatAdmin("ğŸ° ë¡œë˜ ì¶”ì²¨ ê²°ê³¼", resM));
                } catch(e) {}
            }
            ctx.isUpdated = true;
        }
    }
}

//==========ì„¹í„°19==========

/* ë©”ì¸ ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆ í•¨ìˆ˜ */
action = function(room, msg, sender, isGroupChat, replier, imageDB) {
    Executor.execute(new java.lang.Runnable({
        run: function() {
            try {
                var roomName = room ? room.trim() : "";
                var cleanSender = sender ? String(sender).trim() : ""; 
                
                if (ALLOWED_ROOMS.indexOf(roomName) === -1 || cleanSender === "ì˜¤í”ˆì±„íŒ…ë´‡") return;

                var data = getDatabase(); 
                if (!data) return;

                if (!data.rooms[roomName]) data.rooms[roomName] = { users: {} };
                var roomData = data.rooms[roomName];
                
                if (!roomData.features) {
                    if (typeof ROOM_FEATURE_TEMPLATE === 'function') {
                        roomData.features = ROOM_FEATURE_TEMPLATE();
                    }
                }
                
                var rFeatures = roomData.features;

                /* [ë§ˆì´ê·¸ë ˆì´ì…˜] ê¸°ì¡´ ì „ì—­ ë°ì´í„°ë¥¼ í˜„ì¬ ë°©ìœ¼ë¡œ ì´ì‚¬ (ìµœì´ˆ 1íšŒ) */
                if (data.lotto && !rFeatures.lotto.round) {
                    rFeatures.lotto = data.lotto;
                }

                // [ë°ì´í„° ë¶„ë¦¬] ì°¸ì¡°(Reference) ì—°ê²° - ì „ì—­ ë³€ìˆ˜ ì˜¤ì—¼ ë°©ì§€
                racingData = rFeatures.racing;
                lotto = rFeatures.lotto;
                marketOpenPrice = rFeatures.marketOpenPrice;
                feverData = rFeatures.feverData;
                sprinkleData = rFeatures.sprinkleData;

                /**
                 * [Gemini ìš”ì²­ ì‚¬í•­] ìƒíƒœ ê´€ë¦¬ ì—”ì§„ ë…ë¦½í™” (Bug Fix)
                 * ì„¤ëª…: ëª¨ë“  ìƒíƒœë¥¼ rFeatures.states í•˜ë‚˜ì— ë„£ìœ¼ë©´ 'ë³€ìˆ˜ ì¶©ëŒ'ì´ ë°œìƒí•˜ì—¬ ìˆ«ìê°€ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                 * ì„¹í„° 1ì˜ TEMPLATE êµ¬ì¡°ì— ë§ê²Œ ê°ê°ì˜ ë…ë¦½ëœ ì£¼ë¨¸ë‹ˆë¡œ ì •í™•íˆ ë§¤í•‘í•©ë‹ˆë‹¤.
                 */
                menuWaitState = rFeatures.states.menuWait; 
                bankProcessState = rFeatures.states.bankProcess;
                selectWaitState = rFeatures.states.selectWait;
                lottoPurchaseState = rFeatures.states.lottoPurchase;
                activeThefts = rFeatures.states.activeThefts;
                duelData = rFeatures.states.duelData;
                miningState = rFeatures.states.mining;
                loanRegisterState = rFeatures.states.loanRegister;
                loanContractWaitState = rFeatures.states.loanContractWait;

                /* [ì‹ ê·œ] ë„ë°° ë°©ì§€ ë° íƒ€ì„ì•„ì›ƒ ì²´í¬ ì—”ì§„ */
                var user = null;
                var currentImgHash = null;
                try { if (imageDB) currentImgHash = imageDB.getProfileHash(); } catch(e) {}

                // ìœ ì € ê°ì²´ ì„ ì œ íƒìƒ‰ (ë„ë°° ì²´í¬ìš©)
                for (var id in roomData.users) {
                    var u = roomData.users[id];
                    if ((currentImgHash && u.imageHash === currentImgHash) || u.name === cleanSender) {
                        user = u;
                        break;
                    }
                }

                if (user) {
                    var now = Date.now();
                    var conf = SYSTEM_CONFIG.SPAM;

                    // 1. ì´ë¯¸ íƒ€ì„ì•„ì›ƒ ìƒíƒœì¸ ê²½ìš° ì¦‰ì‹œ ì¢…ë£Œ (ë¬´ì‘ë‹µ)
                    if (user.timeoutEndTime && now < user.timeoutEndTime) {
                        return;
                    }

                    // 2. ì±„íŒ… ë¡œê·¸ ê¸°ë¡ ë° ìŠ¬ë¼ì´ë”© ìœˆë„ìš° í•„í„°ë§
                    if (!user.chatLog) user.chatLog = [];
                    user.chatLog.push(now);
                    user.chatLog = user.chatLog.filter(function(time) {
                        return now - time < conf.LIMIT_WINDOW;
                    });

                    // 3. ë„ë°° ê¸°ì¤€ ì´ˆê³¼ ì‹œ íƒ€ì„ì•„ì›ƒ ë¶€ì—¬
                    if (user.chatLog.length > conf.LIMIT_COUNT) {
                        user.timeoutEndTime = now + conf.TIMEOUT_MS;
                        user.chatLog = []; // ë¡œê·¸ ì´ˆê¸°í™”
                        
                        var expireTime = new Date(user.timeoutEndTime).toLocaleTimeString();
                        var timeoutMsg = "ğŸ”‡ [ë„ë°° ê°ì§€: ì´ìš© ì œí•œ]\n" +
                                         "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                                         "ëŒ€ìƒ: " + getDisplayName(user) + "ë‹˜\n" +
                                         "ì‚¬ìœ : ë‹¨ì‹œê°„ ê³¼ë„í•œ ì±„íŒ… ë°œì†¡\n" +
                                         "ì œí•œ: " + Math.floor(conf.TIMEOUT_MS / 60000) + "ë¶„ê°„ ë´‡ ì´ìš© ë¶ˆê°€\n" +
                                         "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                                         "ğŸ’¡ í•´ì œ ì‹œê°: " + expireTime;
                        
                        replier.reply(timeoutMsg);
                        safeSaveData(data);
                        return;
                    }
                }

                /* [í•µì‹¬] ë²„ê·¸ ì œë³´ ë° ì§„ì‹¤ íŒë³„ ì‹œìŠ¤í…œ */
                if (msg.startsWith("/ë²„ê·¸ì œë³´ ")) {
                    var content = msg.substring(6).trim();
                    if (content.length < 2) return replier.reply("ë‚´ìš©ì„ ìƒì„¸íˆ ì ì–´ì£¼ì„¸ìš”.");
                    
                    if(user) { 
                        var lastAct = user.lastAction;
                        var timeDiff = lastAct ? (Date.now() - lastAct.time) : 99999999;
                        var diagnosis = "";
                        var isConfirmed = false;

                        if (lastAct && timeDiff < 300000) { 
                            if (lastAct.status === "PENDING") { diagnosis = "âš ï¸ ë¡œì§ ì¤‘ë‹¨ë¨(ì‘ë‹µì—†ìŒ)"; isConfirmed = true; }
                            else if (lastAct.status === "CRASH") { diagnosis = "ğŸš« ì‹œìŠ¤í…œ ì—ëŸ¬(Crash)"; isConfirmed = true; }
                            else if (lastAct.status === "FAIL") { diagnosis = "ğŸ“‰ ë°ì´í„° ë¶ˆì¼ì¹˜(ê³„ì‚°ì˜¤ë¥˜)"; isConfirmed = true; }
                            else if (lastAct.status === "SUCCESS") { 
                                replier.reply("ğŸ¤– [ì‹œìŠ¤í…œ ì§„ë‹¨: ì •ìƒ]\nì§ì „ ì‘ì—…(" + lastAct.cmd + ")ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nì˜¤ë¥˜ê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                                return;
                            }
                        } else { 
                            diagnosis = "â“ ì‹¤í–‰ ê¸°ë¡ ì—†ìŒ(ë¡œì§ ë¯¸ì§„ì…/ì˜¤íƒ€)"; isConfirmed = true; 
                        }

                        var logTime = new Date().toLocaleString();
                        var logTxt = "[" + logTime + "] " + cleanSender + ": " + content + "\n    ã„´ íŒë…: " + diagnosis + "\n";
                        FileStream.append(BUG_LOG_PATH, logTxt);
                        
                        if(isConfirmed) replier.reply("âœ… [ì œë³´ ì ‘ìˆ˜]\níŒë… ê²°ê³¼: " + diagnosis + "\në¶„ì„ ë‚´ìš©ì´ ë²„ê·¸ ë¦¬ìŠ¤íŠ¸ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        else replier.reply("ğŸ“ ì œë³´ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    }
                    return;
                }

                /* ê´€ë¦¬ììš© ì‹œìŠ¤í…œ ì œì–´ */
                if (isAdmin(sender, data)) {
                    if (msg === "/ê°•ì œì¬ê°€ë™") {
                        if (lock.isLocked()) lock.unlock(); 
                        globalData = getDatabase(); 
                        if (globalData) { globalData.botActive = true; safeSaveData(globalData); }
                        replier.reply(formatAdmin("ğŸ”„ ì‹œìŠ¤í…œ ì¬ê°€ë™", "ê²°ê³¼: ë½ í•´ì œ ë° ë©”ëª¨ë¦¬ ë™ê¸°í™” ì™„ë£Œ"));
                        return;
                    }
                }

//==========ì„¹í„°20-1==========

if (!data) return;
var roomData = data.rooms[roomName] || { users: {} };
data.rooms[roomName] = roomData;

/* [ìµœì í™”] ì „ì—­ UID ìºì‹œ ê°ì²´ ì²´í¬ */
if (typeof uidCache === 'undefined') var uidCache = {};

/* ìœ ì € ì‹ë³„ ë¡œì§ (ìºì‹œ ìš°ì„  ê²€ìƒ‰ ë°©ì‹ ì ìš©) */
var currentImgHash = null;
try { if (imageDB) currentImgHash = imageDB.getProfileHash(); } catch(e) { currentImgHash = null; }

var targetUid = null;
var cacheKey = roomName + "_" + cleanSender + (currentImgHash ? "_" + currentImgHash : "");

// 1. ìºì‹œì—ì„œ ë¨¼ì € ì°¾ê¸°
if (uidCache[cacheKey] && roomData.users[uidCache[cacheKey]]) {
    targetUid = uidCache[cacheKey];
} else {
    // 2. ë£¨í”„ íƒìƒ‰ (ìµœì´ˆ 1íšŒ ì‹¤í–‰)
    for (var id in roomData.users) {
        var u = roomData.users[id];
        if (!u) continue;
        
        if (currentImgHash && u.imageHash === currentImgHash) {
            targetUid = id;
            if (u.name !== cleanSender) {
                if (!data.nickHistory[id]) data.nickHistory[id] = [];
                data.nickHistory[id].push({ old: u.name, date: getSimpleDate() });
                u.name = cleanSender;
            }
            break;
        }
        
        if (u.name === cleanSender) { 
            targetUid = id; 
            if (currentImgHash) u.imageHash = currentImgHash; 
            break; 
        }
    }
    if (targetUid) uidCache[cacheKey] = targetUid;
}

/* ì‹ ê·œ ìœ ì € ë“±ë¡ ë° í™˜ì˜ ë©”ì‹œì§€ (ë„ë°° ë°©ì§€ ì‹œìŠ¤í…œ ë³€ìˆ˜ í†µí•© ë° ì¹­í˜¸ í†µê³„ í•„ë“œ ì¶”ê°€) */
if (!targetUid) {
    targetUid = generateUUID();
    roomData.users[targetUid] = { 
        name: cleanSender, point: 1000, tier: 0, creditScore: 600, totalAttendance: 0, 
        loan: { debt: 0, items: [] }, lastDate: "", icon: "", title: "", 
        inventory: [], tierGuard: 0,
        imageHash: currentImgHash, chatCount: 0, dailyGambleCount: 0,
        bank: 0, jailReleaseTime: 0, stockHoldings: {}, stockAvg: {}, 
        dailyPromotionAttempts: 1, purchasedPromotionAttempts: 0, lastBonusTriggeredCount: -1,
        /* [ì‹ ê·œ] ê²Œì„ íŒìˆ˜ ì¸ì¦ ì‹œìŠ¤í…œ ë³€ìˆ˜ */
        gameAuthCount: 0,      // í˜„ì¬ ì¸ì¦ ì™„ë£Œ íšŸìˆ˜
        purchasedAuthCount: 0, // ì´ë²ˆ ì‹œì¦Œ ì¸ì¦ê¶Œ êµ¬ë§¤ íšŸìˆ˜
        /* [ì‹ ê·œ] ë„ë°° ë°©ì§€ ë° íƒ€ì„ì•„ì›ƒ ë°ì´í„° */
        chatLog: [],           // ì±„íŒ… ë°œì†¡ ì‹œê° ê¸°ë¡ ë°°ì—´
        timeoutEndTime: 0,     // íƒ€ì„ì•„ì›ƒ ì¢…ë£Œ ì‹œê° (0ì´ë©´ ì •ìƒ ìƒíƒœ)
        /* [ì‹ ê·œ] ìœ ë¬¼ ì‹œìŠ¤í…œ ë°ì´í„° ì´ˆê¸°í™” */
        artifactPieces: 0,     // ë³´ìœ  ì¤‘ì¸ ìœ ë¬¼ ì¡°ê° ìˆ˜
        /* [ì‹ ê·œ] ì¹­í˜¸ ì‹œìŠ¤í…œìš© ëˆ„ì  í†µê³„ ë°ì´í„° */
        totalGambleCount: 0,   // í™€ì§ ì´ íŒìˆ˜
        totalGambleWins: 0,    // í™€ì§ ì´ ìŠ¹ë¦¬ìˆ˜
        totalTheftSuccess: 0,  // ë„ë‘‘ì§ˆ ì´ ì„±ê³µ íšŸìˆ˜
        totalInvestAmount: 0,  // ì£¼ì‹ ì´ ëˆ„ì  ë§¤ìˆ˜ì•¡
        totalMiningTime: 0,    // ê´‘ì‚° ì´ ëˆ„ì  ì±„êµ´ ì‹œê°„(ë¶„)
        totalDonation: 0,      // ëˆ„ì  ê¸°ë¶€ ê¸ˆì•¡ ê¸°ë¡ í•„ë“œ
        /* [ê°œí¸] ëœë¤ë°•ìŠ¤ ì¡°ê° ë° ì´ìš©ê¶Œ ì‹œìŠ¤í…œ */
        boxFragments: 0,       // ë¶„í•´ ì‹œ íšë“í•˜ëŠ” ì¡°ê°
        boxTickets: 0,         // ì¡°ê° 5ê°œê°€ ëª¨ì—¬ ë³€í™˜ëœ ëœë¤ë°•ìŠ¤ ì´ìš©ê¶Œ
        collectedIcons: [],     // [ì‹ ê·œ] í•œ ë²ˆì´ë¼ë„ ë½‘ì•˜ë˜ ì•„ì´ì½˜ ê¸°ë¡ (ë¶„í•´í•´ë„ ìœ ì§€ë¨)
        dailyCreditRestoreCount: 0, // ì‹ ìš© íšŒë³µì œ ì¼ì¼ ì‚¬ìš©ëŸ‰
        /* [ì‹ ê·œ: Gemini ìš”ì²­ ì‚¬í•­] ê²½ê³ ì‚­ì œê¶Œ í‰ìƒ êµ¬ë§¤ ê¸°ë¡ */
        boughtWarningRemoval: false 
    };
    
    uidCache[cacheKey] = targetUid;
    
    var welcomeMsg = "ğŸŠ [" + cleanSender + "]ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                     "ğŸ ì…ì¥ ì¶•í•˜ ë³´ë„ˆìŠ¤: " + fP(3000) + "P ì§€ê¸‰!\n" + 
                     "ğŸ•¹ï¸ ë¯¸ë‹ˆê²Œì„ ë° ì¶œì„ì²´í¬ ê¸°ëŠ¥ ì œê³µ\n" +
                     "ğŸ’³ ì‹ ìš© ë“±ê¸‰: 4ë“±ê¸‰ (600ì ) ë¶€ì—¬\n\n" + 
                     "ğŸ“– ì´ìš© ì „ ë°˜ë“œì‹œ '/ë„ì›€ë§'ì„ í™•ì¸í•´ì£¼ì„¸ìš”!";
                     
    replier.reply(welcomeMsg); 
    safeSaveData(data);
}

//==========ì„¹í„°20-2==========

var user = roomData.users[targetUid];

/* [ìˆ˜ì •] ë°ì´í„° êµ¬ì¡° ë³´ì • ë° ì´ˆê¸°í™” */
if (!user.inventory) user.inventory = [];
if (user.tierGuard === undefined) user.tierGuard = 0;
if (user.gameAuthCount === undefined) user.gameAuthCount = 0;
if (user.purchasedAuthCount === undefined) user.purchasedAuthCount = 0;

/* [ì‹ ê·œ: Gemini ìš”ì²­ ì‚¬í•­] ê²½ê³ ì‚­ì œê¶Œ êµ¬ë§¤ ì—¬ë¶€ í•„ë“œ ë§ˆì´ê·¸ë ˆì´ì…˜ */
if (user.boughtWarningRemoval === undefined) user.boughtWarningRemoval = false;

/* [ê°œí¸] ëœë¤ë°•ìŠ¤ ì‹œìŠ¤í…œ ê´€ë ¨ ë³€ìˆ˜ ì•ˆì „ ì´ˆê¸°í™” ë° ìë™ ë§ˆì´ê·¸ë ˆì´ì…˜ */
if (user.boxFragments === undefined) user.boxFragments = 0;
if (user.boxTickets === undefined) user.boxTickets = 0;

// 1. ê¸°ë¡ì¥(collectedIcons)ì´ ì—†ìœ¼ë©´ ìƒì„±
if (user.collectedIcons === undefined) {
    user.collectedIcons = [];
}

// 2. [Gemini ìš”ì²­ ì‚¬í•­] ê¸°ì¡´ ë³´ìœ  ì•„ì´ì½˜ ê¸°ë¡ ìë™ ë§ˆì´ê·¸ë ˆì´ì…˜
// ê°€ë°©ì— ìˆëŠ” ì•„ì´ì½˜ë“¤ì„ ì „ìˆ˜ ì¡°ì‚¬í•˜ì—¬ í•œ ë²ˆì´ë¼ë„ ë½‘ì€ ê¸°ë¡ì— ìë™ ë“±ë¡í•©ë‹ˆë‹¤.
if (user.inventory && user.inventory.length > 0) {
    user.inventory.forEach(function(it) {
        if (it.effect === "icon" && user.collectedIcons.indexOf(it.icon) === -1) {
            user.collectedIcons.push(it.icon);
        }
    });
}

/* [í•µì‹¬] ê°•ì œ ì¶”ì‹¬ í”Œë˜ê·¸ ì´ˆê¸°í™” ë° ë³´ì • */
if (user.isTransferred === undefined) user.isTransferred = false;

/* [ê¸°ëŠ¥] ê¸°ì¡´ ì•„ì´ì½˜ ë° ì¹­í˜¸ ê°€ë°© ìë™ ë§ˆì´ê·¸ë ˆì´ì…˜ */
if (user.inventory) {
    // 1. ì•„ì´ì½˜ ë§ˆì´ê·¸ë ˆì´ì…˜
    if (user.icon && user.icon !== "") {
        var hasIconInInv = false;
        for (var j = 0; j < user.inventory.length; j++) {
            if (user.inventory[j].icon === user.icon) { hasIconInInv = true; break; }
        }
        if (!hasIconInInv) {
            for (var k = 0; k < SHOP_ITEMS.length; k++) {
                if (SHOP_ITEMS[k].effect === "icon" && SHOP_ITEMS[k].icon === user.icon) {
                    user.inventory.push({
                        id: SHOP_ITEMS[k].id, name: SHOP_ITEMS[k].name, icon: SHOP_ITEMS[k].icon,
                        effect: "icon", title: ""
                    });
                    // ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œ ê¸°ë¡ì¥ì—ë„ ë™ì‹œ ë“±ë¡
                    if (user.collectedIcons.indexOf(user.icon) === -1) user.collectedIcons.push(user.icon);
                    break;
                }
            }
        }
    }
    
    // 2. ì¹­í˜¸ ë§ˆì´ê·¸ë ˆì´ì…˜ (ëˆ„ë½ë¶„ ì¶”ê°€)
    if (user.title && user.title !== "") {
        var hasTitleInInv = false;
        for (var j = 0; j < user.inventory.length; j++) {
            if (user.inventory[j].title === user.title) { hasTitleInInv = true; break; }
        }
        if (!hasTitleInInv) {
            for (var k = 0; k < SHOP_ITEMS.length; k++) {
                if (SHOP_ITEMS[k].effect === "title" && SHOP_ITEMS[k].title === user.title) {
                    user.inventory.push({
                        id: SHOP_ITEMS[k].id, name: SHOP_ITEMS[k].name, icon: SHOP_ITEMS[k].icon || "",
                        effect: "title", title: SHOP_ITEMS[k].title
                    });
                    break;
                }
            }
        }
    }
}

var today = getSimpleDate();
user.point = Number(user.point || 0);

/* ë¯¼ìƒì§€ì›ê¸ˆ ì¦‰ì‹œ ì²´í¬ */
checkEconomicStimulus(user, roomName, false);

/* ì¤‘ë³µ ìœ ì € ì„ íƒ ì²˜ë¦¬ë¶€ (ì‚¬ì±„ ë³´ì „ ë° êµ­ê³  íšŒìˆ˜ ë¡œì§ í†µí•©) */
if (selectWaitState[targetUid]) {
    if (Date.now() - selectWaitState[targetUid].timestamp > 30000) {
        delete selectWaitState[targetUid];
    } 
    else if (msg === "ì·¨ì†Œ") {
        delete selectWaitState[targetUid];
        replier.reply(formatCommand("ğŸš« ì„ íƒ ì·¨ì†Œ", user, "ì‘ì—…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."));
        return;
    }
    else {
        var choice = parseInt(msg);
        if (!isNaN(choice) && choice >= 1 && choice <= selectWaitState[targetUid].results.length) {
            var selected = selectWaitState[targetUid].results[choice - 1];
            var type = selectWaitState[targetUid].type;
            var extra = selectWaitState[targetUid].extra;
            var targetUser = selected.data;
            delete selectWaitState[targetUid];

            if (type === "info") {
                var cr = getCreditInfo(targetUser.creditScore);
                var info = "ğŸ’° í¬ì¸íŠ¸: " + fp(targetUser.point) + "P\nğŸ¦ ì˜ˆê¸ˆ: " + fp(targetUser.bank) + "P\nğŸ’³ ì‹ ìš©: " + cr.label + " (" + targetUser.creditScore + "ì )\nğŸ… í‹°ì–´: " + TIERS[targetUser.tier];
                replier.reply(formatCommand("ğŸ” ìœ ì € ìƒì„¸ ì •ë³´", targetUser, info, null));
            }
            else if (type === "transfer") {
                if (selected.id === targetUid) return replier.reply(formatError(user, "ì†¡ê¸ˆ ë¶ˆê°€", "ìê¸° ìì‹ ì—ê²ŒëŠ” ì†¡ê¸ˆí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
                util_updatePoint(user, roomData, -extra.amount, "ì†¡ê¸ˆ ë³´ëƒ„", roomName); // ê´€ë¬¸ í†µê³¼
                var res = processRepayment(targetUser, extra.amount, selected.id, roomName);
                util_updatePoint(targetUser, roomData, Number(res.actualGain), "ì†¡ê¸ˆ ë°›ìŒ", roomName);
                replier.reply(formatCommand("ğŸ’¸ ì†¡ê¸ˆ ì™„ë£Œ", user, getDisplayName(targetUser) + "ë‹˜ê»˜ " + fp(extra.amount) + "P ë³´ëƒˆìŠµë‹ˆë‹¤.", "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
            }
            else if (type === "admin_userdata") { 
                replier.reply(formatAdmin("ìœ ì € ë°ì´í„° ì¡°íšŒ", JSON.stringify(targetUser, null, 2))); 
            }
            else if (type === "admin_point_give") {
                var preP = Number(targetUser.point);
                targetUser.point = Number(targetUser.point) + extra.amount;
                verifyPointTransaction(targetUser, preP, extra.amount, "ê´€ë¦¬ì ì§€ê¸‰");
                replier.reply(formatAdmin("í¬ì¸íŠ¸ ì§€ê¸‰ ì™„ë£Œ", getDisplayName(targetUser) + "ë‹˜: +" + fp(extra.amount) + "P\n(í˜„ì¬: " + fp(targetUser.point) + "P)"));
                safeSaveData(data);
            }
            else if (type === "admin_point_take") {
                util_updatePoint(targetUser, roomData, -extra.amount, "ê´€ë¦¬ì ì°¨ê°", roomName); // ê´€ë¬¸ í†µê³¼
                replier.reply(formatAdmin("í¬ì¸íŠ¸ ì°¨ê° ì™„ë£Œ", getDisplayName(targetUser) + "ë‹˜ ì°¨ê° ì²˜ë¦¬ë¨"));
            }
            else if (type === "admin_attend_edit") {
                targetUser.totalAttendance = extra.days;
                replier.reply(formatAdmin("ì¶œì„ ìˆ˜ì • ì™„ë£Œ", getDisplayName(targetUser) + "ë‹˜: " + extra.days + "ì¼"));
                safeSaveData(data);
            }
            /* [ìˆ˜ì •] ìœ ì € ì‚­ì œ (ì¤‘ë³µ ì„ íƒ ì¼€ì´ìŠ¤) - ì‚¬ì±„ ë³´ì „ ë° êµ­ê³  íšŒìˆ˜ ì ìš© */
            else if (type === "admin_delete") {
                var tName = targetUser.name;
                var targetId = selected.id;
                var refundLog = "";
                var refundCount = 0;
                var totalRefunded = 0;

                // 1. ëª¨ë“  ì‚¬ì±„ ê³„ì•½ ê°•ì œ ì •ì‚° ë° ì‚­ì œ (ì±„ê¶Œì ë³´í˜¸)
                if (roomData.loanContracts) {
                    for (var cid in roomData.loanContracts) {
                        var c = roomData.loanContracts[cid];
                        if (c.borrowerUid === targetId) {
                            var lender = roomData.users[c.lenderUid];
                            if (lender) {
                                var debtAmt = Number(c.currentDebt);
                                lender.point = Number(lender.point) + debtAmt;
                                totalRefunded += debtAmt;
                                refundCount++;
                                try { Api.replyRoom(roomName, "ğŸš¬ [ì‚¬ì±„ ê°•ì œ ì •ì‚°]\n" + tName + "ë‹˜ì˜ ë°ì´í„° ì‚­ì œë¡œ ì¸í•´ " + lender.name + "ë‹˜ê»˜ ë¯¸ìˆ˜ê¸ˆ " + fp(debtAmt) + "Pê°€ ì „ì•¡ ë°˜í™˜ë˜ì—ˆìŠµë‹ˆë‹¤."); } catch(e){}
                            }
                            delete roomData.loanContracts[cid];
                        }
                    }
                }

                // 2. ì€í–‰ ëŒ€ì¶œê¸ˆ êµ­ê³  íšŒìˆ˜
                if (targetUser.loan && Number(targetUser.loan.debt) > 0) {
                    var bankDebt = Number(targetUser.loan.debt);
                    roomData.bankReserve = (Number(roomData.bankReserve) || 0) + bankDebt;
                    refundLog += "\n\nğŸ¦ ì€í–‰ ëŒ€ì¶œê¸ˆ " + fp(bankDebt) + "Pê°€ êµ­ê³ ë¡œ ìë™ íšŒìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.";
                }

                if (refundCount > 0) refundLog += "\nâš ï¸ ì‚¬ì±„ ë³´ì „ ì™„ë£Œ: " + refundCount + "ê±´ (" + fp(totalRefunded) + "P)";

                // 3. ë°ì´í„° ì‚­ì œ ì²˜ë¦¬
                if (typeof uidCache !== 'undefined') {
                    for (var key in uidCache) {
                        if (uidCache[key] === targetId) delete uidCache[key];
                    }
                }
                delete roomData.users[targetId];
                safeSaveData(data);
                replier.reply(formatAdmin("ìœ ì € ì‚­ì œ ì™„ë£Œ", "[" + tName + "]ë‹˜ì˜ ë°ì´í„°ë¥¼ ì˜êµ¬ ì‚­ì œí–ˆìŠµë‹ˆë‹¤." + refundLog));
            }
            else if (type === "admin_attend_reset") {
                targetUser.lastDate = "";
                replier.reply(formatAdmin("ì¶œì„ ì´ˆê¸°í™”", getDisplayName(targetUser) + "ë‹˜ì˜ ì˜¤ëŠ˜ ì¶œì„ ê¸°ë¡ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤."));
                safeSaveData(data);
            }
            else if (type === "user_restore") {
                var stablePath = BASE_DIR + "backup/last_stable_backup.json";
                if (new java.io.File(stablePath).exists()) {
                    var backupData = JSON.parse(FileStream.read(stablePath));
                    var backupUser = null;
                    for (var r in backupData.rooms) { 
                        if (backupData.rooms[r].users[selected.id]) { 
                            backupUser = backupData.rooms[r].users[selected.id]; 
                            break; 
                        } 
                    }
                    if (backupUser) { 
                        roomData.users[selected.id] = backupUser; 
                        safeSaveData(data); 
                        replier.reply(formatAdmin("ìœ ì € ë³µêµ¬ ì™„ë£Œ", getDisplayName(backupUser) + "ë‹˜ ë³µêµ¬ ì„±ê³µ")); 
                    }
                }
            }
            else if (type === "admin_nick_log") {
                var hist = data.nickHistory[selected.id] || [];
                if (hist.length === 0) {
                    replier.reply(formatAdmin("ë‹‰ë„¤ì„ ê¸°ë¡", getDisplayName(targetUser) + "ë‹˜ì€ ë³€ê²½ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤."));
                } else {
                    var logMsg = [];
                    for(var i=0; i<hist.length; i++) logMsg.push((i+1) + ". " + hist[i].old + " (" + hist[i].date + ")");
                    replier.reply(formatAdmin("ğŸ“‹ ë‹‰ë„¤ì„ ë³€ê²½ ì´ë ¥", "í˜„ì¬: " + targetUser.name + "\n\n[ê³¼ê±° ê¸°ë¡]\n" + logMsg.join("\n")));
                }
            }
            return;
        }
    }
}

//==========ì„¹í„°21==========

        /* ë¡œë˜ ë²ˆí˜¸ ì…ë ¥ ì²˜ë¦¬ë¶€ (ì•ˆì „ ê´€ë¬¸ í†µí•© ë²„ì „) */
        if (lottoPurchaseState[targetUid]) {
            if (Date.now() - lottoPurchaseState[targetUid].time > 30000) {
                delete lottoPurchaseState[targetUid];
            } 
            else if (msg === "ì·¨ì†Œ") {
                delete lottoPurchaseState[targetUid];
                replier.reply(formatCommand("ğŸš« ë¡œë˜ êµ¬ë§¤ ì·¨ì†Œ", user, "êµ¬ë§¤ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."));
                return;
            }
            else {
                var rawNums = msg.match(/\d+/g);
                if (!rawNums || rawNums.length !== 3) {
                    replier.reply(formatError(user, "ì…ë ¥ ì˜¤ë¥˜", "ìˆ«ì 3ê°œë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: 1 5 10)"));
                    return;
                }
                var nums = rawNums.map(Number).sort(function(a, b) { return a - b; });
                var isInvalid = false;
                if (new Set(nums).size !== 3) isInvalid = true;
                for (var i = 0; i < 3; i++) { if (nums[i] < 1 || nums[i] > 15) isInvalid = true; }
                if (isInvalid) {
                    replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "1~15 ì‚¬ì´ì˜ ì¤‘ë³µ ì—†ëŠ” ìˆ«ì 3ê°œë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
                    return;
                }

                var lottoPrice = (lottoPurchaseState[targetUid].price !== undefined) ? lottoPurchaseState[targetUid].price : 1000;

                /* [í•µì‹¬ ìˆ˜ì • êµ¬ê°„] */
                var startPoint = Number(user.point); // ì°¨ê° ì „ ì”ì•¡ ê¸°ë¡
                
                // 1. ì•ˆì „ ê´€ë¬¸ì„ í†µí•´ í¬ì¸íŠ¸ ì°¨ê° (ë³´ìœ ì•¡ë³´ë‹¤ ë¡œë˜ê°’ì´ ë¹„ì‹¸ë©´ ë³´ìœ ì•¡ë§Œí¼ë§Œ ì°¨ê°ë¨)
                util_updatePoint(user, roomData, -lottoPrice, "ë¡œë˜ êµ¬ë§¤", roomName); 
                
                // 2. ì‹¤ì œë¡œ ì°¨ê°ëœ ê¸ˆì•¡ ê³„ì‚° (ì˜ˆ: 1000ì›ì¸ë° 500ì›ë§Œ ìˆì—ˆë‹¤ë©´ 500ì›ë§Œ ê³„ì‚°ë¨)
                var actualDeducted = startPoint - Number(user.point); 

                // 3. ë¡œë˜ ì‘ëª¨ê¶Œ ë“±ë¡
                if (!lotto.entries[targetUid]) lotto.entries[targetUid] = [];
                lotto.entries[targetUid].push(nums);

                // 4. ì‹¤ì œë¡œ ëºì€ ëˆë§Œí¼ë§Œ ë‹¹ì²¨ê¸ˆ í’€ì— ì¶”ê°€ (ê²½ì œ ì§€í‘œ ì¼ì¹˜)
                lotto.dailyPool = (lotto.dailyPool || 0) + actualDeducted;
                /* [ìˆ˜ì • ë] */
                
                delete lottoPurchaseState[targetUid];
                replier.reply(formatCommand("ğŸ« ë¡œë˜ êµ¬ë§¤ ì™„ë£Œ", user, "ì„ íƒ ë²ˆí˜¸: [" + nums.join(", ") + "]\nì°¨ê° ê¸ˆì•¡: " + fp(actualDeducted) + "P\nì¶”ì²¨ ì‹œê°„: ë§¤ì¼ ë°¤ 22:00", "ë‚´ ì”ì•¡: " + fP(user.point) + "P"));
                
                safeSaveData(data);
                return;
            }
        }

        /* ì±„íŒ… ë³´ë„ˆìŠ¤ ë¡œì§ (í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹ ì ìš©: ì‹¤ì‹œê°„ ì €ì¥ ì œê±°ë¡œ ë ‰ ë°©ì§€) */
        if (msg.indexOf("/") !== 0) {
            user.chatCount = (user.chatCount || 0) + 1;
            user.chatCycleCount = (user.chatCycleCount || 0) + 1;
            if (user.chatCycleCount > 13 || !user.chatBonusTarget) {
                user.chatCycleCount = 1; 
                user.chatBonusTarget = Math.floor(Math.random() * 12) + 1;
                user.chatBonusGiven = false; 
            }
            if (user.chatCycleCount >= user.chatBonusTarget && !user.chatBonusGiven) {
                var multiplier = 1.0;
                var roomDataForChat = data.rooms[roomName];
                if (roomDataForChat && roomDataForChat.economyBase && roomDataForChat.economyBase > 0) {
                    var currentEco = calculateEconomy(data, roomName);
                    var rawRatio = currentEco.total / roomDataForChat.economyBase;
                    var damping = (data.economyDamping !== undefined) ? data.economyDamping : 0.5;
                    multiplier = 1 + (rawRatio - 1) * damping;
                    if (multiplier < 0.5) multiplier = 0.5;
                }

                var basePrize = Math.floor(Math.random() * 21) + 80;
                var prize = Math.floor(basePrize * multiplier);
                
                var prePoint = Number(user.point);
                
                /* [í•µì‹¬] ì‚¬ì±„ ì¶”ì‹¬ ë¡œì§ì´ í¬í•¨ëœ í†µí•© ìƒí™˜ í•¨ìˆ˜ í˜¸ì¶œ */
                // targetUidë¥¼ ì¸ìë¡œ ë„˜ê²¨ ì‚¬ì±„ ê³„ì•½ì ì‹ë³„ ë° ì¶”ì‹¬ ì§„í–‰
                var res = processRepayment(user, prize, targetUid, roomName);
                util_updatePoint(user, roomData, Number(res.actualGain), "ì±„íŒ… ë³´ë„ˆìŠ¤", roomName); // ê´€ë¬¸ í†µê³¼

                user.creditScore = Math.min(1000, Number(user.creditScore || 600) + 1);
                
                // ì¶”ì‹¬ ë° ìƒí™˜ ë‚´ì—­ì´ í¬í•¨ëœ ë©”ì‹œì§€ ì¶œë ¥
                var output = "ğŸ ì±„íŒ… ë³´ë„ˆìŠ¤\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + getDisplayName(user) + "ë‹˜\n" + fp(prize) + "Pë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!" + (res.repayMsg ? res.repayMsg : "") + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”";
                replier.reply(output + "\në‚´ ì”ì•¡: " + fP(user.point) + "P");
                
                user.chatBonusGiven = true; 
                
                /* [ìµœì í™”] í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹ ì ìš©: ê³ ë¹ˆë„ ì‘ì—…ì¸ ì±„íŒ… ë³´ë„ˆìŠ¤ëŠ” ì‹¤ì‹œê°„ ì €ì¥ì„ ìƒëµí•¨ */
                // ì‹¤ì œ ì €ì¥ì€ 5ë¶„ ì£¼ê¸° ìŠ¤ì¼€ì¤„ëŸ¬(ì„¹í„° 16)ê°€ ë‹´ë‹¹í•˜ì—¬ I/O ë¶€í•˜ë¥¼ ì œê±°í•¨.
                // safeSaveData(data); 
            }
        }
        
//==========ì„¹í„°22-1==========

/* [ìˆ˜ì •] í†µí•© ì—…ë¬´ ì²˜ë¦¬ í•¸ë“¤ëŸ¬ (1ë‹¨ê³„: ì†¡ê¸ˆ, ì˜ˆê¸ˆ ë° ê¸°ë¶€) */
if (bankProcessState && bankProcessState[targetUid]) {
    var state = bankProcessState[targetUid];

    if (Date.now() - state.time > 30000) {
        delete bankProcessState[targetUid];
    } 
    else if (msg === "ì·¨ì†Œ") {
        delete bankProcessState[targetUid];
        replier.reply(formatCommand("ğŸš« ì—…ë¬´ ì·¨ì†Œ", user, "ìš”ì²­í•˜ì‹  ì—…ë¬´ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."));
    } 
    else {
        /* [ê¸°ëŠ¥ 1] ì†¡ê¸ˆ ì²˜ë¦¬ */
        if (state.type === 'transfer') {
            var ps = msg.split(" ");
            if (ps.length < 2) {
                replier.reply(formatError(user, "ì…ë ¥ ì˜¤ë¥˜", "í˜•ì‹: [ë‹‰ë„¤ì„] [ê¸ˆì•¡]"));
            } else {
                var am = parseInt(ps.pop().replace(/,/g, "")); 
                var tn = ps.join(" ").trim(); 
                var found = findUserByName(roomData, tn);

                if (found.length === 0) {
                    replier.reply(formatError(user, "ëŒ€ìƒ ì—†ìŒ", "[" + tn + "]ë‹˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
                } else if (found.length > 1) {
                    handleUserSelection(replier, targetUid, found, "transfer", { amount: am }, user);
                } else if (found[0].id === targetUid) {
                    replier.reply(formatError(user, "ë³¸ì¸ ì†¡ê¸ˆ ë¶ˆê°€", "ìì‹ ì—ê²ŒëŠ” ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
                } else if (isNaN(am) || am <= 0) {
                    replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜", "ì •í™•í•œ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
                } else if (user.point < am) {
                    replier.reply(formatError(user, "ì”ì•¡ ë¶€ì¡±", "ë³´ìœ  í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."));
                } else {
                    var rc = found[0].data;
                    var preSender = Number(user.point);
                    user.point -= am;
                    verifyPointTransaction(user, preSender, -am, "ì†¡ê¸ˆ ë³´ëƒ„");

                    var res = processRepayment(rc, am, found[0].id, roomName);
                    var preRc = Number(rc.point);
                    rc.point = Number(rc.point) + Number(res.actualGain);
                    verifyPointTransaction(rc, preRc, Number(res.actualGain), "ì†¡ê¸ˆ ë°›ìŒ");

                    replier.reply(formatCommand("ğŸ’¸ ì†¡ê¸ˆ ì™„ë£Œ", user, getDisplayName(rc) + "ë‹˜ê»˜ " + fp(am) + "Pë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤." + res.repayMsg, "(í˜„ì¬ ì”ì•¡: " + fp(user.point) + "P)"));
                    delete bankProcessState[targetUid];
                    safeSaveData(data);
                }
            }
        }

        /* [ê¸°ëŠ¥ 2] ì˜ˆê¸ˆ ì²˜ë¦¬ */
        else if (state.type === 'deposit') {
            var amt = parseInt(msg.replace(/,/g, ""));
            if (isNaN(amt) || amt <= 0) {
                replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜", "ì˜ˆê¸ˆí•  ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
            } else if (user.point < amt) {
                replier.reply(formatError(user, "í¬ì¸íŠ¸ ë¶€ì¡±", "ë³´ìœ í•˜ì‹  í¬ì¸íŠ¸ë³´ë‹¤ ë§ìŠµë‹ˆë‹¤."));
            } else {
                var preP = Number(user.point);
                user.point -= amt;
                user.bank = (user.bank || 0) + amt;

                if (roomData.bankReserve === undefined || roomData.bankReserve === null) {
                    roomData.bankReserve = SYSTEM_CONFIG.ECO.BANK.INITIAL_RESERVE;
                }
                roomData.bankReserve += amt;

                util_updatePoint(user, roomData, -amt, "ì€í–‰ ì˜ˆê¸ˆ", roomName);

                replier.reply(formatCommand("ğŸ’° ì˜ˆê¸ˆ ì™„ë£Œ", user, fp(amt) + "Pë¥¼ í†µì¥ì— ì…ê¸ˆí–ˆìŠµë‹ˆë‹¤.\n(ì¤‘ì•™ì€í–‰ ê°€ìš© ì¬ì›ìœ¼ë¡œ í¸ì…ë¨)", "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
                delete bankProcessState[targetUid];
                safeSaveData(data);
            }
        }

        /* [ìˆ˜ì •] ê¸°ë¶€ ì²˜ë¦¬ (ëˆ„ì  ê¸°ë¶€ ì¹­í˜¸ ì‹œìŠ¤í…œ ì—°ë™) */
        else if (state.type === 'donate') {
            var amt = parseInt(msg.replace(/,/g, ""));
            if (isNaN(amt) || amt <= 0) {
                replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜", "ê¸°ë¶€í•  ê¸ˆì•¡ì„ ìˆ«ìë¡œ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”."));
            } else if (user.point < amt) {
                replier.reply(formatError(user, "ì”ì•¡ ë¶€ì¡±", "ë³´ìœ í•˜ì‹  í¬ì¸íŠ¸ë³´ë‹¤ ë§ì€ ê¸ˆì•¡ì€ ê¸°ë¶€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
            } else {
                /* 1. ì¤‘ì•™ì€í–‰ ì—°ë™ ê¸°ë¶€ê¸ˆ ì²˜ë¦¬ */
                util_updatePoint(user, roomData, -amt, "ì€í–‰ ê¸°ë¶€", roomName);
                
                /* 2. ëˆ„ì  ê¸°ë¶€ ê¸ˆì•¡ í•©ì‚° */
                user.totalDonation = (user.totalDonation || 0) + amt;

                /* 3. ê¸°ë¶€ ì¹­í˜¸ ì²´í¬ ë¡œì§ (Gemini ìš”ì²­ ì‚¬í•­: 4ë‹¨ê³„) */
                var donation = user.totalDonation;
                var replierStub = { reply: function(m) { Api.replyRoom(roomName, m); } };

                if (donation >= 1000000) {
                    util_checkAndAwardTitle(user, replierStub, "ê¸°ë¶€ì˜ì™•", 5004, "ğŸ‘‘", "ëˆ„ì  ê¸°ë¶€ 1,000,000P", "êµ­ê°€ ê²½ì œì˜ ì§„ì •í•œ ìˆ˜í˜¸ìë¡œ ë“±ê·¹í•˜ì…¨ìŠµë‹ˆë‹¤.");
                } else if (donation >= 500000) {
                    util_checkAndAwardTitle(user, replierStub, "ìì„ ê°€", 5003, "âœ¨", "ëˆ„ì  ê¸°ë¶€ 500,000P", "1,000,000P ë‹¬ì„± ì‹œ ê¸°ë¶€ì˜ì™• ì¹­í˜¸ë¥¼ íšë“í•©ë‹ˆë‹¤.");
                } else if (donation >= 300000) {
                    util_checkAndAwardTitle(user, replierStub, "ê¸°ë¶€ì²œì‚¬", 5002, "ğŸ‘¼", "ëˆ„ì  ê¸°ë¶€ 300,000P", "500,000P ë‹¬ì„± ì‹œ ìì„ ê°€ ì¹­í˜¸ë¥¼ íšë“í•©ë‹ˆë‹¤.");
                } else if (donation >= 100000) {
                    util_checkAndAwardTitle(user, replierStub, "ì„ í•œì†ê¸¸", 5001, "ğŸŒ±", "ëˆ„ì  ê¸°ë¶€ 100,000P", "300,000P ë‹¬ì„± ì‹œ ê¸°ë¶€ì²œì‚¬ ì¹­í˜¸ë¥¼ íšë“í•©ë‹ˆë‹¤.");
                }

                var thanksMsg = "ì¤‘ì•™ì€í–‰ì— " + fp(amt) + "Pë¥¼ ê¸°ë¶€í•˜ì…¨ìŠµë‹ˆë‹¤.\n" +
                                "ë³´ë‚´ì£¼ì‹  ì†Œì¤‘í•œ ìì‚°ì€ êµ­ê°€ ê²½ì œ ìœ„ê¸° ê·¹ë³µê³¼ \n" +
                                "ì „ì²´ ìœ ì € ë³µì§€ í–¥ìƒì„ ìœ„í•´ ê·€í•˜ê²Œ ì‚¬ìš©ë©ë‹ˆë‹¤.\n" +
                                "ë”°ëœ»í•œ ë§ˆìŒì— ì§„ì‹¬ìœ¼ë¡œ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤!\n\n" +
                                "ğŸ¦ [êµ­ê³  ì…ê³ ]: ê¸°ë¶€ê¸ˆì´ ì¤‘ì•™ì€í–‰ ì¬ì›ìœ¼ë¡œ ê·€ì†ë¨\n" +
                                "ğŸ“Š ëˆ„ì  ê¸°ë¶€ì•¡: " + fp(donation) + "P";

                replier.reply(formatCommand("ğŸ ê¸°ë¶€ ì™„ë£Œ", user, thanksMsg, "(í˜„ì¬ ì”ì•¡: " + fp(user.point) + "P)"));
                delete bankProcessState[targetUid];
                safeSaveData(data);
            }
        }
    }
}
            
//==========ì„¹í„°22-2==========

/* [ë…ë¦½í˜•] í†µí•© ì—…ë¬´ ì²˜ë¦¬ í•¸ë“¤ëŸ¬ (2ë‹¨ê³„: ì¶œê¸ˆ, ëŒ€ì¶œ, ìƒí™˜) */
if (bankProcessState && bankProcessState[targetUid]) {
    var state = bankProcessState[targetUid];
    var roomData = data.rooms[roomName]; // ì¬ì› ê´€ë¦¬ë¥¼ ìœ„í•´ roomData ì°¸ì¡°

    // ì¤‘ì•™ì€í–‰ ì¬ì› ì´ˆê¸°í™” (ì„¹í„° 1ì˜ ì„¤ì •ê°’ ì‚¬ìš©)
    if (roomData.bankReserve === undefined) roomData.bankReserve = SYSTEM_CONFIG.ECO.BANK.INITIAL_RESERVE;

    // ê°€ë“œ ë¡œì§: ì‹œê°„ ì´ˆê³¼ ë° ì·¨ì†Œ ì²˜ë¦¬
    if (Date.now() - state.time > 30000) {
        delete bankProcessState[targetUid];
    } 
    else if (msg === "ì·¨ì†Œ") {
        delete bankProcessState[targetUid];
        replier.reply(formatCommand("ğŸš« ì€í–‰ ì—…ë¬´ ì·¨ì†Œ", user, "ìš”ì²­í•˜ì‹  ì—…ë¬´ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."));
    } 
    else {
        /* [ê¸°ëŠ¥ 3] ì¶œê¸ˆ ì²˜ë¦¬ (ì§€ê¸‰ì¤€ë¹„ì œë„ ë°˜ì˜: ê¸ˆê³  ì‹¤ì¬ê³  í™•ì¸) */
        if (state.type === 'withdraw') {
            var amt = parseInt(msg.replace(/,/g, ""));
            if (isNaN(amt) || amt <= 0) {
                replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜", "ì¶œê¸ˆí•  ìˆ«ìë¥¼ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”."));
            } else if (user.bank < amt) {
                replier.reply(formatError(user, "ì”ê³  ë¶€ì¡±", "í†µì¥ ì”ê³ ë³´ë‹¤ ë§ì€ ê¸ˆì•¡ì€ ì¶œê¸ˆí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
            } else if (roomData.bankReserve < amt) {
                /* [ì‹ ê·œ] ë±…í¬ëŸ° ë°©ì§€: ì€í–‰ ì‹¤ìì‚°ì´ ë¶€ì¡±í•  ê²½ìš° ì¶œê¸ˆ ì œí•œ */
                replier.reply(formatError(user, "ì€í–‰ ì§€ê¸‰ ë¶ˆëŠ¥", "ì£„ì†¡í•©ë‹ˆë‹¤. í˜„ì¬ ì€í–‰ì˜ í˜„ê¸ˆ ìœ ë™ì„±(ì‹¤ì¬ê³ )ì´ ë¶€ì¡±í•˜ì—¬ ì¶œê¸ˆì´ ì¼ì‹œ ì œí•œë©ë‹ˆë‹¤.\nëŒ€ì¶œê¸ˆ íšŒìˆ˜ ë° ìˆ˜ìˆ˜ë£Œ ì ë¦½ ì‹œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.\n\nğŸ¦ í˜„ì¬ ì€í–‰ ê¸ˆê³ : " + fp(roomData.bankReserve) + "P"));
            } else {
                var preP = Number(user.point);
                user.bank -= amt;
                user.point += amt;
                
                /* [í•µì‹¬] ì¶œê¸ˆ ì‹œ ì¤‘ì•™ì€í–‰ ê¸ˆê³ ì—ì„œ í¬ì¸íŠ¸ ìœ ì¶œ */
                roomData.bankReserve -= amt;
                
                // [v5.8] ë¸”ë™ë°•ìŠ¤ ê¸°ë¡: ìœ ì € +amt, ì€í–‰ -amt
                verifyPointTransaction(user, preP, amt, "ì€í–‰ ì¶œê¸ˆ", roomName, -amt);

                replier.reply(formatCommand("ğŸ§ ì¶œê¸ˆ ì™„ë£Œ", user, fp(amt) + "Pë¥¼ í˜„ê¸ˆìœ¼ë¡œ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", "ë³´ìœ  í¬ì¸íŠ¸: " + fp(user.point) + "P"));
                delete bankProcessState[targetUid];
                safeSaveData(data);
            }
        }

        /* [ê¸°ëŠ¥ 4] ì€í–‰ ëŒ€ì¶œ ì‹¤í–‰ (loan) - ì§€ê¸‰ì¤€ë¹„ìœ¨ ì œì–´ ì ìš© */
        if (state.type === 'loan') {
            var amt = parseInt(msg.replace(/,/g, ""));
            var cr = getCreditInfo(user.creditScore);
            var bConf = SYSTEM_CONFIG.ECO.BANK;
            var lConf = SYSTEM_CONFIG.ECO.PRIVATE_LOAN;

            /* [í•µì‹¬] ì§€ê¸‰ì¤€ë¹„ì œë„ ê¸°ë°˜ ê°€ìš© ëŒ€ì¶œ ìì‚° ê³„ì‚° */
            var totalDeposits = 0;
            for (var id in roomData.users) { totalDeposits += (roomData.users[id].bank || 0); }
            
            var requiredReserve = Math.floor(totalDeposits * bConf.RESERVE_RATIO);
            var lendableAmount = roomData.bankReserve - requiredReserve;

            if (isNaN(amt) || amt <= 0) {
                replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜", "ëŒ€ì¶œë°›ì„ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
            } 
            else if (amt > lendableAmount) {
                var reserveInfo = "í˜„ì¬ ì€í–‰ì˜ ëŒ€ì¶œ ê°€ëŠ¥ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.\n(ì§€ê¸‰ì¤€ë¹„ìœ¨ " + (bConf.RESERVE_RATIO * 100) + "% ì¤€ìˆ˜ ì¤‘)\n\n" +
                                  "ğŸ¦ í˜„ì¬ ê¸ˆê³ : " + fp(roomData.bankReserve) + "P\n" +
                                  "ğŸ›¡ï¸ ë²•ì • ì¤€ë¹„ê¸ˆ: " + fp(requiredReserve) + "P\n" +
                                  "ğŸ’° ì‹¤ì œ ëŒ€ì¶œ ê°€ëŠ¥ì•¡: " + fp(Math.max(0, lendableAmount)) + "P";
                replier.reply(formatError(user, "ì€í–‰ ìê¸ˆ ë™ê²°", reserveInfo));
            }
            else if ((user.dailyLoanCount || 0) >= lConf.DAILY_LIMIT) {
                delete bankProcessState[targetUid];
                replier.reply(formatError(user, "ëŒ€ì¶œ ì œí•œ", "ëŒ€ì¶œì€ í•˜ë£¨ì— ìµœëŒ€ " + lConf.DAILY_LIMIT + "íšŒê¹Œì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."));
            } 
            else if (amt > cr.limit) {
                replier.reply(formatError(user, "í•œë„ ì´ˆê³¼", cr.label + "ì˜ ìµœëŒ€ í•œë„ëŠ” " + fp(cr.limit) + "Pì…ë‹ˆë‹¤."));
            } 
            else {
                user.dailyLoanCount = (user.dailyLoanCount || 0) + 1;
                if (user.dailyLoanCount >= 2) {
                    user.creditScore = Math.max(0, Number(user.creditScore || 600) - 20);
                    checkAndHandleDefaulter(user, roomName);
                }

                var total = Math.floor(amt * cr.rate);
                if (!user.loan || typeof user.loan !== 'object') user.loan = { debt: 0, items: [] };
                if (!user.loan.items) user.loan.items = [];

                user.loan.debt = Number(user.loan.debt || 0) + Number(total);
                user.loan.items.push(Number(total));

                var preP = Number(user.point);
                user.point = Number(user.point || 0) + Number(amt);
                
                // [ì¤‘ìš”] ì€í–‰ ì¬ì›ì—ì„œ ëŒ€ì¶œê¸ˆ ì°¨ê°
                roomData.bankReserve -= amt;

                // [v5.8] ë¸”ë™ë°•ìŠ¤ ê¸°ë¡: ìœ ì € +amt, ì€í–‰ -amt
                verifyPointTransaction(user, preP, amt, "ëŒ€ì¶œ ì‹¤í–‰", roomName, -amt);

                replier.reply(formatCommand("ğŸ¦ ëŒ€ì¶œ ìŠ¹ì¸", user, fp(amt) + "P ì…ê¸ˆ ì™„ë£Œ\n(ìƒí™˜ ì˜ˆì •ì•¡: " + fp(total) + "P)\n\nğŸ›ï¸ ë‚¨ì€ ê°€ìš© ì¬ì›: " + fp(roomData.bankReserve - requiredReserve) + "P", "ë³´ìœ  í¬ì¸íŠ¸: " + fp(user.point) + "P"));
                delete bankProcessState[targetUid];
                safeSaveData(data);
            }
        }

        /* [ê¸°ëŠ¥ 5] ì€í–‰ ëŒ€ì¶œ ìƒí™˜ (repay) - ì¬ì› ë³µêµ¬ ë¡œì§ í¬í•¨ */
        if (state.type === 'repay') {
            var amt = parseInt(msg.replace(/,/g, ""));
            if (isNaN(amt) || amt <= 0) {
                replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜", "ìƒí™˜í•  ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
            } else if (user.point < amt) {
                replier.reply(formatError(user, "í¬ì¸íŠ¸ ë¶€ì¡±", "ë³´ìœ í•˜ì‹  í¬ì¸íŠ¸ê°€ ìƒí™˜ì•¡ë³´ë‹¤ ì ìŠµë‹ˆë‹¤."));
            } else {
                var preP = Number(user.point);
                var res = distributeRepayment(user, amt);
                user.point = Number(user.point) - Number(res.actualRepay); 
                
                // [ì¤‘ìš”] ìƒí™˜ëœ ì›ê¸ˆì€ ì€í–‰ ì¬ì›ìœ¼ë¡œ ë‹¤ì‹œ ë³µêµ¬ (ì¬ì› ìˆœí™˜)
                roomData.bankReserve = (roomData.bankReserve || 0) + res.actualRepay;

                // [v5.8] ë¸”ë™ë°•ìŠ¤ ê¸°ë¡: ìœ ì € -actualRepay, ì€í–‰ +actualRepay
                verifyPointTransaction(user, preP, -res.actualRepay, "ëŒ€ì¶œ ìƒí™˜", roomName, res.actualRepay);

                var currentDebt = (user.loan && user.loan.debt) ? Number(user.loan.debt) : 0;
                replier.reply(formatCommand("ğŸ“‰ ìƒí™˜ ì™„ë£Œ", user, fp(res.actualRepay) + "P ìƒí™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nğŸ¦ ì€í–‰ ì¬ì› ì¶©ì „: +" + fp(res.actualRepay) + "P", "ë‚¨ì€ ëŒ€ì¶œê¸ˆ: " + fp(currentDebt) + "P"));
                delete bankProcessState[targetUid];
                safeSaveData(data);
            }
        }
    }
}
            
//==========ì„¹í„°22-3==========

/* [ë…ë¦½í˜•] í†µí•© ì—…ë¬´ ì²˜ë¦¬ í•¸ë“¤ëŸ¬ (3ë‹¨ê³„: ì‚¬ì±„ ë“±ë¡ ë° ë¹Œë¦¬ê¸°) */
if (bankProcessState && bankProcessState[targetUid]) {
    var state = bankProcessState[targetUid];

    // ê°€ë“œ ë¡œì§: ì‹œê°„ ì´ˆê³¼ ë° ì·¨ì†Œ ì²˜ë¦¬ (ë…ë¦½ì„± ìœ ì§€)
    if (Date.now() - state.time <= 30000 && msg !== "ì·¨ì†Œ") {
        
        /* [ê¸°ëŠ¥ 6] ì‚¬ì±„ ë§¤ë¬¼ ë“±ë¡ ì²˜ë¦¬ (p2p_reg_input) */
        if (state.type === 'p2p_reg_input') {
            var parts = msg.split(" ");
            if (parts.length < 2) {
                replier.reply(formatError(user, "ì…ë ¥ ì˜¤ë¥˜", "í˜•ì‹: [ê¸ˆì•¡] [ì´ìœ¨]\nì˜ˆ) 10000 5"));
            } else {
                var amt = parseInt(parts[0]);
                var rate = parseInt(parts[1]);
                var conf = SYSTEM_CONFIG.ECO.PRIVATE_LOAN;

                // 1. ë“±ë¡ ì¡°ê±´ ê²€ì¦ (ìµœì†Œ ê¸ˆì•¡, ë²•ì • ì´ìœ¨ ë²”ìœ„)
                if (isNaN(amt) || amt < conf.MIN_AMOUNT) {
                    replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜", "ìµœì†Œ " + fp(conf.MIN_AMOUNT) + "P ì´ìƒ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤."));
                } else if (isNaN(rate) || rate < 5 || rate > conf.MAX_RATE) {
                    replier.reply(formatError(user, "ì´ìœ¨ ì˜¤ë¥˜", "ì´ìœ¨ì€ 5% ~ " + conf.MAX_RATE + "% ì‚¬ì´ë¡œ ì„¤ì •í•˜ì„¸ìš”."));
                } else if (user.point < amt) {
                    replier.reply(formatError(user, "í¬ì¸íŠ¸ ë¶€ì¡±", "ë“±ë¡í•˜ë ¤ëŠ” í¬ì¸íŠ¸ê°€ ë³´ìœ  ìì‚°ë³´ë‹¤ ë§ìŠµë‹ˆë‹¤."));
                } else {
                    // 2. í¬ì¸íŠ¸ ì°¨ê° ë° ê²€ì¦
                    var preP = Number(user.point);
                    user.point -= amt;
                    verifyPointTransaction(user, preP, -amt, "ì‚¬ì±„ í’€ ë“±ë¡", roomName, 0);

                    // 3. ë§¤ë¬¼ ë°ì´í„° ìƒì„± ë° ì €ì¥
                    var poolId = generateUUID();
                    if (!roomData.loanPools) roomData.loanPools = {};
                    roomData.loanPools[poolId] = {
                        lenderUid: targetUid,
                        lenderName: cleanSender,
                        totalAmount: amt,
                        remainingAmount: amt,
                        rate: rate,
                        time: Date.now()
                    };

                    replier.reply(formatCommand("ğŸ’° ì‚¬ì±„ ë“±ë¡ ì™„ë£Œ", user, fp(amt) + "P (ì´ì " + rate + "%/3h) ë§¤ë¬¼ì„ ì‹œì¥ì— ì˜¬ë ¸ìŠµë‹ˆë‹¤.", "ë‚¨ì€ ì”ì•¡: " + fp(user.point) + "P"));
                    delete bankProcessState[targetUid];
                    safeSaveData(data);
                }
            }
        }

        /* [ê¸°ëŠ¥ 7] ì‚¬ì±„ ë¹Œë¦¬ê¸° ì‹ ì²­ ì²˜ë¦¬ (p2p_borrow_amt) */
        if (state.type === 'p2p_borrow_amt') {
            var amt = parseInt(msg);
            var pool = roomData.loanPools[state.extra.poolId];
            var conf = SYSTEM_CONFIG.ECO.PRIVATE_LOAN;

            // 1. ë§¤ë¬¼ ë° ê¸ˆì•¡ ìœ íš¨ì„± ê²€ì¦
            if (!pool) {
                replier.reply(formatError(user, "ë§¤ë¬¼ ì •ë³´ ì—†ìŒ", "í•´ë‹¹ ì‚¬ì±„ ë§¤ë¬¼ì´ ì´ë¯¸ ì‚­ì œë˜ì—ˆê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."));
            } else if (isNaN(amt) || amt < conf.MIN_BORROW) {
                replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜", "ìµœì†Œ " + fp(conf.MIN_BORROW) + "P ì´ìƒ ë¹Œë ¤ì•¼ í•©ë‹ˆë‹¤."));
            } else if (amt > pool.remainingAmount) {
                replier.reply(formatError(user, "ê¸ˆì•¡ ì´ˆê³¼", "í•´ë‹¹ ë§¤ë¬¼ì˜ ì”ì—¬ ê¸ˆì•¡(" + fp(pool.remainingAmount) + "P)ê¹Œì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."));
            } else if (pool.lenderUid === targetUid) {
                replier.reply(formatError(user, "ê³„ì•½ ë¶ˆê°€", "ë³¸ì¸ì´ ë“±ë¡í•œ ì‚¬ì±„ëŠ” ì§ì ‘ ë¹Œë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
            } else {
                // 2. ë§¤ë¬¼ ì”ì•¡ ì°¨ê° ë° ì†Œì§„ ì‹œ ì‚­ì œ
                pool.remainingAmount -= amt;
                if (pool.remainingAmount <= 0) delete roomData.loanPools[state.extra.poolId];

                // 3. [í•µì‹¬] ì¦‰ì‹œ ì´ì 10% ê°€ì‚° ë¡œì§ ì ìš©
                var initialDebt = Math.floor(amt * 1.1);

                // 4. ê³„ì•½ì„œ ìƒì„± ë° ì €ì¥
                var contractId = generateUUID();
                if (!roomData.loanContracts) roomData.loanContracts = {};
                roomData.loanContracts[contractId] = {
                    lenderUid: pool.lenderUid,
                    lenderName: pool.lenderName,
                    borrowerUid: targetUid,
                    borrowerName: cleanSender,
                    principal: amt,
                    currentDebt: initialDebt, // 10% ì„ ì´ì í¬í•¨ ì±„ë¬´ ì‹œì‘
                    rate: pool.rate,
                    startTime: Date.now(),
                    status: 'active'
                };

                // 5. í¬ì¸íŠ¸ ì§€ê¸‰ ë° ê²€ì¦
                var preP = Number(user.point);
                user.point += amt;
                verifyPointTransaction(user, preP, amt, "ì‚¬ì±„ ë¹Œë¦¼ ìŠ¹ì¸");

                replier.reply(formatCommand("ğŸ“ ì‚¬ì±„ ê³„ì•½ ì²´ê²°", user, pool.lenderName + "ë‹˜ìœ¼ë¡œë¶€í„° " + fp(amt) + "Pë¥¼ ë¹Œë ¸ìŠµë‹ˆë‹¤.\n(ì¦‰ì‹œ ì´ì 10% í¬í•¨ ì±„ë¬´: " + fp(initialDebt) + "P)", "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
                delete bankProcessState[targetUid];
                safeSaveData(data);
            }
        }
    }
}

//==========ì„¹í„°22-4==========

/* [ë…ë¦½í˜•] í†µí•© ì—…ë¬´ ì²˜ë¦¬ í•¸ë“¤ëŸ¬ (4ë‹¨ê³„: ì‚¬ì±„ ìƒí™˜, íšŒìˆ˜, ìˆ˜ê±°) */
if (bankProcessState && bankProcessState[targetUid]) {
    var state = bankProcessState[targetUid];

    // 1. ì…ë ¥ ëŒ€ê¸° ì‹œê°„ ì´ˆê³¼ ê²€ì¦ (30ì´ˆ)
    if (Date.now() - state.time > 30000) {
        delete bankProcessState[targetUid];
    } 
    // 2. ì‘ì—… ì·¨ì†Œ ì²˜ë¦¬
    else if (msg === "ì·¨ì†Œ") {
        delete bankProcessState[targetUid];
        replier.reply(formatCommand("ğŸš« ì€í–‰ ì—…ë¬´ ì·¨ì†Œ", user, "ìš”ì²­í•˜ì‹  ì—…ë¬´ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."));
    } 
    else {
        /* [ê¸°ëŠ¥ 8] ë¹Œë¦° ì‚¬ì±„ ìƒí™˜ ì²˜ë¦¬ (p2p_repay_amt) */
        if (state.type === 'p2p_repay_amt') {
            var amt = parseInt(msg);
            var contract = roomData.loanContracts[state.extra.contractId];
            if (!contract) {
                replier.reply(formatError(user, "ê³„ì•½ ì •ë³´ ì—†ìŒ"));
            } else if (isNaN(amt) || amt <= 0 || user.point < amt) {
                replier.reply(formatError(user, "ê¸ˆì•¡/í¬ì¸íŠ¸ ì˜¤ë¥˜"));
            } else {
                var actualRepay = Math.min(amt, contract.currentDebt);
                var preP = Number(user.point);
                user.point -= actualRepay;
                verifyPointTransaction(user, preP, -actualRepay, "ì‚¬ì±„ ìƒí™˜ ì§€ë¶ˆ", roomName, 0);

                var lender = roomData.users[contract.lenderUid];
                if (lender) {
                    var preL = Number(lender.point);
                    lender.point += actualRepay;
                    verifyPointTransaction(lender, preL, actualRepay, "ì‚¬ì±„ ì´ì ìˆ˜ì…");
                }

                // ë¶€ì±„ ì°¨ê° ë° ì™„ë‚© ì²´í¬ ë¡œì§
                contract.currentDebt -= actualRepay;
                var footerMsg = "ë‚¨ì€ ë¹š: " + fp(contract.currentDebt) + "P";
                if (contract.currentDebt <= 0) {
                    delete roomData.loanContracts[state.extra.contractId];
                    footerMsg = "ëª¨ë“  ì±„ë¬´ê°€ ë³€ì œë˜ì—ˆìŠµë‹ˆë‹¤.";
                }

                replier.reply(formatCommand("ğŸ“‰ ì‚¬ì±„ ìƒí™˜ ì™„ë£Œ", user, contract.lenderName + "ë‹˜ê»˜ " + fp(actualRepay) + "Pë¥¼ ê°šì•˜ìŠµë‹ˆë‹¤.\n" + footerMsg, "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
                delete bankProcessState[targetUid];
                safeSaveData(data);
            }
        }

        /* [ê¸°ëŠ¥ 9] ë“±ë¡í•œ ì‚¬ì±„ ë§¤ë¬¼ íšŒìˆ˜ (p2p_withdraw_amt) */
        if (state.type === 'p2p_withdraw_amt') {
            var amt = (msg === "ì „ì•¡") ? state.extra.max : parseInt(msg);
            var pool = roomData.loanPools[state.extra.poolId];
            if (!pool) {
                replier.reply(formatError(user, "ë§¤ë¬¼ ì •ë³´ ì—†ìŒ"));
            } else if (isNaN(amt) || amt <= 0 || amt > pool.remainingAmount) {
                replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜"));
            } else {
                pool.remainingAmount -= amt;
                var preP = Number(user.point);
                user.point += amt;
                verifyPointTransaction(user, preP, amt, "ì‚¬ì±„ í’€ íšŒìˆ˜");

                if (pool.remainingAmount <= 0) delete roomData.loanPools[state.extra.poolId];
                replier.reply(formatCommand("âœ… ì‚¬ì±„ íšŒìˆ˜ ì™„ë£Œ", user, fp(amt) + "Pë¥¼ ì‹œì¥ì—ì„œ íšŒìˆ˜í–ˆìŠµë‹ˆë‹¤.", "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
                delete bankProcessState[targetUid];
                safeSaveData(data);
            }
        }

        /* [ê¸°ëŠ¥ 10] ì±„ë¬´ì ìì‚° ê°•ì œ ìˆ˜ê±° (p2p_collect_manual) */
        if (state.type === 'p2p_collect_manual') {
            var contract = roomData.loanContracts[state.extra.contractId];
            if (!contract) {
                replier.reply(formatError(user, "ê³„ì•½ ì •ë³´ ì—†ìŒ"));
            } else {
                var debtor = roomData.users[contract.borrowerUid];
                if (!debtor) {
                    replier.reply(formatError(user, "ì±„ë¬´ì ì •ë³´ ì—†ìŒ"));
                } else {
                    var collectAmt = Math.min(Number(debtor.point), contract.currentDebt);
                    if (collectAmt <= 0) {
                        delete bankProcessState[targetUid];
                        replier.reply(formatError(user, "ìˆ˜ê±° ì‹¤íŒ¨", debtor.name + "ë‹˜ì˜ ì§€ê°‘ì´ ë¹„ì–´ìˆì–´ ìˆ˜ê±°í•  í¬ì¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤."));
                    } else {
                        // ì±„ë¬´ì ì°¨ê° ë° ì±„ê¶Œì ê°€ì‚° ì •ë°€ ê²€ì¦
                        var preDebtor = Number(debtor.point);
                        debtor.point -= collectAmt;
                        verifyPointTransaction(debtor, preDebtor, -collectAmt, "ì‚¬ì±„ ê°•ì œ ìˆ˜ê±° ë‹¹í•¨");

                        var preLender = Number(user.point);
                        user.point += collectAmt;
                        verifyPointTransaction(user, preLender, collectAmt, "ì‚¬ì±„ ì§ì ‘ ìˆ˜ê±° ìˆ˜ìµ");

                        contract.currentDebt -= collectAmt;
                        var footer = "ë‚¨ì€ ë¹š: " + fp(contract.currentDebt) + "P";
                        if (contract.currentDebt <= 0) {
                            delete roomData.loanContracts[state.extra.contractId];
                            footer = "í•´ë‹¹ ìœ ì €ì˜ ëª¨ë“  ì±„ë¬´ê°€ ë³€ì œë˜ì—ˆìŠµë‹ˆë‹¤.";
                        }

                        replier.reply(formatCommand("ğŸš¬ ì‚¬ì±„ ì§ì ‘ ìˆ˜ê±° ì™„ë£Œ", user, debtor.name + "ë‹˜ì˜ ì§€ê°‘ì—ì„œ " + fp(collectAmt) + "Pë¥¼ ìˆ˜ê±°í–ˆìŠµë‹ˆë‹¤.\n" + footer, "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
                        delete bankProcessState[targetUid];
                        safeSaveData(data);
                    }
                }
            }
        }
    }
}

//==========ì„¹í„°22-5==========

/* [ë…ë¦½í˜•] í†µí•© ì—…ë¬´ ì²˜ë¦¬ í•¸ë“¤ëŸ¬ (5ë‹¨ê³„: ìƒì  ì•„ì´í…œ êµ¬ë§¤ ì²˜ë¦¬) */
if (bankProcessState && bankProcessState[targetUid] && bankProcessState[targetUid].type === 'shop_buy') {
    var state = bankProcessState[targetUid];
    var roomData = data.rooms[roomName]; // ì‚¬ì±„ ì²´í¬ë¥¼ ìœ„í•´ roomData ì°¸ì¡°

    // 1. ì…ë ¥ ëŒ€ê¸° ì‹œê°„ ì´ˆê³¼ ê²€ì¦ (30ì´ˆ)
    if (Date.now() - state.time > 30000) {
        delete bankProcessState[targetUid];
    }
    // 2. ì‘ì—… ì·¨ì†Œ ì²˜ë¦¬
    else if (msg === "ì·¨ì†Œ") {
        delete bankProcessState[targetUid];
        replier.reply(formatCommand("ğŸš« ìƒì  êµ¬ë§¤ ì·¨ì†Œ", user, "ì•„ì´í…œ êµ¬ë§¤ë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤."));
    }
    else {
        /* [ê¸°ëŠ¥ 11] ìƒì  ì•„ì´í…œ êµ¬ë§¤ ì²˜ë¦¬ í•¸ë“¤ëŸ¬ */
        var idx = parseInt(msg) - 1;
        var filteredItems = (state.extra && state.extra.items) ? state.extra.items : [];

        // 1. ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬
        if (isNaN(idx) || idx < 0 || idx >= filteredItems.length) {
            replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "ëª©ë¡ì— ìˆëŠ” ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."));
        } else {
            var item = filteredItems[idx];

            /* [ìˆ˜ì •] ì‹ ìš© ì ìˆ˜ íšŒë³µì œ ì¼ì¼ ì œí•œ ì²´í¬ */
            if (item.effect === "credit" && (user.dailyCreditRestoreCount || 0) >= 1) {
                delete bankProcessState[targetUid];
                return replier.reply(formatError(user, "êµ¬ë§¤ ì œí•œ", "ì‹ ìš© ì ìˆ˜ íšŒë³µì œëŠ” í•˜ë£¨ì— 1ê°œë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤."));
            }

            /* [ì‹ ê·œ: Gemini ìš”ì²­ ì‚¬í•­] ê²½ê³ ì‚­ì œê¶Œ êµ¬ë§¤ ì œí•œ ë¡œì§ ì§‘í–‰ */
            if (item.effect === "warnClear") {
                // A. í‰ìƒ 1íšŒ êµ¬ë§¤ ì œí•œ ì²´í¬
                if (user.boughtWarningRemoval === true) {
                    delete bankProcessState[targetUid];
                    return replier.reply(formatError(user, "êµ¬ë§¤ ë¶ˆê°€", "ê²½ê³ ì‚­ì œê¶Œì€ í‰ìƒ ë‹¨ 1íšŒë§Œ êµ¬ë§¤í•  ìˆ˜ ìˆëŠ” í•œì • ë¬¼í’ˆì…ë‹ˆë‹¤."));
                }

                // B. ì‚¬ì±„ ë³´ìœ  ì—¬ë¶€ ì²´í¬ (ì‚¬ì±„ ì‹œì¥ ì—°ë™)
                var hasSache = false;
                if (roomData && roomData.loanContracts) {
                    for (var cid in roomData.loanContracts) {
                        if (roomData.loanContracts[cid].borrowerUid === targetUid) {
                            hasSache = true;
                            break;
                        }
                    }
                }
                if (hasSache) {
                    delete bankProcessState[targetUid];
                    return replier.reply(formatError(user, "êµ¬ë§¤ ì œí•œ", "í˜„ì¬ ì‚¬ì±„(P2P ëŒ€ì¶œ)ë¥¼ ì´ìš© ì¤‘ì…ë‹ˆë‹¤. ëª¨ë“  ì‚¬ì±„ë¥¼ ìƒí™˜í•œ í›„ì—ë§Œ êµ¬ë§¤ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤."));
                }
            }
            
            /* [ìˆ˜ì •] ë³µìˆ˜ êµ¬ë§¤ ê°€ëŠ¥ ì—¬ë¶€ íŒë³„ (ì†Œëª¨ì„± ì•„ì´í…œ ì¶”ì¶œ) */
            var stackableEffects = ["promotion", "tierGuard"];
            var isStackable = stackableEffects.indexOf(item.effect) !== -1;

            if (isStackable) {
                // ìˆ˜ëŸ‰ ì…ë ¥ ìƒíƒœ(shop_quantity)ë¡œ ì „í™˜
                bankProcessState[targetUid] = {
                    type: 'shop_quantity',
                    time: Date.now(),
                    extra: { item: item }
                };
                replier.reply(formatCommand("ğŸ”¢ ìˆ˜ëŸ‰ ì…ë ¥", user, "êµ¬ë§¤í•˜ì‹¤ [" + item.name + "]ì˜ ìˆ˜ëŸ‰ì„ ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
            } else {
                // ë‹¨ê¶Œ êµ¬ë§¤ ë¡œì§ (ì•„ì´ì½˜, ëœë¤ë°•ìŠ¤, ë¡œë˜, ê²½ê³ ì‚­ì œê¶Œ ë“±)
                var finalPrice = getItemPrice(item, user, roomName);
                var isUsingTicket = (item.effect === "randomBox" && (user.boxTickets || 0) > 0);

                // 2. ìì‚° ë³´ìœ  í™•ì¸
                if (!isUsingTicket && Number(user.point) < finalPrice) {
                    delete bankProcessState[targetUid];
                    replier.reply(formatError(user, "í¬ì¸íŠ¸ ë¶€ì¡±", fp(finalPrice) + "Pê°€ í•„ìš”í•©ë‹ˆë‹¤."));
                } else {
                    // 3. ì¤‘ë³µ ì†Œìœ  ì²´í¬ (ì•„ì´ì½˜/ì¹­í˜¸ ì „ìš©)
                    var hasItem = false;
                    if (item.effect === "icon" || item.effect === "title") {
                        var inv = user.inventory || [];
                        for (var i = 0; i < inv.length; i++) {
                            if (inv[i].id === item.id) { hasItem = true; break; }
                        }
                    }

                    if (hasItem) {
                        delete bankProcessState[targetUid];
                        replier.reply(formatError(user, "ì¤‘ë³µ ì†Œìœ ", "ì´ë¯¸ ë³´ìœ  ì¤‘ì¸ ì•„ì´í…œì…ë‹ˆë‹¤."));
                    } else {
                        // [ìˆ˜ì •] ê²Œì„ ì¸ì¦ê¶Œ ì‹œì¦Œ í•œë„ ì²´í¬
                        if (item.effect === "gameAuth" && (user.purchasedAuthCount || 0) >= 2) {
                            delete bankProcessState[targetUid];
                            return replier.reply(formatError(user, "êµ¬ë§¤ í•œë„ ì´ˆê³¼", "ì¸ì¦ê¶Œì€ ì‹œì¦Œë‹¹ ìµœëŒ€ 2íšŒê¹Œì§€ë§Œ êµ¬ë§¤ ê°€ëŠ¥í•©ë‹ˆë‹¤."));
                        }

                        // 4. í¬ì¸íŠ¸ ì°¨ê° ë° ì‹¤ì‹œê°„ ê²€ì¦
                        if (!isUsingTicket) {
                            var preP = Number(user.point);
                            user.point -= finalPrice;
                            util_updatePoint(user, roomData, -finalPrice, "ìƒì  êµ¬ë§¤: " + item.name, roomName);
                        }

                        // 5. ìƒíƒœ ì´ˆê¸°í™” í›„ ë‹¨ê¶Œ(qty:1) íš¨ê³¼ ì‹¤í–‰
                        delete bankProcessState[targetUid];
                        if (typeof _handleShopEffect === 'function') {
                            _handleShopEffect(item, user, roomName, replier, data, targetUid, finalPrice, isUsingTicket, 1);
                        }
                        safeSaveData(data);
                    }
                }
            }
        }
    }
}

/* ë³µìˆ˜ ìˆ˜ëŸ‰ ì…ë ¥ ì²˜ë¦¬ í•¸ë“¤ëŸ¬ (ê¸°ì¡´ ìœ ì§€) */
else if (bankProcessState && bankProcessState[targetUid] && bankProcessState[targetUid].type === 'shop_quantity') {
    var state = bankProcessState[targetUid];
    var item = state.extra.item;

    if (Date.now() - state.time > 30000) {
        delete bankProcessState[targetUid];
    } else if (msg === "ì·¨ì†Œ") {
        delete bankProcessState[targetUid];
        replier.reply(formatCommand("ğŸš« êµ¬ë§¤ ì·¨ì†Œ", user, "ì•„ì´í…œ êµ¬ë§¤ë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤."));
    } else {
        var qty = parseInt(msg.replace(/[^0-9]/g, ""));
        if (isNaN(qty) || qty <= 0) {
            replier.reply(formatError(user, "ì…ë ¥ ì˜¤ë¥˜", "êµ¬ë§¤í•  ìˆ˜ëŸ‰ì„ ìˆ«ìë¡œ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”."));
        } else {
            var unitPrice = getItemPrice(item, user, roomName);
            var totalPrice = unitPrice * qty;

            if (Number(user.point) < totalPrice) {
                replier.reply(formatError(user, "í¬ì¸íŠ¸ ë¶€ì¡±", "ì´ " + fp(totalPrice) + "Pê°€ í•„ìš”í•©ë‹ˆë‹¤. (ë³´ìœ : " + fp(user.point) + "P)"));
            } else {
                var preP = Number(user.point);
                user.point -= totalPrice;
                verifyPointTransaction(user, preP, -totalPrice, "ìƒì  êµ¬ë§¤: " + item.name + " x" + qty, roomName, totalPrice);
                
                delete bankProcessState[targetUid];
                if (typeof _handleShopEffect === 'function') {
                    _handleShopEffect(item, user, roomName, replier, data, targetUid, totalPrice, false, qty);
                }
                safeSaveData(data);
            }
        }
    }
}

//==========ì„¹í„°23-1==========

/* [ì„¹í„° í†µí•© ìˆ˜ì •] ë„ì›€ë§ ë° ë©”ë‰´ ì„ íƒ ëŒ€ê¸° ì²˜ë¦¬ (ê³µí†µ í•¸ë“¤ëŸ¬ ë° 1ë‹¨ê³„) */
if (menuWaitState && menuWaitState[targetUid]) {
    var state = menuWaitState[targetUid];
    var roomData = data.rooms[roomName];
    
    // ì¤‘ì•™ì€í–‰ ì¬ì› ì´ˆê¸°í™” (UI ì¶œë ¥ìš©)
    if (roomData.bankReserve === undefined) roomData.bankReserve = 10000;

    // 1. ê³µí†µ: ì‹œê°„ ì´ˆê³¼ ì²´í¬
    if (Date.now() - state.time > 30000) { 
        delete menuWaitState[targetUid]; 
    } 
    // 2. ê³µí†µ: ì·¨ì†Œ ìš”ì²­ ì²´í¬
    else if (msg === "ì·¨ì†Œ") {
        delete menuWaitState[targetUid];
        replier.reply(formatCommand("ğŸš« ë©”ë‰´ ì„ íƒ ì·¨ì†Œ", user, "ì‘ì—…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."));
    }
    // 3. ê° ë©”ë‰´ë³„ ë¡œì§ ì²˜ë¦¬
    else {
        var choice = msg.trim();
        
        /* [1ë‹¨ê³„] ì€í–‰ ë©”ì¸ ë©”ë‰´ ì„ íƒ ì²˜ë¦¬ (v5.2 ê¸°ë¶€ ì„ íƒ ì¶”ê°€) */
        if (state.type === 'bank_menu') {
             if (choice === "1") { 
                bankProcessState[targetUid] = { type: 'deposit', time: Date.now() };
                replier.reply(formatCommand("ğŸ’° ì˜ˆê¸ˆ ì§„í–‰", user, "ì˜ˆê¸ˆí•  ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(ë³´ìœ : " + fP(user.point) + "P)", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
                delete menuWaitState[targetUid];
             } else if (choice === "2") { 
                bankProcessState[targetUid] = { type: 'withdraw', time: Date.now() };
                replier.reply(formatCommand("ğŸ§ ì¶œê¸ˆ ì§„í–‰", user, "ì¶œê¸ˆí•  ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(ì”ê³ : " + fp(user.bank) + "P)", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
                delete menuWaitState[targetUid];
             } else if (choice === "3") { 
                bankProcessState[targetUid] = { type: 'transfer', time: Date.now() };
                replier.reply(formatCommand("ğŸ’¸ ì†¡ê¸ˆ ì§„í–‰", user, "ë°›ì„ ì‚¬ëŒì˜ [ë‹‰ë„¤ì„]ê³¼ [ê¸ˆì•¡]ì„ ë„ì–´ì“°ê¸°ë¡œ ì…ë ¥í•˜ì„¸ìš”.\n(ì˜ˆ: í™ê¸¸ë™ 5000)", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
                delete menuWaitState[targetUid];
             } else if (choice === "4") { 
                var cr = getCreditInfo(user.creditScore);
                if (cr.limit <= 0) { 
                    delete menuWaitState[targetUid]; 
                    replier.reply(formatError(user, "ëŒ€ì¶œ ë¶ˆê°€", "ì‹ ìš©ë“±ê¸‰ì´ ë„ˆë¬´ ë‚®ìŠµë‹ˆë‹¤.")); 
                }
                else {
                    bankProcessState[targetUid] = { type: 'loan', time: Date.now() };
                    var loanMsg = "í¬ë§ ëŒ€ì¶œê¸ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n" +
                                  "ë‚´ í•œë„: " + fp(cr.limit) + "P (ì´ìœ¨: " + ((cr.rate-1)*100).toFixed(0) + "%)\n" +
                                  "ğŸ¦ ì€í–‰ ê°€ìš© ì¬ì›: " + fp(roomData.bankReserve) + "P";
                    replier.reply(formatCommand("ğŸ¦ ëŒ€ì¶œ ì§„í–‰", user, loanMsg, "ì·¨ì†Œ: [ì·¨ì†Œ]"));
                    delete menuWaitState[targetUid];
                }
             } else if (choice === "5") { 
                if (!user.loan || user.loan.debt <= 0) { 
                    delete menuWaitState[targetUid]; 
                    replier.reply(formatError(user, "ìƒí™˜ ë¶ˆê°€", "ê°šì„ ëŒ€ì¶œê¸ˆì´ ì—†ìŠµë‹ˆë‹¤.")); 
                }
                else {
                    bankProcessState[targetUid] = { type: 'repay', time: Date.now() };
                    replier.reply(formatCommand("ğŸ“‰ ìƒí™˜ ì§„í–‰", user, "ìƒí™˜í•  ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(ëŒ€ì¶œ ì”ì•¡: " + fp(user.loan.debt) + "P)\në³´ìœ  í¬ì¸íŠ¸: " + fp(user.point) + "P", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
                    delete menuWaitState[targetUid];
                }
             } 
             else if (choice === "6") {
                menuWaitState[targetUid] = { type: 'p2p_loan_menu', time: Date.now() };
                var p2pMenu = "1. ğŸ’° ì‚¬ì±„ ë“±ë¡ (ë§¤ë¬¼ ì˜¬ë¦¬ê¸°)\n" +
                              "2. ğŸ“‹ ì‚¬ì±„ ëª©ë¡ (ë¶„í•  ëŒ€ì¶œ ë°›ê¸°)\n" +
                              "3. ğŸ“‰ ì‚¬ì±„ ìƒí™˜ (ë¹Œë¦° ëˆ ê°šê¸°)\n" +
                              "4. ğŸ“¥ ì‚¬ì±„ íšŒìˆ˜ (ë“±ë¡ ë§¤ë¬¼ íšŒìˆ˜)\n" +
                              "5. ğŸ‘¥ ë‚´ ì±„ë¬´ì í˜„í™© (ì§ì ‘ ìˆ˜ê±° ê°€ëŠ¥)";
                replier.reply(formatCommand("ğŸš¬ ì‚¬ì±„ ì‹œì¥ ì—…ë¬´ ì„ íƒ", user, p2pMenu, "ì›í•˜ì‹œëŠ” ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
                return;  
             }
             /* [ì‹ ê·œ] 7ë²ˆ ê¸°ë¶€ ë©”ë‰´ ì²˜ë¦¬ */
             else if (choice === "7") {
                bankProcessState[targetUid] = { type: 'donate', time: Date.now() };
                replier.reply(formatCommand("ğŸ ê¸°ë¶€ ì§„í–‰", user, "ê¸°ë¶€í•  ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(ë³´ìœ : " + fP(user.point) + "P)", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
                delete menuWaitState[targetUid];
             }
        }
    }
}

//==========ì„¹í„°23-2==========

/* [2ë‹¨ê³„] ì‚¬ì±„ ì‹œì¥ ì„œë¸Œ ë©”ë‰´ ì„ íƒ ì²˜ë¦¬ (ë…ë¦½í˜•) */
if (menuWaitState && menuWaitState[targetUid]) {
    var state = menuWaitState[targetUid];
    var choice = msg.trim();

    if (state.type === 'p2p_loan_menu') {
        if (choice === "1") {
            bankProcessState[targetUid] = { type: 'p2p_reg_input', time: Date.now() };
            replier.reply(formatCommand("ğŸ’° ì‚¬ì±„ ë§¤ë¬¼ ë“±ë¡", user, "ë“±ë¡í•  [ê¸ˆì•¡]ê³¼ [ì´ìœ¨]ì„ ì…ë ¥í•˜ì„¸ìš”.\n(ì˜ˆ: 10000 5)", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
        } 
        else if (choice === "2") {
            var pools = Object.keys(roomData.loanPools || {});
            if (pools.length === 0) { 
                replier.reply(formatSimple("ğŸ“‹ ì‚¬ì±„ ì‹œì¥", "í˜„ì¬ ì´ ë°©ì— ë“±ë¡ëœ ë§¤ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.", null));
            } else {
                var list = [];
                var tempPools = [];
                for(var i=0; i<pools.length; i++) {
                    var p = roomData.loanPools[pools[i]];
                    list.push((i+1) + ". [" + p.lenderName + "] ì”ì—¬: " + fp(p.remainingAmount) + "P (ì´ì " + p.rate + "%/3h)");
                    tempPools.push(pools[i]);
                }
                menuWaitState[targetUid] = { type: 'p2p_select_pool', time: Date.now(), extra: { pools: tempPools } };
                return replier.reply(formatCommand("ğŸ“‹ ì‚¬ì±„ ë§¤ë¬¼ ëª©ë¡", user, list.join("\n"), "ë¹Œë¦¬ê³  ì‹¶ì€ ë§¤ë¬¼ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
            }
        }
        else if (choice === "3") {
            var myContracts = [];
            if (roomData.loanContracts) {
                for(var id in roomData.loanContracts) {
                    if(roomData.loanContracts[id].borrowerUid === targetUid) myContracts.push({ id: id, data: roomData.loanContracts[id] });
                }
            }
            if (myContracts.length === 0) return replier.reply(formatError(user, "ë‚´ì—­ ì—†ìŒ", "í˜„ì¬ ì´ ë°©ì—ì„œ ë¹Œë ¤ ì“°ê³  ìˆëŠ” ì‚¬ì±„ê°€ ì—†ìŠµë‹ˆë‹¤."));
            
            var list = [];
            for(var i=0; i<myContracts.length; i++) {
                var c = myContracts[i].data;
                list.push((i+1) + ". [" + c.lenderName + "] ì±„ë¬´ì•¡: " + fp(c.currentDebt) + "P (ì´ìœ¨ " + c.rate + "%)");
            }
            menuWaitState[targetUid] = { type: 'p2p_select_repay', time: Date.now(), extra: { contracts: myContracts.map(x => x.id) } };
            return replier.reply(formatCommand("ğŸ“‰ ì‚¬ì±„ ìƒí™˜ ì„ íƒ", user, list.join("\n"), "ê°šì„ ì‚¬ì±„ì˜ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”."));
        }
        else if (choice === "4") {
            var myPools = [];
            if (roomData.loanPools) {
                for(var id in roomData.loanPools) {
                    if(roomData.loanPools[id].lenderUid === targetUid) myPools.push({ id: id, data: roomData.loanPools[id] });
                }
            }
            if (myPools.length === 0) return replier.reply(formatError(user, "ë‚´ì—­ ì—†ìŒ", "ì´ ë°©ì— ì˜¬ë ¤ë‘” ì‚¬ì±„ í’€ì´ ì—†ìŠµë‹ˆë‹¤."));

            var list = [];
            for(var i=0; i<myPools.length; i++) {
                var p = myPools[i].data;
                list.push((i+1) + ". ì”ì—¬: " + (p.remainingAmount) + "P (ì´ìœ¨ " + p.rate + "%/3h)");
            }
            menuWaitState[targetUid] = { type: 'p2p_select_withdraw', time: Date.now(), extra: { pools: myPools.map(x => x.id) } };
            return replier.reply(formatCommand("ğŸ“¥ ì‚¬ì±„ í’€ íšŒìˆ˜", user, list.join("\n"), "íšŒìˆ˜í•  ì‚¬ì±„ í’€ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”."));
        }
        else if (choice === "5") {
            var myDebtors = [];
            if (roomData.loanContracts) {
                for(var id in roomData.loanContracts) {
                    if(roomData.loanContracts[id].lenderUid === targetUid) myDebtors.push({ id: id, data: roomData.loanContracts[id] });
                }
            }
            if (myDebtors.length === 0) return replier.reply(formatSimple("ğŸ‘¥ ë‚´ ì±„ë¬´ì í˜„í™©", "í˜„ì¬ ëˆì„ ë¹Œë ¤ ê°„ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.", null));

            var list = [];
            var tempContracts = [];
            for(var i=0; i<myDebtors.length; i++) {
                var d = myDebtors[i].data;
                var status = (Date.now() - d.startTime > 24*60*60*1000) ? " (ğŸš¨ì—°ì²´)" : "";
                list.push((i+1) + ". [" + d.borrowerName + "] ë¹š: " + fp(d.currentDebt) + "P" + status);
                tempContracts.push(myDebtors[i].id);
            }
            menuWaitState[targetUid] = { type: 'p2p_select_collect', time: Date.now(), extra: { contracts: tempContracts } };
            replier.reply(formatCommand("ğŸ‘¥ ë‚´ ì±„ë¬´ì ëª…ë‹¨", user, list.join("\n"), "ê°•ì œ ìˆ˜ê±°ë¥¼ ì›í•˜ì‹œë©´ ìœ ì € ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
            return;
        }
        delete menuWaitState[targetUid]; return;
    }
}

//==========ì„¹í„°23-3==========

/* [3ë‹¨ê³„] ì‚¬ì±„ ëª©ë¡ ì„ íƒ ì²˜ë¦¬ (ë…ë¦½í˜•) */
if (menuWaitState && menuWaitState[targetUid]) {
    var state = menuWaitState[targetUid];
    var choice = msg.trim();

    if (state.type === 'p2p_select_pool') {
        var idx = parseInt(choice) - 1;
        var poolId = state.extra.pools[idx];
        if (!poolId) return replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜"));
        
        bankProcessState[targetUid] = { type: 'p2p_borrow_amt', time: Date.now(), extra: { poolId: poolId } };
        replier.reply(formatCommand("ğŸ’° ì‚¬ì±„ ê¸ˆì•¡ ì„¤ì •", user, "ì„ íƒ ë§¤ë¬¼: [" + roomData.loanPools[poolId].lenderName + "]\nì”ì—¬ ê¸ˆì•¡: " + fp(roomData.loanPools[poolId].remainingAmount) + "P\n\në¹Œë¦´ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
        delete menuWaitState[targetUid]; return;
    }

    else if (state.type === 'p2p_select_repay') {
        var idx = parseInt(choice) - 1;
        var contractId = state.extra.contracts[idx];
        if (!contractId) return replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜"));

        bankProcessState[targetUid] = { type: 'p2p_repay_amt', time: Date.now(), extra: { contractId: contractId } };
        
        /* [ìˆ˜ì •] ìƒí™˜ ì…ë ¥ì°½ì— í˜„ì¬ ë³´ìœ  í¬ì¸íŠ¸ í‘œì‹œ ì¶”ê°€ */
        var currentDebt = roomData.loanContracts[contractId].currentDebt;
        var lenderName = roomData.loanContracts[contractId].lenderName;
        
        replier.reply(formatCommand("ğŸ“‰ ì‚¬ì±„ ìƒí™˜ì•¡ ì…ë ¥", user, 
            "ì„ íƒ ê³„ì•½: [" + lenderName + "]\n" +
            "ê°šì•„ì•¼ í•  ëˆ: " + fp(currentDebt) + "P\n" +
            "ğŸ’° ë³´ìœ  í¬ì¸íŠ¸: " + fp(user.point) + "P\n\n" +
            "ê°šì„ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.", 
            "ì·¨ì†Œ: [ì·¨ì†Œ]"
        ));
        delete menuWaitState[targetUid]; return;
    }

    else if (state.type === 'p2p_select_withdraw') {
        var idx = parseInt(choice) - 1;
        var poolId = state.extra.pools[idx];
        if (!poolId) return replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜"));

        bankProcessState[targetUid] = { type: 'p2p_withdraw_amt', time: Date.now(), extra: { poolId: poolId, max: roomData.loanPools[poolId].remainingAmount } };
        replier.reply(formatCommand("ğŸ“¥ íšŒìˆ˜ ê¸ˆì•¡ ì…ë ¥", user, "í˜„ì¬ í’€ ì”ì•¡: " + fp(roomData.loanPools[poolId].remainingAmount) + "P\n\níšŒìˆ˜í•  ê¸ˆì•¡ì„ ì…ë ¥í•˜ê±°ë‚˜ [ì „ì•¡]ì„ ì…ë ¥í•˜ì„¸ìš”.", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
        delete menuWaitState[targetUid]; return;
    }

    else if (state.type === 'p2p_select_collect') {
        var idx = parseInt(choice) - 1;
        var contractId = state.extra.contracts[idx];
        if (!contractId) return replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜"));

        bankProcessState[targetUid] = { type: 'p2p_collect_manual', time: Date.now(), extra: { contractId: contractId } };
        replier.reply(formatCommand("ğŸš¬ ì‚¬ì±„ ê°•ì œ ìˆ˜ê±° í™•ì¸", user, "[" + roomData.loanContracts[contractId].borrowerName + "]ë‹˜ì˜ ì§€ê°‘ì—ì„œ ìì‚°ì„ ìˆ˜ê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì§„í–‰í•˜ì‹œë ¤ë©´ ì•„ë¬´ ë©”ì‹œì§€ë‚˜ ì…ë ¥í•´ì£¼ì„¸ìš”.", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
        delete menuWaitState[targetUid]; return;
    }
}

//==========ì„¹í„°23-4==========

/* [4ë‹¨ê³„] ìƒì  ë° ë„ì›€ë§ ì²˜ë¦¬ (ë…ë¦½í˜•) */
if (menuWaitState && menuWaitState[targetUid]) {
    var state = menuWaitState[targetUid];
    var choice = msg.trim();

    if (state.type === 'shop_category') {
        var catId = parseInt(choice);
        if (isNaN(catId) || !SHOP_CATEGORIES[catId]) {
            return replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "ì˜¬ë°”ë¥¸ ì¹´í…Œê³ ë¦¬ ë²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."));
        }

        // ì„ íƒëœ ì¹´í…Œê³ ë¦¬ì— í•´ë‹¹í•˜ëŠ” ì•„ì´í…œë§Œ í•„í„°ë§
        var filteredItems = [];
        for (var i = 0; i < SHOP_ITEMS.length; i++) {
            if (SHOP_ITEMS[i].cat === catId) filteredItems.push(SHOP_ITEMS[i]);
        }

        if (filteredItems.length === 0) {
            return replier.reply(formatSimple("ğŸ›’ ìƒì  ì•Œë¦¼", "í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì— ì¤€ë¹„ëœ ë¬¼í’ˆì´ ì—†ìŠµë‹ˆë‹¤.", "ë‹¤ë¥¸ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”."));
        }

        var list = [];
        for (var j = 0; j < filteredItems.length; j++) {
            var item = filteredItems[j];
            var currentPrice = getItemPrice(item, user, roomName); 
            list.push((j + 1) + ". " + item.icon + " " + item.name + " : " + fp(currentPrice) + "P");
        }

        // êµ¬ë§¤ ëŒ€ê¸° ìƒíƒœë¡œ ì „ì´ (í•„í„°ë§ëœ ë¦¬ìŠ¤íŠ¸ ì „ë‹¬)
        bankProcessState[targetUid] = { 
            type: 'shop_buy', 
            time: Date.now(), 
            extra: { items: filteredItems } 
        };

        delete menuWaitState[targetUid];
        return replier.reply(formatCommand("ğŸ›’ " + SHOP_CATEGORIES[catId], user, list.join("\n"), "êµ¬ë§¤í•  ë¬¼í’ˆì˜ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
    }

    /* ë„ì›€ë§ ë©”ë‰´ ì²˜ë¦¬ */
    else if (state.type === 'help') {
        var helpBody = ""; var next = "";
        var targetCat = "";
        
        if (choice === "1") { targetCat = "ì¡°íšŒ"; next = "ë‚´ ì •ë³´ í™•ì¸: [/ë‚´ì •ë³´]"; }
        else if (choice === "2") { targetCat = "ê²Œì„"; next = "ìŠ¹ê¸‰ ë„ì „: [/ìŠ¹ê¸‰]"; }
        else if (choice === "3") { targetCat = "ìƒì "; next = "ìƒì  í™•ì¸: [/ìƒì ]"; }
        else if (choice === "4") { targetCat = "ê²½ì œ"; next = "ì€í–‰ ë° ì‚¬ì±„ ë©”ë‰´: [/ì€í–‰]"; }
        else if (choice === "5") { targetCat = "ì£¼ì‹"; next = "ì‹œì„¸ í™•ì¸: [/ì£¼ì‹]"; }
        else if (choice === "6") { targetCat = "ê´‘ì‚°"; next = "ì±„êµ´ ì‹œì‘: [/ê´‘ì‚°ì‹œì‘]"; }
        
        if (targetCat !== "") {
            var list = [];
            for(var i=0; i<CMD_LIST.user.length; i++) {
                var c = CMD_LIST.user[i];
                if(c.cat === targetCat) list.push("â€¢ " + c.cmd + ": " + c.desc);
            }
            helpBody = list.join("\n");
        } else if (choice === "7" && isAdmin(sender, data)) {
            var list = [];
            for(var i=0; i<CMD_LIST.admin.length; i++) {
                var a = CMD_LIST.admin[i];
                list.push((i+1) + ". " + a.cmd + " " + a.desc);
            }
            helpBody = "âš™ï¸ [ê´€ë¦¬ì ì „ìš© ëª…ë ¹ì–´]\n" + list.join("\n"); 
            next = "ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ì‹ ì¤‘íˆ ì‚¬ìš©í•˜ì„¸ìš”.";
        }
        
        if (helpBody !== "") { 
            delete menuWaitState[targetUid]; 
            return replier.reply(formatCommand("ğŸ“– ìƒì„¸ ë„ì›€ë§", null, helpBody, next)); 
        }
    }

    /* [Gemini ìš”ì²­ ì‚¬í•­] ê°€ì´ë“œ ë©”ë‰´ ì²˜ë¦¬ ë¡œì§ ì¶”ê°€ */
    else if (state.type === 'guide_menu') {
        var guideBody = "";
        var guideTitle = "";

        if (choice === "1") {
            guideTitle = "ğŸ›ï¸ ì¤‘ì•™ì€í–‰ ë° ì‹ ìš© ê²½ì œ";
            guideBody = "â€¢ ì¤‘ì•™ì€í–‰ ì¬ì›: ìƒì  ìˆ˜ìµ, ë„ë°• íŒ¨ë°°ê¸ˆ ë“±ì´ ê¸ˆê³ ë¡œ ì ë¦½ë©ë‹ˆë‹¤.\n" +
                        "â€¢ ì§€ê¸‰ì¤€ë¹„ì œë„: ì´ ì˜ˆê¸ˆì˜ 20%ëŠ” ëŒ€ì¶œ ë¶ˆê°€í•œ ì¤€ë¹„ê¸ˆì…ë‹ˆë‹¤. ê¸ˆê³  ê³ ê°ˆ ì‹œ ì¶œê¸ˆì´ ì œí•œë©ë‹ˆë‹¤.\n" +
                        "â€¢ ìë™ ìƒí™˜: ë¹š ë³´ìœ  ì‹œ ìˆ˜ìµì˜ ì¼ë¶€ê°€ ê°•ì œ ìƒí™˜ë©ë‹ˆë‹¤.\n" +
                        "  (ì€í–‰ëŒ€ì¶œ 30% / ì‹ ë¶ˆÂ·ì‚¬ì±„ 50% / ëŒ€í™˜ 70%)";
        }
        else if (choice === "2") {
            guideTitle = "ğŸ‡ ì¤‘ì•™ ê²½ë§ˆ ì‹œìŠ¤í…œ";
            guideBody = "â€¢ ë°°íŒ…: ë§¤ì‹œ 00~49ë¶„ ì°¸ì—¬, ì •ê°ì— ê²°ê³¼ ë°œí‘œ ë° ì •ì‚°.\n" +
                        "â€¢ ë‹¹ì²¨ê¸ˆ: 10% êµ­ê³  ìˆ˜ìˆ˜ë£Œ ì œì™¸ í›„ ì§€ë¶„ë§Œí¼ ë¶„í•  ì§€ê¸‰.\n" +
                        "â€¢ í•˜í•œ ë³´ì¥: ë‹¹ì²¨ ì‹œ ë°°íŒ…ì•¡ì˜ ìµœì†Œ 3ë°° ë°°ë‹¹ì„ ì€í–‰ì´ ë³´ì „í•´ë“œë¦½ë‹ˆë‹¤.\n" +
                        "â€¢ ìƒí•œ ì œí•œ: ë…ì  ë°©ì§€ë¥¼ ìœ„í•´ ë°°íŒ…ì•¡ì˜ ìµœëŒ€ 10ë°°ê¹Œì§€ë§Œ ìˆ˜ë ¹ ê°€ëŠ¥í•©ë‹ˆë‹¤.\n" +
                        "â€¢ ì´ì›”: ë¬´ìŠ¹ì ë°œìƒ ì‹œ íŒëˆì˜ 70%ê°€ ì­íŒŸìœ¼ë¡œ í•©ì‚° ì´ì›”ë©ë‹ˆë‹¤.";
        }
        else if (choice === "3") {
            guideTitle = "ğŸ“ˆ ì£¼ì‹ ë° íˆ¬ì";
            guideBody = "â€¢ ìš´ì˜: 07:00 ~ 23:59 (10ë¶„ë§ˆë‹¤ ë³€ë™)\n" +
                        "â€¢ ì„¸ê¸ˆ: ë§¤ë„ ì‹œ íŒë§¤ ê¸ˆì•¡ì˜ 5%ê°€ êµ­ì„¸ë¡œ ìë™ ì°¨ê°ë©ë‹ˆë‹¤.\n" +
                        "â€¢ ìƒí: ì£¼ê°€ê°€ ê¸°ì¤€ê°€ ì´í•˜ë¡œ í­ë½ ì‹œ âš ï¸ í‘œì‹œê°€ ëœ¨ë©°, ì§€ì†ë  ê²½ìš° ìƒì¥ íì§€(0P) ë©ë‹ˆë‹¤.";
        }
        else if (choice === "4") {
            guideTitle = "ğŸ° ë¡œë˜ ë° ë„ë°•";
            guideBody = "â€¢ ë¡œë˜: 1~15 ì¤‘ 3ê°œ ìˆ«ì. 22ì‹œ ì¶”ì²¨. 1ë“± ë‹¹ì²¨ê¸ˆì€ ë‹¹ì²¨ì ì—†ì„ ì‹œ ë§¤ì¼ ë¬´ì œí•œ ì´ì›”ë©ë‹ˆë‹¤.\n" +
                        "â€¢ í™€ì§: ê¸°ë³¸ ë°°ë‹¹ 1.9ë°°. [í”¼ë²„íƒ€ì„] ë°œë™ ì‹œ 5ë¶„ê°„ ìŠ¹ë¥  ë³´ë„ˆìŠ¤ê°€ ì ìš©ë©ë‹ˆë‹¤.";
        }
        else if (choice === "5") {
            guideTitle = "â›ï¸ í™œë™ ë° ìˆ˜ìµ";
            guideBody = "â€¢ ê´‘ì‚°: ë°©ì¹˜í˜• ìˆ˜ìµí˜• í™œë™. ì±„ë¬´ ë³´ìœ  ì‹œ ê·¼ë¡œ ì˜ìš• ê³ ì·¨ë¡œ íš¨ìœ¨ì´ 1.5ë°° ìƒìŠ¹í•©ë‹ˆë‹¤.\n" +
                        "â€¢ ìœ ë¬¼: ì±„êµ´ ì¤‘ 0.1% í™•ë¥ ë¡œ ë°œê²¬. ì¡°ê° ìˆ˜ì§‘ëŸ‰ì— ë”°ë¼ [ë„êµ´ì™•] ë“± 5ë‹¨ê³„ ì¹­í˜¸ê°€ ë¶€ì—¬ë©ë‹ˆë‹¤.\n" +
                        "â€¢ ë„ë‘‘ì§ˆ: íƒ€ì¸ ìì‚° 10% ê°•íƒˆ. [ì¡ì•˜ë‹¤ìš”ë†ˆ] ëŒ€ì‘ ì‹œ ë²Œê¸ˆ ë° ê°ì˜¥ 1ì‹œê°„ì´ ë¶€ê³¼ë©ë‹ˆë‹¤.";
        }
        else if (choice === "6") {
            guideTitle = "ğŸ ë¯¼ìƒ ì§€ì› ë° ë³µì§€";
            guideBody = "â€¢ ì§€ì›ê¸ˆ: ì‹¤ì§ˆ ìˆœìì‚°ì´ í‰ê· ì˜ 40% ë¯¸ë§Œì¸ ì„œë¯¼ ìœ ì €ì—ê²Œ í•˜ë£¨ í•œ ë²ˆ ì§€ê¸‰ë©ë‹ˆë‹¤.\n" +
                        "â€¢ ìì‚°ê°€ ì¹­í˜¸: ì´ ìì‚°(ê°€ìš©+ì£¼ì‹+ì±„ê¶Œ-ë¶€ì±„) ëŒíŒŒ ì‹œ ì¬ë²Œ, ê±°ìƒ ë“± ì˜êµ¬ ì†Œì¥ ì¹­í˜¸ë¥¼ íšë“í•©ë‹ˆë‹¤.";
        }

        if (guideBody !== "") {
            delete menuWaitState[targetUid];
            return replier.reply(formatCommand("ğŸ“” " + guideTitle, null, guideBody, "ë‹«ê¸°: [ì·¨ì†Œ]"));
        }
    }
}

/* [í•µì‹¬] ë„ì›€ë§ ëª…ë ¹ì–´ (ë…ë¦½ ì‹¤í–‰ ë³´ì¥ ìœ„ì¹˜) */
if (msg === "/ë„ì›€ë§") {
    menuWaitState[targetUid] = { type: 'help', time: Date.now() };
    var menu = "1. ğŸ‘¤ ì¡°íšŒ ë° ì •ë³´\n2. ğŸ® ê²Œì„ ë° í™œë™\n3. ğŸ›’ ìƒì  ë° ì•„ì´í…œ\n4. ğŸ¦ ì€í–‰ ë° ì‚¬ì±„\n5. ğŸ“ˆ ì£¼ì‹ íˆ¬ì\n6. â›ï¸ ê´‘ì‚° ì±„êµ´ (ë°©ì¹˜í˜•)\n";
    if (isAdmin(sender, data)) menu += "7. âš™ï¸ ê´€ë¦¬ì ê¸°ëŠ¥\n";
    replier.reply(formatCommand("ğŸ“– ë‚´ë¦¬ë‹¤ë´‡ ë„ì›€ë§", null, "ì›í•˜ì‹œëŠ” ë©”ë‰´ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.\n\n" + menu, "ì…ë ¥ ëŒ€ê¸°: 30ì´ˆ"));
    return;
}

/* [Gemini ìš”ì²­ ì‚¬í•­] ê°€ì´ë“œ ëª…ë ¹ì–´ ì¶”ê°€ */
if (msg === "/ê°€ì´ë“œ") {
    menuWaitState[targetUid] = { type: 'guide_menu', time: Date.now() };
    var guideMenu = "1. ğŸ›ï¸ ì¤‘ì•™ì€í–‰ ë° ì‹ ìš© ê²½ì œ\n2. ğŸ‡ ì¤‘ì•™ ê²½ë§ˆ ì‹œìŠ¤í…œ\n3. ğŸ“ˆ ì£¼ì‹ ë° íˆ¬ì\n4. ğŸ° ë¡œë˜ ë° ë„ë°•\n5. â›ï¸ í™œë™ ë° ìˆ˜ìµ\n6. ğŸ ë¯¼ìƒ ì§€ì› ë° ë³µì§€\n";
    replier.reply(formatCommand("ğŸ“” ë‚´ë¦¬ë‹¤ë´‡ ë§ˆìŠ¤í„° ê°€ì´ë“œ", null, "ìƒì„¸ ë‚´ìš©ì„ ë³´ê³  ì‹¶ì€ í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.\n\n" + guideMenu, "ì…ë ¥ ëŒ€ê¸°: 30ì´ˆ"));
    return;
}

//==========ì„¹í„°24==========

        /* [ìµœì í™”] ê²Œì„ ë° ê²½ì œ í™œë™ ëª…ë ¹ì–´ í†µí•© ì²˜ë¦¬ êµ¬ê°„ */
        /* ë©”ì¸ í•¨ìˆ˜ì˜ ìš©ëŸ‰ ì´ˆê³¼(64KB) ë°©ì§€ë¥¼ ìœ„í•´ ì™¸ë¶€ í•¨ìˆ˜ë¡œ ìœ„ì„ */
        /* ì„¹í„° 24~36ì— ìˆë˜ ëª¨ë“  ë¡œì§ì„ _handleGameLogic í•¨ìˆ˜ë¡œ ì´ê´€í•©ë‹ˆë‹¤. */
        
        // _handleGameLogic í•¨ìˆ˜ê°€ ì¡´ì¬í•˜ê³ , í•´ë‹¹ í•¨ìˆ˜ì—ì„œ ëª…ë ¹ì–´ë¥¼ ì²˜ë¦¬í–ˆë‹¤ë©´(true ë°˜í™˜) ì¦‰ì‹œ ì¢…ë£Œ
        if (typeof _handleGameLogic === 'function') {
            if (_handleGameLogic(msg, user, data, replier, roomName, targetUid, sender)) return;
        }

//==========ì„¹í„°25==========

        /* [ìµœì í™”] ê´€ë¦¬ì ëª…ë ¹ì–´ í†µí•© ì²˜ë¦¬ êµ¬ê°„ */
        /* ë©”ì¸ í•¨ìˆ˜ì˜ ìš©ëŸ‰ ì´ˆê³¼(64KB) ë°©ì§€ë¥¼ ìœ„í•´ ì™¸ë¶€ í•¨ìˆ˜ë¡œ ìœ„ì„ */
        if (isAdmin(sender, data)) {
            if (typeof _handleAdminLogic === 'function') {
                // ê´€ë¦¬ì ë¡œì§ í•¨ìˆ˜ê°€ trueë¥¼ ë°˜í™˜í•˜ë©´(ëª…ë ¹ì–´ ì²˜ë¦¬ë¨) í•¨ìˆ˜ ì¢…ë£Œ
                if (_handleAdminLogic(msg, user, data, replier, roomName, targetUid, sender)) return;
            }
        }

//==========ì„¹í„°26==========

    } catch (e) {
        Log.error("Thread Runtime Error: " + e);
        if (lock.isLocked()) {
            try {
                lock.unlock();
            } catch(err) {
                Log.error("Lock Release Error: " + err);
            }
        }
    }
}
}));
}

/**
 * [ë…ë¦½í˜• í•¨ìˆ˜ 1] ì¸ë²¤í† ë¦¬ ë¡œì§ (ìì‚°ê°€ ì˜êµ¬ ì¹­í˜¸ í†µí•©ë³¸)
 * ê¸°ëŠ¥: ë³´ìœ  ì•„ì´í…œ í™•ì¸, ì¥ì°©, ë¶„í•´ ì²˜ë¦¬
 * ìˆ˜ì •: ì˜êµ¬ ì¹­í˜¸(700ë²ˆëŒ€) ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜ ë° ë³´í˜¸ ë¡œì§ ì¶”ê°€
 */
function _handleInventoryLogic(msg, user, data, replier, roomName, targetUid) {
    // 1. ê°€ë°© ì¡°íšŒ (ë¶„ë¥˜ ë° ìë™ ì •ë ¬ ì ìš©)
    if (msg === "/ê°€ë°©") {
        var inv = user.inventory || [];
        
        // ID ê¸°ì¤€ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬ (ìì‚°ê°€ ì¹­í˜¸ 700~703ë²ˆì´ ì¹­í˜¸ ìƒë‹¨ì— ì˜¤ë„ë¡ ì •ë ¬)
        inv.sort(function(a, b) {
            var idA = Number(a.id) || 9999;
            var idB = Number(b.id) || 9999;
            if (idA !== idB) return idA - idB;
            return (a.name || "").localeCompare(b.name || "");
        });

        var iconEntries = [];
        var titleEntries = [];
        
        if (inv.length === 0) {
            iconEntries.push("(ë³´ìœ  ì¤‘ì¸ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤)");
        } else {
            for (var i = 0; i < inv.length; i++) {
                var it = inv[i];
                var activeMark = "";
                
                // í˜„ì¬ ì¥ì°© ìƒíƒœ í™•ì¸ (âœ… í‘œì‹œ)
                if (it.effect === "icon" && user.icon === it.icon) activeMark = " (âœ… ì¥ì°© ì¤‘)";
                else if (it.effect === "title" && user.title === it.title) activeMark = " (âœ… ì¥ì°© ì¤‘)";
                
                var entry = (i + 1) + ". " + (it.icon || "ğŸ“¦") + " " + it.name + activeMark;

                if (it.effect === "icon") iconEntries.push(entry);
                else if (it.effect === "title") titleEntries.push(entry);
            }
        }

        var invDisplay = "[ì•„ì´í…œ ë³´ê´€í•¨]\n";
        invDisplay += "ğŸ–¼ï¸ ì•„ì´ì½˜ ëª©ë¡ (ë“±ê¸‰ìˆœ)\n";
        invDisplay += (iconEntries.length > 0 ? iconEntries.join("\n") : "- ì—†ìŒ") + "\n\n";
        
        invDisplay += "ğŸ–ï¸ ì¹­í˜¸ ëª©ë¡ (ë“±ê¸‰ìˆœ)\n";
        invDisplay += (titleEntries.length > 0 ? titleEntries.join("\n") : "- ì—†ìŒ");

        var consumables = "\n\n[ë‚´ ì†Œëª¨í’ˆ ì •ë³´]\n" +
                          "ğŸ›¡ï¸ ê°•ë“± ë°©ì–´ê¶Œ: " + (user.tierGuard || 0) + "ê°œ\n" +
                          "ğŸ”‚ ì¶”ê°€ ìŠ¹ê¸‰ê¶Œ: " + (user.purchasedPromotionAttempts || 0) + "íšŒ\n" +
                          "ğŸ§© ë¶„í•´ ì¡°ê°: " + (user.boxFragments || 0) + " / 5 ê°œ\n" +
                          "ğŸ« ëœë¤ë°•ìŠ¤ ì´ìš©ê¶Œ: " + (user.boxTickets || 0) + "ë§¤";
        
        var content = invDisplay + consumables + "\n\n(ì¥ì°©: [/ì¥ì°© ë²ˆí˜¸]) (ë¶„í•´: [/ë¶„í•´ ë²ˆí˜¸])";
        replier.reply(formatCommand("ğŸ’ ë‚´ ê°€ë°©", user, content, "ì›í•˜ëŠ” ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì—¬ ì¥ì°©í•˜ì„¸ìš”."));
        return true;
    }

    // 2. ì•„ì´í…œ ì¥ì°© (ì‹ ìš©ë¶ˆëŸ‰ì ì œí•œ ë° ì¸ë±ìŠ¤ ì •í•©ì„± ìœ ì§€)
    if (msg.indexOf("/ì¥ì°© ") === 0) {
        if (Number(user.creditScore || 600) < 500) {
            replier.reply(formatError(user, "ì¥ì°© ë¶ˆê°€", "í˜„ì¬ ì‹ ìš©ë¶ˆëŸ‰ì ìƒíƒœì´ë¯€ë¡œ ì•„ì´ì½˜ ë° ì¹­í˜¸ ë³€ê²½ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤. ì‹ ìš©ì„ ë¨¼ì € íšŒë³µí•˜ì„¸ìš”."));
            return true;
        }

        var parts = msg.trim().split(/\s+/);
        if (parts.length < 2) {
            replier.reply(formatError(user, "í˜•ì‹ ì˜¤ë¥˜", "/ì¥ì°© [ë²ˆí˜¸]"));
            return true;
        }

        var idx = parseInt(parts[1]);
        var inv = user.inventory || [];
        if (isNaN(idx) || idx < 1 || idx > inv.length) {
            replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "ê°€ë°©ì— í‘œì‹œëœ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."));
            return true;
        }

        var selected = inv[idx - 1];
        if (selected.effect === "icon") {
            user.icon = selected.icon;
            replier.reply(formatCommand("âœ¨ ì•„ì´ì½˜ ì¥ì°©", user, "[" + selected.icon + "] ì•„ì´ì½˜ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.", "ë‚´ ì •ë³´: [/ë‚´ì •ë³´]"));
        } else if (selected.effect === "title") {
            user.title = selected.title || "";
            replier.reply(formatCommand("ğŸ–ï¸ ì¹­í˜¸ ì¥ì°©", user, "[" + (selected.title || selected.name) + "] ì¹­í˜¸ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.", "ë‚´ ì •ë³´: [/ë‚´ì •ë³´]"));
        }
        safeSaveData(data);
        return true;
    }

    // 3. ì•„ì´ì½˜ ë¶„í•´ ë¡œì§ (ì˜êµ¬ ì¹­í˜¸ ë³´í˜¸ ë¡œì§ ì¶”ê°€)
    if (msg.indexOf("/ë¶„í•´ ") === 0) {
        var inv = user.inventory || [];
        if (inv.length === 0) return replier.reply(formatError(user, "ë¶„í•´ ë¶ˆê°€", "ë¶„í•´í•  ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤."));

        var numbers = msg.match(/\d+/g);
        if (!numbers) return replier.reply(formatError(user, "ì…ë ¥ ì˜¤ë¥˜", "/ë¶„í•´ [ë²ˆí˜¸]"));

        var targetIndices = [];
        var protectedCount = 0;

        numbers.forEach(function(n) {
            var idx = parseInt(n) - 1;
            if (idx >= 0 && idx < inv.length && targetIndices.indexOf(idx) === -1) {
                var item = inv[idx];
                // [ì•ˆì „ ì¥ì¹˜] ID 700~799ë²ˆëŒ€(ìì‚°ê°€/ì—…ì  ì˜êµ¬ ì¹­í˜¸)ëŠ” ë¶„í•´ ëŒ€ìƒì—ì„œ ì œì™¸
                if (item.effect === "title" && item.id >= 700 && item.id < 800) {
                    protectedCount++;
                } else {
                    targetIndices.push(idx);
                }
            }
        });

        if (protectedCount > 0 && targetIndices.length === 0) {
            return replier.reply(formatError(user, "ë¶„í•´ ë¶ˆê°€", "ì˜êµ¬ ì—…ì  ì¹­í˜¸ëŠ” ë¶„í•´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        }
        if (targetIndices.length === 0) return replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "ì •í™•í•œ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));

        var disassembledNames = [];
        var earnedFragments = targetIndices.length;
        
        // ì—­ìˆœ ì •ë ¬í•˜ì—¬ splice ì‹œ ì¸ë±ìŠ¤ ë°€ë¦¼ ë°©ì§€
        targetIndices.sort(function(a, b) { return b - a; });

        targetIndices.forEach(function(idx) {
            var item = inv[idx];
            disassembledNames.push((item.icon || "ğŸ“¦") + " " + item.name);
            if (item.effect === "icon" && user.icon === item.icon) user.icon = "";
            if (item.effect === "title" && user.title === item.title) user.title = "";
            inv.splice(idx, 1);
        });

        user.boxFragments = (user.boxFragments || 0) + earnedFragments;
        var earnedTickets = 0;
        
        while (user.boxFragments >= 5) {
            user.boxFragments -= 5;
            user.boxTickets = (user.boxTickets || 0) + 1;
            earnedTickets++;
        }

        var resultMsg = "ì•„ì´í…œ " + targetIndices.length + "ê°œë¥¼ ë¶„í•´í–ˆìŠµë‹ˆë‹¤.\n\n" +
                        "[ë¶„í•´ ëª©ë¡]\n" + disassembledNames.join(", ") + "\n\n" +
                        "ğŸ§© íšë“ ì¡°ê°: +" + earnedFragments + " ê°œ\n" +
                        "(í˜„ì¬ ì¡°ê°: " + user.boxFragments + " / 5 ê°œ)";

        if (protectedCount > 0) resultMsg += "\n\nâš ï¸ ì•Œë¦¼: ì„ íƒí•˜ì‹  ì˜êµ¬ ì¹­í˜¸ " + protectedCount + "ê°œëŠ” ë¶„í•´ ëŒ€ìƒì—ì„œ ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤.";
        if (earnedTickets > 0) resultMsg += "\nğŸ« ëœë¤ë°•ìŠ¤ ì´ìš©ê¶Œ: +" + earnedTickets + "ë§¤ íšë“! (ì¡°ê° ë³€í™˜ ì™„ë£Œ)";

        replier.reply(formatCommand("â™»ï¸ ì•„ì´ì½˜ ë¶„í•´ ì™„ë£Œ", user, resultMsg, "ì´ìš©ê¶Œ í™•ì¸: [/ê°€ë°©]"));
        safeSaveData(data);
        return true;
    }
}

//==========ì„¹í„°28==========

/**
Â * [ë…ë¦½í˜• í•¨ìˆ˜ 2] ë¡œë˜ ë° ì•„ì´ì½˜ ë¡œì§
Â */
function _handleLottoLogic(msg, user, data, replier, roomName, targetUid) {
Â  Â  if (msg === "/ì•„ì´ì½˜ì´ˆê¸°í™”") {
Â  Â  Â  Â  user.icon = "";
Â  Â  Â  Â  replier.reply(formatCommand("âœ… ì•„ì´ì½˜ ì´ˆê¸°í™”", user, "ì„¤ì •ëœ ì•„ì´ì½˜ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.", "ìƒì  ì´ìš©: [/ìƒì ]"));
Â  Â  Â  Â  safeSaveData(data);
Â  Â  Â  Â  return true;
Â  Â  }

Â  Â  if (msg === "/ë¡œë˜ì •ë³´") {
Â  Â  Â  Â  var currentHour = new Date().getHours();
Â  Â  Â  Â  var isAfterDraw = (currentHour >= 22);
Â  Â  Â  Â  var myLottos = (lotto.entries && lotto.entries[targetUid]) ? lotto.entries[targetUid] : [];
Â  Â  Â  Â  var winNums = lotto.lastWinNums || [];

Â  Â  Â  Â  var result = "ğŸ« ë¡œë˜ ì •ë³´\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + getDisplayName(user) + "ë‹˜\n[ë‚˜ì˜ êµ¬ë§¤ ë²ˆí˜¸]\n";
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (myLottos.length === 0) {
Â  Â  Â  Â  Â  Â  result += "(êµ¬ë§¤í•œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤)\n";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  for (var i = 0; i < myLottos.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  var nums = myLottos[i];
Â  Â  Â  Â  Â  Â  Â  Â  var line = (i + 1) + ") " + nums.join(", ");
Â  Â  Â  Â  Â  Â  Â  Â  if (isAfterDraw && winNums.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  var matchCount = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for(var j=0; j < nums.length; j++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (winNums.indexOf(nums[j]) !== -1) matchCount++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (matchCount === 3) line += " ğŸ¥‡1ë“±!";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (matchCount === 2) line += " ğŸ¥ˆ2ë“±!";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (matchCount === 1) line += " ğŸ¥‰3ë“±!";
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  result += line + "\n";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  result += "\n[ë‹¹ì¼ ë‹¹ì²¨ ë²ˆí˜¸]\n";
Â  Â  Â  Â  if (isAfterDraw) {
Â  Â  Â  Â  Â  Â  if (winNums.length > 0) result += "ğŸ† " + winNums.join(", ");
Â  Â  Â  Â  Â  Â  else result += "ğŸ† ì§‘ê³„ ì¤‘ì…ë‹ˆë‹¤.";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  result += "ğŸ† ì•„ì§ ì¶”ì²¨ ì „ì…ë‹ˆë‹¤.";
Â  Â  Â  Â  }
Â  Â  Â  Â  result += "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’¡ [ê°€ì´ë“œ]: êµ¬ë§¤: [/êµ¬ë§¤ 5]";
Â  Â  Â  Â  replier.reply(result);
        return true;
Â  Â  }
}

//==========ì„¹í„°29==========

/**
 * [ë…ë¦½í˜•] ë°©ì¹˜í˜• ê´‘ì‚° ì‹œìŠ¤í…œ ë¡œì§ êµ¬í˜„ë¶€ (ëˆ„ì  ì‹œê°„ ë° ì„±ì·¨ ì¹­í˜¸ í†µí•© ë²„ì „)
 * ì„¤ëª…: ì„¹í„° 46(êµ¬ ì„¹í„° 27 í˜¸ì¶œë¶€)ì—ì„œ í˜¸ì¶œë˜ë©°, ê´‘ì‚° ì‹œì‘/ì •ë³´/ì¢…ë£Œ ë° ë³´ìƒ ì •ì‚° ë¡œì§ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
 * ë°˜ì˜ ì‚¬í•­: ìœ ë¬¼ ì¡°ê° 5ë‹¨ê³„ ì¹­í˜¸ ì²´ê³„ ì ìš© (ë„êµ´ì™•ë§Œ ì „ìš© ì•„ì´ì½˜ [âšœï¸] ë¶€ì—¬)
 */
function _handleMiningLogic(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName]; 

    // 1. ê´‘ì‚° ì‹œì‘
    if (msg === "/ê´‘ì‚°ì‹œì‘") {
        if (user.jailReleaseTime && Date.now() < user.jailReleaseTime) {
            var diff = user.jailReleaseTime - Date.now();
            var remainMin = Math.ceil(diff / (1000 * 60));
            var timeMsg = remainMin >= 60 ? Math.ceil(remainMin / 60) + "ì‹œê°„" : remainMin + "ë¶„";
            replier.reply(formatError(user, "ì…ì¥ ë¶ˆê°€", "í˜„ì¬ ì§•ì—­ ì¤‘ì…ë‹ˆë‹¤. " + timeMsg + " í›„ ê°€ëŠ¥í•©ë‹ˆë‹¤."));
            return true;
        }
        
        if (user.mining && user.mining.active) {
            replier.reply(formatError(user, "í™œë™ ì¤‘", "ì´ë¯¸ ê´‘ì‚°ì—ì„œ ì±„êµ´ ì¤‘ì…ë‹ˆë‹¤."));
            return true;
        }
        
        if (isUserBusy(targetUid)) {
            replier.reply(formatError(user, "í™œë™ ì¤‘", "ì´ë¯¸ ë‹¤ë¥¸ í™œë™(ë„ë°•/ê²°íˆ¬/ë„ë‘‘ì§ˆ) ì¤‘ì…ë‹ˆë‹¤."));
            return true;
        }

        user.mining = { active: true, startTime: Date.now(), room: roomName };
        replier.reply(formatCommand("â›ï¸ ê´‘ì‚° ì…ì„±", user, "ê´‘ì‚°ì—ì„œ ì±„êµ´ì„ ì‹œì‘í–ˆìŠµë‹ˆë‹¤.\nì±„êµ´ ì¤‘ì—ëŠ” ë„ë°•, ì£¼ì‹, ë„ë‘‘ì§ˆ ë“± ìˆ˜ìµí˜• í™œë™ì´ ì œí•œë©ë‹ˆë‹¤.", "ì¢…ë£Œ: [/ê´‘ì‚°ì¢…ë£Œ]"));
        safeSaveData(data);
        return true;
    }

    // 2. ê´‘ì‚° ì •ë³´ (ëˆ„ì  ì±„êµ´ ì‹œê°„ í‘œì‹œ ì¶”ê°€)
    if (msg === "/ê´‘ì‚°ì •ë³´") {
        if (!user.mining || !user.mining.active) {
            replier.reply(formatError(user, "ìƒíƒœ ì˜¤ë¥˜", "í˜„ì¬ ê´‘ì‚°ì—ì„œ ì‘ì—… ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤."));
            return true;
        }

        var durationMin = Math.floor((Date.now() - user.mining.startTime) / 60000);
        var totalMin = (user.totalMiningTime || 0) + durationMin;
        
        var multiplier = 1.0;
        if (roomData.economyBase && roomData.economyBase > 0) {
            var eco = calculateEconomy(data, roomName);
            var rawRatio = eco.total / roomData.economyBase;
            var damping = (data.economyDamping !== undefined) ? data.economyDamping : 0.5;
            multiplier = 1 + (rawRatio - 1) * damping;
            if (multiplier < 0.5) multiplier = 0.5;
        }

        var hasDebt = (user.loan && Number(user.loan.debt) > 0);
        if (!hasDebt && roomData.loanContracts) {
            for (var cid in roomData.loanContracts) {
                if (roomData.loanContracts[cid].borrowerUid === targetUid) { hasDebt = true; break; }
            }
        }
        if (hasDebt) multiplier *= 1.5;

        var basePrice = SYSTEM_CONFIG.ECO.MINE.BASE_PER_MIN; 
        var estimatedEarn = Math.floor(durationMin * basePrice * multiplier);

        var infoBody = "\nì±„êµ´ ì§„í–‰: " + durationMin + "ë¶„ì§¸...\n" +
                       "ğŸ“ˆ ëˆ„ì  ì±„êµ´: " + fp(totalMin) + "ë¶„ ê²½ê³¼\n" +
                       "ì˜ˆìƒ ê¸°ë³¸ìˆ˜ìµ: +" + fp(estimatedEarn) + "P\n\n" +
                       "âœ¨ ê´‘ë¬¼ ë°œê²¬ ìˆ˜ìµì€ ì¢…ë£Œ ì‹œ í•©ì‚°ë©ë‹ˆë‹¤.";

        replier.reply(formatCommand("â›ï¸ ê´‘ì‚° ì§„í–‰ í˜„í™©", user, infoBody, "ì¢…ë£Œ ë° ì •ì‚°ì€ [/ê´‘ì‚°ì¢…ë£Œ]"));
        return true;
    }

    // 3. ê´‘ì‚° ì¢…ë£Œ (ìœ ë¬¼ 5ë‹¨ê³„ ì¹­í˜¸ ì •ì‚° ë° ëˆ„ì  ì‹œê°„ ë°˜ì˜)
    if (msg === "/ê´‘ì‚°ì¢…ë£Œ") {
        if (!user.mining || !user.mining.active) {
            replier.reply(formatError(user, "ìƒíƒœ ì˜¤ë¥˜", "í˜„ì¬ ì‘ì—… ì¤‘ì´ì§€ ì•ŠìŠµë‹ˆë‹¤."));
            return true;
        }

        if (user.jailReleaseTime && Date.now() < user.jailReleaseTime) {
            user.mining.active = false; 
            safeSaveData(data);
            replier.reply(formatError(user, "ê²€ê±° í™•ì¸", "ì§•ì—­í˜• ì„ ê³ ë¡œ ì¸í•´ ê´‘ì‚°ì—ì„œ ê°•ì œ í‡´ê±°ë˜ì—ˆìŠµë‹ˆë‹¤.\n(ëˆ„ì  ì±„êµ´ ìˆ˜ìµ ì†Œë©¸)"));
            return true;
        }

        var now = Date.now();
        var durationMin = Math.floor((now - user.mining.startTime) / 60000); 

        if (durationMin < 1) {
            user.mining.active = false; 
            safeSaveData(data);
            replier.reply(formatCommand("â›ï¸ ê´‘ì‚° í‡´ê±°", user, "ì±„êµ´ ì‹œê°„ì´ ë„ˆë¬´ ì§§ì•„ ìˆ˜ìµì´ ë°œìƒí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n(ìµœì†Œ 1ë¶„ ì´ìƒ ìœ ì§€ í•„ìš”)", "ë‹¤ì‹œ ì‹œì‘: [/ê´‘ì‚°ì‹œì‘]"));
            return true;
        }

        var multiplier = 1.0;
        if (roomData.economyBase && roomData.economyBase > 0) {
            var eco = calculateEconomy(data, roomName);
            var rawRatio = eco.total / roomData.economyBase;
            var damping = (data.economyDamping !== undefined) ? data.economyDamping : 0.5;
            multiplier = 1 + (rawRatio - 1) * damping;
            if (multiplier < 0.5) multiplier = 0.5;
        }

        var hasDebt = (user.loan && Number(user.loan.debt) > 0);
        if (!hasDebt && roomData.loanContracts) {
            for (var cid in roomData.loanContracts) {
                if (roomData.loanContracts[cid].borrowerUid === targetUid) { hasDebt = true; break; }
            }
        }
        if (hasDebt) multiplier *= 1.5;

        var basePrice = SYSTEM_CONFIG.ECO.MINE.BASE_PER_MIN;
        var conf = SYSTEM_CONFIG.ECO.MINE;
        var totalEarn = 0;
        var copperCount = 0, goldCount = 0, diaCount = 0;
        var artifactFound = 0;

        for (var i = 0; i < durationMin; i++) {
            var rand = Math.random();
            var minIncome = basePrice * multiplier;

            if (rand < conf.DIA_PROB) { diaCount++; totalEarn += (minIncome * conf.DIA_MULT); }
            else if (rand < conf.GOLD_PROB) { goldCount++; totalEarn += (minIncome * conf.GOLD_MULT); }
            else if (rand < conf.COPPER_PROB) { copperCount++; totalEarn += (minIncome * conf.COPPER_MULT); }
            else { totalEarn += minIncome; }

            if (Math.random() < (conf.ARTIFACT_CHANCE || 0.0005)) {
                artifactFound++;
            }
        }

        totalEarn = Math.floor(totalEarn);
        var borrowerUid = targetUid || user.uid; 
        var res = processRepayment(user, totalEarn, borrowerUid, roomName); 
        
        util_updatePoint(user, roomData, Number(res.actualGain), "ê´‘ì‚° ì±„êµ´");

        // [ëˆ„ì  ì‹œê°„ ì¹­í˜¸ ì²´í¬]
        if (user.totalMiningTime === undefined) user.totalMiningTime = 0;
        user.totalMiningTime += durationMin;

        var replierStub = { reply: function(m) { Api.replyRoom(roomName, m); } };

        if (user.totalMiningTime >= 7000) {
            util_checkAndAwardTitle(user, replierStub, "ì±„êµ´ì˜ì‹ ", 2903, "â›ï¸", "ëˆ„ì  ì±„êµ´ 7,000ë¶„", "ìœ ë¬¼ ë„ê°ë„ í•¨ê»˜ í™•ì¸í•´ë³´ì„¸ìš”! [/ìœ ë¬¼ë„ê°]");
        } else if (user.totalMiningTime >= 5000) {
            util_checkAndAwardTitle(user, replierStub, "ì„ê³µ", 2902, "â›ï¸", "ëˆ„ì  ì±„êµ´ 5,000ë¶„", "7,000ë¶„ ë‹¬ì„± ì‹œ [ì±„êµ´ì˜ì‹ ]ì„ íšë“í•©ë‹ˆë‹¤.");
        } else if (user.totalMiningTime >= 1000) {
            util_checkAndAwardTitle(user, replierStub, "ë‘ë”ì§€", 2901, "â›ï¸", "ëˆ„ì  ì±„êµ´ 1,000ë¶„", "5,000ë¶„ ë‹¬ì„± ì‹œ [ì„ê³µ]ì— ë„ì „í•˜ì„¸ìš”!");
        }

        /* [Gemini ìš”ì²­ ì‚¬í•­] ìœ ë¬¼ ì¡°ê° 5ë‹¨ê³„ ì¹­í˜¸ ìë™ ë¶€ì—¬ (í•˜ìœ„ëŠ” ì•„ì´ì½˜ ì—†ìŒ, ë„êµ´ì™•ë§Œ ì „ìš©ì•„ì´ì½˜) */
        user.artifactPieces = (user.artifactPieces || 0) + artifactFound;

        if (user.artifactPieces >= 50) {
            util_checkAndAwardTitle(user, replierStub, "ë„êµ´ì™•", 2915, "âšœï¸", "ìœ ë¬¼ ì¡°ê° 50ê°œ ë‹¬ì„±", "ì „ì„¤ì˜ ë„êµ´ì™•ìœ¼ë¡œ ë“±ê·¹í•˜ì…¨ìŠµë‹ˆë‹¤!");
        } else if (user.artifactPieces >= 40) {
            util_checkAndAwardTitle(user, replierStub, "íŠ¸ë ˆì €í—Œí„°", 2914, "", "ìœ ë¬¼ ì¡°ê° 40ê°œ ë‹¬ì„±", "50ê°œ ë‹¬ì„± ì‹œ ì „ìš© ì•„ì´ì½˜ì´ ìˆëŠ” [ë„êµ´ì™•]ì´ ë©ë‹ˆë‹¤.");
        } else if (user.artifactPieces >= 30) {
            util_checkAndAwardTitle(user, replierStub, "ë°œêµ´ê°€", 2913, "", "ìœ ë¬¼ ì¡°ê° 30ê°œ ë‹¬ì„±", "ì¡°ê¸ˆ ë” í˜ë‚´ì„œ íŠ¸ë ˆì €í—Œí„°ì— ë„ì „í•˜ì„¸ìš”!");
        } else if (user.artifactPieces >= 20) {
            util_checkAndAwardTitle(user, replierStub, "íƒì‚¬ì›", 2912, "", "ìœ ë¬¼ ì¡°ê° 20ê°œ ë‹¬ì„±", "ìœ ì ì˜ í”ì ë“¤ì´ ë³´ì´ê¸° ì‹œì‘í•©ë‹ˆë‹¤.");
        } else if (user.artifactPieces >= 10) {
            util_checkAndAwardTitle(user, replierStub, "ë„êµ´ê¾¼", 2911, "", "ìœ ë¬¼ ì¡°ê° 10ê°œ ë‹¬ì„±", "ë“œë””ì–´ ì²« ë²ˆì§¸ ìœ ë¬¼ ì¹­í˜¸ë¥¼ íšë“í•˜ì…¨ìŠµë‹ˆë‹¤.");
        }

        user.mining.active = false;
        var repayInfo = res.repayMsg ? "\n\n" + res.repayMsg : "";
        var resultBody = "\nâ›ï¸ ì±„êµ´ ì‹œê°„: " + durationMin + "ë¶„\n" +
                         "ğŸŸ« êµ¬ë¦¬ " + copperCount + "íšŒ ğŸ—‚ï¸ í™©ê¸ˆ " + goldCount + "íšŒ\n" +
                         "ğŸ’ ë‹¤ì´ì•„ " + diaCount + "íšŒ\n\n" +
                         "ğŸ’° ì±„êµ´ ìˆ˜ìµ: " + fp(totalEarn) + "P" + repayInfo;

        if (artifactFound > 0) {
            resultBody += "\n\nâœ¨ [íŠ¹ë³„ ë°œê²¬] âœ¨\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                           "ì‹¬ìƒì¹˜ ì•Šì€ ê¸°ìš´ì˜ ì¡°ê°ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤!\n\n" +
                           "ğŸ§© ìœ ë¬¼ ì¡°ê° íšë“ (+" + artifactFound + ")\n" +
                           "(í˜„ì¬ ë³´ìœ : " + user.artifactPieces + " ê°œ)";
        }
                                  
        replier.reply(formatCommand("â›ï¸ ì±„êµ´ ê²°ê³¼", user, resultBody, "ë‚´ ì”ì•¡: " + fP(user.point) + "P"));
        safeSaveData(data);
        return true;
    }
}

//==========ì„¹í„°30==========

/**
 * [ì „ì—­ ë…ë¦½ í•¨ìˆ˜] ìƒì  ì•„ì´í…œ íš¨ê³¼ ì²˜ë¦¬ ì—”ì§„
 * ê¸°ëŠ¥: êµ¬ë§¤í•œ ì•„ì´í…œì˜ íš¨ê³¼ ë°œë™ ë° ì¤‘ì•™ì€í–‰ ì¬ì› ì •ì‚°
 * ìˆ˜ì • ì‚¬í•­: [Gemini ìš”ì²­ ì‚¬í•­] ìˆ˜ì§‘ëŒ€ë§ˆì™• íŒì • ë¡œì§ì„ ì•„ì´ì½˜ íšë“ ì‹œì ìœ¼ë¡œ í•œì •í•˜ì—¬ ì˜¤ì‘ë™ ë°©ì§€
 */
function _handleShopEffect(item, user, roomName, replier, data, targetUid, finalPrice, isUsingTicket, quantity) {
    var roomData = data.rooms[roomName];
    if (!roomData) return;
    
    // ìˆ˜ëŸ‰ì´ ì „ë‹¬ë˜ì§€ ì•Šì€ ê²½ìš° ê¸°ë³¸ê°’ 1 ì„¤ì •
    var qty = (quantity !== undefined && quantity !== null) ? quantity : 1;

    // ì¤‘ì•™ì€í–‰ ì¬ì› ì´ˆê¸°í™” (ê¸°ë³¸ 10,000P)
    if (roomData.bankReserve === undefined || roomData.bankReserve === null) {
        roomData.bankReserve = 10000;
    }
    
    /* [1. ìì‚° ì •ì‚°] ì´ìš©ê¶Œì„ ì‚¬ìš©í•˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ êµ¬ë§¤ ëŒ€ê¸ˆ(ì´ì•¡)ì„ ì€í–‰ìœ¼ë¡œ ê·€ì† */
    if (!isUsingTicket) {
        roomData.bankReserve += finalPrice;
    } else {
        // ì´ìš©ê¶Œ ì‚¬ìš© ì‹œ ìœ ì € ë°ì´í„°ì—ì„œ ì´ìš©ê¶Œ 1ë§¤ ì°¨ê° (ì´ìš©ê¶Œì€ ë‹¨ê¶Œ êµ¬ë§¤ë§Œ ê°€ëŠ¥)
        user.boxTickets = Math.max(0, (user.boxTickets || 0) - 1);
    }

    /* [ìˆ˜ì§‘ëŒ€ë§ˆì™• íŒì • í•¨ìˆ˜] - ì¤‘ë³µ ë°©ì§€ ë° ì•„ì´ì½˜ íšë“ ì‹œì—ë§Œ í˜¸ì¶œë¨ */
    var checkCollectionMaster = function() {
        var TOTAL_COLLECTABLE_ICONS = 6; // ìƒì  ì•„ì´ì½˜ 6ì¢… ê¸°ì¤€
        if (user.collectedIcons && user.collectedIcons.length >= TOTAL_COLLECTABLE_ICONS) {
            var replierStub = { reply: function(m) { Api.replyRoom(roomName, m); } };
            util_checkAndAwardTitle(user, replierStub, "ìˆ˜ì§‘ëŒ€ë§ˆì™•", 3001, "ğŸµï¸", "ëª¨ë“  ì•„ì´ì½˜ ìˆ˜ì§‘ ì™„ë£Œ", "ëª¨ë“  ìƒì§•ì„ ì†ì— ë„£ì€ ì „ì„¤ì˜ ìˆ˜ì§‘ê°€ì…ë‹ˆë‹¤.");
        }
    };

    /* [2. ì•„ì´í…œ íš¨ê³¼ë³„ ì‹¤í–‰ ë¡œì§] */
    
    // 1. ëœë¤ ì•„ì´ì½˜ ë°•ìŠ¤ ì²˜ë¦¬ (ë©”ì‹œì§€ í…Œì´ë¸” ë° ì¤‘ë³µ ì¡°ê° ì§€ê¸‰ í¬í•¨)
    if (item.effect === "randomBox") {
        var rand = Math.random();
        var cumulative = 0;
        var resultIdx = 0; 

        var msgTable = {
            0: { title: "ğŸ ëœë¤ ì•„ì´ì½˜ ë°•ìŠ¤ ê°œë´‰", desc: "\"ì—ê³ ... ë¨¼ì§€ë§Œ ìŒ“ì¸ ì°½ê³ ì—ì„œ ì“¸ëª¨ì—†ëŠ” ë¬¼ê±´ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.\"", guide: "ê°€ë°©ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. [/ê°€ë°©]" },
            1: { title: "ğŸ ëœë¤ ì•„ì´ì½˜ ë°•ìŠ¤ ê°œë´‰", desc: "\"ë‚˜ì˜ì§€ ì•Šë„¤ìš”! ì‹±ê·¸ëŸ¬ìš´ ì•„ì´ì½˜ì„ íšë“í–ˆìŠµë‹ˆë‹¤.\"", guide: "ì¥ì°© ì‹œ [/ì¥ì°© ë²ˆí˜¸]ë¥¼ ì…ë ¥í•˜ì„¸ìš”." },
            2: { title: "ğŸ ëœë¤ ì•„ì´ì½˜ ë°•ìŠ¤ ê°œë´‰", desc: "\"ì˜¤! ë¹›ë‚˜ëŠ” ì•„ì´í…œì…ë‹ˆë‹¤. í¬ê·€í•œ ê°€ì¹˜ê°€ ëŠê»´ì§€ë„¤ìš”!\"", guide: "ê°€ë°©ì—ì„œ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤. [/ê°€ë°©]" },
            3: { title: "ğŸŠ ì—í”½ ì•„ì´í…œ íšë“! ğŸŠ", desc: "\"ì™€ìš°! ëŒ€ë‹¨í•œ ìš´ì…ë‹ˆë‹¤. í™”ë ¤í•œ ì—í”½ ì•„ì´ì½˜ì„ ì†ì— ë„£ì—ˆìŠµë‹ˆë‹¤!\"", guide: "ê°€ë°©ì— ì•ˆì „í•˜ê²Œ ë³´ê´€ë˜ì—ˆìŠµë‹ˆë‹¤." },
            4: { title: "âœ¨ [ì „ì„¤ê¸‰] ìœ ë‹ˆí¬ ë“±ì¥! âœ¨", desc: "\"ë¯¿ê¸°ì§€ ì•ŠëŠ” í–‰ìš´! ì‹ í™” ì†ì—ì„œë‚˜ ë³´ë˜ ìœ ë‹ˆí¬ ì•„ì´í…œì…ë‹ˆë‹¤!\"", guide: "ì¦‰ì‹œ ì¥ì°©í•˜ì—¬ ìë‘í•´ë³´ì„¸ìš”! [/ê°€ë°©]" },
            5: { title: "ğŸ”¥ [ì´ˆë¹„ìƒ] ë ˆì „ë”ë¦¬ ê°•ë¦¼! ğŸ”¥", desc: "\"ì¶•í•˜í•©ë‹ˆë‹¤! ì„œë²„ ìµœìƒìœ„ 2%ì˜ í™•ë¥ ì„ ëš«ê³  ì „ì„¤ì„ íšë“í–ˆìŠµë‹ˆë‹¤!\"", guide: "ì´ ì•„ì´ì½˜ì€ ìƒì ì—ì„œ ì ˆëŒ€ êµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤." }
        };

        for (var g = 0; g < RANDOM_BOX_CONFIG.PROBS.length; g++) {
            cumulative += RANDOM_BOX_CONFIG.PROBS[g].prob;
            if (rand < cumulative) { resultIdx = g; break; }
        }

        var resGrade = RANDOM_BOX_CONFIG.PROBS[resultIdx];
        var winIcon = resGrade.items[Math.floor(Math.random() * resGrade.items.length)];
        
        if (!user.collectedIcons) user.collectedIcons = [];
        var isDuplicate = (user.collectedIcons.indexOf(winIcon) !== -1);
        var mData = msgTable[resultIdx] || msgTable[0];

        if (isDuplicate) {
            // [Gemini ìš”ì²­ ì‚¬í•­] ì¤‘ë³µ ì‹œ ë¶„í•´ ì¡°ê° +1 ì§€ê¸‰
            user.boxFragments = (user.boxFragments || 0) + 1;
            var ticketConverted = false;
            if (user.boxFragments >= 5) {
                user.boxFragments -= 5;
                user.boxTickets = (user.boxTickets || 0) + 1;
                ticketConverted = true;
            }
            
            var dupContent = "ë“±ê¸‰: " + resGrade.icon + " " + resGrade.grade + "\n" +
                             "ê²°ê³¼: [" + winIcon + "]\n\n" +
                             "âš ï¸ ì¤‘ë³µ ì•„ì´ì½˜ ë‹¹ì²¨!\n(ì´ë¯¸ ë„ê°ì— ë“±ë¡ëœ ì•„ì´ì½˜ì…ë‹ˆë‹¤)\n\n" +
                             "ğŸ§© ë³´ìƒ: ë¶„í•´ ì¡°ê° +1ê°œ ì§€ê¸‰\n" +
                             "ğŸ“Š í˜„ì¬ ì¡°ê°: " + user.boxFragments + " / 5 ê°œ";
            if (ticketConverted) dupContent += "\nğŸ« ì¡°ê°ì´ ëª¨ì—¬ [ëœë¤ë°•ìŠ¤ ì´ìš©ê¶Œ] 1ë§¤ ìë™ ì§€ê¸‰!";
            
            replier.reply(formatCommand("ğŸ ë°•ìŠ¤ ê°œë´‰ ê²°ê³¼", user, dupContent, "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
        } else {
            // ì‹ ê·œ ì•„ì´ì½˜ íšë“ ì‹œ ê°€ë°© ì¶”ê°€ ë° ë„ê° ë“±ë¡
            user.inventory.push({ id: 900 + resultIdx, name: resGrade.grade.split(" ")[0] + " ì•„ì´ì½˜", icon: winIcon, effect: "icon", title: "" });
            user.collectedIcons.push(winIcon);
            
            var newContent = "ë“±ê¸‰: " + resGrade.icon + " " + resGrade.grade + "\n" +
                             "ê²°ê³¼: [" + winIcon + "]\n\n" + mData.desc;
            replier.reply(formatCommand(mData.title, user, newContent, mData.guide + "\në‚´ ì”ì•¡: " + fp(user.point) + "P"));

            /* [ì‹ ê·œ ìˆ˜ì§‘ ë°œìƒ] ì¹­í˜¸ íŒì • í˜¸ì¶œ */
            checkCollectionMaster();
        }
    } 
    
    // 2. [ë³µêµ¬] ê²Œì„ íŒìˆ˜ ì¸ì¦ê¶Œ ì²˜ë¦¬ (ë‹¨ê¶Œ ì²˜ë¦¬)
    else if (item.effect === "gameAuth") {
        user.gameAuthCount = (user.gameAuthCount || 0) + 1;
        user.purchasedAuthCount = (user.purchasedAuthCount || 0) + 1;
        replier.reply(formatCommand("ğŸ« ì¸ì¦ê¶Œ ì‚¬ìš© ì™„ë£Œ", user, "ê²Œì„ íŒìˆ˜ ì¸ì¦ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.\ní˜„ì¬ ì¸ì¦ íšŸìˆ˜: " + user.gameAuthCount + "/2", "ì‹œì¦Œë‹¹ êµ¬ë§¤: " + user.purchasedAuthCount + "/2"));
    } 
    
    // 3. [ë³µêµ¬] ë¡œë˜ êµ¬ë§¤ ëŒ€ê¸° ì²˜ë¦¬ (ì‹œê°„ ì œí•œ ê°€ë“œ ì¶”ê°€)
    else if (item.effect === "lotto") {
        var currentHour = new Date().getHours();
        
        // 21:00(ë§ˆê°ê³µì§€) ~ 23:59 ì‚¬ì´ êµ¬ë§¤ ì‹œë„ ì°¨ë‹¨
        if (currentHour >= 21) {
            // ì°¨ë‹¨ëœ ê²½ìš° ì°¨ê°ëœ í¬ì¸íŠ¸ë¥¼ ë‹¤ì‹œ ë³µêµ¬í•˜ê³  ì¢…ë£Œ
            util_updatePoint(user, roomData, finalPrice, "ë¡œë˜ êµ¬ë§¤ ë¶ˆê°€ í™˜ë¶ˆ", roomName);
            replier.reply(formatError(user, "êµ¬ë§¤ ë¶ˆê°€", "ë¡œë˜ íŒë§¤ê°€ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.\n(íŒë§¤ ì‹œê°„: 00:00 ~ 20:59)\n\nğŸ’° ê²°ì œ ê¸ˆì•¡ì´ í™˜ë¶ˆë˜ì—ˆìŠµë‹ˆë‹¤."));
            return;
        }

        lottoPurchaseState[targetUid] = { time: Date.now(), price: finalPrice };
        replier.reply(formatCommand("ğŸ« ë¡œë˜ ë²ˆí˜¸ ì…ë ¥", user, "1~15 ì‚¬ì´ì˜ ìˆ«ì 3ê°œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(ì˜ˆ: 1 5 10)", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
    } 
    
    // 4. ìƒì  ì¼ë°˜ ì•„ì´ì½˜ êµ¬ë§¤ ì²˜ë¦¬
    else if (item.effect === "icon") {
        user.inventory.push({ id: item.id, name: item.name, icon: item.icon, effect: item.effect, title: "" });
        
        var isNewIcon = false;
        if (!user.collectedIcons) user.collectedIcons = [];
        if (user.collectedIcons.indexOf(item.icon) === -1) {
            user.collectedIcons.push(item.icon);
            isNewIcon = true;
        }
        user.icon = item.icon;
        replier.reply(formatCommand("ğŸ›’ êµ¬ë§¤ ì™„ë£Œ", user, item.name + " êµ¬ë§¤ ë° ì¥ì°© ì„±ê³µ!", "ì¥ì°© ë³€ê²½: [/ê°€ë°©]"));

        /* [ì‹ ê·œ ìˆ˜ì§‘ ë°œìƒ] ì¹­í˜¸ íŒì • í˜¸ì¶œ */
        if (isNewIcon) checkCollectionMaster();
    }
    
    // 5. ê¸°íƒ€ ì†Œëª¨ì„± ì•„ì´í…œ ì²˜ë¦¬ (ìˆ˜ëŸ‰ qty ë°˜ì˜)
    else if (item.effect === "promotion") {
        user.purchasedPromotionAttempts = (user.purchasedPromotionAttempts || 0) + qty;
        replier.reply(formatCommand("ğŸ›’ êµ¬ë§¤ ì™„ë£Œ", user, item.name + " x" + qty + " êµ¬ë§¤ ì„±ê³µ!", "ë‚¨ì€ ìŠ¹ê¸‰ ê¸°íšŒ: " + (user.dailyPromotionAttempts + user.purchasedPromotionAttempts)));
    } else if (item.effect === "tierGuard") {
        user.tierGuard = (user.tierGuard || 0) + qty;
        replier.reply(formatCommand("ğŸ›’ êµ¬ë§¤ ì™„ë£Œ", user, item.name + " x" + qty + " êµ¬ë§¤ ì„±ê³µ!", "ë³´ìœ  ë°©ì–´ê¶Œ: " + user.tierGuard + "ê°œ"));
    } else if (item.effect === "credit") {
        var totalRestore = (item.value || 50);
        user.creditScore = Math.min(1000, (user.creditScore || 600) + totalRestore);
        user.dailyCreditRestoreCount = (user.dailyCreditRestoreCount || 0) + 1;
        if (typeof checkAndHandleDefaulter === 'function') checkAndHandleDefaulter(user, roomName);
        replier.reply(formatCommand("ğŸ›’ êµ¬ë§¤ ì™„ë£Œ", user, item.name + " ì‚¬ìš© ì„±ê³µ! (ì‹ ìš© +50)", "í˜„ì¬ ì ìˆ˜: " + user.creditScore));
    }

    /* [ì‹ ê·œ: Gemini ìš”ì²­ ì‚¬í•­] ê²½ê³ ì‚­ì œê¶Œ(warnClear) êµ¬ë§¤ ì™„ë£Œ ì²˜ë¦¬ */
    else if (item.effect === "warnClear") {
        user.boughtWarningRemoval = true;
        // ì‹¤ì œ ê²½ê³ (ê²½ê³  ì¹´ìš´íŠ¸ ë“±)ê°€ ì¡´ì¬í•œë‹¤ë©´ ì—¬ê¸°ì„œ ì´ˆê¸°í™” ë¡œì§ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
        if (user.warningCount !== undefined) user.warningCount = 0; 
        
        replier.reply(formatCommand("ğŸ« ê²½ê³ ì‚­ì œê¶Œ ì‚¬ìš© ì™„ë£Œ", user, "ê²½ê³ ì‚­ì œê¶Œ êµ¬ë§¤ ë° ì‚¬ìš©ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n(í‰ìƒ 1íšŒ ì‚¬ìš© ê¸°ë¡ ì™„ë£Œ)", "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
    }

    /* [ìˆ˜ì •] ì „ì²´ í•˜ë‹¨ì— ìˆë˜ ìˆ˜ì§‘ëŒ€ë§ˆì™• ì²´í¬ ë¡œì§ì„ ì‚­ì œí•˜ê³  ìœ„ìª½ì˜ ì•„ì´ì½˜ íšë“ ë¶„ê¸°ë¡œ ì´ë™í•¨ */

    safeSaveData(data);
}

//==========ì„¹í„°31==========

/**
 * [ê´€ë¦¬ì ëª…ë ¹ì–´ ë¶„ë°°ê¸°] (Admin Logic Dispatcher - Registry Refactored)
 * ì„¤ëª…: ê´€ë¦¬ì ëª…ë ¹ì–´ì˜ í†µí•© ì§„ì…ì ì…ë‹ˆë‹¤. 
 * ì„¹í„° 1ì˜ ADMIN_COMMANDS ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¥¼ ì°¸ì¡°í•˜ì—¬ ë“±ë¡ëœ ë¡œì§ì„ ìë™ìœ¼ë¡œ ë§¤í•‘ ë° ì‹¤í–‰í•©ë‹ˆë‹¤.
 */
function _handleAdminLogic(msg, user, data, replier, roomName, targetUid, sender) {
    // 1. ëª…ë ¹ì–´ ì²« ë‹¨ì–´ ì¶”ì¶œ (ì˜ˆ: "/ì¬ì›ìˆ˜ì • 1000" -> "/ì¬ì›ìˆ˜ì •")
    var cmd = msg.split(" ")[0]; 

    // 2. ê´€ë¦¬ì ëª…ë ¹ì–´ ë ˆì§€ìŠ¤íŠ¸ë¦¬(ADMIN_COMMANDS)ì—ì„œ í•´ë‹¹ ëª…ë ¹ì–´ ê²€ìƒ‰
    // ì„¹í„° 6ì—ì„œ ë“±ë¡ëœ ë§¤í•‘ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìµœì í™”ëœ O(1) íƒìƒ‰ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
    if (ADMIN_COMMANDS[cmd] && typeof ADMIN_COMMANDS[cmd].execute === 'function') {
        
        // 3. ë“±ë¡ëœ í•˜ìœ„ ë¡œì§ í•¨ìˆ˜(ì„¹í„° 35~38 ë“±)ë¥¼ ì¦‰ì‹œ ì‹¤í–‰ ë° ê²°ê³¼ ë°˜í™˜
        // ì‹¤í–‰ ì‹œ í•„ìš”í•œ ëª¨ë“  ì»¨í…ìŠ¤íŠ¸ ê°ì²´ë¥¼ ì¸ìë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.
        return ADMIN_COMMANDS[cmd].execute(msg, user, data, replier, roomName, targetUid);
    }

    // 4. ì²˜ë¦¬ëœ ëª…ë ¹ì–´ê°€ ì—†ê±°ë‚˜ ë“±ë¡ë˜ì§€ ì•Šì€ ê²½ìš° false ë°˜í™˜
    return false; 
}

//==========ì„¹í„°32==========

/**
 * [ê´€ë¦¬ì í•˜ìœ„ ëª¨ë“ˆ 1] ì‹œìŠ¤í…œ ê¸°ë³¸ ì œì–´ ë° ê¶Œí•œ ê´€ë¦¬
 * ê¸°ëŠ¥: ë„ì›€ë§, ë´‡êµ¬ë™, ê°•ì œì¬ê°€ë™, ë„ë°•ì œí•œ, ê´€ë¦¬ì ë“±ë¡/í•´ì œ
 */
function _adminSystemLogic(msg, user, data, replier, roomName) {

    /* ê´€ë¦¬ì ë„ì›€ë§ */
    if (msg === "/ê´€ë¦¬ì") {
        var list = [];
        for(var i=0; i<ADMIN_CMD_LIST.length; i++) {
            list.push(ADMIN_CMD_LIST[i]);
        }
        replier.reply(formatAdmin("ê´€ë¦¬ì ëª…ë ¹ì–´ ëª©ë¡", list.join("\n")));
        return true;
    }

    /* ì‹œìŠ¤í…œ êµ¬ë™ ì œì–´ */
    if (msg.indexOf("/ë´‡êµ¬ë™ ") === 0) {
        var state = msg.split(" ")[1];
        data.botActive = (state === "ì˜¨");
        safeSaveData(data);
        replier.reply(formatAdmin("ì‹œìŠ¤í…œ ì„¤ì •", "ë´‡ êµ¬ë™ ìƒíƒœ: [" + state + "]"));
        return true;
    }

    /* ì‹œìŠ¤í…œ ê°•ì œ ì¬ê°€ë™ (ë½ í•´ì œ) */
    if (msg === "/ê°•ì œì¬ê°€ë™") {
        if (lock.isLocked()) lock.unlock();
        replier.reply(formatAdmin("ì™„ë£Œ", "ì‹œìŠ¤í…œ ë½ í•´ì œ ë° ë™ê¸°í™” ì™„ë£Œ"));
        return true;
    }

    /* ë„ë°• ì œí•œ ì„¤ì • */
    if (msg.indexOf("/ë„ë°•ì œí•œ ") === 0) {
        var sw = msg.split(" ")[1]; 
        data.gambleLimit = (sw === "ì˜¨");
        safeSaveData(data);
        replier.reply(formatAdmin("ì„¤ì •", "ë„ë°• ì œí•œ ìƒíƒœ: [" + sw + "]"));
        return true;
    }

    /* ê´€ë¦¬ì ë“±ë¡ */
    if (msg.indexOf("/ê´€ë¦¬ìë“±ë¡ ") === 0) {
        var target = msg.substring(7).trim();
        if (!data.admins) data.admins = ["ê´€ë¦¬ì"];
        if (data.admins.indexOf(target) !== -1) { 
            replier.reply(formatAdmin("ê´€ë¦¬ì ë“±ë¡ ì•Œë¦¼", "ì´ë¯¸ ê´€ë¦¬ìë¡œ ë“±ë¡ë˜ì–´ ìˆëŠ” ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.")); 
            return true; 
        }
        data.admins.push(target);
        safeSaveData(data);
        replier.reply(formatAdmin("ê´€ë¦¬ì ë“±ë¡ ì™„ë£Œ", "[" + target + "]ë‹˜ì„ ë¶€ê´€ë¦¬ìë¡œ ë“±ë¡í–ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    /* ê´€ë¦¬ì í•´ì œ */
    if (msg.indexOf("/ê´€ë¦¬ìí•´ì œ ") === 0) {
        var target = msg.substring(7).trim();
        if (target === "95 ë‚¨ ê´‘ì–´") { 
            replier.reply(formatAdmin("ì˜¤ë¥˜", "ìµœìƒìœ„ ê´€ë¦¬ì ê¶Œí•œì€ í•´ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); 
            return true; 
        }
        if (!data.admins) data.admins = ["ê´€ë¦¬ì"];
        var idx = data.admins.indexOf(target);
        if (idx === -1) { 
            replier.reply(formatAdmin("ì˜¤ë¥˜", "í•´ë‹¹ ë‹‰ë„¤ì„ì„ ê´€ë¦¬ì ëª…ë‹¨ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); 
            return true; 
        }
        data.admins.splice(idx, 1);
        safeSaveData(data);
        replier.reply(formatAdmin("ê´€ë¦¬ì í•´ì œ ì™„ë£Œ", "[" + target + "]ë‹˜ì„ ê´€ë¦¬ì ê¶Œí•œì—ì„œ ì œì™¸í–ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    /* ê´€ë¦¬ì ëª©ë¡ */
    if (msg === "/ê´€ë¦¬ìëª©ë¡") {
        var list = data.admins || ["ê´€ë¦¬ì"];
        replier.reply(formatAdmin("í˜„ì¬ ê´€ë¦¬ì ëª…ë‹¨", "â€¢ " + list.join("\nâ€¢ ")));
        return true;
    }

    return false; // ì²˜ë¦¬ëœ ëª…ë ¹ì–´ê°€ ì—†ìŒ
}

//==========ì„¹í„°33==========

/**
 * [ê´€ë¦¬ì í•˜ìœ„ ëª¨ë“ˆ 2] ë¡œê·¸ ë° ì œë³´ ê´€ë¦¬
 * ê¸°ëŠ¥: ë²„ê·¸ ì œë³´ í™•ì¸/ì‚­ì œ, ì˜¤ë¥˜ ë¡œê·¸ í™•ì¸/ì‚­ì œ, ê´€ë¦¬ì í™œë™ ë¡œê·¸ ì¡°íšŒ
 */
function _adminLogLogic(msg, user, data, replier) {

    /* ë²„ê·¸ ì œë³´ ëª©ë¡ í™•ì¸ */
    if (msg === "/ì œë³´ëª©ë¡") {
        var list = FileStream.read(BUG_LOG_PATH);
        if (!list || list.trim() === "") replier.reply(formatAdmin("ì œë³´ ë‚´ì—­", "ì ‘ìˆ˜ëœ ë²„ê·¸ ì œë³´ê°€ ì—†ìŠµë‹ˆë‹¤."));
        else replier.reply(formatAdmin("ğŸ“‚ ë²„ê·¸ ì œë³´ ëª©ë¡", list.trim()));
        return true;
    }

    /* ë²„ê·¸ ì œë³´ ì´ˆê¸°í™” */
    if (msg === "/ì œë³´ì´ˆê¸°í™”") {
        FileStream.remove(BUG_LOG_PATH);
        replier.reply(formatAdmin("ì™„ë£Œ", "ë²„ê·¸ ì œë³´ ë‚´ì—­ì„ ëª¨ë‘ ì‚­ì œí–ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    /* ì˜¤ë¥˜ ë¡œê·¸ í™•ì¸ */
    if (msg === "/ì˜¤ë¥˜ë¡œê·¸") {
        var list = FileStream.read(ERROR_LOG_PATH);
        if (!list || list.trim() === "") replier.reply(formatAdmin("ì˜¤ë¥˜ ë¡œê·¸", "ê¸°ë¡ëœ ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ì—†ìŠµë‹ˆë‹¤."));
        else replier.reply(formatAdmin("âš ï¸ ì‹œìŠ¤í…œ ì˜¤ë¥˜ ë¡œê·¸", list.trim()));
        return true;
    }

    /* ì˜¤ë¥˜ ë¡œê·¸ ì´ˆê¸°í™” */
    if (msg === "/ì˜¤ë¥˜ì´ˆê¸°í™”") {
        FileStream.remove(ERROR_LOG_PATH);
        replier.reply(formatAdmin("ì™„ë£Œ", "ì˜¤ë¥˜ ë¡œê·¸ë¥¼ ëª¨ë‘ ì‚­ì œí–ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    /* ê´€ë¦¬ì í™œë™ ë¡œê·¸ */
    if (msg === "/ê´€ë¦¬ìë¡œê·¸") {
        var logs = data.adminLogs || [];
        replier.reply(formatAdmin("í™œë™ ë¡œê·¸", logs.slice(-10).join("\n") || "ê¸°ë¡ ì—†ìŒ"));
        return true;
    }

    return false;
}

//==========ì„¹í„°34==========

/**
 * [ê´€ë¦¬ì í•˜ìœ„ ëª¨ë“ˆ 3] ìœ ì € ë°ì´í„° ê´€ë¦¬
 * ê¸°ëŠ¥: ìœ ì € ì¡°íšŒ, ìˆ˜ì •, ì‚­ì œ, ë³µì›, ë°ì´í„° ì´ì „, ë‹‰ë„¤ì„ ê¸°ë¡, ì‹ ìš© ì¡°ì •
 * ìˆ˜ì • ì‚¬í•­: ìœ ì € ì‚­ì œ ì‹œ ì¶œì„ì¼ìˆ˜ ë¬´ê´€ ì‚¬ì±„ ì „ì•¡ ë³´ì „ ë° ê³„ì•½ì„œ ê°•ì œ ì‚­ì œ ë¡œì§ ì ìš©
 */
function _adminUserManageLogic(msg, user, data, replier, roomName, targetUid) {

    /* ìƒì„¸ ìœ ì € ë°ì´í„° ì¡°íšŒ */
    if (msg.indexOf("/ìœ ì €ë°ì´í„° ") === 0) {
        var tn = msg.substring(7).trim();
        var roomData = data.rooms[roomName];
        var found = findUserByName(roomData, tn);
        if (!found.length) replier.reply(formatAdmin("ì˜¤ë¥˜", "ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        else if (found.length > 1) handleUserSelection(replier, targetUid, found, "admin_userdata", null, user);
        else replier.reply(formatAdmin("ìœ ì € ë°ì´í„° ì¡°íšŒ", JSON.stringify(found[0].data, null, 2)));
        return true;
    }

    /* ë‹‰ë„¤ì„ ë³€ê²½ ì´ë ¥ */
    if (msg.indexOf("/ë‹‰ë„¤ì„ê¸°ë¡ ") === 0) {
        var tn = msg.substring(7).trim();
        var roomData = data.rooms[roomName];
        var found = findUserByName(roomData, tn);
        if (!found.length) { replier.reply(formatAdmin("ì˜¤ë¥˜", "ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (found.length > 1) { handleUserSelection(replier, targetUid, found, "admin_nick_log", null, user); return true; }
        var targetId = found[0].id;
        var history = data.nickHistory[targetId] || [];
        if (history.length === 0) { replier.reply(formatAdmin("ë‹‰ë„¤ì„ ê¸°ë¡", getDisplayName(found[0].data) + "ë‹˜ì€ ë³€ê²½ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        var logMsg = [];
        for(var i=0; i<history.length; i++) logMsg.push((i+1) + ". " + history[i].old + " (" + history[i].date + ")");
        replier.reply(formatAdmin("ğŸ“‹ ë‹‰ë„¤ì„ ë³€ê²½ ì´ë ¥", "í˜„ì¬: " + found[0].data.name + "\n\n[ê³¼ê±° ê¸°ë¡]\n" + logMsg.join("\n")));
        return true;
    }

    /* [ì‹ ê·œ] ì‹ ìš© ì ìˆ˜ ì§ì ‘ ì¡°ì • (v5.2) */
    if (msg.indexOf("/ì‹ ìš©ì¡°ì • ") === 0) {
        var ps = msg.split(" ");
        if (ps.length < 3) {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "í˜•ì‹: /ì‹ ìš©ì¡°ì • [ë‹‰ë„¤ì„] [ì ìˆ˜]\nì˜ˆ) /ì‹ ìš©ì¡°ì • í™ê¸¸ë™ -50"));
            return true;
        }
        var scoreChange = parseInt(ps.pop());
        var targetName = ps.slice(1).join(" ").trim();
        var roomData = data.rooms[roomName];
        var found = findUserByName(roomData, targetName);

        if (isNaN(scoreChange)) { replier.reply(formatAdmin("ì˜¤ë¥˜", "ì¡°ì •í•  ì ìˆ˜ë¥¼ ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”.")); return true; }
        if (!found.length) { replier.reply(formatAdmin("ì˜¤ë¥˜", "ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (found.length > 1) { 
            handleUserSelection(replier, targetUid, found, "admin_credit_edit", { score: scoreChange }, user); 
            return true; 
        }

        var targetUser = found[0].data;
        var oldScore = Number(targetUser.creditScore || 600);
        targetUser.creditScore = Math.min(1000, Math.max(0, oldScore + scoreChange));
        
        if (typeof checkAndHandleDefaulter === 'function') {
            checkAndHandleDefaulter(targetUser, roomName);
        }

        safeSaveData(data);
        var crInfo = getCreditInfo(targetUser.creditScore);
        var resText = "ëŒ€ìƒ: " + getDisplayName(targetUser) + "ë‹˜\n" +
                      "ë³€ë™: " + (scoreChange > 0 ? "+" : "") + scoreChange + "ì \n" +
                      "í˜„ì¬: " + targetUser.creditScore + "ì  (" + crInfo.label + ")";
        
        replier.reply(formatAdmin("âš™ï¸ ì‹ ìš© ì ìˆ˜ ì¡°ì • ì™„ë£Œ", resText));
        return true;
    }

    /* ì¶œì„ ì´ˆê¸°í™” */
    if (msg.indexOf("/ì¶œì„ì´ˆê¸°í™” ") === 0) {
        var tn = msg.substring(7).trim();
        var roomData = data.rooms[roomName];
        var found = findUserByName(roomData, tn);
        if (!found.length) { replier.reply(formatAdmin("ì˜¤ë¥˜", "ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (found.length > 1) { handleUserSelection(replier, targetUid, found, "admin_attend_reset", null, user); return true; }
        found[0].data.lastDate = "";
        safeSaveData(data);
        replier.reply(formatAdmin("ì¶œì„ ì´ˆê¸°í™” ì™„ë£Œ", getDisplayName(found[0].data) + "ë‹˜ì˜ ì˜¤ëŠ˜ ì¶œì„ ê¸°ë¡ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    /* ì¶œì„ ì¼ìˆ˜ ìˆ˜ì • */
    if (msg.indexOf("/ì¶œì„ì¼ìˆ˜ìˆ˜ì • ") === 0) {
        var ps = msg.split(" "), days = parseInt(ps.pop()), tn = ps.slice(1).join(" ");
        var roomData = data.rooms[roomName];
        var found = findUserByName(roomData, tn);
        if (!found.length) { replier.reply(formatAdmin("ì˜¤ë¥˜", "ëŒ€ìƒ ì—†ìŒ")); return true; }
        if (found.length > 1) { handleUserSelection(replier, targetUid, found, "admin_attend_edit", { days: days }, user); return true; }
        found[0].data.totalAttendance = days; safeSaveData(data);
        replier.reply(formatAdmin("ìˆ˜ì • ì™„ë£Œ", getDisplayName(found[0].data) + ": " + days + "ì¼"));
        return true;
    }

    /* ì „ì²´ ì¶œì„ ìˆ˜ì • */
    if (msg.indexOf("/ì „ì²´ì¶œì„ìˆ˜ì • ") === 0) {
        var days = parseInt(msg.split(" ")[1]);
        for (var r in data.rooms) {
            for (var id in data.rooms[r].users) { data.rooms[r].users[id].totalAttendance = days; }
        }
        safeSaveData(data);
        replier.reply(formatAdmin("ì™„ë£Œ", "ì „ì²´ ì¶œì„ " + days + "ì¼ë¡œ ê³ ì •"));
        return true;
    }

    /* ë°ì´í„° ì´ì „ */
    if (msg.indexOf("/ë°ì´í„°ì´ì „ ") === 0) {
        if (msg.indexOf(" > ") === -1) { replier.reply(formatAdmin("ì˜¤ë¥˜", "í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.\nì˜ˆ) /ë°ì´í„°ì´ì „ êµ¬ë‹‰ë„¤ì„ > ì‹ ë‹‰ë„¤ì„")); return true; }
        var names = msg.substring(7).split(" > ");
        var oldName = names[0].trim();
        var newName = names[1].trim();
        var roomData = data.rooms[roomName];
        
        var oldFound = findUserByName(roomData, oldName);
        var newFound = findUserByName(roomData, newName);

        if (oldFound.length === 0) { replier.reply(formatAdmin("ì˜¤ë¥˜", "êµ¬ ë‹‰ë„¤ì„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (newFound.length === 0) { replier.reply(formatAdmin("ì˜¤ë¥˜", "ì‹  ë‹‰ë„¤ì„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (oldFound.length > 1 || newFound.length > 1) { replier.reply(formatAdmin("ì˜¤ë¥˜", "ì¤‘ë³µ ë‹‰ë„¤ì„ì´ ì¡´ì¬í•©ë‹ˆë‹¤. ì •í™•í•œ í’€ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")); return true; }

        var oldId = oldFound[0].id;
        var oldData = oldFound[0].data;
        var newData = newFound[0].data;

        newData.point = oldData.point;
        newData.bank = oldData.bank;
        newData.tier = oldData.tier;
        newData.creditScore = oldData.creditScore;
        newData.totalAttendance = oldData.totalAttendance;
        newData.loan = oldData.loan;
        newData.stockHoldings = oldData.stockHoldings;
        newData.stockAvg = oldData.stockAvg;
        newData.icon = oldData.icon;
        newData.title = oldData.title;

        if (typeof uidCache !== 'undefined') {
            for (var key in uidCache) {
                if (uidCache[key] === oldId) delete uidCache[key];
            }
        }
        delete roomData.users[oldId];
        safeSaveData(data);
        replier.reply(formatAdmin("ë°ì´í„° ì´ì „ ì„±ê³µ", oldName + " â” " + newName + "\nëª¨ë“  ìì‚° ë° ë“±ê¸‰ì´ ì´ì „ë˜ì—ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    /* ìœ ì € ì‚­ì œ (ì‚¬ì±„ ì „ì•¡ ë³´ì „ ë° ê³„ì•½ ê°•ì œ ì‚­ì œ ì ìš©) */
    if (msg.indexOf("/ìœ ì €ì‚­ì œ ") === 0) {
        var tn = msg.substring(6).trim();
        var roomData = data.rooms[roomName];
        var found = findUserByName(roomData, tn);
        if (!found.length) { replier.reply(formatAdmin("ì˜¤ë¥˜", "ëŒ€ìƒ ì—†ìŒ")); return true; }
        if (found.length > 1) { handleUserSelection(replier, targetUid, found, "admin_delete", null, user); return true; }
        
        var targetId = found[0].id;
        var targetData = found[0].data;
        var refundLog = "";
        var refundCount = 0;
        var totalRefunded = 0;

        // [ìˆ˜ì •] ì¶œì„ì¼ìˆ˜ ê´€ê³„ì—†ì´ ëª¨ë“  ì‚¬ì±„ ê³„ì•½ ê°•ì œ ì •ì‚° ë° ì‚­ì œ
        if (roomData.loanContracts) {
            for (var cid in roomData.loanContracts) {
                var c = roomData.loanContracts[cid];
                if (c.borrowerUid === targetId) {
                    var lender = roomData.users[c.lenderUid];
                    if (lender) {
                        var debtAmt = Number(c.currentDebt);
                        lender.point = Number(lender.point) + debtAmt;
                        totalRefunded += debtAmt;
                        refundCount++;
                        try { Api.replyRoom(roomName, "ğŸš¬ [ì‚¬ì±„ ê°•ì œ ì •ì‚°]\n" + targetData.name + "ë‹˜ì˜ ë°ì´í„° ì‚­ì œë¡œ ì¸í•´ " + lender.name + "ë‹˜ê»˜ ë¯¸ìˆ˜ê¸ˆ " + fp(debtAmt) + "Pê°€ ì „ì•¡ ë°˜í™˜ë˜ì—ˆìŠµë‹ˆë‹¤."); } catch(e){}
                    }
                    delete roomData.loanContracts[cid]; // ê³„ì•½ì„œ ê°•ì œ íŒŒê¸°
                }
            }
        }

        // [ì‹ ê·œ] ì€í–‰ ëŒ€ì¶œê¸ˆ êµ­ê³  íšŒìˆ˜ (íì‡„í˜• ê²½ì œ ì•ˆì •í™”)
        if (targetData.loan && Number(targetData.loan.debt) > 0) {
            var bankDebt = Number(targetData.loan.debt);
            roomData.bankReserve = (Number(roomData.bankReserve) || 0) + bankDebt;
            refundLog += "\nğŸ¦ ì€í–‰ ëŒ€ì¶œê¸ˆ " + fp(bankDebt) + "Pê°€ êµ­ê³ ë¡œ ìë™ íšŒìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.";
        }

        if (refundCount > 0) refundLog += "\nâš ï¸ ì‚¬ì±„ ë³´ì „ ì™„ë£Œ: " + refundCount + "ê±´ (" + fp(totalRefunded) + "P)";

        if (typeof uidCache !== 'undefined') {
            for (var key in uidCache) {
                if (uidCache[key] === targetId) delete uidCache[key];
            }
        }
        delete roomData.users[targetId];
        safeSaveData(data);
        replier.reply(formatAdmin("ìœ ì € ì‚­ì œ ì™„ë£Œ", "[" + targetData.name + "]ë‹˜ì˜ ë°ì´í„°ë¥¼ ì˜êµ¬ ì‚­ì œí–ˆìŠµë‹ˆë‹¤." + refundLog));
        return true;
    }

    /* ìœ ì € ë¶€ë¶„ ë³µì› */
    if (msg.indexOf("/ìœ ì €ë³µì› ") === 0) {
        var tn = msg.substring(6).trim();
        var roomData = data.rooms[roomName];
        var found = findUserByName(roomData, tn);
        if (found.length > 1) { handleUserSelection(replier, targetUid, found, "user_restore", null, user); return true; }
        if (found.length === 0) { replier.reply(formatAdmin("ì˜¤ë¥˜", "ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }

        var targetId = found[0].id;
        var stablePath = BACKUP_DIR + "last_stable_backup.json";
        var backupData = JSON.parse(FileStream.read(stablePath));
        var restored = false;
        
        for (var r in backupData.rooms) {
            if (backupData.rooms[r].users[targetId]) {
                roomData.users[targetId] = backupData.rooms[r].users[targetId];
                restored = true;
                if (typeof uidCache !== 'undefined') {
                    for (var key in uidCache) {
                        if (uidCache[key] === targetId) delete uidCache[key];
                    }
                }
                break;
            }
        }
        
        if(restored) { safeSaveData(data); replier.reply(formatAdmin("ì™„ë£Œ", "íŠ¹ì • ìœ ì € ë°ì´í„° ë³µêµ¬ ì™„ë£Œ")); }
        else replier.reply(formatAdmin("ì‹¤íŒ¨", "ë°±ì—… ë³¸ì— í•´ë‹¹ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤."));
        return true;
    }

    return false;
}

//==========ì„¹í„°35==========

/**
 * [ê´€ë¦¬ì í•˜ìœ„ ëª¨ë“ˆ 4] ê²½ì œ ë° í¬ì¸íŠ¸ ê´€ë¦¬
 * ê¸°ëŠ¥: ê²½ì œì§€í‘œ, ë°ì´í„°êµì •, ë¬¼ê°€ì¡°ì •, í¬ì¸íŠ¸ ì§€ê¸‰/ì°¨ê°/ë¿Œë¦¬ê¸°, ê°ì¢… ì´ˆê¸°í™”, ì¬ì›ìˆ˜ì • ë° ì¶©ì „, ìê°€ë³µì›
 */
function _adminEconomyLogic(msg, user, data, replier, roomName, targetUid) {

    /* [1] ì€í–‰ ê°€ìš© ì¬ì› ìˆ˜ë™ ìˆ˜ì • (ê°•ì œ ì„¤ì •) */
    if (msg.indexOf("/ì¬ì›ìˆ˜ì • ") === 0) {
        var val = parseInt(msg.split(" ")[1].replace(/,/g, ""));
        if (isNaN(val)) {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "ìˆ˜ì •í•  ê¸ˆì•¡ì„ ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”.\nì˜ˆ) /ì¬ì›ìˆ˜ì • 3000"));
            return true;
        }

        var roomData = data.rooms[roomName];
        if (!roomData) return true;
        
        roomData.bankReserve = val;
        safeSaveData(data);
        
        replier.reply(formatAdmin("ğŸ¦ ì€í–‰ ì¬ì› ìˆ˜ì • ì™„ë£Œ", 
            "í˜„ì¬ ë°©ì˜ ê°€ìš© ì¬ì›ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n" +
            "ğŸ’° ì„¤ì • ê¸ˆì•¡: " + fp(val) + "P\n" +
            "ğŸ“¢ ì´ì œ ìœ ì €ë“¤ì´ ì´ ê¸ˆì•¡ ë‚´ì—ì„œ ëŒ€ì¶œ ê°€ëŠ¥í•©ë‹ˆë‹¤."));
        return true;
    }

    /* [ì‹ ê·œ] ì€í–‰ ê¸´ê¸‰ ì¬ì› ì¶©ì „ (ê¸°ì¡´ ì”ì•¡ì— ì¶”ê°€ í•©ì‚°) */
    if (msg.indexOf("/ì¬ì›ì¶©ì „ ") === 0) {
        var val = parseInt(msg.split(" ")[1].replace(/,/g, ""));
        if (isNaN(val) || val <= 0) {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "ì¶©ì „í•  ê¸ˆì•¡ì„ ì–‘ì˜ ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”.\nì˜ˆ) /ì¬ì›ì¶©ì „ 100000"));
            return true;
        }
        var roomData = data.rooms[roomName];
        if (!roomData) return true;

        if (roomData.bankReserve === undefined || roomData.bankReserve === null) roomData.bankReserve = 0;
        roomData.bankReserve += val;
        
        safeSaveData(data);
        
        var resMsg = "ê²°ê³¼: êµ­ê³  ë³´ì¶© ì™„ë£Œ\n" +
                     "ìˆ˜í˜ˆ ê¸ˆì•¡: +" + fp(val) + "P\n" +
                     "ğŸ¦ í˜„ì¬ ê¸ˆê³  ì´ì•¡: " + fp(roomData.bankReserve) + "P";
        
        replier.reply(formatAdmin("âš™ï¸ ì¤‘ì•™ì€í–‰ ê¸´ê¸‰ ì¬ì› ìˆ˜í˜ˆ", resMsg));
        return true;
    }

   /* [2] íŠ¹ì • ì¢…ëª© ì‹ ê·œ ìƒì¥/ë¶€í™œ ëª…ë ¹ì–´ */
    if (msg.indexOf("/ì¢…ëª©ì¶”ê°€ ") === 0) {
        var parts = msg.split(" ");
        if (parts.length < 3) {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "í˜•ì‹: /ì¢…ëª©ì¶”ê°€ [ì¢…ëª©ëª…] [ê°€ê²©]"));
            return true;
        }
        var name = parts[1];
        var price = parseInt(parts[2].replace(/,/g, ""));
        if (isNaN(price)) {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "ê°€ê²©ì€ ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”."));
            return true;
        }

        data.stockMarket[name] = {
            price: price, lastPrice: price, type: assignStockType(), 
            delistTick: 0, delistLimit: 5, trend: "none", trendTick: 0
        };

        safeSaveData(data);
        replier.reply(formatAdmin("ğŸ“ˆ ì¢…ëª© ì¶”ê°€ ì™„ë£Œ", "[" + name + "] ì¢…ëª©ì´ " + fp(price) + "Pë¡œ ìƒì¥ë˜ì—ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    /* [ê´€ë¦¬ì] íŠ¹ì • ì¢…ëª© ì´ë¦„ ë° ê°€ê²© ìˆ˜ì • */
    if (msg.indexOf("/ì¢…ëª©ìˆ˜ì • ") === 0) {
        var parts = msg.split(" ");
        if (parts.length < 4) {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "í˜•ì‹: /ì¢…ëª©ìˆ˜ì • [ê¸°ì¡´ì´ë¦„] [ìƒˆì´ë¦„] [ìƒˆê°€ê²©]"));
            return true;
        }
        var oldName = parts[1];
        var newName = parts[2];
        var newPrice = parseInt(parts[3].replace(/,/g, ""));

        if (!data.stockMarket[oldName]) {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "[" + oldName + "] ì¢…ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
            return true;
        }

        var stockData = data.stockMarket[oldName];
        stockData.price = newPrice;
        stockData.lastPrice = newPrice;
        
        if (oldName !== newName) {
            data.stockMarket[newName] = stockData;
            delete data.stockMarket[oldName];
            
            var fixCount = 0;
            for (var r in data.rooms) {
                var users = data.rooms[r].users;
                for (var uid in users) {
                    var u = users[uid];
                    if (u.stockHoldings && u.stockHoldings[oldName] !== undefined) {
                        u.stockHoldings[newName] = u.stockHoldings[oldName];
                        delete u.stockHoldings[oldName];
                        if (u.stockAvg && u.stockAvg[oldName] !== undefined) {
                            u.stockAvg[newName] = u.stockAvg[oldName];
                            delete u.stockAvg[oldName];
                        }
                        fixCount++;
                    }
                }
            }
        }

        safeSaveData(data);
        var res = "âœ… ìˆ˜ì • ì™„ë£Œ: " + oldName + " â” " + newName + "\nğŸ’° ê°€ê²©: " + fp(newPrice) + "P";
        if (oldName !== newName) res += "\nğŸ‘¥ ìœ ì € ë°ì´í„° ì´ì „: " + fixCount + "ëª…";
        
        replier.reply(formatAdmin("ì£¼ì‹ ì‹œì¥ ê°œì…", res));
        return true;
    }

    /* [3] ìœ ì € ë³´ìœ  ìì‚° ê¸°ë°˜ ì‹œì¥ ì¬ê±´ */
    if (msg === "/ì‹œì¥ìì‚°ë³µêµ¬") {
        var roomData = data.rooms[roomName];
        if (!roomData) return true;
        var recoveredCount = 0;
        
        for (var uid in roomData.users) {
            var u = roomData.users[uid];
            if (u.stockHoldings) {
                for (var sName in u.stockHoldings) {
                    if (!data.stockMarket[sName] || data.stockMarket[sName].price <= 10) {
                        var type = assignStockType();
                        var recoverPrice = Number(u.stockAvg ? u.stockAvg[sName] : 1000) || 1000;
                        
                        data.stockMarket[sName] = {
                            price: recoverPrice,
                            lastPrice: recoverPrice,
                            type: type,
                            delistTick: 0,
                            delistLimit: 5,
                            trend: "none",
                            trendTick: 0
                        };
                        recoveredCount++;
                    }
                }
            }
        }

        marketOpenPrice = 1000;
        data.marketOpenPrice = 1000;
        safeSaveData(data);
        
        var resMsg = "âœ… [ìì‚° ê¸°ë°˜ ì‹œì¥ ë³µêµ¬ ì™„ë£Œ]\n" +
                     "- ë¶€í™œì‹œí‚¨ ì¢…ëª© ìˆ˜: " + recoveredCount + "ê°œ\n" +
                     "- ë³µêµ¬ ê¸°ì¤€: ìœ ì € ë³´ìœ  í‰ë‹¨ê°€ ë°˜ì˜\n" +
                     "- ì‹œê°€ ì •ìƒí™”: 1,000P ì„¤ì •";
        replier.reply(formatAdmin("ì‹œìŠ¤í…œ ë³µêµ¬ ë³´ê³ ", resMsg));
        return true;
    }

    /* [4] ê²½ì œ ì§€í‘œ ìƒì„¸ ì¡°íšŒ */
    if (msg === "/ê²½ì œì •ë³´") {
        var eco = calculateEconomy(data, roomName);
        var rData = data.rooms[roomName];
        var base = rData.economyBase || 0;
        
        var multiplier = 1.0;
        if (base > 0) {
            var rawRatio = eco.total / base;
            var damping = (data.economyDamping !== undefined) ? data.economyDamping : 0.5;
            multiplier = 1 + (rawRatio - 1) * damping;
            if (multiplier < 0.5) multiplier = 0.5;
        }

        var ecoMsg = "ğŸ’° ì´ ìˆœìì‚°: " + fp(eco.total) + "P\n" +
                     "ğŸ¦ ì€í–‰ ì¬ê³ : " + fp(rData.bankReserve || 0) + "P\n" +
                     "âš–ï¸ ë¬¼ê°€ ê¸°ì¤€ì : " + (base > 0 ? fp(base) + "P" : "ì„¤ì • ì—†ìŒ") + "\n" +
                     "ğŸ“ˆ í˜„ì¬ ë¬¼ê°€ ë°°ìœ¨: x" + multiplier.toFixed(2) + "\n" +
                     "ğŸ‘¥ í™œì„± ìœ ì €ìˆ˜: " + eco.count + "ëª…\n" +
                     "ğŸ’ ìœ ì €ë‹¹ í‰ê· ìì‚°: " + fp(eco.average) + "P";

        replier.reply(formatAdmin("ì‹¤ì‹œê°„ ê²½ì œ ë¦¬í¬íŠ¸", ecoMsg));
        return true;
    }

    /* [5] ë°ì´í„° êµì • ë° ë¬´ê²°ì„± ê²€ì‚¬ */
    if (msg.trim() === "/ë°ì´í„°êµì •") {
        var fixCount = 0;
        var refundCount = 0;
        var totalRefunded = 0;

        for (var r in data.rooms) {
            var currentRoom = data.rooms[r];
            if (!currentRoom.loanPools) currentRoom.loanPools = {};
            if (!currentRoom.loanContracts) currentRoom.loanContracts = {};

            for (var id in currentRoom.users) {
                var u = currentRoom.users[id];
                if (!u) continue;

                if (Number(u.totalAttendance || 0) <= 3) {
                    for (var cid in currentRoom.loanContracts) {
                        var c = currentRoom.loanContracts[cid];
                        if (c.borrowerUid === id) {
                            var lender = currentRoom.users[c.lenderUid];
                            if (lender) {
                                lender.point = Number(lender.point) + Number(c.currentDebt);
                                totalRefunded += Number(c.currentDebt);
                                refundCount++;
                            }
                            delete currentRoom.loanContracts[cid];
                        }
                    }
                }
                u.point = Math.floor(Number(u.point || 0));
                u.bank = Math.floor(Number(u.bank || 0));
                u.creditScore = Math.min(1000, Math.max(0, Number(u.creditScore || 600)));
                u.isDefaulter = (u.creditScore < 500);
                if (!u.loan) u.loan = { debt: 0, items: [] };
                if (!u.stockHoldings) u.stockHoldings = {};
                fixCount++;
            }
        }
        
        safeSaveData(data);
        var resMsg = "ì „ì²´ ìœ ì € " + fixCount + "ëª… ë™ê¸°í™” ì™„ë£Œ\n" +
                     "ğŸ“‰ ì‚¬ì±„ í™˜ìˆ˜: " + refundCount + "ê±´ (" + fp(totalRefunded) + "P ë°˜í™˜)";
        replier.reply(formatAdmin("ë°ì´í„° êµì • ë° ë¶„ë¦¬ ì™„ë£Œ", resMsg));
        return true;
    }

    /* [6] ë¬¼ê°€ ì¡°ì • */
    if (msg.indexOf("/ë¬¼ê°€ì¡°ì •") === 0) {
        var args = msg.split(" ");
        var currentEco = calculateEconomy(data, roomName); 
        if (args[1] === "ì´ˆê¸°í™”") { data.rooms[roomName].economyBase = 0; safeSaveData(data); replier.reply(formatAdmin("âš–ï¸ ë¬¼ê°€ ì´ˆê¸°í™”", "ê¸°ë³¸ê°€ë¡œ ê³ ì •ë©ë‹ˆë‹¤.")); return true; }
        var oldBase = data.rooms[roomName].economyBase || currentEco.total;
        var newBase = (args.length > 1 && !isNaN(parseInt(args[1]))) ? parseInt(args[1]) : Math.floor(Math.sqrt(oldBase * currentEco.total));
        data.rooms[roomName].economyBase = newBase;
        safeSaveData(data);
        replier.reply(formatAdmin("âš–ï¸ ë¬¼ê°€ ì¡°ì • ì™„ë£Œ", "ìƒˆ ê¸°ì¤€: " + fp(newBase) + "P"));
        return true;
    }

    /* [7] ë¬¼ê°€ ì™„ì¶© ë¹„ìœ¨ ì„¤ì • */
    if (msg.indexOf("/ë¬¼ê°€ì™„ì¶©") === 0) {
        var val = parseFloat(msg.split(" ")[1]);
        if (isNaN(val) || val < 0.0 || val > 1.0) { replier.reply(formatAdmin("ì˜¤ë¥˜", "0.0 ~ 1.0 ì‚¬ì´ì˜ ì†Œìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")); return true; }
        data.economyDamping = val;
        safeSaveData(data);
        replier.reply(formatAdmin("ğŸ›¡ï¸ ë¬¼ê°€ ì™„ì¶© ì„¤ì • ì™„ë£Œ", "ì ìš© ë¹„ìœ¨: " + (val*100) + "%"));
        return true;
    }

    /* [8] í¬ì¸íŠ¸ ì§€ê¸‰ */
    if (msg.indexOf("/í¬ì¸íŠ¸ì§€ê¸‰ ") === 0) {
        var parts = msg.trim().split(/\s+/);
        if (parts.length < 3) { replier.reply(formatError(user, "í˜•ì‹ ì˜¤ë¥˜", "/í¬ì¸íŠ¸ì§€ê¸‰ [ë‹‰ë„¤ì„] [ê¸ˆì•¡]")); return true; }
        var am = parseInt(parts.pop());
        var tn = parts.slice(1).join(" ").trim();
        var roomData = data.rooms[roomName];
        var found = findUserByName(roomData, tn);
        if (found.length === 0) { replier.reply(formatError(user, "ëŒ€ìƒ ì—†ìŒ", "[" + tn + "]ë‹˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (found.length > 1) { handleUserSelection(replier, targetUid, found, "admin_point_give", { amount: am }, user); return true; }
        
        var targetUser = found[0].data;
        util_updatePoint(targetUser, null, am, "ê´€ë¦¬ì ì§ì ‘ ì§€ê¸‰", roomName);
        replier.reply(formatAdmin("í¬ì¸íŠ¸ ì§€ê¸‰ ì™„ë£Œ", getDisplayName(targetUser) + "ë‹˜: +" + fp(am) + "P"));
        safeSaveData(data);
        return true;
    }

    /* [9] í¬ì¸íŠ¸ ì°¨ê° (ê°•í™”: ì”ì•¡ ì´ˆê³¼ ì°¨ê° ì‹œ ì•ˆë‚´ ë¬¸êµ¬ ì¶”ê°€) */
    if (msg.indexOf("/í¬ì¸íŠ¸ì°¨ê° ") === 0) {
        var parts = msg.trim().split(/\s+/);
        if (parts.length < 3) { replier.reply(formatError(user, "í˜•ì‹ ì˜¤ë¥˜", "/í¬ì¸íŠ¸ì°¨ê° [ë‹‰ë„¤ì„] [ê¸ˆì•¡]")); return true; }
        var requestedAmount = parseInt(parts.pop());
        var tn = parts.slice(1).join(" ").trim();
        var roomData = data.rooms[roomName];
        var found = findUserByName(roomData, tn);

        if (found.length === 0) { replier.reply(formatError(user, "ëŒ€ìƒ ì—†ìŒ", "[" + tn + "]ë‹˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (found.length > 1) { handleUserSelection(replier, targetUid, found, "admin_point_take", { amount: requestedAmount }, user); return true; }
        
        var targetUser = found[0].data;
        var currentPoint = Number(targetUser.point);
        
        // ì‹¤ì œë¡œ ê°€ì ¸ê°ˆ ìˆ˜ ìˆëŠ” ì–‘ ê³„ì‚°
        var actualTake = Math.min(currentPoint, requestedAmount);
        var isShortage = requestedAmount > currentPoint;

        // ì‹¤ì œ ì°¨ê° ì§‘í–‰ (ì„¹í„° 7ì˜ util_updatePoint í˜¸ì¶œ)
        util_updatePoint(targetUser, roomData, -actualTake, "ê´€ë¦¬ì ì§ì ‘ ì°¨ê°", roomName);
        
        var resContent = getDisplayName(targetUser) + "ë‹˜: -" + fp(actualTake) + "P ì°¨ê° ì™„ë£Œ";
        if (isShortage) {
            resContent += "\n(âš ï¸ ìš”ì²­ì•¡ " + fp(requestedAmount) + "P ì¤‘ ì”ì•¡ ë¶€ì¡±ìœ¼ë¡œ ë³´ìœ  ì „ì•¡ ì°¨ê°)";
        }
        resContent += "\ní˜„ì¬ ì”ì•¡: 0P";

        replier.reply(formatAdmin("í¬ì¸íŠ¸ ì°¨ê° ë³´ê³ ", resContent));
        safeSaveData(data);
        return true;
    }

    /* [10] ì „ì²´ í¬ì¸íŠ¸ ì§€ê¸‰ */
    if (msg.indexOf("/ì „ì²´í¬ì¸íŠ¸ì§€ê¸‰ ") === 0) {
        var amt = parseInt(msg.split(" ")[1]);
        if (isNaN(amt)) return true;
        var count = 0;
        for (var r in data.rooms) {
            for (var id in data.rooms[r].users) {
                data.rooms[r].users[id].point = Number(data.rooms[r].users[id].point) + amt;
                count++;
            }
        }
        safeSaveData(data);
        replier.reply(formatAdmin("ì „ì²´ ì§€ê¸‰ ì™„ë£Œ", "ì´ " + count + "ëª…ì—ê²Œ " + fp(amt) + "P ì§€ê¸‰ ì™„ë£Œ"));
        return true;
    }

    /* [11] í¬ì¸íŠ¸ ë¿Œë¦¬ê¸° (ë°©ë³„ ë…ë¦½ ì—”ì§„ ì°¸ì¡° ìœ ì§€ ë²„ì „) */
    if (msg === "/ë¿Œë¦¬ê¸°") {
        if (sprinkleData.active) { 
            replier.reply(formatAdmin("ì˜¤ë¥˜", "ì´ë¯¸ ë¿Œë¦¬ê¸°ê°€ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.")); 
            return true; 
        }
        
        var roomData = data.rooms[roomName];
        var count = Math.floor(Math.random() * 3) + 2; 
        var multiplier = 1.0;
        
        if (roomData.economyBase && roomData.economyBase > 0) {
            var eco = calculateEconomy(data, roomName);
            multiplier = 1 + (eco.total / roomData.economyBase - 1) * (data.economyDamping || 0.5);
        }
        
        var portions = [];
        var totalSprinkle = 0;
        for(var i=0; i<count; i++) {
            var baseP = Math.floor(Math.random() * 501) + 500; 
            var finalP = Math.floor(baseP * multiplier);
            portions.push(finalP);
            totalSprinkle += finalP;
        }

        /* [Gemini ìš”ì²­ ì‚¬í•­] ì°¸ì¡° ë³´ì¡´ ë°©ì‹ì˜ ë°ì´í„° ì—…ë°ì´íŠ¸ */
        // ì„¤ëª…: sprinkleData = { ... } ì‹ì˜ ì¬í• ë‹¹ì€ ì„¹í„° 19ì˜ ë§¤í•‘ì„ íŒŒê´´í•˜ë¯€ë¡œ 
        // ê¸°ì¡´ ê°ì²´ì˜ ì†ì„±ê°’ë§Œ ìˆ˜ì •í•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ì™€ì˜ ì—°ê²°ì„ ìœ ì§€í•©ë‹ˆë‹¤.
        sprinkleData.active = true;
        sprinkleData.totalPoint = totalSprinkle;
        sprinkleData.remainingPoint = totalSprinkle;
        sprinkleData.limit = count;
        sprinkleData.currentWinners = 0;
        sprinkleData.winners = [];
        sprinkleData.portions = portions;

        Api.replyRoom(roomName, formatAdmin("ğŸ‰ í¬ì¸íŠ¸ ë¿Œë¦¬ê¸° ì‹œì‘!", "ì„ ì°©ìˆœ " + count + "ëª…!\nì±„íŒ…ì°½ì— [ì¤ê¸°]ë¥¼ ì…ë ¥í•˜ì„¸ìš”!\nğŸ’° ì´ ë°°ì •: " + fp(totalSprinkle) + "P"));
        
        // 1ë¶„ í›„ ìë™ ì¢…ë£Œ íƒ€ì´ë¨¸
        setTimeout(function() { 
            if (sprinkleData.active) { 
                sprinkleData.active = false; 
                Api.replyRoom(roomName, formatAdmin("ğŸ ë¿Œë¦¬ê¸° ì‹œê°„ ì´ˆê³¼", "ì´ë²¤íŠ¸ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")); 
                safeSaveData(globalData);
            } 
        }, 60000);
        
        safeSaveData(data);
        return true;
    }

    /* [12] ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì„¸íŠ¸ */
    if (msg === "/ë¡œë˜ë°ì´í„°ì´ˆê¸°í™”") {
        lotto = { round: (lotto.round || 0) + 1, entries: {}, dailyPool: 0, jackpot: 0, lastWinNums: [] };
        safeSaveData(data);
        replier.reply(formatAdmin("ì™„ë£Œ", "ë¡œë˜ ì‹œìŠ¤í…œ ë¦¬ì…‹ ì™„ë£Œ"));
        return true;
    }
    if (msg === "/ìŠ¹ê¸‰íšŸìˆ˜ì´ˆê¸°í™”") {
        for (var r in data.rooms) {
            for (var id in data.rooms[r].users) {
                data.rooms[r].users[id].dailyPromotionAttempts = 1;
                data.rooms[r].users[id].purchasedPromotionAttempts = 0;
            }
        }
        safeSaveData(data);
        replier.reply(formatAdmin("ì™„ë£Œ", "ì „ì²´ ìŠ¹ê¸‰ ê¸°íšŒ ì´ˆê¸°í™”"));
        return true;
    }
    if (msg === "/ì‹œì¦Œê°•ì œì¢…ë£Œ") {
        for (var r in data.rooms) {
            for (var id in data.rooms[r].users) { data.rooms[r].users[id].tier = 0; }
        }
        safeSaveData(data);
        replier.reply(formatAdmin("ì™„ë£Œ", "ëª¨ë“  ìœ ì € í‹°ì–´ ì´ˆê¸°í™”"));
        return true;
    }

    /* [13] ì‹œìŠ¤í…œ ìê°€ ë³µì› (ë”¥ ì˜µí‹°ë§ˆì´ì§• ë²„ì „) */
    if (msg.trim() === "/ì‹œìŠ¤í…œìê°€ë³µì›") {
        // 1. íœ˜ë°œì„± ìƒíƒœê°’ ë° í™œë™ ë½(Lock) ì¼ê´„ í•´ì œ
        lottoPurchaseState = {}; 
        sprinkleData = { active: false, winners: [] };
        activeThefts = {}; 
        duelData = {}; 
        selectWaitState = {};
        bankProcessState = {}; 
        menuWaitState = {};
        miningState = {}; // ê´‘ì‚° í™œë™ ì´ˆê¸°í™”
        feverData = { active: false, endTime: 0, scheduled: [] }; // í”¼ë²„íƒ€ì„ ìƒíƒœ ì´ˆê¸°í™”

        // 2. UID ìºì‹œ ì´ˆê¸°í™” (ë©”ëª¨ë¦¬ ì •ë¦¬)
        if (typeof uidCache !== 'undefined') uidCache = {};

        // 3. ì‹œìŠ¤í…œ í•µì‹¬ ê²½ì œ ì§€í‘œ ë³µêµ¬
        if (!data.marketOpenPrice || data.marketOpenPrice <= 0) data.marketOpenPrice = 1000;
        marketOpenPrice = data.marketOpenPrice; // ì „ì—­ ë³€ìˆ˜ ë™ê¸°í™”

        // 4. ì „ ìœ ì € ë°ì´í„° ìˆ˜ì¹˜ ì •ê·œí™” ë° í•„ìˆ˜ í•„ë“œ ë³µêµ¬
        var fixCount = 0;
        for (var r in data.rooms) {
            var roomObj = data.rooms[r];
            
            // ì¤‘ì•™ì€í–‰ ì¬ì› ëˆ„ë½ ì‹œ ë³µêµ¬
            if (roomObj.bankReserve === undefined || roomObj.bankReserve === null) {
                roomObj.bankReserve = SYSTEM_CONFIG.ECO.BANK.INITIAL_RESERVE;
            }
            // ìœ„ê¸° ì•Œë¦¼ ìƒíƒœ ë¦¬ì…‹
            roomObj.lastBankAlert = "normal";

            for (var id in roomObj.users) {
                var u = roomObj.users[id];
                if (!u) continue;
                u.point = Math.floor(Number(u.point || 0));
                u.bank = Math.floor(Number(u.bank || 0));
                u.creditScore = Math.min(1000, Math.max(0, Number(u.creditScore || 600)));
                
                if (!u.loan) u.loan = { debt: 0, items: [] };
                if (!u.stockHoldings) u.stockHoldings = {};
                fixCount++;
            }
        }

        // 5. íŒŒì¼ ì‹œìŠ¤í…œ ë½(Lock) ê°•ì œ í•´ì œ ì‹œë„
        if (lock.isLocked()) {
            try { lock.unlock(); } catch(e) {}
        }

        safeSaveData(data);
        replier.reply(formatAdmin("âš™ï¸ ì‹œìŠ¤í…œ ìê°€ ë³µì› ì™„ë£Œ", 
            "1. ëª¨ë“  ì…ë ¥ ëŒ€ê¸° ë° í™œë™ ìƒíƒœ ì´ˆê¸°í™”\n" +
            "2. ì¤‘ì•™ì€í–‰ ì¬ì› ë° ì£¼ì‹ ì‹œì„¸ ì§€í‘œ ë³µêµ¬\n" +
            "3. êµ­ê°€ ìœ„ê¸° ì•Œë¦¼ ì—”ì§„ ë¦¬ì…‹\n" +
            "4. ìœ ì € " + fixCount + "ëª…ì˜ ë°ì´í„° ì •ìˆ˜í™” ì™„ë£Œ"));
        return true;
    }

    if (msg.trim() === "/ì „ì²´ë³µì›") {
        var stablePath = BACKUP_DIR + "last_stable_backup.json";
        if (!new java.io.File(stablePath).exists()) { replier.reply(formatAdmin("ì˜¤ë¥˜", "ë°±ì—… íŒŒì¼ ìœ ì‹¤")); return true; }
        var content = FileStream.read(stablePath);
        FileStream.write(FILE_PATH, content);
        globalData = JSON.parse(content);
        replier.reply(formatAdmin("ì„±ê³µ", "ë°ì´í„° ì „ì²´ ë¡¤ë°± ì„±ê³µ"));
        return true;
    }

    return false;
}

//==========ì„¹í„°36==========

/**
 * [ê²Œì„ ëª…ë ¹ì–´ ë¶„ë°°ê¸°] (Game Logic Dispatcher - Registry Refactored)
 * ì„¤ëª…: ìœ ì €ë“¤ì˜ ê²Œì„/ê²½ì œ í™œë™ ëª…ë ¹ì–´ë¥¼ ê° ì „ë¬¸ ë‹´ë‹¹ í•¨ìˆ˜ë¡œ ì—°ê²°í•©ë‹ˆë‹¤.
 * ì„¹í„° 1ì˜ USER_COMMANDS ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¥¼ ì°¸ì¡°í•˜ì—¬ ë“±ë¡ëœ ë¡œì§ì„ ìë™ìœ¼ë¡œ ë§¤í•‘ ë° ì‹¤í–‰í•©ë‹ˆë‹¤.
 */
function _handleGameLogic(msg, user, data, replier, roomName, targetUid, sender) {
    
    // 1. ëª…ë ¹ì–´ ì²« ë‹¨ì–´ ì¶”ì¶œ (ì˜ˆ: "/í™€ì§ 100" -> "/í™€ì§")
    var cmd = msg.split(" ")[0];

    // 2. ìœ ì € ëª…ë ¹ì–´ ë ˆì§€ìŠ¤íŠ¸ë¦¬(USER_COMMANDS)ì—ì„œ í•´ë‹¹ ëª…ë ¹ì–´ ê²€ìƒ‰
    // ì„¹í„° 6ì—ì„œ ë“±ë¡ëœ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìµœì í™”ëœ íƒìƒ‰ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
    if (USER_COMMANDS[cmd] && typeof USER_COMMANDS[cmd].execute === 'function') {
        
        // 3. ë“±ë¡ëœ í•˜ìœ„ ë¡œì§ í•¨ìˆ˜(ì„¹í„° 40~44 ë° ë¡œë˜/ê´‘ì‚°/ê°€ë°© ë“±)ë¥¼ ì¦‰ì‹œ ì‹¤í–‰ ë° ê²°ê³¼ ë°˜í™˜
        // ì‹¤í–‰ ì‹œ í•„ìš”í•œ ëª¨ë“  ì»¨í…ìŠ¤íŠ¸ ê°ì²´ë¥¼ ì¸ìë¡œ ì „ë‹¬í•˜ì—¬ ìœ„ì„í•©ë‹ˆë‹¤.
        return USER_COMMANDS[cmd].execute(msg, user, data, replier, roomName, targetUid);
    }

    // 4. ë“±ë¡ë˜ì§€ ì•Šì€ ëª…ë ¹ì–´ì´ê±°ë‚˜ ì²˜ë¦¬í•  ë¡œì§ì´ ì—†ëŠ” ê²½ìš° false ë°˜í™˜
    return false;
}

//==========ì„¹í„°37==========

/**
 * [ê²Œì„ í•˜ìœ„ ëª¨ë“ˆ 1] ì€í–‰ ë° ì‚¬ì±„ ê´€ë¦¬
 * ê¸°ëŠ¥: ì€í–‰ ë©”ë‰´ í˜¸ì¶œ, ëŒ€ì¶œê¸ˆ ì§ì ‘ ìƒí™˜
 * ì„¤ëª…: ë©”ë‰´ UIì— ê¸°ë¶€ í•­ëª©ì„ ì¶”ê°€í•˜ê³ , ìƒí™˜ ì‹œ ì¤‘ì•™ì€í–‰ ì¬ê³ ë¡œ í™˜ìˆ˜ë˜ë„ë¡ ì—°ë™í•¨.
 */
function _gameBankLogic(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];
    if (!roomData) return false;

    /* [ê¸°ëŠ¥ 1] ì€í–‰ ì‹œìŠ¤í…œ ì§„ì… (v5.2 ê¸°ë¶€ ë©”ë‰´ ì¶”ê°€) */
    if (msg === "/ì€í–‰") {
        menuWaitState[targetUid] = { type: 'bank_menu', time: Date.now() };
        var bankMenu = "1. ğŸ’° ì˜ˆê¸ˆ (í¬ì¸íŠ¸ â” ì€í–‰)\n" +
                       "2. ğŸ§ ì¶œê¸ˆ (ì€í–‰ â” í¬ì¸íŠ¸)\n" +
                       "3. ğŸ’¸ ì†¡ê¸ˆ (íƒ€ì¸ì—ê²Œ ì´ì²´)\n" +
                       "4. ğŸ¦ ëŒ€ì¶œ (ì‹ ìš©ë“±ê¸‰ë³„)\n" +
                       "5. ğŸ“‰ ìƒí™˜ (ëŒ€ì¶œê¸ˆ ê°šê¸°)\n" +
                       "6. " + (SYSTEM_CONFIG.MSG.PREFIX.LOAN || "ğŸš¬") + " ì‚¬ì±„ ì‹œì¥ (P2P ëŒ€ì¶œ)\n" +
                       "7. ğŸ ê¸°ë¶€ (êµ­ê³  í›„ì›)"; // [ì‹ ê·œ] ê¸°ë¶€ í•­ëª© ì¶”ê°€
        
        var myPoint = Number(user.point || 0);
        var myBank = Number(user.bank || 0);
        
        var content = bankMenu + "\n\n" +
               "ğŸ¦ ì€í–‰ ì”ê³  : " + fp(roomData.bankReserve) + "P\n\n" +
               "ë³´ìœ : " + fp(myPoint) + "P / ì˜ˆê¸ˆ: " + fp(myBank) + "P\n" +
               "(ë²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”)";

        // formatCommandë¥¼ í˜¸ì¶œí•˜ì—¬ ìµœì¢… ë©”ì‹œì§€ ì¡°ë¦½
        replier.reply(formatCommand("ğŸ¦ ì€í–‰ ì—…ë¬´ ì„ íƒ", user, content, "ì…ë ¥ ëŒ€ê¸°: 30ì´ˆ"));
        return true;
    }

    /* [ê¸°ëŠ¥ 2] ëŒ€ì¶œê¸ˆ ìƒí™˜ (ì§ì ‘ ëª…ë ¹ì–´) */
    if (msg.indexOf("/ìƒí™˜ ") === 0) {
        var myDebt = (user.loan && user.loan.debt) ? Number(user.loan.debt) : 0;
        if (myDebt <= 0) { 
            replier.reply(formatError(user, "ìƒí™˜ ë¶ˆê°€", "ê°šì•„ì•¼ í•  ì€í–‰ ëŒ€ì¶œê¸ˆì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")); 
            return true; 
        }

        var parts = msg.split(" ");
        // ì‰¼í‘œê°€ í¬í•¨ëœ ì…ë ¥ë„ ì²˜ë¦¬ ê°€ëŠ¥í•˜ë„ë¡ ê°œì„ 
        var amt = parseInt(parts[1].replace(/,/g, "")); 
        
        if (isNaN(amt) || amt <= 0) { 
            replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜", "ì •í™•í•œ ìƒí™˜ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.")); 
            return true; 
        }
        
        var myPoint = Number(user.point || 0);
        if (myPoint < amt) { 
            replier.reply(formatError(user, "í¬ì¸íŠ¸ ë¶€ì¡±", "ë³´ìœ  í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.")); 
            return true; 
        }
        
        // ë¶„ì‚° ìƒí™˜ ë¡œì§ í˜¸ì¶œ (ì„¹í„° 13 ì •ì˜)
        var res = distributeRepayment(user, amt);
        
        /* [ì¤‘ì•™ì€í–‰ ì—°ë™] í†µí•© í¬ì¸íŠ¸ í•¨ìˆ˜ ì‚¬ìš© */
        // ìœ ì € í¬ì¸íŠ¸ ì°¨ê°ê³¼ ë™ì‹œì— ì°¨ê°ëœ ê¸ˆì•¡(res.actualRepay)ì´ bankReserveì— ìë™ ì…ê¸ˆë¨.
        util_updatePoint(user, roomData, -Number(res.actualRepay), "ëŒ€ì¶œ ìƒí™˜");
        
        var remainingDebt = (user.loan && user.loan.debt) ? Number(user.loan.debt) : 0;
        replier.reply(formatCommand("ğŸ“‰ ìƒí™˜ ì™„ë£Œ", user, fp(res.actualRepay) + "P ìƒí™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\n(ì‹ ìš© ì ìˆ˜ +" + res.creditGain + ")", "ë‚¨ì€ ëŒ€ì¶œ: " + fp(remainingDebt) + "P / ì”ì•¡: " + fp(user.point) + "P"));
        
        safeSaveData(data);
        return true;
    }

    return false;
}

//==========ì„¹í„°38==========

/**
 * [ê²Œì„ í•˜ìœ„ ëª¨ë“ˆ 2] ì •ë³´ ë° ë­í‚¹ ì¡°íšŒ (UI ìµœì í™” ë° ì¶œì„ ìƒíƒœ ì¶”ê°€)
 * ê¸°ëŠ¥: ë‚´ì •ë³´, ìœ ë¬¼ë„ê°, ì‹ ìš©ë“±ê¸‰, ëŒ€ì¶œí•œë„, ëª…ì˜ˆì˜ì „ë‹¹, ìˆœìœ„, ìœ ì €ì •ë³´, ê²½ë§ˆì¡°íšŒ
 * ìˆ˜ì • ì‚¬í•­: ë„êµ´ì™• ë‹¬ì„± ì‹œ íŠ¹ë³„ ì¶•í•˜ ë©˜íŠ¸ ì ìš© ë° ìœ ë¬¼ ë„ê° UI ìµœì¢… ìµœì í™”
 */
function _gameInfoLogic(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];

    /* [Gemini ìš”ì²­ ì‚¬í•­] ê²½ë§ˆ ì •ë³´ ì‹¤ì‹œê°„ ë¸Œë¦¬í•‘ ê¸°ëŠ¥ í†µí•© (ë‚´ ë°°íŒ… ì •ë³´ í¬í•¨) */
    if (msg === "/ê²½ë§ˆ") {
        if (!racingData.isOperating) {
            replier.reply(formatSimple("ğŸ‡ ê²½ë§ˆì¥ íœ´ì¥ ì•ˆë‚´", "í˜„ì¬ ê²½ë§ˆ ìš´ì˜ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤.\n(ìš´ì˜ì‹œê°„: 09:00 ~ 23:59)", "ì˜¤ì „ 9ì‹œ ì •ê°ì— ê°œì¥í•©ë‹ˆë‹¤."));
            return true;
        }

        var hList = racingData.horses.map(function(h) {
            var horseBetSum = 0;
            for (var uid in racingData.bets) {
                if (racingData.bets[uid].horseId === h.id) horseBetSum += Number(racingData.bets[uid].amount);
            }
            return h.id + ". " + h.name + " [" + h.icon + "]\n    â”” í˜„ ë°°íŒ…ì•¡: " + fp(horseBetSum) + "P";
        }).join("\n");

        var now = new Date();
        var nowMin = now.getMinutes();
        var remainMin = 49 - nowMin;
        var remainSec = 59 - now.getSeconds();
        if (remainMin < 0) { remainMin = 0; remainSec = 0; }

        var myBet = racingData.bets[targetUid];
        var myBetInfo = "";
        if (myBet) {
            var myHorse = racingData.horses[myBet.horseId - 1]; 
            myBetInfo = "ğŸ‘¤ ë‚´ ë°°íŒ…: " + myBet.horseId + "ë²ˆ " + myHorse.name + " (" + fp(myBet.amount) + "P)";
        } else {
            myBetInfo = "ğŸ‘¤ ë‚´ ë°°íŒ…: ì°¸ì—¬ ë‚´ì—­ ì—†ìŒ";
        }

        var raceHeader = (nowMin >= 50) ? "ğŸ ë°°íŒ… ë§ˆê° ë° ì •ì‚° ì¤‘" : "ì œ " + racingData.round + "íšŒì°¨ ê²½ê¸° ë°°íŒ… ì§„í–‰ ì¤‘";
        var totalPrizePool = racingData.totalPool + racingData.carryOver;
        var racingBody = raceHeader + "\n\n" +
                         "[ğŸ‡ ì¶œì „ë§ˆ ë¼ì¸ì—…]\n" + hList + "\n\n" +
                         myBetInfo + "\n" +
                         "ğŸ’° í˜„ì¬ ì´ ë°°ë‹¹ê¸ˆ: " + fp(totalPrizePool) + "P\n" +
                         (racingData.carryOver > 0 ? "âœ¨ ì´ì›” ì ë¦½ê¸ˆ: " + fp(racingData.carryOver) + "P í¬í•¨\n" : "") +
                         "ğŸ•’ ë°°íŒ… ë§ˆê°: " + remainMin + "ë¶„ " + remainSec + "ì´ˆ ë‚¨ìŒ";

        replier.reply(formatCommand("ğŸ‡ ë‚´ë¦¬ë‹¤ ì¤‘ì•™ ê²½ë§ˆì¥", user, racingBody, "ë°°íŒ…: [/ë°°íŒ… ë²ˆí˜¸ ê¸ˆì•¡]"));
        return true;
    }

    /* [ê¸°ëŠ¥ 3] ë‚´ ì •ë³´ ì¡°íšŒ */
    if (msg === "/ë‚´ì •ë³´") {
        var cr = getCreditInfo(user.creditScore);
        var authInfo = "ğŸ® ê²Œì„ ì¸ì¦: " + (user.gameAuthCount || 0) + "/2 (ì‹œì¦Œ)";
        
        var bankDebt = (user.loan && user.loan.debt) ? Math.floor(Number(user.loan.debt)) : 0;
        var sacheDebt = 0;
        var sacheClaims = 0; 
        var overdueSache = 0;

        if (roomData && roomData.loanContracts) {
            for (var cid in roomData.loanContracts) {
                var c = roomData.loanContracts[cid];
                if (c.borrowerUid === targetUid) {
                    sacheDebt += Math.floor(c.currentDebt);
                    if (c.status === 'overdue') overdueSache += Math.floor(c.currentDebt);
                }
                if (c.lenderUid === targetUid) {
                    sacheClaims += Math.floor(c.currentDebt);
                }
            }
        }

        var todayStr = getSimpleDate();
        var attendMark = (user.lastDate === todayStr) ? " (âœ…)" : " (â³)";
        var totalPromotion = (Number(user.dailyPromotionAttempts) || 0) + (Number(user.purchasedPromotionAttempts) || 0);

        var infoBody = authInfo + "\n" +
                       "ğŸ’° ë³´ìœ  í¬ì¸íŠ¸: " + fp(user.point) + "P\n" +
                       "ğŸ¦ ì˜ˆê¸ˆ: " + fp(user.bank) + "P\n" +
                       (sacheClaims >= 1 ? "ğŸ¤ ë¯¸ìˆ˜ ì±„ê¶Œ: " + fp(sacheClaims) + "P\n" : "") +
                       "ğŸ’³ ì‹ ìš© ë“±ê¸‰: " + cr.label + " (" + user.creditScore + "ì )\n" +
                       "ğŸ… í˜„ì¬ í‹°ì–´: " + (TIERS[user.tier] || "ì•„ì´ì–¸") + "\n" +
                       "ğŸ“… ëˆ„ì  ì¶œì„: " + (user.totalAttendance || 0) + "ì¼" + attendMark + "\n" +
                       "ğŸ”‚ ìŠ¹ê¸‰ ê¸°íšŒ: " + totalPromotion + "íšŒ";
        
        if (bankDebt > 0) {
            var transferTag = user.isTransferred ? " (ğŸš¨ëŒ€í™˜ ì±„ë¬´: 70% ê°•ì œìƒí™˜)" : "";
            infoBody += "\nğŸ¦ ë¯¸ìƒí™˜ ëŒ€ì¶œ: " + fp(bankDebt) + "P" + transferTag;
        }

        if (sacheDebt > 0) {
            infoBody += "\nğŸš¬ ë¯¸ìƒí™˜ ì‚¬ì±„: " + fp(sacheDebt) + "P";
            if (overdueSache > 0) infoBody += "\nğŸš¨ ì‚¬ì±„ ì—°ì²´: " + fp(overdueSache) + "P (50% ìë™ìƒí™˜)";
        }
        
        replier.reply(formatCommand("ğŸ“Œ ë‚´ ìƒì„¸ ì •ë³´", user, infoBody, "ì•„ì´í…œ êµ¬ë§¤: [/ìƒì ]")); 
        return true;
    }

    /* [Gemini ìš”ì²­ ì‚¬í•­] ìœ ë¬¼ ë„ê° ì¡°íšŒ UI ê°€ë³€ ì²˜ë¦¬ ìë™í™” */
    if (msg === "/ìœ ë¬¼ë„ê°") {
        var pieces = Number(user.artifactPieces || 0);
        
        // 1. í˜„ì¬ ì¡°ê° ìˆ˜ì— ë”°ë¥¸ ë‹¤ìŒ ëª©í‘œì¹˜ì™€ ëª©í‘œ ì¹­í˜¸ ì„¤ì •
        var targetGoal = 10;
        var nextTitle = "ë„êµ´ê¾¼";

        if (pieces >= 50) { 
            targetGoal = 50; 
            nextTitle = "ë„êµ´ì™• âšœï¸"; 
        } else if (pieces >= 40) { 
            targetGoal = 50; 
            nextTitle = "ë„êµ´ì™• âšœï¸"; 
        } else if (pieces >= 30) { 
            targetGoal = 40; 
            nextTitle = "íŠ¸ë ˆì €í—Œí„°"; 
        } else if (pieces >= 20) { 
            targetGoal = 30; 
            nextTitle = "ë°œêµ´ê°€"; 
        } else if (pieces >= 10) { 
            targetGoal = 20; 
            nextTitle = "íƒì‚¬ì›"; 
        } else { 
            targetGoal = 10; 
            nextTitle = "ë„êµ´ê¾¼"; 
        }

        // 2. ë‹¬ì„± ìƒíƒœ í…ìŠ¤íŠ¸ íŒë³„
        var statusTxt = (pieces >= 50) ? "ì „ì„¤ ë“±ê·¹!" : "ì§„í–‰ ì¤‘...";
        
        // 3. UI ë°”ë”” êµ¬ì„±
        var statusContent = "âœ¨ ìœ ë¬¼ ì¡°ê°\n" +
                            "ğŸ§© ë³´ìœ : " + pieces + " / " + targetGoal + " ê°œ\n\n" +
                            "ğŸ ìˆ˜ì§‘ ë‹¬ì„± ë³´ìƒ\n" +
                            "ğŸ–ï¸ ì¹­í˜¸: [" + nextTitle + "] (" + statusTxt + ")";
        
        // 4. ê°€ì´ë“œ ë¬¸êµ¬ ê°€ë³€ ì²˜ë¦¬
        var guideText = (pieces >= 50) 
            ? "ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ê³ ëŒ€ì˜ ì‹ ë¹„ë¥¼ ëª¨ë‘ í’€ì–´ë‚¸ ë‹¹ì‹ ì€ ì´ ì‹œëŒ€ì˜ ì§„ì •í•œ ì „ì„¤, ë„êµ´ì™•ì´ì‹­ë‹ˆë‹¤!" 
            : "ê´‘ì‚°ì—ì„œ 0.1% í™•ë¥ ë¡œ ì¡°ê°ì´ ë°œê²¬ë©ë‹ˆë‹¤. " + targetGoal + "ê°œë¥¼ ëª¨ìœ¼ë©´ ìë™ìœ¼ë¡œ ì¹­í˜¸ê°€ ë¶€ì—¬ë©ë‹ˆë‹¤.";
        
        replier.reply(formatCommand("ğŸº ìœ ë¬¼ ë„ê°", user, statusContent, guideText));
        return true;
    }

    /* [ê¸°ëŠ¥ 4] ì‹ ìš© ë“±ê¸‰ ë° ëŒ€ì¶œ í•œë„ ì¡°íšŒ */
    if (msg === "/ì‹ ìš©ë“±ê¸‰" || msg === "/ëŒ€ì¶œí•œë„") {
        var cr = getCreditInfo(user.creditScore);
        var table = getCreditLimitTable(); 
        var myCredit = "\n[ë‚´ ì‹ ìš© ìƒíƒœ]\nì ìˆ˜: " + user.creditScore + "ì \në“±ê¸‰: " + cr.label + "\nëŒ€ì¶œ ê°€ëŠ¥ í•œë„: " + fp(cr.limit) + "P";
        replier.reply(formatCommand("ğŸ’³ ì‹ ìš© ë“±ê¸‰ ë° í•œë„", user, table + "\n" + myCredit, "ì€í–‰ ì´ìš©: [/ì€í–‰]"));
        return true;
    }

    /* [ê¸°ëŠ¥ 5] ëª…ì˜ˆì˜ ì „ë‹¹ */
    if (msg === "/ëª…ì˜ˆì˜ì „ë‹¹") {
        var challengers = [];
        var roomUsers = roomData.users;
        for (var id in roomUsers) {
            var u = roomUsers[id];
            if (u && u.tier === 9) {
                var count = Math.max(1, u.challengerCount || 0);
                challengers.push("ğŸ† " + u.name + " (ëˆ„ì  " + count + "íšŒ)");
            }
        }
        var content = challengers.length > 0 ? challengers.join("\n") : "í˜„ì¬ ì´ ë°©ì— ë“±ë¡ëœ ì±Œë¦°ì €ê°€ ì—†ìŠµë‹ˆë‹¤.";
        replier.reply(formatSimple("ğŸ… ëª…ì˜ˆì˜ ì „ë‹¹", content, "ìµœê³  í‹°ì–´ ë‹¬ì„± ì‹œ ë“±ë¡ë©ë‹ˆë‹¤."));
        return true;
    }

    /* [ê¸°ëŠ¥ 6] ìì‚° ìˆœìœ„ */
    if (msg === "/ì¶œì„ìˆœìœ„") {
        var users = [];
        var roomUsers = roomData.users;
        for (var id in roomUsers) {
            var u = roomUsers[id];
            var netWorth = util_calculateNetWorth(u, roomData);
            if (netWorth >= 1) users.push({ data: u, total: netWorth });
        }
        users.sort(function(a, b) { return b.total - a.total; });
        var rankList = [];
        for (var i = 0; i < Math.min(10, users.length); i++) {
            rankList.push((i + 1) + ". " + getDisplayName(users[i].data) + " (" + fp(users[i].total) + "P)");
        }
        var rankMsg = (rankList.length > 0 ? rankList.join("\n") : "ìˆœìœ„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        replier.reply(formatSimple("ìì‚° ë­í‚¹ (ì‹¤ì§ˆ ìˆœìì‚° ê¸°ì¤€)", rankMsg, "ë‚´ ì •ë³´: [/ë‚´ì •ë³´]"));
        return true;
    }

    /* [ê¸°ëŠ¥ 7] ìœ ì € ì •ë³´ ìƒì„¸ ì¡°íšŒ */
    if (msg.indexOf("/ìœ ì €ì •ë³´") === 0) {
        var tn = msg.substring(5).trim(); 
        if (tn === "") {
            replier.reply(formatError(user, "ì…ë ¥ ì˜¤ë¥˜", "ì¡°íšŒí•  ìœ ì €ì˜ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”."));
            return true;
        }
        var found = findUserByName(roomData, tn);
        if (found.length === 0) { 
            replier.reply(formatError(user, "ëŒ€ìƒ ì—†ìŒ", "[" + tn + "]ë‹˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); 
            return true; 
        }
        if (found.length === 1) {
            var targetUser = found[0].data;
            var targetIdInside = found[0].id;
            var cr = getCreditInfo(targetUser.creditScore);
            
            var sDebt = 0;
            var sClaims = 0;
            if (roomData.loanContracts) {
                for (var cid in roomData.loanContracts) {
                    var c = roomData.loanContracts[cid];
                    if (c.borrowerUid === targetIdInside) sDebt += Math.floor(c.currentDebt);
                    if (c.lenderUid === targetIdInside) sClaims += Math.floor(c.currentDebt);
                }
            }

            var info = "ğŸ’° í¬ì¸íŠ¸: " + fp(targetUser.point) + "P\n" +
                       "ğŸ¦ ì˜ˆê¸ˆ: " + fp(targetUser.bank) + "P\n" +
                       (sClaims >= 1 ? "ğŸ¤ ë¯¸ìˆ˜ ì±„ê¶Œ: " + fp(sClaims) + "P\n" : "") +
                       "ğŸ’³ ì‹ ìš©: " + cr.label + " (" + targetUser.creditScore + "ì )\n" +
                       "ğŸ… í‹°ì–´: " + (TIERS[targetUser.tier] || "ì•„ì´ì–¸") + "\n" +
                       "ğŸ“… ì¶œì„: " + (targetUser.totalAttendance || 0) + "ì¼";
            
            var bDebt = (targetUser.loan && targetUser.loan.debt) ? Math.floor(Number(targetUser.loan.debt)) : 0;
            if (bDebt > 0) info += "\nğŸ¦ ë¯¸ìƒí™˜ ëŒ€ì¶œ: " + fp(bDebt) + "P";
            if (sDebt > 0) info += "\nğŸš¬ ë¯¸ìƒí™˜ ì‚¬ì±„: " + fp(sDebt) + "P";

            replier.reply(formatCommand("ğŸ” ìœ ì € ìƒì„¸ ì •ë³´", targetUser, info, null));
        } else {
            handleUserSelection(replier, targetUid, found, "info", null, user);
        }
        return true;
    }

    return false;
}

//==========ì„¹í„°39==========

/**
 * [ê²Œì„ í•˜ìœ„ ëª¨ë“ˆ 3] ì•¡ì…˜ ë° ë„ë°• í†µí•© ë¶„ë°°ê¸°
 * ì„¤ëª…: ì„¹í„° 39(ì „ì²´ ë¶„ë°°ê¸°)ë¡œë¶€í„° í˜¸ì¶œë°›ì•„, ì‹¤ì œ ì„¸ë¶€ ë¡œì§(42-1 ~ 42-3)ìœ¼ë¡œ ì—°ê²°í•©ë‹ˆë‹¤.
 * ì´ êµ¬ì¡°ë¥¼ í†µí•´ ê° ê¸°ëŠ¥ë³„ë¡œ ë…ë¦½ì ì¸ ìˆ˜ì • ë° ê´€ë¦¬ê°€ ê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤.
 */
function _gameActionLogic(msg, user, data, replier, roomName, targetUid) {
    var cmd = msg.split(" ")[0]; // ëª…ë ¹ì–´ ì²« ë‹¨ì–´ ì¶”ì¶œ
    
    // 1. í™€ì§, ìŠ¹ê¸‰, ê²½ë§ˆ ê´€ë ¨ ë¡œì§ (ì„¹í„° 40 ìœ„ì„)
    // [ìˆ˜ì •]: /ë°°íŒ… ë° ë°°íŒ…ì·¨ì†Œ ì¡°ê±´ì„ ì¶”ê°€í•˜ì—¬ Part1 í•¨ìˆ˜ê°€ ì‹¤í–‰ë  ìˆ˜ ìˆë„ë¡ ì…êµ¬ë¥¼ ê°œë°©í•¨
    if (cmd === "/í™€ì§" || cmd === "/ìŠ¹ê¸‰" || cmd === "/ë°°íŒ…" || cmd === "ë°°íŒ…ì·¨ì†Œ") {
        return _gameActionLogic_Part1(msg, user, data, replier, roomName, targetUid);
    }
    
    // 2. ê²°íˆ¬ ë¡œì§ (ì„¹í„° 41 ìœ„ì„)
    if (cmd === "/ê²°íˆ¬" || cmd === "ìˆ˜ë½" || cmd === "ê±°ì ˆ" || cmd === "ì·¨ì†Œ") {
        return _gameActionLogic_Part2(msg, user, data, replier, roomName, targetUid);
    }
    
    // 3. ë„ë‘‘ì§ˆ ë° ì¤ê¸° ë¡œì§ (ì„¹í„° 42 ìœ„ì„)
    if (cmd === "/ë„ë‘‘ì§ˆ" || cmd === "ì¡ì•˜ë‹¤ìš”ë†ˆ" || cmd === "ì¤ê¸°") {
        return _gameActionLogic_Part3(msg, user, data, replier, roomName, targetUid);
    }
    
    return false; // í•´ë‹¹ë˜ëŠ” ëª…ë ¹ì–´ê°€ ì—†ìŒ
}

//==========ì„¹í„°40==========

/**
 * [ê²Œì„ í•˜ìœ„ ëª¨ë“ˆ 3-1] ì•¡ì…˜ ë° ë„ë°• ê²Œì„ (í™€ì§ & ìŠ¹ê¸‰ & ê²½ë§ˆ ì•¡ì…˜)
 * ì„¤ëª…: ë…ë¦½ëœ í•¨ìˆ˜ë¡œ êµ¬ì„±í•˜ì—¬ ì»´íŒŒì¼ ì˜¤ë¥˜ë¥¼ ë°©ì§€í•˜ê³  ìœ ì§€ë³´ìˆ˜ì„±ì„ ë†’ì˜€ìŠµë‹ˆë‹¤.
 * ìˆ˜ì • ì‚¬í•­: ë°°íŒ… ëª…ë ¹ì–´ ì¸ì‹ ë²„ê·¸ ìˆ˜ì •, 50ë¶„ ì´í›„ ë°°íŒ… ì°¨ë‹¨ ë¡œì§ ê°•í™”, ì¤‘ì•™ì€í–‰ ì—°ë™ ìµœì í™”
 */
function _gameActionLogic_Part1(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];
    if (!roomData) return false;

    // ì¤‘ì•™ì€í–‰ ì¬ì› ì‹œìŠ¤í…œ ì´ˆê¸°í™”
    if (roomData.bankReserve === undefined || roomData.bankReserve === null) {
        roomData.bankReserve = SYSTEM_CONFIG.ECO.BANK.INITIAL_RESERVE;
    }

    var rConf = SYSTEM_CONFIG.ECO.RACING; // ê²½ë§ˆ ì„¤ì • ì°¸ì¡°

    /* [ìˆ˜ì •] 1. ê²½ë§ˆ ë°°íŒ… ì•¡ì…˜ (/ë°°íŒ… [ë²ˆí˜¸] [ê¸ˆì•¡]) */
    if (msg.indexOf("/ë°°íŒ… ") === 0) {
        // 1. ìš´ì˜ ì‹œê°„ ì²´í¬
        if (!racingData.isOperating) {
            replier.reply(formatError(user, "ê²½ë§ˆì¥ íœ´ì¥", "í˜„ì¬ ìš´ì˜ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤. (09:00 ~ 23:59)"));
            return true;
        }

        // 2. ë°°íŒ… ë§ˆê° ì‹œê°„ ì²´í¬ (50ë¶„~59ë¶„)
        var nowMin = new Date().getMinutes();
        if (nowMin >= 50) {
            replier.reply(formatError(user, "ë°°íŒ… ë§ˆê°", "í˜„ì¬ ì œ " + racingData.round + "íšŒì°¨ ê²½ê¸°ê°€ ë§ˆê°ë˜ì–´ ì •ì‚° ì¤‘ì…ë‹ˆë‹¤.\nì •ê°(00ë¶„) ìƒˆë¡œìš´ ê²½ê¸° ê°œì¥ í›„ ë°°íŒ…í•´ì£¼ì„¸ìš”."));
            return true;
        }

        // 3. ìƒíƒœ ì²´í¬ (ê´‘ì‚° ë“±)
        if (user.mining && user.mining.active) {
            replier.reply(formatError(user, "ì‘ì—… ì¤‘", "ê´‘ì‚° ì±„êµ´ ì¤‘ì—ëŠ” ë°°íŒ…ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤."));
            return true;
        }

        // 4. [ë²„ê·¸ ìˆ˜ì •] ëª…ë ¹ì–´ íŒŒì‹± (ì—°ì† ê³µë°± ëŒ€ì‘ ì •ê·œì‹ ì ìš©)
        var ps = msg.trim().split(/\s+/);
        if (ps.length < 3) { 
            replier.reply(formatError(user, "í˜•ì‹ ì˜¤ë¥˜", "/ë°°íŒ… [ë§ë²ˆí˜¸] [ê¸ˆì•¡]\nì˜ˆ) /ë°°íŒ… 1 1000")); 
            return true; 
        }
        
        var hId = parseInt(ps[1]);
        var betAmt = parseInt(ps[2].replace(/,/g, ""));

        // 5. ìœ íš¨ì„± ê²€ì‚¬
        if (isNaN(hId) || hId < 1 || hId > racingData.horses.length) {
            replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "1~" + racingData.horses.length + "ë²ˆ ì‚¬ì´ì˜ ë§ì„ ì„ íƒí•˜ì„¸ìš”."));
            return true;
        }

        // 6. Eco-base ê¸°ë°˜ ë™ì  í•œë„ ê³„ì‚°
        var multiplier = 1.0;
        if (roomData.economyBase && roomData.economyBase > 0) {
            var eco = calculateEconomy(data, roomName);
            var rawRatio = eco.total / roomData.economyBase;
            var damping = (data.economyDamping !== undefined) ? data.economyDamping : 0.5;
            multiplier = 1 + (rawRatio - 1) * damping;
            if (multiplier < 0.5) multiplier = 0.5;
        }

        var minLimit = Math.floor(rConf.MIN_BET * multiplier);
        var maxLimit = Math.floor(rConf.MAX_BET * multiplier);

        if (isNaN(betAmt) || betAmt < minLimit) {
            replier.reply(formatError(user, "ê¸ˆì•¡ ë¯¸ë‹¬", "í˜„ì¬ ìµœì†Œ ë°°íŒ…ê¸ˆì€ " + fp(minLimit) + "P ì…ë‹ˆë‹¤."));
            return true;
        }
        if (betAmt > maxLimit) {
            replier.reply(formatError(user, "í•œë„ ì´ˆê³¼", "í˜„ì¬ ìµœëŒ€ ë°°íŒ…ê¸ˆì€ " + fp(maxLimit) + "P ì…ë‹ˆë‹¤."));
            return true;
        }
        if (Number(user.point) < betAmt) {
            replier.reply(formatError(user, "í¬ì¸íŠ¸ ë¶€ì¡±", "ë³´ìœ  í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."));
            return true;
        }

        // 7. ì¤‘ë³µ ë°°íŒ… ì²´í¬
        if (racingData.bets[targetUid]) {
            replier.reply(formatError(user, "ì¤‘ë³µ ë°°íŒ… ë¶ˆê°€", "ì´ë¯¸ ë°°íŒ…í•˜ì…¨ìŠµë‹ˆë‹¤.\nì·¨ì†Œ í›„ ë‹¤ì‹œ ë°°íŒ…í•˜ë ¤ë©´ [ë°°íŒ…ì·¨ì†Œ]ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
            return true;
        }

        // 8. ë°°íŒ… ì‹¤í–‰ ë° ìì‚° ì°¨ê°
        util_updatePoint(user, roomData, -betAmt, "ê²½ë§ˆ ë°°íŒ…", roomName);
        
        var selectedHorse = racingData.horses[hId - 1];
        racingData.bets[targetUid] = { 
            uid: targetUid, 
            horseId: hId, 
            amount: betAmt, 
            name: user.name 
        };
        racingData.totalPool += betAmt;

        replier.reply(formatCommand("âœ… [ê²½ë§ˆ ë°°íŒ… ì™„ë£Œ]", user, "ğŸ‡ ì„ íƒ: " + selectedHorse.id + "ë²ˆ " + selectedHorse.name + "\nğŸ’° ê¸ˆì•¡: " + fp(betAmt) + "P ë°°íŒ… ì„±ê³µ!", "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
        safeSaveData(data);
        return true;
    }

    /* [ê¸°ëŠ¥ 2] ê²½ë§ˆ ë°°íŒ… ì·¨ì†Œ (ë°°íŒ…ì·¨ì†Œ) */
    if (msg === "ë°°íŒ…ì·¨ì†Œ") {
        if (!racingData.isOperating) return false;
        
        var nowMin = new Date().getMinutes();
        if (nowMin >= 50) {
            replier.reply(formatError(user, "ì·¨ì†Œ ë¶ˆê°€", "ì •ì‚°ì´ ì§„í–‰ ì¤‘ì¸ ë§ˆê° ì‹œê°„ì—ëŠ” ì·¨ì†Œê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤."));
            return true;
        }

        var myBet = racingData.bets[targetUid];
        if (!myBet) {
            replier.reply(formatError(user, "ë‚´ì—­ ì—†ìŒ", "ì´ë²ˆ íšŒì°¨ì— ë°°íŒ…í•œ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤."));
            return true;
        }

        // ìˆ˜ìˆ˜ë£Œ 10% ì ìš©
        var fee = Math.floor(myBet.amount * rConf.CANCEL_FEE);
        var refund = myBet.amount - fee;

        // í™˜ë¶ˆ ì²˜ë¦¬ (ìˆ˜ìˆ˜ë£ŒëŠ” êµ­ê³  bankReserveì— ë‚¨ìŒ)
        util_updatePoint(user, roomData, refund, "ê²½ë§ˆ ë°°íŒ… ì·¨ì†Œ", roomName);
        
        racingData.totalPool -= myBet.amount;
        delete racingData.bets[targetUid];

        var cancelMsg = "ê²½ë§ˆ ë°°íŒ…ì„ ì² íšŒí–ˆìŠµë‹ˆë‹¤.\n\nğŸ’° ì›ë˜ ë°°íŒ…ê¸ˆ: " + fp(myBet.amount) + "P\n" +
                         "âš–ï¸ ì·¨ì†Œ ìœ„ì•½ê¸ˆ(10%): -" + fp(fee) + "P\n" +
                         "ğŸ ìµœì¢… í™˜ë¶ˆì•¡: " + fp(refund) + "P";
        
        replier.reply(formatCommand("ğŸš« ë°°íŒ… ì·¨ì†Œ ì™„ë£Œ", user, cancelMsg, "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
        safeSaveData(data);
        return true;
    }

    /* [ê¸°ì¡´ ë¡œì§] í™€ì§ ë„ë°• (ì¤‘ëµ - ê¸°ì¡´ ì½”ë“œ ìœ ì§€ë¨) */
    if (msg.indexOf("/í™€ì§ ") === 0) {
        startTracking(user, "í™€ì§ ê²Œì„");
        try {
            if (user.mining && user.mining.active) {
                endTracking(user, false, "ê´‘ì‚° ì±„êµ´ ì¤‘");
                replier.reply(formatError(user, "ì‘ì—… ì¤‘", "ê´‘ì‚°ì—ì„œ ì±„êµ´ ì¤‘ì—ëŠ” í™€ì§ì„ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
                return true;
            }
            if (data.gambleLimit) {
                endTracking(user, false, "ë„ë°• ì œí•œ ìƒíƒœ");
                replier.reply(formatError(user, "ì‹œìŠ¤í…œ ì œí•œ", "í˜„ì¬ ê´€ë¦¬ìì— ì˜í•´ ë„ë°• ì‹œìŠ¤í…œì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤."));
                return true;
            }
            var ps = msg.trim().split(/\s+/);
            if (ps.length < 3) { replier.reply(formatError(user, "í˜•ì‹ ì˜¤ë¥˜", "/í™€ì§ [í™€|ì§] [ê¸ˆì•¡]")); return true; }
            var pick = ps[1];
            var bet = parseInt(ps[2].replace(/,/g, ""));
            
            if (pick !== "í™€" && pick !== "ì§") { 
                replier.reply(formatError(user, "ì…ë ¥ ì˜¤ë¥˜", "í™€ ë˜ëŠ” ì§ë§Œ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.")); 
                return true; 
            }
            
            var multiplier = 1.0;
            if (roomData.economyBase && roomData.economyBase > 0) {
                var eco = calculateEconomy(data, roomName);
                var rawRatio = eco.total / roomData.economyBase;
                var damping = (data.economyDamping !== undefined) ? data.economyDamping : 0.5;
                multiplier = 1 + (rawRatio - 1) * damping;
                if (multiplier < 0.5) multiplier = 0.5;
            }

            var minBet = Math.floor((SYSTEM_CONFIG.ECO.GAMBLE_MIN || 300) * multiplier);
            var maxBet = Math.floor((SYSTEM_CONFIG.ECO.GAMBLE_MAX || 2000) * multiplier);

            if (isNaN(bet) || bet < minBet) { replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜", "ìµœì†Œ " + fp(minBet) + "P ì´ìƒ ë² íŒ…í•´ì•¼ í•©ë‹ˆë‹¤.")); return true; }
            if (bet > maxBet) { replier.reply(formatError(user, "ë°°íŒ… ìƒí•œì•¡ ì´ˆê³¼", "ë°°íŒ… ê¸ˆì•¡ì€ ìµœëŒ€ " + fp(maxBet) + "Pê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.")); return true; }
            if (Number(user.point) < bet) { replier.reply(formatError(user, "í¬ì¸íŠ¸ ë¶€ì¡±", "ë² íŒ…í•  í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.")); return true; }

            var expectedPayout = Math.floor(bet * 0.9);
            if (roomData.bankReserve < expectedPayout) {
                replier.reply(formatError(user, "ì€í–‰ ìê¸ˆ ë¶€ì¡±", "ì£„ì†¡í•©ë‹ˆë‹¤. í˜„ì¬ ì€í–‰ ê¸ˆê³ ì˜ í˜„ê¸ˆ ë¶€ì¡±ìœ¼ë¡œ ë„ë°•íŒì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nğŸ¦ í˜„ì¬ ê¸ˆê³ : " + fp(roomData.bankReserve) + "P"));
                return true;
            }
            
            var isFeverActive = (data.feverData && data.feverData.active === true);
            var winProb = isFeverActive ? SYSTEM_CONFIG.PROB.ODD_EVEN_FEVER : SYSTEM_CONFIG.PROB.ODD_EVEN_WIN;
            var isWin = Math.random() < winProb; 
            var result = isWin ? pick : (pick === "í™€" ? "ì§" : "í™€");
            
            user.dailyGambleCount = (user.dailyGambleCount || 0) + 1;
            var creditPenalty = (user.dailyGambleCount > 10) ? 1 : 0;
            if (creditPenalty > 0) {
                user.creditScore = Math.max(0, Number(user.creditScore || 600) - creditPenalty);
                checkAndHandleDefaulter(user, roomName);
            }

            if (user.totalGambleCount === undefined) user.totalGambleCount = 0;
            if (user.totalGambleWins === undefined) user.totalGambleWins = 0;
            user.totalGambleCount++;

            if (isWin) {
                user.totalGambleWins++;
                var res = processRepayment(user, expectedPayout, targetUid, roomName);
                util_updatePoint(user, roomData, Number(res.actualGain), "í™€ì§ ì ì¤‘", roomName);
                var winPrefix = isFeverActive ? "ğŸ”¥ [í”¼ë²„] " : "ğŸŠ ";
                replier.reply(formatCommand(winPrefix + "í™€ì§ ì ì¤‘!", user, "ê²°ê³¼: [" + result + "]\nì¶•í•˜í•©ë‹ˆë‹¤! " + fp(Number(res.actualGain)) + "Pë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤." + res.repayMsg, "í˜„ì¬ ì”ì•¡: " + fP(user.point) + "P"));
            } else {
                util_updatePoint(user, roomData, -bet, "í™€ì§ ë¯¸ì ì¤‘", roomName);
                var losePrefix = isFeverActive ? "ğŸ”¥ [í”¼ë²„] " : "ğŸ’€ ";
                replier.reply(formatCommand(losePrefix + "í™€ì§ ë¯¸ì ì¤‘", user, "ê²°ê³¼: [" + result + "]\nì•„ì‰½ì§€ë§Œ " + fp(bet) + "Pë¥¼ ìƒì—ˆìŠµë‹ˆë‹¤.", "í˜„ì¬ ì”ì•¡: " + fP(user.point) + "P"));
            }

            var winRate = (user.totalGambleWins / user.totalGambleCount) * 100;
            var replierStub = { reply: function(m) { Api.replyRoom(roomName, m); } };

            if (user.totalGambleCount >= 500) {
                util_checkAndAwardTitle(user, replierStub, "ë„ë°•ì˜ì‹ ", 4003, "ğŸ²", "ë„ë°• íšŸìˆ˜ 500íšŒ", "ìš´ê³¼ ì‹¤ë ¥ì„ ëª¨ë‘ ê²¸ë¹„í•œ ë„ë°•ì˜ ì‹ ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else if (user.totalGambleCount >= 100 && winRate >= 60) {
                util_checkAndAwardTitle(user, replierStub, "íƒ€ì§œ", 4002, "ğŸ´", "ì´ ìŠ¹ë¥  60% ì´ìƒ", "ë„ë°•íŒì˜ íë¦„ì„ ì§€ë°°í•˜ëŠ” íƒ€ì§œë¡œ ì¸ì •ë°›ì•˜ìŠµë‹ˆë‹¤.");
            } else if (user.totalGambleCount >= 100) {
                util_checkAndAwardTitle(user, replierStub, "ê¾¼", 4001, "ğŸƒ", "ë„ë°• íšŸìˆ˜ 100íšŒ", "ìŠ¹ë¥  60% ë‹¬ì„± ì‹œ [íƒ€ì§œ]ì— ë„ì „í•˜ì„¸ìš”!");
            }

            safeSaveData(data);
            endTracking(user, true, "ì™„ë£Œ");
            return true;
        } catch(e) { endTracking(user, false, "CRASH: " + e); replier.reply("ğŸš« ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); return true; }
    }

    /* [ê¸°ì¡´ ë¡œì§] í‹°ì–´ ìŠ¹ê¸‰ */
    if (msg === "/ìŠ¹ê¸‰") {
        var totalAttempts = Number(user.dailyPromotionAttempts || 0) + Number(user.purchasedPromotionAttempts || 0);
        if (totalAttempts <= 0) { replier.reply(formatError(user, "ê¸°íšŒ ì—†ìŒ", "ìƒì ì—ì„œ ìŠ¹ê¸‰ê¶Œì„ êµ¬ë§¤í•˜ì„¸ìš”.")); return true; }
        if (user.tier >= 9) { replier.reply(formatError(user, "ìµœê³  ë“±ê¸‰", "ì´ë¯¸ ì±Œë¦°ì € ë“±ê¸‰ì…ë‹ˆë‹¤.")); return true; }

        var usedDaily = false;
        if (Number(user.dailyPromotionAttempts) > 0) { user.dailyPromotionAttempts--; usedDaily = true; }
        else { user.purchasedPromotionAttempts--; }

        var prob = TIER_PROBS[user.tier] || { up: 50, stay: 40, down: 10 };
        var rand = Math.random() * 100;
        var isSundayFever = (new Date().getDay() === 0);
        if (isSundayFever) rand -= 5; 

        startTracking(user, "ìŠ¹ê¸‰ ë„ì „");

        if (rand < prob.up) { 
            user.tier++;
            var successBody = "í‹°ì–´: [" + TIERS[user.tier] + "]\n\n";
            if (user.tier === 9) {
                user.challengerCount = (user.challengerCount || 0) + 1;
                user.challengerIconSeason = getSimpleSeason();
                successBody += "ğŸŠ ì¶•í•˜í•©ë‹ˆë‹¤! ì „ì„¤ì ì¸ ì±Œë¦°ì € ë“±ê¸‰ì— ë„ë‹¬í•˜ì…¨ìŠµë‹ˆë‹¤!\nëª…ì˜ˆì˜ ì „ë‹¹ì— ì„±í•¨ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.";
            } else {
                if (usedDaily) user.dailyPromotionAttempts++; else user.purchasedPromotionAttempts++;
                successBody += "ğŸ‰ ìŠ¹ê¸‰ ì„±ê³µ ë³´ë„ˆìŠ¤: ì¬ë„ì „ ê¸°íšŒ ìœ ì§€!";
            }
            if (isSundayFever) successBody += "\nğŸ”¥ ì¼ìš”ì¼ í”¼ë²„íƒ€ì„ ë³´ë„ˆìŠ¤: ìŠ¹ë¥  +5% ì ìš©!";
            replier.reply(formatCommand("ğŸŠ ìŠ¹ê¸‰ ì„±ê³µ!", user, successBody, "ë‚¨ì€ ê¸°íšŒ: " + (Number(user.dailyPromotionAttempts) + Number(user.purchasedPromotionAttempts)) + "íšŒ / ë°©ì–´ê¶Œ: " + (user.tierGuard || 0) + "ê°œ"));
            endTracking(user, true, "ìŠ¹ê¸‰ ì„±ê³µ");
        } else if (rand > (100 - prob.down)) {
            if (Number(user.tierGuard || 0) > 0) {
                user.tierGuard--;
                replier.reply(formatCommand("ğŸ›¡ï¸ ê°•ë“± ë°©ì–´", user, "í‹°ì–´: [" + TIERS[user.tier] + "] (ìœ ì§€)\n\në°©ì–´ê¶Œì„ ì‚¬ìš©í•˜ì—¬ ë³´í˜¸í–ˆìŠµë‹ˆë‹¤.", "ë‚¨ì€ ë°©ì–´ê¶Œ: " + user.tierGuard + "ê°œ"));
                endTracking(user, true, "ê°•ë“± ë°©ì–´");
            } else {
                user.tier = Math.max(0, user.tier - 1);
                replier.reply(formatCommand("ğŸ“‰ ê°•ë“± ë°œìƒ", user, "í‹°ì–´: [" + TIERS[user.tier] + "]\n\nìƒíƒœ: í‹°ì–´ê°€ í•œ ë‹¨ê³„ í•˜ë½í–ˆìŠµë‹ˆë‹¤.", "ë‚¨ì€ ê¸°íšŒ: " + (Number(user.dailyPromotionAttempts) + Number(user.purchasedPromotionAttempts)) + "íšŒ / ë°©ì–´ê¶Œ: 0ê°œ"));
                endTracking(user, false, "ê°•ë“± ë°œìƒ");
            }
        } else {
            replier.reply(formatCommand("ğŸ˜ ìŠ¹ê¸‰ ì‹¤íŒ¨", user, "í‹°ì–´: [" + TIERS[user.tier] + "] (ìœ ì§€)\n\nìƒíƒœ: ìŠ¹ê¸‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "ë‚¨ì€ ê¸°íšŒ: " + (Number(user.dailyPromotionAttempts) + Number(user.purchasedPromotionAttempts)) + "íšŒ / ë°©ì–´ê¶Œ: " + (user.tierGuard || 0) + "ê°œ"));
            endTracking(user, false, "ìŠ¹ê¸‰ ì‹¤íŒ¨");
        }
        safeSaveData(data);
        return true;
    }

    return false;
}

//==========ì„¹í„°41==========

/**
 * [ê²Œì„ í•˜ìœ„ ëª¨ë“ˆ 3-2] ì•¡ì…˜ ë° ë„ë°• ê²Œì„ (ê²°íˆ¬ ì‹œìŠ¤í…œ)
 */
function _gameActionLogic_Part2(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];
    if (!roomData) return false;

    /* [ê¸°ëŠ¥ 11] ê²°íˆ¬ ì‹ ì²­ */
    if (msg.indexOf("/ê²°íˆ¬ ") === 0) {
        if (data.gambleLimit) { replier.reply(formatError(user, "ë„ë°• ì œí•œ", "í˜„ì¬ ë„ë°• ê¸°ëŠ¥ì´ ì œí•œë˜ì–´ ìˆìŠµë‹ˆë‹¤.")); return true; }
        var parts = msg.trim().split(/\s+/);
        if (parts.length < 3) { replier.reply(formatError(user, "í˜•ì‹ ì˜¤ë¥˜", "/ê²°íˆ¬ [ë‹‰ë„¤ì„] [ê¸ˆì•¡]")); return true; }
        var am = parseInt(parts.pop().replace(/,/g, ""));
        var tn = parts.slice(1).join(" ").trim();

        var multiplier = 1.0;
        if (roomData.economyBase && roomData.economyBase > 0) {
            var eco = calculateEconomy(data, roomName);
            var rawRatio = eco.total / roomData.economyBase;
            var damping = (data.economyDamping !== undefined) ? data.economyDamping : 0.5;
            multiplier = 1 + (rawRatio - 1) * damping;
            if (multiplier < 0.5) multiplier = 0.5;
        }
        var minBet = Math.floor(100 * multiplier);

        if (isNaN(am) || am < minBet) { replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜", "ìµœì†Œ " + fp(minBet) + "P ì´ìƒ ê²°íˆ¬ ê°€ëŠ¥í•©ë‹ˆë‹¤.")); return true; }
        if (Number(user.point) < am) { replier.reply(formatError(user, "í¬ì¸íŠ¸ ë¶€ì¡±", "ë² íŒ…í•  í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.")); return true; }
        
        var found = findUserByName(roomData, tn);
        if (found.length === 0) { replier.reply(formatError(user, "ëŒ€ìƒ ì—†ìŒ", "[" + tn + "]ë‹˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (found.length > 1) { handleUserSelection(replier, targetUid, found, "duel", { bet: am }, user); return true; }
        var target = found[0];
        if (target.id === targetUid) { replier.reply(formatError(user, "ê²°íˆ¬ ë¶ˆê°€", "ìì‹ ê³¼ëŠ” ì‹¸ìš¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (isUserBusy(target.id)) { replier.reply(formatError(user, "ëŒ€ìƒ í™œë™ ì¤‘", "ìƒëŒ€ë°©ì´ í˜„ì¬ ë‹¤ë¥¸ í™œë™ì„ í•˜ê³  ìˆìŠµë‹ˆë‹¤.")); return true; }

        util_updatePoint(user, roomData, -am, "ê²°íˆ¬ ì‹ ì²­ ë² íŒ…", roomName);

        duelData[target.id] = { challengerUid: targetUid, point: am, expire: Date.now() + 30000, room: roomName };
        replier.reply(formatCommand("âš”ï¸ ê²°íˆ¬ ì‹ ì²­", target.data, getDisplayName(user) + "ë‹˜ì´ " + fp(am) + "P ê²°íˆ¬ë¥¼ ì‹ ì²­í–ˆìŠµë‹ˆë‹¤!\n\nìŠ¹ë‚™í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ìˆ˜ë½/ê±°ì ˆ/ì·¨ì†Œ)", "ë‚´ ì”ì•¡: " + fP(user.point) + "P"));
        safeSaveData(data);
        return true;
    }

    /* [ìˆ˜ì •] ê²°íˆ¬ ì·¨ì†Œ (ì‹ ì²­ì ë³¸ì¸ì´ ì² íšŒ) */
    if (msg === "ì·¨ì†Œ") {
        var foundDuelId = null;
        // ë‚´ê°€ ì‹ ì²­í•œ ê²°íˆ¬ê°€ ìˆëŠ”ì§€ ì „ì²´ duelDataì—ì„œ íƒìƒ‰
        for (var tid in duelData) {
            if (duelData[tid].challengerUid === targetUid) {
                foundDuelId = tid;
                break;
            }
        }

        if (foundDuelId) {
            var d = duelData[foundDuelId];
            util_updatePoint(user, roomData, d.point, "ê²°íˆ¬ ì·¨ì†Œ í™˜ê¸‰");
            delete duelData[foundDuelId];
            replier.reply(formatCommand("ğŸš« ê²°íˆ¬ ì·¨ì†Œ", user, "ê²°íˆ¬ ì‹ ì²­ì„ ì² íšŒí•˜ê³  ë² íŒ…ê¸ˆì„ ë°˜í™˜ë°›ì•˜ìŠµë‹ˆë‹¤.", "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
            safeSaveData(data);
            return true;
        }
        return false; // ë‚´ê°€ ì‹ ì²­í•œ ê²°íˆ¬ê°€ ì—†ìœ¼ë©´ ì¼ë°˜ ì±„íŒ…ìœ¼ë¡œ ì²˜ë¦¬
    }

    /* [ìˆ˜ì •] ê²°íˆ¬ ìˆ˜ë½ (ìƒëŒ€ë°©ì´ ìŠ¹ë‚™) */
    if (msg === "ìˆ˜ë½" && duelData[targetUid]) {
        if (data.gambleLimit) { replier.reply(formatError(user, "ë„ë°• ì œí•œ", "í˜„ì¬ ë„ë°• ê¸°ëŠ¥ì´ ì œí•œë˜ì–´ ìˆìŠµë‹ˆë‹¤.")); return true; }
        var d = duelData[targetUid];
        var challenger = roomData.users[d.challengerUid];
        
        if (!challenger) { 
            delete duelData[targetUid]; 
            replier.reply(formatError(user, "ì‹ ì²­ì ì •ë³´ ì—†ìŒ")); 
            return true; 
        }

        if (Number(user.point) < d.point) {
            // ìˆ˜ë½ì í¬ì¸íŠ¸ ë¶€ì¡± ì‹œ ì‹ ì²­ìì—ê²Œ í¬ì¸íŠ¸ ëŒë ¤ì£¼ê³  ê²°íˆ¬ ì¢…ë£Œ
            util_updatePoint(challenger, roomData, d.point, "ìƒëŒ€ í¬ì¸íŠ¸ ë¶€ì¡±ìœ¼ë¡œ ì¸í•œ í™˜ê¸‰");
            delete duelData[targetUid];
            replier.reply(formatError(user, "í¬ì¸íŠ¸ ë¶€ì¡±", "ìˆ˜ë½í•˜ê¸° ìœ„í•œ í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•˜ì—¬ ê²°íˆ¬ê°€ ë¬´ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤."));
            safeSaveData(data);
            return true;
        }

        // ìˆ˜ë½ì í¬ì¸íŠ¸ ì°¨ê°
        util_updatePoint(user, roomData, -d.point, "ê²°íˆ¬ ìˆ˜ë½ ë² íŒ…");

        // ìŠ¹íŒ¨ ê²°ì • (50:50)
        var isChallengerWin = Math.random() < 0.5;
        var winner = isChallengerWin ? challenger : user;
        var winnerId = isChallengerWin ? d.challengerUid : targetUid;
        var winPrize = d.point * 2;

        /* í†µí•© ìƒí™˜ ì—”ì§„ í˜¸ì¶œ ë° ìŠ¹ë¦¬ê¸ˆ ì§€ê¸‰ */
        var res = processRepayment(winner, winPrize, winnerId, roomName);
        winner.point = Number(winner.point) + Number(res.actualGain);
        verifyPointTransaction(winner, winner.point - res.actualGain, Number(res.actualGain), "ê²°íˆ¬ ìŠ¹ë¦¬ ë³´ìƒ");

        var resBody = "âš”ï¸ ê²°íˆ¬ ê²°ê³¼\n" + getDisplayName(challenger) + " VS " + getDisplayName(user) + "\n\nğŸ† ìŠ¹ì: " + getDisplayName(winner) + "\nğŸ’° íšë“: " + fp(winPrize) + "P" + (res.repayMsg || "");
        replier.reply(formatCommand("âš”ï¸ ê²°íˆ¬ ì¢…ë£Œ", winner, resBody, "ë‚´ ì”ì•¡: " + fp(winner.point) + "P"));
        
        delete duelData[targetUid];
        safeSaveData(data);
        return true;
    }

    /* [ìˆ˜ì •] ê²°íˆ¬ ê±°ì ˆ (ìƒëŒ€ë°©ì´ ê±°ë¶€) */
    if (msg === "ê±°ì ˆ" && duelData[targetUid]) {
        var d = duelData[targetUid];
        var challenger = roomData.users[d.challengerUid];
        if (challenger) {
            util_updatePoint(challenger, roomData, d.point, "ê²°íˆ¬ ê±°ì ˆ í™˜ê¸‰");
        }
        delete duelData[targetUid];
        replier.reply(formatCommand("ğŸš« ê²°íˆ¬ ê±°ì ˆ", user, "ê²°íˆ¬ ì‹ ì²­ì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.", "ì‹ ì²­ìì—ê²Œ ë² íŒ…ê¸ˆì´ ë°˜í™˜ë˜ì—ˆìŠµë‹ˆë‹¤."));
        safeSaveData(data);
        return true;
    }
    return false;
}

//==========ì„¹í„°42==========

/**
 * [ê²Œì„ í•˜ìœ„ ëª¨ë“ˆ 3-3] ì•¡ì…˜ ë° ë„ë°• ê²Œì„ (ë„ë‘‘ì§ˆ & ì¤ê¸°)
 * ìˆ˜ì • ì‚¬í•­: ë²Œê¸ˆ ì´ì¤‘ ê°€ì‚° ë²„ê·¸ ìˆ˜ì • ë° ëª¨ë“  í¬ì¸íŠ¸ ë¡œì§ì— ë°© ê²©ë¦¬ ì‹ë³„ì(roomName) ì ìš©
 */
function _gameActionLogic_Part3(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];
    if (!roomData) return false;

    /* [ê¸°ëŠ¥ 12] ë„ë‘‘ì§ˆ ì‹œë„ */
    if (msg.indexOf("/ë„ë‘‘ì§ˆ ") === 0) {
        if (data.gambleLimit) { replier.reply(formatError(user, "ë„ë°• ì œí•œ", "í˜„ì¬ ë„ë°• ê¸°ëŠ¥ì´ ì œí•œë˜ì–´ ìˆìŠµë‹ˆë‹¤.")); return true; }
        if (user.mining && user.mining.active) { replier.reply(formatError(user, "ì‘ì—… ì¤‘", "ê´‘ì‚°ì—ì„œ ì¼í•˜ëŠ” ì¤‘ì—ëŠ” ë„ë‘‘ì§ˆì„ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        
        // ì§•ì—­ ìƒíƒœ í™•ì¸
        if (user.jailReleaseTime && Date.now() < user.jailReleaseTime) {
            var diff = user.jailReleaseTime - Date.now();
            var remainMin = Math.ceil(diff / (1000 * 60));
            var timeMsg = remainMin >= 60 ? Math.ceil(remainMin / 60) + "ì‹œê°„" : remainMin + "ë¶„";
            replier.reply(formatError(user, "ë„ë‘‘ì§ˆ ê¸ˆì§€", "í˜„ì¬ ì§•ì—­ ì¤‘ì…ë‹ˆë‹¤. " + timeMsg + " í›„ ê°€ëŠ¥í•©ë‹ˆë‹¤."));
            return true;
        }

        // ì¤‘ë³µ ë„ë‘‘ì§ˆ ì§„í–‰ ì—¬ë¶€ ì²´í¬
        for (var v in activeThefts) { 
            if (activeThefts[v].thiefUid === targetUid) { replier.reply(formatError(user, "ì‘ì—… ì¤‘", "ì´ë¯¸ ë„ë‘‘ì§ˆì„ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.")); return true; }
        }

        var tn = msg.substring(5).trim();
        var found = findUserByName(roomData, tn);
        if (found.length === 0) { replier.reply(formatError(user, "ëŒ€ìƒ ì—†ìŒ", "[" + tn + "]ë‹˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (found.length > 1) { handleUserSelection(replier, targetUid, found, "theft", null, user); return true; }
        
        var victim = found[0];

        // ëŒ€ìƒ ìƒíƒœ í™•ì¸
        if (victim.data.mining && victim.data.mining.active) {
            replier.reply(formatError(user, "ì ‘ê·¼ ë¶ˆê°€", "ëŒ€ìƒì´ í˜„ì¬ ê´‘ì‚° ê¹Šì€ ê³³ì—ì„œ ì‘ì—… ì¤‘ì´ë¼ í„¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
            return true;
        }
        if (activeThefts[victim.id]) { replier.reply(formatError(user, "ì¤‘ë³µ ê°•íƒˆ ë¶ˆê°€", getDisplayName(victim.data) + "ë‹˜ì€ í˜„ì¬ ë‹¤ë¥¸ ë„ë‘‘ì´ ì‘ì—… ì¤‘ì…ë‹ˆë‹¤!")); return true; }
        if (victim.id === targetUid) { replier.reply(formatError(user, "ê°•íƒˆ ë¶ˆê°€", "ìì‹ ì˜ ì§€ê°‘ì€ í„¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }

        // ì¿¨íƒ€ì„ ë° ëŒ€ìƒ í¬ì¸íŠ¸ í™•ì¸
        if (!user.theftCooldowns) user.theftCooldowns = {};
        var now = Date.now();
        var lastTheftTime = user.theftCooldowns[victim.id] || 0;
        if (now - lastTheftTime < 3600000) { 
            var remainMinCooldown = Math.ceil((3600000 - (now - lastTheftTime)) / 60000);
            replier.reply(formatError(user, "ì¿¨íƒ€ì„ ì œí•œ", getDisplayName(victim.data) + "ë‹˜ì€ ì´ë¯¸ í„¸ì—ˆìŠµë‹ˆë‹¤.\n" + remainMinCooldown + "ë¶„ í›„ ë‹¤ì‹œ ê°€ëŠ¥í•©ë‹ˆë‹¤."));
            return true;
        }
        if (Number(victim.data.point) <= 300) { replier.reply(formatError(user, "ê°•íƒˆ ëŒ€ìƒ ë¶€ì í•©", fp(300) + "Pë¥¼ ì´ˆê³¼í•˜ëŠ” ìœ ì €ë§Œ í„¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")); return true; }

        // ë„ë‘‘ì§ˆ í”„ë¡œì„¸ìŠ¤ ì‹œì‘
        var sT = setTimeout(function(){ processTheftResult(roomName, targetUid, victim.id); }, 60000);
        var pT = setTimeout(function(){ if (Math.random() < 0.5) { processPoliceResult(roomName, targetUid, victim.id); } }, 30000);
        activeThefts[victim.id] = { thiefUid: targetUid, successTimer: sT, policeTimer: pT };

        user.theftCooldowns[victim.id] = now;
        user.creditScore = Math.max(0, Number(user.creditScore || 600) - 10);

        replier.reply(formatCommand("ğŸ•µï¸ ë„ë‘‘ì§ˆ ì‹œë„", user, getDisplayName(victim.data) + "ë‹˜ ê°•íƒˆ ì‹œë„ ì¤‘ (1ë¶„ ì†Œìš”)\n\nğŸš“ 30ì´ˆ í›„ ê²½ì°° ì¶œë™ í™•ë¥  50%!", "ë°©ì–´: 1ë¶„ ë‚´ [ì¡ì•˜ë‹¤ìš”ë†ˆ] ì…ë ¥"));
        
        // [Gemini ìš”ì²­ ì‚¬í•­] ë°© ì‹ë³„ì roomName ì¶”ê°€
        checkAndHandleDefaulter(user, roomName);
        safeSaveData(data);
        return true;
    }

    /* ë„ë‘‘ì§ˆ ë°©ì–´ (ì¡ì•˜ë‹¤ìš”ë†ˆ) */
    if (msg === "ì¡ì•˜ë‹¤ìš”ë†ˆ") {
        if (!activeThefts[targetUid]) return false;
        var theft = activeThefts[targetUid];
        if (theft.successTimer) clearTimeout(theft.successTimer);
        if (theft.policeTimer) clearTimeout(theft.policeTimer);
        var thief = roomData.users[theft.thiefUid];
        
        var multiplier = 1.0;
        if (roomData.economyBase && roomData.economyBase > 0) {
            var eco = calculateEconomy(data, roomName);
            var rawRatio = eco.total / roomData.economyBase;
            var damping = (data.economyDamping !== undefined) ? data.economyDamping : 0.5;
            multiplier = 1 + (rawRatio - 1) * damping;
            if (multiplier < 0.5) multiplier = 0.5;
        }

        var basePenalty = Math.floor(Math.random() * 101) + 200;
        var penalty = Math.floor(basePenalty * multiplier);
        var actualPenalty = Math.min(penalty, Number(thief.point));
        
        // [Gemini ìš”ì²­ ì‚¬í•­] ì´ì¤‘ í•©ì‚° ë²„ê·¸ ìˆ˜ì •
        // util_updatePoint ë‚´ë¶€ì—ì„œ "ë„ë‘‘ì§ˆ ì²´í¬ ë²Œê¸ˆ" ì‚¬ìœ  ì‹œ ì´ë¯¸ bankReserveì— í•©ì‚°ë˜ë¯€ë¡œ, 
        // í•˜ë‹¨ì˜ ìˆ˜ë™ í•©ì‚° ë¡œì§(roomData.bankReserve += ...)ì„ ì œê±°í•˜ê³  ì´ í•¨ìˆ˜ í•˜ë‚˜ë¡œ í†µí•©í•©ë‹ˆë‹¤.
        util_updatePoint(thief, roomData, -actualPenalty, "ë„ë‘‘ì§ˆ ì²´í¬ ë²Œê¸ˆ", roomName);
        
        thief.jailReleaseTime = Date.now() + (1 * 60 * 60 * 1000); // 1ì‹œê°„ ì§•ì—­
        delete activeThefts[targetUid];
        
        replier.reply(formatAdmin("ğŸš“ ì²´í¬ ì™„ë£Œ", "ğŸš¨ [í˜„í–‰ë²” ì²´í¬]\nëŒ€ìƒ: " + getDisplayName(thief) + "\nê²°ê³¼: -" + fp(actualPenalty) + "P ì°¨ê° / ì§•ì—­ 1ì‹œê°„"));
        safeSaveData(data);
        return true;
    }

   /* [Gemini ìš”ì²­ ì‚¬í•­] ë¿Œë¦¬ê¸° ì¤ê¸° (ì°¸ì¡° ê¸°ë°˜ ë°ì´í„° í™•ì¸ ë° êµ­ê³  ì—°ë™) */
    if (msg === "ì¤ê¸°") {
        // [ìˆ˜ì •] sprinkleData ê°ì²´ì˜ ì†ì„±ì„ ì§ì ‘ í™•ì¸í•˜ì—¬ ë°©ë³„ ë…ë¦½ ìƒíƒœ ì²´í¬
        if (!sprinkleData || sprinkleData.active !== true) return false;
        
        if (sprinkleData.winners.indexOf(targetUid) !== -1) { 
            replier.reply(formatError(user, "ì¤‘ë³µ ì°¸ì—¬ ë¶ˆê°€", "ì´ë¯¸ ì´ ì´ë²¤íŠ¸ì—ì„œ í¬ì¸íŠ¸ë¥¼ íšë“í•˜ì…¨ìŠµë‹ˆë‹¤.")); 
            return true; 
        }
        if (sprinkleData.currentWinners >= sprinkleData.limit) { 
            replier.reply(formatError(user, "ì„ ì°©ìˆœ ë§ˆê°", "ì´ë¯¸ ëª¨ë“  í¬ì¸íŠ¸ê°€ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤.")); 
            return true; 
        }
        
        var prize = sprinkleData.portions.pop();
        sprinkleData.winners.push(targetUid);
        sprinkleData.currentWinners++;
        
        // í†µí•© ìƒí™˜ ì—”ì§„ ë° í¬ì¸íŠ¸ ê°€ì‚°
        var res = processRepayment(user, prize, targetUid, roomName);
        util_updatePoint(user, roomData, Number(res.actualGain), "ë¿Œë¦¬ê¸° ì¤ê¸°", roomName);
        
        replier.reply(formatCommand("ğŸ‰ ì¤ê¸° ì„±ê³µ!", user, fp(prize) + "Pë¥¼ ì£¼ì› ìŠµë‹ˆë‹¤!" + res.repayMsg, "ë‚´ ì”ì•¡: " + fP(user.point) + "P"));
        
        // ì „ëŸ‰ ì†Œì§„ ì‹œ ìƒíƒœ í•´ì œ
        if (sprinkleData.currentWinners >= sprinkleData.limit) { 
            sprinkleData.active = false; 
            Api.replyRoom(roomName, formatAdmin("ğŸ ë¿Œë¦¬ê¸° ë§ˆê°", "ëª¨ë“  í¬ì¸íŠ¸ê°€ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤.")); 
        }
        safeSaveData(data);
        return true;
    }

    return false;
}

//==========ì„¹í„°43==========

/**
 * [ê²Œì„ í•˜ìœ„ ëª¨ë“ˆ 4] ì£¼ì‹ íˆ¬ì ê´€ë¦¬ (ì„±ì·¨ ê¸°ë°˜ ì¹­í˜¸ í†µí•© ë²„ì „)
 * ê¸°ëŠ¥: ì£¼ì‹ ì‹œì„¸ ì¡°íšŒ, ë‚´ ì£¼ì‹ í™•ì¸, ë§¤ìˆ˜, ë§¤ë„
 * ì„¤ëª…: íì‡„í˜• ìˆœí™˜ ê²½ì œ ì—°ë™ - ë§¤ìˆ˜ê¸ˆì€ ê¸ˆê³  ì…ê³ , ë§¤ë„ê¸ˆì€ ê¸ˆê³  ì§€ì¶œ
 */
function _gameStockLogic(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];
    if (!roomData) return false;

    // ì¤‘ì•™ì€í–‰ ì¬ì› ì´ˆê¸°í™” (ì•ˆì „ì¥ì¹˜)
    if (roomData.bankReserve === undefined || roomData.bankReserve === null) {
        roomData.bankReserve = SYSTEM_CONFIG.ECO.BANK.INITIAL_RESERVE;
    }

    /* [ê¸°ëŠ¥ 13] ì£¼ì‹ ê±°ë˜ */

    // 1. ì‹¤ì‹œê°„ ì‹œì„¸ ì¡°íšŒ
    if (msg === "/ì£¼ì‹") {
        var currentHour = new Date().getHours();
        var isMarketOpen = (currentHour >= 7 && currentHour <= 23);
        var statusText = isMarketOpen ? "ğŸŸ¢ ì¥ ìš´ì˜ ì¤‘ (07:00 ~ 23:59)" : "ğŸ”´ ì¥ ë§ˆê° (00:00~06:59)";
        var stockList = generateStockList(data); 
        
        replier.reply("ğŸ“ˆ ì‹¤ì‹œê°„ ì£¼ì‹ ì‹œì„¸\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + statusText + "\n\n" + (stockList || "ìƒì¥ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.") + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’¡ [ê°€ì´ë“œ]: ë§¤ìˆ˜: [/ë§¤ìˆ˜ ì¢…ëª©ëª… ìˆ˜ëŸ‰]");
        return true;
    }

    // 2. ë‚´ ë³´ìœ  ì£¼ì‹ í™•ì¸
    if (msg === "/ë‚´ì£¼ì‹") {
        var holdings = user.stockHoldings || {};
        var keys = Object.keys(holdings);
        var title = "ğŸ“Š " + getDisplayName(user) + "ì˜ ì£¼ì‹ ìƒí™©";

        if (keys.length === 0) {
            replier.reply(formatCommand(title, null, "ë³´ìœ  ì¤‘ì¸ ì£¼ì‹ì´ ì—†ìŠµë‹ˆë‹¤.", "ë§¤ìˆ˜: [/ë§¤ìˆ˜ ì¢…ëª©ëª… ìˆ˜ëŸ‰]"));
            return true;
        }

        var list = [];
        var totalEvaluation = 0;
        var totalPurchase = 0;

        for (var i = 0; i < keys.length; i++) {
            var sName = keys[i];
            var count = Number(holdings[sName]);
            if (count <= 0) continue;

            var stock = data.stockMarket[sName];
            var isDelisted = !stock; 
            var curPrice = isDelisted ? 0 : Math.floor(Number(stock.price));
            var avgPrice = Math.floor(Number(user.stockAvg[sName] || 0));
            
            var purchaseVal = Math.floor(avgPrice * count);
            var evaluationVal = Math.floor(curPrice * count);
            
            totalPurchase += purchaseVal;
            totalEvaluation += evaluationVal;
            
            var profit = evaluationVal - purchaseVal;
            var profitRate = avgPrice > 0 ? ((profit / purchaseVal) * 100).toFixed(1) : "0.0";
            var signIcon = profit > 0 ? "ğŸ”º" : (profit < 0 ? "ğŸ”¹" : "â–");
            var nameDisplay = isDelisted ? "âš ï¸(ìƒí) " + sName : sName;
            
            list.push("â€¢ " + nameDisplay + " " + count + "ì£¼\n" +
                      "  ìˆ˜ìµ: " + fp(Math.floor(profit)) + "P (" + signIcon + profitRate + "%)\n" +
                      "  í‰ë‹¨: " + fp(avgPrice) + "P â” í˜„ì¬: " + fp(curPrice) + "P");
        }

        var totalProfit = totalEvaluation - totalPurchase;
        var totalRate = totalPurchase > 0 ? ((totalProfit / totalPurchase) * 100).toFixed(1) : "0.0";
        var totalSignIcon = totalProfit > 0 ? "ğŸ”º" : (totalProfit < 0 ? "ğŸ”¹" : "â–");

        var summary = "ğŸ’ ì´ í‰ê°€ê¸ˆì•¡: " + fp(Math.floor(totalEvaluation)) + "P\n" +
                      "ğŸ“Š ì´ ìˆ˜ìµë¥ : " + fp(Math.floor(totalProfit)) + "P (" + totalSignIcon + totalRate + "%)\n" +
                      "ğŸ’° ë³´ìœ  í¬ì¸íŠ¸: " + fp(Math.floor(user.point)) + "P";

        replier.reply(formatCommand(title, null, list.join("\n\n") + "\n\n" + summary, "ë§¤ë„: [/ë§¤ë„ ì¢…ëª©ëª… ìˆ˜ëŸ‰]"));
        return true;
    }

    // 3. ì£¼ì‹ ë§¤ìˆ˜ (ê¸ˆê³  ì…ê³  ë° íˆ¬ì ì¹­í˜¸ ì—°ë™)
    if (msg.indexOf("/ë§¤ìˆ˜ ") === 0) {
        if (user.mining && user.mining.active) { replier.reply(formatError(user, "ì‘ì—… ì¤‘", "ê´‘ì‚°ì—ì„œ ì±„êµ´ ì¤‘ì—ëŠ” ì£¼ì‹ ê±°ë˜ë¥¼ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        var currentHour = new Date().getHours();
        if (currentHour < 7) { replier.reply(formatError(user, "ì£¼ì‹ ì‹œì¥ ë§ˆê°", "í˜„ì¬ëŠ” ì£¼ì‹ ì¥ì™¸ ì‹œê°„ì…ë‹ˆë‹¤.\n(ìš´ì˜ì‹œê°„: 07:00 ~ 23:59)")); return true; }

        var parts = msg.split(" ");
        if (parts.length < 3) { replier.reply(formatError(user, "í˜•ì‹ ì˜¤ë¥˜", "/ë§¤ìˆ˜ [ì¢…ëª©ëª…] [ìˆ˜ëŸ‰]")); return true; }
        var sName = parts[1], count = parseInt(parts[2]);
        var stock = data.stockMarket[sName];
        if (!stock) { replier.reply(formatError(user, "ì¢…ëª© ì—†ìŒ", "[" + sName + "]ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (isNaN(count) || count <= 0) { replier.reply(formatError(user, "ìˆ˜ëŸ‰ ì˜¤ë¥˜", "ìˆ˜ëŸ‰ì„ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”.")); return true; }
        
        var totalPrice = Math.floor(Number(stock.price) * count);
        if (Number(user.point) < totalPrice) { replier.reply(formatError(user, "í¬ì¸íŠ¸ ë¶€ì¡±", "í•„ìš”: " + fp(totalPrice) + "P")); return true; }
        
        /* [í•µì‹¬] ì¤‘ì•™ì€í–‰ ì—°ë™: ë§¤ìˆ˜ ëŒ€ê¸ˆì„ ê¸ˆê³ ì— ì…ê³  */
        util_updatePoint(user, roomData, -totalPrice, "ì£¼ì‹ ë§¤ìˆ˜", roomName);

        if (!user.stockHoldings) user.stockHoldings = {};
        if (!user.stockAvg) user.stockAvg = {};
        var curCount = Number(user.stockHoldings[sName] || 0);
        var curAvg = Number(user.stockAvg[sName] || 0);
        
        user.stockAvg[sName] = Math.floor(((curAvg * curCount) + totalPrice) / (curCount + count));
        user.stockHoldings[sName] = curCount + count;

        /* [ì‹ ê·œ] ëˆ„ì  íˆ¬ì ë°ì´í„° ì—…ë°ì´íŠ¸ ë° ì¹­í˜¸ ì²´í¬ */
        if (user.totalInvestAmount === undefined) user.totalInvestAmount = 0;
        user.totalInvestAmount += totalPrice;

        var replierStub = { reply: function(m) { Api.replyRoom(roomName, m); } };
        if (user.totalInvestAmount >= 7000000) {
            util_checkAndAwardTitle(user, replierStub, "íˆ¬ìì˜ì‹ ", 4303, "ğŸ“ˆ", "ëˆ„ì  íˆ¬ìì•¡ 7,000,000P", "ì°¨íŠ¸ë¥¼ ì§€ë°°í•˜ì—¬ íˆ¬ìì˜ì‹ ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤!");
        } else if (user.totalInvestAmount >= 3000000) {
            util_checkAndAwardTitle(user, replierStub, "í°ì†", 4302, "ğŸ“‰", "ëˆ„ì  íˆ¬ìì•¡ 3,000,000P", "ì°¨íŠ¸ë¥¼ ì§€ë°°í•˜ì—¬ [íˆ¬ìì˜ì‹ ]ì— ë„ë‹¬í•˜ì„¸ìš”!");
        } else if (user.totalInvestAmount >= 1000000) {
            util_checkAndAwardTitle(user, replierStub, "ê°œë¯¸", 4301, "ğŸœ", "ëˆ„ì  íˆ¬ìì•¡ 1,000,000P", "ì‹œì¥ì„ ë°°ìš°ëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤. [í°ì†]ì„ í–¥í•´ ë‚˜ì•„ê°€ì„¸ìš”!");
        }
        
        if (!data.stockTraffic) data.stockTraffic = {};
        if (!data.stockTraffic[sName]) data.stockTraffic[sName] = { buy: 0, sell: 0 };
        data.stockTraffic[sName].buy += count;
        
        replier.reply(formatCommand("ğŸ“ˆ ì£¼ì‹ ë§¤ìˆ˜ ì™„ë£Œ", user, "ì¢…ëª©: " + sName + "\nìˆ˜ëŸ‰: " + count + "ì£¼\në§¤ìˆ˜ê°€: " + fp(stock.price) + "P (ì´ " + fp(totalPrice) + "P)", "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
        safeSaveData(data);
        return true;
    }

    // 4. ì£¼ì‹ ë§¤ë„ (ê¸ˆê³  ì§€ì¶œ ì—°ë™ ë° ë±…í¬ëŸ° ë°©ì§€)
    if (msg.indexOf("/ë§¤ë„ ") === 0) {
        if (user.mining && user.mining.active) { replier.reply(formatError(user, "ì‘ì—… ì¤‘", "ê´‘ì‚°ì—ì„œ ì±„êµ´ ì¤‘ì—ëŠ” ì£¼ì‹ ê±°ë˜ë¥¼ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        var currentHour = new Date().getHours();
        if (currentHour < 7) { replier.reply(formatError(user, "ì£¼ì‹ ì‹œì¥ ë§ˆê°", "í˜„ì¬ëŠ” ì£¼ì‹ ì¥ì™¸ ì‹œê°„ì…ë‹ˆë‹¤.")); return true; }

        var parts = msg.split(" ");
        if (parts.length < 3) { replier.reply(formatError(user, "í˜•ì‹ ì˜¤ë¥˜", "/ë§¤ë„ [ì¢…ëª©ëª…] [ìˆ˜ëŸ‰]")); return true; }
        
        var sName = parts[1];
        var count = parseInt(parts[2]);
        var holdings = (user.stockHoldings && user.stockHoldings[sName]) ? Number(user.stockHoldings[sName]) : 0;

        if (holdings < count || count <= 0) { replier.reply(formatError(user, "ìˆ˜ëŸ‰ ë¶€ì¡±", "ë³´ìœ  ìˆ˜ëŸ‰ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")); return true; }
        
        var stock = data.stockMarket[sName];
        var sellPrice = stock ? Math.floor(Number(stock.price)) : 0;
        var totalSell = sellPrice * count; 
        var fee = Math.floor(totalSell * 0.05); 
        var finalPrice = totalSell - fee; 

        /* [í•µì‹¬] ì€í–‰ íŒŒì‚° ë³´í˜¸ (ë±…í¬ëŸ° ë°©ì§€) */
        if (roomData.bankReserve < finalPrice) {
            replier.reply(formatError(user, "ê±°ë˜ ì¼ì‹œ ì¤‘ë‹¨", "ì£„ì†¡í•©ë‹ˆë‹¤. í˜„ì¬ ì¤‘ì•™ì€í–‰ì˜ í˜„ê¸ˆ ìœ ë™ì„± ë¶€ì¡±ìœ¼ë¡œ ì£¼ì‹ ë§¤ë„ ëŒ€ê¸ˆ ì§€ê¸‰ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.\n\nğŸ¦ í˜„ì¬ ì€í–‰ ê¸ˆê³ : " + fp(roomData.bankReserve) + "P"));
            return true;
        }

        var avgPrice = (user.stockAvg && user.stockAvg[sName]) ? Number(user.stockAvg[sName]) : sellPrice; 
        var purchaseVal = Math.floor(avgPrice * count); 
        var profit = totalSell - purchaseVal; 
        var profitRate = purchaseVal > 0 ? ((profit / purchaseVal) * 100).toFixed(1) : "0.0";
        var signIcon = (profit > 0) ? "ğŸ”º" : (profit < 0 ? "ğŸ”¹" : "â–");

        user.stockHoldings[sName] = holdings - count;
        if (user.stockHoldings[sName] <= 0) { 
            delete user.stockHoldings[sName]; 
            if (user.stockAvg) delete user.stockAvg[sName]; 
        }
        
        var res = processRepayment(user, finalPrice, targetUid, roomName); 
        
        /* [í•µì‹¬] ì¤‘ì•™ì€í–‰ ì—°ë™: ë§¤ë„ ëŒ€ê¸ˆì„ ê¸ˆê³ ì—ì„œ ì°¨ê° ì§€ê¸‰ */
        util_updatePoint(user, roomData, Number(res.actualGain), "ì£¼ì‹ ë§¤ë„", roomName);
        
        if (!data.stockTraffic) data.stockTraffic = {};
        if (!data.stockTraffic[sName]) data.stockTraffic[sName] = { buy: 0, sell: 0 };
        data.stockTraffic[sName].sell += count;
        
        var sellMsg = "ğŸ“‰ ì£¼ì‹ ë§¤ë„ ì™„ë£Œ\n" +
              "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
              getDisplayName(user) + "ë‹˜\n" +
              "ì¢…ëª©: " + sName + " " + count + "ì£¼\n" +
              "ìˆ˜ìµ : " + fp(Math.abs(profit)) + "P (" + signIcon + Math.abs(profitRate).toFixed(1) + "%)\n" +
              "ì‹¤í˜„ì†ìµ : " + fp(finalPrice) + "P (ìˆ˜ìˆ˜ë£Œ -5% í¬í•¨)" + (res.repayMsg || "") + "\n" +
              "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
              "ğŸ’¡ [ê°€ì´ë“œ]: ë‚´ ì”ì•¡: " + fp(user.point) + "P";

        replier.reply(sellMsg);
        safeSaveData(data);
        return true;
    }

    return false;
}

//==========ì„¹í„°44==========

/**
 * [ê²Œì„ í•˜ìœ„ ëª¨ë“ˆ 5] ìƒì  ë° ê¸°íƒ€ í™œë™
 * ê¸°ëŠ¥: ìƒì  ë©”ë‰´ í˜¸ì¶œ, ì¶œì„ ì²´í¬
 * ì„¤ëª…: íì‡„í˜• ìˆœí™˜ ê²½ì œ ì—°ë™ - ì¶œì„ ë³´ìƒì„ ì¤‘ì•™ì€í–‰ ê¸ˆê³ ì—ì„œ ì§€ê¸‰í•©ë‹ˆë‹¤.
 */
function _gameShopLogic(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];
    if (!roomData) return false;

    // ì¤‘ì•™ì€í–‰ ì¬ì› ì´ˆê¸°í™” (ì•ˆì „ì¥ì¹˜)
    if (roomData.bankReserve === undefined || roomData.bankReserve === null) {
        roomData.bankReserve = SYSTEM_CONFIG.ECO.BANK.INITIAL_RESERVE;
    }

    /* [ê¸°ëŠ¥ 14] ìƒì  ë©”ë‰´ í˜¸ì¶œ */
    if (msg === "/ìƒì ") {
        menuWaitState[targetUid] = { type: 'shop_category', time: Date.now() };
        var categoryList = [];
        for (var id in SHOP_CATEGORIES) {
            categoryList.push(id + ". " + SHOP_CATEGORIES[id]);
        }
        var shopMenu = "ì›í•˜ì‹œëŠ” ì¹´í…Œê³ ë¦¬ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.\n\n" + categoryList.join("\n");
        replier.reply(formatCommand("ğŸ›’ ë‚´ë¦¬ë‹¤ë´‡ í†µí•© ìƒì ", user, shopMenu, "ì·¨ì†Œ: [ì·¨ì†Œ] / ì…ë ¥ ëŒ€ê¸°: 30ì´ˆ"));
        return true;
    }

    /* [ê¸°ëŠ¥ 2] ì¶œì„ ì²´í¬ (ì¤‘ì•™ì€í–‰ ì—°ë™) */
    if (msg === "/ì¶œì„") {
        var today = getSimpleDate();
        // 1. ì¤‘ë³µ ì¶œì„ ì²´í¬
        if (user.lastDate === today) { 
            replier.reply(formatError(user, "ì´ë¯¸ ì¶œì„ ì™„ë£Œ", "ì¶œì„ì€ í•˜ë£¨ì— í•œ ë²ˆë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.")); 
            return true; 
        }
        
        // 2. ë¬¼ê°€ ì—°ë™ ë°°ìœ¨ ê³„ì‚°
        var multiplier = 1.0;
        if (roomData.economyBase && roomData.economyBase > 0) {
            var eco = calculateEconomy(data, roomName);
            var rawRatio = eco.total / roomData.economyBase;
            var damping = (data.economyDamping !== undefined) ? data.economyDamping : 0.5;
            multiplier = 1 + (rawRatio - 1) * damping;
            if (multiplier < 0.5) multiplier = 0.5;
        }

        // 3. ëœë¤ ë³´ìƒ ê³„ì‚° (200P ~ 300P ì‚¬ì´)
        var minR = SYSTEM_CONFIG.ECO.ATTEND_MIN || 200;
        var maxR = SYSTEM_CONFIG.ECO.ATTEND_MAX || 300;
        var baseReward = Math.floor(Math.random() * (maxR - minR + 1)) + minR; 
        var reward = Math.floor(baseReward * multiplier);

        /* [í•µì‹¬ ìˆ˜ì •] ì€í–‰ íŒŒì‚° ë³´í˜¸ ë¡œì§ */
        // ì€í–‰ ê¸ˆê³ ì— ì¶œì„ ë³´ìƒì„ ì§€ê¸‰í•  ìˆ˜ ìˆëŠ” í˜„ê¸ˆì´ ìˆëŠ”ì§€ í™•ì¸
        if (roomData.bankReserve < reward) {
            var errorMsg = "ì£„ì†¡í•©ë‹ˆë‹¤. í˜„ì¬ ì¤‘ì•™ì€í–‰ì˜ ì¬ê³ ê°€ ë¶€ì¡±í•˜ì—¬ ì¶œì„ ë³´ìƒì„ ì§€ê¸‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n" +
                           "ê²½ì œ í™œë™(ì£¼ì‹ ë§¤ìˆ˜, ìƒì  ì´ìš© ë“±)ì„ í†µí•´ êµ­ê³ ê°€ ì¶©ì „ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.\n\n" +
                           "ğŸ¦ í˜„ì¬ ê¸ˆê³ : " + fp(roomData.bankReserve) + "P";
            replier.reply(formatError(user, "êµ­ê³  ê³ ê°ˆ", errorMsg));
            return true;
        }

        /* [í•µì‹¬ ìˆ˜ì •] ì¶œì„ ë³´ìƒ ì§€ê¸‰ ì „ í†µí•© ìƒí™˜ ì—”ì§„ í˜¸ì¶œ */
        var res = processRepayment(user, reward, targetUid, roomName);
        
        /* [í•µì‹¬ ìˆ˜ì •] ì¤‘ì•™ì€í–‰ ì—°ë™: ë³´ìƒê¸ˆì„ ê¸ˆê³ ì—ì„œ ì°¨ê° ì§€ê¸‰ */
        // util_updatePoint í˜¸ì¶œ ì‹œ roomDataë¥¼ ì „ë‹¬í•˜ì—¬ "ì¶œì„ ë³´ìƒ" ì‚¬ìœ ë¡œ ê¸ˆê³  ì”ì•¡ ì°¨ê°
        util_updatePoint(user, roomData, Number(res.actualGain), "ì¶œì„ ë³´ìƒ", roomName);

        // 4. ìœ ì € ìƒíƒœ ë°ì´í„° ì—…ë°ì´íŠ¸
        user.lastDate = today; 
        user.totalAttendance = (user.totalAttendance || 0) + 1;
        user.creditScore = Math.min(1000, (user.creditScore || 600) + 2); 
        
        var content = fp(reward) + "Pê°€ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤! (ì‹ ìš© +2)" + (res.repayMsg || "") + "\n" +
                      "ğŸ¦ êµ­ê³  ì¬ì›ì—ì„œ ì—°ê¸ˆì´ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.";

        replier.reply(formatCommand("âœ… ì¼ì¼ ì¶œì„ ì™„ë£Œ", user, content, "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
        
        safeSaveData(data); 
        return true;
    }

    return false;
}

//==========ì„¹í„°45==========

/* [ì§€ì—° ì‹¤í–‰] ëª…ë ¹ì–´ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì´ˆê¸°í™” (Initialization) */
// ëª¨ë“  ë¡œì§ í•¨ìˆ˜(ì„¹í„° 30~44)ê°€ ë©”ëª¨ë¦¬ì— ì ì¬ëœ í›„ ì‹¤í–‰ë˜ì–´ì•¼ í•˜ë¯€ë¡œ íŒŒì¼ ë§¨ ëì— ë°°ì¹˜í•©ë‹ˆë‹¤.
(function initializeRegistry() {
    try {
        // 1. ìœ ì € ëª…ë ¹ì–´ ë“±ë¡
        // ì„¹í„° 6ì˜ CMD_LIST.userì— ì¶”ê°€ëœ ê²½ë§ˆ ê´€ë ¨ ëª…ë ¹ì–´ë“¤ì„ ìë™ìœ¼ë¡œ ìˆœíšŒí•˜ë©° ë“±ë¡í•©ë‹ˆë‹¤.
        for (var i = 0; i < CMD_LIST.user.length; i++) {
            var c = CMD_LIST.user[i];
            
            // evalì„ ì‚¬ìš©í•˜ì—¬ ë¬¸ìì—´ ì´ë¦„(ì˜ˆ: "_gameActionLogic")ì„ ì‹¤ì œ í•¨ìˆ˜ ê°ì²´ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
            var executor = null;
            try { executor = eval(c.func); } catch(e) {}

            if (typeof executor === 'function') {
                registerUserCmd(c.cmd, c.desc, c.cat, executor);
            } else {
                Log.error("âŒ ëª…ë ¹ì–´ ë“±ë¡ ì‹¤íŒ¨ (í•¨ìˆ˜ ë¯¸ë°œê²¬): " + c.cmd + " -> " + c.func);
            }
        }

        // 2. ê´€ë¦¬ì ëª…ë ¹ì–´ ë“±ë¡
        for (var j = 0; j < CMD_LIST.admin.length; j++) {
            var a = CMD_LIST.admin[j];
            
            var adminExecutor = null;
            try { adminExecutor = eval(a.func); } catch(e) {}

            if (typeof adminExecutor === 'function') {
                registerAdminCmd(a.cmd, a.desc, adminExecutor);
            } else {
                Log.error("âŒ ê´€ë¦¬ì ëª…ë ¹ì–´ ë“±ë¡ ì‹¤íŒ¨: " + a.cmd);
            }
        }
        
        // [Gemini ì•Œë¦¼] ê²½ë§ˆ ì‹œìŠ¤í…œ ë¡œë“œ í™•ì¸ ë¡œê·¸ (ë””ë²„ê¹…ìš©)
        Log.info("ğŸ [Racing System] ê²½ë§ˆ ì—”ì§„ ë° ê´€ë ¨ ëª…ë ¹ì–´ ë¡œë“œ ì™„ë£Œ.");
        
    } catch(e) {
        Log.error("Registry Init Critical Error: " + e);
    }
})();
