//==========ì„¹í„°1==========

/**
 * [v14.3] ì‹œìŠ¤í…œ ì „ì—­ ìì› ì„ ì–¸ë¶€
 * ê¸°ëŠ¥: ëª¨ë“  ì„¹í„°ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ìŠ¤ë ˆë“œ í’€ì„ ì „ì—­ ìŠ¤ì½”í”„ì— ì„ ì–¸í•©ë‹ˆë‹¤.
 */
var ParallelPool, LogicQueue, Executor, SaveExecutor; 

var SCHEDULER_KEY = "kakaobot_scheduler_v5";
var WATCHDOG_KEY = "kakaobot_watchdog_v1";
var MY_INSTANCE_ID = java.lang.System.identityHashCode(this) + "";

/* [v15.7] í•¨ì„  ì´ˆì›” ê°•í™” ë°¸ëŸ°ìŠ¤ ì„¤ì •ê°’ */
var SHIP_ENHANCE_CONFIG = {
    LIMIT:  { min: -3, max: 2 },  // ì ì¬ëŸ‰ ë²”ìœ„
    TIME:   { min: -10, max: 30 },  // í•­í•´ì‹œê°„ ë²”ìœ„
    PROFIT: { min: -3, max: 2 },  // ì •ì‚°ìˆ˜ìµ ë²”ìœ„
    COST:   100000                // ê°•í™” 1íšŒ ë¹„ìš©
};

/**
 * [v16.0] í•˜ì´ë¸Œë¦¬ë“œ ì§€ëŠ¥í˜• ì†Œê° ì—”ì§„ (CPU-Safe Deep Scrub)
 * ì—…ê·¸ë ˆì´ë“œ: ê³ ìœ„í—˜ ê²½ë¡œ ìš°ì„  ì†Œíƒ• í›„, ì¬ê·€ ê¹Šì´ë¥¼ 4ë‹¨ê³„ë¡œ ì œí•œí•œ 'ìŠ¤ë§ˆíŠ¸ ìŠ¤ìº”'ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
 * íš¨ê³¼: ìƒˆ ê¸°ëŠ¥ ì¶”ê°€ ì‹œ ê²½ë¡œë¥¼ ì¼ì¼ì´ ì¶”ê°€í•  í•„ìš”ê°€ ì—†ìœ¼ë©°, ë…¸íŠ¸9 CPU ë¶€í•˜ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.
 */
function util_fastClean(obj, depth) {
    if (!obj || typeof obj !== 'object') return;
    var d = depth || 0;
    if (d > 4) return; // [ë³´ì•ˆ] 4ë‹¨ê³„ ì´ìƒ ê¹Šì´ ì¹¨íˆ¬ ì°¨ë‹¨ (CPU ë³´í˜¸)

    // 1ë‹¨ê³„: ê³ ì„±ëŠ¥ íƒ€ê²ŸíŒ… ì†Œíƒ• (ê¸°ì¡´ í•˜ë“œì½”ë”© ê²½ë¡œ)
    if (d === 0) {
        if (obj.replier) obj.replier = null;
        if (obj.imageDB) obj.imageDB = null;
        if (obj.lastAction) obj.lastAction.replier = null;
        if (obj.voyage) obj.voyage.replier = null;
        if (obj.blackjackState) obj.blackjackState.replier = null;
    }

    // 2ë‹¨ê³„: ì§€ëŠ¥í˜• ì¬ê·€ ìˆ˜ìƒ‰ (ì‹ ê·œ ìœ ì… ê²½ë¡œ ìë™ íƒì§€)
    var keys = Object.keys(obj);
    for (var i = 0; i < keys.length; i++) {
        var key = keys[i];
        var val = obj[key];
        
        if (!val || typeof val !== 'object') continue; // ê¸°ë³¸ íƒ€ì…(ìˆ«ì/ë¬¸ì)ì€ ì¦‰ì‹œ íŒ¨ìŠ¤

        // ìë°” ë„¤ì´í‹°ë¸Œ ê°ì²´ ë˜ëŠ” ì„¸ì…˜ ë³µì œë³¸ ë°œê²¬ ì‹œ ì¦‰ì‹œ ì†Œê°
        if (val.getClass !== undefined || (val.constructor && val.constructor.name === 'SessionCacheReplier')) {
            obj[key] = null;
            continue;
        }

        // 3ë‹¨ê³„: ë°°ì—´ ë° ì¤‘ì²© ê°ì²´ ë‚´ë¶€ íƒìƒ‰ (ê¹Šì´ ì œí•œ ì¤€ìˆ˜)
        if (Array.isArray(val)) {
            for (var j = 0; j < val.length; j++) {
                if (val[j] && typeof val[j] === 'object') util_fastClean(val[j], d + 1);
            }
        } else {
            util_fastClean(val, d + 1);
        }
    }
}

if (typeof globalData === 'undefined' || globalData === null) {
    globalData = { rooms: {}, botActive: true, statusCheck: {} };
}
globalData._isInitialized = false;

/**
 * [v14.3] í•˜ì´í¼-í´ë¦° ë¶€íŠ¸ ì—”ì§„ (Power-Saving Edition)
 * ê¸°ëŠ¥: ìŠ¤ë ˆë“œ ê°œìˆ˜ë¥¼ 2ê°œë¡œ ì••ì¶•í•˜ì—¬ ë°œì—´ì„ ì¡ê³ , ì „ì—­ ë³€ìˆ˜ ì°¸ì¡° ì˜¤ë¥˜ë¥¼ í•´ê²°í•©ë‹ˆë‹¤.
 */
(function() {
    try {
        var REG = "msgbot_thread_pool_registry_v1";
        var ACT_ID = "CURRENT_ACTIVE_ID";

        // 1. [ì†Œê°] ì´ì „ ì¸ìŠ¤í„´ìŠ¤ì˜ ì¢€ë¹„ ìì› ë¬¼ë¦¬ì  íŒŒê´´
        if (typeof globalData !== 'undefined' && globalData[REG]) {
            var oldPools = globalData[REG];
            for (var i = 0; i < oldPools.length; i++) {
                try { if (oldPools[i]) oldPools[i].shutdownNow(); } catch (e) {}
            }
            Log.info("ğŸ—‘ï¸ [System] ì´ì „ ì¸ìŠ¤í„´ìŠ¤ ì¢€ë¹„ ìì› ì†Œê° ì™„ë£Œ");
        }

        // 2. [ì¤‘ë³µ íƒ€ì´ë¨¸ ì œê±°]
        var oldST = java.lang.System.getProperty(SCHEDULER_KEY);
        if (oldST) { clearInterval(parseInt(oldST)); java.lang.System.clearProperty(SCHEDULER_KEY); }
        var oldWD = java.lang.System.getProperty(WATCHDOG_KEY);
        if (oldWD) { clearInterval(parseInt(oldWD)); java.lang.System.clearProperty(WATCHDOG_KEY); }

        // 3. [ìµœì í™”] ì—”ì§„ ìƒì„± ë° ì „ì—­ ë³€ìˆ˜ í• ë‹¹ (var ì œê±°)
        // ParallelPool: ë©”ì„¸ì§€ ë¡œì§ ì²˜ë¦¬ìš© (ë…¸íŠ¸9 ì½”ì–´ ë¶€í•˜ ë¶„ì‚° 4ê°œ ê³ ì •)
        ParallelPool = java.util.concurrent.Executors.newFixedThreadPool(4); 
        LogicQueue = java.util.concurrent.Executors.newSingleThreadExecutor();
        // Executor: ë””ìŠ¤ì½”ë“œ ë°±ì—… ë° ì™¸ë¶€ í†µì‹  ì „ìš© (ëŠë¦° ì‘ì—… ê²©ë¦¬ 2ê°œ ê³ ì •)
        Executor = java.util.concurrent.Executors.newFixedThreadPool(2);
        // SaveExecutor: I/O ë° ë°ì´í„° ë¬´ê²°ì„± ì €ì¥ ì „ìš© (2ê°œ ê³ ì •)
        SaveExecutor = java.util.concurrent.Executors.newFixedThreadPool(2);

        java.lang.System.setProperty(ACT_ID, MY_INSTANCE_ID);
        globalData[REG] = [ParallelPool, LogicQueue, Executor, SaveExecutor];
        
        // globalScope(this) ë™ê¸°í™” - ë¡œë”ê°€ ì´ ë³€ìˆ˜ë“¤ì„ ì°¾ì„ ìˆ˜ ìˆê²Œ í•¨
        this.ParallelPool = ParallelPool;
        this.LogicQueue = LogicQueue;
        this.Executor = Executor;
        this.SaveExecutor = SaveExecutor;

        Log.info("â™»ï¸ [System] v14.3 ìµœì í™” ì—”ì§„ ì í™” ì„±ê³µ (ID: " + MY_INSTANCE_ID + ")");
        java.lang.System.gc(); 

    } catch (e) {
        Log.error("ğŸš¨ [System] ì—”ì§„ ë¦¬ë¶€íŠ¸ ì¹˜ëª…ì  ê²°í•¨: " + e);
    }
})();

var _lastHealNotifyTime = 0;

/* [v10.0] ì›ìì  ì•¡ì…˜ ìŠ¤í…Œì´ì§•(Staging) ì‹œìŠ¤í…œ ì „ì—­ ê°ì²´ */
var GLOBAL_STAGING = {
    active: {}, // { uid: boolean } ìŠ¤í…Œì´ì§• ëª¨ë“œ í™œì„±í™” ì—¬ë¶€
    cache: {}   // { uid: { userObject_Snapshot } } ì„ì‹œ ì €ì¥ë³¸
};

/* [v10.0] ì§€ëŠ¥í˜• ì‹œìŠ¤í…œ í™˜ê²½ ì„¤ì • (Performance & Gini) */
var INTELLIGENT_CONFIG = {
    PERFORMANCE: {
        MAX_LOG_SIZE: 1.5 * 1024 * 1024, // 1.5MB ì´ˆê³¼ ì‹œ ìë™ ë¡œí…Œì´ì…˜
        LAG_THRESHOLD_MS: 450,           // ì‘ë‹µ 0.45ì´ˆ ì´ˆê³¼ ì‹œ ê²½ê³  ë° ìë™ ìµœì í™”
        GC_INTERVAL_MIN: 10              // 10ë¶„ë§ˆë‹¤ ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ ìœ ë„
    },
    ECONOMY: {
        GINI_CRITICAL: 0.45,             // ì§€ë‹ˆê³„ìˆ˜ 0.45 ì´ˆê³¼ ì‹œ 'ë¹ˆë¶€ê²©ì°¨ ê²½ë³´' ë° êµì • ê°€ë™
        MAX_PROGRESSIVE_TAX: 0.5,       // ë¶ˆí‰ë“± ì‹¬í™” ì‹œ ìì‚°ê°€ ìµœëŒ€ ì¶”ê°€ ì„¸ìœ¨ (5%)
        REWARD_BOOST_LIMIT: 1.5          // ì„œë¯¼ì¸µ ìµœëŒ€ ë³´ìƒ ê°•í™” ë°°ìœ¨ (1.5ë°°)
    }
};

/* [ì‹ ê·œ] ëª…ë ¹ì–´ ìë™ ë“±ë¡ ì‹œìŠ¤í…œ (Command Registry) */
var USER_COMMANDS = {};
var ADMIN_COMMANDS = {};

function registerUserCmd(cmd, desc, cat, func) {
    USER_COMMANDS[cmd] = { desc: desc, cat: cat, execute: func };
}

function registerAdminCmd(cmd, desc, func) {
    ADMIN_COMMANDS[cmd] = { desc: desc, execute: func };
}

/**
 * [ì „ì—­ í‘œì¤€ ê·œê²©] USER_SCHEMA v1.0
 * ì¹˜ìœ (Sector 19)ì™€ ì‹ ê·œê°€ì…(Sector 20-1)ì´ ê³µí†µìœ¼ë¡œ ì°¸ì¡°í•˜ëŠ” ë¦¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤.
 * ë®ì–´ì“°ê¸° ì‚¬ê³ ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ point ë“± í•µì‹¬ ìì‚°ì˜ ê¸°ë³¸ê°’ì€ 0ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
 */
var USER_SCHEMA = [
    { key: 'point', default: 0, type: 'number' },
    { key: 'bank', default: 0, type: 'number' },
    { key: 'tier', default: 0, type: 'number' },
    { key: 'totalAttendance', default: 0, type: 'number' },
    { key: 'creditScore', default: 600, type: 'number' },
    { key: 'inventory', default: [], type: 'array' },
    { key: 'collectedIcons', default: [], type: 'array' },
    { key: 'landHoldings', default: {}, type: 'object' },
    { key: 'landAvg', default: {}, type: 'object' },
    { key: 'chatLog', default: [], type: 'array' },
    { key: 'timeoutEndTime', default: 0, type: 'number' },
    { key: 'totalMiningTime', default: 0, type: 'number' },
    { key: 'artifactPieces', default: 0, type: 'number' },
    { key: 'totalGambleCount', default: 0, type: 'number' },
    { key: 'totalGambleWins', default: 0, type: 'number' },
    { key: 'totalTheftSuccess', default: 0, type: 'number' },
    { key: 'totalLandInvest', default: 0, type: 'number' },
    { key: 'dailyPromotionAttempts', default: 1, type: 'number' },
    { key: 'dailyGambleCount', default: 0, type: 'number' },
    { key: 'boughtWarningRemoval', default: false, type: 'boolean' },
    { key: 'hasVotedToday', default: false, type: 'boolean' },
    { key: 'lastFishingTime', default: 0, type: 'number' },
    { key: 'totalSpittoBought', default: 0, type: 'number' },
    { key: 'horseParts', default: [], type: 'array' },
    { key: 'landDeedCount', default: 0, type: 'number' },
    { key: 'lottoFailCount', default: 0, type: 'number' },
    { key: 'luckyCharmEnd', default: 0, type: 'number' },
    { key: 'accruedInterest', default: 0, type: 'number' },
    { key: 'lastBankUpdateTime', default: 0, type: 'number' },
    { key: 'totalFishingSuccess', default: 0, type: 'number' },
    { key: 'totalDonation', default: 0, type: 'number' },
    { key: 'consecutiveWins', default: 0, type: 'number' },
    { key: 'lastGambleTime', default: 0, type: 'number' },
    { key: 'isManipulated', default: false, type: 'boolean' },
    { key: 'gambleWinRate', default: 0, type: 'number' },
    { key: 'fishLuck', default: 0, type: 'number' },
    { key: 'horseWinRate', default: 0, type: 'number' },
    { key: 'spittoWinRate', default: 0, type: 'number' },
    { key: 'shipLevel', default: 1, type: 'number' },
    { key: 'cargo', default: {}, type: 'object' },
    { key: 'cargoAvg', default: {}, type: 'object' },
    { key: 'specialties', default: {}, type: 'object' },
    { key: 'tradeCount', default: 0, type: 'number' },
    { key: 'totalCasinoBet', default: 0, type: 'number' },
    { key: 'totalCasinoWin', default: 0, type: 'number' },
    { key: 'shipName', default: '', type: 'string' },
    { key: 'lastCasinoResult', default: null, type: 'object' },
    { key: 'dailyLadderWins', default: [], type: 'array' },
    { key: 'dailyBaccaratWins', default: [], type: 'array' },
    { key: 'blackjackState', default: null, type: 'object' },
    { key: 'dailyBlackjackWins', default: [], type: 'array' },
    { key: 'casinoAuditStartTime', default: 0, type: 'number' },
    { key: 'casinoAuditStartAssets', default: 0, type: 'number' },
    { key: 'casinoAuditAlertHistory', default: [], type: 'array' },
    { key: 'lastBotUseTime', default: 0, type: 'number' },
    { key: 'loan', default: { debt: 0, items: [] }, type: 'object' },
    { key: 'purchasedPromotionAttempts', default: 0, type: 'number' },
    { key: 'gameAuthCount', default: 0, type: 'number' },
    { key: 'purchasedAuthCount', default: 0, type: 'number' },
    { key: 'boxFragments', default: 0, type: 'number' },
    { key: 'boxTickets', default: 0, type: 'number' },
    { key: 'dailyLoanCount', default: 0, type: 'number' },
    { key: 'dailyStimulusCount', default: 0, type: 'number' },
    { key: 'dailyCreditRestoreCount', default: 0, type: 'number' },
    { key: 'lastTheftActionTime', default: 0, type: 'number' },
    { key: 'lastTheftVictimTime', default: 0, type: 'number' },
    { key: 'isDefaulter', default: false, type: 'boolean' },
    { key: 'lastDate', default: '', type: 'string' },
    { key: 'hasSeenSyncNotice', default: false, type: 'boolean' },
    { key: 'challengerCount', default: 0, type: 'number' },
    { key: 'challengerIconSeason', default: '', type: 'string' },
    { key: 'tierGuard', default: 0, type: 'number' },
    { key: 'mining', default: { active: false, startTime: 0, room: "" }, type: 'object' },
    { key: 'jailReleaseTime', default: 0, type: 'number' },
    { key: 'isTransferred', default: false, type: 'boolean' },
    { key: 'lastAction', default: null, type: 'object' },
    { key: 'voyage', default: { active: false, dest: "", arrival: 0, marketSnapshot: {}, cargoSnapshot: {}, specialtySnapshot: {} }, type: 'object' },
    { key: 'job', default: null, type: 'string' }, // ì§ì—… ìƒíƒœ: 'pirate', 'navy', null
    { key: 'infamy', default: 0, type: 'number' }, // í•´ì  ì•…ëª…ì¹˜
    { key: 'fame', default: 0, type: 'number' },   // í•´êµ° ëª…ì„±ì¹˜
    { key: 'currentBounty', default: 0, type: 'number' }, // í•´ì ì—ê²Œ ê±¸ë¦° ì‹¤ì‹œê°„ í˜„ìƒê¸ˆ (êµ­ê³  ì˜ˆì•½ì•¡)
    { key: 'retreatEndTime', default: 0, type: 'number' }, // í•´êµ° íŒ¨ë°° ì‹œ í‡´ê° ì¢…ë£Œ ì‹œê°„ (15ë¶„ í˜ë„í‹°)
    { key: 'jobJoinDate', default: '', type: 'string' }, // ì§ì—… ê°€ì…ì¼ (ë¯¸í™œë™ ë°•íƒˆ ì²´í¬ìš©)
    { key: 'totalPillageSuccess', default: 0, type: 'number' }, // ëˆ„ì  ì•½íƒˆ ì„±ê³µ íšŸìˆ˜
    { key: 'totalCaptureSuccess', default: 0, type: 'number' }, // ëˆ„ì  í† ë²Œ ì„±ê³µ íšŸìˆ˜
    { key: 'isPillaged', default: false, type: 'boolean' }, // í˜„ì¬ í•­í•´ ì¤‘ ì•½íƒˆ ë°œìƒ ì—¬ë¶€ (ì¤‘ë³µ ì•½íƒˆ ë°©ì§€ìš©)
    { key: 'pillageCooldownEndTime', default: 0, type: 'number' }, // í•´ì  íŒ¨ë°° ì‹œ ì•½íƒˆ ì¿¨íƒ€ì„ (30ë¶„)
    { key: 'merchantShipLevel', default: 1, type: 'number' },
    { key: 'enhLimit', default: 0, type: 'number' },  // ì ì¬ëŸ‰ ê°•í™” (-3~2)
    { key: 'enhTime', default: 0, type: 'number' },   // ì‹œê°„ ê°•í™” (-2~3)
    { key: 'enhProfit', default: 0, type: 'number' }, // ìˆ˜ìµ ê°•í™” (-3~2)
    { key: 'tempEnh', default: null, type: 'object' }, // ì„ íƒ ëŒ€ê¸°ìš© ì„ì‹œì €ì¥
    { key: 'ancientMaps', default: 0, type: 'number' },       // ë³´ìœ  ì¤‘ì¸ ê³ ëŒ€ ì§€ë„ ìˆ˜
    { key: 'rareSpecialties', default: 0, type: 'number' },   // ë³´ìœ  ì¤‘ì¸ ì§„ê·€í•œ íŠ¹ì‚°í’ˆ ìˆ˜
    { key: 'lastHiddenVoyage', default: 0, type: 'number' },   // ë§ˆì§€ë§‰ ìì¹˜ë ¹ ì¶œí•­ íƒ€ì„ìŠ¤íƒ¬í”„
    { key: 'title', default: '', type: 'string' },
    { key: 'icon', default: '', type: 'string' },
    { key: 'chatCount', default: 0, type: 'number' },
    { key: 'chatCycleCount', default: 0, type: 'number' },
    { key: 'chatBonusTarget', default: 0, type: 'number' },
    { key: 'chatBonusGiven', default: false, type: 'boolean' },
    { key: 'lastPirateWageDate', default: '', type: 'string' },
    { key: 'lastNavyWageDate', default: '', type: 'string' },
    { key: 'claimableReward', default: 0, type: 'number' },
    { key: 'hasNotifiedReward', default: false, type: 'boolean' },
    { key: 'durability', default: 100, type: 'number' }, // ì„ ë°• ë‚´êµ¬ë„ (0~100)
    { key: 'currentLoc', default: 'ë¬´ì—­ ì§€ë¶€', type: 'string' } // í˜„ì¬ ìœ„ì¹˜
];

/* [ì´ˆê³ ì† ì—”ì§„] ì „ì—­ UID-ë‹‰ë„¤ì„ ìºì‹œ ì´ˆê¸°í™” */
if (typeof globalData !== 'undefined' && !globalData.nameToIdCache) {
    globalData.nameToIdCache = {};
}

/* [v10.0] ì§€ëŠ¥í˜• ì„±ëŠ¥ ê°ì‹œì(IPM) ì „ì—­ ë©”íŠ¸ë¦­ìŠ¤ */
var PERF_METRICS = {
    avgLag: 0,        // í‰ê·  ì§€ì—° ì‹œê°„ (ms)
    peakLag: 0,       // ìµœê³  ì§€ì—° ì‹œê°„ (ms)
    lastOptimize: 0,  // ë§ˆì§€ë§‰ ìµœì í™” ì‹œê°„
    msgPerMin: 0,     // ë¶„ë‹¹ ì²˜ë¦¬ ë©”ì‹œì§€ ìˆ˜
    logSize: 0        // í˜„ì¬ ë¡œê·¸ íŒŒì¼ í¬ê¸° (bytes)
};

/* íŒŒì¼ ë° ë°ì´í„° ë™ê¸°í™” ê°ì²´ */
var Lock = java.util.concurrent.locks.ReentrantLock; 
var lock = new Lock(); 
var logLock = new Lock(); // [v5.8] ì €ë„ë§(ë¸”ë™ë°•ìŠ¤) ì „ìš© ë…ë¦½ ë½ ì¶”ê°€
var SD_PATH = android.os.Environment.getExternalStorageDirectory().getAbsolutePath(); 
var BASE_DIR = SD_PATH + "/msgbot/data/"; 
var FILE_PATH = BASE_DIR + "attendance.json"; 
var REGISTRY_PATH = BASE_DIR + "user_registry.json";
var JOURNAL_PATH = BASE_DIR + "transaction.log"; // [v5.8] ì‹¤ì‹œê°„ ê±°ë˜ ê¸°ë¡ìš© ë¸”ë™ë°•ìŠ¤ ê²½ë¡œ
var BACKUP_DIR = BASE_DIR + "backup/"; 

/**
 * [v10.2] ë¡œê·¸ ë¬´ê²°ì„± ë° ì‹œìŠ¤í…œ ê¶Œí•œ ìê°€ì§„ë‹¨
 * ê¸°ëŠ¥: ë´‡ì´ ê°€ë™ë  ë•Œ ë¸”ë™ë°•ìŠ¤ íŒŒì¼ì— ì“°ê¸° ê¶Œí•œì´ ìˆëŠ”ì§€ ì¦‰ì‹œ ì²´í¬í•©ë‹ˆë‹¤.
 */
(function checkSystemIntegrity() {
    try {
        var logDir = new java.io.File(BASE_DIR);
        if (!logDir.exists()) logDir.mkdirs();

        var testFile = new java.io.File(JOURNAL_PATH);
        var isWritable = testFile.exists() ? testFile.canWrite() : logDir.canWrite();
        
        if (!isWritable) {
            // ìˆ˜ì •: í‘œì¤€ ë³´ì•ˆ ë¡œê·¸ í¬ë§· ì ìš© (ë””ìì¸ í†µì¼)
            var body = "âŒ ë‚´ìš©: ë¸”ë™ë°•ìŠ¤ ë¡œê·¸ ì“°ê¸° ê¶Œí•œ ê±°ë¶€\n" +
                       "ğŸ“ ê²½ë¡œ: " + BASE_DIR + "\n" +
                       "âš ï¸ ìœ„ê¸°: ì‹œìŠ¤í…œ ì €ë„ë§ ë° ë³µêµ¬ ê¸°ëŠ¥ ë§ˆë¹„";

            var alertMsg = util_formatSecurityLog(
                "ğŸš¨ [SYSTEM: ë¬´ê²°ì„± ì§„ë‹¨ ìœ„ê¸°]", 
                "SERVER_OS", 
                "ë² ë¦­ë°©", 
                body, 
                "ê¸°ê¸° ì €ì¥ì†Œ ê¶Œí•œ í™•ì¸ ë° ìˆ˜ë™ ì¬ì„¤ì • ê¶Œê³ "
            );
            Log.error(alertMsg);
            try { Api.replyRoom("ë² ë¦­ë°©", alertMsg); } catch(e) {}
        } else {
            Log.info("âœ… [ë³´ì•ˆ ê°€ë™] ë¸”ë™ë°•ìŠ¤ ë¬´ê²°ì„± ê²€ì‚¬ í†µê³¼.");
            // ì„ íƒì‚¬í•­: ê°€ë™ ì„±ê³µ ì‹œì—ë„ ì•Œë¦¼ì„ ë°›ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì£¼ì„ì„ í•´ì œí•˜ì„¸ìš”.
            // try { Api.replyRoom("ë² ë¦­ë°©", "âœ… ë¸”ë™ë°•ìŠ¤ ê¸°ë¡ ì¥ì¹˜ê°€ ì •ìƒ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤."); } catch(e) {}
        }
    } catch (e) {
        Log.error("Integrity Check Error: " + e);
    }
})();

/* [ìµœì í™”] ì „ì—­ UID ìºì‹œ ì‹œìŠ¤í…œ */
var uidCache = uidCache || {}; 

/* ë¡œê·¸ ì €ì¥ ê²½ë¡œ ë° ë””ë ‰í† ë¦¬ ì„¤ì • */ 
var BUG_LOG_PATH = BASE_DIR + "logs/bug_report.txt"; 
var ERROR_LOG_PATH = BASE_DIR + "logs/error_log.txt"; 
var logDir = new java.io.File(BASE_DIR + "logs/"); 
if (!logDir.exists()) logDir.mkdirs(); 
var dir = new java.io.File(BACKUP_DIR); 
if (!dir.exists()) dir.mkdirs(); 

/* ì „ì—­ ìƒíƒœ ë³€ìˆ˜ */ 
if (typeof globalData === 'undefined' || globalData === null) {
    var globalData = { rooms: {}, botActive: true }; 
}

/* [ì•ˆì •í™”] í•µì‹¬ ê²Œì„ ì—”ì§„ ë° ìƒíƒœ ì°¸ì¡° ì „ì—­ ì„ ì–¸ */
var racingData = null;      // ê²½ë§ˆ ì‹¤ì‹œê°„ ë°ì´í„° ì°¸ì¡°ìš©
var lotto = null;           // ë¡œë˜ ì‹¤ì‹œê°„ ë°ì´í„° ì°¸ì¡°ìš©
var marketOpenPrice = globalData.marketOpenPrice || 0;    // ëœë“œë§ˆí¬ ì‹œê°€ ì°¸ì¡°ìš©
var sprinkleData = {};      // ë¿Œë¦¬ê¸° ìƒíƒœ ì°¸ì¡°ìš©
var _msgReceiveTime = 0;    // [ì‹ ê·œ] ì‘ë‹µì†ë„ ì¸¡ì •ì„ ìœ„í•œ ì „ì—­ íƒ€ì„ìŠ¤íƒ¬í”„

/* [ì•ˆì •í™”] ì…ë ¥ ëŒ€ê¸° ë° í™œë™ ìƒíƒœ ë³€ìˆ˜ ì´ˆê¸° ì„ ì–¸ */
var menuWaitState = {};
var bankProcessState = {};
var selectWaitState = {};
var lottoPurchaseState = {};
var activeThefts = {};
var duelData = {};
var miningState = {};
var loanRegisterState = {};
var loanContractWaitState = {};


/**
 * [ê°œí¸] ë¬´ì—­ êµ­ê°€ë³„ ê³ ì • ìƒì‚° í’ˆëª© ë° íŠ¹ì‚°í’ˆ ë§¤í•‘ (ìˆœí™˜ ë§¤ì¹­ ì—”ì§„ìš©)
 * ì„¤ëª…: ê° êµ­ê°€ì˜ ìêµ­ ìƒì‚°ë¬¼ì„ ì •ì˜í•˜ë©°, ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ì´ë¥¼ ì œì™¸í•œ í’ˆëª©ì„ ì„ í˜¸/ê¸°í”¼ë¡œ ë°°ì •í•©ë‹ˆë‹¤.
 */
var TRADE_RELATION = {
    "í¬ë¥´íˆ¬": { produce: "ì‹ë£Œí’ˆ", set: "ë¼ì§€ê³ ê¸°" },
    "ì½”ì½œë¼": { produce: "ê³µì—…í’ˆ", set: "ê°•ì² " },   // ê³µì˜ˆí’ˆ -> ê³µì—…í’ˆìœ¼ë¡œ ìˆ˜ì •
    "ë‚˜í´ë¦¬": { produce: "ê³µì˜ˆí’ˆ", set: "ë„ìê¸°" }, // ê³µì—…í’ˆ -> ê³µì˜ˆí’ˆìœ¼ë¡œ ìˆ˜ì •
    "ë² ë¼í¬ë£¨ìŠ¤": { produce: "ê·€ê¸ˆì†", set: "ê¸ˆê´´" },
    "í‚´ë²Œë¦¬": { produce: "ë³´ì„", set: "ë‹¤ì´ì•„ëª¬ë“œ" }
};

/**
 * [Gemini ìš”ì²­ ì‚¬í•­] ë°©ë³„ ë…ë¦½í™”ë¥¼ ìœ„í•œ ë°ì´í„° í…œí”Œë¦¿
 * ì„¤ëª…: ì•„ë˜ì˜ êµ¬ì¡°ê°€ ê° ë°©(Room)ì´ ìƒì„±ë  ë•Œë§ˆë‹¤ ë…ë¦½ì ìœ¼ë¡œ ë³µì œë˜ì–´ í• ë‹¹ë©ë‹ˆë‹¤.
 */
var ROOM_FEATURE_TEMPLATE = function() {
    return {
        /* [Gemini ìš”ì²­ ì‚¬í•­] ê²½ë§ˆ ì‹œìŠ¤í…œ ì‹¤ì‹œê°„ ìƒíƒœ ë° ìƒìˆ˜ ì„¤ëª… í†µí•© */
        racing: {
            round: 1,           // [íšŒì°¨]: ê²½ë§ˆì˜ ì§„í–‰ ì°¨ìˆ˜ë¥¼ ê¸°ë¡ (ë´‡ ì¬ì‹œì‘ ì‹œ 1ë¡œ ì´ˆê¸°í™”ë¨)
            horses: [           // [ì¶œì „ë§ˆ ì •ë³´]: ê° ë§ì˜ ê³ ìœ  ID, ì´ë¦„, ìš°ìŠ¹ ê°€ì¤‘ì¹˜(weight), ìƒíƒœ ì•„ì´ì½˜ ì €ì¥
                { id: 1, name: "ì–´ë§ˆì–´ë§ˆ", weight: 1.0, icon: "â˜ï¸ ë³´í†µ" },
                { id: 2, name: "ì–´ì„œë§ì„í•´", weight: 1.0, icon: "â˜ï¸ ë³´í†µ" },
                { id: 3, name: "ë§ˆì˜ì›¨ì´", weight: 1.0, icon: "â˜ï¸ ë³´í†µ" },
                { id: 4, name: "í•µíƒ„ë‘", weight: 1.0, icon: "â˜ï¸ ë³´í†µ" },
                { id: 5, name: "ëŒê²©ì•ìœ¼ë¡œ", weight: 1.0, icon: "â˜ï¸ ë³´í†µ" }
            ],
            bets: {},           // [ë°°íŒ… ê¸°ë¡]: { UID: {horseId, amount, name} } í˜•ì‹ìœ¼ë¡œ í˜„ì¬ íšŒì°¨ ë°°íŒ… ì •ë³´ë¥¼ ì €ì¥
            totalPool: 0,       // [ë‹¹ê¸° ëˆ„ì ê¸ˆ]: ì´ë²ˆ íšŒì°¨ì— ìœ ì €ë“¤ì´ ë°°íŒ…í•œ ìˆœìˆ˜ í¬ì¸íŠ¸ í•©ê³„
            carryOver: 0,       // [ì´ì›”ê¸ˆ/Jackpot]: ì´ì „ íšŒì°¨ì—ì„œ ë‹¹ì²¨ìê°€ ì—†ì–´ ë„˜ì–´ì˜¨ í¬ì¸íŠ¸ (70% ë¹„ìœ¨ ì ìš©ì•¡)
            // [ìš´ì˜ í”Œë˜ê·¸]: ë´‡ ë¡œë“œ ì‹œ í˜„ì¬ ì‹œê°„ì„ ì¦‰ì‹œ íŒë³„í•˜ì—¬ 09:00~23:59 ì‚¬ì´ë©´ ìë™ìœ¼ë¡œ ê°€ë™ ìƒíƒœ(true)ë¡œ ì„¤ì •
            isOperating: (function() {
                var h = new Date().getHours();
                return h >= 9 && h <= 23; 
            })(),
            isDeadlineNotified: false, // [ì•Œë¦¼ ì œì–´]: 49ë¶„ 59ì´ˆ ë§ˆê° ê³µì§€ê°€ ì¤‘ë³µ ë°œì†¡ë˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ëŠ” ìŠ¤ìœ„ì¹˜
            isResultProcessed: false   // [ì •ì‚° ì œì–´]: ì •ê°(00ë¶„) ê²°ê³¼ ì •ì‚° ë¡œì§ì´ ì¤‘ë³µ ì‹¤í–‰ë˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ëŠ” ìŠ¤ìœ„ì¹˜
        },

        portData: {
            "í¬ë¥´íˆ¬": { level: 1, totalInvest: 0, governorUid: "", userInvests: {}, collectedTariff: 0 },
            "ì½”ì½œë¼": { level: 1, totalInvest: 0, governorUid: "", userInvests: {}, collectedTariff: 0 },
            "ë‚˜í´ë¦¬": { level: 1, totalInvest: 0, governorUid: "", userInvests: {}, collectedTariff: 0 },
            "ë² ë¼í¬ë£¨ìŠ¤": { level: 1, totalInvest: 0, governorUid: "", userInvests: {}, collectedTariff: 0 },
            "í‚´ë²Œë¦¬": { level: 1, totalInvest: 0, governorUid: "", userInvests: {}, collectedTariff: 0 }
        },

        /* ë°©ë³„ ëœë“œë§ˆí¬ ì‹œì¥ ë° ê¸°íƒ€ ë°ì´í„° */
        stockMarket: {},
        stockTraffic: {},
        marketOpenPrice: 0,
        sprinkleData: { active: false, winners: [], portions: [] },
        lotto: { round: 1, entries: {}, dailyPool: 0, jackpot: 0, lastWinNums: [] },

        msgCount: 0,

        government: {
            activePolicy: { // í˜„ì¬ ì‹œí–‰ ì¤‘ì¸ ì •ì±… ë°°ìœ¨ (ê¸°ë³¸ê°’)
                stockTax: 0.05,
                mineMult: 1.0,
                attendMult: 1.0,
                loanLimitMult: 1.0,
                bankInterest: 0.02,
                theftFineMult: 1.0,
                policeProbAdj: 0.0
            },
            pendingBill: null,   // ì˜¤ëŠ˜ ë°œì˜ëœ ì•ˆê±´ ë°ì´í„°
            votes: { pro: 0, con: 0, voters: [] }, // íˆ¬í‘œ ê°€ì¤‘ì¹˜ í•© ë° ì°¸ì—¬ì ëª…ë‹¨
            lastBillDate: "",
            resultStatus: null,
            isClosing: false
        },

        /* ë°©ë³„ ë…ë¦½ ì…ë ¥ ëŒ€ê¸° ìƒíƒœ */
        states: {
            menuWait: {}, bankProcess: {}, selectWait: {}, lottoPurchase: {},
            activeThefts: {}, duelData: {}, mining: {},
            loanRegister: {}, loanContractWait: {}
        }
    };
};

/* ê´€ë¦¬ì UID ê¸°ë°˜ ì¸ì¦ */ 
var adminUIDs = ["fixed-uuid-3873df88-0533-4647-99c8-8a4b0bde6da3", "fixed-uuid-ê´€ë¦¬ì2"]; 

/* [v16.6] ìˆ¨ê²¨ì§„ ìì¹˜ë ¹ 'ì—˜ë„ë¼ë„' íƒí—˜ ì„¤ì •ê°’ */
var ELDORADO_CONFIG = {
    NAME: "ì—˜ë„ë¼ë„: ìŠí˜€ì§„ ì„±ì—­",
    MAP_UNLOCK_COUNT: 10,        // ì…í•­ì— í•„ìš”í•œ ì§€ë„ ê°œìˆ˜
    PIECE_TO_MAP: 10,            // ì§€ë„ 1ì¥ë‹¹ í•„ìš”í•œ ì¡°ê° ìˆ˜
    COOLDOWN: 6 * 60 * 60 * 1000, // 6ì‹œê°„ ì¿¨íƒ€ì„
    PROFIT_MULT: 2.0,            // ìˆœìˆ˜ìµ 2ë°°
    RARE_PRICE: 100000,          // ì§„ê·€í•œ íŠ¹ì‚°í’ˆ ë§¤ê°ê°€
    MAP_PROB: 0.20               // ë¬´ì—­ ì‹œ ì§€ë„ íšë“ í™•ë¥  (20%)
};

/* ì‹œìŠ¤í…œ í•µì‹¬ ìƒìˆ˜ ì„¤ì • */
var SYSTEM_CONFIG = {

    TRADE: {
        PRICE_CYCLE_MIN: 60,        // ì‹œì„¸ ë³€ë™ ì£¼ê¸° (60ë¶„)

        GOODS_COST: {
            "ì‹ë£Œí’ˆ": 10000,
            "ê³µì—…í’ˆ": 15000,
            "ê³µì˜ˆí’ˆ": 20000,
            "ê·€ê¸ˆì†": 25000,
            "ë³´ì„": 30000
        },

        // [ì¶”ê°€] í•­êµ¬ íˆ¬ì ë° ì´ë… ì‹œìŠ¤í…œ ì„¸ë¶€ ì„¤ì •
        INVEST: {
            OPEN_HOUR: 7,           // íˆ¬ì ê°€ëŠ¥ ì‹œì‘ ì‹œê° (07:00)
            CLOSE_HOUR: 23,          // íˆ¬ì ê°€ëŠ¥ ì¢…ë£Œ ì‹œê° (23:59)
            LEVEL_UP_STEP: 1000000,  // ë ˆë²¨ì—… ê¸°ì¤€ ê¸ˆì•¡ (100ë§ŒPë‹¹ 1ë ˆë²¨ ìƒìŠ¹)
            MAX_LEVEL: 30,           // í•­êµ¬ ìµœëŒ€ ë°œì „ ë ˆë²¨
            BONUS_PER_LEVEL: 0.01,   // ë ˆë²¨ë‹¹ ì„ í˜¸ í’ˆëª© ë§¤ì…ê°€ ê°€ì‚° ë°°ìœ¨ (1%)
            GOV_SPEC_MIN: 1,         // ì´ë… íŠ¹ì‚°í’ˆ íšë“ ìµœì†ŒëŸ‰
            GOV_SPEC_MAX: 3          // ì´ë… íŠ¹ì‚°í’ˆ íšë“ ìµœëŒ€ëŸ‰
        },

        NATIONS: {
            "í¬ë¥´íˆ¬": { favorite: "ê³µì—…í’ˆ", hate: "ì‹ë£Œí’ˆ", specialty: "ë¼ì§€ê³ ê¸°" },
            "ì½”ì½œë¼": { favorite: "ê³µì˜ˆí’ˆ", hate: "ê·€ê¸ˆì†", specialty: "ê°•ì² " },
            "ë‚˜í´ë¦¬": { favorite: "ë³´ì„",   hate: "ê³µì—…í’ˆ", specialty: "ë„ìê¸°" },
            "ë² ë¼í¬ë£¨ìŠ¤": { favorite: "ì‹ë£Œí’ˆ", hate: "ë³´ì„",   specialty: "ê¸ˆê´´" },
            "í‚´ë²Œë¦¬": { favorite: "ê·€ê¸ˆì†", hate: "ê³µì˜ˆí’ˆ", specialty: "ë‹¤ì´ì•„ëª¬ë“œ" }
        },

        SHIPS: {
            1: { name: "ì¹´ë¼ë²¨", capacity: 10, speedMult: 1.0, upgradeCost: 0 },
Â  Â  Â  Â  Â  Â  2: { name: "í”„ë¦¬ê¹ƒ", capacity: 25, speedMult: 0.75, upgradeCost: 1000000 },
Â  Â  Â  Â  Â  Â  3: { name: "ê°¤ë¦¬ì˜¨", capacity: 40, speedMult: 0.5, upgradeCost: 2000000 },
Â  Â  Â  Â  Â  Â  4: { name: "í—¤ë¹„ í”„ë¦¬ê¹ƒ", capacity: 40, speedMult: 0.45, upgradeCost: 1000000 },
Â  Â  Â  Â  Â  Â  5: { name: "ë² ë„¤ì¹˜ì•ˆ ê°¤ë¦¬ì–´ìŠ¤", capacity: 40, speedMult: 0.42, upgradeCost: 1000000 },
Â  Â  Â  Â  Â  Â  6: { name: "ìŠˆí¼ í”„ë¦¬ê¹ƒ", capacity: 40, speedMult: 0.40, upgradeCost: 1000000 },
Â  Â  Â  Â  Â  Â  7: { name: "ì² ê°‘ì„ ", capacity: 40, speedMult: 0.38, upgradeCost: 1000000 },
Â  Â  Â  Â  Â  Â  8: { name: "1ë“± ì „ì—´í•¨", capacity: 40, speedMult: 0.35, upgradeCost: 1000000 },
Â  Â  Â  Â  Â  Â  9: { name: "ì†”ë ˆìœ  ë¡œì–„", capacity: 40, speedMult: 0.32, upgradeCost: 1000000 },
Â  Â  Â  Â  Â  Â  10: { name: "ì‚° í ë¦¬í˜", capacity: 40, speedMult: 0.30, upgradeCost: 1000000 }
        },
        EVENTS: {
            PROB: 1.0,             // ë¬´ì—­ ì •ì‚° ì‹œ ì´ë²¤íŠ¸ ë°œìƒ ì´ í™•ë¥  (40%)
            LIST: {
                STORM: { name: "í­í’ìš°", penalty: 0.15, msg: "ğŸŒŠ í­í’ìš°ë¥¼ ë§Œë‚˜ ì„ ì²´ê°€ íŒŒì†ë˜ì—ˆìŠµë‹ˆë‹¤! (ìˆ˜ë¦¬ë¹„ ì§€ì¶œ)" },
                FIRE: { name: "í™”ì¬", penalty: 0.2, target: ["ì‹ë£Œí’ˆ", "ê³µì˜ˆí’ˆ"], msg: "ğŸ”¥ ì°½ê³ ì— í™”ì¬ê°€ ë°œìƒí•˜ì—¬ ì ì¬ë¬¼ì´ ì „ì†Œë˜ì—ˆìŠµë‹ˆë‹¤!" },
                CORROSION: { name: "ë¶€ì‹", penalty: 0.2, target: ["ê³µì—…í’ˆ", "ê·€ê¸ˆì†"], msg: "ğŸ§ª ì†Œê¸ˆë¬¼ì— í™”ë¬¼ì´ ë¶€ì‹ë˜ì–´ ê°€ì¹˜ê°€ í•˜ë½í–ˆìŠµë‹ˆë‹¤!" },
                SMOOTH: { name: "ìˆœí•­", boost: 0.2, msg: "ğŸŒ¬ï¸ ìˆœí’ì„ íƒ€ê³  ì˜ˆì •ë³´ë‹¤ ë¹ ë¥´ê²Œ ë„ì°©í–ˆìŠµë‹ˆë‹¤!" },
                FESTIVAL: { name: "ì¶•ì œ", boost: 0.15, msg: "ğŸŠ í•­êµ¬ì˜ ì¶•ì œë¡œ ë¬¼ìê°€ ë¹„ì‹¸ê²Œ íŒ”ë ¸ìŠµë‹ˆë‹¤!" },
                FLOTSAM: { name: "ë‚œíŒŒì„ ", min: 10000, max: 50000, msg: "ğŸšï¸ í‘œë¥˜í•˜ë˜ ë‚œíŒŒì„ ì—ì„œ ê·€ì¤‘í•œ ë¬¼ìë¥¼ ê±´ì ¸ëƒˆìŠµë‹ˆë‹¤!" },
                MONSTER:  { name: "ê´´ìˆ˜ìŠµê²©", penalty: 0.25, msg: "ğŸ¦‘ ì‹¬í•´ ê´´ìˆ˜ì˜ ìŠµê²©ìœ¼ë¡œ ë°°ê°€ ë°˜íŒŒë˜ì—ˆìŠµë‹ˆë‹¤!" },
                FOG:      { name: "ì§™ì€ì•ˆê°œ", penalty: 0.1, msg: "ğŸŒ«ï¸ ì•ˆê°œë¡œ ì¸í•´ ì…í•­ì´ ì§€ì—°ë˜ì—ˆìŠµë‹ˆë‹¤." },
                SCURVY:   { name: "ì„ ì›ê´´ì§ˆ", flatPenalty: 20000, msg: "ğŸ¥ ê´´í˜ˆë³‘ ì¹˜ë£Œë¹„ë¡œ ì§€ì¶œì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤." }
          }
        },
        GOODS: ["ì‹ë£Œí’ˆ", "ê³µì˜ˆí’ˆ", "ê³µì—…í’ˆ", "ê·€ê¸ˆì†", "ë³´ì„"],
        BASE_PRICE: 10000,
        SPECIALTY_COST: {
            "ì‹ë£Œí’ˆ": 10000,
            "ê³µì—…í’ˆ": 15000,
            "ê³µì˜ˆí’ˆ": 20000,
            "ê·€ê¸ˆì†": 25000,
            "ë³´ì„": 30000
        },
        BASE_TAX: 0.1,
        MAX_TAX: 0.10,
        SPECIALTY_CHANCE: 0.50,
        SPECIALTY_PROFIT: 3.0,

        JOBS: {
            PIRATE: { 
                retireFee: 1000000, // ì€í‡´(ë©´ì£„ë¶€) ìˆ˜ìˆ˜ë£Œ
                jailTime: 10 * 60 * 1000, // íŒ¨ë°° ì‹œ ì§•ì—­ (10ë¶„)
Â  Â  Â  Â  Â  Â  Â  Â  pillageTime: 3 * 60 * 1000, // ì•½íƒˆ ì†Œìš” ì‹œê°„ (3ë¶„)
Â  Â  Â  Â  Â  Â  Â  Â  winCooldown: 2 * 60 * 1000, // ìŠ¹ë¦¬ ì‹œ ì¬ì •ë¹„ ì¿¨íƒ€ì„ (3ë¶„)
Â  Â  Â  Â  Â  Â  Â  Â  bailAmount: 50000, // ì„ë°© ë³´ì„ê¸ˆ (5ë§ŒP)
Â  Â  Â  Â  Â  Â  Â  Â  bountyBase: 50000, // ê¸°ë³¸ ì‹œì‘ í˜„ìƒê¸ˆ
Â  Â  Â  Â  Â  Â  Â  Â  bountyInc: 15000,Â  // ì•½íƒˆ ì„±ê³µë‹¹ í˜„ìƒê¸ˆ ì¦ê°€ì•¡
Â  Â  Â  Â  Â  Â  Â  Â  pillageRateMin: 0.3, // Lv.1 ê¸°ë³¸ ì•½íƒˆë¥  (30%)
Â  Â  Â  Â  Â  Â  Â  Â  pillageRateMax: 0.5  // Lv.10 ìµœëŒ€ ì•½íƒˆë¥  (50%)
            },
            NAVY: { 
                retireFee: 800000, // ì „ì—­ ìˆ˜ìˆ˜ë£Œ
                retreatTime: 5 * 60 * 1000, // íŒ¨ë°° ì‹œ í‡´ê° ì‹œê°„ (5ë¶„)
                maxDailyWage: 100000 // í•´êµ° ì¼ê¸‰ ìµœëŒ€ ìƒí•œ (10ë§ŒP)
            },
            ESCORT_FEE_RATE: 0.05,

            ESCORT_TAX: { // í’ˆëª©ë³„ ì›ê°€ ê¸°ì¤€ í˜¸ìœ„ ë³´í˜¸ì„¸ìœ¨
                "ì‹ë£Œí’ˆ": 0.03, "ê³µì—…í’ˆ": 0.05, "ê³µì˜ˆí’ˆ": 0.05, "ê·€ê¸ˆì†": 0.08, "ë³´ì„": 0.12 
            }
        }
     },

    /**
         * [ì‹ ê·œ] í’ˆëª©ë³„ ì°¨ë“± ìˆ˜ìµë¥  ë§¤íŠ¸ë¦­ìŠ¤
         * - ì„ í˜¸(pref): ì‹ë£Œí’ˆì€ ë†’ê²Œ(1.28), ë³´ì„ì€ ë‚®ê²Œ(1.19) ì„¤ì •í•˜ì—¬ ë°¸ëŸ°ìŠ¤ ì¡°ì •
         * - ì¼ë°˜(norm): ì„¸ê¸ˆ ê³ ë ¤ ì‹œ ì•½ì†Œí•œ ì´ë“ í˜¹ì€ ë³¸ì „ (1.05)
         * - ê¸°í”¼(hate): ê°•ë ¥í•œ ì†ì‹¤ ë¶€ì—¬ (0.8)
         */
        PROFIT_RATES: {
        "ì‹ë£Œí’ˆ": { pref: 1.15, norm: 1.05, hate: 0.8 }, 
        "ê³µì—…í’ˆ": { pref: 1.14, norm: 1.05, hate: 0.8 },
        "ê³µì˜ˆí’ˆ": { pref: 1.13, norm: 1.05, hate: 0.8 },
        "ê·€ê¸ˆì†": { pref: 1.12, norm: 1.05, hate: 0.8 },
        "ë³´ì„":   { pref: 1.11, norm: 1.05, hate: 0.8 } 
     },

    MANIPULATION: {
        DEFAULT_GAMBLE: 65, // í™€ì§(ì‚¬ë‹¤ë¦¬/ë°”ì¹´ë¼) ì ì¤‘ ë³´ì •ì¹˜
        DEFAULT_FISH: 40,   // ë‚šì‹œ ë†’ì€ ë“±ê¸‰ ë‚šì„ ë³´ì •ì¹˜
        DEFAULT_RACING: 5,  // ê²½ë§ˆ ìš°ìŠ¹ ê°€ì¤‘ì¹˜ ë³´ë„ˆìŠ¤
        DEFAULT_SPITTO: 65, // ìŠ¤í”¼ë˜ ë‹¹ì²¨ ë³´ì •ì¹˜
        MAX_RATE: 100,
        MIN_RATE: 0
    },

    ECO: {

        /* [v11.9.24] ë°°ë‹¹ ì£¼ë¨¸ë‹ˆ ì ë¦½ ë°°ìœ¨ (ì‚¬ìš©ì•ˆ) */
        ACTIVITY_ACCUM_RATES: {
            MINE: 0,
            FISH: 0,
            CASINO: 0,
            BANK: 0,
            SHOP: 0,
            RACING: 0
        },

        /* [Gemini ìš”ì²­ ì‚¬í•­] ì‹œê°„ ê¸°ë°˜ í™•ì • ë°°ë‹¹ ì‹œìŠ¤í…œ ì„¤ì • */
        HOURLY_DIVIDEND: 10000,           // ì‹œê°„ë‹¹ ê¸°ë³¸ ë°°ë‹¹ê¸ˆ (10,000P)
        DIVIDEND_BONUS_THRESHOLD: 10,     // ì§€ë¶„ ë³´ë„ˆìŠ¤ ì‹œì‘ ì„ê³„ê°’ (10ì§€ë¶„)
        DIVIDEND_BONUS_RATE: 0.1,         // ì´ˆê³¼ 1ì§€ë¶„ë‹¹ ê°€ì‚° ë°°ìœ¨ (10%)

        /* [ê¸°ì´ˆ ê²½ì œ ì„¤ì •] */
        ATTEND_MIN: 8000, // [ì¶œì„ ìµœì†Œ ì§€ê¸‰]: í•˜í•œì„  15,000P
        ATTEND_MAX: 10000, // [ì¶œì„ ìµœëŒ€ ì§€ê¸‰]: ìƒí•œì„  20,000P
        GAMBLE_MIN: 2000,  // [ë„ë°• ìµœì†Œ ë² íŒ…]: 2,000P
        GAMBLE_MAX: 50000, // [ë„ë°• ìµœëŒ€ ë² íŒ…]: 200,000P (ì‚¬í–‰ì„± ì–µì œ)

        /* [ì‹ ê·œ] ìŠ¤í”¼ë˜ ë° ìƒì‚°í˜• ì»¨í…ì¸  ì„¤ì • */
        SPITTO: {
            PRICE: 2000,           // ë³µê¶Œ ê°€ê²©
            RTP: 0.855,              // ê¸°ëŒ€ ìˆ˜ìµë¥  (85.5%)
            PROBS: {
                RANK1: 0.0005,     // 1ë“± í™•ë¥  (0.05%)
                RANK2: 0.02,       // 2ë“± í™•ë¥  (2%)
                RANK3: 0.15,       // 3ë“± í™•ë¥  (15%)
                RANK4: 0.55         // 4ë“± í™•ë¥  (55%)
            },
            PRIZES: {
                RANK1: 500000,     // 1ë“± ìƒê¸ˆ
                RANK2: 25000,      // 2ë“± ìƒê¸ˆ
                RANK3: 5000,       // 3ë“± ìƒê¸ˆ
                RANK4: 1000         // 4ë“± ìƒê¸ˆ
            }
        },
        FISHING: {
            COOLDOWN: 600000,      // ì¿¨íƒ€ì„ (10ë¶„ = 600,000ms)
            MIN_REWARD: 500,       // ìµœì†Œ ë³´ìƒ
            MAX_REWARD: 1500,       // ìµœëŒ€ ë³´ìƒ
            FAIL_PROB: 0.05,         // ê½ í™•ë¥  (5%)
            ARTIFACT_CHANCE: 0.005  // [ì‹ ê·œ] ìœ ë¬¼ ì¡°ê° ë°œê²¬ í™•ë¥  (0.5%)
        },
        
        /* [ì‹ ê·œ] ì¤‘ì•™ì€í–‰ ì§€ê¸‰ì¤€ë¹„ì œë„ ì„¤ì • */
        BANK: {
            RESERVE_RATIO: 0.20, // [ì§€ê¸‰ì¤€ë¹„ìœ¨]: ì€í–‰ ì´ ì˜ˆê¸ˆì•¡ ì¤‘ ëŒ€ì¶œí•´ì¤„ ìˆ˜ ì—†ëŠ” ìµœì†Œ í˜„ê¸ˆ ë³´ìœ  ë¹„ì¤‘ (20%)
            INITIAL_RESERVE: 10000, // [ì´ˆê¸° ì¬ì›]: ë°ì´í„° ì´ˆê¸°í™” ì‹œ ì€í–‰ ê¸ˆê³ ì— ê¸°ë³¸ìœ¼ë¡œ ë“¤ì–´ìˆëŠ” í¬ì¸íŠ¸
            INTEREST_RATE: 0.02,  // [ë§¤ì¼ ì´ììœ¨] 0.02 = 2%, 0.05 = 5% (ì›í•˜ì‹œëŠ” ìˆ˜ì¹˜ë¡œ ë³€ê²½í•˜ì„¸ìš”)
            /* [ì§€ëŠ¥í˜• íƒ„ë ¥ ê¸ˆë¦¬ ì„¤ì •] */
            MIN_MULTIPLIER: 0.5,  // ê¸ˆë¦¬ í•˜í•œ ìŠ¹ìˆ˜ (0.5ë°°)
            MAX_MULTIPLIER: 3.0,  // ê¸ˆë¦¬ ìƒí•œ ìŠ¹ìˆ˜ (3.0ë°°)
            TARGET_RESERVE_RATIO: 0.1 // ì ì • êµ­ê³  ìœ ì§€ ë¹„ìœ¨ (ê²½ì œ ê¸°ì¤€ì ì˜ 10%)
        },

        /* [ì‹ ê·œ] ê²½ë§ˆ ì‹œìŠ¤í…œ ì„¸ë¶€ ì„¤ì • ìƒìˆ  */
        RACING: {
            MIN_BET: 10000,       // [ìµœì†Œ ë°°íŒ…ì•¡]: ê²½ë§ˆ ì°¸ì—¬ë¥¼ ìœ„í•œ ìµœì†Œ í¬ì¸íŠ¸
            MAX_BET: 30000,      // [ìµœëŒ€ ë°°íŒ…ì•¡]: í•œ íšŒì°¨ì— ê±¸ ìˆ˜ ìˆëŠ” ìµœëŒ€ í¬ì¸íŠ¸ ìƒí•œì„ 
            TAX_RATE: 0.1,       // [ê¸°ë³¸ ìˆ˜ìˆ˜ë£Œ]: ë‹¹ì²¨ê¸ˆ ì •ì‚° ì „ ì „ì²´ íŒëˆì—ì„œ êµ­ê³ ë¡œ í™˜ìˆ˜ë˜ëŠ” ë¹„ìœ¨ (10%)
            CANCEL_FEE: 0.1,     // [ì·¨ì†Œ ìœ„ì•½ê¸ˆ]: ë°°íŒ… ì·¨ì†Œ ì‹œ ì›ê¸ˆì—ì„œ ì°¨ê°ë˜ì–´ êµ­ê³ ë¡œ ê·€ì†ë˜ëŠ” ìˆ˜ìˆ˜ë£Œ (10%)
            WINLESS_BANK_RATE: 0.3,   // [ë¬´ìŠ¹ì êµ­ê³ í–‰]: ìš°ìŠ¹ì ì—†ì„ ì‹œ íŒëˆì˜ 30%ë¥¼ ì€í–‰ ê¸ˆê³ ë¡œ ì¦‰ì‹œ íšŒìˆ˜
            WINLESS_JACKPOT_RATE: 0.7, // [ë¬´ìŠ¹ì ì´ì›”ì•¡]: ìš°ìŠ¹ì ì—†ì„ ì‹œ íŒëˆì˜ 70%ë¥¼ ë‹¤ìŒ íšŒì°¨ carryOverë¡œ ëˆ„ì 
            OPEN_HOUR: 9,        // ê²½ë§ˆì¥ ìë™ ê°œì¥ ì‹œê° (ì˜¤ì „ 9ì‹œ)
            CLOSE_HOUR: 23,       // ê²½ë§ˆì¥ ë§ˆì§€ë§‰ ë°°íŒ… ë§ˆê° ì‹œê° (ì˜¤í›„ 11ì‹œ 59ë¶„)
            MAX_PAYOUT_MULT: 7   // [ë°°ë‹¹ ê¸°ì¤€ì ]: ë‹¹ì²¨ ì‹œ ì§€ê¸‰ë˜ëŠ” ê³ ì • ë°°ìœ¨ (í˜„ì¬ 7ë°° ê³ ì • ì§€ê¸‰)
        },
        
        /* [ê°œí¸] ëœë“œë§ˆí¬ ë¶€ë™ì‚° ì‹œìŠ¤í…œ ì„¤ì • */
        LANDMARK: {
            PREFIXES: ["ì„œìš¸", "ë‰´ìš•", "íŒŒë¦¬", "ë„ì¿„", "ë‘ë°”ì´", "ëŸ°ë˜", "ë¡œë§ˆ", "ë² ë¥¼ë¦°", "ì‹œë“œë‹ˆ", "ê´‘í™”ë¬¸", "ê°•ë‚¨", "í•´ìš´ëŒ€", "íŒêµ", "ì„±ìˆ˜"], 
            SUFFIXES: ["ë¹Œë”©", "íƒ€ì›Œ", "ìŠ¤í€˜ì–´", "íŒ°ë¦¬ìŠ¤", "ì„¼í„°", "ì•„ë ˆë‚˜", "ë®¤ì§€ì—„", "íŒŒí¬", "ê°€ë“ ", "ì•„í‹€ë¦¬ì—", "ìŠ¤í…Œì´ì…˜", "ë¼ì´ë¸ŒëŸ¬ë¦¬"], 
            TRAITS: { 
                "normal": { label: "ëœë“œë§ˆí¬", volatility: 0.5, prob: 44, icon: "ğŸ¢" },
                "bluechip": { label: "ë¹„ì¦ˆë‹ˆìŠ¤íƒ€ì›Œ", volatility: 1, prob: 28, icon: "ğŸ¨" },
                "hotspot": { label: "ìƒê°€", volatility: 1.8, prob: 28, icon: "ğŸšï¸" }
            },

           /* [Gemini] ëœë“œë§ˆí¬ ê³ ì •ê°€ ë° ì§€ë¶„ ìƒìŠ¹ ì •ì±… */
Â  Â  Â  Â  Â  Â  FIXED_POLICY: {
Â  Â  Â  Â  Â  Â  Â  Â  BASE_PRICE: 200000,Â  Â // 0ì§€ë¶„ ê¸°ì¤€ ê¸°ë³¸ê°€
Â  Â  Â  Â  Â  Â  Â  Â  PER_SHARE_RATE: 0.05Â  // 1ì§€ë¶„ë‹¹ ìƒìŠ¹ë¥  (5%)
Â  Â  Â  Â  Â  Â  },

            MANIPULATION: { 
                TARGET: "ì„œìš¸íƒ€ì›Œ", 
                IS_UP: true,       
                RATE: 0.25,        
                ACTIVE: false      
            },
            SETTINGS: { 
                MAX_COUNT: 10,     // ë¶€ë™ì‚° ë§¤ë¬¼ ìµœëŒ€ìˆ˜
                OPEN_HOUR: 7,      
                CLOSE_HOUR: 23,    
                MANI_RATE: 0.25,   
                DELIST_LIMIT: 0.001, // ê²½ë§¤(ìƒí) ìœ„ê¸° ê¸°ì¤€
                ABS_DELIST_LIMIT: 10000, 
                CLOSING_LIMIT: 0.40, 
                RESISTANCE_START: 0.20, 
                GRAVITY: 0.18      
            }
        },

        MINE: { // [ê´‘ì‚° ì±„êµ´ ì„¤ì •]
            BASE_PER_MIN: 100, // ë¶„ë‹¹ íšë“í•˜ëŠ” ê¸°ë³¸ ì±„êµ´ í¬ì¸íŠ¸ (ë¬¼ê°€ ë°°ìœ¨ ì ìš© ì „)
            COPPER_PROB: 0.06, // êµ¬ë¦¬ ë°œê²¬ í™•ë¥  (6%)
            GOLD_PROB: 0.035,   // ê¸ˆ ë°œê²¬ í™•ë¥  (3.5%)
            DIA_PROB: 0.008,   // ë‹¤ì´ì•„ëª¬ë“œ ë°œê²¬ í™•ë¥  (0.8%)
            COPPER_MULT: 5.0,  // êµ¬ë¦¬ ë°œê²¬ ì‹œ ìˆ˜ìµ ë°°ìœ¨
            GOLD_MULT: 10.0,    // ê¸ˆ ë°œê²¬ ì‹œ ìˆ˜ìµ ë°°ìœ¨
            DIA_MULT: 25.0,    // ë‹¤ì´ì•„ëª¬ë“œ ë°œê²¬ ì‹œ ìˆ˜ìµ ë°°ìœ¨
            ARTIFACT_CHANCE: 0.002, // [ìœ ë¬¼ ì¡°ê°]: ë§¤ ë¶„ë§ˆë‹¤ ìœ ë¬¼ì„ ì°¾ì„ í™•ë¥  (0.1%)
            ARTIFACT_GOAL: 50  // [ë„êµ´ì™• ì¹­í˜¸]: ìœ ë¬¼ ì¡°ê°ì„ ì´ ê°¯ìˆ˜ë§Œí¼ ëª¨ìœ¼ë©´ ìë™ ë¶€ì—¬
        },
        PRIVATE_LOAN: { // [ì‚¬ì±„(P2P) ì‹œì¥ ì„¤ì •]
            MIN_AMOUNT: 10000,       // ì‚¬ì±„ ë§¤ë¬¼ ë“±ë¡ ì‹œ ìµœì†Œ ë‹¨ìœ„
            MAX_RATE: 15,           // ë²•ì • ìµœê³  ì´ìœ¨ (3ì‹œê°„ë‹¹ ìµœëŒ€ 15%)
            COLLECTION_LIMIT: 24,   // [ì¶”ì‹¬ ì‹œì‘]: ëŒ€ì¶œ í›„ 24ì‹œê°„ ê²½ê³¼ ì‹œ ìˆ˜ìµ ì••ë¥˜(50%) ì‹œì‘
            INTEREST_PERIOD: 3,     // ì´ìê°€ ë³µë¦¬ë¡œ ê³„ì‚°ë˜ì–´ ë¶™ëŠ” ì£¼ê¸° (3ì‹œê°„)
            MIN_BORROW: 5000,       // ìœ ì €ê°€ ì‚¬ì±„ë¥¼ ë¹Œë¦´ ë•Œ ìµœì†Œ ë‹¨ìœ„
            DAILY_LIMIT: 1          // ì€í–‰ ëŒ€ì¶œ ì¼ì¼ ì´ìš© ì œí•œ íšŸìˆ˜
        },
        CREDIT: { // [ì€í–‰ ì‹ ìš© ë“±ê¸‰ ì²´ê³„]
            SCORES: [900, 800, 700, 600, 500], // ê° ë“±ê¸‰ì„ ë‚˜ëˆ„ëŠ” ê¸°ì¤€ ì ìˆ˜
            LIMITS: [1000000, 800000, 600000, 500000, 400000, 300000], // ë“±ê¸‰ë³„ ëŒ€ì¶œ ê°€ëŠ¥ í•œë„
            RATES: [1.014, 1.025, 1.05, 1.09, 1.14, 1.18], // ë“±ê¸‰ë³„ ê¸°ë³¸ ì´ìœ¨ (ì‹œì¥ ìŠ¹ìˆ˜ì™€ ì—°ë™ë˜ì–´ ìµœì¢… ì‚°ì¶œë¨)
            LABELS: ["1ë“±ê¸‰", "2ë“±ê¸‰", "3ë“±ê¸‰", "4ë“±ê¸‰", "5ë“±ê¸‰", "ì‹ ìš©ë¶ˆëŸ‰ì"], 
            ICONS: ["ğŸ‘‘", "ğŸ’", "ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰", "ğŸš«"] 
        }
    },

BACKUP: {
        // ì—¬ê¸°ì— ë³¸ì¸ì˜ ë””ìŠ¤ì½”ë“œ ì›¹í›„í¬ URLì„ ì…ë ¥í•˜ì„¸ìš”. (ë”°ì˜´í‘œ í•„ìˆ˜)
        DISCORD_WEBHOOK_URL: "https://discord.com/api/webhooks/1466005811594793000/LUVyScCaI88gKz4SxMUSOniTi890hRNVGvGn1SC_FoNhYU5Vy7bZD9PpjSF0mQHRUMUq"
    },

    SPAM: { // [ë„ë°° ë°©ì§€ ì—”ì§„ ì„¤ì •]
        LIMIT_COUNT: 5,        // ì œí•œ ì‹œê°„ ë‚´ í—ˆìš©ë˜ëŠ” ìµœëŒ€ ë©”ì‹œì§€ ìˆ˜
        LIMIT_WINDOW: 3000,    // ë„ë°° íŒì • ì‹œê°„ ë²”ìœ„ (3000ms = 3ì´ˆ)
        TIMEOUT_MS: 300000     // ë„ë°° ì ë°œ ì‹œ ë´‡ ì´ìš©ì´ ì œí•œë˜ëŠ” ì‹œê°„ (5ë¶„)
    },

    PROB: { // [í•µì‹¬ ê²Œì„ í™•ë¥  ì—”ì§„]
        ODD_EVEN_WIN: 0.47,        // í™€ì§ ê¸°ë³¸ ìŠ¹ë¥  (45%)
        ODD_EVEN_PAYOUT: 0.90,     // í™€ì§ ê¸°ë³¸ ë°°ë‹¹ë¥  (ì‚¬ìš©ì ì •ì˜)
        ODD_EVEN_FEVER: 0.50,      // í”¼ë²„íƒ€ì„ ì‹œ í™€ì§ ê¸°ë³¸ ìŠ¹ë¥  (50%)
        STOCK_NEW_LISTING: 0.8,    // ë§¤ ë³€ë™ íƒ€ì„ë§ˆë‹¤ ì‹ ê·œ ì¢…ëª©ì´ ìƒì¥ë  í™•ë¥  (50%)
        STOCK_SPECIAL: 0.5,        // íŠ¹ì • ì¢…ëª©ì— íŠ¹ìˆ˜ ì´ë²¤íŠ¸(í­ë“±/í­ë½)ê°€ ë°œìƒí•  í™•ë¥  (50%)
        STOCK_UP_CHANCE: 0.45      // íŠ¹ìˆ˜ ì´ë²¤íŠ¸ ë°œìƒ ì‹œ 'ìƒìŠ¹'ì¼ í™•ë¥  (45%, í•˜ë½ì´ ì¡°ê¸ˆ ë” ë†’ìŒ)
    },
    
    MSG: { // [ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì„¤ì •]
        PREFIX: {
            INFO: "â„¹ï¸", ERROR: "ğŸš«", ADMIN: "âš™ï¸", SUCCESS: "âœ…", 
            WARN: "âš ï¸", GAMBLE_WIN: "ğŸŠ", GAMBLE_LOSE: "ğŸ’€", LOAN: "ğŸš¬", MINE: "â›ï¸", TIMEOUT: "ğŸ”‡"
        }, 
        ERR_FORM: "í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.", 
        ERR_MONEY: "í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.", 
        ERR_USER: "ëŒ€ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", 
        ERR_TIMEOUT: "ë„ë°°ë¡œ ì¸í•´ ì´ìš©ì´ ì¼ì‹œ ì œí•œë˜ì—ˆìŠµë‹ˆë‹¤." 
        },

    /* [v10.7] ì¹´ì§€ë…¸ ì§€ëŠ¥í˜• í™•ë¥  ë³´ì • ì •ë°€ ì„¸íŒ… */
    ADJUST: {
            ENABLED: true,
            STEP_AMOUNT: 300000,  // 30ë§ŒP ë‹¨ìœ„
            STEP_RATE: 0.01,      // ë‹¨ìœ„ë‹¹ -1%
            PROB_FLOOR: 0.35      // ìµœì†Œ ìŠ¹ë¥  í•˜í•œì„  (35%)
        },

    /* í†µí•© ì¹´ì§€ë…¸ ì‹œìŠ¤í…œ ìƒì„¸ ì„¤ì • */
    CASINO: {
        LADDER: { 
            INTERVAL_SEC: 120,
            PAYOUT_SINGLE: 1.9,
            PAYOUT_COMB: 4.0,
            MIN_BET: 2000,   // [ìˆ˜ì •ìœ„ì¹˜] ì‚¬ë‹¤ë¦¬ ìµœì†Œ ë°°íŒ…ì•¡
            LIMIT: 200000    // [ìˆ˜ì •ìœ„ì¹˜] ì‚¬ë‹¤ë¦¬ ìµœëŒ€ ë°°íŒ…ì•¡
        },
        BACCARAT: { 
            INTERVAL_SEC: 180,
            PAYOUT: { PLAYER: 2.0, BANKER: 1.95, TIE: 8.0 },
            MIN_BET: 2000,  // [ìˆ˜ì •ìœ„ì¹˜] ë°”ì¹´ë¼ ìµœì†Œ ë°°íŒ…ì•¡
            LIMIT: 200000   // [ìˆ˜ì •ìœ„ì¹˜] ë°”ì¹´ë¼ ìµœëŒ€ ë°°íŒ…ì•¡
        },
        BLACKJACK: {
            MIN_BET: 2000,        // ë¸”ë™ì­ ìµœì†Œ ë°°íŒ…
            LIMIT: 500000         // ë¸”ë™ì­ ìµœëŒ€ ë°°íŒ…
        }
    }
};

//==========ì„¹í„°2==========

/**
 * [v8.1 ê°œí¸] ë¸”ë™ë°•ìŠ¤ ë³µêµ¬ ì—”ì§„ (Smart Replay Option 2)
 * ê¸°ëŠ¥: ìë³¸ê¸ˆ ëŒ€ë¹„ ìˆ˜ìµ í•„í„°ë§ ë¡œì§ì„ ë„ì…í•˜ì—¬ ë³´ë„ˆìŠ¤ ë ˆë²„ë¦¬ì§€ë¥¼ ì´ìš©í•œ ë¶€ë‹¹ ìˆ˜ìµì„ ì°¨ë‹¨í•©ë‹ˆë‹¤.
 * [Gemini ìš”ì²­ ì‚¬í•­ ë°˜ì˜]: ì‚¬ìœ (Reason) í•„í„°ë§ ì‹œìŠ¤í…œ ì™„ë²½ í†µí•©
 */
function recoverFromJournal(data) {
    try {
        var journalFile = new java.io.File(JOURNAL_PATH);
        if (!journalFile.exists() || journalFile.length() === 0) return;

        var rawLogs = FileStream.read(JOURNAL_PATH);
        FileStream.write(JOURNAL_PATH, ""); 

        var logs = rawLogs.split("\n");
        var recoveryCount = 0;
        var skipCount = 0;
        var taintedUsers = {}; // ìë³¸ê¸ˆ í•œë„ë¥¼ ì´ˆê³¼í•˜ì—¬ ë² íŒ…í•œ ìœ ì € íƒœê·¸ ëª©ë¡

        logs.forEach(function(line) {
            if (!line.trim()) return;
            var parts = line.split("|"); 
            // [êµì •]: ì‚¬ìœ ê°€ í¬í•¨ëœ 5ê°œ í•­ëª©ì´ ëª¨ë‘ ìˆëŠ”ì§€ í™•ì¸
            if (parts.length < 5) return;

            var uid = parts[0];
            var room = parts[1];
            var delta = Number(parts[2]);
            var brDelta = Number(parts[3] || 0);
            var reason = parts[4] || ""; 

            if (data.rooms[room] && data.rooms[room].users[uid] && !isNaN(delta)) {
                var user = data.rooms[room].users[uid];

                // [í•„í„° 1]: ì…ì¥ ë³´ë„ˆìŠ¤ ê¸°ë¡ì€ í•©ì‚°ì—ì„œ ì œì™¸ (ì¤‘ë³µ ì§€ê¸‰ ë°©ì§€)
                if (reason.indexOf("ì…ì¥ ì¶•í•˜") !== -1) {
                    skipCount++;
                    return;
                }

                // [í•„í„° 2]: ìë³¸ê¸ˆ í•œë„ ì´ˆê³¼ ë² íŒ… ê°ì§€ (ì˜µì…˜ 2 ë…¼ë¦¬)
                if (delta < 0 && Math.abs(delta) > Number(user.point)) {
                    taintedUsers[uid] = true;
                    return;
                }

                // [í•„í„° 3]: íƒœê·¸ëœ ìœ ì €ì˜ ìˆ˜ìµ(+) ê¸°ë¡ ë¬´íš¨í™”
                if (taintedUsers[uid] && delta > 0) {
                    skipCount++;
                    return;
                }

                // [ìµœì¢… ë°˜ì˜]: í•„í„°ë¥¼ í†µê³¼í•œ ì •ë‹¹í•œ ë°ì´í„°ë§Œ í•©ì‚° (0ì› í•˜í•œì„  ê°•ì œ ì ìš©)
                user.point = Math.max(0, Number(user.point || 0) + delta);
                data.rooms[room].bankReserve = Number(data.rooms[room].bankReserve || 0) + brDelta;
                recoveryCount++;
            }
        });

        if (recoveryCount > 0 || skipCount > 0) {
            // 1. ê¸°ë¡ ë³´ì¡´ (íˆìŠ¤í† ë¦¬ ì´ê´€)
            var rawLogs = FileStream.read(JOURNAL_PATH);
            FileStream.append(BASE_DIR + "total_history.log", rawLogs);

            // 2. ë¬¼ë¦¬ íŒŒì¼ ì¦‰ì‹œ í™•ì • ì €ì¥
            safeSaveData(data, true); 

            // 3. [ì¤‘ìš”] ì•Œë¦¼ ì „ íŒŒì¼ ì‚­ì œ (ë„ë°° ë°©ì§€ í•µì‹¬)
            var jFile = new java.io.File(JOURNAL_PATH);
            if (jFile.exists()) jFile.delete();

            // 4. í‘œì¤€ ë³´ì•ˆ UI ë©”ì‹œì§€ ì¡°ë¦½
            var recoverBody = "âœ… ë‚´ìš©: ë¸”ë™ë°•ìŠ¤ ë¡œê·¸ ì •ë°€ ë³µêµ¬ ì™„ë£Œ\n" +
                              "ğŸ“Š ì²˜ë¦¬: " + recoveryCount + "ê±´ ë³µêµ¬ / " + skipCount + "ê±´ í•„í„°ë§\n" +
                              "ğŸ“„ ì†ŒìŠ¤: " + JOURNAL_PATH;

            var recoverMsg = util_formatSecurityLog(
                "ğŸ›¡ï¸ [RECOVERY: ë¸”ë™ë°•ìŠ¤ ì—”ì§„ ê°€ë™]", 
                "JOURNAL_REPLAY", 
                "SYSTEM", 
                recoverBody, 
                "ë©”ëª¨ë¦¬ ë™ê¸°í™” ë° ë³µêµ¬ ë¡œê·¸ ë¬¼ë¦¬ì  íŒŒê¸° ì™„ë£Œ"
            );

            // 5. ê²°ê³¼ ë³´ê³  (ë„ë°°ê°€ ë°œìƒí•˜ì§€ ì•ŠìŒ)
            Log.info("[Recovery] " + recoveryCount + "ê±´ ë³µêµ¬ ì™„ë£Œ");
            try { Api.replyRoom("ë² ë¦­ë°©", recoverMsg); } catch(e) {}
        }
    } catch (e) {
        Log.error("Journal Recovery Error: " + e);
    }
}

/**
 * [v11.9.3 ìµœì¢…í˜•] ë‚ ì§œ í•„í„°ë§ ê¸°ë°˜ ë°°ë‹¹ ì£¼ë¨¸ë‹ˆ ì •ë°€ ì¬ê³„ì‚° ì—”ì§„
 * ê¸°ëŠ¥: ë¸”ë™ë°•ìŠ¤ ë¡œê·¸ ì¤‘ 'ì˜¤ëŠ˜' ë°œìƒí•œ ì‹¤ì œ í™œë™ ìˆ˜ìµë§Œ ì¶”ì¶œí•˜ì—¬ ì£¼ë¨¸ë‹ˆë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤.
 */
function util_recalculateDailyPools(data, roomName) {
    try {
        var logFile = new java.io.File(JOURNAL_PATH);
        if (!logFile.exists() || logFile.length() === 0) return;

        var logs = FileStream.read(JOURNAL_PATH).split("\n");
        var roomObj = data.rooms[roomName];
        var cfg = SYSTEM_CONFIG.ECO.ACTIVITY_ACCUM_RATES;
        
        // ì˜¤ëŠ˜ ë‚ ì§œ ë¬¸ìì—´ (ë¡œê·¸ì˜ ì‹œê°„ ì •ë³´ì™€ ëŒ€ì¡°ìš©)
        var todayPrefix = new Date().toLocaleDateString(); 

        // 1. ê¸°ì¡´ ì˜¤ì—¼ëœ ì£¼ë¨¸ë‹ˆ ì´ˆê¸°í™”
        roomObj.features.dailyPools = { mine: 0, fish: 0, casino: 0, bank: 0, shop: 0, race: 0 };

        logs.forEach(function(line) {
            if (!line.trim()) return;
            var parts = line.split("|");
            // [êµì •] ë¡œê·¸ì— ê¸°ë¡ëœ ë°© ì´ë¦„ì´ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
            if (parts.length < 5 || parts[1] !== roomName) return;

            var amount = Math.abs(Number(parts[2])); 
            var reason = parts[4]; 

            // 1. ì¹´ì§€ë…¸ ë°°ë‹¹ê¸ˆ ì§‘ê³„ (ì›ê¸ˆ ëˆ„ì  ë°©ì‹ìœ¼ë¡œ í†µì¼)
            if (reason.indexOf("í™€ì§ ì ì¤‘") !== -1) {
                var originalBet = amount / 0.85; 
                var houseCommission = originalBet * 0.15; 
                roomObj.features.dailyPools.casino += Math.floor(houseCommission);
            }
            else if (reason.indexOf("í™€ì§ ë¯¸ì ì¤‘") !== -1) {
                roomObj.features.dailyPools.casino += amount;
            }
            // 2. ê¸°íƒ€ í™œë™ ì§‘ê³„ (cfg ì°¸ì¡° ì œê±°)
            else if (reason.indexOf("ê´‘ì‚°") !== -1) roomObj.features.dailyPools.mine += amount;
            else if (reason.indexOf("ë‚šì‹œ ë³´ìƒ") !== -1) roomObj.features.dailyPools.fish += amount;
            else if (reason.indexOf("ì´ì ì§€ê¸‰") !== -1) roomObj.features.dailyPools.bank += amount;
            else if (reason.indexOf("ìƒì  êµ¬ë§¤") !== -1) roomObj.features.dailyPools.shop += amount;
            else if (reason.indexOf("ê²½ë§ˆ ë°°íŒ…") !== -1) roomObj.features.dailyPools.race += amount;
        });
        
    } catch (e) {
        Log.error("Recalculate DailyPools Error: " + e);
    }
}

/**
 * [v11.9.16 ìµœì¢…ì•ˆ] ì˜¤ëŠ˜ì¹˜ ë°±ì—… ë¡œê·¸ ì†Œê¸‰ í•©ì‚° ì—”ì§„ (Date Filtering)
 * ê¸°ëŠ¥: ë¡œì§ ë³€ê²½ ì „ ë°±ì—…ëœ 'ì˜¤ëŠ˜ì˜ ë¡œê·¸'ë¥¼ ë¶„ì„í•˜ì—¬ ë©”ëª¨ë¦¬ ì£¼ë¨¸ë‹ˆë¥¼ ë³µêµ¬í•©ë‹ˆë‹¤.
 */
function util_restoreDailyPoolsFromHistory(data, roomName) {
    try {
        var historyPath = BASE_DIR + "total_history.log";
        var hFile = new java.io.File(historyPath);
        if (!hFile.exists() || hFile.length() === 0) return 0;

        var logs = FileStream.read(historyPath).split("\n");
        var roomObj = data.rooms[roomName];
        var cfg = SYSTEM_CONFIG.ECO.ACTIVITY_ACCUM_RATES;
        var restoredCount = 0;

        // [í•µì‹¬] ì˜¤ëŠ˜ ë‚ ì§œ í•„í„° (ì˜ˆ: "2026. 2. 4.")
        var todayStr = new Date().toLocaleDateString();

        logs.forEach(function(line) {
            if (!line.trim()) return;
            var p = line.split("|");
            // í˜•ì‹ì´ ë§ì§€ ì•Šê±°ë‚˜, ë‹¤ë¥¸ ë°©ì˜ ê¸°ë¡ì´ê±°ë‚˜, ì˜¤ëŠ˜ ë‚ ì§œê°€ ì•„ë‹ˆë©´ í†µê³¼
            // (ì°¸ì¡°: ë¡œê·¸ê°€ ë¹„ì›Œì§ˆ ë•Œ ì°íŒ ì‹œìŠ¤í…œ ë‚ ì§œ ì •ë³´ê°€ ìˆëŠ” ê²½ìš°ë§Œ í•©ì‚°)
            if (p.length < 5 || p[1] !== roomName) return;
            
            // ë§Œì•½ ë¡œê·¸ì— ë‚ ì§œ ì •ë³´ê°€ ì—†ë‹¤ë©´ ì˜¤ëŠ˜ ë°œìƒí•œ ëª¨ë“  ë¡œê·¸ë¥¼ ì½ìœ¼ë¯€ë¡œ 
            // 00ì‹œ ì •ì‚° ì§í›„ì— í•œ ë²ˆë§Œ ì‹¤í–‰í•˜ëŠ” ê²ƒì´ ê°€ì¥ ì•ˆì „í•©ë‹ˆë‹¤.
            
            var amt = Math.abs(Number(p[2]));
            var reason = p[4];

            if (reason.indexOf("ê´‘ì‚°") !== -1) roomObj.features.dailyPools.mine += Math.floor(amt * cfg.MINE);
            else if (reason.indexOf("ë‚šì‹œ") !== -1) roomObj.features.dailyPools.fish += Math.floor(amt * cfg.FISH);
            // ê³¼ê±° ë¡œê·¸ì— ì°íŒ 'í™€ì§'ì´ë‚˜ 'ì ì¤‘' í‚¤ì›Œë“œê¹Œì§€ ì‹¹ ê¸ì–´ëª¨ìë‹ˆë‹¤.
            else if (reason.indexOf("ì¹´ì§€ë…¸") !== -1 || reason.indexOf("ì‚¬ë‹¤ë¦¬") !== -1 || reason.indexOf("ë°”ì¹´ë¼") !== -1 || reason.indexOf("í™€ì§") !== -1 || reason.indexOf("ì ì¤‘") !== -1) {
                roomObj.features.dailyPools.casino += Math.floor(amt * cfg.CASINO);
            }
            else if (reason.indexOf("ì´ì") !== -1) roomObj.features.dailyPools.bank += Math.floor(amt * cfg.BANK);
            else if (reason.indexOf("ìƒì ") !== -1 || reason.indexOf("êµ¬ë§¤") !== -1) roomObj.features.dailyPools.shop += Math.floor(amt * cfg.SHOP);
            else if (reason.indexOf("ê²½ë§ˆ") !== -1) roomObj.features.dailyPools.race += Math.floor(amt * cfg.RACING);
            
            restoredCount++;
        });
        return restoredCount;
    } catch (e) {
        Log.error("History Restoration Error: " + e);
        return 0;
    }
}

/**
 * [Gemini ì •ë°€ êµì •] ë°ì´í„°ë² ì´ìŠ¤ ë¡œë“œ í•¨ìˆ˜
 */
/**
 * [v12.5 ìµœì¢…í˜•] ë°ì´í„°ë² ì´ìŠ¤ ë¡œë“œ ë° ìœ í•´ ê°ì²´(SessionCacheReplier) ì „ìˆ˜ ì†Œê° ì—”ì§„
 * ê¸°ëŠ¥: ì¥ë¶€ë¥¼ ì½ì–´ì˜¬ ë•Œ ìœ ì € ë°ì´í„°ì— ë°•ì œëœ ìë°” ê°ì²´ë¥¼ íƒì§€í•˜ì—¬ ì¦‰ì‹œ ì œê±°í•¨ìœ¼ë¡œì¨ ì•± í¬ë˜ì‹œë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.
 */
function getDatabase() {
    if (globalData && globalData._isInitialized === true) {
        return globalData;
    }

    var isAcquired = false;
    try {
        isAcquired = lock.tryLock(1000, java.util.concurrent.TimeUnit.MILLISECONDS);
        if (!isAcquired) {
            Log.warn("âš ï¸ ë°ì´í„°ë² ì´ìŠ¤ê°€ í˜„ì¬ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ì¬ì‹œë„í•©ë‹ˆë‹¤.");
            return globalData;
        }

        var file = new java.io.File(FILE_PATH);
        var initialData;
        
        if (!file.exists()) {
            initialData = {
                rooms: {}, admins: ["ê´€ë¦¬ì"], botActive: true,
                nickHistory: {}, adminLogs: [], economyDamping: 0.5,
                lastDailyReset: "", isRecovering: false, nameToIdCache: {}
            };
        } else {
            var content = FileStream.read(FILE_PATH);
            if (!content) throw new Error("Empty File");
            initialData = JSON.parse(content);
        }

        recoverFromJournal(initialData);

        (function util_autoRepairTradeStuck(data) {
            if (!data || !data.rooms) return;
            for (var r in data.rooms) {
                var users = data.rooms[r].users;
                if (!users) continue;
                for (var id in users) {
                    var u = users[id];
                    if (u.voyage && u.voyage.active === true && u.voyage.isProcessing === true) {
                        u.voyage.isProcessing = false;
                        u.voyage.isAlerted = false;
                    }
                }
            }
        })(initialData);
        
        if (initialData.rooms) {
            for (var rName in initialData.rooms) {
                var targetRoom = initialData.rooms[rName];
                if (!targetRoom.features) {
                    targetRoom.features = (typeof ROOM_FEATURE_TEMPLATE === 'function') ? ROOM_FEATURE_TEMPLATE() : {};
                } else {
                    var template = (typeof ROOM_FEATURE_TEMPLATE === 'function') ? ROOM_FEATURE_TEMPLATE() : {};
                    if (!targetRoom.features.racing) targetRoom.features.racing = template.racing;
                    if (!targetRoom.features.lotto) targetRoom.features.lotto = template.lotto;
                    if (!targetRoom.features.stockMarket) targetRoom.features.stockMarket = template.stockMarket;
                    if (!targetRoom.features.portData) targetRoom.features.portData = template.portData;
                    if (!targetRoom.features.states) {
                        targetRoom.features.states = template.states;
                    } else {
                        var s = targetRoom.features.states;
                        var ts = template.states;
                        for (var key in ts) {
                            if (!s[key] || typeof s[key] !== 'object') s[key] = {};
                        }
                    }
                }
                if (!targetRoom.loanPools) targetRoom.loanPools = {};
                if (!targetRoom.loanContracts) targetRoom.loanContracts = {};
                if (targetRoom.bankReserve === undefined) targetRoom.bankReserve = 10000;
            }
        }
        
        if (!initialData.nameToIdCache) initialData.nameToIdCache = {};
        initialData._isInitialized = true;
        globalData = initialData;
        return globalData;

    } catch (e) {
        Log.error("DB Load Error: " + e);
        var stableFile = new java.io.File(BACKUP_DIR + "last_stable_backup.json");
        if (stableFile.exists()) {
            globalData = JSON.parse(FileStream.read(BACKUP_DIR + "last_stable_backup.json"));
            if (globalData) {
                if (typeof util_scrubNativeObject === 'function') {
                    util_scrubNativeObject(globalData);
                    Log.warn("ğŸ›¡ï¸ [Recovery] ë°±ì—… ë°ì´í„° ì •ë°€ ê²€ì—­ ë° ë³µêµ¬ ì™„ë£Œ");
                }
                globalData._isInitialized = true;
                return globalData;
            }
            return globalData;
        }
        return null;
    } finally {
        if (isAcquired) {
            lock.unlock();
        }
    }
}

/* ë¡œì§ ì¶”ì  ì‹œì‘ */
function startTracking(user, commandName) {
    if (!user) return;
    user.lastAction = { cmd: commandName, status: "PENDING", time: Date.now(), msg: "ìˆ˜í–‰ ì‹œì‘" };
}

/**
 * [v8.1 ì—…ê·¸ë ˆì´ë“œ] í¬ì¸íŠ¸ ë³€ë™ ê²€ì¦ ë° ì‚¬ìœ  í¬í•¨ ë¸”ë™ë°•ìŠ¤ ê¸°ë¡
 * [êµì •]: ë¡œê·¸ í•œ ì¤„ì— reasonì„ ë°˜ë“œì‹œ í¬í•¨í•˜ì—¬ ì €ì¥í•©ë‹ˆë‹¤.
 */
function verifyPointTransaction(user, prePoint, changeAmount, reason, roomName, brDelta) {
    try {
        var expected = Number(prePoint) + Number(changeAmount);
        var actual = Number(user.point);
        
        if (actual !== expected) {
            var errorMsg = "[" + new Date().toLocaleString() + "] [ë¶ˆì¼ì¹˜] " + (user.name||"") + ": " + reason + " (ì˜ˆìƒ:" + fp(expected) + "/ì‹¤ì œ:" + fp(actual) + ")\n";
            FileStream.append(ERROR_LOG_PATH, errorMsg);
            // [ê°œë³„ ìœ ì € ë¡¤ë°±]: ì—°ì‚° ì˜¤ë¥˜ ê°ì§€ ì‹œ í•´ë‹¹ ìœ ì €ì˜ ë°ì´í„°ë§Œ ì•ˆì „ ì§€ì ìœ¼ë¡œ ë˜ëŒë¦¼
            var db = getDatabase();
            var safeUser = null;
            for (var r in db.rooms) { 
                if (db.rooms[r].users[user.uid]) { 
                    safeUser = db.rooms[r].users[user.uid]; 
                    break; 
                } 
            }
            
            if (safeUser) {
                var roomData = db.rooms[roomName || "ë‚´ë¦¬ë‹¤"];
                if (roomData) {
                    // ë¬¸ì œê°€ ëœ ìœ ì € ê°ì²´ë§Œ ë°±ì—…ë³¸ìœ¼ë¡œ í†µì§¸ë¡œ êµì²´ (ì „ì²´ ë¡¤ë°±)
                    roomData.users[user.uid] = JSON.parse(JSON.stringify(safeUser)); 
                }
            }
            
            var errorBody = "âŒ ì‚¬ìœ : í¬ì¸íŠ¸ ì—°ì‚° ë¶ˆì¼ì¹˜ (ë°ì´í„° ì˜¤ì—¼ ìœ„í—˜)\n" +
                            "ğŸ“Š ìˆ˜ì¹˜: ì˜ˆìƒ " + fp(expected) + "P / ì‹¤ì œ " + fp(actual) + "P\n" +
                            "ğŸ“‰ í•­ëª©: " + reason;

            var rollbackMsg = util_formatSecurityLog(
                "ğŸ›¡ï¸ [INTEGRITY: ë°ì´í„° ë¬´ê²°ì„± ê°€ë“œ]", 
                user.name, 
                (roomName || "ë‚´ë¦¬ë‹¤"), 
                errorBody, 
                "í•´ë‹¹ ìœ ì € ë°ì´í„°ë¥¼ ì•ˆì „ ì„¸ì´ë¸Œ ì§€ì ìœ¼ë¡œ ì¦‰ì‹œ ë¡¤ë°± ì™„ë£Œ"
            );

            try { Api.replyRoom(roomName || "ë‚´ë¦¬ë‹¤", rollbackMsg); } catch(e){}
            try { Api.replyRoom("ë² ë¦­ë°©", rollbackMsg); } catch(e){}
            
            user.lastAction = { cmd: reason, status: "FAIL", amount: changeAmount, time: Date.now(), msg: "ë°ì´í„° ë¶ˆì¼ì¹˜ ë° ë¡¤ë°±" };
        } else {
            if (roomName) {
                logLock.lock();
                try {
                    // [v13.8] ì •ë°€ íƒ€ì„ë¼ì¸ ë³µêµ¬ë¥¼ ìœ„í•´ 1ì—´ì— Date.now()ë¥¼ ì¶”ê°€í•œ 6ì—´ êµ¬ì¡°ë¡œ í™•ì¥
                    // í¬ë§·: ì‹œê°„|UID|ë°©ì´ë¦„|ë³€ë™ì•¡|êµ­ê³ ë³€ë™|ì‚¬ìœ 
                    var journalEntry = Date.now() + "|" + user.uid + "|" + roomName + "|" + changeAmount + "|" + (brDelta || 0) + "|" + reason + "\n";
                    FileStream.append(JOURNAL_PATH, journalEntry);
                } finally {
                    logLock.unlock();
                }
            }
            if (user.lastAction && user.lastAction.status !== "FAIL") {
                user.lastAction = { cmd: reason, status: "SUCCESS", amount: changeAmount, time: Date.now(), msg: "ì •ìƒ ì™„ë£Œ" };
            }
        }
    } catch(e) { 
        FileStream.append(ERROR_LOG_PATH, "ê²€ì¦ì˜¤ë¥˜: " + e + "\n"); 
    }
}

/* ë¡œì§ ì¶”ì  ì¢…ë£Œ */
function endTracking(user, isSuccess, resultMsg) {
    if (!user || !user.lastAction) return;
    if (user.lastAction.status === "FAIL") return; 
    user.lastAction.status = isSuccess ? "SUCCESS" : "CRASH";
    user.lastAction.msg = resultMsg;
    user.lastAction.endTime = Date.now();
}

//==========ì„¹í„°3==========

/* [ìµœì í™”] í•˜ì´ë¸Œë¦¬ë“œ ë¹„ë™ê¸° ì˜ì†í™”(Asynchronous Persistence) ì—”ì§„ v7.0 (Multi-Gen Backup) */
/**
 * @param {Object} data - ì €ì¥í•  ë°ì´í„° ê°ì²´
 * @param {Boolean} isForceBackup - trueì¼ ê²½ìš° 3ì„¸ëŒ€ ìˆœí™˜ ë°±ì—… ì‹¤í–‰
 */
function safeSaveData(data, isForceBackup) {
    if (!data) return;

    var isHealed = false; 
    var healReports = []; 

    try {
        var roomCount = Object.keys(data.rooms || {}).length;
        if (roomCount === 0) throw new Error("ì €ì¥ ê±°ë¶€: ë°©(rooms) ê°ì²´ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");

        var DB_DATA = null;
        try {
            var dbFile = new java.io.File(FILE_PATH);
            if (dbFile.exists()) {
                var dbContent = FileStream.read(FILE_PATH);
                if (dbContent) DB_DATA = JSON.parse(dbContent);
            }
        } catch(e) { Log.error("DB Read for Healing Fail: " + e); }

        for (var rName in data.rooms) {
            var room = data.rooms[rName];
            for (var uid in room.users) {
                var u = room.users[uid];
                if (u.skipHealing === true) continue; 

                if (DB_DATA && DB_DATA.rooms[rName] && DB_DATA.rooms[rName].users[uid]) {
                    var safeU = DB_DATA.rooms[rName].users[uid];
                    var isFieldHealed = false;

                    // [ìˆ˜ì •] íŒŒì¼(safeU)ì´ ì´ˆê¸°í™”ëœ ìƒíƒœì¼ ê²½ìš°, ë©”ëª¨ë¦¬(u)ì˜ ë°ì´í„°ë¥¼ ë®ì–´ì”Œìš°ì§€ ì•Šë„ë¡ ê°€ë“œ ì¶”ê°€
                    var filePoint = Number(safeU.point || 0);
                    var memoPoint = Number(u.point || 0);
                    if (filePoint < 1000 && memoPoint > 10000) continue; 

                    // A. í¬ì¸íŠ¸ ì •ë°€ ì²´í¬ (NaN ë°©ì–´ ë° ë¹„ì •ìƒ ê¸‰ê° ì²´í¬)
                    var lastPoint = filePoint;
                    var cr = getCreditInfo(u.creditScore || 600, rName);
                    var maxAllowDrop = Math.max(cr.limit * 1.5, lastPoint * 0.5);

                    if (isNaN(u.point) || u.point === null) {
                        u.point = lastPoint; 
                        isFieldHealed = true;
                    } else if (lastPoint > 10000 && (lastPoint - u.point) > maxAllowDrop) {
                        u.point = lastPoint;
                        isFieldHealed = true;
                    }

                    // B. ì€í–‰ ì”ê³  ì •ë°€ ì²´í¬
                    var lastBank = Number(safeU.bank || 0);
                    if (isNaN(u.bank) || u.bank === null) {
                        u.bank = lastBank;
                        isFieldHealed = true;
                    } else if (lastBank > 10000 && (lastBank - u.bank) / lastBank >= 0.8) {
                        u.bank = lastBank;
                        isFieldHealed = true;
                    }

                    // [ì‹ ê·œ] ë…¼ë¦¬ì  ë¬´ê²°ì„± ìƒì‹œ ìˆ˜ìˆ  (Auto-Surgical Repair)
                    // 1. ëŒ€ì¶œê¸ˆ ë…¼ë¦¬ ì²´í¬: ì”ì•¡ì€ ìˆëŠ”ë° ìƒì„¸ ë‚´ì—­ì´ ì¦ë°œí•œ ê²½ìš° ìë™ ë³µêµ¬
                    if (u.loan && Number(u.loan.debt) > 0) {
                        if (!Array.isArray(u.loan.items) || u.loan.items.length === 0) {
                            u.loan.items = [Number(u.loan.debt)];
                            isFieldHealed = true;
                            Log.warn("ğŸ©¹ [Surgical] " + u.name + " ëŒ€ì¶œ ë‚´ì—­ ë…¼ë¦¬ ë³µêµ¬");
                        }
                    }

                    // 2. í•­í•´ ë°ì´í„° ë…¼ë¦¬ ì²´í¬: í™œì„±í™” ìƒíƒœì¸ë° í•„ìˆ˜ ì •ë³´ê°€ ëˆ„ë½ëœ ê²½ìš° ê°•ì œ ê·€í•­
                    if (u.voyage && u.voyage.active === true) {
                        if (!u.voyage.dest || !u.voyage.arrival || isNaN(u.voyage.arrival)) {
                            u.voyage.active = false;
                            isFieldHealed = true;
                            Log.warn("ğŸ©¹ [Surgical] " + u.name + " ë¹„ì •ìƒ í•­í•´ ì„¸ì…˜ ì¢…ë£Œ");
                        }
                    }

                    // 3. ìŒìˆ˜ ìì‚° ê°•ì œ ì •ê·œí™”
                    if (Number(u.point) < 0) { u.point = 0; isFieldHealed = true; }
                    if (Number(u.bank) < 0) { u.bank = 0; isFieldHealed = true; }

                    // C. ë¶€ë™ì‚° ì§€ë¶„ ì •ë°€ ì²´í¬
                    if (safeU.landHoldings && u.landHoldings) {
                        for (var lName in safeU.landHoldings) {
                            var lastQty = Number(safeU.landHoldings[lName] || 0);
                            var curQty = Number(u.landHoldings[lName] || 0);
                            if (lastQty >= 10 && (lastQty - curQty) / lastQty >= 0.8) {
                                u.landHoldings[lName] = lastQty; 
                                isFieldHealed = true;
                            }
                        }
                    }

                    var lastInvCount = Array.isArray(safeU.inventory) ? safeU.inventory.length : 0;
                    var curInvCount = Array.isArray(u.inventory) ? u.inventory.length : 0;
                    if (lastInvCount >= 5 && (curInvCount / lastInvCount) <= 0.2) {
                        u.inventory = JSON.parse(JSON.stringify(safeU.inventory));
                        isFieldHealed = true;
                    }

                    if (isFieldHealed) {
                        isHealed = true;
                        healReports.push(u.name + " (ë¬´ê²°ì„± ì •ë°€ ìˆ˜ìˆ  ì™„ë£Œ)");
                    }
                }
            } 
        } 

        // ëª¨ë“  ë°©ì˜ ê²€ì‚¬ê°€ ëë‚œ ì‹œì ì— í•œ ë²ˆë§Œ ì¹˜ìœ  ë³´ê³ ì„œ ë°œì†¡
        if (isHealed && healReports.length > 0) {
            try {
                var reportMsg = util_formatSecurityLog(
                    "ğŸ©¹ [SYSTEM: ìê°€ ë¬´ê²°ì„± ìˆ˜ìˆ  ë³´ê³ ]", 
                    "HEALER_BOT", 
                    "ALL_ROOMS", 
                    "âœ… ë‚´ìš©: ë…¼ë¦¬ì  ê²°í•¨ ë° ìì‚° ì˜¤ì—¼ ìë™ ìˆ˜ì • ì™„ë£Œ\nğŸ“Š ëŒ€ìƒ: " + healReports.length + "ëª… ì¶”ì¶œë¨",
                    "ë©”ëª¨ë¦¬ ì •ê·œí™” ë° ë¬¼ë¦¬ ì €ì¥ ë°ì´í„° ë°˜ì˜"
                );
                Api.replyRoom("ë² ë¦­ë°©", reportMsg);
            } catch(e) {}
        }

    } catch (validationError) {
        Log.error("!!! [ë°ì´í„° ì˜¤ì—¼ ë°©ì§€ ì‘ë™] !!!: " + validationError.message);
        try { Api.replyRoom("ë² ë¦­ë°©", "ğŸš¨ [ë°ì´í„° ë³´í˜¸] ì˜¤ì—¼ ê°ì§€ë¡œ ìë™ ì €ì¥ ì°¨ë‹¨: " + validationError.message); } catch (e) {}
        return; 
    }

    globalData = data;

    if (isForceBackup) {
        if (typeof _saveTimer !== 'undefined' && _saveTimer) { clearTimeout(_saveTimer); _saveTimer = null; }
        _performPhysicalSave(data, isForceBackup);
    } else {
        if (typeof _saveTimer !== 'undefined' && _saveTimer) return; 
        _saveTimer = setTimeout(function() {
            _performPhysicalSave(data, false);
            _saveTimer = null;
        }, 500);
    }
}

var _saveTimer = null; 
function _performPhysicalSave(data, isForceBackup) {
    SaveExecutor.execute(new java.lang.Runnable({
        run: function() {
            var isAcquired = false; 
            try {
                isAcquired = lock.tryLock(500, java.util.concurrent.TimeUnit.MILLISECONDS);
                if (!isAcquired) return;

                // [v16.0 ì§€ëŠ¥í˜• ì†Œê° ì—”ì§„ ì ìš©] ì €ì¥ ì§ì „ ë°ì´í„° ì „ìˆ˜ ê²€ì—­
                if (typeof util_fastClean === 'function') {
                    util_fastClean(data, 0);
                }

                var content = JSON.stringify(data);
                var check = JSON.parse(content);
                if (!check || !check.rooms) throw new Error("ë°ì´í„° êµ¬ì¡° ë¶ˆì™„ì „ (rooms ëˆ„ë½)");

                var targetPath = FILE_PATH;
                var tempPath = FILE_PATH + ".tmp";
                
                FileStream.write(tempPath, content);
                var tempFile = new java.io.File(tempPath);

                if (tempFile.exists() && tempFile.length() > 0) {
                    var orgFile = new java.io.File(targetPath);
                    if (orgFile.exists()) orgFile.delete();
                    tempFile.renameTo(orgFile);

                    for (var r in data.rooms) {
                        if (!data.rooms[r].users) continue;
                        for (var id in data.rooms[r].users) {
                            data.rooms[r].users[id].skipHealing = false;
                        }
                    }
                }

                // [ì‹ ê·œ] 3ì„¸ëŒ€ ìˆœí™˜ ë°±ì—… ì—”ì§„ (Rotation Backup)
                if (isForceBackup) {
                    if (data._backupCycle === undefined) data._backupCycle = 1;
                    var cycle = data._backupCycle;
                    
                    var backupPath = BACKUP_DIR + "stable_backup_" + cycle + ".json";
                    FileStream.write(backupPath, content);
                    
                    // ë‹¤ìŒ ì €ì¥ì„ ìœ„í•´ ì‚¬ì´í´ ê°±ì‹  (1 -> 2 -> 3 -> 1)
                    data._backupCycle = (cycle % 3) + 1;
                    // Log.info("ğŸ’¾ [Backup] ìŠ¬ë¡¯ " + cycle + "ë²ˆì— ë°±ì—… ì™„ë£Œ.");
                }
                
                content = null; 
            } catch (e) {
                Log.error("Async Save Fail: " + e.message);
                try { Api.replyRoom("ë² ë¦­ë°©", "ğŸš¨ [ì‹œìŠ¤í…œ ë¹„ìƒ] ì €ì¥ ë§ˆë¹„: " + e.message); } catch (err) {}
            } finally {
                if (isAcquired) lock.unlock();
                java.lang.System.gc(); 
            }
        }
    }));
}

//==========ì„¹í„°4==========

/* ê´€ë¦¬ì ë° ì‹œìŠ¤í…œ ì„¤ì • */
var FIXED_ADMINS = ["95 ë‚¨ ê´‘ì–´", "ë² ë¦­"]; // ì—¬ê¸°ì— ë³¸ì¸ì˜ ì •í™•í•œ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”
var TIERS = ["ì•„ì´ì–¸", "ë¸Œë¡ ì¦ˆ", "ì‹¤ë²„", "ê³¨ë“œ", "í”Œë ˆí‹°ë„˜", "ì—ë©”ë„ë“œ", "ë‹¤ì´ì•„ëª¬ë“œ", "ë§ˆìŠ¤í„°", "ê·¸ëœë“œë§ˆìŠ¤í„°", "ì±Œë¦°ì €"];
var ALLOWED_ROOMS = ["ë‚´ë¦¬ë‹¤", "í…ŒìŠ¤íŠ¸", "ë² ë¦­ë°©"]; 
var CASINO_RELAY_ROOM = "ì¤‘ê³„ë°©";

//==========ì„¹í„°5==========

/* ê³ í‹°ì–´ ìŠ¹ê¸‰ í™•ë¥  ì„¤ì • */
var TIER_PROBS = {
    0: { up: 95, stay: 5, down: 0 },
    1: { up: 85, stay: 15, down: 0 },
    2: { up: 70, stay: 25, down: 5 },
    3: { up: 50, stay: 40, down: 10 },
    4: { up: 35, stay: 50, down: 15 },
    5: { up: 20, stay: 60, down: 20 },
    6: { up: 12, stay: 68, down: 20 },
    7: { up: 8, stay: 67, down: 25 },  
    8: { up: 5, stay: 70, down: 25 }  
};

/* ìƒì  ì¹´í…Œê³ ë¦¬ ì •ì˜ */
var SHOP_CATEGORIES = {
    1: "ğŸ¨ ì¥ì°©/ê¾¸ë¯¸ê¸° (ì•„ì´ì½˜)",
    2: "ğŸ”‚ ì„±ì¥/ê²Œì„ (ìŠ¹ê¸‰, ë°©ì–´)",
    3: "ğŸ’³ ê²½ì œ/ì§€ì› (ì‹ ìš©, ì¸ì¦, ê¸°íƒ€)",
    4: "ğŸ ëœë¤ ë½‘ê¸° (ì•„ì´ì½˜ ë°•ìŠ¤)",
    5: "ğŸ« íŠ¹ìˆ˜/ë³µê¶Œ (ë¡œë˜)"
};

/* [ìˆ˜ì •] ìƒì  ì•„ì´í…œ ë°ì´í„° (ê²½ê³ ì‚­ì œê¶Œ ì¶”ê°€) */
var SHOP_ITEMS = [
    { id: 1, name: "í™œë™ê°€ ì•„ì´ì½˜", icon: "ğŸŒ±", price: 5000, effect: "icon", title: "", cat: 1 },
    { id: 2, name: "ìˆ™ë ¨ì ì•„ì´ì½˜", icon: "âš”ï¸", price: 10000, effect: "icon", title: "", cat: 1 },
    { id: 3, name: "ëŸ¬ë¸”ë¦¬ ì•„ì´ì½˜", icon: "â£ï¸", price: 20000, effect: "icon", title: "", cat: 1 },
    { id: 4, name: "ë² í…Œë‘ ì•„ì´ì½˜", icon: "ğŸ’", price: 30000, effect: "icon", title: "", cat: 1 },
    { id: 5, name: "ì—ì´ë¦¬ì–¸ ì•„ì´ì½˜", icon: "ğŸ‘¾", price: 50000, effect: "icon", title: "", cat: 1 },
    { id: 6, name: "ë„¤ì„ë“œ ì•„ì´ì½˜", icon: "ğŸ‘‘", price: 70000, effect: "icon", title: "", cat: 1 },
    { id: 8, name: "ìŠ¹ê¸‰ ê¸°íšŒ êµ¬ë§¤", icon: "ğŸ”‚", price: 4000, effect: "promotion", cat: 2 },  
    { id: 9, name: "ê°•ë“± ë°©ì–´ê¶Œ", icon: "ğŸ›¡ï¸", price: 20000, effect: "tierGuard", cat: 2 },
    { id: 10, name: "ì‹ ìš© ì ìˆ˜ íšŒë³µ", icon: "ğŸ’Š", price: 10000, effect: "credit", value: 50, cat: 3 },
    { id: 11, name: "[ì‹œì¦Œ] ë¡¤ íŒìˆ˜ ì¸ì¦ê¶Œ", icon: "ğŸ«", price: 100000, effect: "gameAuth", cat: 3 },
    /* [ì‹ ê·œ] ê²½ê³ ì‚­ì œê¶Œ: ê¸°ë³¸ê°€ 500,000P ì„¤ì • */
    { id: 13, name: "ê²½ê³ ì‚­ì œê¶Œ", icon: "ğŸ«", price: 1500000, effect: "warnClear", cat: 3 },
    { id: 12, name: "ëœë¤ ì•„ì´ì½˜ ë°•ìŠ¤", icon: "ğŸ", price: 5000, effect: "randomBox", cat: 4 },
    { id: 7, name: "ë¡œë˜ êµ¬ë§¤", icon: "ğŸŸï¸", price: 2000, effect: "lotto", cat: 5 },
    { id: 14, name: "ìŠ¤í”¼ë˜ ë³µê¶Œ", icon: "ğŸ§§", price: 2000, effect: "spitto", cat: 5 },
    { id: 101, name: "ì‹ë£Œí’ˆ ìƒì", icon: "ğŸ", price: 10000, effect: "trade_cargo", value: "ì‹ë£Œí’ˆ", cat: 6 },
    { id: 103, name: "ê³µì—…í’ˆ ìƒì", icon: "âš™ï¸", price: 15000, effect: "trade_cargo", value: "ê³µì—…í’ˆ", cat: 6 },
    { id: 102, name: "ê³µì˜ˆí’ˆ ìƒì", icon: "ğŸº", price: 20000, effect: "trade_cargo", value: "ê³µì˜ˆí’ˆ", cat: 6 },
    { id: 104, name: "ê·€ê¸ˆì† ìƒì", icon: "ğŸª™", price: 25000, effect: "trade_cargo", value: "ê·€ê¸ˆì†", cat: 6 },
    { id: 105, name: "ë³´ì„ ìƒì", icon: "ğŸ’", price: 30000, effect: "trade_cargo", value: "ë³´ì„", cat: 6 },
    { id: 106, name: "ì„ ë°• ì´ë¦„ë³€ê²½ê¶Œ", icon: "ğŸ“", price: 500000, effect: "ship_rename", cat: 6 }
];

/* [ì‹ ê·œ] ëœë¤ ì•„ì´ì½˜ ë°•ìŠ¤ ìƒì„¸ êµ¬ì„± ë° í™•ë¥  ì„¤ì • */
var RANDOM_BOX_CONFIG = {
    PROBS: [
        { grade: "ê½ (Trash)", icon: "ğŸ’©", prob: 0.60, items: ["ğŸ’©", "ğŸ¤¡", "ğŸ§¤", "ğŸ‘", "ğŸŒ‚", "ğŸª ", "ğŸš½", "ğŸ¦´", "ğŸ§±", "ğŸ§¹", "ğŸ§º", "ğŸ§»", "ğŸ§¼", "ğŸ¦¶", "ğŸ¦Ÿ"] },
        { grade: "ë…¸ë§ (Normal)", icon: "ğŸŒ±", prob: 0.20, items: ["ğŸŒ±", "âš”ï¸", "â£ï¸", "ğŸ€", "ğŸ€", "ğŸˆ", "ğŸ§¸", "ğŸª", "ğŸ­", "ğŸ", "ğŸ„", "ğŸŒ»", "ğŸ±", "ğŸ¶", "ğŸ"] },
        { grade: "ë ˆì–´ (Rare)", icon: "ğŸ’", prob: 0.10, items: ["ğŸ’", "ğŸ‘¾", "ğŸ›¡ï¸", "ğŸ°", "ğŸ§¿", "ğŸ­", "ğŸ¨", "ğŸ§ª", "ğŸ”­", "ğŸ¸", "ğŸ¹", "ğŸ•¯ï¸", "â›“ï¸", "ğŸ§¬"] },
        { grade: "ì—í”½ (Epic)", icon: "ğŸ”®", prob: 0.05, items: ["ğŸ‘‘", "â˜„ï¸", "ğŸ§¨", "ğŸ”®", "â›©ï¸", "ğŸ¡", "ğŸš", "ğŸŒ‹", "ğŸ…", "ğŸ¦…", "ğŸ¹", "ğŸ°", "ğŸ›¥ï¸", "ğŸ§¿"] },
        { grade: "ìœ ë‹ˆí¬ (Unique)", icon: "ğŸ¦„", prob: 0.03, items: ["ğŸª", "ğŸ®", "ğŸ²", "ğŸ¦¾", "ğŸ›°ï¸", "ğŸ¦„", "ğŸ§", "ğŸ¦", "ğŸ‹", "ğŸ¦œ", "ğŸ•¸ï¸", "ğŸƒ", "ğŸ…", "ğŸ§œ"] },
        { grade: "ë ˆì „ë”ë¦¬ (Legendary)", icon: "ğŸ°", prob: 0.02, items: ["ğŸ”¥", "ğŸ’«", "ğŸŒŒ", "âš¡", "ğŸ›¸", "ğŸŒˆ", "â˜€ï¸", "â„ï¸", "ğŸŒ‘", "ğŸ”±", "ğŸ’®", "ğŸ’ ", "ğŸ–ï¸" ] }
    ],
    PAYBACK: 2000 // ì¤‘ë³µ ì•„ì´ì½˜ ë‹¹ì²¨ ì‹œ í™˜ê¸‰ê¸ˆ
};

//==========ì„¹í„°6==========

/**
 * [ì‹œìŠ¤í…œ ëª¨ë“ˆ] ëª…ë ¹ì–´ ìë™ ë“±ë¡ ë° ë„ì›€ë§ ê´€ë¦¬
 * ê¸°ëŠ¥: CMD_LISTì˜ ë°ì´í„°ë¥¼ USER_COMMANDS/ADMIN_COMMANDS ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— ë§¤í•‘í•˜ê³  ë„ì›€ë§ ìƒì„±
 */

/* [1] ë„ì›€ë§ ìƒì„± í•¨ìˆ˜ (ë™ì  ë Œë”ë§) */
function generateHelpMenu(category) {
    var list = [];
    for (var cmd in USER_COMMANDS) {
        var item = USER_COMMANDS[cmd];
        if (item.cat === category) {
            list.push("â€¢ " + cmd + ": " + item.desc);
        }
    }
    return list.length > 0 ? list.join("\n") : "í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì— ì¤€ë¹„ëœ ëª…ë ¹ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.";
}

function generateAdminHelp() {
    var list = [];
    var idx = 1;
    for (var cmd in ADMIN_COMMANDS) {
        list.push(idx + ". " + cmd + " (" + ADMIN_COMMANDS[cmd].desc + ")");
        idx++;
    }
    return "âš™ï¸ [ê´€ë¦¬ì ì „ìš© ëª…ë ¹ì–´]\n" + list.join("\n");
}

/* [2] ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸ ë°ì´í„° (ìˆ˜ì •ë¨: ê²°íˆ¬ ì‘ë‹µ ë° ê²½ë§ˆ ëª…ë ¹ì–´ í†µí•© ì¶”ê°€) */
var CMD_LIST = {
    user: [
        { cmd: "/ì¶œì„", desc: "ë§¤ì¼ í¬ì¸íŠ¸ íšë“", cat: "ì¡°íšŒ", func: "_gameShopLogic" },
        { cmd: "/ë‚´ì •ë³´", desc: "ë‚´ ìŠ¤íƒ¯ í™•ì¸", cat: "ì¡°íšŒ", func: "_gameInfoLogic" },
        { cmd: "/ë„ì›€ë§", desc: "ë´‡ ì´ìš© ì¢…í•© ê°€ì´ë“œ", cat: "ì¡°íšŒ", func: "_handleMenuStep4" },
        { cmd: "/ì‹ ìš©ë“±ê¸‰", desc: "ì‹ ìš© ì ìˆ˜ì™€ ë“±ê¸‰ í™•ì¸", cat: "ì¡°íšŒ", func: "_gameInfoLogic" },
        { cmd: "/ì¶œì„ìˆœìœ„", desc: "í¬ì¸íŠ¸ ë­í‚¹ í™•ì¸", cat: "ì¡°íšŒ", func: "_gameInfoLogic" },
        { cmd: "/ìœ ì €ì •ë³´", desc: "[ë‹‰ë„¤ì„] ìƒì„¸ì •ë³´ ë³´ê¸°", cat: "ì¡°íšŒ", func: "_gameInfoLogic" },
        { cmd: "/ëª…ì˜ˆì˜ì „ë‹¹", desc: "ì±Œë¦°ì € ëª…ë‹¨ í™•ì¸", cat: "ì¡°íšŒ", func: "_gameInfoLogic" },
        { cmd: "/ë²„ê·¸ì œë³´", desc: "[ë‚´ìš©] ì˜¤ë¥˜ ë° ë²„ê·¸ ì‹ ê³ ", cat: "ì¡°íšŒ", func: "_gameInfoLogic" },
        { cmd: "/í•‘", desc: "ë´‡ ì‘ë‹µ ì†ë„ ì¸¡ì •", cat: "ì¡°íšŒ", func: "_gameInfoLogic" },
        { cmd: "/ê²½ë§ˆ", desc: "í˜„ì¬ ì¶œì „ë§ˆ ì •ë³´ ë° ë°°ë‹¹ í™•ì¸", cat: "ì¡°íšŒ", func: "_gameInfoLogic" }, // [ì‹ ê·œ ê²½ë§ˆ ì¡°íšŒ]
        { cmd: "/ì½”ë“œí™•ì¸", desc: "ê¸°ê¸°ë³€ê²½/ì „ì²´ë³€ê²½ ëŒ€ë¹„ ë³µêµ¬ì½”ë“œ í™•ì¸", cat: "ì¡°íšŒ", func: "_gameInfoLogic" },
        { cmd: "/ê³„ì •ì—°ë™", desc: "[ì½”ë“œ] ì…ë ¥í•˜ì—¬ ì´ì „ ë°ì´í„° ë³µêµ¬", cat: "ì¡°íšŒ", func: "_gameInfoLogic" },
        { cmd: "/ì¹´ì§€ë…¸", desc: "ì‚¬ë‹¤ë¦¬ ë° ë°”ì¹´ë¼ í†µí•© ê²Œì„ì¥", cat: "ê²Œì„", func: "_gameCasinoLogic" },
        { cmd: "/í™€ì§", desc: "(í†µí•©ë¨) /ì¹´ì§€ë…¸ ëª…ë ¹ì–´ë¥¼ ì´ìš©í•˜ì„¸ìš”", cat: "ê²Œì„", func: "_gameActionLogic" },
        { cmd: "/ìŠ¹ê¸‰", desc: "í‹°ì–´ ìŠ¹ê¸‰ ë„ì „", cat: "ê²Œì„", func: "_gameActionLogic" },
        { cmd: "/ë°°íŒ…", desc: "[ë§ë²ˆí˜¸] [í¬ì¸íŠ¸] ê²½ë§ˆ ì°¸ì—¬", cat: "ê²Œì„", func: "_gameActionLogic" }, // [ì‹ ê·œ ê²½ë§ˆ ë°°íŒ…]
        { cmd: "ë°°íŒ…ì·¨ì†Œ", desc: "í˜„ì¬ íšŒì°¨ ë°°íŒ… ì² íšŒ (ìˆ˜ìˆ˜ë£Œ 10%)", cat: "ê²Œì„", func: "_gameActionLogic" }, // [ì‹ ê·œ ê²½ë§ˆ ì·¨ì†Œ]
        { cmd: "/ê²°íˆ¬", desc: "[ë‹‰ë„¤ì„] [í¬ì¸íŠ¸] ì‹ ì²­", cat: "ê²Œì„", func: "_gameActionLogic" },
        { cmd: "ìˆ˜ë½", desc: "ê²°íˆ¬ ì‹ ì²­ ìŠ¹ë‚™", cat: "ê²Œì„", func: "_gameActionLogic" },
        { cmd: "ê±°ì ˆ", desc: "ê²°íˆ¬ ì‹ ì²­ ê±°ì ˆ", cat: "ê²Œì„", func: "_gameActionLogic" },
        { cmd: "ì·¨ì†Œ", desc: "ê²°íˆ¬ ì‹ ì²­ ì² íšŒ", cat: "ê²Œì„", func: "_gameActionLogic" },
        { cmd: "/ë„ë‘‘ì§ˆ", desc: "[ë‹‰ë„¤ì„] í¬ì¸íŠ¸ íƒˆì·¨ ì‹œë„", cat: "ê²Œì„", func: "_gameActionLogic" },
        { cmd: "ì¡ì•˜ë‹¤ìš”ë†ˆ", desc: "ë„ë‘‘ì§ˆ ë°©ì–´ (1ë¶„ ì´ë‚´)", cat: "ê²Œì„", func: "_gameActionLogic" },
        { cmd: "ì¤ê¸°", desc: "ë°”ë‹¥ì— ë–¨ì–´ì§„ í¬ì¸íŠ¸ íšë“", cat: "ê²Œì„", func: "_gameActionLogic" },
        { cmd: "/ìƒì ", desc: "ì•„ì´ì½˜ ë° ë°©ì–´ê¶Œ êµ¬ë§¤", cat: "ìƒì ", func: "_gameShopLogic" },
        { cmd: "/êµ¬ë§¤", desc: "[ë²ˆí˜¸] ìƒì  ë¬¼í’ˆ êµ¬ë§¤", cat: "ìƒì ", func: "_gameShopLogic" },
        { cmd: "/ê°€ë°©", desc: "ë³´ìœ  ì¤‘ì¸ ì•„ì´ì½˜/ì¹­í˜¸ í™•ì¸", cat: "ìƒì ", func: "_handleInventoryLogic" },
        { cmd: "/ì¥ì°©", desc: "[ë²ˆí˜¸] ë³´ìœ  ì•„ì´í…œ ì¥ì°©", cat: "ìƒì ", func: "_handleInventoryLogic" },
        { cmd: "/ë¶„í•´", desc: "[ë²ˆí˜¸] ì•„ì´ì½˜ ë¶„í•´ ë° í¬ì¸íŠ¸ íšŒìˆ˜", cat: "ìƒì ", func: "_handleInventoryLogic" },
        { cmd: "/ë¡œë˜ì •ë³´", desc: "ë‚´ ë¡œë˜ ë²ˆêµ¬ ë° ê²°ê³¼ í™•ì¸", cat: "ìƒì ", func: "_handleLottoLogic" },
        { cmd: "/ì•„ì´ì½˜ì´ˆê¸°í™”", desc: "ì„¤ì •í•œ ì•„ì´ì½˜ ì‚­ì œ", cat: "ìƒì ", func: "_handleLottoLogic" },
        { cmd: "/ì€í–‰", desc: "ì˜ˆê¸ˆ/ì¶œê¸ˆ/ì†¡ê¸ˆ/ëŒ€ì¶œ/ì‚¬ì±„ ì¢…í•© ê´€ë¦¬", cat: "ê²½ì œ", func: "_gameBankLogic" },
        { cmd: "/ëŒ€ì¶œí•œë„", desc: "ì‹ ìš© ë“±ê¸‰ë³„ í•œë„ í™•ì¸", cat: "ê²½ì œ", func: "_gameInfoLogic" },
        { cmd: "/ìƒí™˜", desc: "[ê¸ˆì•¡] ëŒ€ì¶œê¸ˆ ì§ì ‘ ìƒí™˜", cat: "ê²½ì œ", func: "_gameBankLogic" },
        { cmd: "/ëœë“œë§ˆí¬", desc: "ì‹¤ì‹œê°„ ë¶€ë™ì‚° ì‹œì„¸ í™•ì¸", cat: "ë¶€ë™ì‚°", func: "_gameLandmarkLogic" },
        { cmd: "/ë‚´ë¶€ë™ì‚°", desc: "ë³´ìœ  ì§€ë¶„ ë° ìˆ˜ìµë¥  í™•ì¸", cat: "ë¶€ë™ì‚°", func: "_gameLandmarkLogic" },
        { cmd: "/íˆ¬ì", desc: "[ê±´ë¬¼ëª…] [ìˆ˜ëŸ‰] ì§€ë¶„ ë§¤ì…", cat: "ë¶€ë™ì‚°", func: "_gameLandmarkLogic" },
        { cmd: "/ë§¤ê°", desc: "[ê±´ë¬¼ëª…] [ìˆ˜ëŸ‰] ì§€ë¶„ ì²˜ë¶„", cat: "ë¶€ë™ì‚°", func: "_gameLandmarkLogic" },
        { cmd: "/ê´‘ì‚°ì‹œì‘", desc: "ë°©ì¹˜í˜• í¬ì¸íŠ¸ ì±„êµ´ ì‹œì‘", cat: "ê´‘ì‚°", func: "_handleMiningLogic" },
        { cmd: "/ê´‘ì‚°ì •ë³´", desc: "í˜„ì¬ ì±„êµ´ í˜„í™© ë° ì˜ˆìƒ ìˆ˜ìµ í™•ì¸", cat: "ê´‘ì‚°", func: "_handleMiningLogic" },
        { cmd: "/ê´‘ì‚°ì¢…ë£Œ", desc: "ì±„êµ´ ì™„ë£Œ ë° í¬ì¸íŠ¸ ì •ì‚°", cat: "ê´‘ì‚°", func: "_handleMiningLogic" },
        { cmd: "/ìœ ë¬¼ë„ê°", desc: "ìœ ë¬¼ ì¡°ê° ìˆ˜ì§‘ í˜„í™© í™•ì¸", cat: "ê´‘ì‚°", func: "_gameInfoLogic" },
        { cmd: "/ì˜íšŒ", desc: "í˜„ì¬ ì •ì±… ë° ì•ˆê±´ ì¡°íšŒ", cat: "ì •ë¶€", func: "_gameGovernmentLogic" },
        { cmd: "/íˆ¬í‘œ", desc: "[ì°¬ì„±|ë°˜ëŒ€] ì•ˆê±´ íˆ¬í‘œ ì°¸ì—¬", cat: "ì •ë¶€", func: "_gameGovernmentLogic" },
        { cmd: "/ìŠ¤í”¼ë˜", desc: "ì¦‰ì„ë³µê¶Œ êµ¬ë§¤ (1,000P)", cat: "ìƒ", func: "_gameLotteryLogic" },
        { cmd: "/ë‚šì‹œ", desc: "ê°•ê°€ì—ì„œ ë¬¼ê³ ê¸° ë‚šê¸° (10ë¶„ ì¿¨íƒ€ì„)", cat: "ê²Œì„", func: "_gameActivityLogic" },
        { cmd: "/ë¬´ì—­", desc: "ê°€ìƒ êµ­ê°€ì™€ì˜ í•´ìƒ êµì—­ ë° ì„ ë°• ê´€ë¦¬", cat: "ë¬´ì—­", func: "_gameTradeLogic" }
    ],
    admin: [
        { cmd: "/ê³µì§€", desc: "[ë‚´ìš©] ë‚´ë¦¬ë‹¤ ë°©ì— ê³µì§€ ì „ì†¡", func: "_adminSystemLogic" },
        { cmd: "/ë´‡êµ¬ë™", desc: "[ì˜¨|ì˜¤í”„] ì‹œìŠ¤í…œ ì œì–´", func: "_adminSystemLogic" },
        { cmd: "/ì§„ë‹¨", desc: "[ë‹‰ë„¤ì„] ìœ ì € ìƒíƒœ ì •ë°€ ë¶„ì„", func: "_adminUserManageLogic" },
        { cmd: "/ìœ ì €ì„¸ì²™", desc: "[ë‹‰ë„¤ì„] ì˜¤ì—¼ëœ ë°ì´í„° ì •ë°€ ì†Œë…", func: "_adminUserManageLogic" },
        { cmd: "/í•µì†Œë…", desc: "[ë‹‰ë„¤ì„] ì—ëŸ¬ í•„ë“œ ê°•ì œ ì‚­ì œ (ìµœí›„ìˆ˜ë‹¨)", func: "_adminUserManageLogic" },
        { cmd: "/ê´‘ì‚°ìë™ë³µêµ¬", desc: "[ë‹‰ë„¤ì„] ë°±ì—…ë³¸ ê¸°ë°˜ ê´‘ì‚° ë°ì´í„° ìë™ ë³µêµ¬", func: "_adminUserManageLogic" },
        { cmd: "/ê²½ë¡œìˆ˜ì‚¬", desc: "ë´‡ ì¸ì‹ ì‹œìŠ¤í…œ ê²½ë¡œ ë° íŒŒì¼ ëª©ë¡ í™•ì¸ (ë””ë²„ê¹…ìš©)", func: "_adminUserManageLogic" },
        { cmd: "/ë¬´ì—­ë³µêµ¬", desc: "[ë‹‰ë„¤ì„] ì •ì‚° ê¼¬ì„ ê°•ì œ í•´ì œ ë° ì¬ì‹œì‘", func: "_adminUserManageLogic" },
        { cmd: "/ë¬´ì—­íšŸìˆ˜ìˆ˜ì •", desc: "[ë‹‰ë„¤ì„] [íšŸìˆ˜] ê¸°ë¡ ìˆ˜ë™ ë³µêµ¬", func: "_adminUserManageLogic" },
        { cmd: "/ë¸”ë™ë°•ìŠ¤", desc: "[ë‹‰ë„¤ì„] ìµœê·¼ ê±°ë˜ ë‚´ì—­ ì—­ì¶”ì ", func: "_adminUserManageLogic" },
        { cmd: "/ë¶€ë™ì‚°ìì‚°ë³µêµ¬", desc: "ìœ ì € í‰ë‹¨ê°€ ê¸°ë°˜ ì‹œì„¸ ê¸´ê¸‰ ë³µêµ¬", func: "_adminEconomyLogic" },
        { cmd: "/ë§¤ë¬¼ì¶”ê°€", desc: "[ì´ë¦„] [ê°€ê²©] ì‹ ê·œ ìƒì¥", func: "_adminEconomyLogic" },
        { cmd: "/ë§¤ë¬¼ì‚­ì œ", desc: "[ê±´ë¬¼ëª…] ì‹œì¥ì—ì„œ ì˜êµ¬ ì œê±°", func: "_adminEconomyLogic" },
        { cmd: "/ë§¤ë¬¼ìˆ˜ì •", desc: "[ê¸°ì¡´] [ìƒˆì´ë¦„] [ê°€ê²©] ìˆ˜ì •", func: "_adminEconomyLogic" },
        { cmd: "/ê²½ì œì •ë³´", desc: "ì€í–‰ ì¬ì› ë° ê²½ì œ ì§€í‘œ í™•ì¸", func: "_adminEconomyLogic" },
        { cmd: "/ì¬ì›ìˆ˜ì •", desc: "[ê¸ˆì•¡] ì€í–‰ ê¸ˆê³  ìë³¸ ì¡°ì •", func: "_adminEconomyLogic" },
        { cmd: "/ë°ì´í„°êµì •", desc: "ì€í–‰ ì¬ì› ë° ìœ ì € ë°ì´í„° ë™ê¸°í™”", func: "_adminEconomyLogic" },
        { cmd: "/ë¬¼ê°€ì¡°ì •", desc: "[ê¸°ì¤€ê°’] ì¸í”Œë ˆ ë°˜ì˜ ìƒì ê°€ ì¡°ì ˆ", func: "_adminEconomyLogic" },
        { cmd: "/ë¬¼ê°€ì™„ì¶©", desc: "[0.0~1.0] ë¬¼ê°€ ë³€ë™í­ ì¡°ì ˆ", func: "_adminEconomyLogic" },
        { cmd: "/ê°•ì œì¬ê°€ë™", desc: "ì‹œìŠ¤í…œ ë½ í•´ì œ ë° ë¦¬ì…‹", func: "_adminSystemLogic" },
        { cmd: "/ì„œë²„ìƒíƒœ", desc: "ì§€ëŠ¥í˜• ì„±ëŠ¥ ê°ì‹œì(IPM) ëŒ€ì‹œë³´ë“œ", func: "_adminEconomyLogic" },
        { cmd: "/ìœ ì €ì‚­ì œ", desc: "[ë‹‰ë„¤ì„] ë°ì´í„° ì˜êµ¬ ì‚­ì œ", func: "_adminUserManageLogic" },
        { cmd: "/ìœ ì €ë°ì´í„°", desc: "ìƒì„¸ JSON ë°ì´í„° í™•ì¸", func: "_adminUserManageLogic" },
        { cmd: "/ë°ì´í„°ì´ì „", desc: "[êµ¬ë‹‰] > [ì‹ ë‹‰] ìì‚° ì´ì „", func: "_adminUserManageLogic" },
        { cmd: "/ë‹‰ë„¤ì„ê¸°ë¡", desc: "[ë‹‰ë„¤ì„] ë³€ê²½ ì´ë ¥ ì¡°íšŒ", func: "_adminUserManageLogic" },
        { cmd: "/ë©”ëª¨ë¦¬ì •í™”", desc: "ë©”ëª¨ë¦¬ ë‚´ ì˜¤ì—¼ëœ ë„¤ì´í‹°ë¸Œ ê°ì²´ ê°•ì œ ì œê±°", func: "_adminUserManageLogic" },
        { cmd: "/ì‹œìŠ¤í…œì™„ì „ì •í™”", desc: "DB ë‚´ ì˜¤ì—¼ ê°ì²´ ë¬¸ìì—´ ì¹˜í™˜ ë° ì—”ì§„ ë¦¬ë¶€íŠ¸", func: "_adminUserManageLogic" },
        { cmd: "/ë°±ì—…íŒŒì¼ì •í™”", desc: "ìë°”ê°ì²´ ì˜¤ì—¼ í´ë¦¬ë‹", func: "_adminUserManageLogic" },
        { cmd: "/ì¶œì„ì´ˆê¸°í™”", desc: "[ë‹‰ë„¤ì„] ì˜¤ëŠ˜ ê¸°ë¡ ì‚­ì œ", func: "_adminUserManageLogic" },
        { cmd: "/ì±„êµ´ì‹œê°„ë³µêµ¬", desc: "[ë‹‰ë„¤ì„] [ë¶„] ê°œë³„ ë³µêµ¬", func: "_adminUserManageLogic" },
        { cmd: "/ì „ì²´ì±„êµ´ë³µêµ¬", desc: "00ì‹œ ëˆ„ë½ë¶„ + ì˜¤ëŠ˜ ì±„êµ´ë¶„ ìë™ í•©ì‚° ë³µêµ¬", func: "_adminUserManageLogic" },
        { cmd: "/ë°°ë‹¹ê¸ˆê°•ì œì •ì‚°", desc: "ëˆ„ë½ëœ ë°°ë‹¹ê¸ˆ ì¦‰ì‹œ ì§€ê¸‰ ë° ì£¼ë¨¸ë‹ˆ ì´ˆê¸°í™”", func: "_adminUserManageLogic" },
        { cmd: "/í¬ì¸íŠ¸ì§€ê¸‰", desc: "[ë‹‰ë„¤ì„] [ìˆ˜ëŸ‰] ì§ì ‘ ì§€ê¸‰", func: "_adminEconomyLogic" },
        { cmd: "/ì „ì²´í¬ì¸íŠ¸ì§€ê¸‰", desc: "[ìˆ˜ëŸ‰] ì „ì› ì§€ê¸‰", func: "_adminEconomyLogic" },
        { cmd: "/í¬ì¸íŠ¸ì°¨ê°", desc: "[ë‹‰ë„¤ì„] [ìˆ˜ëŸ‰] ì°¨ê°", func: "_adminEconomyLogic" },
        { cmd: "/ë„ë°•ì œí•œ", desc: "[ì˜¨|ì˜¤í”„] ì‹œìŠ¤í…œ ì œì–´", func: "_adminSystemLogic" },
        { cmd: "/ì „ì†¡", desc: "[ë‹‰ë„¤ì„] [ë‚´ìš©] 1:1 ì›ê²© ë©”ì‹œì§€", func: "_adminSystemLogic", hidden: true },
        { cmd: "/ë¿Œë¦¬ê¸°", desc: "ëœë¤ í¬ì¸íŠ¸ ì„ ì°©ìˆœ ì´ë²¤íŠ¸", func: "_adminEconomyLogic" },
        { cmd: "/ê´€ë¦¬ìë“±ë¡", desc: "[ë‹‰ë„¤ì„] ë¶€ê´€ë¦¬ì ì¶”ê°€", func: "_adminSystemLogic" },
        { cmd: "/ê´€ë¦¬ìí•´ì œ", desc: "[ë‹‰ë„¤ì„] ê´€ë¦¬ì ê¶Œí•œ ë°•íƒˆ", func: "_adminSystemLogic" },
        { cmd: "/ê´€ë¦¬ìëª©ë¡", desc: "ê¶Œí•œ ë³´ìœ ì ëª…ë‹¨ ì¡°íšŒ", func: "_adminSystemLogic" },
        { cmd: "/ê´€ë¦¬ìë¡œê·¸", desc: "ìµœê·¼ ê´€ë¦¬ í™œë™ ë‚´ì—­", func: "_adminLogLogic" },
        { cmd: "/ì œë³´ëª©ë¡", desc: "ë²„ê·¸ ì œë³´ í™•ì¸", func: "_adminLogLogic" },
        { cmd: "/ì œë³´ì´ˆê¸°í™”", desc: "ì œë³´ ë‚´ì—­ ì „ì²´ ì‚­ì œ", func: "_adminLogLogic" },
        { cmd: "/ì˜¤ë¥˜ë¡œê·¸", desc: "ì‹œìŠ¤í…œ ì—ëŸ¬ ë¡œê·¸ í™•ì¸", func: "_adminLogLogic" },
        { cmd: "/ì˜¤ë¥˜ì´ˆê¸°í™”", desc: "ì‹œìŠ¤í…œ ì—ëŸ¬ ë¡œê·¸ ì‚­ì œ", func: "_adminLogLogic" },
        { cmd: "/ìŠ¹ê¸‰íšŸìˆ˜ì´ˆê¸°í™”", desc: "ì „ì²´ ìŠ¹ê¸‰ ê¸°íšŒ ë¦¬ì…‹", func: "_adminEconomyLogic" },
        { cmd: "/ëª…ë ¹ì–´ì ê²€", desc: "í•µì‹¬ ë¡œì§ ì‘ë™ ì—¬ë¶€ ì „ìˆ˜ ì¡°ì‚¬", func: "_adminEconomyLogic" },
        { cmd: "/ì‹œì¦Œê°•ì œì¢…ë£Œ", desc: "ëª¨ë“  í‹°ì–´ ì´ˆê¸°í™”", func: "_adminEconomyLogic" },
        { cmd: "/ì¶œì„ì¼ìˆ˜ìˆ˜ì •", desc: "[ë‹‰ë„¤ì„] [ìˆ˜ì¹˜] ìˆ˜ì •", func: "_adminUserManageLogic" },
        { cmd: "/ì „ì²´ì¶œì„ìˆ˜ì •", desc: "ëª¨ë“  ìœ ì € ì¶œì„ì¼ ê³ ì •", func: "_adminUserManageLogic" },
        { cmd: "/ë¡œë˜ë°ì´í„°ì´ˆê¸°í™”", desc: "ë¡œë˜ ì‹œìŠ¤í…œ ë¦¬ì…‹", func: "_adminEconomyLogic" },
        { cmd: "/ì „ì²´ë³µì›", desc: "ë°ì´í„° ë¡¤ë°± (ì•ˆì „ ì§€ì )", func: "_adminEconomyLogic" },
        { cmd: "/ìœ ì €ë³µì›", desc: "[ë‹‰ë„¤ì„] ë¶€ë¶„ ë³µêµ¬", func: "_adminUserManageLogic" },
        { cmd: "/ì‹œìŠ¤í…œìê°€ë³µì›", desc: "ë©”ëª¨ë¦¬ ìµœì í™” ë° ë³€ìˆ˜ ì´ˆê¸°í™”", func: "_adminEconomyLogic" },
        { cmd: "/ì´ì›”ê¸ˆìˆ˜ì •", desc: "[ê¸ˆì•¡] ê²½ë§ˆ ì­íŒŸ ê¸ˆì•¡ ê°•ì œ ì¡°ì •", func: "_adminEconomyLogic" },
        { cmd: "/ì¬ì›ì¶©ì „", desc: "[ê¸ˆì•¡] ì€í–‰ ê¸ˆê³  ìë³¸ ê¸´ê¸‰ ìˆ˜í˜ˆ", func: "_adminEconomyLogic" },
        { cmd: "/ë³´ì•ˆì ê²€", desc: "ë°ì´í„° ë³´í˜¸ ì—”ì§„ ìê°€ì§„ë‹¨", func: "_adminEconomyLogic" },
        { cmd: "/êµ­ê³ ë¡œê·¸", desc: "ì¤‘ì•™ì€í–‰ ì¬ì› ë³€ë™ ë‚´ì—­ ì‹¤ì‹œê°„ ì¶”ì ", func: "_adminEconomyLogic" },
        { cmd: "/ëª…ë¶€í™•ì¸", desc: "ë“±ë¡ëœ ì „ì²´ ìœ ì € ë³µêµ¬ ì½”ë“œ ì¡°íšŒ", func: "_adminEconomyLogic" },
        { cmd: "/ëª…ë¶€ì‚­ì œ", desc: "[ë‹‰ë„¤ì„] íŠ¹ì • ìœ ì € ëª…ë¶€ ê°•ì œ ì‚­ì œ", func: "_adminEconomyLogic" },
        { cmd: "/ëª…ë¶€ì—…ë°ì´íŠ¸", desc: "ë“±ë¡ëœ ì „ì²´ ìœ ì € ë³µêµ¬ ì½”ë“œ ì—…ë°ì´íŠ¸", func: "_adminEconomyLogic" },
        { cmd: "/ì‹ ìš©ì¡°ì •", desc: "[ë‹‰ë„¤ì„] [ì ìˆ˜] ì‹ ìš©ì ìˆ˜ ì§ì ‘ ê°€ê°", func: "_adminUserManageLogic" },
        { cmd: "/ì¹­í˜¸íšŒìˆ˜", desc: "[ë‹‰ë„¤ì„] [ì¹­í˜¸ëª…] ë°•íƒˆ", func: "_adminUserManageLogic" },
        { cmd: "/ì¡°ì‘", desc: "[ë‹‰ë„¤ì„] [í™€ì§%] [ë‚šì‹œ%]", func: "_adminUserManageLogic", hidden: true },
        { cmd: "/ë°°ë‹¹ë³µêµ¬", desc: "ë¡œê·¸ ê¸°ë°˜ ë°°ë‹¹ê¸ˆ ì†Œê¸‰ í•©ì‚°", func: "_adminEconomyLogic", hidden: true },
        { cmd: "/ë°°ë‹¹ì´ˆê¸°í™”", desc: "[í•­ëª©] ë°°ë‹¹ ì£¼ë¨¸ë‹ˆ ê°•ì œ ë¦¬ì…‹", func: "_adminEconomyLogic", hidden: true },
        { cmd: "/ë¡œê·¸ì›ê²©ë³µêµ¬", desc: "[HH:mm] [URL] íŠ¹ì • ì‹œì  ì´í›„ ë¡œê·¸ ì„ ë³„ ë³µêµ¬", func: "_adminEconomyLogic" },
        { cmd: "/ë³´ì•ˆí…ŒìŠ¤íŠ¸", desc: "[1-3] ë³´ì•ˆ ì—”ì§„ 4ë‹¨ê³„ ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸", func: "_adminEconomyLogic" },
        { cmd: "/ì „ì²´ë¶€ë™ì‚°", desc: "ì „ êµ¬ì—­ ìœ ì €ë“¤ì˜ ë¶€ë™ì‚° ë³´ìœ  í˜„í™© ì´ê´„ ì¡°íšŒ", func: "_adminEconomyLogic" },
        { cmd: "/ë¶€ë™ì‚°íšŒìˆ˜", desc: "[ë‹‰ë„¤ì„] [ê±´ë¬¼ëª…] [ìˆ˜ëŸ‰|ì „ë¶€] ì§€ë¶„ ê°•ì œ ëª°ìˆ˜", func: "_adminEconomyLogic" },
        { cmd: "/ë°°ë‹¹í˜„í™©", desc: "6ëŒ€ í•µì‹¬ ëœë“œë§ˆí¬ì˜ ë‹¹ì¼ ëˆ„ì  ì˜ˆìƒ ë°°ë‹¹ê¸ˆ ì‹¤ì‹œê°„ ì¡°íšŒ", func: "_adminEconomyLogic" },
        { cmd: "/ì‹œì¥ë°ì´í„°êµì •", desc: "í—¬ëŸ¬ ê°„ì„­ìœ¼ë¡œ ê¼¬ì¸ ëœë“œë§ˆí¬ ìˆ˜ëŸ‰ ê°•ì œ ì••ì¶• ë° êµì •", func: "_adminEconomyLogic" },
        { cmd: "/ê²½ì œì „ì²´ë¦¬ì…‹", desc: "ëª¨ë“  ìœ ì € ìì‚°/ë¶€ì±„ ì´ˆê¸°í™”ë° 20ë§ŒP ê³µí‰ ì§€ê¸‰", func: "_adminEconomyLogic" },
        { cmd: "/ìì •í…ŒìŠ¤íŠ¸", desc: "00ì‹œ ë¦¬ì…‹ ë¡œì§ ê°•ì œ íŠ¸ë¦¬ê±°", func: "_adminEconomyLogic" },
        { cmd: "/ì—°ë™ì§„ë‹¨", desc: "1:1 ì±„íŒ…ë°© ê³„ì • ì—°ë™ ìƒíƒœ ë¶„ì„", func: "_adminUserManageLogic" },
        { cmd: "/ë°©ëª©ë¡", desc: "DB ì „ì²´ ë°© ë¦¬ìŠ¤íŠ¸ ë° ìœ ì €ìˆ˜ ìŠ¤ìº”", func: "_adminSystemLogic" },
        { cmd: "/ì§€ë¶„í˜„í™©", desc: "ì „ êµ¬ì—­ ëœë“œë§ˆí¬ ì†Œìœ ì ë° ì§€ë¶„ ìƒì„¸ ì¡°íšŒ", func: "_adminEconomyLogic" },
        { cmd: "/ë°ì´í„°ì „ìˆ˜ì¡°ì‚¬", desc: "[ë‹‰ë„¤ì„] ëª…ë¶€ ë¬´ì‹œ DB ì „ì²´ ìŠ¤ìº”", func: "_adminUserManageLogic" },
        { cmd: "/ëª…ë¶€ê°•ì œë“±ë¡", desc: "[ë‹‰ë„¤ì„] [UID] ìˆ˜ë™ ë°”ì¸ë”©", func: "_adminUserManageLogic" },
        { cmd: "/ì „ì²´ì§ì—…ì´ˆê¸°í™”", desc: "ëª¨ë“  ìœ ì €ì˜ ì§ì—… ë° ì•…ëª…/ëª…ì„± ë°ì´í„° ì´ˆê¸°í™”", func: "_adminUserManageLogic" },
        { cmd: "/í™”ë¬¼ë³µêµ¬", desc: "[ë‹‰ë„¤ì„] [í’ˆëª©] [ìˆ˜ëŸ‰] í™”ë¬¼ ìˆ˜ë™ ë³µêµ¬", func: "_adminUserManageLogic" }
    ]
};

/* ì „ì—­ ìƒíƒœ ë³€ìˆ˜ë“¤ (ì„¹í„°1ê³¼ ì¤‘ë³µ ë°©ì§€ ì²˜ë¦¬) */ 
var sprayData = { 
    totalPoint: 0, 
    remainingPoint: 0, 
    maxWinners: 0, 
    currentWinners: 0, 
    winnersList: [], 
    isActive: false, 
    timer: null 
};

/* ì„¹í„°1ì— ì—†ëŠ” ë³€ìˆ˜ë§Œ ì‹ ê·œ ì„ ì–¸ */ 
// var selectWaitState = {}; 
// var bankProcessState = {};

//==========ì„¹í„°7==========

/**
 * [ì‹ ì„¤: ê°€ìƒ ì •ë¶€ ì •ì±… ì¶”ì¶œê¸°] v1.0
 * ê¸°ëŠ¥: í•´ë‹¹ ë°©ì˜ í˜„ì¬ ì‹œí–‰ ì¤‘ì¸ ì •ì±… ê°ì²´ë¥¼ ì•ˆì „í•˜ê²Œ ë°˜í™˜
 */
function util_getActivePolicy(roomData) {
    if (roomData && roomData.features && roomData.features.government && roomData.features.government.activePolicy) {
        return roomData.features.government.activePolicy;
    }
    // ì •ì±… ë°ì´í„°ê°€ ì—†ì„ ê²½ìš° í‘œì¤€ ê¸°ë³¸ê°’ ë°˜í™˜ (ì‹œìŠ¤í…œ ì¤‘ë‹¨ ë°©ì§€)
    return {
        stockTax: 0.05,
        mineMult: 1.0,
        attendMult: 1.0,
        loanLimitMult: 1.2,
        bankInterest: 0.01,
        theftFineMult: 1.0,
        policeProbAdj: 0.0
    };
}

/**
 * [v15.0] íƒ„í™˜ ì¶”ì í˜• ì„¸ì…˜ ì²­ì†Œ ì—”ì§„ (êµ¬ë¬¸ ë¬´ê²°ì„± ê²€ì¦ ì™„ë£Œ)
 * ê¸°ëŠ¥: ì–´ëŠ ë°©ì—ì„œ ì„¸ì…˜ì„ ë°œê²¬í•˜ë“ , ì•Œë¦¼ì€ ìœ ì €ê°€ ì‹¤ì œ ëŒ€í™” ì¤‘ì¸ ë°©(originRoom)ìœ¼ë¡œë§Œ ë³´ëƒ…ë‹ˆë‹¤.
 */
function util_autoClearTimeouts(data) {
    var now = Date.now();
    for (var rName in data.rooms) {
        var roomObj = data.rooms[rName];
        if (!roomObj || !roomObj.features || !roomObj.features.states) continue;
        
        var states = roomObj.features.states;
        var queues = ["menuWait", "bankProcess", "lottoPurchase", "selectWait"];

        queues.forEach(function(qKey) {
            var q = states[qKey];
            if (!q) return;
            for (var uid in q) {
                var entry = q[uid];
                var startTime = entry.time || entry.timestamp || 0;
                
                if (startTime > 0 && (now - startTime > 30000)) {
                    var actualOrigin = entry.originRoom || rName;
                    var u = null;
                    if (data.rooms["ë‚´ë¦¬ë‹¤"] && data.rooms["ë‚´ë¦¬ë‹¤"].users[uid]) {
                        u = data.rooms["ë‚´ë¦¬ë‹¤"].users[uid];
                    }

                    if (u) {
                        try {
// [ìˆ˜ì •] ì„¸ì…˜ ë°œìƒì§€(actualOrigin)ë¡œë§Œ ì •í™•íˆ íƒ€ì„ì•„ì›ƒ ì•Œë¦¼ ì „ì†¡
                            Api.replyRoom(actualOrigin, formatError(u, "ì…ë ¥ ì‹œê°„ ì´ˆê³¼", "30ì´ˆ ì´ë‚´ì— ì‘ë‹µì´ ì—†ì–´ ë©”ë‰´ê°€ ë‹«í˜”ìŠµë‹ˆë‹¤."));
                        } catch(e) { Log.error("Timeout Notify Error: " + e); }
                    }
                    
                    // [ì¤‘ìš”] ë™ê¸°í™”ëœ ëª¨ë“  ë°©ì˜ ì„¸ì…˜ì„ ì¦‰ì‹œ íŒŒê¸°
                    if (data.rooms["ë‚´ë¦¬ë‹¤"].features.states[qKey]) delete data.rooms["ë‚´ë¦¬ë‹¤"].features.states[qKey][uid];
                    if (data.rooms[actualOrigin] && data.rooms[actualOrigin].features.states[qKey]) delete data.rooms[actualOrigin].features.states[qKey][uid];
                    delete q[uid]; 
                }
            }
        });
    }
}

/**
 * [ì›ìì  ê°œí¸: ë²”ìš© ë°ì´í„° ê²Œì´íŠ¸ì›¨ì´] v2.0
 * ê²€ì¦: íƒ€ì… ì¼ì¹˜ ë° ìœ íš¨ ìˆ«ì ì—¬ë¶€ë¥¼ ì„ í–‰ ê²€ì‚¬í•˜ê³  ì •ìƒ ë³€ê²½ ìŠ¹ì¸ í”Œë˜ê·¸ ë¶€ì—¬
 */
function util_setData(user, key, value, reason, roomName) {
    if (!user || key === undefined) return;
    
    var preValue = user[key];
    
    // [ì›ìì  ê²€ì¦] ê¸°ì¡´ ë°ì´í„°ì™€ íƒ€ì…ì´ ë‹¤ë¥´ê±°ë‚˜ ìˆ«ìê°€ ì•„ë‹Œ ê²½ìš°(NaN) ì°¨ë‹¨
    if (preValue !== undefined && preValue !== null) {
        if (typeof preValue !== typeof value || (typeof value === 'number' && isNaN(value))) {
            var body = "âŒ ë‚´ìš©: ë°ì´í„° íƒ€ì… ì˜¤ì—¼ ì‹œë„ ì°¨ë‹¨\n" +
                       "ğŸ”‘ í•„ë“œ: " + key + "\n" +
                       "âš ï¸ ì‹œë„ê°’: " + value + " (íƒ€ì…: " + (typeof value) + ")";
            
            var securityMsg = util_formatSecurityLog("ğŸ›¡ï¸ [ATOMIC: ë°ì´í„° ë¬´ê²°ì„± ê°€ë“œ]", user.name, (roomName || "ë‚´ë¦¬ë‹¤"), body, "ë³€ê²½ ê±°ë¶€ ë° ë°ì´í„° ë³´í˜¸");
            try { Api.replyRoom("ë² ë¦­ë°©", securityMsg); } catch(e) {}
            return; 
        }
    }

    user[key] = value; 
    user.skipHealing = true; // ì •ìƒ ë¡œì§ì— ì˜í•œ ë³€ê²½ì´ë¯€ë¡œ í—¬ëŸ¬ ë¬´ì‹œ ê¶Œí•œ ë¶€ì—¬

    if (key === 'tier' && preValue !== value) {
        Log.info("[Status Change] " + user.name + " í‹°ì–´ ë³€ë™: " + preValue + " -> " + value);
    }
}

/**
 * [ì›ìì  ê°œí¸: ì¤‘ì•™ì€í–‰ êµ­ê³  3ì¤‘ ë°©ì–´ë§‰] v2.1 (ì „ì²´ ë¡¤ë°± ì ìš©)
 */
function util_updateReserve(roomData, delta, reason, roomName) {
    if (!roomData || isNaN(delta) || delta === 0) return;
    
    var preReserve = Number(roomData.bankReserve || 0);
    var expectedReserve = preReserve + Number(delta);

    var normalOutflow = ["ê²½ë§ˆ ë‹¹ì²¨ê¸ˆ", "ë¡œë˜", "ì£¼ì‹ ë§¤ë„", "ì€í–‰ ì¶œê¸ˆ", "ì¬ì›", "ì§€ì›ê¸ˆ", "íˆ¬í‘œ", "ê±°ë§ˆë¹„", "ìŠ¤í”¼ë˜"];
    var isVerified = normalOutflow.some(function(act) { return reason.indexOf(act) !== -1; });

    roomData.bankReserve = expectedReserve;

    var isCorrupted = isNaN(roomData.bankReserve) || (roomData.bankReserve !== expectedReserve);
    var lossRate = preReserve > 0 ? (preReserve - roomData.bankReserve) / preReserve : 0;
    var isAbnormalLoss = !isVerified && (preReserve > 100000 && lossRate >= 0.8);

   if (isCorrupted || isAbnormalLoss) {
        var db = getDatabase();
        var rName = roomName || "ë‚´ë¦¬ë‹¤";
        // [ìˆ˜ì •] êµ­ê³  ë°ì´í„° ì „ì²´ë¥¼ ì•ˆì „ ì§€ì ìœ¼ë¡œ ë¡¤ë°±
        if (db.rooms[rName]) {
            roomData.bankReserve = Number(db.rooms[rName].bankReserve || 10000);
        }
        var resBody = "âŒ ì‚¬ìœ : " + (isCorrupted ? "ì—°ì‚°ì˜¤ë¥˜(NaN)" : "ë¹„ì¸ê°€ ì´ìƒê¸‰ê°") + "\n" +
                      "ğŸ“Š ì‹œë„: " + fp(delta) + "P (ì´ì „: " + fp(preReserve) + "P)";

        var resMsg = util_formatSecurityLog(
            "ğŸš¨ [RESERVE: êµ­ê³  ë³´ì•ˆ ì—”ì§„]", 
            "CENTRAL_BANK", 
            rName, 
            resBody, 
            "êµ­ê³  ë°ì´í„°ë¥¼ ì•ˆì „ ì§€ì ìœ¼ë¡œ ê°•ì œ ë¡¤ë°±"
        );
        try { Api.replyRoom("ë² ë¦­ë°©", resMsg); } catch(e){}
    }
}

/**
 * [ì›ìì  ê°œí¸: ëœë“œë§ˆí¬ ì§€ë¶„ ì •ë°€ ê°ì‚¬] v2.2 (Landmark Edition)
 */
function util_updateLandmark(user, landName, delta, reason, roomName) {
    if (!user || !landName || isNaN(delta)) return;
    if (!user.landHoldings || typeof user.landHoldings !== 'object') {
        user.landHoldings = {};
    } else {
        // ê¸°ì¡´ ê°ì²´ë¥¼ ë³µì‚¬í•˜ì—¬ ìƒˆë¡œìš´ ë©”ëª¨ë¦¬ ì£¼ì†Œë¡œ í• ë‹¹ (ì°¸ì¡° ëŠê¸°)
        user.landHoldings = JSON.parse(JSON.stringify(user.landHoldings));
    }
    
    var preCount = Number(user.landHoldings[landName] || 0);
    var expectedCount = preCount + Number(delta);
    
    var normalLandActs = ["ë§¤ê°", "íŒë§¤", "ì²­ì‚°", "ì² ê±°", "êµì •", "ë³µêµ¬", "ì´ì „", "ì´ê´€"];
    var isVerified = normalLandActs.some(function(act) { return reason.indexOf(act) !== -1; });

    if (isVerified || delta > 0) user.skipHealing = true;
    
    user.landHoldings[landName] = expectedCount;

    if (isNaN(user.landHoldings[landName]) || user.landHoldings[landName] !== expectedCount || user.landHoldings[landName] < 0) {
        var db = getDatabase();
        var safeUser = null;
        for (var r in db.rooms) { if (db.rooms[r].users[user.uid]) { safeUser = db.rooms[r].users[user.uid]; break; } }
        
        if (safeUser) {
            var roomData = getDatabase().rooms[roomName || "ë‚´ë¦¬ë‹¤"];
            if (roomData) roomData.users[user.uid] = JSON.parse(JSON.stringify(safeUser));
            // ìˆ˜ì •: ë¶€ë™ì‚° ë³´ì•ˆ ì•Œë¦¼ UI í†µí•©
            var landBody = "âŒ ë‚´ìš©: ë°ì´í„° ì˜¤ì—¼(NaN/ìŒìˆ˜) ê°ì§€\n" +
                           "ğŸ¢ ëŒ€ìƒ: [" + landName + "] ì§€ë¶„ ë°ì´í„°";

            var landMsg = util_formatSecurityLog("ğŸ›¡ï¸ [LANDMARK: ë¶€ë™ì‚° ë³´ì•ˆ ì—”ì§„]", user.name, (roomName || "ë‚´ë¦¬ë‹¤"), landBody, "ë³´ì•ˆ í”„ë¡œí† ì½œì— ì˜í•´ í•´ë‹¹ ìœ ì € ë°ì´í„° ë¡¤ë°± ì™„ë£Œ");
            try { Api.replyRoom("ë² ë¦­ë°©", landMsg); } catch(e){}
        }
    }
}

/**
 * [ì›ìì  ê°œí¸: ì€í–‰ ì”ê³  ê²Œì´íŠ¸ì›¨ì´] v2.1 (ì „ì²´ ë¡¤ë°± ì ìš©)
 */
function util_updateBank(user, roomData, delta, reason, roomName) {
    if (!user || isNaN(delta) || delta === 0) return;

    var preBank = Number(user.bank || 0);
    var expectedBank = preBank + Number(delta);

    var normalBankActs = ["ì¶œê¸ˆ", "ì†¡ê¸ˆ", "ì´ì²´", "ê²°ì œ", "ì§€ë¶ˆ", "ê¸°ë¶€", "ìˆ˜ìˆ˜ë£Œ", "ì´ì", "ëŒ€ë‚©", "ì´ê´€", "ë³µêµ¬", "ì •ì‚°"];
    var isVerified = (delta > 0) || normalBankActs.some(function(act) { return reason.indexOf(act) !== -1; });

    if (isVerified) user.skipHealing = true;

    var now = Date.now();
    if (user.lastBankUpdateTime > 0 && preBank > 0) {
        var timePassed = now - user.lastBankUpdateTime;
        var earned = preBank * SYSTEM_CONFIG.ECO.BANK.INTEREST_RATE * (timePassed / 86400000);
        user.accruedInterest = (user.accruedInterest || 0) + earned;
    }
    user.lastBankUpdateTime = now;
    user.bank = Math.max(0, expectedBank);

    if (isNaN(user.bank) || user.bank !== expectedBank) {
        var db = getDatabase();
        var safeUser = null;
        for (var r in db.rooms) { if (db.rooms[r].users[user.uid]) { safeUser = db.rooms[r].users[user.uid]; break; } }
        
        if (safeUser) {
            // [í•µì‹¬: ëˆë³µì‚¬ ë°©ì§€] ì˜ˆê¸ˆ ì—°ì‚° ì˜¤ë¥˜ ì‹œ ìœ ì € ë°ì´í„° ì „ì²´ ë¡¤ë°±
            if (roomData) roomData.users[user.uid] = JSON.parse(JSON.stringify(safeUser));
            // ìˆ˜ì •: ì€í–‰ ë³´ì•ˆ ì•Œë¦¼ UI í†µí•©
            var bankBody = "âŒ ë‚´ìš©: ì˜ˆê¸ˆ ìì‚° ì˜¤ì—¼(ì—°ì‚° ì˜¤ë¥˜) ì°¨ë‹¨\n" +
                           "ğŸ’° ë³€ë™: " + fp(delta) + "P (ì´ì „: " + fp(preBank) + "P)";

            var bankMsg = util_formatSecurityLog("ğŸ›¡ï¸ [BANK: ì€í–‰ ë³´ì•ˆ ì—”ì§„]", user.name, (roomName || "ë‚´ë¦¬ë‹¤"), bankBody, "ì„¸ì´ë¸Œ í¬ì¸íŠ¸ ê¸°ë°˜ ë°ì´í„° ì „ì²´ ë³µêµ¬");
            try { Api.replyRoom("ë² ë¦­ë°©", bankMsg); } catch(e){}
        }
    }
}

/**
Â * [ì‹œìŠ¤í…œ] ì§„ë‹¨ìš© ì²´í¬í¬ì¸íŠ¸ ë„ì¥ í•¨ìˆ˜
Â * ì„¤ëª…: ìŠ¤ì¼€ì¤„ëŸ¬ ë¡œì§ì˜ ì™„ê²°ì„±ì„ ì²´í¬í•˜ê¸° ìœ„í•´ ë©”ëª¨ë¦¬ì— íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ê¸°ë¡í•©ë‹ˆë‹¤.
Â */
function util_stamp(key) {
    if (typeof globalData !== 'undefined' && globalData !== null) {
        if (!globalData.statusCheck) globalData.statusCheck = {};
        globalData.statusCheck[key] = Date.now();
    }
}

/**
 * [ìˆ˜ì •] í†µí•© ìˆœìì‚° ê³„ì‚° ì—”ì§„ (ì—ëŸ¬ ë¡œê¹… ë° ì•ˆì „ì„± ê°•í™”)
 */
function util_calculateNetWorth(user, roomData) {
    if (!user) return 0;
    try {
        var data = getDatabase(); 
        var liquidAssets = Number(user.point || 0) + Number(user.bank || 0);
        var landmarkAssets = 0;

        var market = data.landmarkMarket || (roomData && roomData.features ? roomData.features.landmarkMarket : null);

        if (user.landHoldings && market) {
            for (var lName in user.landHoldings) {
                var landmark = market[lName];
                if (landmark) landmarkAssets += (Number(user.landHoldings[lName] || 0) * Number(landmark.price || 0));
            }
        }
        
        var bankDebt = (user.loan && user.loan.debt) ? Number(user.loan.debt) : 0;
        var sacheDebt = 0;
        var sacheClaims = 0; 

        if (roomData && roomData.loanContracts) {
            for (var cid in roomData.loanContracts) {
                var c = roomData.loanContracts[cid];
                if (c.borrowerUid === user.uid) sacheDebt += Number(c.currentDebt || 0);
                if (c.lenderUid === user.uid) sacheClaims += Number(c.currentDebt || 0);
            }
        }
        return Math.max(0, Math.floor(liquidAssets + landmarkAssets + sacheClaims - bankDebt - sacheDebt));
    } catch(e) {
        Log.error("NetWorth Calculation Error for " + user.name + ": " + e);
        return Number(user.point || 0); 
    }
}

/**
 * [ì‹ ì„¤: ì›ìì  ì»¤ë°‹] v1.0
 * ê¸°ëŠ¥: ëª¨ë“  ë¡œì§ì´ ì—ëŸ¬ ì—†ì´ ì¢…ë£Œë˜ì—ˆì„ ë•Œ, ê°€ìƒ ì£¼ë¨¸ë‹ˆì˜ ë‚´ìš©ì„ ì‹¤ì œ DBì— ë°˜ì˜í•©ë‹ˆë‹¤.
 */
function util_stagingCommit(user, roomData) {
    if (!user || !user.uid || !GLOBAL_STAGING.active[user.uid]) return;
    user.skipHealing = true;
    delete GLOBAL_STAGING.active[user.uid];
    delete GLOBAL_STAGING.cache[user.uid];
    // ì»¤ë°‹ ì„±ê³µ ì‹œ ìµœì¢… ìƒíƒœë¥¼ ë¬¼ë¦¬ íŒŒì¼ë¡œ ì˜ì†í™”
    safeSaveData(globalData);
}

/**
 * [ì‹ ì„¤: ì›ìì  ë¡¤ë°±] v1.0
 * ê¸°ëŠ¥: ë¡œì§ ë„ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´, ê°€ìƒ ì£¼ë¨¸ë‹ˆë¥¼ íŒŒê¸°í•˜ê³  ì‹œì‘ ì „ ìƒíƒœë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.
 */
function util_stagingRollback(user, roomName) {
    if (!user || !user.uid || !GLOBAL_STAGING.active[user.uid]) return;
    var snapshot = GLOBAL_STAGING.cache[user.uid];
    if (snapshot && globalData.rooms[roomName]) {
        globalData.rooms[roomName].users[user.uid] = snapshot; // ì‹œì‘ ì „ ìƒíƒœë¡œ ì¦‰ì‹œ ë³µêµ¬
    }
    delete GLOBAL_STAGING.active[user.uid];
    delete GLOBAL_STAGING.cache[user.uid];
    Log.info("[Atomic Rollback] " + user.name + "ë‹˜ì˜ íŠ¸ëœì­ì…˜ ì‹¤íŒ¨ë¡œ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
}

/**
 * [v15.5] ê³ ì† ì¬ê·€ ë³µì œ ì—”ì§„ (ìµœì¢… ìˆ˜ì •ë³¸)
 * ê¸°ëŠ¥: ë¬´ê±°ìš´ JSON ë³€í™˜ì„ ì œê±°í•˜ì—¬ í•‘ ì§€ì—°ì„ í•´ê²°í•˜ê³ , ì¤‘ë³µ êµ¬ë¬¸ì„ ì œê±°í•˜ì—¬ ë¬¸ë²• ì˜¤ë¥˜ë¥¼ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.
 */
function util_stagingStart(user) {
    if (!user || !user.uid) return;
    
    GLOBAL_STAGING.active[user.uid] = true;

    // ë‚´ë¶€ ì¬ê·€ ë³µì‚¬ í•¨ìˆ˜ (ì°¸ì¡° ì˜¤ì—¼ ë°©ì§€ ë° ê³ ì† ì²˜ë¦¬)
    var deepCopy = function(obj) {
        if (obj === null || typeof obj !== 'object') return obj;
        if (obj.getClass !== undefined) return null; // ìë°” ê°ì²´ ë³µì œ ì°¨ë‹¨
        var clone = Array.isArray(obj) ? [] : {};
        for (var key in obj) {
            clone[key] = deepCopy(obj[key]); 
        }
        return clone;
    };

    // ê°€ìƒ ì£¼ë¨¸ë‹ˆ(Cache)ì— ë³µì œë³¸ ì €ì¥
    GLOBAL_STAGING.cache[user.uid] = deepCopy(user);
}

/**
 * [ì›ìì  ê°œí¸: í¬ì¸íŠ¸ ê²Œì´íŠ¸ì›¨ì´ ì—”ì§„] v7.2 (Staging í˜¸í™˜í˜•)
 */
function util_updatePoint(user, roomData, delta, reason, roomName) {
    if (!user || isNaN(delta) || delta === 0) return;

    // [ê°ì‹œ] ë™ì¼ ì‚¬ìœ ë¡œ ì—°ì† ì§€ê¸‰(delta > 0)ë˜ëŠ” ê²½ìš° ì²´í¬
    if (delta > 0 && user.lastAction && user.lastAction.cmd === reason) {
        var timeGap = Date.now() - user.lastAction.time;
        
        // ë¬´ì—­ ì •ì‚°ì€ ìµœì†Œ 1ì‹œê°„ ì´ìƒ ê±¸ë¦¬ëŠ” ì‘ì—…ì´ë¯€ë¡œ 10ì´ˆ(10000ms) ì°¨ë‹¨ ì ìš©
        if (reason.indexOf("ë¬´ì—­ ì •ì‚°") !== -1 && timeGap < 10000) {
            Log.error("ğŸš¨ [ë¬´ì—­ ë³µì‚¬ ì°¨ë‹¨] " + user.name + " (" + timeGap + "ms)");
            throw new Error("ë¬´ì—­ ì •ì‚° ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ ì‘ë™ (5ì´ˆ ê°€ë“œ)");
        }
        
        // ê·¸ ì™¸ ì¼ë°˜ í™œë™(ìŠ¤í”¼ë˜, ë°•ìŠ¤ ë“±)ì€ ì •ìƒì ì¸ ì—°ì† í˜¸ì¶œì„ ê³ ë ¤í•´ 1ì´ˆ(1000ms)ë§Œ ë°©ì–´
        else if (timeGap < 1000) {
            Log.error("ğŸš¨ [ì—°íƒ€ ê³¼ë¶€í•˜ ì°¨ë‹¨] " + user.name + " : " + reason);
            throw new Error("ì‹œìŠ¤í…œ ê³¼ë¶€í•˜ ë°©ì§€ (ì—°íƒ€ ì°¨ë‹¨)");
        }
    }
    
    // [v10.0] ìŠ¤í…Œì´ì§• í™œì„±í™” ì—¬ë¶€ì— ë”°ë¥¸ ë™ì  ì°¸ì¡°
    var targetUser = GLOBAL_STAGING.active[user.uid] ? user : user;
    /* (ì°¸ê³ : ìŠ¤í…Œì´ì§• ì¤‘ì´ë©´ ì´ë¯¸ user ê°ì²´ê°€ ë©”ëª¨ë¦¬ìƒì—ì„œ ë¶„ë¦¬ëœ ìƒíƒœì„) */

   // [ì ì§„ì  ì¹¨ì‹ ë°©ì–´] ìŠ¤í…Œì´ì§•(ë³´í˜¸ë§‰) ì™¸ë¶€ì—ì„œ ë°œìƒí•˜ëŠ” ëª¨ë“  ì°¨ê°ì„ ì‹ ìš© ë“±ê¸‰ ê¸°ì¤€ìœ¼ë¡œ í•„í„°ë§
    // [ìˆ˜ì •]: ê´€ë¦¬ì í™œë™(reasonì— 'ì°¨ê°' í¬í•¨)ì´ê±°ë‚˜ ì§ì ‘ì ì¸ ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ ì‹œ ë°©ì–´ ë¡œì§ í†µê³¼
    var isAdminAction = (reason && reason.indexOf("ì°¨ê°") !== -1);
    
    if (!GLOBAL_STAGING.active[user.uid] && delta < 0 && !isAdminAction) {
        var cr = getCreditInfo(user.creditScore || 600);
        // 1íšŒ ìµœëŒ€ í—ˆìš©ì¹˜: ì‹ ìš©í•œë„ì˜ 1.2ë°° ë˜ëŠ” í˜„ì¬ ìì‚°ì˜ 40% ì¤‘ í° ê°’
        var dropLimit = Math.max(cr.limit * 1.2, (user.point || 0) * 0.4); 
        
        if (Math.abs(delta) > dropLimit) {
            var guardBody = "âš ï¸ ë‚´ìš©: ë¹„ì •ìƒ ì§€ì¶œ(ì‹ ìš©í•œë„ ì´ˆê³¼) ê°ì§€\n" +
                            "ğŸ’µ ì‹œë„: " + fp(Math.abs(delta)) + "P (í•œë„: " + fp(dropLimit) + "P)\n" +
                            "ğŸ“ˆ ì‚¬ìœ : " + (reason || "ë¯¸ë¶„ë¥˜ í™œë™");
            
            var guardMsg = util_formatSecurityLog("ğŸ›¡ï¸ [GUARD: ì¹¨ì‹ ë°©ì–´ ì‘ë™]", user.name, (roomName || "ë‚´ë¦¬ë‹¤"), guardBody, "ìì‚° ë³´í˜¸ë¥¼ ìœ„í•´ ê±°ë˜ ì°¨ë‹¨ ë° ë¡¤ë°±");
            
            Api.replyRoom(roomName, guardMsg);
            try { Api.replyRoom("ë² ë¦­ë°©", "ğŸš¨ [Security Alert] ì¹¨ì‹ ë°©ì–´ ì‹œìŠ¤í…œì´ ìœ„í˜‘ì„ ì°¨ë‹¨í–ˆìŠµë‹ˆë‹¤."); } catch(e) {}
            throw new Error("ì‹ ìš© ë“±ê¸‰ ì§€ì¶œ í•œë„ ì´ˆê³¼ (ì¹¨ì‹ ë°©ì–´)");
        }
    }

    var normalKeywords = [
        "ë¶€ë™ì‚°", "ë§¤ì…", "ë§¤ê°", "ë°°ë‹¹", "ì„ëŒ€", "ê±´ë¬¼", "íˆ¬ì",
        "ë§¤ìˆ˜", "ë§¤ë„", "ìƒì ", "êµ¬ë§¤", "ì˜ˆê¸ˆ", "ì¶œê¸ˆ", "ì†¡ê¸ˆ", "ì´ì²´", "ë°°íŒ…", "ê¸°ë¶€", 
        "ì°¨ê°", "í™€ì§", "ê²°íˆ¬", "ë²Œê¸ˆ", "ìƒí™˜", "íŒ¨ë„í‹°", "ë¶„í•´", "ì¤ê¸°", "ë„ë‘‘ì§ˆ", "ìˆ˜ìˆ˜ë£Œ", 
        "ìˆ˜ê±°", "ì •ì‚°", "í™˜ìˆ˜", "ì§•ìˆ˜", "ìŠ¤í”¼ë˜", "ë¡œë˜", "ë‚šì‹œ", "ì¸ì¦", "ê±°ë§ˆë¹„", "ì‚¬ì±„", 
        "ë“±ë¡", "ì·¨ì†Œ", "ëŒ€ë‚©", "ë³µêµ¬", "êµì •", "ì´ì „", "ë¦¬ì…‹", "ì‹œì¦Œ", "ì‹œìŠ¤í…œ", "ë°°ë‹¹", 
        "ì¥ë ¤", "ì§€ì›", "ëª°ìˆ˜", "ë°•ìŠ¤", "ëœë¤ë°•ìŠ¤", "ë½‘ê¸°", "ì•„ì´ì½˜", "ê°œë´‰", "ì§€ê¸‰",
        "ì¹´ì§€ë…¸", "ì‚¬ë‹¤ë¦¬", "ë°”ì¹´ë¼", "ì ì¤‘", "ë¯¸ì ì¤‘"
    ];
    var isVerifiedAction = (delta > 0) || normalKeywords.some(function(k) { return reason && reason.indexOf(k) !== -1; });

    var prePoint = Number(user.point || 0);
    var actualDelta = (delta < 0 && (prePoint + delta) < 0) ? -prePoint : Number(delta);
    var expectedPoint = prePoint + actualDelta;

    if (isVerifiedAction) user.skipHealing = true;

    var brDelta = 0; 
    if (roomData && typeof roomData === 'object') {
        if (roomData.bankReserve === undefined) roomData.bankReserve = 10000;
        var bankOutput = [
            "ì¶œì„ ë³´ìƒ", "ë¯¼ìƒì§€ì›ê¸ˆ", "í™€ì§ ì ì¤‘", "ì£¼ì‹ ë§¤ë„", "ê´‘ì‚° ì±„êµ´", 
            "ë¡œë˜ 1ë“±", "ë¡œë˜ 2ë“±", "ë¡œë˜ 3ë“±", "ë¶„í•´ íšŒìˆ˜", "ì¤‘ë³µ í™˜ê¸‰", 
            "ê²°íˆ¬ ìŠ¹ë¦¬", "ë¿Œë¦¬ê¸° ì¤ê¸°", "ê²½ë§ˆ ë‹¹ì²¨", "ì€í–‰ ì¶œê¸ˆ", "ëŒ€ì¶œ ì‹¤í–‰", 
            "íˆ¬í‘œ ê±°ë§ˆë¹„", "êµ­ê°€ íŠ¹ë³„ ë°°ë‹¹ê¸ˆ", "ì •ë¶€ ê·¼ë¡œ ì¥ë ¤ê¸ˆ", "ìŠ¤í”¼ë˜ ë‹¹ì²¨ê¸ˆ",
            "ë¬´ì—­ ì •ì‚° ìˆ˜ìµ", "í•´ì  í† ë²Œ í˜„ìƒê¸ˆ",
            "ì ì¤‘ ìˆ˜ìµ", "ë¸”ë™ì­ ìŠ¹ë¦¬", "ì´ì ì§€ê¸‰", "ê´€ì„¸ ìˆ˜ë ¹", "í™œë™ ìì‚° ì •ì‚°", "ë³´ì „ê¸ˆ"
        ];
        var bankInput = [
            "ì£¼ì‹ ë§¤ìˆ˜", "í™€ì§ ë¯¸ì ì¤‘", "ì²´í¬ ë²Œê¸ˆ", "ëŒ€ì¶œ ìƒí™˜", "ìƒì  êµ¬ë§¤", 
            "ê²½ì°° ë²Œê¸ˆ", "ë„ë‘‘ì§ˆ ì„±ê³µ", "ì€í–‰ ê¸°ë¶€", "ê²½ë§ˆ ë°°íŒ…", "ì·¨ì†Œ ìˆ˜ìˆ˜ë£Œ", 
            "ë¡œë˜ êµ¬ë§¤", "ë³´ìœ ì„¸ ì§•ìˆ˜", "ìì‚° í™˜ìˆ˜", "ë¶€ë™ì‚° ë§¤ì…", "ìŠ¤í”¼ë˜ êµ¬ë§¤", 
            "ê°•í™”", "ì—…ê·¸ë ˆì´ë“œ", "ê°œì¡°", "ì„ ë°•", "ì´ë¦„ ë³€ê²½",
            "ë¯¸ì ì¤‘ ì°¨ê°", "ë¸”ë™ì­ íŒ¨ë°°", "ì€í‡´ ë¹„ìš©", "ì „ì—­ ë¹„ìš©", "ë³´ì„ê¸ˆ", "í•­êµ¬ íˆ¬ì", "ë³´í˜¸ì„¸", "ê´€ì„¸ êµ­ê³  ì…ê³ "
        ];
        if (actualDelta > 0) {
            // ì‚¬ìœ ì— "ë°°ë‹¹ê¸ˆ"ì´ë‚˜ "ì¥ë ¤ê¸ˆ"ì´ í¬í•¨ë˜ë©´ êµ­ê³ ì—ì„œ ì°¨ê°í•˜ë„ë¡ ì„¤ê³„
            if (bankOutput.some(function(r){ return reason.indexOf(r) !== -1; })) brDelta = -actualDelta;
        } else {
            if (bankInput.some(function(r){ return reason.indexOf(r) !== -1; })) brDelta = Math.abs(actualDelta);
        }

       /* [v11.9.24] ë°°ë‹¹ ì£¼ë¨¸ë‹ˆ: í¬ì¸íŠ¸ê°€ ì•„ë‹Œ 'ì›ê¸ˆ(Revenue)' ëˆ„ì ìœ¼ë¡œ ë³€ê²½ */
        if (roomData.features && roomData.features.dailyPools) {
            var dp = roomData.features.dailyPools;
            var r = reason || "";
            var absAmt = Math.abs(actualDelta);

            // [êµì •]: ìƒìˆ˜ë¥¼ ì—¬ê¸°ì„œ ê³±í•˜ì§€ ì•Šê³  ì›ê¸ˆ(absAmt)ë§Œ ê·¸ëŒ€ë¡œ ë”í•©ë‹ˆë‹¤.
            if (r.indexOf("ê´‘ì‚°") !== -1) dp.mine += absAmt;
            else if (r.indexOf("ë‚šì‹œ") !== -1) dp.fish += absAmt;
            else if (r.indexOf("ì¹´ì§€ë…¸") !== -1 || r.indexOf("ì‚¬ë‹¤ë¦¬") !== -1 || r.indexOf("ë°”ì¹´ë¼") !== -1 || r.indexOf("í™€ì§") !== -1 || r.indexOf("ì ì¤‘") !== -1) {
                dp.casino += absAmt;
            }
            else if (r.indexOf("ìƒì ") !== -1 || r.indexOf("êµ¬ë§¤") !== -1) dp.shop += absAmt;
            else if (r.indexOf("ì´ì") !== -1) dp.bank += absAmt;
            else if (r.indexOf("ê²½ë§ˆ") !== -1 || r.indexOf("ë°°íŒ…") !== -1) dp.race += absAmt;
        }
        util_updateReserve(roomData, brDelta, reason, roomName);
    }

    user.point = expectedPoint; 

    // [ê°ì‹œ ì—”ì§„] 1:1 ëŒ€í™”ë°© ì¹´ì§€ë…¸ ì–´ë·°ì§• ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ (êµ¬ë¶„ì„  ì œê±° ë° ìµœì í™”)
    if (delta > 0 && ALLOWED_ROOMS.indexOf(roomName) === -1 && user.casinoAuditStartTime > 0) {
        var auditNow = Date.now();
        // 1) 2ë¶„ ì´ë‚´ ìˆ˜ìµì¸ì§€ ê²€ì‚¬
        if (auditNow - user.casinoAuditStartTime <= 120000) {
            var currentTotalAssets = Number(user.point) + Number(user.bank || 0);
            
            var lastCheckpoint = (user.casinoAuditAlertHistory && user.casinoAuditAlertHistory.length > 0)
                ? user.casinoAuditAlertHistory[user.casinoAuditAlertHistory.length - 1]
                : user.casinoAuditStartAssets;

            // 2) ê¸°ì¤€ì  ëŒ€ë¹„ 2ë°° ì´ˆê³¼ ë‹¬ì„± íŒì •
            if (currentTotalAssets >= lastCheckpoint * 2 && currentTotalAssets >= user.casinoAuditStartAssets * 2) {
                if (!user.casinoAuditAlertHistory) user.casinoAuditAlertHistory = [];
                user.casinoAuditAlertHistory.push(currentTotalAssets);

                var alertLog = user.casinoAuditAlertHistory.map(function(val, idx) {
                    return "â€¢ ì•Œë¦¼" + (idx + 1) + "íšŒ: " + fp(val) + " P";
                }).join("\n");

                var alertTitle = user.casinoAuditAlertHistory.length === 1 ? "ì¹´ì§€ë…¸ ê³ ìˆ˜ìµ ê°ì§€" : "ê³ ì•¡ ìˆ˜ìµ ì§€ì† ë°œìƒ";
                
                var reportBody = "ğŸš¨ [" + alertTitle + "]\n" +
                                 "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                                 "ğŸ‘¤ ëŒ€ìƒì: " + user.name + " (ID: " + user.uid + ")\n" +
                                 "ğŸ“ ë°œìƒì¥ì†Œ: 1:1 ëŒ€í™”ë°© (" + roomName + ")\n" +
                                 "ğŸ’° í˜„ì¬ ì”ì•¡: " + fp(currentTotalAssets) + " P\n\n" +
                                 "ğŸ“ˆ ë°œìƒì‚¬ìœ : " + (reason || "ì¹´ì§€ë…¸ ê²Œì„ ê²°ê³¼") + "\n\n" +
                                 "ğŸ“Š ìœ ì € í˜„í™©:\n" +
                                 "â€¢ ì‹œì‘ìì‚°: " + fp(user.casinoAuditStartAssets) + " P\n" +
                                 alertLog + "\n\n" + // ìš”ì²­í•˜ì‹  ëŒ€ë¡œ ì¤‘ê°„ êµ¬ë¶„ì„ ì„ ì œê±°í–ˆìŠµë‹ˆë‹¤.
                                 "âš ï¸ ê´€ë¦¬ìëŠ” ì–´ë·°ì§• ì—¬ë¶€ë¥¼ í™•ì¸í•˜ì‹­ì‹œì˜¤.\n" +
                                 "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”";

                try { Api.replyRoom("ë² ë¦­ë°©", reportBody); } catch(e) { Log.error("Audit Alert Fail: " + e); }
            }
        }
    }

    if (!GLOBAL_STAGING.active[user.uid]) {
        var lossRate = prePoint > 0 ? (prePoint - user.point) / prePoint : 0;
        if ((isNaN(user.point) || user.point === null || user.point !== expectedPoint) || (!user.skipHealing && lossRate >= 0.8)) {
            var db = getDatabase();
            var safeUser = null;
            for (var r in db.rooms) { if (db.rooms[r].users[user.uid]) { safeUser = db.rooms[r].users[user.uid]; break; } }
            if (safeUser) {
                if (roomData) roomData.users[user.uid] = JSON.parse(JSON.stringify(safeUser)); // í•´ë‹¹ ìœ ì €ë§Œ ë¡¤ë°±
               var gateBody = "âŒ ë‚´ìš©: í¬ì¸íŠ¸ ì—°ì‚° ì˜¤ë¥˜ ë˜ëŠ” ë¹„ì¸ê°€ ê¸‰ê° ë°œìƒ\n" +
                               "ğŸ“Š ìƒíƒœ: " + fp(prePoint) + "P â” " + fp(user.point) + "P";
                
                var gateMsg = util_formatSecurityLog("ğŸš¨ [GATEWAY: ë¹„ì •ìƒ ë³€ë™ ê°ì§€]", user.name, (roomName || "ë‚´ë¦¬ë‹¤"), gateBody, "ì‹œìŠ¤í…œ ìê°€ ë³´í˜¸ë¥¼ ìœ„í•´ í•´ë‹¹ ìœ ì € ë°ì´í„° ì¦‰ì‹œ ë¡¤ë°±");
                try { Api.replyRoom(roomName, gateMsg); } catch(e){}
            }
        }
    }

    try {
        var totalNetWorth = util_calculateNetWorth(user, roomData);
        var assetTitles = [
            { name: "ìì‚°ì™•", limit: 5000000, id: 703, msg: "[ì¥ì°© íš¨ê³¼]: ë§¤ì¼ 00ì‹œ ì€í–‰ ì˜ˆê¸ˆ ì´ì ìˆ˜ë ¹ ì‹œ ì´ìœ¨ 1.5ë°° ë³´ë„ˆìŠ¤ê°€ ì ìš©ë©ë‹ˆë‹¤." },
            { name: "ë¶€í˜¸", limit: 2000000, id: 702, msg: "ìƒë¥˜ ì‚¬íšŒì˜ ì¼ì›ì´ ë˜ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤." },
            { name: "ê±°ìƒ", limit: 1000000, id: 701, msg: "ì‹œì¥ì„ ì›€ì§ì´ëŠ” ê±°ëŒ€í•œ ì†ê¸¸ì´ ëŠê»´ì§‘ë‹ˆë‹¤." },
            { name: "ì¬ë²Œ", limit: 500000, id: 700, msg: "ì„±ê³µì ì¸ ìì‚° ì¶•ì ì˜ ì²« ê²°ì‹¤ì„ ë§ºì—ˆìŠµë‹ˆë‹¤." }
        ];

       var rStub = { reply: function(m) { try { Api.replyRoom(roomName || "ë‚´ë¦¬ë‹¤", m); } catch(e){} } };

        for (var i = 0; i < assetTitles.length; i++) {
            var t = assetTitles[i];
            if (totalNetWorth >= t.limit) {
                // ê³µìš© í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ì‘ìœ„ ìˆ˜ì—¬ì‹ ì§„í–‰ (ê°€ë°© ì²´í¬ ë° ì¥ì°© ë¡œì§ ë‚´ì¥ë¨)
                var awarded = util_checkAndAwardTitle(
                    user, 
                    rStub, 
                    t.name, 
                    t.id, 
                    "ğŸ’°", 
                    "ë‚´ë¦¬ë‹¤ ê²½ì œ ìœ„ì›íšŒ", 
                    "ìˆœìì‚° " + fp(t.limit) + "P", 
                    t.msg, 
                    roomName
                );
                
                if (awarded) break; // í•˜ë‚˜ë¼ë„ ìˆ˜ì—¬í–ˆë‹¤ë©´ ì¤‘ë‹¨ (ì¤‘ë³µ ë°©ì§€)
            }
        }
    } catch(e) {}

    if (typeof verifyPointTransaction === 'function') {
        verifyPointTransaction(user, prePoint, actualDelta, reason, roomName, brDelta);
    }
}

/* í¬ì¸íŠ¸ ë‹¨ìœ„ ì‰¼í‘œ í¬ë§·íŒ… (0ì› ë²„ê·¸ ë°©ì§€í˜•) */
function fp(val) {
    var num = Number(val);
    if (isNaN(num)) return "0";
    return String(Math.floor(num)).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}
var fP = fp;

/* UI í¬ë§·í„° í•¨ìˆ˜êµ° */
function formatCommand(title, user, content, nextStep) { 
    var msg = title + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"; 
    if (user !== null) { 
        var nameTag = (typeof user === "string") ? user : getDisplayName(user); 
        msg += nameTag + "ë‹˜\n"; 
    } 
    msg += content + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"; 
    if (nextStep) msg += "\nğŸ’¡ [ê°€ì´ë“œ]: " + nextStep; 
    return msg; 
}

function formatSimple(title, content, nextStep) {
    var msg = "â„¹ï¸ " + title + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + content + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”";
    if (nextStep) msg += "\nğŸ’¡ [ê°€ì´ë“œ]: " + nextStep;
    return msg;
}

function formatAdmin(title, content) { 
    return "âš™ï¸ " + title + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + content + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"; 
}

function formatError(user, content, nextStep) { 
    var nameTag = (typeof user === "string") ? user : getDisplayName(user); 
    var msg = "ğŸš« ì˜¤ë¥˜ ë°œìƒ\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + nameTag + "ë‹˜\nì‚¬ìœ : " + content + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"; 
    if (nextStep) msg += "\nğŸ’¡ [ê°€ì´ë“œ]: " + nextStep; 
    return msg; 
}

/**
 * [ì‹ ê·œ] ëœë“œë§ˆí¬ ê°€ê²© ë³€ë™ ì—”ì§„
 */
function stock_calculateNextPrice(currentPrice) {
    if (!marketOpenPrice || marketOpenPrice <= 0) return currentPrice;
    var cfg = SYSTEM_CONFIG.ECO.STOCK.SETTINGS;
    var growthRate = (currentPrice - marketOpenPrice) / marketOpenPrice;
    var change = (Math.random() * 2.4 - 1.2) / 100;

    if (growthRate > cfg.RESISTANCE_START) {
        // [ìµœì¢… êµì •]: ì‚­ì œëœ timeWeight ì°¸ì¡°ë¥¼ ì œê±°í•˜ì—¬ ìˆ˜ì‹ ì˜¤ë¥˜ë¥¼ ë°©ì§€í•¨
        var resistance = (growthRate - cfg.RESISTANCE_START) * cfg.GRAVITY;
        change -= resistance;
        
        if (growthRate >= (cfg.CLOSING_LIMIT - 0.01) && change > 0) {
            if (Math.random() < 0.8) change = -Math.abs(change) * 0.5;
        }
    }
    return Math.max(10, currentPrice + (currentPrice * change));
}

/**
 * [ì‹ ì„¤] êµ­ê³  ë¹„ìƒíƒœì„¸ ë°°ìœ¨ ì‚°ì¶œ (ì§€ëŠ¥í˜• ë°©ì–´)
 */
function util_getEmergencyMultiplier(roomName) {
    var data = getDatabase();
    var roomData = data.rooms[roomName];
    if (!roomData || !roomData.economyBase) return 1.0;
    
    var reserve = Number(roomData.bankReserve || 0);
    var base = Number(roomData.economyBase);
    
    // ì¬ê³ ê°€ ê¸°ì¤€ì ì˜ 10% ë¯¸ë§Œì´ë©´ ëª¨ë“  ë³´ìƒ 50% ì‚­ê°
    if (reserve < (base * 0.1)) return 0.5; 
    return 1.0;
}

/**
 * [ì‹ ì„¤] êµ­ê³  ì§€ê¸‰ ê°€ëŠ¥ ì—¬ë¶€ ì²´í¬ (ë¶€ë„ ë°©ì–´)
 */
function util_isBankSolvent(roomName, amount) {
    var data = getDatabase(); 
    var targetRoom = (ALLOWED_ROOMS.indexOf(roomName) === -1) ? "ë‚´ë¦¬ë‹¤" : roomName;
    var roomData = data.rooms[targetRoom];
    if (!roomData) return false;
    return (Number(roomData.bankReserve || 0) >= amount);
}

/**
 * [ì‹ ì„¤] êµ­ê°€ ë¶€ë„ ìƒíƒœ í™•ì¸ í•¨ìˆ˜
 * ë¶€ë„ ì„ í¬(disaster) ìƒíƒœì¸ì§€ í™•ì¸í•˜ì—¬ ë¦¬ìŠ¤í¬ ì»¨í…ì¸  ì§„í–‰ ì—¬ë¶€ ê²°ì •
 */
function util_isBankruptcy(roomName) {
    var data = getDatabase();
    var roomData = data.rooms[roomName];
    if (!roomData) return false;
    // lastBankAlertê°€ 'disaster'ì¸ ê²½ìš°ì—ë§Œ true(ë¶€ë„ìƒíƒœ)ë¥¼ ë°˜í™˜
    return roomData.lastBankAlert === "disaster";
}

/**
 * [ì‹ ì„¤] ì¢…ëª© ì•½ì–´ ê²€ìƒ‰ ì—”ì§„
 * @param {Object} market - ê²€ìƒ‰ ëŒ€ìƒ ì¢…ëª© ê°ì²´ (ì „ì²´ ì‹œì¥ í˜¹ì€ ë³´ìœ  ëœë“œë§ˆí¬)
 * @param {String} input - ìœ ì € ì…ë ¥ ì•½ì–´ (ì˜ˆ: "ë‚˜íˆ¬ì¦")
 */
function util_findStockByShorthand(market, input) {
    var stocks = Object.keys(market);
    var matched = [];
    var searchStr = input ? input.trim() : "";
    if (searchStr === "") return matched;

    for (var i = 0; i < stocks.length; i++) {
        var name = stocks[i];
        var searchIdx = 0;
        // ì…ë ¥ëœ ê¸€ìê°€ ì¢…ëª©ëª…ì— ìˆœì„œëŒ€ë¡œ ë“¤ì–´ìˆëŠ”ì§€ ì²´í¬ (ì˜ˆ: ë‚˜...íˆ¬...ì¦)
        for (var j = 0; j < name.length && searchIdx < searchStr.length; j++) {
            if (name[j] === searchStr[searchIdx]) searchIdx++;
        }
        if (searchIdx === searchStr.length) matched.push(name);
    }
    return matched;
}

/**
 * [ì‹ ì„¤] ëœë“œë§ˆí¬ ìµœëŒ€ì£¼ì£¼ ì¶”ì¶œ ì—”ì§„
 * @param {Object} roomData - í•´ë‹¹ ë°© ë°ì´í„°
 * @param {String} landName - ê±´ë¬¼ ì´ë¦„
 * @returns {Object|null} ìœ ì € ê°ì²´ ë° ID, ì§€ë¶„ëŸ‰
 */
function util_getMajorityOwner(roomData, landName) {
    var topOwnerId = null;
    var maxQty = 0;
    
    // í•´ë‹¹ ë°©ì˜ ëª¨ë“  ìœ ì €ë¥¼ ë£¨í”„í•˜ë©° íŠ¹ì • ê±´ë¬¼ì˜ ì§€ë¶„ 1ìœ„ë¥¼ íƒìƒ‰
    for (var uid in roomData.users) {
        var u = roomData.users[uid];
        var qty = (u.landHoldings && u.landHoldings[landName]) ? Number(u.landHoldings[landName]) : 0;
        
        // ì§€ë¶„ì´ í˜„ì¬ ìµœê³ ì¹˜ë³´ë‹¤ ë§ì„ ê²½ìš° ê°±ì‹ 
        if (qty > maxQty) {
            maxQty = qty;
            topOwnerId = uid;
        }
    }
    
    // ì§€ë¶„ ë³´ìœ ìê°€ í•œ ëª…ì´ë¼ë„ ìˆìœ¼ë©´ ê°ì²´ ë°˜í™˜, ì—†ìœ¼ë©´ null ë°˜í™˜
    return topOwnerId ? { id: topOwnerId, data: roomData.users[topOwnerId], qty: maxQty } : null;
}

/**
 * [ì‹ ê·œ] ì „ êµ¬ì—­ íŠ¹ì • ê±´ë¬¼ì˜ ì´ ì§€ë¶„ í•©ê³„ ê³„ì‚° (Global)
 * ì„¤ëª…: ëª¨ë“  ë°©ì˜ ìœ ì € ë°ì´í„°ë¥¼ ë’¤ì ¸ íŠ¹ì • ê±´ë¬¼ì˜ ë°œí–‰ëœ ì´ ì§€ë¶„ ìˆ˜ë¥¼ í•©ì‚°í•©ë‹ˆë‹¤.
 */
function util_getTotalShares(landName, roomData) {
    var total = 0;
    if (!roomData || !roomData.users) return 0;
    for (var u in roomData.users) {
        total += Number((roomData.users[u].landHoldings || {})[landName] || 0);
    }
    return total;
}

//==========ì„¹í„°8==========

/**
 * [v10.0 ì§€ëŠ¥í˜• ì—”ì§„] ì§€ë‹ˆ ê³„ìˆ˜(Gini Coefficient) ê³„ì‚° í•¨ìˆ˜
 * ì›ë¦¬: ìì‚°ì˜ ë¶ˆí‰ë“±ë„ë¥¼ ì‚°ì¶œ (0: ì™„ì „í‰ë“±, 1: ì™„ì „ë¶ˆí‰ë“±)
 * $$G = \frac{\sum_{i=1}^{n} \sum_{j=1}^{n} |x_i - x_j|}{2n^2 \bar{x}}$$
 */
function util_calculateGini(roomName) {
    var data = getDatabase();
    var room = data.rooms[roomName];
    if (!room) return 0;

    var assets = [];
    for (var uid in room.users) {
        assets.push(util_calculateNetWorth(room.users[uid], room));
    }
    
    var n = assets.length;
    if (n < 2) return 0;
    
    assets.sort(function(a, b) { return a - b; });
    
    var mean = assets.reduce(function(a, b) { return a + b; }, 0) / n;
    if (mean === 0) return 0;

    var sumDiff = 0;
    for (var i = 0; i < n; i++) {
        for (var j = 0; j < n; j++) {
            sumDiff += Math.abs(assets[i] - assets[j]);
        }
    }
    
    return sumDiff / (2 * n * n * mean);
}

/**
Â * [Gemini ì •ë°€ êµì •] ê²½ì œ ì§€í‘œ ê³„ì‚° í•¨ìˆ˜ (ì‹œìŠ¤í…œ íŒëˆ ì™„ë²½ í†µí•© ë²„ì „)
Â * ë°˜ì˜: ëœë“œë§ˆí¬, ê²½ë§ˆ ë°°íŒ…ì•¡, ë¡œë˜ ì­íŒŸ, ì€í–‰ ì¬ì› ë“±ì„ ëª¨ë‘ í•©ì‚°í•˜ì—¬ ë¬¼ê°€ ì™œê³¡ ë°©ì§€
Â */
function calculateEconomy(data, roomName) {
    var totalAssets = 0;      // [ë¬¼ê°€ìš©] ì‹œìŠ¤í…œ ì „ì²´ í†µí™”ëŸ‰
    var totalUserWealth = 0;  // [í‰ê· ìš©] ìœ ì €ë“¤ì˜ ì‹¤ì§ˆ ìˆœìì‚° í•©ê³„
    var userCount = 0;
    var economyBase = 0;      // [ì¡°íšŒìš©] í˜„ì¬ ë°©ì˜ ë¬¼ê°€ ê¸°ì¤€ì 

    if (!data || !data.rooms) return { total: 0, count: 0, average: 0, base: 0 };
    var roomsToScan = roomName ? [roomName] : Object.keys(data.rooms);
    
    // 1. ì „ì—­ ì­íŒŸ íŒëˆ í•©ì‚°
    if (!roomName) totalAssets += Number(data.lotto_jackpot_pool || 0);

    for (var i = 0; i < roomsToScan.length; i++) {
        var r = roomsToScan[i];
        var roomData = data.rooms[r];
        if (!roomData) continue;

        // ë¬¼ê°€ ê¸°ì¤€ì  í™•ë³´
        economyBase = Number(roomData.economyBase || 0);

        // A. ì‹œìŠ¤í…œ ê¸ˆê³  ë° ì§„í–‰ ì¤‘ì¸ íŒëˆ í•©ì‚°
        totalAssets += Number(roomData.bankReserve || 0);
        if (roomData.features) {
            if (roomData.features.racing) {
                totalAssets += Number(roomData.features.racing.totalPool || 0);
                totalAssets += Number(roomData.features.racing.carryOver || 0);
            }
            if (roomData.features.lotto) totalAssets += Number(roomData.features.lotto.dailyPool || 0);
        }

        // B. ìœ ì € ë°ì´í„° í•©ì‚° ë£¨í”„
        for (var uid in roomData.users) {
            var u = roomData.users[uid];
            if (!u) continue;

            // 1. [í‰ê· ìì‚°ìš©]: ì±„ê¶Œ/ì±„ë¬´ê°€ í¬í•¨ëœ ìœ ì €ì˜ ì‹¤ì§ˆ ìˆœìì‚° í•©ì‚°
            totalUserWealth += util_calculateNetWorth(u, roomData);

            // 2. [ë¬¼ê°€ìš©]: ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•´ êµ­ê³ ì— ì—†ëŠ” 'í˜„ê¸ˆ'ê³¼ 'ë¶€ë™ì‚° ê°€ì¹˜'ë§Œ í†µí™”ëŸ‰ì— ì¶”ê°€
            var cash = Number(u.point || 0);
            var landmarkVal = 0;
            var market = data.landmarkMarket || (roomData.features ? roomData.features.landmarkMarket : null);
            if (u.landHoldings && market) {
                for (var lName in u.landHoldings) {
                    if (market[lName]) landmarkVal += (Number(u.landHoldings[lName]) * Number(market[lName].price));
                }
            }
            totalAssets += (cash + landmarkVal);
            userCount++;
        } // ìœ ì € ë£¨í”„ ì¢…ë£Œ
    }

    return {
        total: Math.max(0, totalAssets), 
        count: userCount,
        average: userCount > 0 ? Math.floor(totalUserWealth / userCount) : 0,
        base: economyBase // ìš”ì²­í•˜ì‹  ë¬¼ê°€ê¸°ì¤€ í•„ë“œ ì¶”ê°€
    };
}

/**
 * [v10.0 ì§€ëŠ¥í˜• ì—”ì§„] ì§€ë‹ˆ ê³„ìˆ˜(Gini Coefficient) ê³„ì‚° í•¨ìˆ˜
 * ê¸°ëŠ¥: í•´ë‹¹ ë°©ì˜ ìì‚° ë¶ˆí‰ë“±ë„ë¥¼ ì‚°ì¶œí•©ë‹ˆë‹¤. (0: í‰ë“±, 1: ë…ì )
 * ìœ„ì¹˜: ê²½ì œ ì§€í‘œ ê³„ì‚°ë¶€(Sector 8) í•˜ë‹¨
 */
function util_calculateGini(roomName) {
    var data = getDatabase();
    var room = data.rooms[roomName];
    if (!room || !room.users) return 0;

    var assets = [];
    for (var uid in room.users) {
        // ìœ ì €ë³„ ìˆœìì‚°(í˜„ê¸ˆ+ì˜ˆê¸ˆ+ëœë“œë§ˆ-ë¹š) ë¦¬ìŠ¤íŠ¸ ì¶”ì¶œ
        var netWorth = util_calculateNetWorth(room.users[uid], room);
        assets.push(Math.max(0, netWorth));
    }
    
    var n = assets.length;
    if (n < 2) return 0; // ë¹„êµ ëŒ€ìƒì´ 2ëª… ë¯¸ë§Œì´ë©´ ê³„ì‚° ë¶ˆê°€
    
    assets.sort(function(a, b) { return a - b; }); // ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬ (ë¡œë Œì¸  ê³¡ì„  ê¸°ë°˜)
    
    var mean = assets.reduce(function(a, b) { return a + b; }, 0) / n;
    if (mean === 0) return 0;

    var sumDiff = 0;
    for (var i = 0; i < n; i++) {
        for (var j = 0; j < n; j++) {
            // ëª¨ë“  ìœ ì € ê°„ ìì‚° ì°¨ì´ì˜ ì ˆëŒ“ê°’ í•©ì‚°
            sumDiff += Math.abs(assets[i] - assets[j]);
        }
    }
    
    // ìµœì¢… ì§€ë‹ˆ ê³„ìˆ˜ ì‚°ì¶œ (Gini Index ê³µì‹)
    return sumDiff / (2 * n * n * mean);
}

//==========ì„¹í„°9==========

/**
 * [ì‹ ì„¤: ì§€ëŠ¥í˜• ë¹ˆë¶€ê²©ì°¨ êµì • ë°°ìœ¨] v1.0
 * ê¸°ëŠ¥: ì§€ë‹ˆ ê³„ìˆ˜ì— ë”°ë¼ ìì‚°ê°€ì—ê²ŒëŠ” ëˆ„ì§„ì„¸ë¥¼, ì„œë¯¼ì—ê²ŒëŠ” ë³´ë„ˆìŠ¤ë¥¼ ë¶€ì—¬í•˜ëŠ” ì§€ëŠ¥í˜• ìˆ˜ì¹˜ë¥¼ ë°˜í™˜
 */
function util_getGiniCorrection(user, roomName) {
    var data = getDatabase(); // [ìˆ˜ì •] ë°ì´í„° ë¡œë“œë¥¼ ìµœìƒë‹¨ìœ¼ë¡œ ì´ë™
    if (!data || !data.rooms || !data.rooms[roomName]) return { tax: 1.0, reward: 1.0, level: "ì•ˆì •" };

    var logicRoom = (ALLOWED_ROOMS.indexOf(roomName) === -1) ? "ë‚´ë¦¬ë‹¤" : roomName;
    if (!data.rooms[logicRoom]) return { tax: 1.0, reward: 1.0, level: "ì•ˆì •" };

    var gini = util_calculateGini(logicRoom);
    var conf = INTELLIGENT_CONFIG.ECONOMY;
    
    if (gini < conf.GINI_CRITICAL) return { tax: 1.0, reward: 1.0, level: "ì•ˆì •" };

    var today = getSimpleDate();
    if (data.lastGiniAlertDate !== today) {
        data.lastGiniAlertDate = today; 
        var alertMsg = util_formatSecurityLog("ğŸš¨ [ECONOMY: ë¹ˆë¶€ê²©ì°¨ ê²½ë³´]", "SYSTEM", logicRoom, 
            "ğŸ“Š ì§€ë‹ˆê³„ìˆ˜: " + gini.toFixed(3), "3ë‹¨ê³„ ê³„ì¸µë³„ ì°¨ë“± ìˆ˜ì¹™ ê°€ë™");
        try { Api.replyRoom("ë² ë¦­ë°©", alertMsg); } catch(e) {}
    }

    var percentile = util_getNetWorthPercentile(user, logicRoom);
    var intensity = (gini - conf.GINI_CRITICAL) / (1 - conf.GINI_CRITICAL);
    
    // ê¸°ë³¸ê°’ (ì¤‘ì‚°ì¸µ)
    var res = { tax: 1.0, reward: 1.0, level: "ì¤‘ì‚°ì¸µ" };

    if (percentile <= 15) {
        // ìƒë¥˜ì¸µ (ì—˜ë¦¬íŠ¸): ëˆ„ì§„ì„¸ ì ìš© (ìµœëŒ€ +50%)
        res.tax = 1.0 + (conf.MAX_PROGRESSIVE_TAX * intensity);
        res.level = "ìƒë¥˜ì¸µ(ëˆ„ì§„)";
    } else if (percentile >= 70) {
        // ë¶€ì–‘ì¸µ (ì„œë¯¼): ë³´ìƒ ê°•í™” (ìµœëŒ€ 1.5ë°°)
        res.reward = 1.0 + ((conf.REWARD_BOOST_LIMIT - 1.0) * intensity);
        res.level = "ë¶€ì–‘ì¸µ(ì§€ì›)";
    }
    
    return res;
}

/**
 * [ê³µí†µ í•¨ìˆ˜: ë¬¼ê°€ ë°°ìœ¨ í†µí•© ì—”ì§„] v5.9
 * ê¸°ëŠ¥: íŠ¹ì • ë°©ì˜ ê²½ì œ ì§€í‘œë¥¼ ë¶„ì„í•˜ì—¬ í˜„ì¬ì˜ ìµœì¢… ë¬¼ê°€ ë°°ìœ¨(Multiplier)ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
 * ìš©ë„: ìƒì ê°€ ì¡°ì ˆ, ì¶œì„ ë³´ìƒ ì¡°ì ˆ, ì±„êµ´ íš¨ìœ¨ ì¡°ì ˆ ë“±
 */
function util_getEcoMultiplier(roomName) {
    var data = getDatabase();
    var roomData = data.rooms[roomName];
    if (!roomData || !roomData.economyBase || roomData.economyBase <= 0) return 1.0;

    // ì„¹í„° 8ì˜ í†µí•© ê²½ì œ ì§€í‘œ í˜¸ì¶œ (ì±„ê¶Œ/ë¶€ì±„ ë°˜ì˜ ìˆ˜ì¹˜)
    var currentEco = calculateEconomy(data, roomName);
    var rawRatio = currentEco.total / roomData.economyBase; 
    
    var damping = (data.economyDamping !== undefined) ? data.economyDamping : 0.3;
    
    // ë¬¼ê°€ ë°°ìœ¨ì´ 1.2ë°°ë¥¼ ì´ˆê³¼í•  ê²½ìš°, ì™„ì¶©ë ¥ì„ ì¡°ì •í•˜ì—¬ ìƒìŠ¹ ì–µì œ
    if (rawRatio > 1.2) {
        damping = Math.min(0.5, damping + (rawRatio - 1.2) * 0.5);
    }
    var multiplier = 1 + (rawRatio - 1) * damping;
    
    if (multiplier > 2.0) {
        var inflationBody = "ğŸ“ˆ ë‚´ìš©: í•˜ì´í¼ ì¸í”Œë ˆì´ì…˜ ì§•í›„ ê°ì§€\n" +
                            "ğŸ’° í˜„ì¬ ë¬¼ê°€ ë°°ìœ¨: x" + multiplier.toFixed(2);
        var inflationMsg = util_formatSecurityLog("ğŸš¨ [ECONOMY: ë¬¼ê°€ í­ë“± ìœ„í—˜]", "MARKET", roomName, inflationBody, "ë¬¼ê°€ ì™„ì¶© ì—”ì§„(Damping) ì‘ë™ ì—¬ë¶€ ì ê²€ ê¶Œê³ ");
        try { Api.replyRoom("ë² ë¦­ë°©", inflationMsg); } catch(e) {}
    }

    // ìµœì†Œ ë°°ìœ¨ ì œí•œ (í•˜í•œì„  0.5ë°°)
    return Math.max(0.5, multiplier);
}

/**
 * [ì‹œìŠ¤í…œ] ì•„ì´í…œ ê°€ê²© ê³„ì‚° í•¨ìˆ˜
 * ê¸°ëŠ¥: í†µí•© ì—”ì§„ ë°°ìœ¨ì„ ì ìš©í•˜ì—¬ ì‹¤ì‹œê°„ ë‹¨í’ˆê°€(1ê°œ ê°€ê²©)ë¥¼ ì‚°ì¶œí•©ë‹ˆë‹¤.
 */
function getItemPrice(item, user, roomName) {
    var logicRoom = (ALLOWED_ROOMS.indexOf(roomName) === -1) ? "ë‚´ë¦¬ë‹¤" : roomName;
    var multiplier = util_getEcoMultiplier(logicRoom);
    var giniCorr = util_getGiniCorrection(user, logicRoom);

    // [ì •ë¶€ ì •ì±… ì—°ë™] í˜„ì¬ ì‹œí–‰ ì¤‘ì¸ ì •ì±… ë¡œë“œ
    var data = getDatabase();
    var pol = util_getActivePolicy(data.rooms[logicRoom]);

    // ê¸°ì´ˆê°€(Base) ì„¤ì •: ë¬´ì—­ ë¬¼í’ˆì¼ ê²½ìš° ì„¹í„° 1ì˜ ìƒìˆ˜ë¥¼ ìš°ì„  ì°¸ì¡°
    var rawPrice = Number(item.price);
    if (item.effect === "trade_cargo" && item.value) {
        var tradeCfg = SYSTEM_CONFIG.TRADE;
        rawPrice = (tradeCfg.GOODS_COST && tradeCfg.GOODS_COST[item.value]) ? tradeCfg.GOODS_COST[item.value] : rawPrice;
    }

    var basePrice = Math.floor(rawPrice * multiplier * giniCorr.tax * (pol.shopPriceMult || 1.0));

    // ìµœì¢… ê¸°ë³¸ê°€ ì‚°ì¶œ: (ì›ê°€ * ë¬¼ê°€ë°°ìœ¨ * ì§€ë‹ˆëˆ„ì§„ì„¸)
    var basePrice = Math.floor(rawPrice * multiplier * giniCorr.tax);

    // [ìˆ˜ì§‘ëŒ€ë§ˆì™•] ëª¨ë“  ìƒì  êµ¬ë§¤ê°€ 15% í• ì¸
    if (user.title === "ìˆ˜ì§‘ëŒ€ë§ˆì™•") {
        basePrice = Math.floor(basePrice * 0.85);
    }

    // [ìŠ¹ê¸‰ê¶Œ ëˆ„ì  í• ì¦] êµ¬ë§¤í•  ë•Œë§ˆë‹¤ ê¸°ë³¸ê°€ì˜ 10%ì”© ì˜êµ¬ í• ì¦
    if (item.id === 8) { 
        var boughtCount = Number(user.purchasedPromotionAttempts || 0);
        var surchargeUnit = Math.floor(basePrice * 0.10); // ê¸°ë³¸ê°€ì˜ 10% ì‚°ì¶œ
        return basePrice + (surchargeUnit * boughtCount); 
    }

    return basePrice;
}

/**
 * [Gemini ì •ë°€ êµì •] ê²½ì œ ë¶€ì–‘ ì§€ì›ê¸ˆ ì²´í¬ í•¨ìˆ˜ (ì¤‘ë³µ ì„ ì–¸ ì œê±° ë° í†µí•©)
 */
function checkEconomicStimulus(user, roomName, isManual) {
    if ((user.totalAttendance || 0) < 2) return;
    
    var currentCount = user.dailyStimulusCount || 0;
    if (currentCount >= 1) return;

    var data = getDatabase();
    if (!data) return;
    
    var eco = calculateEconomy(data, roomName);
    var avgAsset = eco.average;
    var roomData = data.rooms[roomName];
    var myNetWorth = util_calculateNetWorth(user, roomData);

    // 1. ì§€ê¸‰ ê¸°ì¤€ì„ : í‰ê·  ìˆœìì‚°ì˜ 70% ë¯¸ë§Œìœ¼ë¡œ ì™„í™” (ê¸°ì¡´ 40%)
    var targetLine = Math.floor(avgAsset * 0.7);
    
    if (myNetWorth < targetLine) {
        var multiplier = util_getEcoMultiplier(roomName);
        var giniCorr = util_getGiniCorrection(user, roomName);
        var gap = targetLine - myNetWorth;
        var emergencyMult = util_getEmergencyMultiplier(roomName);

        // [ì •ë¶€ ì •ì±… ì—°ë™] ì¸í”Œë ˆì´ì…˜ ì–µì œ ì •ì±… ë¡œë“œ
        var pol = util_getActivePolicy(roomData);

        // 2. ì§€ì›ê¸ˆì•¡: í‰ê·  ìˆœìì‚°ì˜ 10%ë¥¼ ê¸°ë³¸ ì§€ê¸‰ì•¡ìœ¼ë¡œ ì„¤ì • (ê¸°ì¡´ 10,000P ê³ ì •)
        var baseRewardAmount = Math.floor(avgAsset * 0.1);
        
        // ê°ì¢… ê²½ì œ ìŠ¹ìˆ˜(ë¬¼ê°€, ê¸´ê¸‰ìƒí™©, ì§€ë‹ˆê³„ìˆ˜, ì •ë¶€ì •ì±…)ë¥¼ ì ìš©í•˜ì—¬ ìµœì¢… ê¸ˆì•¡ ì‚°ì¶œ
        var baseGive = Math.floor(baseRewardAmount * multiplier * emergencyMult * giniCorr.reward * (pol.globalRewardMult || 1.0));
        
        // ê¸°ì¤€ì„ (70%)ì„ ì´ˆê³¼í•˜ì—¬ ì§€ê¸‰ë˜ì§€ ì•Šë„ë¡ ë³´ì •
        var giveAmount = Math.min(baseGive, gap);

        // [ì‹ ê·œ] ì‹ ìš©ë¶ˆëŸ‰ì í˜ë„í‹°: ë¯¼ìƒì§€ì›ê¸ˆ 20% ì‚­ê°
        if (Number(user.creditScore || 600) < 500) {
            giveAmount = Math.floor(giveAmount * 0.8);
        }
        
        if (giveAmount < 100 || !util_isBankSolvent(roomName, giveAmount)) return;

        util_updatePoint(user, roomData, giveAmount, "ë¯¼ìƒì§€ì›ê¸ˆ ì§€ê¸‰", roomName);
        user.dailyStimulusCount = currentCount + 1;

        var msg = "\nê²½ì œ ìœ„ê¸° ê·¹ë³µì„ ìœ„í•œ ê¸´ê¸‰ ë¯¼ìƒì§€ì›ê¸ˆì´ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.\n" +
                  "ğŸ’° ì§€ì›ê¸ˆì•¡: +" + fp(giveAmount) + "P";

        Api.replyRoom(roomName, formatCommand("ğŸ ë¯¼ìƒì§€ì›ê¸ˆ ì•ˆë‚´", user, msg, "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
        safeSaveData(data);
    }
}


//==========ì„¹í„°10==========

/* ì‹ ìš© ì •ë³´ ê³„ì‚° í•¨ìˆ˜ (ìƒìˆ˜ ì—°ë™) */
function getCreditInfo(score, roomName) {
    var s = Number(score || 600);
    var conf = SYSTEM_CONFIG.ECO.CREDIT;
    var data = getDatabase();
    var roomData = data.rooms[roomName || "ë‚´ë¦¬ë‹¤"];
    
    // 00ì‹œì— í™•ì •ëœ í‰ê·  ìì‚° í˜¸ì¶œ
    var avgAsset = (roomData && roomData.features && roomData.features.government) ? 
                   Number(roomData.features.government.dailyAvgAsset || 420000) : 420000;

    // [í•µì‹¬ ë¹„ìœ¨ ê³µì‹]: í˜„ì¬ í‰ê·  ìì‚° / ê¸°ì¤€ì (420,000P)
    // ì˜ˆ: í‰ê· ì´ 63ë§ŒPë©´ ë°°ìœ¨ì€ 1.5ë°°ê°€ ë¨
    var assetRatio = avgAsset / 420000;

    for(var i=0; i<conf.SCORES.length; i++) {
        if(s >= conf.SCORES[i]) {
            return { 
                grade: i+1, 
                limit: Math.floor(conf.LIMITS[i] * assetRatio), // ê¸°ë³¸í•œë„ * ë¹„ìœ¨ ì ìš©
                label: conf.LABELS[i], 
                rate: conf.RATES[i], 
                icon: conf.ICONS[i] 
            };
        }
    }
    // ë§ˆì§€ë§‰ ë“±ê¸‰ (ì‹ ìš©ë¶ˆëŸ‰)
    var lastIdx = conf.SCORES.length;
    return { 
        grade: lastIdx+1, 
        limit: Math.floor(conf.LIMITS[lastIdx] * assetRatio), 
        label: conf.LABELS[lastIdx], 
        rate: conf.RATES[lastIdx], 
        icon: conf.ICONS[lastIdx] 
    };
}

/* ì‹ ìš© í•œë„ í‘œ ìƒì„± í•¨ìˆ˜ (ë¹„ìœ¨ì œ ë°˜ì˜) */
function getCreditLimitTable(roomName) {
    var conf = SYSTEM_CONFIG.ECO.CREDIT;
    var list = [];
    var data = getDatabase();
    var roomData = data.rooms[roomName || "ë‚´ë¦¬ë‹¤"];
    
    // 1. í‰ê·  ìì‚° ë¹„ë¡€ ë°°ìœ¨ ê³„ì‚° (ê¸°ì¤€ì  420,000P)
    var avgAsset = (roomData && roomData.features && roomData.features.government) ? 
                   Number(roomData.features.government.dailyAvgAsset || 420000) : 420000;
    var assetRatio = avgAsset / 420000;

    // 2. í˜„ì¬ ì‹œì¥ ìŠ¹ìˆ˜(dynMult) ì‹¤ì‹œê°„ í˜¸ì¶œ
    var dynMult = 1.0;
    if (typeof util_getDynamicRateMultiplier === 'function') {
        dynMult = util_getDynamicRateMultiplier(roomName);
    }

    // 3. 1ë“±ê¸‰ ~ 5ë“±ê¸‰ ë£¨í”„ ì²˜ë¦¬
    for(var i=0; i<conf.SCORES.length; i++) {
        var baseRatePct = (conf.RATES[i] - 1) * 100;
        var appliedRate = (baseRatePct * dynMult).toFixed(1); // ì‹œì¥ ìŠ¹ìˆ˜ ì ìš© ë° ì†Œìˆ˜ì  ê³ ì •
        var dynamicLimit = Math.floor(conf.LIMITS[i] * assetRatio); // í‰ê·  ìì‚° ë¹„ë¡€ í•œë„ ì ìš©
        
        list.push(conf.ICONS[i] + " " + conf.LABELS[i] + " (" + conf.SCORES[i] + "ì ~): " + appliedRate + "%\n(í•œë„ " + fp(dynamicLimit) + "P)");
    }
    
    var lastIdx = conf.SCORES.length; 
    var lastBaseRate = (conf.RATES[lastIdx] - 1) * 100;
    var lastApplied = (lastBaseRate * dynMult).toFixed(1); 
    var lastDynamicLimit = Math.floor(conf.LIMITS[lastIdx] * assetRatio);
    
    list.push(conf.ICONS[lastIdx] + " " + conf.LABELS[lastIdx] + " (<" + conf.SCORES[lastIdx-1] + "): " + lastApplied + "%\n(í•œë„ " + fp(lastDynamicLimit) + "P)");
    
    return list.join("\n");
}

/**
 * [ìˆ˜ì •] ë‹‰ë„¤ì„ í‘œì‹œ ìƒì„± í•¨ìˆ˜ (ì¹­í˜¸ ì „ìš© ì•„ì´ì½˜ ìë™ ë…¸ì¶œ ì‹œìŠ¤í…œ)
 * [Gemini ìš”ì²­ ì‚¬í•­ ë°˜ì˜]: ì¹­í˜¸ ì¥ì°© ì‹œ ì¸ë²¤í† ë¦¬ì—ì„œ í•´ë‹¹ ì¹­í˜¸ì˜ ì•„ì´ì½˜ì„ ì°¾ì•„ ìë™ìœ¼ë¡œ ì ‘ë‘ì‚¬ì— ë¶™ì…ë‹ˆë‹¤.
 */
function getDisplayName(user) {
    if (!user) return "ì•Œ ìˆ˜ ì—†ìŒ";
    var userIcon = user.icon || "";
    var tierIcon = (user.tier === 9 ? "ğŸ†" : ""); 
    var credit = getCreditInfo(user.creditScore || 600);
    
    var titleStr = "";
    
    // 1ìˆœìœ„: ì‹ ìš©ë¶ˆëŸ‰ìì¼ ê²½ìš° ë¬´ì¡°ê±´ [ì‹ ìš©ë¶ˆëŸ‰ì] í‘œì‹œ
    if (credit.label === "ì‹ ìš©ë¶ˆëŸ‰ì") {
        titleStr = "[ì‹ ìš©ë¶ˆëŸ‰ì] ";
    } 
    // 2ìˆœìœ„: ì¼ë°˜ ìƒíƒœì¼ ë•Œ ì¥ì°© ì¤‘ì¸ ì¹­í˜¸ í‘œì‹œ (ì•„ì´ì½˜ ì œí•œ ë¡œì§)
    else if (user.title && user.title.length > 0) {
        var titleIcon = "";
        
        // [Gemini ê·œì¹™]: ë„êµ´ì™•, ìˆ˜ì§‘ëŒ€ë§ˆì™•ë§Œ ì¸ë²¤í† ë¦¬ì—ì„œ ì•„ì´ì½˜ì„ ì°¾ì•„ í•©ì¹©ë‹ˆë‹¤.
        var specialTitles = ["ë„êµ´ì™•", "ìˆ˜ì§‘ëŒ€ë§ˆì™•", "í•´ìƒì™•", "í•´ì ì™•", "ì œí•´ì™•"];
        
        if (specialTitles.indexOf(user.title) !== -1) {
            if (user.inventory && user.inventory.length > 0) {
                for (var i = 0; i < user.inventory.length; i++) {
                    var item = user.inventory[i];
                    if (item.effect === "title" && item.title === user.title) {
                        titleIcon = item.icon || ""; 
                        break;
                    }
                }
            }
        }
        
        // titleIconì´ ë¹„ì–´ìˆìœ¼ë©´(ê·¸ ì™¸ ì¹­í˜¸ë“¤) ìë™ìœ¼ë¡œ [ì¹­í˜¸ëª…]ë§Œ ì¶œë ¥ë©ë‹ˆë‹¤.
        titleStr = "[" + titleIcon + user.title + "] ";
    }
    
    return titleStr + tierIcon + userIcon + (user.name || "ì•Œ ìˆ˜ ì—†ìŒ");
}

/* [ìˆ˜ì •] ê´€ë¦¬ì ì—¬ë¶€ í™•ì¸ í•¨ìˆ˜ (FIXED_ADMINS ì²´í¬ ì¶”ê°€) */
function isAdmin(sender, data, uid) {
    if (!sender) return false;
    // [ìˆ˜ì •] ë‹‰ë„¤ì„ ë‚´ë¶€ì˜ ëª¨ë“  ê³µë°±ì„ ì œê±°í•˜ì—¬ ë¹„êµ (ì •í™•ë„ 100%)
    var cleanInputName = String(sender).replace(/\s/g, "");
    
    // ë§ˆìŠ¤í„° ë‹‰ë„¤ì„ ë¦¬ìŠ¤íŠ¸ë„ ê³µë°± ì œê±° í›„ ë¹„êµ
    var masterMatched = FIXED_ADMINS.some(function(adminName) {
        return adminName.replace(/\s/g, "") === cleanInputName;
    });
    
    if (masterMatched) return true;
    if (uid && adminUIDs.indexOf(uid) !== -1) return true;

    // ë¶€ê´€ë¦¬ì ëª…ë‹¨ ì²´í¬
    if (data && data.admins) {
        var adminMatched = data.admins.some(function(name) {
            return name.replace(/\s/g, "") === cleanInputName;
        });
        if (adminMatched) return true;
    }

    return false;
}

//==========ì„¹í„°11==========

/**
 * [v11.9 ì‹ ì„¤] ë³´ì•ˆ í†µí•© ì•Œë¦¼ í”„ë¡œí† ì½œ ì—”ì§„
 * ëª¨ë“  ì‹œìŠ¤í…œ ì¥ì•  ë° ë³´ì•ˆ ì•Œë¦¼ì˜ UIë¥¼ í‘œì¤€í™”í•©ë‹ˆë‹¤.
 */
function util_formatSecurityLog(header, user, room, body, action) {
    return header + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
           "ğŸ‘¤ ëŒ€ìƒ/ìœ ì €: " + user + "\n" +
           "ğŸ“ ë°œìƒ ì¥ì†Œ: " + room + "\n" +
           body + "\n" +
           "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
           "ğŸ›¡ï¸ ì¡°ì¹˜: " + action;
}

function util_checkUserState(user, uid, roomName, isJobActivity) {
    if (typeof util_scrubNativeObject === 'function') util_scrubNativeObject(user);
    var now = Date.now();
    var data = getDatabase();
    
    // ì°¸ì¡° ë³€ìˆ˜ ì„ ì–¸: ì—ëŸ¬ì˜ ì›ì¸ì¸ dDataì™€ aTheftsë¥¼ ëª…í™•íˆ ì •ì˜í•©ë‹ˆë‹¤.
    var logicRoom = (ALLOWED_ROOMS.indexOf(roomName) === -1) ? "ë‚´ë¦¬ë‹¤" : roomName;
    var rObj_internal = data.rooms[logicRoom] || data.rooms["ë‚´ë¦¬ë‹¤"];
    var dData = (rObj_internal.features && rObj_internal.features.states) ? rObj_internal.features.states.duelData : {};
    var aThefts = (rObj_internal.features && rObj_internal.features.states) ? rObj_internal.features.states.activeThefts : {};
    var activePillages = (data.rooms["ë‚´ë¦¬ë‹¤"].features) ? (data.rooms["ë‚´ë¦¬ë‹¤"].features.activePillages || {}) : {};

    // [ê°œí¸] ì „ êµ¬ì—­ ì„¸ì…˜ ìŠ¤ìº”: ì–´ëŠ ë°©ì—ì„œë“  ì…ë ¥ ëŒ€ê¸° ì¤‘ì´ë¼ë©´ 'í™œë™ ì¤‘'ìœ¼ë¡œ ê°„ì£¼
    for (var rN in data.rooms) {
        var rObj = data.rooms[rN];
        if (rObj.features && rObj.features.states) {
            var s = rObj.features.states;
            var qKeys = ["menuWait", "bankProcess", "selectWait", "lottoPurchase"];
            qKeys.forEach(function(k) {
                if (s[k] && s[k][uid]) {
                    var currentSession = s[k][uid];
                    // ì„¸ì…˜ ë°œìƒì§€ê°€ í˜„ì¬ ë°©ì´ ì•„ë‹ˆë¼ë©´, ì°¨ë‹¨í•˜ì§€ ì•Šê³  í•´ë‹¹ ì„¸ì…˜ì„ ì¦‰ì‹œ ì´ˆê¸°í™”(ì‚­ì œ)
                    if (currentSession.originRoom !== roomName) {
                        delete s[k][uid]; 
                        // [ì„ íƒ ì‚¬í•­] ë¡œê·¸ë¥¼ ë‚¨ê²¨ ì´ˆê¸°í™” ì—¬ë¶€ë¥¼ ê´€ë¦¬ìê°€ í™•ì¸í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.
                        Log.info("ğŸ§¹ [Session Cleanup] " + user.name + "ë‹˜ì˜ íƒ€ êµ¬ì—­ ì„¸ì…˜ ê°•ì œ ì´ˆê¸°í™” (" + (currentSession.originRoom || rN) + ")");
                    }
                }
            });
        }
    }

    // 1. í•´ìƒ í™œë™(isJobActivity: true) ê²€ì¦ ì‹œ: í•´ì „ íŒ¨ë°° íƒ€ì´ë¨¸ë§Œ ì²´í¬
    if (isJobActivity === true) {
        // [í•´êµ°] í›„í‡´/ì •ë¹„ ìƒíƒœ ì²´í¬ (15ë¶„ í˜ë„í‹°)
        if (user.retreatEndTime && now < user.retreatEndTime) {
            var diffR = user.retreatEndTime - now;
            var remainMinR = Math.ceil(diffR / (1000 * 60));
            return { canAction: false, reason: "í˜„ì¬ í•´ì „ íŒ¨ë°°ë¡œ ì¸í•´ í›„í‡´ ì •ë¹„ ì¤‘ì…ë‹ˆë‹¤. (" + remainMinR + "ë¶„ ë‚¨ìŒ)" };
        }
        // [í•´ì ] ì•½íƒˆ ì¿¨íƒ€ì„/í•´ìƒ ì§•ì—­ ì²´í¬
        if (user.pillageCooldownEndTime && now < user.pillageCooldownEndTime) {
            var diffP = user.pillageCooldownEndTime - now;
            var remainMinP = Math.ceil(diffP / (1000 * 60));
            return { canAction: false, reason: "í˜„ì¬ í•¨ëŒ€ ì¬ì •ë¹„(í•´ìƒ ì§•ì—­) ì¤‘ì…ë‹ˆë‹¤. (" + remainMinP + "ë¶„ ë‚¨ìŒ)" };
        }

    // [ì‹ ê·œ] í•´ìƒ êµì „(ì•½íƒˆ/í† ë²Œ) ì§„í–‰ ìƒíƒœ ì²´í¬ - í•´ìƒ í™œë™ ì‹œì—ë§Œ ì°¨ë‹¨
        if (activePillages[uid]) return { canAction: false, reason: "í˜„ì¬ í•´ì ì—ê²Œ ìŠµê²©ë°›ì•„ êµì „ ì¤‘ì…ë‹ˆë‹¤!" };
        
        for (var pKey in activePillages) {
            var pEntry = activePillages[pKey];
            if (pEntry.pirateUid === uid) return { canAction: false, reason: "í˜„ì¬ ë‹¤ë¥¸ ì„ ë°•ì„ ì•½íƒˆ ì¤‘ì¸ ìƒíƒœì…ë‹ˆë‹¤." };
        }

        // [í•´êµ°] í˜¸ìœ„ ì¤‘ ìƒíƒœ ì²´í¬ - í•´ìƒ í™œë™ ì‹œì—ë§Œ ì°¨ë‹¨
        if (user.job === 'navy') {
            for (var rN in data.rooms) {
                var rO = data.rooms[rN];
                for (var uI in rO.users) {
                    var targetV = rO.users[uI].voyage;
                    if (targetV && targetV.active === true && targetV.escortUid === uid && Date.now() < targetV.arrival) {
                         return { canAction: false, reason: "í˜„ì¬ ìƒì„ ì„ í˜¸ìœ„ í•­í•´ ì¤‘ì´ë¯€ë¡œ ë‹¤ë¥¸ í•´ìƒ ì„ë¬´ê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤." };
                    }
                }
            }
        }
    }

    // 2. ì¼ë°˜ í™œë™(ë„ë°•/ì€í–‰/ê´‘ì‚° ë“±) ê²€ì¦ ì‹œ: ë„ë‘‘ì§ˆ ì§•ì—­ë§Œ ì²´í¬
    else {
        // [ë„ë‘‘ì§ˆ] ì§•ì—­ ìƒíƒœ ì²´í¬
        if (user.jailReleaseTime && now < user.jailReleaseTime) {
            var diff = user.jailReleaseTime - now;
            var remainMin = Math.ceil(diff / (1000 * 60));
            var timeStr = remainMin >= 60 ? Math.ceil(remainMin / 60) + "ì‹œê°„" : remainMin + "ë¶„";
            return { canAction: false, reason: "í˜„ì¬ ë„ë‘‘ì§ˆ ì£„ë¡œ ì§•ì—­ ì¤‘ì…ë‹ˆë‹¤. (" + timeStr + " ë‚¨ìŒ)" };
        }
    }

    // 3. ê´‘ì‚° ì±„êµ´ ìƒíƒœ ì²´í¬ (ì •ì˜ëœ isJobActivityë¥¼ ì •ìƒ ì°¸ì¡°)
    if (user.mining && user.mining.active && !isJobActivity) {
        return { canAction: false, isMining: true, reason: "í˜„ì¬ ê´‘ì‚°ì—ì„œ ì±„êµ´ ì‘ì—… ì¤‘ì…ë‹ˆë‹¤." };
    }

    // 4. ê²°íˆ¬ ì§„í–‰ ìƒíƒœ ì²´í¬ (ë°©ë³„ ë°ì´í„° ì°¸ì¡°í˜•ìœ¼ë¡œ êµì •)
    if (dData[uid]) return { canAction: false, reason: "í˜„ì¬ ê²°íˆ¬ ì‹ ì²­ì„ ë°›ì€ ìƒíƒœì…ë‹ˆë‹¤." };
    for (var dKey in dData) {
        if (dData[dKey].challengerUid === uid) return { canAction: false, reason: "í˜„ì¬ íƒ€ì¸ì—ê²Œ ê²°íˆ¬ë¥¼ ì‹ ì²­í•œ ìƒíƒœì…ë‹ˆë‹¤." };
    }

    // 5. ë„ë‘‘ì§ˆ ì§„í–‰ ìƒíƒœ ì²´í¬ (ë°©ë³„ ë°ì´í„° ì°¸ì¡°í˜•ìœ¼ë¡œ êµì •)
    if (aThefts[uid]) return { canAction: false, reason: "í˜„ì¬ ë„ë‘‘ì§ˆì˜ í‘œì ì´ ë˜ì–´ ë°©ì–´ ì¤‘ì…ë‹ˆë‹¤." };
    for (var vKey in aThefts) {
        if (aThefts[vKey].thiefUid === uid) return { canAction: false, reason: "í˜„ì¬ ë‹¤ë¥¸ ìœ ì €ë¥¼ í„¸ê³  ìˆëŠ” ì¤‘ì…ë‹ˆë‹¤." };
    }

    // 6. í•´ìƒ ì•½íƒˆ ë° êµì „ ì§„í–‰ ìƒíƒœ ì²´í¬ (ì‹¤ì‹œê°„ ì„¸ì…˜ ê°ì‹œ)
    // - ë‚´ê°€ ì•½íƒˆ ëŒ€ìƒ(ìƒì¸)ì¼ ë•Œ
    if (activePillages[uid]) return { canAction: false, reason: "í˜„ì¬ í•´ì ì—ê²Œ ìŠµê²©ë°›ì•„ êµì „ ì¤‘ì…ë‹ˆë‹¤!" };
    
    for (var pKey in activePillages) {
        var pEntry = activePillages[pKey];
        if (pEntry.pirateUid === uid) return { canAction: false, reason: "í˜„ì¬ ë‹¤ë¥¸ ì„ ë°•ì„ ì•½íƒˆ ì¤‘ì¸ ìƒíƒœì…ë‹ˆë‹¤." };
    }

    // [ì‹ ê·œ] í•´êµ° í˜¸ìœ„ ì¤‘ ìƒíƒœ ì •ë°€ ê²€ì¦ (ìƒì¸ íƒ€ì´ë¨¸ ì—°ë™)
    if (user.job === 'navy') {
        for (var rN in data.rooms) {
            var rO = data.rooms[rN];
            for (var uI in rO.users) {
                var targetV = rO.users[uI].voyage;
                // ìƒì¸ì˜ í•­í•´ê°€ í™œì„±í™” ìƒíƒœì´ê³ , ë‚´ê°€ í˜¸ìœ„í•¨ì´ë©°, ì•„ì§ ë„ì°© ì „(now < arrival)ì¼ ë•Œë§Œ 'ë°”ì¨' ì²˜ë¦¬
                if (targetV && targetV.active === true && targetV.escortUid === uid && Date.now() < targetV.arrival) {
                    var remainM = Math.ceil((targetV.arrival - Date.now()) / 60000);
                    // return { canAction: false, reason: "í˜„ì¬ ìƒì„ ì„ í˜¸ìœ„ í•­í•´ ì¤‘ì…ë‹ˆë‹¤. (" + remainM + "ë¶„ ë‚¨ìŒ)" };
                }
            }
        }
    }

    return { canAction: true, reason: "" };
}

/* ê¸°ì¡´ í˜¸í™˜ì„±ì„ ìœ„í•œ ë‹¨ìˆœ ì²´í¬ í•¨ìˆ˜ */
function isUserBusy(uid, roomName) {
    var data = getDatabase();
    var rName = roomName || "ë‚´ë¦¬ë‹¤";
    if (data.rooms[rName] && data.rooms[rName].users[uid]) {
        var res = util_checkUserState(data.rooms[rName].users[uid], uid, rName);
        return !res.canAction;
    }
    return false;
}

/* ìœ ì € ì´ë¦„ ê²€ìƒ‰ í•¨ìˆ˜ */
function findUserByName(roomData, name) {
    var res = [];
    var searchName = name.trim();
    if (searchName === "") return res; 
    for (var id in roomData.users) {
        var u = roomData.users[id];
        if (u.name === searchName) {
            return [{ id: id, data: u }];
        }
        if (u.name.indexOf(searchName) !== -1) {
            res.push({ id: id, data: u });
        }
    }
    return res;
}

/**
 * [ì‹ ì„¤] ì „ì—­ ìœ ì € ê²€ìƒ‰ ì—”ì§„ (Cross-Room Search)
 * ê¸°ëŠ¥: í˜„ì¬ ë°©ë¿ë§Œ ì•„ë‹ˆë¼ ëª¨ë“  ë°©ì˜ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë’¤ì ¸ì„œ ìœ ì €ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
 */
// ìˆ˜ì •: currentRoom ì°¸ì¡° ì˜¤ë¥˜ í•´ê²° ë° ì¸ì ê·œê²© í™•ì¥
function findUserGlobal(name, roomName) {
    var res = [];
    var searchName = name.trim();
    if (searchName === "") return res;
    
    var data = getDatabase();

    // [êµ¬ì—­ ê²©ë¦¬ ë¡œì§]: 
    // 1. í˜„ì¬ ë°©ì´ "ë‚´ë¦¬ë‹¤"ë¼ë©´ ê²€ìƒ‰ ëŒ€ìƒì„ ì˜¤ì§ ["ë‚´ë¦¬ë‹¤"]ë¡œ í•œì • (ì¤‘ë³µ ë°©ì§€)
    // 2. ê·¸ ì™¸(ë² ë¦­ë°©, 1:1ë°©)ë¼ë©´ ì „ì²´ ALLOWED_ROOMSë¥¼ ìŠ¤ìº” (ê´€ì œ ìœ ì§€)
    var roomsToScan = (roomName === "ë‚´ë¦¬ë‹¤") ? ["ë‚´ë¦¬ë‹¤"] : ALLOWED_ROOMS;

    for (var i = 0; i < roomsToScan.length; i++) {
        var rName = roomsToScan[i];
        var room = data.rooms[rName];
        if (!room || !room.users) continue;

       for (var id in room.users) {
            var u = room.users[id];
            if (u.name === searchName || u.name.indexOf(searchName) !== -1) {
                var roomDisplay = rName;
                if (rName === "ë‚´ë¦¬ë‹¤" && (u.hasSeenSyncNotice || u.is1to1Sync === true)) {
                    roomDisplay = "ë‚´ë¦¬ë‹¤ (1:1ì—°ë™)";
                }
                
                // roomNameì€ ì‹¤ì œ DB í‚¤ì¸ rNameì„ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ì—¬ í•˜ë‹¨ ë¡œì§ í¬ë˜ì‹œ ë°©ì§€
                res.push({ id: id, data: u, roomName: rName, roomDisplay: roomDisplay });
                }
        }
    }
    return res;
}

/* ì¤‘ë³µ ìœ ì € ì„ íƒ í•¸ë“¤ëŸ¬ í•¨ìˆ˜ (ì „ì—­ ëŒ€ì‘í˜•) */
function handleUserSelection(replier, targetUid, found, type, extra, user, roomName) {
    var data = getDatabase();
    var roomData = data.rooms[roomName];
    if (!roomData || !roomData.features) return;

    var safeFound = found.map(function(f) {
        return {
            id: f.id,
            roomName: f.roomName,       // ì‹¤ì œ DB ì ‘ê·¼ í‚¤ (ë‚´ë¦¬ë‹¤, í…ŒìŠ¤íŠ¸ ë“±)
            roomDisplay: f.roomDisplay, // UI ì¶œë ¥ìš© ì´ë¦„
            data: { 
                name: f.data.name, 
                point: Number(f.data.point || 0),
                bank: Number(f.data.bank || 0)
            }
        };
    });

    roomData.features.states.selectWait[targetUid] = { 
        timestamp: Date.now(), 
        results: safeFound, 
        type: type, 
        extra: extra,
        originRoom: roomName // ì¶”ê°€: íƒ€ì„ì•„ì›ƒ ë°œìƒ ì‹œ í•´ë‹¹ ë°©ì—ì„œë§Œ ì•Œë¦¼ì´ ê°€ë„ë¡ ë°© ì •ë³´ ì €ì¥
    };
    
    var list = [];
    for(var i=0; i<found.length; i++) {
        var f = found[i];
        var uPoints = f.data.point !== undefined ? fp(f.data.point) : "0";
        var shortId = f.id ? f.id.substring(0, 8) : "Unknown";
        list.push((i + 1) + ". [" + f.roomDisplay + "] " + f.data.name + " (" + uPoints + "P) [" + shortId + "]");
    }

    replier.reply(formatCommand("ğŸ” ì „ì—­ ì¤‘ë³µ ìœ ì € ì„ íƒ", user, "ê´€ë¦¬í•˜ì‹¤ ëŒ€ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.\n\n" + list.join("\n") + "\n\n(ì·¨ì†Œ: [ì·¨ì†Œ])", "ì…ë ¥ ëŒ€ê¸°: 30ì´ˆ"));
}

/**
 * [ì‹ ì„¤] ì¤‘ë³µ ì¢…ëª© ì„ íƒ í•¸ë“¤ëŸ¬
 */
function handleStockSelection(replier, targetUid, found, type, qty, user, roomName) {
    var data = getDatabase();
    var roomData = data.rooms[roomName];
    if (!roomData || !roomData.features) return;

    roomData.features.states.selectWait[targetUid] = { 
        timestamp: Date.now(), 
        results: found, 
        type: type,     
        extra: { amount: qty } 
    };
    var list = found.map(function(name, i) { return (i + 1) + ". " + name; });
    replier.reply(formatCommand("ğŸ” ì¢…ëª© ì„ íƒ", user, "ì—¬ëŸ¬ ì¢…ëª©ì´ ê²€ìƒ‰ë˜ì—ˆìŠµë‹ˆë‹¤.\në²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.\n\n" + list.join("\n") + "\n\n(ì·¨ì†Œ: [ì·¨ì†Œ])", "ì…ë ¥ ëŒ€ê¸°: 30ì´ˆ"));
}

/**
 * [ì‹ ì„¤: ì›ìì  ì‹ ë¶„ ë™ê¸°í™” ì—”ì§„] v1.0
 * ê¸°ëŠ¥: ìœ ì €ì˜ ë‹‰ë„¤ì„ ë³€ê²½ ì‹œ ì „ ì„œë²„ì˜ ëª¨ë“  ì°¸ì¡° ë°ì´í„°(ì‚¬ì±„, ê²½ë§ˆ ë“±)ë¥¼ ì¼ê´„ ê°±ì‹ í•©ë‹ˆë‹¤.
 * @param {String} uid - ìœ ì € ê³ ìœ  ID
 * @param {String} oldName - ë³€ê²½ ì „ ì´ë¦„
 * @param {String} newName - ë³€ê²½ í›„ ì´ë¦„
 */
function util_syncIdentityGlobal(uid, oldName, newName) {
    var data = getDatabase();
    var syncCount = 0;

    for (var rName in data.rooms) {
        var room = data.rooms[rName];
        
        // 1. ì‚¬ì±„ ê³„ì•½ì„œ(Loan Contracts) ë™ê¸°í™”
        if (room.loanContracts) {
            for (var cid in room.loanContracts) {
                var c = room.loanContracts[cid];
                if (c.borrowerUid === uid) { c.borrowerName = newName; syncCount++; }
                if (c.lenderUid === uid) { c.lenderName = newName; syncCount++; }
            }
        }

        // 2. ê²½ë§ˆ ë°°íŒ… ê¸°ë¡(Racing Bets) ë™ê¸°í™”
        if (room.features && room.features.racing && room.features.racing.bets) {
            var bets = room.features.racing.bets;
            if (bets[uid]) {
                bets[uid].name = newName;
                syncCount++;
            }
        }
        
        // 3. ì‚¬ì±„ ë“±ë¡ ë§¤ë¬¼(Loan Pools) ë™ê¸°í™”
        if (room.loanPools) {
            for (var pid in room.loanPools) {
                if (room.loanPools[pid].lenderUid === uid) {
                    room.loanPools[pid].lenderName = newName;
                    syncCount++;
                }
            }
        }
    }

    if (syncCount > 0) {
        Log.info("[AIS] " + oldName + " â” " + newName + " (" + syncCount + "ê°œ ë°ì´í„° ì›ìì  ë™ê¸°í™” ì™„ë£Œ)");
    }
}

/* ë‚ ì§œ ë° ì‹œì¦Œ ìœ í‹¸ í•¨ìˆ˜ */
function getSimpleDate() { var d = new Date(); return d.getFullYear() + "-" + ("0" + (d.getMonth() + 1)).slice(-2) + "-" + ("0" + d.getDate()).slice(-2); }
function getSimpleSeason() { var d = new Date(); return d.getFullYear().toString().slice(-2) + "-" + (d.getMonth() + 1) + "ì‹œì¦Œ"; }
function generateUUID() { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) { var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); }); }

/**
 * [ê³µí†µ í•¨ìˆ˜: ì¹­í˜¸ ìë™ ë¶€ì—¬ ì‹œìŠ¤í…œ] v6.0 (í‘œì¤€ í¬ë§· ì ìš©)
 */
function util_checkAndAwardTitle(user, replier, titleName, titleId, icon, committee, condition, guideText, roomName) {
    if (!user.inventory) user.inventory = [];
    
    var hasTitle = false;
    for (var i = 0; i < user.inventory.length; i++) {
        if (user.inventory[i].title === titleName) {
            hasTitle = true;
            break;
        }
    }
    if (hasTitle) return false;

    user.inventory.push({ 
        id: titleId, 
        name: "[" + titleName + "] ì¹­í˜¸", 
        icon: icon, 
        effect: "title", 
        title: titleName 
    });

    user.title = titleName;

    var winMsg = "ğŸŠ [" + committee + ": ì‘ìœ„ ìˆ˜ì—¬]\n" +
                 "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                 "ì¶•í•˜í•©ë‹ˆë‹¤! " + (user.name || "ìœ ì €") + "ë‹˜\n\n" +
                 condition + "ë¥¼ ëŒíŒŒí•˜ì—¬\n" +
                 "êµ­ê°€ ê³µì¸ [" + titleName + "] ì¹­í˜¸ë¥¼ í•˜ì‚¬ë°›ì•˜ìŠµë‹ˆë‹¤.\n\n" +
                 "âœ¨ ìƒíƒœ: [" + titleName + "] ìë™ ì¥ì°© ì™„ë£Œ\n" +
                 "ğŸ’¼ ë³´ê´€: ì˜êµ¬ ìì‚°ìœ¼ë¡œ ê°€ë°©ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.\n" +
                 "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                 "ğŸ’¡ " + guideText;

    // [ìˆ˜ì •] ì•Œë¦¼ ì „ì†¡ ì‹œ roomName ì¸ìê°€ ìˆìœ¼ë©´ í•´ë‹¹ ë°©ìœ¼ë¡œë§Œ ì „ì†¡
    try {
        if (replier && typeof replier.reply === 'function') {
            replier.reply(winMsg);
        } else {
            // roomNameì´ "ë² ë¦­ë°©"ìœ¼ë¡œ ë„˜ì–´ì˜¤ë©´ "ë² ë¦­ë°©"ìœ¼ë¡œë§Œ ë³´ëƒ…ë‹ˆë‹¤.
            Api.replyRoom(roomName || "ë‚´ë¦¬ë‹¤", winMsg);
        }
    } catch(e) {
        Log.error("Award Title Reply Error: " + e);
    }
    return true;
}

/**
 * [ì‹ ì„¤] ìˆœìì‚° ë°±ë¶„ìœ„ ê³„ì‚° ì—”ì§„
 * ê¸°ëŠ¥: í•´ë‹¹ ë°© ìœ ì €ë“¤ì˜ ìì‚°ì„ ì „ìˆ˜ ì¡°ì‚¬í•˜ì—¬ ë‚˜ì˜ ìƒëŒ€ì  ìœ„ì¹˜(ìƒìœ„ %)ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
 */
function util_getNetWorthPercentile(user, roomName) {
    try {
        var data = getDatabase();
        var roomObj = data.rooms[roomName || "ë‚´ë¦¬ë‹¤"];
        if (!roomObj || !roomObj.users) return 100;

        var netWorths = [];
        for (var uid in roomObj.users) {
            // ëª¨ë“  ìœ ì €ì˜ ì‹¤ì§ˆ ìˆœìì‚°(í˜„ê¸ˆ+ì˜ˆê¸ˆ+ë¶€ë™ì‚°-ë¹š) ë¦¬ìŠ¤íŠ¸ ìƒì„±
            var nw = util_calculateNetWorth(roomObj.users[uid], roomObj);
            netWorths.push(nw);
        }
        
        // ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (ìì‚° 1ë“±ì´ 0ë²ˆ ì¸ë±ìŠ¤)
        netWorths.sort(function(a, b) { return b - a; });

        var myNetWorth = util_calculateNetWorth(user, roomObj);
        var myRank = netWorths.indexOf(myNetWorth) + 1; // ë‚´ ë“±ìˆ˜
        var totalUsers = netWorths.length;

        // ë°±ë¶„ìœ¨ ê³„ì‚° (ìƒìœ„ 0% ~ 100%)
        return totalUsers > 0 ? (myRank / totalUsers) * 100 : 100;
    } catch (e) {
        Log.error("Percentile Calc Error: " + e);
        return 50; // ì—ëŸ¬ ì‹œ í‰ê· ì¹˜ ë°˜í™˜
    }
}

/**
 * [ì‹ ì„¤] ì§€ëŠ¥í˜• ì°¨ë“± ì†Œë“ì„¸ ë° UI ë°ì´í„° ìƒì„±ê¸°
 * ê¸°ì¤€: ìƒìœ„ 10% ì´ë‚´(7%), 30% ì´ë‚´(5%), ê·¸ ì™¸(3%)
 * ë°˜í™˜: { ì„¸ìœ¨%, ì°¨ê°ì•¡, ë‚´ìˆœìœ„%, ì„¸í›„ìˆ˜ìµ }
 */
function util_applyIncomeTax(user, income, roomName) {
    var percentile = util_getNetWorthPercentile(user, roomName);
    var rate = 0.03; // ê¸°ë³¸ 3% (ì„œë¯¼ì¸µ)

    if (percentile <= 10) {
        rate = 0.07; // ìƒìœ„ 10% (ìµœìƒìœ„ì¸µ)
    } else if (percentile <= 30) {
        rate = 0.05; // ìƒìœ„ 30% (ì¤‘ì‚°ì¸µ)
    }

    // [ì¶”ê°€] ê¸°ë¶€ì™• ì¹­í˜¸ íš¨ê³¼: ëª¨ë“  ì„¸ê¸ˆ 50% ê°ë©´ í˜œíƒ ì ìš©
    if (user.title === "ê¸°ë¶€ì™•") {
        rate = rate * 0.5;
    }

    var taxAmount = Math.floor(income * rate);
    var netIncome = income - taxAmount;

    return {
        ratePct: (rate * 100).toFixed(1),
        taxAmount: taxAmount,              // ì°¨ê°ë  ì„¸ê¸ˆ ì•¡ìˆ˜
        rankPct: Math.floor(percentile),   // UI í‘œì‹œìš© ë‚´ ìˆœìœ„ %
        netIncome: netIncome               // ì„¸ê¸ˆ ë–¼ê³  ë‚¨ì€ ì‹¤ì œ ìˆ˜ìµ
    };
}

/**
 * [ì‹ ê·œ ì¶”ê°€] ì‹ ìš© ë“±ê¸‰ë³„ ë¬´ì—­ ìˆ˜ìµ ë°°ìœ¨ ë°˜í™˜ ì—”ì§„
 * ê¸°ëŠ¥: ë“±ê¸‰(1~6)ì— ë”°ë¼ ìˆœìˆ˜ìµì˜ 90%~60% ì°¨ë“± ì§€ê¸‰ ë°°ìœ¨ì„ ê²°ì •í•©ë‹ˆë‹¤.
 */
function util_getTradeCreditMult(grade) {
    var mapping = { 
        1: 0.90, // 1ë“±ê¸‰: 90% ìˆ˜ë ¹
        2: 0.85, // 2ë“±ê¸‰: 85% ìˆ˜ë ¹
        3: 0.80, // 3ë“±ê¸‰: 80% ìˆ˜ë ¹
        4: 0.75, // 4ë“±ê¸‰: 75% ìˆ˜ë ¹
        5: 0.70, // 5ë“±ê¸‰: 70% ìˆ˜ë ¹
        6: 0.60  // ì‹ ìš©ë¶ˆëŸ‰ì: 60% ìˆ˜ë ¹
    };
    // ë“±ê¸‰ ì •ë³´ê°€ ì—†ìœ¼ë©´ ìµœí•˜ ë“±ê¸‰(60%) ë°°ìœ¨ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ë°˜í™˜í•©ë‹ˆë‹¤.
    return mapping[grade] || 0.60;
}

/**
 * [ì¶”ê°€] ì´ë… ìê²© ê²€ì¦ ì—”ì§„
 * ê¸°ëŠ¥: íŠ¹ì • ìœ ì €ê°€ í•´ë‹¹ í•­êµ¬ì˜ ì´ë…ì¸ì§€ ì—¬ë¶€ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
 * @param {String} targetUid - ìœ ì € UID
 * @param {String} portName - í•­êµ¬ ì´ë¦„
 * @param {Object} roomData - í•´ë‹¹ ë°©ì˜ ë°ì´í„° ê°ì²´
 */
function util_isUserGovernor(targetUid, portName, roomData) {
    if (!roomData || !roomData.features || !roomData.features.portData || !roomData.features.portData[portName]) return false;
    return roomData.features.portData[portName].governorUid === targetUid;
}

/**
 * [ì¶”ê°€] ìœ ì € ë³´ìœ  ì´ë… ê¶Œí•œ ëª©ë¡ ì¶”ì¶œ
 * ê¸°ëŠ¥: ìœ ì €ê°€ ì´ë…ìœ¼ë¡œ ì„ëª…ëœ ëª¨ë“  í•­êµ¬ì˜ ì´ë¦„ì„ ë°°ì—´ë¡œ ë°˜í™˜í•©ë‹ˆë‹¤.
 */
function util_isUserGovernor(targetUid, portName, roomData) {

    // ìˆ˜ì •: features ë‚´ë¶€ì˜ portDataë¥¼ ì°¸ì¡°í•˜ë„ë¡ ë³€ê²½
    if (!roomData || !roomData.features || !roomData.features.portData || !roomData.features.portData[portName]) return false;
    return roomData.features.portData[portName].governorUid === targetUid;
}

/**
 * [ì¶”ê°€] ìœ ì € ë³´ìœ  ì´ë… ê¶Œí•œ ëª©ë¡ ì¶”ì¶œ
 */
function util_getUserGovernorPorts(targetUid, roomData) {
    var myPorts = [];
    if (!roomData || !roomData.features || !roomData.features.portData) return myPorts;
    
    for (var pName in roomData.features.portData) {
        if (roomData.features.portData[pName].governorUid === targetUid) {
            myPorts.push(pName);
        }
    }
    return myPorts;
}

/**
 * [ì¶”ê°€] í•­êµ¬ ë°œì „ ë³´ë„ˆìŠ¤ ê³„ì‚°ê¸°
 */
function util_getPortLevelBonus(portName, roomData) {
    if (!roomData || !roomData.features || !roomData.features.portData || !roomData.features.portData[portName]) return 0;
    var level = roomData.features.portData[portName].level || 1;
    var cfg = SYSTEM_CONFIG.TRADE.INVEST;

    // (ë ˆë²¨ - 1) * 1% ë³´ë„ˆìŠ¤ ì ìš©
    return (level - 1) * (cfg.BONUS_PER_LEVEL || 0.01);
}

//==========ì„¹í„°12==========

/* ê²½ì°° ì¶œë™ ê²°ê³¼ ì²˜ë¦¬ í•¨ìˆ˜ (ì¤‘ì•™ì€í–‰ ì—°ë™ ë° ë°©ë³„ ê²©ë¦¬ ë³´ì •) */
function processPoliceResult(roomName, thiefUid, victimUid) {
    var data = getDatabase();
    if (!data) return;
    var room = data.rooms[roomName];
    if (!room || !room.features || !room.features.states) return;

    // [í•µì‹¬ ìˆ˜ì •] ì „ì—­ ë³€ìˆ˜ê°€ ì•„ë‹Œ ë°©ë³„ ë…ë¦½ ìƒíƒœ ì €ì¥ì†Œë¥¼ ì°¸ì¡°í•˜ë„ë¡ ì—°ê²°
    var activeThefts = room.features.states.activeThefts; 

    var theftData = activeThefts[victimUid];
    if (!theftData) return;
    
    var thief = room.users[thiefUid];
    
    if (activeThefts[victimUid].successTimer) clearTimeout(activeThefts[victimUid].successTimer);
    
    // [ìƒíƒœ í•´ì œ] ì˜¬ë°”ë¥¸ ì°¸ì¡° ê²½ë¡œì—ì„œ ì‚­ì œ ìˆ˜í–‰
    delete activeThefts[victimUid]; 
    
    // 1. ë²Œê¸ˆ ê³„ì‚°: í˜„ê¸ˆ ì°¨ê°ì€ ë³´ìœ ì•¡ì˜ 10%
Â  Â  var cashFine = Math.floor(Number(thief.point) * 0.1);
Â  Â  // 2. ëŒ€ë‚© ê³„ì‚°: 1,000P í•˜í•œì„  ë³´ì¥ (ë¶€ì¡±ë¶„ ì‚°ì¶œ)
Â  Â  var loanGap = Math.max(0, 1000 - cashFine);
Â  Â Â 
Â  Â  util_updatePoint(thief, room, -cashFine, "ë„ë‘‘ì§ˆ ì²´í¬ ë²Œê¸ˆ", roomName);
Â  Â Â 
Â  Â  var loanMsg = "";
Â  Â  if (loanGap > 0) {
Â  Â  Â  Â  if (!thief.loan) thief.loan = { debt: 0, items: [] };
Â  Â  Â  Â  thief.loan.debt = Number(thief.loan.debt || 0) + loanGap;
Â  Â  Â  Â  if (!thief.loan.items) thief.loan.items = [];
Â  Â  Â  Â  thief.loan.items.push(loanGap);
Â  Â  Â  Â  loanMsg = "\nâš ï¸ ë²Œê¸ˆ ë¶€ì¡±ë¶„ ëŒ€ë‚©: " + fp(loanGap) + "P ëŒ€ì¶œ ì „í™˜";
Â  Â  }
Â  Â Â 
Â  Â  var jailTime = 1 * 60 * 60 * 1000;
Â  Â  util_setData(thief, 'jailReleaseTime', Date.now() + jailTime, "ë„ë‘‘ì§ˆ ì²´í¬ ì§•ì—­", roomName);
Â  Â Â 
Â  Â  var msg = "ğŸš¨ [ê²½ì°° ì¶œë™]\nëŒ€ìƒ: " + getDisplayName(thief) + "\në‚´ìš©: ë„ë‘‘ì§ˆ í˜„í–‰ë²” ì²´í¬\në²Œê¸ˆ: -" + fp(cashFine) + "P / ì§•ì—­ 1ì‹œê°„" + loanMsg + "\në‚´ ì”ì•¡: " + fp(thief.point) + "P";
    Api.replyRoom(roomName, formatAdmin("ğŸš“ ì²´í¬ ì™„ë£Œ", msg));
    safeSaveData(data);
}

/* ë„ë‘‘ì§ˆ ì„±ê³µ ê²°ê³¼ ì²˜ë¦¬ í•¨ìˆ˜ (ì¤‘ì•™ì€í–‰ ì—°ë™ ë° ë°©ë³„ ê²©ë¦¬ ë³´ì •) */
function processTheftResult(roomName, thiefUid, victimUid) {
    var data = getDatabase();
    if (!data) return;
    var room = data.rooms[roomName];
    if (!room || !room.features || !room.features.states) return;
    
    // [í•µì‹¬ ìˆ˜ì •] ë°©ë³„ ë…ë¦½ ìƒíƒœ ì €ì¥ì†Œ ì°¸ì¡° ì—°ê²°
    var activeThefts = room.features.states.activeThefts;

    if (!room.users[thiefUid] || !room.users[victimUid]) { 
        if (activeThefts[victimUid]) delete activeThefts[victimUid]; 
        Api.replyRoom(roomName, "âš ï¸ [ì‹œìŠ¤í…œ ì•Œë¦¼]\në„ë‘‘ì§ˆ ì§„í–‰ ì¤‘ ëŒ€ìƒì´ ì‚¬ë¼ì ¸ ìƒí™©ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        return; 
    }
    
    if (activeThefts[victimUid] && activeThefts[victimUid].policeTimer) clearTimeout(activeThefts[victimUid].policeTimer);

    var thief = room.users[thiefUid];
    var victim = room.users[victimUid];
    
    // 1. íƒˆì·¨ì•¡: 5% ~ 10% ì‚¬ì´ ëœë¤
    var minSteal = Math.floor(Number(victim.point) * 0.05);
    var maxSteal = Math.floor(Number(victim.point) * 0.10);
    var stealAmount = Math.floor(Math.random() * (maxSteal - minSteal + 1)) + minSteal;
    
    // 2. í”¼í•´ì ë³´í˜¸: 6ì‹œê°„ ë™ì•ˆ íƒ€ê²Ÿ ì œì™¸
    victim.lastTheftVictimTime = Date.now() + (6 * 60 * 60 * 1000);

    util_updatePoint(victim, room, -stealAmount, "ë„ë‘‘ì§ˆ ë‹¹í•¨", roomName);

    var plunderArtifact = "";
    if (Math.random() < 0.10 && Number(victim.artifactPieces || 0) > 0) {
        victim.artifactPieces = Number(victim.artifactPieces) - 1;
        thief.artifactPieces = Number(thief.artifactPieces || 0) + 1;
        plunderArtifact = "\n\nâœ¨ [ìœ ë¬¼ ì•½íƒˆ ì„±ê³µ]!\n" + victim.name + "ë‹˜ì˜ 'ìœ ë¬¼ ì¡°ê°' 1ê°œë¥¼ ê°€ë¡œì±˜ìŠµë‹ˆë‹¤!";
    }

    var res = processRepayment(thief, stealAmount, thiefUid, roomName); 
    
    // ë„ë‘‘ì˜ í¬ì¸íŠ¸ ì¦ê°€ (ì´ ëˆì€ í”¼í•´ìì—ê²Œì„œ ì™”ìœ¼ë¯€ë¡œ ì€í–‰ ì¬ì› ë³€ë™ 0)
    util_updatePoint(thief, room, Number(res.actualGain), "ë„ë‘‘ì§ˆ ì„±ê³µ", roomName);
    
   // 2. [í™•ì •] ë„ë‘‘ì§ˆ ì„±ê³µ ëˆ„ì  í†µê³„ ê²Œì´íŠ¸ì›¨ì´ ë³´í˜¸
    var nextTheftSuccess = Number(thief.totalTheftSuccess || 0) + 1;
    util_setData(thief, 'totalTheftSuccess', nextTheftSuccess, "ë„ë‘‘ì§ˆ ì„±ê³µ ê¸°ë¡", roomName);

    // 3. ë¦¬í”Œë¼ì´ì–´ ìŠ¤í… ì„ ì–¸ (ì¹­í˜¸ ìë™ ë¶€ì—¬ ì‹œìŠ¤í…œ ì—°ë™ìš©)
    var replierStub = { reply: function(m) { Api.replyRoom(roomName, m); } };

    // ì¹­í˜¸ ë¶€ì—¬ ë¡œì§ (ê²Œì´íŠ¸ì›¨ì´ë¡œ ê°±ì‹ ëœ ìµœì‹  ê°’ì„ ì°¸ì¡°)
    if (thief.totalTheftSuccess >= 50) {
        util_checkAndAwardTitle(thief, replierStub, "ì•½íƒˆì™•", 1203, "ğŸ‘¤", "ë‚´ë¦¬ë‹¤ ê·¸ë¦¼ì ê¸¸ë“œ", "ëˆ„ì  ë„ë‘‘ì§ˆ ì„±ê³µ 50íšŒ", "[ì¥ì°© íš¨ê³¼]: ë„ë‘‘ì§ˆ ì‹œ ê²½ì°°ì´ ì¶œë™í•  í™•ë¥ ì´ ê¸°ì¡´ 50%ì—ì„œ 30%ë¡œ ê°ì†Œí•©ë‹ˆë‹¤.");
    } else if (thief.totalTheftSuccess >= 30) {
        util_checkAndAwardTitle(thief, replierStub, "ëŒ€ë„", 1202, "ğŸ‘º", "ë‚´ë¦¬ë‹¤ ê·¸ë¦¼ì ê¸¸ë“œ", "ëˆ„ì  ë„ë‘‘ì§ˆ ì„±ê³µ 30íšŒ", "ëŒ€ë‹´í•œ ìˆ˜ë²•ìœ¼ë¡œ ì„¸ìƒì„ ë†€ë¼ê²Œ í•˜ê³  ìˆìŠµë‹ˆë‹¤.");
    } else if (thief.totalTheftSuccess >= 10) {
        util_checkAndAwardTitle(thief, replierStub, "ì¢€ë„ë‘‘", 1201, "ğŸ§¤", "ë‚´ë¦¬ë‹¤ ê·¸ë¦¼ì ê¸¸ë“œ", "ëˆ„ì  ë„ë‘‘ì§ˆ ì„±ê³µ 10íšŒ", "ë‚¨ì˜ ì§€ê°‘ì„ ê°€ë³ê²Œ ë§Œë“œëŠ” ê¸°ìˆ ì„ ìµí˜”ìŠµë‹ˆë‹¤.");
    }
    
    // [ìƒíƒœ í•´ì œ] ì˜¬ë°”ë¥¸ ì°¸ì¡° ê²½ë¡œì—ì„œ ì‚­ì œ ìˆ˜í–‰
    if (activeThefts[victimUid]) delete activeThefts[victimUid]; 
    
    var content = "ğŸ•µï¸ ë„ë‘‘ì§ˆ ì„±ê³µ!\n" + getDisplayName(victim) + "ë‹˜ì˜ ì§€ê°‘ì—ì„œ\n" + fp(stealAmount) + "Pë¥¼ í›”ì³¤ìŠµë‹ˆë‹¤!" + res.repayMsg + plunderArtifact;
    // [ìˆ˜ì •] ë„ë‘‘ì§ˆ ê²°ê³¼ì— ë³´ìœ  í¬ì¸íŠ¸ í‘œì‹œ ì¶”ê°€
    Api.replyRoom(roomName, formatCommand("ğŸ’° ë„ë‘‘ì§ˆ ê²°ê³¼", thief, content, "ë‚´ ì”ì•¡: " + fp(thief.point) + "P"));
    safeSaveData(data);
}

//==========ì„¹í„°13==========

/**
 * [ê²½ì œ ì‹œìŠ¤í…œ ëª¨ë“ˆ] í†µí•© ìë™ ìƒí™˜ ë° ì‹ ìš© ê´€ë¦¬ (ìˆ˜ì •ëœ ì°¨ë“± ë¹„ìœ¨ ë²„ì „)
 * ìˆ˜ì • ë‚´ìš©: 
 * 1. ì¼ë°˜ ì€í–‰ ë¹š ìƒí™˜: 30%
 * 2. ì‹ ìš©ë¶ˆëŸ‰ì/ì‚¬ì±„ ê°•ì œì¶”ì‹¬: 50%
 * 3. ì€í–‰ ëŒ€í™˜ ì±„ë¬´(ëŒ€ë‚©ê±´): 70%
 */

/* [ê¸°ëŠ¥ 1] ì‹ ìš©ë¶ˆëŸ‰ì ìƒíƒœ ì œì–´ */
function checkAndHandleDefaulter(user, roomName) {
    var currentScore = Number(user.creditScore || 600);
    if (currentScore < 500) {
        if (!user.isDefaulter) {
            util_setData(user, 'isDefaulter', true, "ì‹ ìš©ë„ í•˜ë½(500ë¯¸ë§Œ)", roomName);
            var msg = "ì‹ ìš© ì ìˆ˜ 500ì  ë¯¸ë§Œ í•˜ë½\n\n1. ëŒ€ì¶œ ë³´ìœ  ì‹œ ìˆ˜ìµ 50% ìë™ìƒí™˜\n2. ê°ì¢… ì§€ì›ê¸ˆ 20% ì‚­ê° (êµ­ê³  í™˜ìˆ˜)\n3. ì˜íšŒ íˆ¬í‘œê¶Œ ë°•íƒˆ"
            try { Api.replyRoom(roomName, formatCommand("ğŸ“‰ ì‹ ìš©ë¶ˆëŸ‰ì ì§€ì •", user, msg, "ëŒ€ì¶œ ìƒí™˜ì„ ê¶Œì¥í•©ë‹ˆë‹¤.")); } catch(e){}
        }
    } else {
        if (user.isDefaulter) { user.isDefaulter = false; }
    }
}

/* [ê¸°ëŠ¥ 2] ì€í–‰ ëŒ€ì¶œê¸ˆ ë¶„ì‚° ìƒí™˜ ì—”ì§„ */
function distributeRepayment(user, amount, roomName) {
    if (!user.loan || Number(user.loan.debt) < 1) {
        if (user.loan) { user.loan.debt = 0; user.loan.items = []; user.isTransferred = false; }
        return { actualRepay: 0, creditGain: 0, clearedCount: 0 };
    }
    
    var remainingRepay = Math.floor(Number(amount));
    var initialAmount = remainingRepay;

    var creditGainTotal = 0; 
    var newItems = [];
    var clearedCount = 0; // (ì°¸ê³ ìš© ì¹´ìš´íŠ¸)

    if (!user.loan.items) user.loan.items = [];
    
    // ë“¤ì–´ì˜¨ ìˆœì„œëŒ€ë¡œ ìƒí™˜ ì²˜ë¦¬ (FIFO êµ¬ì¡° ìœ ì§€)
    for (var i = 0; i < user.loan.items.length; i++) {
        var item = user.loan.items[i];
        
        // [í˜¸í™˜ì„±] êµ¬ë²„ì „(ìˆ«ì)ê³¼ ì‹ ë²„ì „(ê°ì²´) ë°ì´í„° ëª¨ë‘ ì²˜ë¦¬
        var currentAmt = (typeof item === 'object') ? Number(item.amount) : Number(item);
        var isHighLoan = (typeof item === 'object') ? item.isHigh : false;

        if (remainingRepay >= currentAmt) {
            // [ì™„ë‚© ì„±ê³µ]: í•´ë‹¹ ëŒ€ì¶œ ê±´ì´ ëª©ë¡ì—ì„œ ì‚¬ë¼ì§
            remainingRepay -= currentAmt;
            clearedCount++;
            
            // ì¡°ê±´: ê³ ì•¡ ëŒ€ì¶œë¡œ ê¸°ë¡ëœ ê±´ì´ì—ˆë‹¤ë©´ ì‹ ìš©ì ìˆ˜ +80 íšŒë³µ
            if (isHighLoan) {
                creditGainTotal += 80;
            }
        } else {
            // [ë¶€ë¶„ ìƒí™˜]: ì”ì•¡ì´ ë‚¨ì•„ì„œ ëª©ë¡ì— ìœ ì§€ë¨
            currentAmt -= remainingRepay;
            remainingRepay = 0;
            
            // ë‚¨ì€ ì”ì•¡ì„ ë‹¤ì‹œ ì €ì¥ (ë°ì´í„° êµ¬ì¡° ìœ ì§€)
            if (typeof item === 'object') {
                item.amount = currentAmt;
                newItems.push(item);
            } else {
                newItems.push(currentAmt);
            }
        }
    }
    
    // ì‹¤ì œ ê°šì€ ì´ì•¡ ê³„ì‚°
    var actualRepayed = initialAmount - remainingRepay;
    user.loan.items = newItems;

    // ë‚¨ì€ ì´ ì±„ë¬´ì•¡ ì¬ê³„ì‚°
    var remainingTotal = 0;
    for (var i = 0; i < newItems.length; i++) { 
        var val = (typeof newItems[i] === 'object') ? Number(newItems[i].amount) : Number(newItems[i]);
        remainingTotal += val; 
    }
    user.loan.debt = remainingTotal; 

    // ì‹ ìš©ì ìˆ˜ ìµœì¢… ë°˜ì˜ (ìµœëŒ€ 1000ì )
    if (creditGainTotal > 0) {
        var nextScore = Math.min(1000, Number(user.creditScore || 600) + creditGainTotal);
        util_setData(user, 'creditScore', nextScore, "ê³ ì•¡ ëŒ€ì¶œ ì™„ë‚© ê°€ì ", roomName);
    }

    // [í™•ì •]: ëŒ€ì¶œê¸ˆì´ ì™„ì „íˆ 0ì´ ë˜ì—ˆì„ ë•Œë§Œ ì±„ë¬´ ì™„ë‚© ì²˜ë¦¬ ë° íŠ¹ìˆ˜ ì±„ë¬´ í”Œë˜ê·¸ë¥¼ í•´ì œí•©ë‹ˆë‹¤.
    if (user.loan.debt <= 0) {
        user.loan.debt = 0; 
        user.loan.items = []; 
        util_setData(user, 'isTransferred', false, "ì±„ë¬´ ì™„ë‚©", roomName);
    }
    
    return { actualRepay: actualRepayed, creditGain: creditGainTotal, clearedCount: clearedCount };
}

/* [ê¸°ëŠ¥ 3] ì‚¬ì±„(P2P) ìë™ ì¶”ì‹¬ ì²˜ë¦¬ (ìˆ˜ì •: ì¶”ì‹¬ ë¹„ìœ¨ 50% ì ìš©) */
function processPrivateCollection(user, userUid, amount, roomName) {
    var data = getDatabase();
    var roomData = data.rooms[roomName];
    if (!roomData) return { collected: 0, msg: "" };

    if (!user.loan || Number(user.loan.debt || 0) <= 0) {
        util_setData(user, 'isTransferred', false, "ì±„ë¬´ ë¶€ì¬ ìƒíƒœ ë™ê¸°í™”", roomName);
    }
    
    // [ì„¤ì • ìˆ˜ì •] ì§ì ‘ ì¶”ì‹¬ í•œë„ë¥¼ ìˆ˜ìµì˜ 50%ë¡œ ë³€ê²½
    var totalLimit = Math.floor(Number(amount) * 0.5); 
    var remainingAmount = totalLimit; 
    
    var totalCollected = 0;
    var collectionLog = "";

    if (roomData.loanContracts) {
        for (var cid in roomData.loanContracts) {
            var c = roomData.loanContracts[cid];
            if (c.borrowerUid === userUid && c.status === 'overdue' && remainingAmount > 0) {
                var collectTarget = Math.min(remainingAmount, c.currentDebt);
                
                var lender = roomData.users[c.lenderUid];
                if (lender) {
                    util_updatePoint(lender, roomData, collectTarget, "ì‚¬ì±„ ì¶”ì‹¬ ìˆ˜ìµ (" + c.borrowerName + ")", roomName);
                }

                c.currentDebt -= collectTarget;
                totalCollected += collectTarget;
                remainingAmount -= collectTarget;
                collectionLog += "\n- " + c.lenderName + "ë‹˜ê»˜ " + fp(collectTarget) + "P ì†¡ê¸ˆ";

                if (c.currentDebt <= 0) {
                    delete roomData.loanContracts[cid];
                    collectionLog += " (ì™„ë‚© ì¢…ë£Œ)";
                }
            }
        }
    }

    if (totalCollected > 0) {
        var msg = "\n\nğŸš¨ [ì‚¬ì±„ ê°•ì œ ì¶”ì‹¬ ì•ˆë‚´]\nì‚¬ì±„ ì—°ì²´ë¡œ ì¸í•´ ìˆ˜ìµì˜ 50%ê°€ ì±„ê¶Œìì—ê²Œ ìë™ ê·€ì†ë˜ì—ˆìŠµë‹ˆë‹¤." + collectionLog;
        return { collected: totalCollected, msg: msg };
    }
    return { collected: 0, msg: "" };
}

/* [ê¸°ëŠ¥ 4] í†µí•© ìë™ ìƒí™˜ í”„ë¡œì„¸ìŠ¤ (ìˆ˜ì •: ë¹„ìœ¨ ì²´ê³„ ì „ë©´ ê°œí¸) */
function processRepayment(user, amount, userUid, roomName) {
    var amt = Number(amount) || 0;
    var currentGain = amt;
    var totalRepayMsg = "";
    var data = getDatabase();

    if (!user.loan || Number(user.loan.debt || 0) <= 0) {
        user.isTransferred = false;
    }

    // 1. ì‚¬ì±„ ì§ì ‘ ì¶”ì‹¬ (50% ë¹„ìœ¨ ì‘ë™)
    var privateRes = processPrivateCollection(user, userUid, currentGain, roomName);
    if (privateRes.collected > 0) {
        currentGain -= privateRes.collected;
        totalRepayMsg += privateRes.msg;
    }

    // 2. ì€í–‰ ëŒ€ì¶œ ìë™ ìƒí™˜
    if (currentGain > 0 && user.loan && Number(user.loan.debt) > 0) {
        // [ê¸°ë³¸ê°’] ì¼ë°˜ ìœ ì € ìƒí™˜ ë¹„ìœ¨ 30%
        var repaymentRate = 0.3; 
        var typeLabel = "ì¼ë°˜ ìƒí™˜";

        // [ì¡°ê±´ 1] ëŒ€í™˜ ì±„ë¬´(ì€í–‰ì´ ì‚¬ì±„ë¥¼ ëŒ€ì‹  ê°šì•„ì¤€ ê²½ìš°)ëŠ” 70% ì••ë¥˜
        if (user.isTransferred === true || user.isTransferred === "true") {
            repaymentRate = 0.7; 
            typeLabel = "ğŸš¨ ëŒ€í™˜ ì±„ë¬´ ê°•ì œ ì¶”ì‹¬";
        } 
        // [ì¡°ê±´ 2] ì‹ ìš©ë¶ˆëŸ‰ì(500ì  ë¯¸ë§Œ)ëŠ” ìˆ˜ìµ ë°œìƒ ì‹œ 50% ì••ë¥˜ (ìƒí™˜ ë¡œì§ í™•ì •)
Â  Â  Â  Â  else if (Number(user.creditScore || 600) < 500) {
Â  Â  Â  Â  Â  Â  repaymentRate = 0.5;Â 
Â  Â  Â  Â  Â  Â  typeLabel = "ì‹ ìš©ë¶ˆëŸ‰ ì œí•œ ìƒí™˜";
Â  Â  Â  Â  }

        var intendedRepay = Math.floor(currentGain * repaymentRate);
        if (intendedRepay > Number(user.loan.debt)) intendedRepay = Number(user.loan.debt);
        
        var res = distributeRepayment(user, intendedRepay, roomName);
        currentGain -= res.actualRepay;

        totalRepayMsg += "\n\nğŸ¦ [ì€í–‰ " + typeLabel + "]\nğŸ’° " + fp(res.actualRepay) + "P ìƒí™˜ë¨ (" + Math.floor(repaymentRate * 100) + "%)";
        
        if (res.creditGain > 0) {
            totalRepayMsg += "\nğŸ“ˆ ì‹ ìš© ì ìˆ˜ +" + res.creditGain + " ìƒìŠ¹";
        }
        
        totalRepayMsg += "\n(ë‚¨ì€ ëŒ€ì¶œ: " + fp(user.loan.debt) + "P)";
    } // if (currentGain > 0...) ë¸”ë¡ ì¢…ë£Œ
    
    return { actualGain: currentGain, repayMsg: totalRepayMsg };
}

//==========ì„¹í„°14==========

/* [ê°œí¸] ëœë“œë§ˆí¬ ë¦¬ìŠ¤íŠ¸ ìƒì„± í•¨ìˆ˜ (ë¶€ë™ì‚° ì»¨ì…‰ ì ìš©) */
function generateLandmarkList(data, roomName) {
    var list = [];
    var dangerLandmarks = [];
    var keys = Object.keys(data.landmarkMarket || {});
    if (keys.length === 0) return null;

    // íƒ€ì…ë³„ ìš°ì„ ìˆœìœ„ ì •ì˜ (ë‚®ì„ìˆ˜ë¡ ìƒë‹¨)
    var getTypePriority = function(name) {
        var fixed = ["ê´‘ì‚°", "ë‚šì‹œí„°", "ì¹´ì§€ë…¸", "ì¤‘ì•™ì€í–‰", "ë°±í™”ì ", "ê²½ë§ˆì¥"];
        if (fixed.indexOf(name) !== -1) return 1; // 1ìˆœìœ„: ê³ ì • ëœë“œë§ˆí¬

        var land = data.landmarkMarket[name];
        if (!land) return 4;
        
        if (land.type === "bluechip") return 2; // 2ìˆœìœ„: ë¹„ì¦ˆë‹ˆìŠ¤íƒ€ì›Œ (ğŸ¨)
        if (land.type === "hotspot") return 3;  // 3ìˆœìœ„: ìƒê°€ ë° ê¸°íƒ€ (ğŸšï¸)
        return 4;
    };

    // ë‹¤ì¤‘ ì •ë ¬: 1ìˆœìœ„ íƒ€ì…(ìš°ì„ ìˆœìœ„), 2ìˆœìœ„ ì´ë¦„(ê°€ë‚˜ë‹¤)
    keys.sort(function(a, b) {
        var priA = getTypePriority(a);
        var priB = getTypePriority(b);
        
        if (priA !== priB) return priA - priB;
        return a.localeCompare(b); // ê°€ë‚˜ë‹¤ìˆœ
    });

    var roomData = data.rooms[roomName]; // í•´ë‹¹ ë°©ì˜ ìœ ì € ë°ì´í„°ë¥¼ ì°¸ì¡°í•˜ê¸° ìœ„í•´ ê°€ì ¸ì˜´
    var landmarkTraits = SYSTEM_CONFIG.ECO.LANDMARK.TRAITS;

    var fixCfg = SYSTEM_CONFIG.ECO.LANDMARK.FIXED_POLICY; // ëˆ„ë½ëœ ë³€ìˆ˜ ì •ì˜ ì¶”ê°€

    for (var i = 0; i < keys.length; i++) {
        var name = keys[i];
        var landmark = data.landmarkMarket[name];
        var trait = landmarkTraits[landmark.type] || landmarkTraits.normal;
        
        var ownerTag = ""; 
        if (roomData) {
            var owner = util_getMajorityOwner(roomData, name);
            if (owner && owner.data) {
                ownerTag = "\n[" + getDisplayName(owner.data) + "]";
            }
        }
        
        var displayPrice = Number(landmark.price);
        var statusInfo = "";

        if (landmark.type === "normal") {
            // [ê°€ê²© ë™ê¸°í™”] ì„¹í„° 7ì˜ ì „ì—­ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
            var totalShares = util_getTotalShares(name, roomData);
            displayPrice = fixCfg.BASE_PRICE + (totalShares * (fixCfg.BASE_PRICE * fixCfg.PER_SHARE_RATE));
            statusInfo = " (ì´ " + totalShares + "ì§€ë¶„)";
        } else {
            var diff = displayPrice - Number(landmark.lastPrice);
            var rate = landmark.lastPrice > 0 ? ((diff / landmark.lastPrice) * 100).toFixed(1) : "0.0";
            var sign = diff > 0 ? "ğŸ”º" : (diff < 0 ? "ğŸ”¹" : "â–");
            statusInfo = " (" + sign + " " + Math.abs(rate) + "%)";
        }
        
        var warningMark = "";
        if (landmark.delistTick && landmark.delistTick > 0) {
            warningMark = " âš ï¸";
            dangerLandmarks.push(name);
        }
        
        list.push(trait.icon + " " + name + ": " + fp(displayPrice) + "P" + statusInfo + warningMark + ownerTag);
    } // for ë£¨í”„ ë

    var result = list.join("\n");

    if (dangerLandmarks.length > 0) {
        result += "\n\nâš ï¸ ë¶€ì§€ ê°€ì¹˜ í•˜ë½ìœ¼ë¡œ ê°•ì œ ì² ê±° ìœ„ê¸°!\ní•´ë‹¹ ê±´ë¬¼ : " + dangerLandmarks.join(", ");
    }
    
    return result;
}

//==========ì„¹í„°15==========

/* ëœë“œë§ˆí¬ ì´ë¦„ ìƒì„± í•¨ìˆ˜ (ë¶€ë™ì‚° ì „ìš©) */
function generateLandmarkName(data) {
    var conf = SYSTEM_CONFIG.ECO.LANDMARK;
    var name = "";
    for (var i = 0; i < 20; i++) {
        var pre = conf.PREFIXES[Math.floor(Math.random() * conf.PREFIXES.length)];
        var suf = conf.SUFFIXES[Math.floor(Math.random() * conf.SUFFIXES.length)];
        name = pre + suf;
        if (!data.landmarkMarket || !data.landmarkMarket[name]) break;
    }
    return name;
}

/* ëœë“œë§ˆí¬ íƒ€ì… í• ë‹¹ í•¨ìˆ˜ */
function assignLandmarkType() {
    var conf = SYSTEM_CONFIG.ECO.LANDMARK;
    var rand = Math.random() * 100;
    var cumulative = 0;
    for (var type in conf.TRAITS) {
        cumulative += conf.TRAITS[type].prob;
        if (rand < cumulative) return type;
    }
    return "normal";
}

/* ëœë“œë§ˆí¬ ì‹œì„¸ ë³€ë™ ë¡œì§ í•¨ìˆ˜ (ë¶€ë™ì‚° ë§ˆì¼“ í†µí•© ë²„ì „) */
function updateLandmarkPrices(data) {
    var conf = SYSTEM_CONFIG.ECO.LANDMARK;
    if (!data.landmarkMarket) data.landmarkMarket = {};
    if (!data.landmarkTraffic) data.landmarkTraffic = {}; 

    // 1. [ê³ ì •] ì‚¬ìš©ì ì§€ì • 6ëŒ€ í•µì‹¬ ëœë“œë§ˆí¬ ê°•ì œ ìƒì¥
    var fixedSites = {
        "ê´‘ì‚°": { price: 500000, type: "bluechip", icon: "â›ï¸" },
        "ë‚šì‹œí„°": { price: 300000, type: "normal", icon: "ğŸ£" },
        "ì¹´ì§€ë…¸": { price: 1000000, type: "hotspot", icon: "ğŸ°" },
        "ì¤‘ì•™ì€í–‰": { price: 5000000, type: "bluechip", icon: "ğŸ¦" },
        "ë°±í™”ì ": { price: 1500000, type: "hotspot", icon: "ğŸ¢" },
        "ê²½ë§ˆì¥": { price: 800000, type: "normal", icon: "ğŸ‡" }
    };
    
    for (var fName in fixedSites) {
        if (!data.landmarkMarket[fName]) {
            var site = fixedSites[fName];
            data.landmarkMarket[fName] = { 
                price: site.price, lastPrice: site.price, type: site.type, 
                delistTick: 0, delistLimit: 9999, trend: "none", trendTick: 0, openPrice: site.price 
            };
        }
    }

    var mainRoom = data.rooms["ë‚´ë¦¬ë‹¤"];
    var pol = util_getActivePolicy(mainRoom);

    var now = new Date();
    var currentHour = now.getHours();
    var isMarketOpen = (currentHour >= conf.SETTINGS.OPEN_HOUR && currentHour <= conf.SETTINGS.CLOSE_HOUR);
    
    var totalSum = 0;
    var count = 0;
    for (var k in data.landmarkMarket) { totalSum += Number(data.landmarkMarket[k].price); count++; }
    var marketAvg = count > 0 ? (totalSum / count) : 1000;

    var eco = calculateEconomy(data, "ë‚´ë¦¬ë‹¤");
    var activeUserCount = Math.max(1, eco.count); 
    var ecoBaseFloor = conf.SETTINGS.ABS_DELIST_LIMIT;

    var eventNews = [];

    /* [1] ì‹ ê·œ ë§¤ë¬¼ ë“±ë¡ ì²˜ë¦¬ */
    if (data.pendingNewLandmark && isMarketOpen) {
        if (Object.keys(data.landmarkMarket).length < conf.SETTINGS.MAX_COUNT) {
            var newName = generateLandmarkName(data);
            var newType = assignLandmarkType();
            var startPrice = Math.floor(marketAvg * ((Math.random() * 0.3) + 0.8));
            
            data.landmarkMarket[newName] = { 
                price: Number(startPrice), lastPrice: Number(startPrice), 
                type: newType, delistTick: 0, delistLimit: Math.floor(Math.random() * 4) + 2,
                trend: "none", trendTick: 0, openPrice: startPrice,
                isOverheated: false
            };
            eventNews.push("ğŸ™ï¸ ì‹ ê·œ ë§¤ë¬¼ ë“±ë¡: " + conf.TRAITS[newType].icon + " " + newName + " (" + fp(startPrice) + "P)");
        }
        data.pendingNewLandmark = false;
    }

    /* [2] ì¡°ì‘ í”„ë¦¬ì…‹ ì„¤ì • ë¡œë“œ */
    var mani = conf.MANIPULATION;
    var specLand = (mani && mani.ACTIVE) ? mani.TARGET : null;
    var specFactor = (mani && mani.ACTIVE) ? (mani.IS_UP ? Math.abs(mani.RATE) : -Math.abs(mani.RATE)) : 0;

    if (!specLand && data.pendingSpecialEffect && isMarketOpen) {
        specLand = data.pendingSpecialEffect.landmark; // landmarkë¡œ í‚¤ê°’ ëŒ€ì‘
        specFactor = data.pendingSpecialEffect.factor;
    }

    /* [3] ì‹œì„¸ ë³€ë™ ê³„ì‚° ë£¨í”„ */
    var msgCount = (mainRoom.features.msgCount || 0);
    var units = Math.floor(Math.min(msgCount, 500) / 50); 
    var hypeFactor = 1 + (units * 0.01); 

    for (var name in data.landmarkMarket) {
        var landmark = data.landmarkMarket[name];
        var trait = conf.TRAITS[landmark.type] || conf.TRAITS.normal;
        var changePercent = 0;
        
        landmark.lastPrice = Number(landmark.price);

        /* [Gemini] ëœë“œë§ˆí¬ íƒ€ì…(normal) ë³€ë™ ì œì™¸ ë¡œì§ */
        if (landmark.type === "normal") {
            // ëœë“œë§ˆí¬ëŠ” ì£¼ì‹í˜• ë³€ë™ì„ í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì—°ì‚°ì„ ê±´ë„ˆëœë‹ˆë‹¤.
            landmark.delistTick = 0; // ê°•ì œ ì² ê±° ìœ„í—˜ ë°©ì§€
            continue; 
        }

        if (isMarketOpen) {
            if (name === specLand) { 
                // [ì¡°ì‘ ë§¤ë¬¼] í­ë“±/í­ë½ ì²˜ë¦¬
                changePercent = specFactor * hypeFactor;
                eventNews.push("ğŸš¨ [ë³€ë™ì„± ì•Œë¦¼]\nê±´ë¬¼: " + name + "\në‚´ìš©: " + (specFactor > 0 ? "ğŸš€ ì‹œì„¸ í­ë“±" : "ğŸ“‰ ì‹œì„¸ í­ë½") + " (" + (Math.abs(changePercent * 100)).toFixed(1) + "%)");
            } else {
                // [ì¼ë°˜ ë§¤ë¬¼] íŠ¸ë Œë“œ ë° ì‹œì„¸ ë³€ë™ ì—°ì‚°
                if (landmark.trendTick <= 0) {
                    // íŠ¸ë Œë“œ ìœ ì§€ ì‹œê°„ ë‹¨ì¶•: ê¸°ì¡´ 2~5íšŒ -> ìˆ˜ì • 2~3íšŒ (ë” ë¹ ë¥¸ íƒœì„¸ ì „í™˜)
                    landmark.trendTick = Math.floor(Math.random() * 2) + 2; 
                    var p = Math.random(); 
                    landmark.trend = (p < 0.35) ? "up" : (p < 0.70 ? "down" : "volatile");
                }

                // ë³€ë™ í­ ëœë¤í™”: ê³ ì • 2.5% ëŒ€ì‹  1.0% ~ 4.0% ì‚¬ì´ì˜ ë¬´ì‘ìœ„ ë°°ìœ¨ ê²°ì •
                var randomRate = (Math.random() * 0.03) + 0.01; 
                var baseRate = (landmark.trend === "up" ? randomRate : (landmark.trend === "down" ? -randomRate : (Math.random() * 0.08 - 0.04)));
                changePercent = baseRate * trait.volatility * hypeFactor;
                
                var traffic = data.landmarkTraffic[name] || { buy: 0, sell: 0 };
                var trafficImpact = Math.max(-0.15, Math.min(0.15, ((traffic.buy - traffic.sell) / (activeUserCount * 5)) * 0.01));
                changePercent += trafficImpact;

                if (pol.volatilityMult) changePercent *= pol.volatilityMult;

                // [v11.9.9 êµì •] ì €í•­ì„  ë° í•˜ë½ ì••ë ¥ ë¡œì§ (ìƒìŠ¹ í¸í–¥ ì œê±°)
                var refPrice = landmark.openPrice || landmark.price;
                var growthRate = (landmark.price - refPrice) / refPrice;
                var sConf = conf.SETTINGS;

                if (growthRate > sConf.RESISTANCE_START) {
                    var gap = growthRate - sConf.RESISTANCE_START;
                    changePercent -= gap * sConf.GRAVITY;
                    changePercent += (Math.random() * 0.06 - 0.03); // ëŒ€ì¹­ì  ë‚œìˆ˜ ë°œìƒ
                    
                    if (growthRate >= sConf.CLOSING_LIMIT - 0.05) changePercent -= 0.08;
                }
                landmark.trendTick--;
            } // else ë¸”ë¡ ë
        } // if (isMarketOpen) ë¸”ë¡ ë
        
        // ìµœì¢… ê°€ê²© ê²°ì • ë° ìµœì €ê°€(10P) ë³´ì¥
        landmark.price = Math.max(10, Math.round(landmark.price * (1 + changePercent))); 

        // ê°•ì œ ì² ê±°(ìƒí) ìœ„ê¸° ì²´í¬
        if (landmark.price < (marketAvg * conf.SETTINGS.DELIST_LIMIT) || landmark.price < ecoBaseFloor) { 
            landmark.delistTick++; 
        } else { 
            landmark.delistTick = 0; 
        }
    } // for ë£¨í”„ ë

    /* ê°•ì œ ì² ê±°(ê²½ë§¤) ì§‘í–‰ */
    var demolished = [];
    for (var name in data.landmarkMarket) {
        if (data.landmarkMarket[name].delistTick >= data.landmarkMarket[name].delistLimit) demolished.push(name);
    }
    
    demolished.forEach(function(delName) { 
        for (var r in data.rooms) {
            for (var uid in data.rooms[r].users) {
                var u = data.rooms[r].users[uid];
                if (u.landHoldings) {
                    delete u.landHoldings[delName];
                    if (u.landAvg) delete u.landAvg[delName];
                }
            }
        }
        delete data.landmarkMarket[delName]; 
        eventNews.push("ğŸš¨ [ê°•ì œ ì² ê±°] " + delName + "\nì‚¬ìœ : ë¶€ì§€ ê°€ì¹˜ ë¯¸ë‹¬ë¡œ ì¸í•œ êµ­ê³  í™˜ìˆ˜"); 
    });

    data.landmarkTraffic = {}; 
    data.pendingSpecialEffect = null; 
    return eventNews;
}

/* ë¶€ë™ì‚° ì‹œì¥ ìˆ˜ë™ ì œì–´ ì—”ì§„ */
function market_forceNewLandmark() {
    var data = getDatabase();
    data.pendingNewLandmark = true;
    return "âœ… ë‹¤ìŒ ë³€ë™ íƒ€ì„ì— ì‹ ê·œ ë§¤ë¬¼ ë“±ë¡ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.";
}

function market_updateLandmarkNow(roomName) {
    var data = getDatabase();
    var result = updateLandmarkPrices(data);
    var body = "ğŸ“ˆ ë¶€ë™ì‚° ì‹œì„¸ ë³€ë™\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸŸ¢ ë¶€ë™ì‚° ìš´ì˜ì¤‘\n\n" + (generateLandmarkList(data) || "ë§¤ë¬¼ ì •ë³´ ì—†ìŒ");
    if (result.length > 0) body += "\n\n" + result.join("\n");
    body += "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"; 
    Api.replyRoom(roomName || "ë‚´ë¦¬ë‹¤", body);
    safeSaveData(data);
    return "âœ… ë¶€ë™ì‚° ì‹œì„¸ ê°±ì‹  ì™„ë£Œ.";
}

//==========ì„¹í„°16-1==========

/* í†µí•© ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰ í•¨ìˆ˜ (ë…ë¦½ ëª¨ë“ˆí˜• ì—”ì§„ + ëŒ€ì‹œë³´ë“œ ì—°ë™) */
function runScheduler() {
    try {
        var oldTimerId = java.lang.System.getProperty(SCHEDULER_KEY);
        if (oldTimerId !== null) {
            clearInterval(parseInt(oldTimerId));
            java.lang.System.clearProperty(SCHEDULER_KEY);
            Log.info("â™»ï¸ êµ¬ë²„ì „ ìŠ¤ì¼€ì¤„ëŸ¬ë¥¼ ì•ˆì „í•˜ê²Œ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤.");
        }
    } catch (e) {
        Log.error("íƒ€ì´ë¨¸ ì¢…ë£Œ ì¤‘ ì˜¤ë¥˜: " + e);
    }
    
   var isFirstTick = true; 

   var newTimer = setInterval(function() {
        try {
             if (typeof MY_INSTANCE_ID !== 'undefined' && java.lang.System.getProperty("CURRENT_ACTIVE_ID") !== MY_INSTANCE_ID) {
                clearInterval(newTimer);
                return;
            }

            var data = getDatabase(); 
            if (!data) return;

            if (!data.statusCheck) data.statusCheck = {};

            // ë¦¬ë¡œë“œ ì§í›„ ì²« ë²ˆì§¸ ë£¨í”„ì—ì„œëŠ” ì§€ì—° ì²´í¬ë¥¼ í•˜ì§€ ì•Šê³  ì‹œê°„ë§Œ ìµœì‹ í™”
            if (isFirstTick) {
                if (!data.statusCheck) data.statusCheck = {};
                data.statusCheck.mainLoop = Date.now();
                isFirstTick = false;
            } else {
                // [ë² ë¦­ë°© ì „ìš©]: ìŠ¤ì¼€ì¤„ëŸ¬ ì§€ì—°(ë¶€ì •ë§¥) ê°ì§€ - ì²« ë²ˆì§¸ ì‹¤í–‰ì´ ì•„ë‹ ë•Œë§Œ ì‘ë™
                if (data.statusCheck && data.statusCheck.mainLoop) {
                    var delay = Date.now() - data.statusCheck.mainLoop;
                    if (delay > 15000) { // 15ì´ˆ ì´ìƒ ì§€ì—° ì‹œ
                        var perfBody = "âš ï¸ ë‚´ìš©: ìŠ¤ì¼€ì¤„ëŸ¬ ë£¨í”„ ì‹¬ê°í•œ ì§€ì—° ë°œìƒ\n" +
                                       "â±ï¸ ì§€ì—° ì‹œê°„: " + (delay/1000).toFixed(1) + "ì´ˆ";
                        
                        var perfMsg = util_formatSecurityLog(
                            "ğŸš¨ [PERF: ì‹œìŠ¤í…œ ì§€ì—° ê°ì§€]", 
                            "SCHEDULER_MAIN", 
                            "ë² ë¦­ë°©", 
                            perfBody, 
                            "ì—”ì§„ ê³¼ë¶€í•˜ ì ê²€ ë° ë©”ëª¨ë¦¬ ìµœì í™” ê¶Œê³ "
                        );
                        
                        Api.replyRoom("ë² ë¦­ë°©", perfMsg);
                    }
                }
            }

            util_stamp("mainLoop"); // ë¡œì§ ì‹œì‘ ì‹œì ì— ë„ì¥ì„ ì°ì–´ ë¬´í•œ ê²½ê³ ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.

            // ëª¨ë“  ì„¹í„°ê°€ ê³µìœ í•  ìƒíƒœ ê°ì²´ (Context)ë¥¼ ë¨¼ì € ì„ ì–¸í•©ë‹ˆë‹¤.
            var ctx = {
                isUpdated: false,
                isForceBackup: false,
                now: new Date(),
                today: getSimpleDate(),
                season: getSimpleSeason(),
                targetRoom: "ë‚´ë¦¬ë‹¤",
                dashboardUrl: "https://script.google.com/macros/s/AKfycbyoURblg3-nLNgSE57Pb9RmjqK3wXyMSRpm9WrkWe3z2kyE_q_wmoabNECLNXWQ2SBZ/exec"
            };

            var currentHour = ctx.now.getHours();
            var currentMin = ctx.now.getMinutes();

            // 0. ì…ë ¥ ëŒ€ê¸°ì—´ ìë™ ë§Œë£Œ ê°ì‹œ ì—”ì§„ ê°€ë™ (1ì´ˆ ì£¼ê¸°)
            if (typeof util_autoClearTimeouts === 'function') {
                util_autoClearTimeouts(data);
            }

            // 0-1. í•´ìƒ ì•½íƒˆ íƒ€ì´ë¨¸ ë° ì§ì—… ë¯¸í™œë™ ê°ì‹œ (1ì´ˆ ì£¼ê¸°)
            if (typeof _runSeaPillageScheduler === 'function') {
                _runSeaPillageScheduler(data, ctx);
            }

            /* í•˜ì´ë¸Œë¦¬ë“œ ë””ìŠ¤ì½”ë“œ ì›ê²© ë°±ì—… (30ë¶„ ì „ì²´ / 1ë¶„ ë¡œê·¸) */
            /* [3. ë””ìŠ¤ì½”ë“œ ë°±ì—… - ì—ëŸ¬ ê²©ë¦¬ ë³´í˜¸ë§‰ ì„¤ì¹˜] */
            try {
                var webhookUrl = SYSTEM_CONFIG.BACKUP ? SYSTEM_CONFIG.BACKUP.DISCORD_WEBHOOK_URL : "";
                if (webhookUrl && webhookUrl.indexOf("http") === 0) {
                    var currentMin = ctx.now.getMinutes();
                    
                    // A. ì „ì²´ ë°ì´í„° ë°±ì—… (30ë¶„ ì£¼ê¸°)
                    if ((currentMin === 0 || currentMin === 30) && data.lastFullBackupMin !== currentMin) {
                        data.lastFullBackupMin = currentMin;
                        _sendDiscordFile(webhookUrl, FILE_PATH, "FULL_DATA_" + ctx.today + "_" + ctx.now.getHours() + "h" + currentMin + "m.json");
                    }

                    // B. ë¸”ë™ë°•ìŠ¤ ë¡œê·¸ ë°±ì—… (1ë¶„ ì£¼ê¸°)
                    if (data.lastLogBackupMin !== currentMin) {
                        data.lastLogBackupMin = currentMin;
                        logLock.lock();
                        try {
                            var logFile = new java.io.File(JOURNAL_PATH);
                            if (logFile.exists() && logFile.length() > 0) {
                                // 1. ì „ì†¡ìš© ì„ì‹œ íŒŒì¼ ìƒì„± (ë ˆì´ìŠ¤ ì»¨ë””ì…˜ ë°©ì§€)
                                var tempFileName = "LOG_TEMP_" + Date.now() + ".txt";
                                var tempPath = BASE_DIR + tempFileName;
                                var rawLogs = FileStream.read(JOURNAL_PATH);
                                
                                if (rawLogs && rawLogs.trim().length > 0) {
                                    // 2. íˆìŠ¤í† ë¦¬ í•©ì‚° ë° ì›ë³¸ ì¦‰ì‹œ ì´ˆê¸°í™”
                                    FileStream.append(BASE_DIR + "total_history.log", rawLogs);
                                    FileStream.write(JOURNAL_PATH, ""); 
                                    
                                    // 3. ì„ì‹œ íŒŒì¼ ì“°ê¸° ë° ë””ìŠ¤ì½”ë“œ ì „ì†¡ ìš”ì²­
                                    FileStream.write(tempPath, rawLogs);
                                    _sendDiscordFile(webhookUrl, tempPath, "LOG_" + ctx.now.getHours() + "h" + currentMin + "m.txt", true);
                                    
                                    Log.info("[Backup] ë¸”ë™ë°•ìŠ¤ ë¡œê·¸ ë¶„ë¦¬ ë° ì „ì†¡ ì˜ˆì•½ ì™„ë£Œ.");
                                }
                            }
                        } finally {
                            logLock.unlock();
                        }
                    }
                }
            } catch (backupError) {
                // ë°±ì—…ì—ì„œ ì—ëŸ¬ê°€ ë‚˜ë”ë¼ë„ ë¡œê·¸ë§Œ ë‚¨ê¸°ê³  ì•„ë˜ ê²Œì„ ë¡œì§ìœ¼ë¡œ ì •ìƒ ì§„í–‰
                Log.error("ğŸš¨ ë°±ì—… ì—”ì§„ ì¼ì‹œ ì˜¤ë¥˜ (ê²©ë¦¬ë¨): " + backupError);
            }

            // 1. ê²½ì œ/ê²½ë§ˆ (ì„¹í„° 16-2)
            try {
                if (typeof _runSector16Logic === 'function') _runSector16Logic(data, ctx);
            } catch (e) {
                Log.error("Sector 16 Logic Crash: " + e);
            }

            // 2. ì¼ì¼ ì´ˆê¸°í™” (ì„¹í„° 17)
            try {
                if (currentHour === 0 && currentMin === 0 && typeof _runSector17Logic === 'function') {
                    _runSector17Logic(data, ctx);
                }
            } catch (e) {
                Log.error("Sector 17 Logic Crash: " + e);
            }

            // 3. ë¡œë˜ ì¶”ì²¨ (ì„¹í„° 18)
            try {
                if (typeof _runSector18Logic === 'function') _runSector18Logic(data, ctx);
            } catch (e) {
                Log.error("Sector 18 Logic Crash: " + e);
            }

            /* [ìµœì¢… ì €ì¥] í•˜ì´ë¸Œë¦¬ë“œ ë¹„ë™ê¸° ì €ì¥ ì²˜ë¦¬ */
            if (ctx.isUpdated) {
                SaveExecutor.execute(new java.lang.Runnable({
                    run: function() { safeSaveData(data, ctx.isForceBackup); }
                }));
            }

            util_stamp("mainLoop");

        } catch (e) { 
          Log.error("Scheduler Error: " + e); }
    }, 2500);

    java.lang.System.setProperty(SCHEDULER_KEY, String(newTimer));
    java.lang.System.setProperty("CURRENT_ACTIVE_ID", MY_INSTANCE_ID);
}

   // 3. ìê°€ ë¶€í™œ ì›Œì¹˜ë… ê°€ë™ (1ë¶„ ì£¼ê¸° ê°ì‹œ)
    var newDog = setInterval(function() {
        try {
            // [ì •êµí™”] ì„¹í„° 1ì˜ MY_INSTANCE_IDë¥¼ í‘œì¤€ìœ¼ë¡œ ì‚¬ìš©
            // ì‹œìŠ¤í…œì— ì €ì¥ëœ í˜„ì¬ í™œì„± ID(CURRENT_ACTIVE_ID)ë¥¼ ê°€ì ¸ì™€ ë¹„êµí•©ë‹ˆë‹¤.
            var activeId = java.lang.System.getProperty("CURRENT_ACTIVE_ID");

            // ë‚´ IDê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ê±°ë‚˜, ì‹œìŠ¤í…œì˜ í™œì„± IDì™€ ë‚´ê°€ ë‹¤ë¥´ë©´ (ì¤‘ë³µ ì‹¤í–‰ ìƒíƒœ) ì¦‰ì‹œ ì¢…ë£Œ
            if (typeof MY_INSTANCE_ID === 'undefined' || activeId !== MY_INSTANCE_ID) {
                clearInterval(newDog);
                return;
            }

            var data = getDatabase();
            if (!data || !data.statusCheck || !data.statusCheck.mainLoop) return;

            var lastHeartbeat = data.statusCheck.mainLoop;
            var diff = Date.now() - lastHeartbeat;

            // ì§€ì—° ì„ê³„ì¹˜ 3ë¶„(180,000ms) ì²´í¬
            if (diff > 180000) { 
                Log.error("ğŸš¨ [Watchdog] ì—”ì§„ ì •ì§€ ê°ì§€! ì‹œìŠ¤í…œì„ ê°•ì œ ì¬ì í™”í•©ë‹ˆë‹¤.");
                try { 
                    Api.replyRoom("ë² ë¦­ë°©", "ğŸ›¡ï¸ [ì‹œìŠ¤í…œ ìê°€ ë³µêµ¬]\nìŠ¤ì¼€ì¤„ëŸ¬ ì •ì§€ê°€ ê°ì§€ë˜ì–´ ì—”ì§„ì„ ê°•ì œ ì¬ê°€ë™í–ˆìŠµë‹ˆë‹¤."); 
                } catch(e) {}
                runScheduler(); 
            }
        } catch (e) { 
            Log.error("Watchdog Runtime Error: " + e); 
        }
    }, 60000); 

    java.lang.System.setProperty(WATCHDOG_KEY, String(newDog));

/**
 * ë””ìŠ¤ì½”ë“œ íŒŒì¼ ì „ì†¡ í—¬í¼ í•¨ìˆ˜
 */
function _sendDiscordFile(url, filePath, fileName) {
    Executor.execute(new java.lang.Runnable({
        run: function() {
            try {
                var file = new java.io.File(filePath);
                if (!file.exists()) return;

                org.jsoup.Jsoup.connect(url)
                    .data("file", fileName, new java.io.FileInputStream(file))
                    .ignoreContentType(true)
                    .ignoreHttpErrors(true)
                    .method(org.jsoup.Connection.Method.POST)
                    .execute();
                
                Log.info("[Remote Backup] " + fileName + " ì „ì†¡ ì„±ê³µ");
            } catch (e) {
                Log.error("Discord Backup Fail: " + e);
            }
        }
    }));
}

/** * [Gemini ìš”ì²­ ì‚¬í•­] ëŒ€ì‹œë³´ë“œ ë°ì´í„° ì „ì†¡ í•¨ìˆ˜ (ë¶€ë™ì‚° ë°ì´í„° ì „ì†¡ ê·œê²©)
 * ì£¼ì‹(stocks) í•„ë“œë¥¼ ëœë“œë§ˆí¬(landmarks) í•„ë“œë¡œ êµì²´í•˜ì—¬ ì „ì†¡í•©ë‹ˆë‹¤.
 */
function _sendToDashboard(data, ctx) {
    var totalPoints = 0;
    var userCount = 0;
    
    var mainRoomData = data.rooms[ctx.targetRoom];
    
    if (mainRoomData && mainRoomData.users) {
        for (var u in mainRoomData.users) {
            var userObj = mainRoomData.users[u];
            totalPoints += (Number(userObj.point || 0) + Number(userObj.bank || 0));
            userCount++;
        }
        
        if (mainRoomData.bankReserve !== undefined) {
            totalPoints += Number(mainRoomData.bankReserve);
        }
    }

    var payload = {
        total_money: totalPoints,
        user_count: userCount,
        landmarks: data.landmarkMarket || {}
    };

    Executor.execute(new java.lang.Runnable({
        run: function() {
            try {
                org.jsoup.Jsoup.connect(ctx.dashboardUrl)
                    .header("Content-Type", "application/json")
                    .requestBody(JSON.stringify(payload))
                    .ignoreContentType(true)
                    .ignoreHttpErrors(true)
                    .method(org.jsoup.Connection.Method.POST)
                    .execute();
            } catch (e) { Log.error("Dashboard Sync Error: " + e); }
        }
    }));
}

/**
 * í•´ìƒ ì•½íƒˆ ì‹¤ì‹œê°„ í”„ë¡œì„¸ì„œ ë° ì§ì—… ìœ ì§€ê´€ë¦¬ ì—”ì§„
 * ê¸°ëŠ¥ 1: 3ë¶„ê°„ í† ë²Œë˜ì§€ ì•Šì€ ì•½íƒˆ ì„¸ì…˜ì„ 'ì„±ê³µ'ìœ¼ë¡œ í™•ì • ì •ì‚°
 * ê¸°ëŠ¥ 2: 7ì¼ê°„ ë¬´ì—­/ì•½íƒˆ/í† ë²Œ í™œë™ì´ ì—†ëŠ” ìœ ì €ì˜ ì§ì—… ê°•ì œ ë°•íƒˆ
 */
function _runSeaPillageScheduler(data, ctx) {
    var nowTs = Date.now();
    var cfg = SYSTEM_CONFIG.TRADE.JOBS.PIRATE;

    // [Part 1: 3ë¶„ ì•½íƒˆ íƒ€ì´ë¨¸ ê°ì‹œ]
    for (var rName in data.rooms) {
        var roomObj = data.rooms[rName];
        if (!roomObj.features || !roomObj.features.activePillages) continue;

        var pillages = roomObj.features.activePillages;
        for (var victimUid in pillages) {
            var p = pillages[victimUid];
            
            // í•´ì  ìœ ì € ê°ì²´ í™•ë³´
            var pirateObj = null;
            for (var r in data.rooms) { if (data.rooms[r].users[p.pirateUid]) { pirateObj = data.rooms[r].users[p.pirateUid]; break; } }

            // í•´ì ì™• ì¹­í˜¸ ì¥ì°© ì‹œ ì‹œê°„ 30% ê°ì†Œ (180,000ms * 0.7 = 126,000ms)
            var basePillageTime = cfg.pillageTime || 180000;
            var requiredTime = (pirateObj && pirateObj.title === "í•´ì ì™•") ? Math.floor(basePillageTime * 0.7) : basePillageTime;
            
            if (nowTs - p.startTime >= requiredTime) {
                if (typeof _processPillageSuccess === 'function') {
                    // Sector 53ì˜ ì•½íƒˆ ì„±ê³µ ì •ì‚° í•¨ìˆ˜ í˜¸ì¶œ
                    _processPillageSuccess(victimUid, p, data, rName);
                    delete pillages[victimUid]; // ì„¸ì…˜ ì¢…ë£Œ
                    ctx.isUpdated = true;
                }
            }
        }
    }

    // [Part 2: 7ì¼ ë¯¸í™œë™ ì§ì—… ë°•íƒˆ] (ë§¤ì¼ 00ì‹œ 10ë¶„ì— 1íšŒ ìˆ˜í–‰)
    if (ctx.now.getHours() === 0 && ctx.now.getMinutes() === 10 && data.lastJobCleanupDate !== ctx.today) {
        data.lastJobCleanupDate = ctx.today;
        var oneWeekMs = 7 * 24 * 60 * 60 * 1000;
        var purgeCount = 0;

        for (var r in data.rooms) {
            var users = data.rooms[r].users;
            for (var uid in users) {
                var u = users[uid];
                if (u.job) {
                    // ë§ˆì§€ë§‰ ì§ì—… í™œë™(ë¬´ì—­/ì•½íƒˆ/í† ë²Œ) ì‹œê°„ ì²´í¬
                    var lastAct = u.lastJobActivityTime || new Date(u.jobJoinDate).getTime() || 0;
                    if (nowTs - lastAct > oneWeekMs) {
                        var jobName = (u.job === 'pirate' ? "í•´ì " : "í•´êµ°");
                        u.job = null;
                        u.jobJoinDate = "";
                        u.infamy = 0;
                        u.fame = 0;
                        u.currentBounty = 0;
                        
                        try {
                            Api.replyRoom(r, "ğŸ“¢ [ì¸ì‚¬ í–‰ì • ì•Œë¦¼]\nìœ ì € '" + u.name + "'ë‹˜ì€ 7ì¼ê°„ í•´ìƒ í™œë™ì´ ì—†ì–´ [" + jobName + "] ì§ìœ„ì—ì„œ ìë™ í•´ì„ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        } catch(e) {}
                        purgeCount++;
                    }
                }
            }
        }
        if (purgeCount > 0) {
            Log.info("[System] ì¥ê¸° ë¯¸í™œë™ ì§ì—…êµ° " + purgeCount + "ëª… ì •ë¦¬ ì™„ë£Œ.");
            ctx.isUpdated = true;
        }
    }
}

//==========ì„¹í„°16-2==========

/* [ì‹ ì„¤] ì§€ëŠ¥í˜• ê²½ì œ ìˆœí™˜ ì´ë²¤íŠ¸ (3ì¢… ëœë¤ - ì¦‰ì‹œ ë°œë™í˜•) */
function _runEconomicStimulus(data, ctx) {
    var roomName = ctx.targetRoom;
    var roomData = data.rooms[roomName];
    if (!roomData || !roomData.economyBase) return;

    var reserve = Number(roomData.bankReserve || 0);
    var base = Number(roomData.economyBase);
    
    // [ì¡°ê±´] ê¸°ì¤€ì  150% ì´ˆê³¼ ì‹œ 'ì¦‰ì‹œ' ë°œë™ (í•˜ë£¨ 1íšŒ ì œí•œ)
    if (reserve > base * 1.5 && data.lastStimulusDate !== ctx.today) {
        
        data.lastStimulusDate = ctx.today;
        var excess = reserve - base; // ì´ˆê³¼ë¶„ ê³„ì‚°
        var eventType = Math.floor(Math.random() * 3) + 1; // 1~3 ëœë¤ ì„ íƒ

        // â‘  [ì§ì ‘ ë¶„ë°°] íŠ¹ë³„ ë°°ë‹¹ê¸ˆ (ì´ˆê³¼ë¶„ì˜ 10% í™˜ì›)
        if (eventType === 1) {
            var totalGiveaway = Math.floor(excess * 0.1);
            var activeUsers = [];
            var nowTs = Date.now();
            for (var uid in roomData.users) {
                // ìµœê·¼ 3ì¼ ë‚´ ì ‘ì†ìë§Œ ëŒ€ìƒ
                if (nowTs - (new Date(roomData.users[uid].lastDate).getTime() || 0) < 3 * 86400000) {
                    activeUsers.push(roomData.users[uid]);
                }
            }

            if (activeUsers.length > 0) {
                var perUser = Math.floor(totalGiveaway / activeUsers.length);
                activeUsers.forEach(function(u) {
                    var res = processRepayment(u, perUser, u.uid, roomName);
                    util_updatePoint(u, roomData, Number(res.actualGain), "êµ­ê°€ íŠ¹ë³„ ë°°ë‹¹ê¸ˆ", roomName);
                });
                
                var msg1 = "ğŸŠ [êµ­ê°€ ê²½ì œ í˜¸í™©: íŠ¹ë³„ ë°°ë‹¹ê¸ˆ ì§€ê¸‰] ğŸŠ\n" +
                           "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                           "ì¤‘ì•™ì€í–‰ì˜ ìˆ˜ìµì´ ê¸°ì¤€ì¹˜ë¥¼ ì´ˆê³¼í•˜ì—¬\n" +
                           "êµ­ë¯¼ ì—¬ëŸ¬ë¶„ê»˜ ë°°ë‹¹ê¸ˆì„ ì¦‰ì‹œ í™˜ì›í•©ë‹ˆë‹¤!\n\n" +
                           "ğŸ’° ì´ í™˜ì› ê·œëª¨: " + fp(totalGiveaway) + "P (êµ­ê³  ì§€ì¶œ)\n" +
                           "ğŸ‘¥ ëŒ€ìƒ ì¸ì›: " + activeUsers.length + "ëª…\n" +
                           "ğŸ§§ ì¸ë‹¹ ë°°ë‹¹: +" + fp(perUser) + "P\n" +
                           "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                           "ğŸ’¡ ë¹šì´ ìˆëŠ” ê²½ìš° ìš°ì„  ìƒí™˜ë˜ì—ˆìŠµë‹ˆë‹¤.";
                Api.replyRoom(roomName, msg1);
            }
        }

        // â‘¡ [ë„ë°• í™œì„±í™”] ì­íŒŸ/ì´ì›”ê¸ˆ ì§€ì› (ì´ˆê³¼ë¶„ì˜ 10% íˆ¬ì…)
        else if (eventType === 2) {
            var supportAmt = Math.floor(excess * 0.1);
            var halfAmt = Math.floor(supportAmt / 2);
            
            data.lotto_jackpot_pool = (Number(data.lotto_jackpot_pool) || 0) + halfAmt;
            if (roomData.features && roomData.features.racing) {
                roomData.features.racing.carryOver = (Number(roomData.features.racing.carryOver) || 0) + halfAmt;
            }
            util_updateReserve(roomData, -supportAmt, "ë„ë°• ì‚°ì—… ì§„í¥ ì§€ì›ê¸ˆ", roomName);

            var msg2 = "ğŸ° [êµ­ê°€ ì§€ì›: ì‚¬í–‰ì„± ì‚°ì—… ì§„í¥ì±…] ğŸ°\n" +
                       "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                       "ê²½ê¸° ë¶€ì–‘ì„ ìœ„í•´ ì¤‘ì•™ì€í–‰ì´ ë§‰ëŒ€í•œ ìê¸ˆì„ íˆ¬ì…í•©ë‹ˆë‹¤!\n\n" +
                       "ğŸ‡ ê²½ë§ˆì¥ ì´ì›”ê¸ˆ: +" + fp(halfAmt) + "P ì§€ì›!\n" +
                       "ğŸ« ë¡œë˜ ì­íŒŸ: +" + fp(halfAmt) + "P ì§€ì›!\n" +
                       "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                       "ì§€ê¸ˆ ë°”ë¡œ ì¼í™•ì²œê¸ˆì˜ ê¸°íšŒë¥¼ ë…¸ë¦¬ì„¸ìš”!";
            Api.replyRoom(roomName, msg2);
        }

        // â‘¢ [ìƒì‚°ì„± í–¥ìƒ] 1:1 ë§¤ì¹­ ë³´ë„ˆìŠ¤ (2ì‹œê°„ ì§€ì†)
        else if (eventType === 3) {
            data.stimulusEndTime = Date.now() + (2 * 60 * 60 * 1000);
            
            var msg3 = "â›ï¸ [ê¸´ê¸‰: ìƒì‚°ì„± 1:1 ë§¤ì¹­ ì§€ì› ì‚¬ì—…] ğŸ£\n" +
                       "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                       "êµ­ê°€ ê²½ì œ í™œì„±í™”ë¥¼ ìœ„í•´ 'ê·¼ë¡œ ì¥ë ¤ê¸ˆ'ì´ ì§€ê¸‰ë©ë‹ˆë‹¤.\n\n" +
                       "â³ ì§€ì† ì‹œê°„: ì§€ê¸ˆë¶€í„° 2ì‹œê°„ ë™ì•ˆ\n" +
                       "âœ¨ íš¨ê³¼: ê´‘ì‚°/ë‚šì‹œ ìˆ˜ìµì˜ 100%ë¥¼ ì€í–‰ì´ ì¶”ê°€ ì§€ê¸‰!\n" +
                       "(ì˜ˆ: 1,000P ì±„êµ´ ì‹œ âœ ì€í–‰ì´ +1,000P ë” ì–¹ì–´ì¤Œ)\n" +
                       "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                       "\"ì¼í•œ ë§Œí¼ ë” ë“œë¦½ë‹ˆë‹¤! ì§€ê¸ˆ ë°”ë¡œ ì›€ì§ì´ì„¸ìš”!\"";
            Api.replyRoom(roomName, msg3);
        }
        
        ctx.isUpdated = true;
    }
}

/* ë…ë¦½ ë¡œì§ í•¨ìˆ˜: ì‚¬ì±„ ë° ì‹œìŠ¤í…œ ê´€ë¦¬ + ë¶€ë™ì‚° ìŠ¤ì¼€ì¤„ëŸ¬ í†µí•© ì—”ì§„ */
function _runSector16Logic(data, ctx) {
    if (ALLOWED_ROOMS.indexOf(ctx.targetRoom) === -1) return;
    try { _runEconomicStimulus(data, ctx); } catch(e) {}
    var nowTs = ctx.now.getTime();
    var currentHour = ctx.now.getHours();
    var currentMin = ctx.now.getMinutes();
    var currentSec = ctx.now.getSeconds();
    var conf = SYSTEM_CONFIG.ECO.LANDMARK;
    var rConf = SYSTEM_CONFIG.ECO.RACING; 
    var mani = conf.MANIPULATION;

    var mainRoomData = data.rooms[ctx.targetRoom];
    if (!mainRoomData || !mainRoomData.features) return; 

    var racingData = mainRoomData.features.racing;
    var lotto = mainRoomData.features.lotto;

    var gov = mainRoomData.features.government;

    /* [ê°€ìƒ ì •ë¶€] 1. ì•ˆê±´ ìë™ ë°œì˜ (20:00) */
    if (currentHour === 20 && currentMin === 0 && gov.lastBillDate !== ctx.today) {
        if (typeof gov_generateBill === 'function') {
            gov.pendingBill = gov_generateBill(); // ì•ˆê±´ ìƒì„± (ì„¹í„° 46 ë¡œì§)
            gov.votes = { pro: 0, con: 0, voters: [] };
            gov.lastBillDate = ctx.today;
            gov.isClosing = false;
            gov.resultStatus = null;

            var billMsg = "ğŸ›ï¸ [ë‚´ë¦¬ë‹¤ ì˜íšŒ ì•ˆê±´ ë°œì˜]\n" +
                          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                          "ğŸ“œ ì•ˆê±´: " + gov.pendingBill.name + "\n\n" +
                          "âœ… í˜œíƒ: " + gov.pendingBill.buffDesc + "\n" +
                          "âš ï¸ ëŒ€ê°€: " + gov.pendingBill.penaltyDesc + "\n" +
                          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                          "ğŸ•’ íˆ¬í‘œ ì‹œê°„: 20:00 ~ 23:50\n" +
                          "ğŸ ì°¸ì—¬ ë³´ìƒ: 2000P (ì¦‰ì‹œ ì§€ê¸‰)\n\n" +
                          "ğŸ’¡ ì°¸ì—¬: [/íˆ¬í‘œ ì°¬ì„±] ë˜ëŠ” [/íˆ¬í‘œ ë°˜ëŒ€]\n" +
                          "(ì°¸ì—¬ìœ¨ 50% ë¯¸ë§Œ ì‹œ ê¸°ê°ë©ë‹ˆë‹¤)";
            Api.replyRoom(ctx.targetRoom, billMsg);
            ctx.isUpdated = true;
        }
    }

    /* [ê°€ìƒ ì •ë¶€] 2. íˆ¬í‘œ ë§ˆê° ë° ì •ì¡±ìˆ˜ ê²€ì¦ (23:50) */
    if (currentHour === 23 && currentMin === 50 && gov.pendingBill && !gov.isClosing) {
        gov.isClosing = true;
        
        // ì •ì¡±ìˆ˜ ê³„ì‚°: ì˜¤ëŠ˜ ì¶œì„í•œ ìœ ì € ê¸°ì¤€ 50%
        var attendees = 0;
        for (var uid in mainRoomData.users) {
            if (mainRoomData.users[uid].lastDate === ctx.today) attendees++;
        }
        var quorum = Math.ceil(attendees * 0.25);
        var participantCount = gov.votes.voters.length;

        if (participantCount < quorum) {
            gov.resultStatus = "REJECTED_QUORUM";
            var failMsg = "ğŸ“¢ [ì˜íšŒ í†µë³´] ê¸ˆì¼ ì•ˆê±´ì´ ê¸°ê°ë˜ì—ˆìŠµë‹ˆë‹¤.\n" +
                          "ì‚¬ìœ : íˆ¬í‘œ ì •ì¡±ìˆ˜ ë¯¸ë‹¬\n" +
                          "(ì°¸ì—¬: " + participantCount + "ëª… / í•„ìš”: " + quorum + "ëª…)";
            Api.replyRoom(ctx.targetRoom, failMsg);
        } else {
            gov.resultStatus = (gov.votes.pro > gov.votes.con) ? "PASSED" : "REJECTED_VOTE";
            var resultText = (gov.resultStatus === "PASSED") ? "ê°€ê²° (ì°¬ì„± ê³¼ë°˜)" : "ë¶€ê²° (ë°˜ëŒ€ ê³¼ë°˜)";
            var finalMsg = "ğŸ›ï¸ [ì˜íšŒ íˆ¬í‘œ ì¢…ë£Œ]\nê²°ê³¼: " + resultText + "\n" +
                           "(ì°¬ì„± " + gov.votes.pro + "í‘œ / ë°˜ëŒ€ " + gov.votes.con + "í‘œ)\n\n" +
                           "ğŸ’¡ ê°€ê²°ëœ ì •ì±…ì€ 00ì‹œ 05ë¶„ì— ë°œíš¨ë©ë‹ˆë‹¤.";
            Api.replyRoom(ctx.targetRoom, finalMsg);
        }
        ctx.isUpdated = true;
    }

    /* [ê°€ìƒ ì •ë¶€] 3. ì •ì±… ê³µì‹ ì ìš© (00:05) */
    // ì¼ì¼ ì´ˆê¸°í™” ë¡œì§ë³´ë‹¤ ìš°ì„ ê¶Œì„ ê°–ë„ë¡ currentMin === 5 ì¡°ê±´ì—ì„œ ì •ì‚° ìš°ì„  ì‹¤í–‰
    if (currentHour === 0 && currentMin === 5 && gov.resultStatus !== null) {
        if (gov.resultStatus === "PASSED") {
            gov.activePolicy = JSON.parse(JSON.stringify(gov.pendingBill.effects));
            Api.replyRoom(ctx.targetRoom, "ğŸ›ï¸ [ì •ë¶€ ê³µí‘œ] ìƒˆë¡œìš´ ì •ì±… ë°œíš¨!\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nì•ˆê±´ '" + gov.pendingBill.name + "'ì´ ê°€ê²°ë˜ì–´ ì§€ê¸ˆë¶€í„° ëª¨ë“  ì‹œìŠ¤í…œì— ê³µì‹ ì ìš©ë©ë‹ˆë‹¤.");
        }
        
        // ì •ì‚° ì™„ë£Œ í›„ ìƒíƒœ ì´ˆê¸°í™” (ë°ì´í„° íœ˜ë°œ ë°©ì§€)
        gov.pendingBill = null;
        gov.resultStatus = null;
        gov.isClosing = false;
        for (var userUid in mainRoomData.users) {
            mainRoomData.users[userUid].hasVotedToday = false;
        }
        ctx.isUpdated = true;
    }

    /* [ì‹œìŠ¤í…œ] 5ë¶„ ì£¼ê¸° ì˜¤í† ì„¸ì´ë¸Œ & ë¶€ë™ì‚° ì‹œì¥ ì œì–´ */
    try {
                if (currentMin % 5 === 0 && data.lastAutoSaveMin !== currentMin) {
                    data.lastAutoSaveMin = currentMin;
                    ctx.isUpdated = true;
                    ctx.isForceBackup = true; 
                }

                /* [v16.0 IPM] 5ë¶„ ì£¼ê¸° ì§€ëŠ¥í˜• ììœ¨ ìµœì í™” (Auto-Log Manager) */
                if (currentMin % 5 === 0 && data.lastMonitorMin !== currentMin) {
                    data.lastMonitorMin = currentMin;
                    var logFile = new java.io.File(JOURNAL_PATH);
                    var errLogFile = new java.io.File(ERROR_LOG_PATH);
                    var limit = (INTELLIGENT_CONFIG && INTELLIGENT_CONFIG.PERFORMANCE) ? INTELLIGENT_CONFIG.PERFORMANCE.MAX_LOG_SIZE : 1572864; // 1.5MB

                    // 1. ë¸”ë™ë°•ìŠ¤ ë¡œê·¸ ìš©ëŸ‰ ê¸°ë°˜ ìë™ ì•„ì¹´ì´ë¹™ (Auto-Rolling)
                    if (logFile.exists() && logFile.length() > limit) {
                        var archiveName = "journal_arc_" + ctx.today + "_" + Date.now() + ".log";
                        var archivePath = BASE_DIR + "logs/" + archiveName;
                        var moved = logFile.renameTo(new java.io.File(archivePath));
                        
                        if (moved) {
                            var logReport = util_formatSecurityLog(
                                "ğŸ“‚ [SYSTEM: í•˜ì´í¼ ë¡œê·¸ ë§¤ë‹ˆì €]", 
                                "IPM_CORE", 
                                "SERVER", 
                                "âœ… ë‚´ìš©: ë¡œê·¸ ìš©ëŸ‰ ì„ê³„ì¹˜ ì´ˆê³¼ë¡œ ìë™ ì•„ì¹´ì´ë¹™ ì™„ë£Œ\nğŸ“Š í¬ê¸°: " + (logFile.length()/(1024*1024)).toFixed(2) + " MB\nğŸ“„ íŒŒì¼: logs/" + archiveName,
                                "ê¸°ì¡´ ë¡œê·¸ ë°±ì—… ë° ì‹ ê·œ ë¡œê·¸ ìŠ¤íŠ¸ë¦¼ ìƒì„±"
                            );
                            try { Api.replyRoom("ë² ë¦­ë°©", logReport); } catch(e) {}
                            Log.info("[LogManager] ë¸”ë™ë°•ìŠ¤ ë¡œê·¸ ë¡¤ë§ ì™„ë£Œ.");
                        }
                    }

                    // 2. ì˜¤ë¥˜ ë¡œê·¸ ê´€ë¦¬ (0.5MB ì´ˆê³¼ ì‹œ ìë™ ë¹„ì›€)
                    if (errLogFile.exists() && errLogFile.length() > 524288) {
                        FileStream.write(ERROR_LOG_PATH, "");
                        Log.info("ğŸ§¹ [LogManager] ì˜¤ë¥˜ ë¡œê·¸ íŒŒì¼ ìë™ ì†Œê° (ìš©ëŸ‰ ì´ˆê³¼)");
                    }

                    if (PERF_METRICS.avgLag > (INTELLIGENT_CONFIG ? INTELLIGENT_CONFIG.PERFORMANCE.LAG_THRESHOLD_MS : 450)) {
                        globalData.nameToIdCache = {}; 
                        java.lang.System.gc();        
                        Log.warn("[IPM] ì„±ëŠ¥ ì €í•˜ê°€ ê°ì§€ë˜ì–´ ë©”ëª¨ë¦¬ ê¸´ê¸‰ ìµœì í™”ë¥¼ ìˆ˜í–‰í–ˆìŠµë‹ˆë‹¤.");
                    }
                    PERF_METRICS.msgPerMin = 0; 
                }

        // [ë¶€ë™ì‚°] ê°œì¥ ì‹œ ì‹œê°€ ë™ê¸°í™” ë¡œì§
        if (currentHour === conf.SETTINGS.OPEN_HOUR && currentMin === 0 && data.lastMarketOpenDate !== ctx.today) {
            data.lastMarketOpenDate = ctx.today;
            if (data.landmarkMarket) {
                for (var lKey in data.landmarkMarket) {
                    data.landmarkMarket[lKey].openPrice = data.landmarkMarket[lKey].price;
                }
                ctx.isUpdated = true;
            }
        }
    } catch(e) { Log.error("Sys/Save Logic Error: " + e); }

    /* [2. ë¶€ë™ì‚° ì‹œì„¸ ë³€ë™ í†µí•© ì—”ì§„] (ì •ê° 1íšŒ ì‹¤í–‰) */
    // ì„¤ëª…: ê¸°ì¡´ì— íŒŒí¸í™”ë˜ì–´ ìˆë˜ 10ë¶„ ì£¼ê¸° ë¡œì§ê³¼ ì£¼ì‹(Stock) ë¡œì§ì„ ëª¨ë‘ ì œê±°í•˜ê³  ì´ í•˜ë‚˜ë¡œ í†µí•©í•©ë‹ˆë‹¤.
    try {
        var landCfg = SYSTEM_CONFIG.ECO.LANDMARK.SETTINGS;
        if (currentHour >= landCfg.OPEN_HOUR && currentHour <= landCfg.CLOSE_HOUR && currentMin === 0 && data.lastLandUpdateHour !== currentHour) {
            
            data.lastLandUpdateHour = currentHour; 

            if (mani && mani.ACTIVE === true) {
                data.pendingSpecialEffect = { landmark: mani.TARGET, factor: mani.IS_UP ? Math.abs(mani.RATE) : -Math.abs(mani.RATE), forceMani: true };
            }
            
            var landResult = updateLandmarkPrices(data);
            if (mainRoomData.features) mainRoomData.features.msgCount = 0;

            var statusText = "ğŸŸ¢ ë¶€ë™ì‚° ì‹œì¥ ìš´ì˜ ì¤‘ (" + landCfg.OPEN_HOUR + ":00 ~ " + landCfg.CLOSE_HOUR + ":59)";
            var body = "ğŸ“ˆ ë¶€ë™ì‚° ì‹œì„¸ ë³€ë™\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + statusText + "\n\n" + (generateLandmarkList(data, ctx.targetRoom) || "ë§¤ë¬¼ ì •ë³´ ì—†ìŒ");
            
            if (landResult && landResult.length > 0) body += "\n\n" + landResult.join("\n");
            body += "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”";
            
            Api.replyRoom(ctx.targetRoom, body);
            ctx.isUpdated = true;
            util_stamp("landmarkLogic");
        }
    } catch (e) { Log.error("Landmark Engine Error: " + e); }

    /* ë¬´ì—­ ì‹œìŠ¤í…œ 1ì‹œê°„ ì£¼ê¸° ìˆœí™˜ ì‹œì„¸ ë³€ë™ ì—”ì§„ */
    /**
     * ê¸°ëŠ¥: ë§¤ì‹œ 30ë¶„ ì •ê°ì— 5ê°œêµ­ì˜ ì„ í˜¸/ê¸°í”¼ í’ˆëª©ì„ 'ìˆœí™˜ ë§¤ì¹­' ë°©ì‹ìœ¼ë¡œ êµì²´ (1ì‹œê°„ ì£¼ê¸°)
     * ê·œì¹™: ìêµ­ ìƒì‚° í’ˆëª©ì€ ì ˆëŒ€ ì„ í˜¸/ê¸°í”¼ì— í¬í•¨ë˜ì§€ ì•ŠìŒ (ìˆ˜ì… í•„ìš”ì„± ê°•ì¡°)
     */
    try {
        var tradeCfg = SYSTEM_CONFIG.TRADE;
        if (currentMin === 30 && data.lastTradeUpdateHour !== currentHour) {
            data.lastTradeUpdateHour = currentHour;
            
            if (!mainRoomData.features.tradeMarket) mainRoomData.features.tradeMarket = {};
            
            // ìˆœí™˜ ë§¤ì¹­ì„ ìœ„í•œ í‘œì¤€ ë°°ì—´ ì •ì˜ (ìƒì‚°í’ˆ ê¸°ì¤€)
            var nations = ["í¬ë¥´íˆ¬", "ì½”ì½œë¼", "ë‚˜í´ë¦¬", "ë² ë¼í¬ë£¨ìŠ¤", "í‚´ë²Œë¦¬"];
            var goods = ["ì‹ë£Œí’ˆ", "ê³µì—…í’ˆ", "ê³µì˜ˆí’ˆ", "ê·€ê¸ˆì†", "ë³´ì„"];
            
            // [ìˆ˜ì •]: ì¤‘ë³µ í—ˆìš© ë° ìµœëŒ€ ì¤‘ë³µ 3ê°œ ì œí•œ ë¡œì§ ì ìš©
            var favIndices = [];
            var goodsPickCount = [0, 0, 0, 0, 0]; // ê° í’ˆëª©ì´ ì„ íƒëœ íšŸìˆ˜ ê¸°ë¡

            for (var i = 0; i < 5; i++) {
                var candidates = [];
                for (var j = 0; j < 5; j++) {
                    // ê·œì¹™ 1: ìêµ­ ìƒì‚° í’ˆëª© ì œì™¸ (j !== i)
                    // ê·œì¹™ 2: ë™ì¼ í’ˆëª©ì€ ì „ ì„¸ê³„ì—ì„œ ìµœëŒ€ 3íšŒê¹Œì§€ë§Œ ì„ í˜¸ë  ìˆ˜ ìˆìŒ (count < 3)
                    if (j !== i && goodsPickCount[j] < 3) {
                        candidates.push(j);
                    }
                }
                // ê°€ìš© í›„ë³´ ì¤‘ ëœë¤ ì„ íƒ
                var selectedIdx = candidates[Math.floor(Math.random() * candidates.length)];
                favIndices[i] = selectedIdx;
                goodsPickCount[selectedIdx]++;
            }

            for (var i = 0; i < nations.length; i++) {
                var nName = nations[i];
                var favIdx = favIndices[i]; // ì´ë²ˆ êµ­ê°€ì˜ ì„ í˜¸ í’ˆëª© í™•ì •
                
                // 3. ê¸°í”¼ í’ˆëª©ì€ ì„ í˜¸ í’ˆëª©ê³¼ ìêµ­ ìƒì‚°ë¬¼ì„ ì œì™¸í•œ ë‚˜ë¨¸ì§€ 3ê°œ ì¤‘ í•˜ë‚˜ë¡œ ì„ íƒ
                var hatePool = [];
                for (var j = 0; j < 5; j++) {
                    if (j !== i && j !== favIdx) hatePool.push(j);
                }
                var hateIdx = hatePool[Math.floor(Math.random() * hatePool.length)];

                mainRoomData.features.tradeMarket[nName] = {
                    favorite: goods[favIdx],
                    hate: goods[hateIdx],
                    specialty: tradeCfg.NATIONS[nName].specialty
                };
            }

            var tradeNotice = "âš™ï¸ [ë‚´ë¦¬ë‹¤ ë¬´ì—­ ì§€ë¶€ ê³µë³´]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                              "ğŸŒ ì„¸ê³„ êµì—­ ì‹œì„¸ê°€ 'ìˆœí™˜ ë§¤ì¹­'ìœ¼ë¡œ ë³€ë™ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n" +
                              "ê° êµ­ê°€ëŠ” í˜„ì¬ ë¶€ì¡±í•œ íƒ€êµ­ ë¬¼ìë¥¼ ì„ í˜¸í•˜ë©°,\nìêµ­ ìƒì‚° í’ˆëª©ì€ ì¼ì ˆ ë§¤ì…í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n" +
                              "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                              "ğŸ’¡ í™•ì¸: [/ë¬´ì—­] â” 1. ì„¸ê³„ ì‹œì„¸ í™•ì¸\n" +
                              "(â€» ì‹œì„¸ëŠ” ë§¤ì‹œ 30ë¶„ ì •ê°ì— ë³€ë™ë©ë‹ˆë‹¤.)";
            
            Api.replyRoom(ctx.targetRoom, tradeNotice);
            ctx.isUpdated = true;
            util_stamp("tradeMarketLogic");
        }
    } catch (e) { Log.error("Trade Market Update Error: " + e); }

    /* [1. ì‚¬ì±„ ë° ê²½ì œ ê°ì‹œ ì—”ì§„] (ë³´ì¡´ êµ¬ì—­) */
    // ì„¤ëª…: êµ­ê°€ ë¶€ë„, ì‚¬ì±„ ì´ì, ê°•ì œ ì¶”ì‹¬ ë“± ì‹œìŠ¤í…œ ì•ˆì •ì„±ì„ ìœ„í•œ í•µì‹¬ ë¡œì§ì…ë‹ˆë‹¤.
    try {
        for (var rName in data.rooms) {
            if (ALLOWED_ROOMS.indexOf(rName) === -1) continue;
            var roomData = data.rooms[rName];
            if (!roomData.loanContracts) roomData.loanContracts = {};

            if (roomData.bankReserve !== undefined) {
                var reserve = roomData.bankReserve;
                if (!roomData.lastBankAlert) roomData.lastBankAlert = "normal";

                var roomBase = roomData.economyBase || 3500000;
                var dangerLimit = Math.floor(roomBase * 0.3);
                var disasterLimit = Math.floor(roomBase * 0.1);
                var normalLimit = Math.floor(roomBase * 0.5);

                if (reserve < disasterLimit && roomData.lastBankAlert !== "disaster") {
                    roomData.lastBankAlert = "disaster";
                    var disasterMsg = "ğŸš¨ [êµ­ê°€ ë¶€ë„ ì„ í¬] ğŸš¨\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nì¤‘ì•™ì€í–‰ì˜ êµ­ê³ ê°€ ë°”ë‹¥ë‚¬ìŠµë‹ˆë‹¤(10% ë¯¸ë§Œ).\n\nğŸš« ë™ê²°: ë¶€ë™ì‚° ë§¤ë§¤, ì¹´ì§€ë…¸, ê²½ë§ˆ ë“± ëª¨ë“  íˆ¬ì í™œë™ì´ ì „ë©´ ê¸ˆì§€ë©ë‹ˆë‹¤.\nğŸ¥ ì œí•œ: ì¶œì„ ë° ë³µì§€ í¬ì¸íŠ¸ê°€ 50% ì‚­ê°ë©ë‹ˆë‹¤.\n\nâš ï¸ í•´ì œ ì¡°ê±´: êµ­ê³ ê°€ ê¸°ì¤€ì ì˜ 50%(" + fp(normalLimit) + "P) ì´ìƒ ì¶©ì „ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.";
                    Api.replyRoom(rName, disasterMsg);
                    ctx.isUpdated = true;
                }
                else if (reserve < dangerLimit && reserve >= disasterLimit && roomData.lastBankAlert === "normal") {
                    roomData.lastBankAlert = "warning";
                    var warningMsg = "âš ï¸ [êµ­ê°€ ë¶€ë„ ìœ„í—˜ ì•Œë¦¼]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nì¤‘ì•™ì€í–‰ ì¬ì›ì´ ìœ„í—˜ ìˆ˜ì¤€(30% ë¯¸ë§Œ)ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.\n\nğŸ¦ í˜„ì¬ ê¸ˆê³ : " + fp(reserve) + "P\nğŸ’¡ ì§€ì†ì ì¸ êµ­ê³  ìœ ì¶œ ì‹œ ë¶€ë„ê°€ ì„ í¬ë˜ì–´ ëª¨ë“  ê²½ì œ í™œë™ì´ ë™ê²°ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
                    Api.replyRoom(rName, warningMsg);
                    ctx.isUpdated = true;
                }
                else if (reserve >= normalLimit && (roomData.lastBankAlert === "warning" || roomData.lastBankAlert === "disaster")) {
                    roomData.lastBankAlert = "normal";
                    var normalMsg = "âœ… [êµ­ê°€ ë¶€ë„ í•´ì œ]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nêµ­ê³ ê°€ ì•ˆì •ê¶Œ(50% ì´ìƒ)ìœ¼ë¡œ ë³µêµ¬ë˜ì–´ ëª¨ë“  ê²½ì œ í™œë™ì´ ì •ìƒí™”ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nğŸ”“ í•´ì œ: ë¶€ë™ì‚°, ë„ë°•, ê²½ë§ˆ ì‹œìŠ¤í…œ ì¬ê°€ë™\nğŸ’° ë³µì§€: ëª¨ë“  ë³´ìƒì´ ì •ìƒ ì§€ê¸‰ìœ¼ë¡œ ì „í™˜ë©ë‹ˆë‹¤.";
                    Api.replyRoom(rName, normalMsg);
                    ctx.isUpdated = true;
                }
            }

            for (var cid in roomData.loanContracts) {
                var c = roomData.loanContracts[cid];
                var periodsPassed = Math.floor((nowTs - c.startTime) / 10800000); 
                
                if (c.appliedPeriods === undefined) c.appliedPeriods = 0;
                
                if (periodsPassed > c.appliedPeriods) {
                    var pendingPeriods = periodsPassed - c.appliedPeriods;
                    var totalNewInterest = 0;
                    for (var i = 0; i < pendingPeriods; i++) {
                        var currentDebt = Number(c.currentDebt || 0);
                        var interest = Math.floor(currentDebt * (Number(c.rate) / 100));
                        c.currentDebt = currentDebt + interest;
                        totalNewInterest += interest;
                    }
                    c.appliedPeriods = periodsPassed;
                    ctx.isUpdated = true;
                    
                    try {
                        var interestMsg = "ğŸš¬ [ì‚¬ì±„ ì´ì ê°±ì‹ ]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ‘¤ ëŒ€ìƒ: " + c.borrowerName + "ë‹˜\nğŸ¤ ì±„ê¶Œì: " + c.lenderName + "\nğŸ•’ ê²½ê³¼: " + (periodsPassed * 3) + "ì‹œê°„\nğŸ’° ì¶”ê°€ ì´ì: +" + fp(totalNewInterest) + "P\nğŸ“‰ í˜„ì¬ ì±„ë¬´: " + fp(c.currentDebt) + "P\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”";
                        Api.replyRoom(rName, interestMsg);
                    } catch(e) {}
                }

                var duration = nowTs - c.startTime;
                var overdueLimit = 24 * 60 * 60 * 1000;
                var bankTakeoverLimit = 36 * 60 * 60 * 1000;

                if (c.status === 'active' && duration > overdueLimit && duration <= bankTakeoverLimit) {
                    c.status = 'overdue'; ctx.isUpdated = true;
                    try { Api.replyRoom(rName, "ğŸš¨ [ê°•ì œ ì¶”ì‹¬ ì§‘í–‰ ì•Œë¦¼]\nëŒ€ìƒ: " + c.borrowerName + "ë‹˜\nì‚¬ìœ : ìƒí™˜ ê¸°í•œ(24ì‹œê°„) ì´ˆê³¼\n\nì§€ê¸ˆë¶€í„° ìˆ˜ìµì˜ 50%ê°€ ì±„ê¶Œìì—ê²Œ ìë™ ê·€ì†ë©ë‹ˆë‹¤."); } catch(e){}
                }
                else if (duration > bankTakeoverLimit) {
                    var amountToPay = Number(c.currentDebt);
                    var lender = roomData.users[c.lenderUid];
                    var borrower = roomData.users[c.borrowerUid];

                    if (lender && borrower) {
                        util_updatePoint(lender, roomData, amountToPay, "ì‚¬ì±„ ì€í–‰ ëŒ€ë‚© íšŒìˆ˜ (" + c.borrowerName + ")", rName);
                        if (!borrower.loan) borrower.loan = { debt: 0, items: [] };
                        borrower.loan.debt = Number(borrower.loan.debt) + amountToPay;
                        borrower.loan.items.push(amountToPay);
                        borrower.isTransferred = true; 
                        borrower.creditScore = Math.max(0, (borrower.creditScore || 600) - 120);
                        checkAndHandleDefaulter(borrower, rName);
                        
                        var takeoverMsg = "ğŸ›ï¸ [ì¤‘ì•™ì€í–‰ ëŒ€í™˜ ì§‘í–‰]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ‘¤ ëŒ€ìƒ: " + c.borrowerName + "ë‹˜\në‚´ìš©: ì‚¬ì±„ ì—°ì²´ 36ì‹œê°„ ê²½ê³¼ë¡œ ì€í–‰ì´ ëŒ€ë‚© ì²˜ë¦¬í•˜ì˜€ìŠµë‹ˆë‹¤.\n\nâš ï¸ [í˜ë„í‹°]: ì‹ ìš©ì ìˆ˜ -120ì  ê°•ë“±\nâš ï¸ í•´ë‹¹ ì±„ë¬´ëŠ” [ì€í–‰ ëŒ€í™˜ ëŒ€ì¶œ]ë¡œ ì „í™˜ë˜ì—ˆìœ¼ë©°, ëª¨ë“  ìˆ˜ìµì˜ 70%ê°€ ê°•ì œ ìƒí™˜ë©ë‹ˆë‹¤.\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”";
                        Api.replyRoom(rName, takeoverMsg);
                        delete roomData.loanContracts[cid];
                        ctx.isUpdated = true;
                    }
                }
            }
        }
    } catch (e) { Log.error("Loan/Bank Logic Error: " + e); }

    /* [3. ê²½ë§ˆ ì‹œìŠ¤í…œ í†µí•© ìŠ¤ì¼€ì¤„ëŸ¬] */
    try {
        // A. ê°œì¥ ì•Œë¦¼
        if (currentHour === rConf.OPEN_HOUR && currentMin === 0) {
            if (racingData.lastOpenDate !== ctx.today) {
                racingData.isOperating = true;
                racingData.isResultProcessed = false; 
                racingData.isDeadlineNotified = false;
                racingData.lastOpenDate = ctx.today;
                var startMsg = "ğŸ‡ [ë‚´ë¦¬ë‹¤ ê²½ë§ˆì¥ ê°œì¥ ì•Œë¦¼]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nì§€ê¸ˆë¶€í„° ì œ " + racingData.round + "íšŒì°¨ ê²½ë§ˆ ë°°íŒ…ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤!\n\nğŸ•’ ë°°íŒ… ì‹œê°„: ë§¤ì‹œ 00ë¶„ ~ 49ë¶„ 59ì´ˆ\nğŸ ê²°ê³¼ ë°œí‘œ: ë§¤ì‹œ 00ë¶„ 00ì´ˆ\nğŸš« ìš´ì˜ ì¢…ë£Œ: 23:59 (00:00 ìµœì¢… ê²°ê³¼)\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’¡ í˜„í™© í™•ì¸: [/ê²½ë§ˆ] ì…ë ¥";
                Api.replyRoom(ctx.targetRoom, startMsg);
            }
        }

        // B. ë°°íŒ… ë§ˆê° ì•Œë¦¼
        if (currentMin === 50 && !racingData.isDeadlineNotified) {
            if (currentHour >= rConf.OPEN_HOUR && currentHour <= rConf.CLOSE_HOUR) {
                racingData.isOperating = true; 
                racingData.isDeadlineNotified = true;
                var deadlineMsg = "ğŸ“¢ [ê²½ë§ˆ ë°°íŒ… ë§ˆê° ì•Œë¦¼]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nì œ " + racingData.round + "íšŒì°¨ ë°°íŒ…ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\nğŸ¦ ìµœì¢… ì§‘ê³„ í¬ì¸íŠ¸: " + fp(racingData.totalPool) + "P\nğŸ ìš°ìŠ¹ë§ˆ íŒë… ë° ì •ì‚° ì§„í–‰ ì¤‘...\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ‡ ì ì‹œ í›„ ì •ê°(00ë¶„)ì— ê²°ê³¼ê°€ ë°œí‘œë©ë‹ˆë‹¤!";
                Api.replyRoom(ctx.targetRoom, deadlineMsg);
                ctx.isUpdated = true;
            }
        }

        // C. ê²°ê³¼ ë°œí‘œ ë° ì •ì‚°
        var isRaceTime = (currentHour >= rConf.OPEN_HOUR && currentHour <= 23) || currentHour === 0;
        if (isRaceTime && currentMin === 0 && currentHour !== rConf.OPEN_HOUR) {
            if (racingData.lastProcessedHour !== currentHour) {
                racingData.isOperating = (currentHour >= rConf.OPEN_HOUR && currentHour <= 23);
                racingData.lastProcessedHour = currentHour;

                // [ì‹ ê·œ] ë°°íŒ… ë°€ì§‘ë„ì— ë”°ë¥¸ í™•ë¥  ì—­ë³´ì • (ë°°íŒ…ì´ ëª°ë¦´ìˆ˜ë¡ ìš°ìŠ¹ í™•ë¥  ê°ì†Œ)
                if (racingData.totalPool > 0) {
                    racingData.horses.forEach(function(h) {
                        var horseBetAmt = 0;
                        for (var uid in racingData.bets) {
                            if (racingData.bets[uid].horseId === h.id) {
                                horseBetAmt += Number(racingData.bets[uid].amount);
                            }
                        }
                        var betRatio = horseBetAmt / racingData.totalPool;
                        
                        // ë°€ì§‘ë„ ë³´ì • ê³„ìˆ˜: ë°°íŒ… ë¹„ìœ¨ì˜ 80%ë§Œí¼ ê°€ì¤‘ì¹˜ ì‚­ê° (ì—­ë°° ìœ ë„)
                        // ì˜ˆ: í•œ ë§ì— 100% ëª°ë¦¬ë©´ ìš°ìŠ¹ í™•ë¥ ì´ ê¸°ì¡´ì˜ 20% ìˆ˜ì¤€ìœ¼ë¡œ ê¸‰ë½
                        var penalty = 1 - (betRatio * 0.5);
                        h.weight = Math.max(0.1, h.weight * penalty); 
                    });
                }

                /* [ì¡°ì‘ ì—”ì§„] íŠ¹ì • ìœ ì €ì˜ ë°°íŒ…ë§ˆ ìš°ìŠ¹ ê°€ì¤‘ì¹˜ ë¶€ì—¬ */
                for (var uid in racingData.bets) {
                    var betUser = roomData.users[uid];
                    // ì¡°ì‘ì´ ì¼œì ¸ ìˆê³  ê²½ë§ˆ ë³´ì •ì¹˜ê°€ ì„¤ì •ëœ ê²½ìš°
                    if (betUser && betUser.isManipulated && (betUser.horseWinRate || 0) > 0) {
                        var targetHorseId = racingData.bets[uid].horseId;
                        var horse = racingData.horses[targetHorseId - 1];
                        
                        // [ë°¸ëŸ°ìŠ¤ ì¡°ì •]: 100ë°° ëŒ€ì‹  ì„¤ì •ê°’ì˜ 0.2ë°°ë¥¼ ê°€ì‚° (70% ì„¤ì • ì‹œ +14.0 ê°€ì¤‘ì¹˜)
                        // ë³´í†µ ë§ì˜ ê°€ì¤‘ì¹˜ê°€ 1.0 ë‚´ì™¸ì´ë¯€ë¡œ, 14.0ë§Œ ë”í•´ì ¸ë„ ì••ë„ì ì¸ ìš°ìŠ¹ í›„ë³´ê°€ ë©ë‹ˆë‹¤.
                        horse.weight += (betUser.horseWinRate * 0.2); 
                    }
                }
                
                var totalW = 0; racingData.horses.forEach(function(h){ totalW += h.weight; });
                var rVal = Math.random() * totalW; var accum = 0; var winner = racingData.horses[0];
                for(var i=0; i<racingData.horses.length; i++){ accum += racingData.horses[i].weight; if(rVal < accum){ winner = racingData.horses[i]; break; } }

                var tax = Math.floor(racingData.totalPool * rConf.TAX_RATE);
                var basePool = racingData.totalPool - tax + racingData.carryOver;
                var winPool = 0; var winnerUids = [];
                for(var uid in racingData.bets){ if(racingData.bets[uid].horseId === winner.id){ winPool += racingData.bets[uid].amount; winnerUids.push(uid); } }

                var mainRoom = data.rooms[ctx.targetRoom];
                // [êµì²´] ì§ì ‘ ì—°ì‚° ëŒ€ì‹  ë³´ì•ˆ ì—”ì§„ ì‚¬ìš© (ìˆ˜ìˆ˜ë£Œ ì…ê³ )
                if(mainRoom) util_updateReserve(mainRoom, tax, "ê²½ë§ˆ ìˆ˜ìˆ˜ë£Œ ì…ê³ ", ctx.targetRoom);

                var resultHeader = "ğŸ [ì œ " + racingData.round + "íšŒ ê²½ë§ˆ ê²°ê³¼ ë° ìƒˆ ê²½ê¸° ì•ˆë‚´]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n[ğŸ† ì§€ë‚œ ê²½ê¸° ê²°ê³¼]\n\"ë§ˆì§€ë§‰ ì§ì„  ì£¼ë¡œì—ì„œ " + winner.id + "ë²ˆ " + winner.name + "ê°€ ê³¨ì¸!\"\n\nğŸ¥‡ ìš°ìŠ¹ë§ˆ: [" + winner.id + "ë²ˆ " + winner.name + "]\n";
                var resultBody = "";
                
                if(winnerUids.length > 0) {
                    // [ë™ê¸°í™”]: ìµœì € ë³´ì¥ ë°°ìœ¨ì„ ìµœëŒ€ ìƒí•œ ë°°ìœ¨(MAX_PAYOUT_MULT)ê³¼ ì¼ì¹˜ì‹œí‚µë‹ˆë‹¤.
                    var targetMult = Number(rConf.MAX_PAYOUT_MULT || 7); 
                    var totalRequiredForPrize = Math.floor(winPool * targetMult);
                    
                    var subsidyNeeded = Math.max(0, totalRequiredForPrize - basePool);
                    var actualSubsidy = 0;
                    if (subsidyNeeded > 0 && mainRoom) {
                        actualSubsidy = Math.min(subsidyNeeded, mainRoom.bankReserve || 0);
                        util_updateReserve(mainRoom, -actualSubsidy, "ê²½ë§ˆ ë³´ì „ê¸ˆ ì§€ì¶œ", ctx.targetRoom);
                    }
                    var finalDistributePool = basePool + actualSubsidy;
                    var totalActuallyPaid = 0;

                    resultBody += "ğŸ›ï¸ êµ­ê³  ìˆ˜ìˆ˜ë£Œ(10%): " + fp(tax) + "P ì…ê³ \n";
                    if (actualSubsidy > 0) {
                        resultBody += "ğŸ›¡ï¸ " + targetMult + "ë°° ë°°ë‹¹ ë³´ì „ ì§€ì›: " + fp(actualSubsidy) + "P\n";
                    } else if (racingData.carryOver > 0) {
                        resultBody += "ğŸ’° ì´ì›”ê¸ˆ í¬í•¨: " + fp(racingData.carryOver) + "P ë°©ì¶œ!\n";
                    }
                    
                    resultBody += "\n[ğŸ–ï¸ ì£¼ìš” ë‹¹ì²¨ì]";
                    winnerUids.forEach(function(uId){
                        var b = racingData.bets[uId]; var u = null;
                        for(var r in data.rooms){ if(data.rooms[r].users[uId]){ u = data.rooms[r].users[uId]; break; } }
                        if(u){
                            var share = b.amount / winPool;
                            var prize = Math.floor(share * finalDistributePool);
                            
                            // [ê³ ì • ë°°ë‹¹ í•µì‹¬]: ìƒí•œì„ ê³¼ ë³´ì¥ì•¡ì„ ë™ì¼í•˜ê²Œ ì„¤ì • (targetMult ë°° ê³ ì •)
                            var fixedLimit = b.amount * targetMult; 
                            
                            // ê³„ì‚°ëœ ë‹¹ì²¨ê¸ˆì´ ë³´ì¥ì•¡ë³´ë‹¤ í¬ë©´ ë³´ì¥ì•¡(7ë°°)ìœ¼ë¡œ ê¹ê³ , 
                            // ë¶€ì¡±í•˜ë©´ ë³´ì „ê¸ˆì´ í¬í•¨ëœ prizeë¥¼ ê·¸ëŒ€ë¡œ ì§€ê¸‰í•˜ì—¬ ê²°ê³¼ì ìœ¼ë¡œ 7ë°°ë¥¼ ë§ì¶¤
                            if (prize > fixedLimit) prize = fixedLimit;

                            if (!util_isBankSolvent(ctx.targetRoom, prize)) {
                                try { Api.replyRoom(ctx.targetRoom, "ğŸš¨ [êµ­ê³  ë¶€ë„] ê²½ë§ˆ ë‹¹ì²¨ê¸ˆ ì§€ê¸‰ ëŠ¥ë ¥ì´ ë¶€ì¡±í•˜ì—¬ ì´ì›” ì²˜ë¦¬ë©ë‹ˆë‹¤."); } catch(e){}
                                return;
                            }

                            var res = processRepayment(u, prize, uId, ctx.targetRoom);
                            util_updatePoint(u, mainRoomData, Number(res.actualGain), "ê²½ë§ˆ ë‹¹ì²¨ê¸ˆ", ctx.targetRoom);
                            totalActuallyPaid += prize;
                            
                            resultBody += "\nâ€¢ " + b.name + " (+" + fp(res.actualGain) + "P) âœ¨" + targetMult + "ë°°ë³´ì¥";
                        }
                    });
                    
                    // ì •ì‚° í›„ ë‚¨ì€ ê¸ˆì•¡ì€ ë‹¤ìŒ íšŒì°¨ë¡œ ì´ì›” (íŒëˆì´ ë„˜ì³¤ì„ ê²½ìš° ëŒ€ë¹„)
                    racingData.carryOver = Math.max(0, finalDistributePool - totalActuallyPaid);
                    if (racingData.carryOver > 10) {
                        resultBody += "\n\nğŸ’° ìƒí•œ ì´ˆê³¼ë¶„ " + fp(racingData.carryOver) + "PëŠ”\në‹¤ìŒ íšŒì°¨ ë°°ë‹¹ìœ¼ë¡œ ì´ì›”ë˜ì—ˆìŠµë‹ˆë‹¤!";
                    }
               } else {
                    var currentRoundNetPool = racingData.totalPool - tax; 
                    var toBank = Math.floor(currentRoundNetPool * rConf.WINLESS_BANK_RATE); 
                    racingData.carryOver = (currentRoundNetPool - toBank) + racingData.carryOver;
                    if(mainRoom) util_updateReserve(mainRoom, toBank, "ê²½ë§ˆ ë¬´ìŠ¹ì êµ­ê³  í™˜ìˆ˜", ctx.targetRoom);
                    resultBody += "ğŸ’€ ë‹¹ì²¨ ìœ ì € ì—†ìŒ\nğŸ’° ì´ì›”ê¸ˆ ë³´ì „ ì™„ë£Œ: " + fp(racingData.carryOver) + "P\n" +
                                 "ğŸ›ï¸ ê¸ˆê¸° íŒëˆ êµ­ê³  ê·€ì†(" + (rConf.WINLESS_BANK_RATE * 100).toFixed(0) + "%): " + fp(toBank) + "P";
                }

                var isClosing = (currentHour === 0);
                if (isClosing) {
                    racingData.isOperating = false;
                    resultBody += "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’¤ ê¸ˆì¼ ê²½ë§ˆ ìš´ì˜ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\në‹¤ìŒ ê²½ê¸°ëŠ” ì˜¤ì „ 09:00ì— ì‹œì‘ë©ë‹ˆë‹¤.";
                } else {
                    resultBody += "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâœ¨ [ì œ " + (racingData.round + 1) + "íšŒ ê²½ê¸° ì‹œì‘] âœ¨\nì§€ê¸ˆë¶€í„° ë‹¤ìŒ ê²½ê¸° ë°°íŒ…ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.";
                }

                Api.replyRoom(ctx.targetRoom, resultHeader + resultBody);
                util_stamp("racingLogic");

                racingData.round++; 
                racingData.bets = {}; 
                racingData.totalPool = 0;
                racingData.isDeadlineNotified = false;
                
                var conds = [{l:"ğŸš€ ìµœìƒ",w:1.5},{l:"â˜€ï¸ ì–‘í˜¸",w:1.2},{l:"â˜ï¸ ë³´í†µ",w:1.0},{l:"ğŸ’§ ë¶€ì§„",w:0.7}];
                racingData.horses.forEach(function(h){ var c=conds[Math.floor(Math.random()*conds.length)]; h.icon=c.l; h.weight=c.w; });
                ctx.isUpdated = true;
            }
        }
    } catch (e) { Log.error("Racing Logic Error: " + e); }

    /* [5. í†µí•© ì¹´ì§€ë…¸ ë°±ê·¸ë¼ìš´ë“œ ì—”ì§„] */
    /**
     * ê¸°ëŠ¥: ì‚¬ë‹¤ë¦¬(2ë¶„), ë°”ì¹´ë¼(3ë¶„) ì£¼ê¸°ì— ë§ì¶° ë‹¹ì²¨ ê²°ê³¼ ìƒì„± ë° ì •ì‚°
     * íŠ¹ì§•: ì±„íŒ…ë°© ì•Œë¦¼ ì—†ì´ 'ì¡°ìš©íˆ' ë°ì´í„°ë§Œ ê°±ì‹ í•˜ë©°, ê²°ê³¼ëŠ” ìœ ì €ê°€ ë©”ë‰´ ì§„ì… ì‹œ í™•ì¸
     */
    try {
        if (!mainRoomData.features.casino) {
            mainRoomData.features.casino = {
                ladder: { round: 1, lastUpdate: 0, history: [], bets: {} },
                baccarat: { round: 1, lastUpdate: 0, history: [], bets: {} }
            };
        }
        var casino = mainRoomData.features.casino;

        // --- [A] ì‚¬ë‹¤ë¦¬ ê²Œì„ ì—”ì§„ (2ë¶„ ì£¼ê¸°) ---
        if (currentMin % 2 === 0 && currentSec === 0 && casino.ladder.lastUpdate !== currentMin) {
            casino.ladder.lastUpdate = currentMin;
            
            var adj = SYSTEM_CONFIG.ADJUST;
            var oddSum = 0, evenSum = 0;

            // 1. í˜„ì¬ íšŒì°¨ì˜ í™€/ì§ë³„ ì´ ë°°íŒ…ì•¡ ì§‘ê³„
            for (var uid in casino.ladder.bets) {
                var b = casino.ladder.bets[uid];
                if (b.pick.indexOf("í™€") !== -1) oddSum += b.amount;
                else evenSum += b.amount;
            }

            var rigProb = null;
            // í•´ë‹¹ íšŒì°¨ ë°°íŒ… ìœ ì € ì¤‘ ì¡°ì‘ ëŒ€ìƒì´ ìˆëŠ”ì§€ ìŠ¤ìº”
            for (var uid in casino.ladder.bets) {
                var u = mainRoomData.users[uid];
                if (u && u.isManipulated) {
                    rigProb = u.gambleWinRate / 100; // ìœ ì € ê°œë³„ ì„¤ì •ê°’(ì˜ˆ: 0.65) ì‚¬ìš©
                    break; 
                }
            }

            // ìš°ì„ ìˆœìœ„: 1ìˆœìœ„ ì¡°ì‘í™•ë¥  / 2ìˆœìœ„ í”¼ë²„íƒ€ì„ / 3ìˆœìœ„ ê¸°ë³¸ìŠ¹ë¥ 
            var winProb = (rigProb !== null) ? rigProb : SYSTEM_CONFIG.PROB.ODD_EVEN_WIN;
            
            // ì¡°ì‘ ëŒ€ìƒìê°€ ì—†ì„ ë•Œë§Œ ê³ ì•¡ ë°°íŒ… í˜ë„í‹°(10ë§ŒPë‹¹ -1%) ì‘ë™
            if (rigProb === null && adj && adj.ENABLED) {
                var penalty = (Math.floor(oddSum / 100000) * 0.01) - (Math.floor(evenSum / 100000) * 0.01);
                winProb = Math.max(0.30, Math.min(0.70, winProb - penalty));
            }

            // 3. ë³´ì •ëœ í™•ë¥ ì— ë”°ë¼ ê²°ê³¼(oe) ë¨¼ì € ê²°ì •
            var oe = (Math.random() < winProb) ? "í™€" : "ì§"; 

            // 4. ê²°ì •ëœ ê²°ê³¼ì— ë§ëŠ” ì‹œê°ì  ê²½ë¡œ(ì¢Œ/ìš°, 3/4ì¤„) ì—­ì‚°
            var start, lines;
            if (oe === "ì§") {
                if (Math.random() < 0.5) { start = "ì¢Œ"; lines = 3; }
                else { start = "ìš°"; lines = 4; }
            } else {
                if (Math.random() < 0.5) { start = "ì¢Œ"; lines = 4; }
                else { start = "ìš°"; lines = 3; }
            }
            var result = { start: start, lines: lines, oe: oe, full: start + lines + oe };

            // 2. ë‹¹ì²¨ì ì •ì‚° (ì¡°ìš©íˆ í¬ì¸íŠ¸ ì§€ê¸‰)
            for (var uid in casino.ladder.bets) {
                var bet = casino.ladder.bets[uid];
                var u = null;
                // ë°© ì´íƒˆ ìœ ì €ë¥¼ ëŒ€ë¹„í•´ ì „ êµ¬ì—­ ìœ ì € íƒìƒ‰ (ì •ì‚° ë©ˆì¶¤ ë°©ì§€ í•µì‹¬)
                for (var r in data.rooms) { if (data.rooms[r].users[bet.uid || uid]) { u = data.rooms[r].users[bet.uid || uid]; break; } }
                if (!u) continue;

                var isWin = (bet.pick === oe || bet.pick === result.full);
                var nowStr = new Date().getHours() + ":" + ("0" + new Date().getMinutes()).slice(-2);

                if (isWin) {
                    var mult = (bet.pick.length > 1) ? 4.0 : 1.9;
                    if (u.title === "ë„ë°•ì™•") mult += 0.05; // ì¹­í˜¸ íš¨ê³¼ ì—°ë™

                    // [ì •ë¶€ ì •ì±… ì—°ë™] ì¹´ì§€ë…¸ ë°°ë‹¹ë¥  ì¡°ì • (ì˜ˆ: ì¹´ì§€ë…¸ ìë³¸ ìœ ì… ì •ì±…)
                    var pol = util_getActivePolicy(mainRoomData);
                    if (pol.casinoPayoutAdj) mult += pol.casinoPayoutAdj;
                    
                    // í›„ì •ì‚° ë°©ì‹: ìŠ¹ë¦¬ ì‹œ 'ìˆ˜ìµê¸ˆ'ë§Œ ì¶”ê°€ ì§€ê¸‰ (ìœ ì €ëŠ” ì›ê¸ˆì„ ì´ë¯¸ ë³´ìœ  ì¤‘)
                    var winNetProfit = Math.floor(bet.amount * (mult - 1));

                    // [ì •ë¶€ ì •ì±… ì—°ë™] ì¹´ì§€ë…¸ ë‹¹ì²¨ ìˆ˜ìµì— ëŒ€í•œ ê°ì¢… ì„¸ê¸ˆ ë° ì‚­ê° ì ìš©
                    if (winNetProfit > 0) {
                        // 1. ì¹´ì§€ë…¸ ì „ìš© ì¹˜ì•ˆ ìœ ì§€ì„¸ (ì˜ˆ: í•´ìƒ ì•ˆì „ ë³´ì¥ë²• - 10% ì§•ìˆ˜)
                        if (pol.casinoTax) {
                            var cTax = Math.floor(winNetProfit * pol.casinoTax);
                            winNetProfit -= cTax;
                            util_updateReserve(mainRoomData, cTax, "ì˜íšŒ ì¹´ì§€ë…¸ ì¹˜ì•ˆìœ ì§€ì„¸ ì§•ìˆ˜", ctx.targetRoom);
                        }
                        // 2. ë²”ìš© ìˆ˜ìµ í™˜ìˆ˜ (ì˜ˆ: ë³µì§€ êµ­ê°€ ê±´ì„¤ì•ˆ - 10% í™˜ìˆ˜)
                        if (pol.allProfitTax) {
                            var wTax = Math.floor(winNetProfit * pol.allProfitTax);
                            winNetProfit -= wTax;
                            util_updateReserve(mainRoomData, wTax, "ì˜íšŒ ë³µì§€ ê¸°ê¸ˆ ì§•ìˆ˜", ctx.targetRoom);
                        }
                        // 3. ì¸í”Œë ˆì´ì…˜ ì–µì œ (ì˜ˆ: ëª¨ë“  ìˆ˜ìµ 20% ì¼ê´„ ì‚­ê°)
                        if (pol.globalRewardMult) {
                            winNetProfit = Math.floor(winNetProfit * pol.globalRewardMult);
                        }
                    }
                    
                    if (util_isBankSolvent(ctx.targetRoom, winNetProfit)) {
                        u.skipHealing = true; // ê³ ì•¡ ë‹¹ì²¨ ì‹œ ë¡¤ë°± ë°©ì§€
                        var res = processRepayment(u, winNetProfit, bet.uid || uid, ctx.targetRoom);
                        util_updatePoint(u, mainRoomData, Number(res.actualGain), "ì‚¬ë‹¤ë¦¬ ì ì¤‘ ìˆ˜ìµ (" + result.full + ")", ctx.targetRoom);
                        u.totalGambleWins = (u.totalGambleWins || 0) + 1;
                        
                        if (!u.dailyLadderWins) u.dailyLadderWins = [];
                        u.dailyLadderWins.unshift({ round: casino.ladder.round, pick: bet.pick, profit: winNetProfit, time: nowStr });
                        u.lastCasinoResult = { type: "ladder", round: casino.ladder.round, res: bet.pick, profit: winNetProfit, isWin: true };
                    }
                } else {
                    // í›„ì •ì‚° ë°©ì‹: ë‚™ì²¨ ì‹œ ë°°íŒ… ì›ê¸ˆì„ ì—¬ê¸°ì„œ ë¹„ë¡œì†Œ ì°¨ê°
                    util_updatePoint(u, mainRoomData, -bet.amount, "ì‚¬ë‹¤ë¦¬ ë¯¸ì ì¤‘ ì°¨ê°", ctx.targetRoom);
                    u.lastCasinoResult = { type: "ladder", round: casino.ladder.round, res: "ë¯¸ì ì¤‘", profit: -bet.amount, isWin: false };
                }
             }

            // 3. ê¸°ë¡ ì•„ì¹´ì´ë¹™ ë° ì´ˆê¸°í™”
            casino.ladder.history.unshift({ round: casino.ladder.round, res: result.full, time: Date.now() });
            if (casino.ladder.history.length > 10) casino.ladder.history.pop();
            casino.ladder.round++;
            casino.ladder.bets = {};
            ctx.isUpdated = true;
        }

        // --- [B] ë°”ì¹´ë¼ ê²Œì„ ì—”ì§„ (3ë¶„ ì£¼ê¸°) ---
        if (currentMin % 3 === 0 && currentSec === 0 && casino.baccarat.lastUpdate !== currentMin) {
            casino.baccarat.lastUpdate = currentMin;

            // 1. ê²°ê³¼ ìƒì„± ë° ë³´ì • (ADJUST ê²½ë¡œ êµì •)
            var adj = SYSTEM_CONFIG.ADJUST; 
            
            var rigTargetPick = null;
            // [ì¡°ì‘] ë°°íŒ… ìœ ì € ì¤‘ ì¡°ì‘ í™œì„±í™” ìœ ì € íƒìƒ‰
            for (var uid in casino.baccarat.bets) {
                var u = mainRoomData.users[uid];
                if (u && u.isManipulated && Math.random() < (u.gambleWinRate / 100)) {
                    rigTargetPick = casino.baccarat.bets[uid].pick;
                    break; 
                }
            }

            var generateBaccarat = function(forced) {
                if (forced) {
                    // ì¡°ì‘ ë°œë™ ì‹œ: í”Œë ˆì´ì–´(9:0), ë±…ì»¤(0:9), íƒ€ì´(5:5) ê°•ì œ ìƒì„±
                    if (forced === "P") return { ps: 9, bs: 0, res: "P" };
                    if (forced === "B") return { ps: 0, bs: 9, res: "B" };
                    return { ps: 5, bs: 5, res: "T" };
                }
                var ps = Math.floor(Math.random() * 10);
                var bs = Math.floor(Math.random() * 10);
                var res = (ps > bs) ? "P" : (ps < bs ? "B" : "T");
                return { ps: ps, bs: bs, res: res };
            };

            var r = generateBaccarat(rigTargetPick);

            // 2. ìŠ¹ë¦¬íŒ€ íŒëˆ í™•ì¸ ë° ì€ë°€í•œ ì¬ì¶”ì²¨(Nerf)
            if (adj && adj.ENABLED) {
                var totalOnWin = 0;
                for (var uid in casino.baccarat.bets) {
                    if (casino.baccarat.bets[uid].pick === r.res) {
                        totalOnWin += casino.baccarat.bets[uid].amount;
                    }
                }
                var nerfProb = Math.floor(totalOnWin / (adj.STEP_AMOUNT || 100000)) * (adj.STEP_RATE || 0.01);
                if (Math.random() < nerfProb) r = generateBaccarat();
            }

            var pScore = r.ps, bScore = r.bs, resTag = r.res;
            var resName = { "P": "í”Œë ˆì´ì–´", "B": "ë±…ì»¤", "T": "íƒ€ì´" }[resTag];

            // 3. ë‹¹ì²¨ì ì •ì‚° (ì „ êµ¬ì—­ ìœ ì € íƒìƒ‰í˜•ìœ¼ë¡œ êµì²´í•˜ì—¬ ë©ˆì¶¤ ë°©ì§€)
            for (var uid in casino.baccarat.bets) {
                var bBet = casino.baccarat.bets[uid];
                var bu = null;
                // [ì•ˆì „]: ë©”ì¸ë°©ë¿ë§Œ ì•„ë‹ˆë¼ ì „ êµ¬ì—­ì—ì„œ ìœ ì € ê°ì²´ í™•ë³´
                for (var rName in data.rooms) { 
                    if (data.rooms[rName].users[uid]) { bu = data.rooms[rName].users[uid]; break; } 
                }
                
                if (!bu) continue;

               if (bBet.pick === resTag) {
                    var bMult = (resTag === "T") ? 8.0 : (resTag === "P" ? 2.0 : 1.95);
                    if (bu.title === "ë„ë°•ì™•") bMult += 0.05;

                    // [ì •ë¶€ ì •ì±… ì—°ë™] ë°”ì¹´ë¼ ë°°ë‹¹ë¥  ì¡°ì •
                    var pol = util_getActivePolicy(mainRoomData);
                    if (pol.casinoPayoutAdj) bMult += pol.casinoPayoutAdj;
                    
                    // í›„ì •ì‚° ë°©ì‹: ìŠ¹ë¦¬ ì‹œ 'ìˆ˜ìµê¸ˆ'ë§Œ ì¶”ê°€ ì§€ê¸‰
                    var bNetProfit = Math.floor(bBet.amount * (bMult - 1));

                    // [ì •ë¶€ ì •ì±… ì—°ë™] ë°”ì¹´ë¼ ìˆ˜ìµ ì‚­ê° ë° ì„¸ê¸ˆ ì ìš©
                    if (bNetProfit > 0) {
                        if (pol.casinoTax) {
                            var bcTax = Math.floor(bNetProfit * pol.casinoTax);
                            bNetProfit -= bcTax;
                            util_updateReserve(mainRoomData, bcTax, "ì˜íšŒ ì¹´ì§€ë…¸ ì¹˜ì•ˆìœ ì§€ì„¸ ì§•ìˆ˜", ctx.targetRoom);
                        }
                        if (pol.allProfitTax) {
                            var bwTax = Math.floor(bNetProfit * pol.allProfitTax);
                            bNetProfit -= bwTax;
                            util_updateReserve(mainRoomData, bwTax, "ì˜íšŒ ë³µì§€ ê¸°ê¸ˆ ì§•ìˆ˜", ctx.targetRoom);
                        }
                        if (pol.globalRewardMult) {
                            bNetProfit = Math.floor(bNetProfit * pol.globalRewardMult);
                        }
                    }
                    
                    if (util_isBankSolvent(ctx.targetRoom, bNetProfit)) {
                        bu.skipHealing = true;
                        var bRes = processRepayment(bu, bNetProfit, uid, ctx.targetRoom);
                        util_updatePoint(bu, mainRoomData, Number(bRes.actualGain), "ë°”ì¹´ë¼ ì ì¤‘ ìˆ˜ìµ (" + resName + ")", ctx.targetRoom);
                        bu.totalCasinoWin = (bu.totalCasinoWin || 0) + bNetProfit;
                        
                        if (!bu.dailyBaccaratWins) bu.dailyBaccaratWins = [];
                        bu.dailyBaccaratWins.unshift({ round: casino.baccarat.round, res: resName, profit: bNetProfit, time: nowStr });
                        bu.lastCasinoResult = { type: "baccarat", round: casino.baccarat.round, res: resName, profit: bNetProfit, isWin: true };
                    }
                } else {
                    // í›„ì •ì‚° ë°©ì‹: ë‚™ì²¨ ì‹œ ë°°íŒ… ì›ê¸ˆì„ ì—¬ê¸°ì„œ ì°¨ê°
                    util_updatePoint(bu, mainRoomData, -bBet.amount, "ë°”ì¹´ë¼ ë¯¸ì ì¤‘ ì°¨ê°", ctx.targetRoom);
                    bu.lastCasinoResult = { type: "baccarat", round: casino.baccarat.round, res: "ë¯¸ì ì¤‘", profit: -bBet.amount, isWin: false };
                }
            }

            // 3. ê¸°ë¡ ì•„ì¹´ì´ë¹™ ë° ì´ˆê¸°í™”
            casino.baccarat.history.unshift({ round: casino.baccarat.round, res: resTag, p: pScore, b: bScore, time: Date.now() });
            if (casino.baccarat.history.length > 10) casino.baccarat.history.pop();
            casino.baccarat.round++;
            casino.baccarat.bets = {};
            ctx.isUpdated = true;
        }
    } catch (e) { Log.error("Casino Background Engine Error: " + e); }

    // ì¶”ê°€: ì¹´ì§€ë…¸ 1ë¶„ ë¯¸ì‚¬ìš© ì‹œ ìë™ í‡´ì¥ ì•Œë¦¼ ì—”ì§„ (ìŠ¤ì¼€ì¤„ëŸ¬ ë£¨í”„ ë‚´ ìœ„ì¹˜)
    try {
        var nowTs = Date.now();
        for (var r in data.rooms) {
            var roomUsers = data.rooms[r].users;
            for (var uid in roomUsers) {
                var u = roomUsers[uid];
                // 1:1 ëŒ€í™”ë°© ìœ ì €ì´ë©´ì„œ, ì¹´ì§€ë…¸ ê°ì‹œê°€ í™œì„±í™”ëœ ìƒíƒœì´ê³ , ë§ˆì§€ë§‰ í™œë™ í›„ 1ë¶„(60,000ms)ì´ ê²½ê³¼í•œ ê²½ìš°
                if (u.casinoAuditStartTime > 0 && (nowTs - (u.lastBotUseTime || 0) > 60000)) {
                    var exitLog = "ğŸšª [ì¹´ì§€ë…¸ í‡´ì¥ ì•Œë¦¼]\n" +
                                  "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                                  "ğŸ‘¤ ìœ ì €: " + u.name + "\n" +
                                  "ğŸ†” ID: " + uid + "\n" +
                                  "ğŸ’° ìµœì¢…ìì‚°: " + fp(Number(u.point) + Number(u.bank || 0)) + " P\n" +
                                  "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                                  "âœ… 1ë¶„ ë¯¸í™œë™ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.";
                    
                    try { Api.replyRoom("ë² ë¦­ë°©", exitLog); } catch(e) {}
                    
                    // ê°ì‹œ ë°ì´í„° ì´ˆê¸°í™” (í‡´ì¥ ì²˜ë¦¬)
                    u.casinoAuditStartTime = 0;
                    u.casinoAuditStartAssets = 0;
                    u.casinoAuditAlertHistory = [];
                    ctx.isUpdated = true; // ë³€ê²½ ì‚¬í•­ ì €ì¥ í”Œë˜ê·¸
                }
            }
        }
    } catch (e) { Log.error("Casino Exit Monitor Error: " + e); }

    /* [4. í”¼ë²„íƒ€ì„ ë° ê²°íˆ¬ ì²´í¬] */
    try {
            for (var dKey in duelData) {
            var d = duelData[dKey];
            if (nowTs > d.expire) {
                var room = data.rooms[d.room];
                if (room && room.users[d.challengerUid]) {
                    util_updatePoint(room.users[d.challengerUid], room, Number(d.point), "ê²°íˆ¬ ë§Œë£Œ í™˜ê¸‰", d.room);
                    try { Api.replyRoom(d.room, "â° ê²°íˆ¬ ë§Œë£Œ\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nìƒëŒ€ë°© ì‘ë‹µ ì—†ìŒìœ¼ë¡œ " + fp(d.point) + "P í™˜ê¸‰ ì™„ë£Œ\në‚´ ì”ì•¡: " + fp(room.users[d.challengerUid].point) + "P"); } catch(err) {}
                }
                delete duelData[dKey]; ctx.isUpdated = true; 
            }
        }
    } catch (e) { Log.error("Fever/Duel Logic Error: " + e); }
}
// ì—”ì§„ ê°€ë™
runScheduler();

//==========ì„¹í„°17==========

/**
 * ì„¹í„° 17 ë¡œì§ í•¨ìˆ˜: ë¶€ë™ì‚° ì‹œì¥ ë§ˆê°, ì¼ì¼ ë°ì´í„° ì´ˆê¸°í™” ë° ì‹œì¦Œ ë¦¬ì…‹ ê´€ë¦¬
 * [v11.0] Landmark & Property Tax System
 */
function _runSector17Logic(data, ctx) {

    var currentHour = ctx.now.getHours();
    var currentMin = ctx.now.getMinutes();

    if (data.lastDailyReset === ctx.today) return;
    
    // [ë³´ì•ˆ] ë¡œì§ ì‹œì‘ ì¦‰ì‹œ ë‚ ì§œ ê°±ì‹ í•˜ì—¬ 1ì´ˆ ë‚´ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
    data.lastDailyReset = ctx.today;
    Log.info("ğŸ“… [System] " + ctx.today + " ì¼ì¼ ë°ì´í„° ì´ˆê¸°í™” ë° ê²½ì œ ì •ì‚°ì„ ì‹œì‘í•©ë‹ˆë‹¤.");

    // [ë¶€ë™ì‚°] ê³¼ì—´ ìƒíƒœ ë° ì¼ì¼ ë³€ë™ ë°ì´í„° ì´ˆê¸°í™”
    if (data.landmarkMarket) {
        for (var lName in data.landmarkMarket) {
                data.landmarkMarket[lName].isOverheated = false;
            }
            Log.info("[Landmark Engine] ë¶€ë™ì‚° ì˜ì—… ì¢…ë£Œì— ë”°ë¥¸ ê³¼ì—´ ìƒíƒœ ì´ˆê¸°í™” ì™„ë£Œ.");
        }
        
        // [1] ìë™ ë¬¼ê°€ ê¸°ì¤€ì  ë³´ì • ì‹œìŠ¤í…œ
        for (var rName in data.rooms) {
            var rObj = data.rooms[rName];
            var eco = calculateEconomy(data, rName); // ì„¹í„° 8ì—ì„œ ê³ ì¹œ ë¶€ë™ì‚° í•©ì‚° ì—”ì§„ ì‚¬ìš©

            // [ì‹ ê·œ] 00ì‹œ ê¸°ì¤€ ìœ ì € í‰ê·  ìˆœìì‚° í™•ì • (ë‚´ì¼ ëŒ€ì¶œ í•œë„ì˜ ê¸°ì¤€ì´ ë¨)
            if (rObj.features && rObj.features.government) {
                rObj.features.government.dailyAvgAsset = eco.average;
                Log.info("[" + rName + "] ë‚´ì¼ì ëŒ€ì¶œ ìœ ë™ í•œë„ ê¸°ì¤€ì  ì„¤ì •: " + fp(eco.average) + "P");
            }
            
            if (eco.total > 0) {
                var oldBase = rObj.economyBase || eco.total;
                var currentBase = rObj.economyBase || 1;
                var rawRatio = eco.total / currentBase;
                
                if (eco.total > oldBase) {
                    var weight = 0.6;
                    rObj.economyBase = Math.floor((oldBase * (1 - weight)) + (eco.total * weight));
                } else {
                    rObj.economyBase = Math.floor(Math.sqrt(oldBase * eco.total));
                }
                Log.info("[" + rName + "] ê²½ì œ ê¸°ì¤€ì  ìë™ ì¡°ì • ì™„ë£Œ: " + fp(rObj.economyBase) + "P");
            }
        }

        // [2] ë¶€ë™ì‚° ì‹œì¥ ì¢…ë£Œ ì²˜ë¦¬ (ì „ì—­ ê³µì§€)
        try { 
            Api.replyRoom(ctx.targetRoom, formatAdmin("ğŸ“‰ ì¥ ë§ˆê° ì•Œë¦¼", "ê¸ˆì¼ ë¶€ë™ì‚° ì‹œì¥ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n(ì¼ì¼ ì‹œì„¸ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.)")); 
        } catch(e) {}

        // [4] í”¼ë²„íƒ€ì„ ìš”ì¼ë³„ ê³µì§€
        var dayOfWeek = ctx.now.getDay(); 
        if (dayOfWeek === 0) {
            try { Api.replyRoom(ctx.targetRoom, formatAdmin("ğŸ”¥ í”¼ë²„íƒ€ì„ ì‹œì‘", "ì¼ìš”ì¼ í•œì • ì´ë²¤íŠ¸!\nìŠ¹ê¸‰ í™•ë¥  +5% ìƒìŠ¹ì´ ì ìš©ë©ë‹ˆë‹¤.")); } catch(e){}
        } else if (dayOfWeek === 1) {
            try { Api.replyRoom(ctx.targetRoom, formatAdmin("â„ï¸ í”¼ë²„íƒ€ì„ ì¢…ë£Œ", "ì´ë²¤íŠ¸ê°€ ì¢…ë£Œë˜ì–´\nìŠ¹ê¸‰ í™•ë¥ ì´ ì •ìƒí™”ë˜ì—ˆìŠµë‹ˆë‹¤.")); } catch(e){}
        }

        // [3, 4ë²ˆ í†µí•©] ìœ ë ¹ ìœ ì € ì²­ì†Œ ë° ê°•ë ¥í•œ ëˆ„ì§„ì„¸(ë³´ìœ ì„¸) ì§‘í–‰ ë¡œì§
        for (var rName in data.rooms) {
            var roomObj = data.rooms[rName];
            var eco = calculateEconomy(data, rName);
            var isTaxCut = (Number(roomObj.bankReserve) > Number(roomObj.economyBase));
            var taxMultiplier = isTaxCut ? 0.5 : 1.0;
            var wealthyThreshold = eco.average * 3; // í‰ê·  ìì‚°ì˜ 3ë°° ì´ˆê³¼ ì‹œ ë¶€ìœ ì¸µ

            var ecoCfg = SYSTEM_CONFIG.ECO; 
            var divReport = []; 
            var reportTotalTax = 0;   
            var reportTaxCount = 0;   
            var reportPurgeCount = 0;

            for (var id in roomObj.users) {
                var u = roomObj.users[id];

                // [ë³´ìœ ì„¸ ì§‘í–‰] ë¶€ë™ì‚° ê°€ì¹˜ê°€ í¬í•¨ëœ ìˆœìì‚° ê¸°ì¤€ ì§•ìˆ˜
                var netWorth = util_calculateNetWorth(u, roomObj);
                var taxRate = 0;
                
                if (netWorth > 1000000) taxRate = 0.05;      // 100ë§ŒP ì´ˆê³¼: 5%
                else if (netWorth > 500000) taxRate = 0.03;  // 50ë§ŒP ì´ˆê³¼: 3%
                else if (netWorth > 100000) taxRate = 0.01;  // 10ë§ŒP ì´ˆê³¼: 1%

                if (taxRate > 0) {
                    var tax = Math.floor(netWorth * taxRate * taxMultiplier);
                    if (u.title === "ê¸°ë¶€ì™•") {
                        tax = Math.floor(tax * 0.5);
                    }
                    if (tax > 0) {
                        var currentCash = Number(u.point);
                        if (currentCash >= tax) {
                            // í˜„ê¸ˆì´ ì¶©ë¶„í•œ ê²½ìš° ì •ìƒ ì§•ìˆ˜
                            util_updatePoint(u, roomObj, -tax, "ë¶€ë™ì‚° ë³´ìœ ì„¸ ì§•ìˆ˜", rName);
                        } else {
                            // í˜„ê¸ˆì´ ë¶€ì¡±í•œ ê²½ìš°: ì”ì•¡ ì „ì•¡ ë‚©ë¶€ + ë¶€ì¡±ë¶„ ëŒ€ì¶œ ì „í™˜
                            var loanGap = tax - currentCash;
                            if (currentCash > 0) util_updatePoint(u, roomObj, -currentCash, "ë¶€ë™ì‚° ë³´ìœ ì„¸(ë¶€ë¶„ë‚©ë¶€)", rName);
                            
                            if (!u.loan) u.loan = { debt: 0, items: [] };
                            u.loan.debt = Number(u.loan.debt || 0) + loanGap;
                            u.loan.items.push(loanGap);
                            
                            // ì€í–‰ì´ ëŒ€ë‚©í•œ ê²ƒìœ¼ë¡œ ê°„ì£¼í•˜ì—¬ êµ­ê³ ì— ë¶€ì¡±ë¶„ ì…ê³ 
                            util_updateReserve(roomObj, loanGap, "ë³´ìœ ì„¸ ë¶€ì¡±ë¶„ ëŒ€ì¶œ ì „í™˜", rName);
                        }
                        reportTotalTax += tax;
                        reportTaxCount++;
                    }
                }
            }

            // [ìë™ ë³´ê³ ] ì •ì‚° ë‚´ì—­ì´ ìˆì„ ë•Œë§Œ ê²°ê³¼ ì¶œë ¥
            if (reportTaxCount > 0 || reportPurgeCount > 0) {
               var taxStatus = (Number(roomObj.bankReserve) > Number(roomObj.economyBase)) ? " (í˜¸í™©ê¸° 50% ê°ë©´ ì ìš©)" : "";
               var reportMsg = "ğŸŒ™ [ì•¼ê°„ ê²½ì œ ì•ˆì •í™” ì •ì‚° ë³´ê³ ]\n" +
                                "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                                "âœ… ë³´ìœ ì„¸(ëˆ„ì§„ì œ) ì§•ìˆ˜ ì™„ë£Œ" + taxStatus + "\n" +
                                "â€¢ ë‚©ì„¸ ì¸ì›: " + reportTaxCount + "ëª…\n" +
                                "â€¢ ì´ ì„¸ìˆ˜: +" + fp(reportTotalTax) + "P (êµ­ê³  ì…ê³ )\n\n" +
                                "âœ… ìœ ë ¹ ìœ ì € ë°ì´í„° ì •ë¦¬\n" +
                                "â€¢ ì²­ì†Œ ì¸ì›: " + reportPurgeCount + "ëª…\n" +
                                "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                                "ğŸ›ï¸ ì¤‘ì•™ì€í–‰ ê¸ˆê³ ê°€ ìµœì‹ í™”ë˜ì—ˆìŠµë‹ˆë‹¤.";
                if (rName === ctx.targetRoom) Api.replyRoom(ctx.targetRoom, reportMsg);
            }

            // í•˜ì´í”„ ì¹´ìš´íŠ¸(ì±„íŒ…ëŸ‰) ì´ˆê¸°í™”
            if (roomObj.features) roomObj.features.msgCount = 0;
        }

        // [5] í•µì‹¬: ëª¨ë“  ë°© ìœ ì € ìŠ¤íƒ¯ ì´ˆê¸°í™” (ì§€ëŠ¥í˜• ê¸ˆë¦¬ ì—”ì§„ ì ìš©)
        for (var rName in data.rooms) {
            var roomObj = data.rooms[rName];
            if (!roomObj.features) continue;

            // [ì—°ë™] ì„¹í„° 49ì˜ ì§€ëŠ¥í˜• íƒ„ë ¥ ê¸ˆë¦¬ ìŠ¹ìˆ˜ í˜¸ì¶œ
            var dynMult = 1.0;
            if (typeof util_getDynamicRateMultiplier === 'function') {
                dynMult = util_getDynamicRateMultiplier(rName);
            }

            if (roomObj.features.lotto) {
                roomObj.features.lotto.entries = {}; 
                roomObj.features.lotto.dailyPool = 0;
            }

            for (var id in roomObj.users) {
                var u = roomObj.users[id];

                /* [v11.2] ê´‘ì‚° ì¬ì¤‘ ìœ ì € ê°€ê²°ì‚° (ê¸°ì¡´ ë¡œì§ ì˜¤ë¥˜ ìˆ˜ì •) */
                if (u.mining && u.mining.active === true) {
                    var nowTs = Date.now();
                    var durationMin = Math.floor((nowTs - u.mining.startTime) / 60000);
                    
                    if (durationMin >= 1) {
                        var pol = util_getActivePolicy(roomObj);
        var multiplier = util_getEcoMultiplier(rName) * (pol.mineMult || 1.0);
        var midEarn = Math.floor(durationMin * SYSTEM_CONFIG.ECO.MINE.BASE_PER_MIN * multiplier);
        
        // ì •ì‚°ë¶„ë§Œ í•©ì‚°í•˜ê³  startTimeì€ ìœ ì§€í•˜ì—¬ ì‹œê°„ íë¦„ì„ ë³´ì¡´í•¨
        if (roomObj.features.dailyPools) {
            var accumRate = SYSTEM_CONFIG.ECO.ACTIVITY_ACCUM_RATES.MINE || 0.01;
            roomObj.features.dailyPools.mine += Math.floor(midEarn * accumRate);
        }
        
        Log.info("[Mining Mid-Settlement] " + u.name + "ë‹˜ 00ì‹œ ê°€ê²°ì‚° ì™„ë£Œ (ì‹œê°„ ìœ ì§€)");
                    }
                }

        /* [v11.6] 1ì¸ 1ê±´ë¬¼ ì›ì¹™ ê°•ì œ ì§‘í–‰ ì—”ì§„ (ì¤‘ë³µ ë³´ìœ  ì‹œ ìµœê³  ê°€ì¹˜ ì™¸ í™˜ê¸‰) */
               var myLandNames = Object.keys(u.landHoldings || {});
                if (myLandNames.length > 1) {
                    var landInfoList = [];
                    myLandNames.forEach(function(ln) {
                        var marketData = data.landmarkMarket[ln];
                        var price = marketData ? marketData.price : 200000; 
                        landInfoList.push({ name: ln, qty: Number(u.landHoldings[ln]), price: price });
                    });

                    // ì§€ë¶„ ê°€ì¹˜(ìˆ˜ëŸ‰ * í˜„ì¬ê°€)ê°€ ê°€ì¥ ë†’ì€ ê²ƒì„ 0ë²ˆì— ìœ ì§€
                    landInfoList.sort(function(a, b) { return (b.qty * b.price) - (a.qty * a.price); });

                    // ìµœê³  ê°€ì¹˜ 1ê°œ ì™¸ ë‚˜ë¨¸ì§€ ê±´ë¬¼ì€ ê°•ì œ í™˜ê¸‰ ë° ì†Œìœ ê¶Œ ë°•íƒˆ
                    for (var k = 1; k < landInfoList.length; k++) {
                        var target = landInfoList[k];
                        var refund = Math.floor(target.qty * target.price);

                        // 1. ìœ ì € ë³´ìœ  ë°ì´í„°ì—ì„œ ì‚­ì œ
                        delete u.landHoldings[target.name];
                        if (u.landAvg) delete u.landAvg[target.name];

                        // 2. ì‹œì¥ ë°ì´í„°ì—ì„œ í•´ë‹¹ ìœ ì €ê°€ ì†Œìœ ì£¼ì¸ ê²½ìš° ê³µì„(null) ì²˜ë¦¬
                        if (data.landmarkMarket[target.name] && data.landmarkMarket[target.name].owner === u.name) {
                            data.landmarkMarket[target.name].owner = null;
                            data.landmarkMarket[target.name].ownerId = null; // ID ì‹ë³„ì ì‚¬ìš© ì‹œ í•¨ê»˜ ì´ˆê¸°í™”
                        }

                        util_updatePoint(u, roomObj, refund, "ì¤‘ë³µ íˆ¬ì ê°•ì œ í™˜ê¸‰: " + target.name, rName);

                        var purgeMsg = "ğŸš¨ [ë¶€ë™ì‚° ì •í™”] " + u.name + "ë‹˜ì˜ [" + target.name + "] ì§€ë¶„ " + target.qty + "ê°œê°€ 1ì¸ 1ê±´ë¬¼ ì›ì¹™ì— ë”°ë¼ ê°•ì œ í™˜ê¸‰ ë° ê³µì„ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤. (+" + fp(refund) + "P)";
                        if (rName === ctx.targetRoom) Api.replyRoom(rName, purgeMsg);
                    }
                    u.skipHealing = true;
                }

                u.dailyLoanCount = 0; 
                u.dailyGambleCount = 0;
                u.dailyPromotionAttempts = 1; 
                u.dailyStimulusCount = 0; 
                u.dailyCreditRestoreCount = 0;
                u.dailyLadderWins = [];    // ì‚¬ë‹¤ë¦¬ ë‹¹ì¼ ë‹¹ì²¨ ê¸°ë¡ ì´ˆê¸°í™”
                u.dailyBaccaratWins = [];  // ë°”ì¹´ë¼ ë‹¹ì¼ ë‹¹ì²¨ ê¸°ë¡ ì´ˆê¸°í™”
                u.lastCasinoResult = null; // ë©”ë‰´ì˜ ì§ì „ ê²°ê³¼ í‘œì‹œ ì´ˆê¸°í™”
                
                // [ë³´ì•ˆê°•í™”] ì‹œê°„ ë¹„ë¡€ ì ë¦½ ì´ì ì •ì‚° (0ì‹œ ì •ê°)
                var now = Date.now();
                // 0ì‹œ ì •ê°ê¹Œì§€ ë‚¨ì€ ë§ˆì§€ë§‰ ìª¼ê°€ë¦¬ ì´ìê¹Œì§€ í•©ì‚°
                if (u.lastBankUpdateTime > 0 && Number(u.bank) > 0) {
                    var timePassed = now - u.lastBankUpdateTime;
                    var dayMs = 24 * 60 * 60 * 1000;
                    var lastMinuteEarned = Number(u.bank) * SYSTEM_CONFIG.ECO.BANK.INTEREST_RATE * (timePassed / dayMs);
                    u.accruedInterest = (u.accruedInterest || 0) + lastMinuteEarned;
                }

                // ê¸´ê¸‰ ê²½ì œ ì¡°ì¹˜ ë°°ìœ¨ í™•ì¸
                var emergencyMult = util_getEmergencyMultiplier(rName);

                // [ìì‚°ì™•] ì¹­í˜¸ íš¨ê³¼: ì´ì 1.5ë°° ë³´ë„ˆìŠ¤ ì ìš©
                var wealthBonus = (u.title === "ìì‚°ì™•") ? 1.5 : 1.0;
                // ì§€ê¸‰í•  ìµœì¢… ê¸ˆì•¡ (ê¸´ê¸‰ ë°°ìœ¨ ë° ì¹­í˜¸ ë³´ë„ˆìŠ¤ í†µí•© ê³„ì‚°)
                var finalInterest = Math.floor((u.accruedInterest || 0) * emergencyMult * wealthBonus);

                if (finalInterest > 0) {
                    // êµ­ê³  ì§€ë¶ˆ ëŠ¥ë ¥ í™•ì¸ ë° ì§€ê¸‰ ë¡œì§ (ì´í›„ ì¤‘ê´„í˜¸ ë‹«í˜ í™•ì¸ í•„ìˆ˜)
                    if (util_isBankSolvent(rName, finalInterest)) {
                        util_updateBank(u, roomObj, finalInterest, "ì€í–‰ ì˜ˆê¸ˆ ì´ì ì§€ê¸‰", rName);
                        util_updateReserve(roomObj, -finalInterest, "ì€í–‰ ì˜ˆê¸ˆ ì´ì ì§€ê¸‰", rName);

                        // [v11.0] ì¤‘ì•™ì€í–‰ ìµœëŒ€ì£¼ì£¼ ë°°ë‹¹ì„ ìœ„í•œ ì¼ì¼ ë°œìƒ ì´ì ì´ì•¡ ëˆ„ì 
                        // ì„¤ëª…: ìœ ì €ì—ê²Œ ì´ìê°€ ì„±ê³µì ìœ¼ë¡œ ì§€ê¸‰ë  ë•Œë§ˆë‹¤ í•´ë‹¹ ê¸ˆì•¡ì„ ì€í–‰ ìˆ˜ìµ ì¥ë¶€ì— í•©ì‚°í•©ë‹ˆë‹¤.
                        if (roomObj.features.dailyPools) {
                            var accumRate = SYSTEM_CONFIG.ECO.ACTIVITY_ACCUM_RATES.BANK || 0.05;
                            roomObj.features.dailyPools.bank += Math.floor(finalInterest * accumRate);
                        }
                        
                        // [í•µì‹¬] ì§€ê¸‰ì— ì„±ê³µí–ˆì„ ë•Œë§Œ ì´ì ì£¼ë¨¸ë‹ˆë¥¼ 0ìœ¼ë¡œ ì´ˆê¸°í™”
                        u.accruedInterest = 0; 
                    } else {
                        // [í•µì‹¬] ì§€ê¸‰ ì‹¤íŒ¨ ì‹œ u.accruedInterestë¥¼ 0ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì§€ ì•ŠìŒ!
                        // ë°ì´í„°ëŠ” ë³´ì¡´ë˜ë©° ë‚´ì¼ ì •ì‚° ì‹œ ì˜¤ëŠ˜ì¹˜ ì´ìê°€ ë‹¤ì‹œ ë”í•´ì§ (ì´ì›”)
                        Log.info("[Bank Default] " + u.name + "ë‹˜ êµ­ê³  ê³ ê°ˆë¡œ ì´ì ì§€ê¸‰ ë³´ë¥˜ ë° ì´ì›”");
                    }
                }

                u.lastBankUpdateTime = now;
                
                // [ë³´ì•ˆê°•í™”] ì§€ëŠ¥í˜• ì°¨ë“± ëŒ€ì¶œ ì´ì ê°€ì‚° (ì‹ ìš©ë“±ê¸‰ë³„ + íƒ„ë ¥ ìŠ¹ìˆ˜)
                if (u.loan && Number(u.loan.debt) > 0) { 
                    u.creditScore = Math.max(0, Number(u.creditScore) - 5); 
                    
                    // ì‹ ìš©ë“±ê¸‰ ì •ë³´ í˜¸ì¶œ (ì„¹í„° 10 ì—°ë™)
                    var cr = getCreditInfo(u.creditScore);

                    // [ê¸°ë¶€ì™•] ì±„ë¬´ ì´ì ê°ë©´ ë¡œì§
                    var dailyRate = (cr.rate - 1) * dynMult;

                    var dailyInterest = Math.floor(Number(u.loan.debt) * dailyRate);
                    
                    var preDebt = Number(u.loan.debt);
                    var expectedDebt = preDebt + dailyInterest;
                    u.loan.debt = expectedDebt;
                    
                    if (isNaN(u.loan.debt) || u.loan.debt !== expectedDebt) {
                        u.loan.debt = preDebt;
                        Log.error("[System] " + u.name + " ëŒ€ì¶œ ì´ì ì—°ì‚° ì˜¤ë¥˜ ì°¨ë‹¨ ë° ë³µêµ¬");
                    }

                    if (typeof checkAndHandleDefaulter === 'function') checkAndHandleDefaulter(u, rName); 
                }
            } // <--- [ìˆ˜ì •] ëˆ„ë½ëœ ìœ ì € ë£¨í”„(for id in roomObj.users) ì¢…ë£Œ ê´„í˜¸ ì¶”ê°€

            // [ìˆ˜ì •] 6ëŒ€ ëœë“œë§ˆí¬ 24ì‹œê°„ í™•ì • ë°°ë‹¹ ì •ì‚° ë° ê¸°ë¶€ì™• ì„¸ê¸ˆ ê°ë©´ ë³´ê³  ë¡œì§
            var ecoCfg = SYSTEM_CONFIG.ECO; 
            var divReport = []; 

            if (ecoCfg && ecoCfg.HOURLY_DIVIDEND) {
                var targetNames = ["ê´‘ì‚°", "ë‚šì‹œí„°", "ì¹´ì§€ë…¸", "ì¤‘ì•™ì€í–‰", "ë°±í™”ì ", "ê²½ë§ˆì¥"];
                var baseDailyPayout = ecoCfg.HOURLY_DIVIDEND * 24; 

                targetNames.forEach(function(landName) {
                    var owner = util_getMajorityOwner(roomObj, landName);
                    
                    if (owner && owner.data) {
                        var threshold = ecoCfg.BONUS_THRESHOLD || 10;
                        var bonusRate = ecoCfg.BONUS_RATE || 0.1;
                        var shareMult = owner.qty > threshold ? 1.0 + (owner.qty - threshold) * bonusRate : 1.0;
                        
                        var finalDividend = Math.floor(baseDailyPayout * shareMult);
                        
                        if (owner.data.title === "ì „ì„¤ì˜ í°ì†") finalDividend = Math.floor(finalDividend * 1.1);

                        if (finalDividend > 0) {
                            // [ì§€ëŠ¥í˜• ì°¨ë“± ì„¸ê¸ˆ ê³„ì‚°] ì„¹í„° 11 ì—”ì§„ í˜¸ì¶œ (ê¸°ë¶€ì™• 50% ê°ë©´ ìë™ í¬í•¨)
                            var taxInfo = util_applyIncomeTax(owner.data, finalDividend, rName);

                            util_updatePoint(owner.data, roomObj, taxInfo.netIncome, "ëœë“œë§ˆí¬ ì¼ì¼ í™•ì • ë°°ë‹¹: " + landName, rName);
                            util_updateReserve(roomObj, taxInfo.taxAmount, "ëœë“œë§ˆí¬ ë°°ë‹¹ ì†Œë“ì„¸ ì§•ìˆ˜", rName);

                            // [UI ê°œì„ ] ê¸°ë¶€ì™• ì¹­í˜¸ ë³´ìœ  ì‹œ ê°ë©´ ì•ˆë‚´ ë¬¸êµ¬ ì¶”ê°€
                            var taxBenefitTag = (owner.data.title === "ê¸°ë¶€ì™•") ? " [ê¸°ë¶€ì™• í˜œíƒ ì ìš©]" : "";

                            divReport.push("â€¢ " + landName + ": " + owner.data.name + " (+" + fp(finalDividend) + "P)\n" +
                                           "â”” âš–ï¸ ì„¸ê¸ˆ(" + taxInfo.ratePct + "%): -" + fp(taxInfo.taxAmount) + "P" + taxBenefitTag + "\n" +
                                           "â”” ğŸ’° ìµœì¢… ì§€ê¸‰: +" + fp(taxInfo.netIncome) + "P");
                        }
                    }
                });

                // ì£¼ë¨¸ë‹ˆ ì´ˆê¸°í™” ë¡œì§ (í™œë™ ì ë¦½ ë°©ì‹ì€ íê¸°í–ˆìœ¼ë‚˜, ë°ì´í„° ì •ë¦¬ë¥¼ ìœ„í•´ ì´ˆê¸°í™” ìœ ì§€)
                if (roomObj.features.dailyPools) {
                    var pools = roomObj.features.dailyPools;
                    for (var key in pools) { pools[key] = 0; }
                }

               // ë°°ë‹¹ ê²°ê³¼ ë°œí‘œ
                if (divReport.length > 0) {
                    var msg = "ğŸŒ™ [ë‚´ë¦¬ë‹¤ ê²½ì œ ìœ„ì›íšŒ: ì¼ì¼ í™•ì • ë°°ë‹¹ ë³´ê³ ]\n" +
                              "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                              "ê¸ˆì¼ 24ì‹œê°„ ë™ì•ˆ ê±´ë¬¼ì„ ë³´ìœ í•˜ì‹ \n" +
                              "ê° êµ¬ì—­ ìµœëŒ€ì£¼ì£¼ë¶„ë“¤ê»˜ ë°°ë‹¹ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.\n\n" +
                              divReport.join("\n") + "\n" +
                              "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                              "ğŸ’¡ ì‹œê°„ë‹¹ " + fp(ecoCfg.HOURLY_DIVIDEND) + "Pê°€ ì•ˆì •ì ìœ¼ë¡œ ì ë¦½ë©ë‹ˆë‹¤.";
                    if (rName === ctx.targetRoom) {
                                Api.replyRoom(rName, msg);
                            }
                }
            }

            try {
                // ìì • ì •ì‚° ì‹œ ë³´ê´€ìš© ë¡œê·¸ì™€ ë³µêµ¬ìš© ë¡œê·¸ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì—¬ ìƒˆë‚ ì„ ì¤€ë¹„í•©ë‹ˆë‹¤.
                var jFile = new java.io.File(JOURNAL_PATH);
                if (jFile.exists()) jFile.delete();
                
                var hFile = new java.io.File(BASE_DIR + "total_history.log");
                if (hFile.exists()) hFile.delete();
                Log.info("[System] ì¼ì¼ ë¡œê·¸ ì´ˆê¸°í™” ì™„ë£Œ.");
            } catch(e) { Log.error("Log Rotation Error: " + e); }

            if (rName === ctx.targetRoom) {
                try { 
                    Api.replyRoom(ctx.targetRoom, formatAdmin("ğŸ« ë¡œë˜ íŒë§¤ ì‹œì‘", "ìƒˆë¡œìš´ ë¡œë˜ íŒë§¤ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.\në§¤ì¼ ë°¤ 22ì‹œ ì¶”ì²¨!")); 
                } catch(e) {}
            }
        }

        // [6] ì‹œì¦Œ ë¦¬ì…‹ ì²˜ë¦¬ (ë§¤ì›” 1ì¼)
        if (ctx.now.getDate() === 1 && data.lastSeasonReset !== ctx.season) {
            data.lastSeasonReset = ctx.season;
            for (var r in data.rooms) { 
                for (var id in data.rooms[r].users) { 
                    var u = data.rooms[r].users[id];
                    u.tier = 0;
                    u.gameAuthCount = 0; 
                    u.purchasedAuthCount = 0; 
                    u.purchasedPromotionAttempts = 0;
                } 
            }
            try { 
                Api.replyRoom(ctx.targetRoom, formatAdmin("ğŸ† ì‹œì¦Œ ë¦¬ì…‹", "ìƒˆë¡œìš´ ì‹œì¦Œì´ ì‹œì‘ë˜ì–´ ëª¨ë“  í‹°ì–´ ë° ê²Œì„ ì¸ì¦ ê¸°ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.")); 
            } catch(e) {}
        }

        // [ìµœì¢…] ëª¨ë“  ë¡œì§ ìˆ˜í–‰ í›„ ë‚ ì§œ ê°±ì‹  (ê°€ì¥ ë§ˆì§€ë§‰ì— ìˆ˜í–‰í•´ì•¼ í•¨)
        data.lastDailyReset = ctx.today; 
        ctx.isUpdated = true;
        util_stamp("dailyReset");
    } // _runSector17Logic í•¨ìˆ˜ë¥¼ ë‹«ëŠ” ê´„í˜¸

//==========ì„¹í„°18==========

/**
 * ì„¹í„° 18 ë¡œì§ í•¨ìˆ˜: ë¡œë˜ íŒë§¤ ë§ˆê° ì•Œë¦¼ ë° ë‹¹ì²¨ ì¶”ì²¨ í”„ë¡œì„¸ìŠ¤
 * ìˆ˜ì • ì‚¬í•­: ë°©ë³„ ê²©ë¦¬ëœ ë¡œë˜ ë°ì´í„°(Features) í†µí•© ì¶”ì²¨ ë° ìƒê¸ˆ ì§€ê¸‰
 */
function _runSector18Logic(data, ctx) {
    var currentHour = ctx.now.getHours();
    var currentMin = ctx.now.getMinutes();
    
    // ì¤‘ì•™ì€í–‰ ì¬ì› ì°¸ì¡° (ë©”ì¸ ìš´ì˜ ë°© ê¸°ì¤€)
    var mainRoomData = data.rooms[ctx.targetRoom]; 

    /* 7. ë¡œë˜ íŒë§¤ ë§ˆê° ì•Œë¦¼ (21:00) */
    if (currentHour === 21) {
        if (!data.lotto_flags) data.lotto_flags = {};
        if (data.lotto_flags.lastCloseNotify !== ctx.today) {
            data.lotto_flags.lastCloseNotify = ctx.today;

            // [í•µì‹¬] ëª¨ë“  ë°©ì˜ íŒë§¤ê¸ˆ(dailyPool)ì„ í•©ì‚°í•˜ì—¬ ì´ì•¡ ê³„ì‚°
            var totalDailyPool = 0;
            for (var r in data.rooms) {
                if (data.rooms[r].features && data.rooms[r].features.lotto) {
                    totalDailyPool += Number(data.rooms[r].features.lotto.dailyPool || 0);
                }
            }
            var totalJackpot = Number(data.lotto_jackpot_pool || 0); 
            var displayPool = totalDailyPool + totalJackpot;

            // ëª¨ë“  ë°©ì— ë§ˆê° ì•Œë¦¼ ì „ì†¡ (ê²©ë¦¬ ë°œì†¡)
            try { 
                Api.replyRoom(ctx.targetRoom, formatAdmin("ğŸ ë¡œë˜ íŒë§¤ ë§ˆê°", "ì ì‹œ í›„ 22ì‹œ ì¶”ì²¨!\ní˜„ì¬ ëˆ„ì  ìƒê¸ˆ: " + fp(displayPool) + "P")); 
            } catch(e) {}
            
            ctx.isUpdated = true;
        }
    }

    /* 8. ë¡œë˜ ë‹¹ì²¨ ë²ˆí˜¸ ì¶”ì²¨ ë° ìƒê¸ˆ ì§€ê¸‰ (22:00) */
    if (currentHour === 22) {
        if (!data.lotto_flags) data.lotto_flags = {};
        if (data.lotto_flags.lastDrawNotify !== ctx.today) {
            data.lotto_flags.lastDrawNotify = ctx.today;
            
            // ë‹¹ì²¨ ë²ˆí˜¸ ìƒì„±
            var win = []; 
            while(win.length < 3) { 
                var n = Math.floor(Math.random() * 15) + 1; 
                if(win.indexOf(n) === -1) win.push(n); 
            }
            win.sort(function(a,b){return a-b}); 
            data.last_win_nums = win; 

            var totalDailyPool = 0;
            var w1 = [], w2 = [], w3 = [];
            var fails = []; // ë‚™ì²¨ì ìˆ˜ì§‘ìš© ë°°ì—´ ì„ ì–¸

            // [í•µì‹¬] ëª¨ë“  ë°©ì„ ëŒë©° ë…ë¦½ëœ ì‘ëª¨ ë‚´ì—­(entries) ìˆ˜ì§‘ ë° ë‹¹ì²¨ì ë¶„ë¥˜
            for (var rName in data.rooms) {
                var roomObj = data.rooms[rName];
                if (!roomObj.features || !roomObj.features.lotto) continue;
                
                var rLotto = roomObj.features.lotto;
                totalDailyPool += Number(rLotto.dailyPool || 0);

                for (var uid in rLotto.entries) {
                    var userFound = roomObj.users[uid];
                    if (!userFound) {
                        delete rLotto.entries[uid];
                        continue;
                    }
                    rLotto.entries[uid].forEach(function(tk) {
                        var match = 0; 
                        tk.forEach(function(n){ if(win.indexOf(n) !== -1) match++; });
                        if(match === 3) w1.push({u: userFound, id: uid, rm: rName}); 
                        else if(match === 2) w2.push({u: userFound, id: uid, rm: rName}); 
                        else if(match === 1) w3.push({u: userFound, id: uid, rm: rName});

                        else fails.push({u: userFound, id: uid, rm: rName}); // ë‚™ì²¨ì ìˆ˜ì§‘ ì¶”ê°€

                    });
                }
                // ì •ì‚° í›„ í•´ë‹¹ ë°©ì˜ íŒëˆ ì´ˆê¸°í™”
                rLotto.dailyPool = 0;
            }

            var baseJackpot = Number(data.lotto_jackpot_pool || 0);
            var totalPrizePool = totalDailyPool + baseJackpot;
            var totalPayout = 0;
            var resM = "ë‹¹ì²¨ ë²ˆí˜¸: [" + win.join(", ") + "]\n";

            // 1ë“± ì§€ê¸‰ (ì „ì•¡ në¹µ)
            if(w1.length > 0) { 
                var p1 = Math.floor(totalPrizePool / w1.length); 
                w1.forEach(function(obj){
                    // ë¶€ë™ì‚° ìì‚°ì´ í¬í•¨ëœ ê²½ì œ ì§€í‘œ ê¸°ì¤€ìœ¼ë¡œ ì§€ê¸‰ ëŠ¥ë ¥ ì²´í¬
                    if (!util_isBankSolvent(obj.rm, p1)) {
                        try { Api.replyRoom(obj.rm, "ğŸš¨ [êµ­ê³  ë¶€ë„] ë¡œë˜ ìƒê¸ˆ ì§€ê¸‰ ëŠ¥ë ¥ì´ ë¶€ì¡±í•˜ì—¬ ì´ì›” ì²˜ë¦¬ë©ë‹ˆë‹¤."); } catch(e){}
                        return;
                    }
                    var res = processRepayment(obj.u, p1, obj.id, obj.rm);
                    util_updatePoint(obj.u, data.rooms[obj.rm], Number(res.actualGain), "ë¡œë˜ 1ë“± ë‹¹ì²¨", obj.rm);
                    totalPayout += p1;
                }); 
                resM += "ğŸ¥‡ 1ë“±: " + w1.length + "ëª… (ê° " + fp(p1) + "P)\n"; 
                data.lotto_jackpot_pool = 0; 
            } else {
                resM += "ğŸ¥‡ 1ë“± ì—†ìŒ (ì „ì•¡ ì´ì›”)\n"; 
                data.lotto_jackpot_pool = totalPrizePool; 
            }

            // 2ë“±/3ë“± ì§€ê¸‰ (ê³ ì • ìƒê¸ˆ)
            w2.forEach(function(obj){ 
                var res = processRepayment(obj.u, 50000, obj.id, obj.rm);
                util_updatePoint(obj.u, data.rooms[obj.rm], Number(res.actualGain), "ë¡œë˜ 2ë“± ë‹¹ì²¨", obj.rm);
                totalPayout += 50000;
            }); 
            if(w2.length > 0) resM += "ğŸ¥ˆ 2ë“±: " + w2.length + "ëª… (ê° 5,0000P)\n";

            w3.forEach(function(obj){ 
                var res = processRepayment(obj.u, 10000, obj.id, obj.rm);
                util_updatePoint(obj.u, data.rooms[obj.rm], Number(res.actualGain), "ë¡œë˜ 3ë“± ë‹¹ì²¨", obj.rm);
                totalPayout += 10000;
            }); 
            if(w3.length > 0) resM += "ğŸ¥‰ 3ë“±: " + w3.length + "ëª… (ê° 1,0000P)";

            // êµ­ê³ (ì¤‘ì•™ì€í–‰) ì¬ì› ì •ì‚°
                if (totalPayout > 0) {
                resM += "\n\nğŸ¦ ìƒê¸ˆ ì´ì•¡ " + fp(totalPayout) + "P êµ­ê³  ì§€ê¸‰ ì™„ë£Œ";
            }

            fails.forEach(function(obj) {
                if (Math.random() < 0.2) { // 20% í™•ë¥ 
                    obj.u.lottoFailCount = (obj.u.lottoFailCount || 0) + 1;
                    var failMsg = "\n\n ğŸ“© ìœ ì €ë‹˜ ë‚™ì²¨ë˜ì—ˆì§€ë§Œ 'ìœ„ë¡œì˜í¸ì§€'ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤.\n";
                    
                    if (obj.u.lottoFailCount >= 15) {
                        obj.u.lottoFailCount = 0;
                        obj.u.luckyCharmEnd = Date.now() + (3600000); // 1ì‹œê°„
                        obj.u.inventory.push({ id: 888, name: "í–‰ìš´ì˜ë¶€ì ", icon: "ğŸ”®", effect: "item", title: "í–‰ìš´ì˜ë¶€ì " });
                        failMsg += "âœ‰ï¸ í¸ì§€ 15ì¥ì´ ëª¨ì—¬ [í–‰ìš´ì˜ë¶€ì ]ìœ¼ë¡œ ë³€í–ˆìŠµë‹ˆë‹¤! âœ¨\nâ³ 1ì‹œê°„ ë™ì•ˆ í™€ì§ ìŠ¹ë¥  +3%ê°€ ìë™ ì ìš©ë©ë‹ˆë‹¤.";
                    } else {
                        failMsg += "í˜„ì¬ ìˆ˜ì§‘: " + obj.u.lottoFailCount + " / 15";
                    }
                    try { Api.replyRoom(obj.rm, "ğŸ’€ ë‚™ì²¨ ì•Œë¦¼\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + obj.u.name + "ë‹˜" + failMsg); } catch(e) {}
                }
            });

            // ëª¨ë“  ë°©ì— ê²°ê³¼ ë°œí‘œ
            try {
                java.lang.Thread.sleep(200); 
                Api.replyRoom(ctx.targetRoom, formatAdmin("ğŸ° ë¡œë˜ ì¶”ì²¨ ê²°ê³¼", resM));
            } catch(e) {}
            util_stamp("lottoLogic");
            ctx.isUpdated = true;
        }
    }
}

//==========ì„¹í„°19==========

// [ìˆ˜ì •] user ë³€ìˆ˜ ë° ìºì‹œ í‚¤ ì„ ì–¸ë¶€ ë³´ê°• (ì°¸ì¡° ì˜¤ë¥˜ ë°©ì§€)
this.msgbot_main_logic = function(room, msg, sender, isGroupChat, replier, imageDB) {
    _perfStartTime = java.lang.System.currentTimeMillis();
    _msgReceiveTime = Date.now();
    
    // [ê°•ë ¥ ê²©ë¦¬] êµ¬ì¸êµ¬ì§ ê´€ë ¨ ë°©ì€ ê¹ƒí—ˆë¸Œ ë¡œì§ì´ ì ˆëŒ€ë¡œ ê°„ì„­í•˜ì§€ ì•ŠìŒ
    var ghostCheckRoom = String(room).replace(/[\u200b-\u200d\ufeff\s]/g, "");
    if (ghostCheckRoom.indexOf("êµ¬ì¸êµ¬ì§ë°©") !== -1 || ghostCheckRoom.indexOf("ë¬¸ì˜ë°©") !== -1) return;

    ParallelPool.execute(new java.lang.Runnable({
        run: function() {
            var realRoom = room ? room.trim() : "";
            var roomName = realRoom; 
            var cleanSender = sender ? String(sender).trim() : "";
            var user = null;

            if (ALLOWED_ROOMS.indexOf(realRoom) === -1 && isGroupChat === true) return;
            if (cleanSender === "ì˜¤í”ˆì±„íŒ…ë´‡") return;

            // [Step 2] ìˆœì°¨ ì²˜ë¦¬ ì—”ì§„ ê°€ë™
            LogicQueue.execute(new java.lang.Runnable({
                run: function() {
                    try {
                        var nowTs = Date.now();
                        var user = null; 
                        var targetUid = null;
                        var cacheKey = "GLOBAL_" + cleanSender;
                    lock.lock(); 

                        var data = getDatabase(); 
                        if (!data) return;

                       // 1. [ì´ˆê³ ì† ì‹ë³„] ìºì‹œ ìš°ì„  í™•ì¸ (ì—°ì‚° ë ‰ ì›ì²œ ì°¨ë‹¨)
                        targetUid = globalData.nameToIdCache[cacheKey];

                        if (!targetUid) {
                            // 2. [ìŠ¤ë§ˆíŠ¸ íƒìƒ‰] ìºì‹œ ì—†ì„ ë•Œë§Œ ì „ êµ¬ì—­ 1íšŒì„± ê²€ìƒ‰
                            var searchName = cleanSender.replace(/\s/g, "");
                            var mainUsers = (data.rooms["ë‚´ë¦¬ë‹¤"] && data.rooms["ë‚´ë¦¬ë‹¤"].users) ? data.rooms["ë‚´ë¦¬ë‹¤"].users : {};
                            
                            // A. ë©”ì¸ë°© 'ë‚´ë¦¬ë‹¤' ìš°ì„  íƒìƒ‰
                            for (var mId in mainUsers) {
                                if (mainUsers[mId].name.replace(/\s/g, "") === searchName) {
                                    targetUid = mId; break;
                                }
                            }
                            // B. ì—†ì„ ê²½ìš° íƒ€ êµ¬ì—­ ì „ìˆ˜ ì¡°ì‚¬ (ìµœì´ˆ 1íšŒë§Œ ìˆ˜í–‰)
                            if (!targetUid) {
                                for (var rN in data.rooms) {
                                    if (rN === "ë‚´ë¦¬ë‹¤") continue;
                                    var rO = data.rooms[rN];
                                    for (var aId in rO.users) {
                                        if (rO.users[aId].name.replace(/\s/g, "") === searchName) {
                                            targetUid = aId; break;
                                        }
                                    }
                                    if (targetUid) break;
                                }
                            }
                            // C. ê²°ê³¼ ìºì‹œ ë°•ì œ
                            if (targetUid) globalData.nameToIdCache[cacheKey] = targetUid;
                        }

                        // 3. [ë¬´ê²°ì„± ë° ê³ ì† ì •í™”] ìœ ì € ê°ì²´ í™•ë³´ ë° ë”¥ í—¬ëŸ¬ í†µí•©
                        var logicRoomName = (realRoom === "ë² ë¦­ë°©" || ALLOWED_ROOMS.indexOf(realRoom) === -1) ? "ë‚´ë¦¬ë‹¤" : realRoom;
                        if (targetUid && data.rooms[logicRoomName] && data.rooms[logicRoomName].users[targetUid]) {
                            user = data.rooms[logicRoomName].users[targetUid];
                            
                            // [v6.6 ë”¥ í—¬ëŸ¬] UID ê°•ì œ ì¼ì¹˜í™” ë° ë¬´ê²°ì„± ë³µêµ¬
                            if (!user.uid || user.uid !== targetUid) {
                                user.uid = targetUid;
                                Log.info("ğŸ©¹ [Deep-Healer] " + user.name + "ì˜ UID ë¬´ê²°ì„±ì„ ë³µêµ¬í–ˆìŠµë‹ˆë‹¤.");
                                safeSaveData(data, false);
                            }

                            // [v15.5 ì§€ëŠ¥í˜• ê³ ì† ì†Œë…] ìˆ«ì/ê¸€ìëŠ” ì¦‰ì‹œ íŒ¨ìŠ¤í•˜ì—¬ í•‘ ì§€ì—° í•´ê²°
                            util_fastClean(user);
                            for (var k in user) {
                                var v = user[k];
                                if (v === null || typeof v !== 'object') continue; 
                                if (v.getClass !== undefined || k === 'replier' || k === 'imageDB') {
                                    delete user[k];
                                }
                            }
                        }

                        // [ì¤‘ê³„ ì‹œìŠ¤í…œ] ìœ ì € ì…ë ¥ ì‹¤ì‹œê°„ íƒˆì·¨
                        // ìœ ì €ê°€ ì¹´ì§€ë…¸ ê°ì‹œ ëª¨ë“œì¼ ë•Œ, í•´ë‹¹ ìœ ì €ê°€ ì¹˜ëŠ” ëª¨ë“  ì±„íŒ…ì„ ì¤‘ê³„ë°©ì— ì „ì†¡
                        if (ALLOWED_ROOMS.indexOf(realRoom) === -1 && realRoom !== CASINO_RELAY_ROOM) {
                        try {
                        var relayInput = "ğŸ‘¤ [1:1ì…ë ¥] " + cleanSender + "\nğŸ’¬ " + msg;
                        Api.replyRoom(CASINO_RELAY_ROOM, relayInput);
                        } catch(e) { Log.error("Input Relay Error: " + e); }
                        }

                       /* [í•µì‹¬ ê°€ë“œ] ì´ì œ ì‹ë³„ëœ targetUidë¡œ ê´€ë¦¬ì ì—¬ë¶€ë¥¼ ì •í™•íˆ íŒë³„í•©ë‹ˆë‹¤. */
                    if (data.botActive === false && !isAdmin(cleanSender, data, targetUid)) {
                        return; 
                    }

                    // 1. ì‹¤ì œ ë©”ì‹œì§€ê°€ ë°œìƒí•œ 'ë¬¼ë¦¬ì ì¸ ë°©'ì˜ ê°ì²´ì™€ featuresë¥¼ ë¨¼ì € ìƒì„± (1:1ë°© ì„¸ì…˜ ì¸ì‹ìš©)
                    if (!data.rooms[roomName]) data.rooms[roomName] = { users: {} };
                    if (!data.rooms[roomName].features) {
                        data.rooms[roomName].features = (typeof ROOM_FEATURE_TEMPLATE === 'function') ? ROOM_FEATURE_TEMPLATE() : {};
                    }

                    // 2. ì´í›„ ë…¼ë¦¬ì  ë°ì´í„° ì²˜ë¦¬ë¥¼ ìœ„í•œ roomData ë¦¬ë‹¤ì´ë ‰íŠ¸ ìˆ˜í–‰ (í¬ì¸íŠ¸/ìœ ì € ì •ë³´ëŠ” 'ë‚´ë¦¬ë‹¤' ì°¸ì¡°)
                    var roomData = (roomName === "ë² ë¦­ë°©" || ALLOWED_ROOMS.indexOf(roomName) === -1) 
                                   ? data.rooms["ë‚´ë¦¬ë‹¤"] 
                                   : (data.rooms[roomName] || { users: {} });

                    // 3. 1:1 ì±„íŒ…ë°© ì „ìš© ì—°ë™ ê°€ë“œ (ë¸”ë¡ ë§ˆê° ì² ì €)
                    if (ALLOWED_ROOMS.indexOf(roomName) === -1) {
                        var mainUsers = (data.rooms["ë‚´ë¦¬ë‹¤"] && data.rooms["ë‚´ë¦¬ë‹¤"].users) ? data.rooms["ë‚´ë¦¬ë‹¤"].users : {};
                        var cleanTarget = cleanSender.replace(/\s/g, "");
                        // (ì´ê³³ì— í•„ìš”í•œ 1:1 ì „ìš© ì¶”ê°€ ë¡œì§ ë°°ì¹˜ ê°€ëŠ¥)
                    } 

                    // 4. ì‹¤ì‹œê°„ í•˜ì´í”„(ì±„íŒ…ëŸ‰) ê¸°ë¡ ë° ë°°ë‹¹ ì£¼ë¨¸ë‹ˆ ë³µêµ¬ (ëª¨ë“  ë°© ê³µí†µ ë¡œì§)
                    if (roomData && roomData.features) {
                        roomData.features.msgCount = (roomData.features.msgCount || 0) + 1;

                        /* [v11.0] 6ëŒ€ ëœë“œë§ˆí¬ ì¼ì¼ ë°°ë‹¹ê¸ˆ ëˆ„ì  ì£¼ë¨¸ë‹ˆ ìë™ ë³µêµ¬ */
                        if (!roomData.features.dailyPools) {
                            roomData.features.dailyPools = { 
                                mine: 0, fish: 0, casino: 0, bank: 0, shop: 0, race: 0 
                            };
                        }
                    }

                // ì„¤ëª…: ì„¹í„° 1ì˜ í…œí”Œë¦¿ì— ìƒˆë¡œìš´ ê¸°ëŠ¥ì´ ì¶”ê°€ë˜ë©´, ê¸°ì¡´ ë°©ì—ë„ ì¦‰ì‹œ í•´ë‹¹ ê³µê°„ì„ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.
                if (typeof ROOM_FEATURE_TEMPLATE === 'function') {
                    var template = ROOM_FEATURE_TEMPLATE();
                    // 1. ë©”ì¸ ê¸°ëŠ¥ í‚¤ ëˆ„ë½ ì²´í¬ (racing, lotto ë“±)
                    for (var key in template) {
                        if (!roomData.features[key]) {
                            roomData.features[key] = template[key];
                        }
                    }
                    // 2. States ë‚´ë¶€ ëˆ„ë½ ì²´í¬ (menuWait, bankProcess ë“±)
                    if (!roomData.features.states) {
                        roomData.features.states = template.states;
                    } else {
                        for (var skey in template.states) {
                            if (!roomData.features.states[skey]) {
                                roomData.features.states[skey] = {};
                            }
                        }
                    }
                }
                
                var rFeatures = roomData.features;

                if (!rFeatures.states) rFeatures.states = { 
                    menuWait: {}, bankProcess: {}, selectWait: {}, lottoPurchase: {},
                    activeThefts: {}, duelData: {}, mining: {}, loanRegister: {}, loanContractWait: {} 
                };

                /* [ë§ˆì´ê·¸ë ˆì´ì…˜] ê¸°ì¡´ ì „ì—­ ë°ì´í„°ë¥¼ í˜„ì¬ ë°©ìœ¼ë¡œ ì´ì‚¬ (ìµœì´ˆ 1íšŒ) */
                if (data.lotto && !rFeatures.lotto.round) {
                    rFeatures.lotto = data.lotto;
                }

                // [Gemini ìš”ì²­ ì‚¬í•­] ë°ì´í„° ì°¸ì¡° ì§€ì—­í™” (Thread-Safe)
                if (rFeatures && rFeatures.states) {
                    var racingData = rFeatures.racing;
                    var lotto = rFeatures.lotto;
                    var feverData = rFeatures.feverData;
                    var sprinkleData = rFeatures.sprinkleData;

                    var menuWaitState = rFeatures.states.menuWait; 
                    var bankProcessState = rFeatures.states.bankProcess;
                    var selectWaitState = rFeatures.states.selectWait;
                    var lottoPurchaseState = rFeatures.states.lottoPurchase;
                    var activeThefts = rFeatures.states.activeThefts;
                    var duelData = rFeatures.states.duelData;
                    var miningState = rFeatures.states.mining;
                    var loanRegisterState = rFeatures.states.loanRegister;
                    var loanContractWaitState = rFeatures.states.loanContractWait;
                }

                // [ê²°íˆ¬ ë¡œì§ ìš°ì„ ìˆœìœ„ ê°€ë“œ]
                // ìˆ˜ë½, ê±°ì ˆ, ì·¨ì†Œ í‚¤ì›Œë“œ ì…ë ¥ ì‹œ ë‹¤ë¥¸ ëŒ€ê¸° ìƒíƒœê°€ ê°„ì„­í•˜ì§€ ëª»í•˜ë„ë¡ ê²°íˆ¬ ë°ì´í„°ë¥¼ ìµœìš°ì„  íƒìƒ‰í•©ë‹ˆë‹¤.
                var SYSTEM_KEYWORDS = ["ì¤ê¸°", "ìˆ˜ë½", "ê±°ì ˆ", "ì·¨ì†Œ", "ì¡ì•˜ë‹¤ìš”ë†ˆ", "ë°°íŒ…ì·¨ì†Œ"];
                var isSystemMsg = msg.startsWith("/") || SYSTEM_KEYWORDS.indexOf(msg) !== -1;

                /* [ì‹ ê·œ] ë„ë°° ë°©ì§€ ë° íƒ€ì„ì•„ì›ƒ ì²´í¬ ì—”ì§„ */
                var user = null;
                var currentImgHash = null;
                try { if (imageDB) currentImgHash = imageDB.getProfileHash(); } catch(e) {}

                // [v6.7 í†µí•©] ìœ ì € ê°ì²´ ë° UID ë™ì‹œ íƒìƒ‰ ì—”ì§„
                for (var id in roomData.users) {
                    var u = roomData.users[id];
                    // í•´ì‹œê°’(í”„ì‚¬) ë˜ëŠ” ë‹‰ë„¤ì„ì´ ì¼ì¹˜í•˜ëŠ”ì§€ ê²€ì‚¬
                    if ((currentImgHash && u.imageHash === currentImgHash) || u.name === cleanSender) {
                        user = u;
                        targetUid = id; // ì°¾ì€ ìœ ì €ì˜ ê³ ìœ  ì½”ë“œ(ID)ë¥¼ ì¦‰ì‹œ ë°”ì¸ë”©
                        break;
                    }
                }

               // 1:1 ì±„íŒ…ë°©ì¼ ê²½ìš°, ì‹œìŠ¤í…œì´ ì°¸ì¡°í•˜ëŠ” 'ë°© ë°ì´í„°(roomData)' ìì²´ë¥¼ ë©”ì¸ë°©ìœ¼ë¡œ ë°”ê¿”ì¹˜ê¸°í•©ë‹ˆë‹¤.
                // íŠ¹ì • ë°© ì´ë¦„ì„ ì§€ì •í•˜ì§€ ì•Šê³ , DBì— ìˆëŠ” ëª¨ë“  ë°©ì„ ë’¤ì ¸ì„œ ê°€ì¥ ë¶€ìì¸ ê³„ì •ì„ ì°¾ì•„ëƒ…ë‹ˆë‹¤.
                if (ALLOWED_ROOMS.indexOf(realRoom) === -1) {
                    var bestMatchUser = null;
                    var bestMatchUid = null;
                    var bestMatchRoomData = null;
                    var maxPoints = -1;

                    // 1. DBì— ì¡´ì¬í•˜ëŠ” ëª¨ë“  ë°©ì„ ìˆœíšŒ
                    for (var dbRoomName in data.rooms) {
                        // í˜„ì¬ 1:1 ë°©(ìê¸° ìì‹ )ì€ ì œì™¸í•˜ê³  ê²€ìƒ‰
                        if (dbRoomName === realRoom) continue;

                        var rData = data.rooms[dbRoomName];
                        if (!rData || !rData.users) continue;

                        // 2. í•´ë‹¹ ë°©ì˜ ìœ ì € ëª©ë¡ ìŠ¤ìº”
                        for (var mUid in rData.users) {
                            var mUser = rData.users[mUid];
                            
                            // ì´ë¦„ ì¼ì¹˜ í™•ì¸ (ê³µë°± ì œê±° í›„ ë¹„êµ)
                            if (mUser.name.trim() === cleanSender.trim()) {
                                var uPoint = Number(mUser.point || 0);
                                
                                // ë™ëª…ì´ì¸(ë˜ëŠ” ìœ ë ¹ê³„ì •) ì¤‘ í¬ì¸íŠ¸ê°€ ê°€ì¥ ë§ì€ 'ì§„ì§œ'ë¥¼ ì„ íƒ
                                if (uPoint > maxPoints) {
                                    maxPoints = uPoint;
                                    bestMatchUser = mUser;
                                    bestMatchUid = mUid;
                                    bestMatchRoomData = rData;
                                }
                            }
                        }
                    }

                    // 3. ì°¾ì€ 'ì§„ì§œ ê³„ì •'ìœ¼ë¡œ 1:1ë°© ë°ì´í„° ë®ì–´ì“°ê¸°
                    if (bestMatchUser && bestMatchRoomData) {
                        user = bestMatchUser;           // ìœ ì € ê°ì²´ êµì²´
                        targetUid = bestMatchUid;       // UID êµì²´
                        roomData = bestMatchRoomData;   // [í•µì‹¬] ì¥ë¶€ë¥¼ ì°¾ì€ ë°©ì˜ ì¥ë¶€ë¡œ êµì²´
                        
                        // ë¡œê·¸: ì—°ê²°ëœ ë°© ì´ë¦„ì´ ë¬´ì—‡ì¸ì§€ í™•ì¸í•˜ê³  ì‹¶ë‹¤ë©´ ì£¼ì„ í•´ì œ
                        // Log.info("[ì—°ë™ ì„±ê³µ] " + cleanSender + " -> " + bestMatchRoomData.users[bestMatchUid].name);
                    }
                }

                /* [v6.6 ë”¥ í—¬ëŸ¬] íƒ€ì… ê²€ì¦í˜• ìê°€ ì¹˜ìœ  ì—”ì§„ (Deep Healing & Memory Sync) */
                if (user && targetUid) {
                    var isDeepHealed = false;
                    
                    // [êµì •]: ê²Œì´íŠ¸ì›¨ì´ ë° ì €ë„ë§ ì‹ë³„ì„ ìœ„í•œ UID ê°•ì œ ë°”ì¸ë”©
                    if (!user.uid || user.uid !== targetUid) {
                        user.uid = targetUid;
                        isDeepHealed = true;
                    }

                    // [âš“ í•´ì /í•´êµ° ì‹œìŠ¤í…œ ë°ì´í„° ìë™ ë§ˆì´ê·¸ë ˆì´ì…˜ ë° ë³´ì •]
    // Sector 1ì˜ USER_SCHEMAì— ì¶”ê°€ëœ ì‹ ê·œ ì§ì—… ê´€ë ¨ í•„ë“œë“¤ì„ ì „ìˆ˜ ì¡°ì‚¬í•˜ì—¬ 
    // ëˆ„ë½ëœ ê²½ìš° ê¸°ë³¸ê°’ì„ ì£¼ì…í•˜ê³ , ì˜ëª»ëœ íƒ€ì…(NaN ë“±)ì€ ì •ê·œí™”í•©ë‹ˆë‹¤.
    USER_SCHEMA.forEach(function(item) {
        var val = user[item.key];
        
        // 1. ì´ë¯¸ ë°ì´í„°ê°€ ì¡´ì¬í•˜ê³  íƒ€ì…ì´ ì˜¬ë°”ë¥¸ ê²½ìš° ìœ ì§€
        if (val !== undefined && val !== null) {
            if (typeof val === item.type || (item.type === 'array' && Array.isArray(val))) return;
        }

        // 2. ìˆ˜ë¦¬ ë¡œì§: ìˆ«ìëŠ” í˜•ë³€í™˜ ì‹œë„, ê·¸ ì™¸(ì§ì—…, ë‚ ì§œ ë“±)ëŠ” ìŠ¤í‚¤ë§ˆ ê¸°ë³¸ê°’ ì£¼ì…
        if (item.type === 'number' && val !== undefined && !isNaN(Number(val))) {
            user[item.key] = Number(val);
        } else {
            user[item.key] = item.default;
        }
        
        // 3. ë³€ê²½ ë°œìƒ ì‹œ ì¹˜ìœ  í”Œë˜ê·¸ í™œì„±í™” (ë¬¼ë¦¬ ì €ì¥ ìœ ë„)
        isDeepHealed = true;
    });

                    // 3. [Sync] ìˆ˜ë¦¬ ë°œìƒ ì‹œ ë¬¼ë¦¬ ì €ì¥ ë° ë©”ëª¨ë¦¬(globalData) ì¦‰ì‹œ ê°±ì‹ 
                    if (isDeepHealed) {
                        Log.info("[Deep-Healer] " + user.name + "ë‹˜ êµ¬ì¡° ìµœì í™” ë° ë™ê¸°í™” ì™„ë£Œ.");
                        safeSaveData(data, false);
                        if (typeof globalData !== 'undefined') globalData = data; 
                    }

                // 4. [Spam Guard] ë„ë°° ë°©ì§€ ë¡œì§ (ë¬´ì—­ ì •ì‚° ì´í›„ì— ì‹¤í–‰)
                var now = Date.now();
                    var conf = SYSTEM_CONFIG.SPAM;
                    if (user.timeoutEndTime && now < user.timeoutEndTime) return;

                    user.chatLog.push(now);
                    user.chatLog = user.chatLog.filter(function(time) { return now - time < conf.LIMIT_WINDOW; });

                    if (user.chatLog.length > conf.LIMIT_COUNT) {
                        user.timeoutEndTime = now + conf.TIMEOUT_MS;
                        user.chatLog = [];
                        var expireTime = new Date(user.timeoutEndTime).toLocaleTimeString();
                        var timeoutMsg = "ğŸ”‡ [ë„ë°° ê°ì§€: ì´ìš© ì œí•œ]\n" +
                                         "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                                         "ëŒ€ìƒ: " + getDisplayName(user) + "ë‹˜\n" +
                                         "ì‚¬ìœ : ë‹¨ì‹œê°„ ê³¼ë„í•œ ì±„íŒ… ë°œì†¡\n" +
                                         "ì œí•œ: " + Math.floor(conf.TIMEOUT_MS / 60000) + "ë¶„ê°„ ë´‡ ì´ìš© ë¶ˆê°€\n" +
                                         "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                                         "ğŸ’¡ í•´ì œ ì‹œê°: " + expireTime;
                        replier.reply(timeoutMsg);
                        safeSaveData(data);
                        return;
                    }
                }

                /* [í•µì‹¬] ë²„ê·¸ ì œë³´ ë° ì§„ì‹¤ íŒë³„ ì‹œìŠ¤í…œ */
                if (msg.startsWith("/ë²„ê·¸ì œë³´ ")) {
                    var content = msg.substring(6).trim();
                    if (content.length < 2) return replier.reply("ë‚´ìš©ì„ ìƒì„¸íˆ ì ì–´ì£¼ì„¸ìš”.");
                    
                    if(user) { 
                        var lastAct = user.lastAction;
                        var timeDiff = lastAct ? (Date.now() - lastAct.time) : 99999999;
                        var diagnosis = "";
                        var isConfirmed = false;

                        if (lastAct && timeDiff < 300000) { 
                            if (lastAct.status === "PENDING") { diagnosis = "âš ï¸ ë¡œì§ ì¤‘ë‹¨ë¨(ì‘ë‹µì—†ìŒ)"; isConfirmed = true; }
                            else if (lastAct.status === "CRASH") { diagnosis = "ğŸš« ì‹œìŠ¤í…œ ì—ëŸ¬(Crash)"; isConfirmed = true; }
                            else if (lastAct.status === "FAIL") { diagnosis = "ğŸ“‰ ë°ì´í„° ë¶ˆì¼ì¹˜(ê³„ì‚°ì˜¤ë¥˜)"; isConfirmed = true; }
                            else if (lastAct.status === "SUCCESS") { 
                                replier.reply("ğŸ¤– [ì‹œìŠ¤í…œ ì§„ë‹¨: ì •ìƒ]\nì§ì „ ì‘ì—…(" + lastAct.cmd + ")ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nì˜¤ë¥˜ê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                                return;
                            }
                        } else { 
                            diagnosis = "â“ ì‹¤í–‰ ê¸°ë¡ ì—†ìŒ(ë¡œì§ ë¯¸ì§„ì…/ì˜¤íƒ€)"; isConfirmed = true; 
                        }

                        var logTime = new Date().toLocaleString();
                        var logTxt = "[" + logTime + "] " + cleanSender + ": " + content + "\n    ã„´ íŒë…: " + diagnosis + "\n";
                        FileStream.append(BUG_LOG_PATH, logTxt);
                        
                        if(isConfirmed) replier.reply("âœ… [ì œë³´ ì ‘ìˆ˜]\níŒë… ê²°ê³¼: " + diagnosis + "\në¶„ì„ ë‚´ìš©ì´ ë²„ê·¸ ë¦¬ìŠ¤íŠ¸ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        else replier.reply("ğŸ“ ì œë³´ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    }
                    return;
                }

                /* ê´€ë¦¬ììš© ì‹œìŠ¤í…œ ì œì–´ */
                if (isAdmin(sender, data)) {
                    if (msg === "/ê°•ì œì¬ê°€ë™") {
                        if (lock.isLocked()) lock.unlock(); 
                        globalData = getDatabase(); 
                        if (globalData) { globalData.botActive = true; safeSaveData(globalData); }
                        replier.reply(formatAdmin("ğŸ”„ ì‹œìŠ¤í…œ ì¬ê°€ë™", "ê²°ê³¼: ë½ í•´ì œ ë° ë©”ëª¨ë¦¬ ë™ê¸°í™” ì™„ë£Œ"));
                        return;
                    }
                }

//==========ì„¹í„°20-1==========

if (!data) return;

// 1. [ìµœìš°ì„  ì‹¤ì²´í™”] ë¦¬ë‹¤ì´ë ‰íŠ¸ ì „, ë©”ì‹œì§€ê°€ ë°œìƒí•œ 'ë¬¼ë¦¬ì  ë°©' ê°ì²´ë¶€í„° ìƒì„±
if (!data.rooms[roomName]) data.rooms[roomName] = { users: {} };
if (!data.rooms[roomName].features) {
    data.rooms[roomName].features = (typeof ROOM_FEATURE_TEMPLATE === 'function') ? ROOM_FEATURE_TEMPLATE() : {};
}
// í•˜ìœ„ states êµ¬ì¡° ê°•ì œ ë³´ê°• (ë¬¼ë¦¬ ë°©ìš©)
if (!data.rooms[roomName].features.states) {
    data.rooms[roomName].features.states = { 
        menuWait: {}, bankProcess: {}, selectWait: {}, lottoPurchase: {},
        activeThefts: {}, duelData: {}, mining: {}, loanRegister: {}, loanContractWait: {} 
    };
}

// 2. [ì°¸ì¡° ë³€ìˆ˜ ì„ ì–¸] ì´í›„ ìœ ì € ë°ì´í„° ì²˜ë¦¬ë¥¼ ìœ„í•œ ë…¼ë¦¬ì  roomData ì—°ê²°
var currentImgHash = (function(){ try { return imageDB ? imageDB.getProfileHash() : null; } catch(e){ return null; } })();
var isIdentityRecovered = false;
var cacheKey = "GLOBAL_" + cleanSender;

// [í•µì‹¬ íŒ¨ì¹˜] ì§€ê°‘ ë°ì´í„°ëŠ” 'ë‚´ë¦¬ë‹¤' ê³ ì •, ì„¸ì…˜ ë°ì´í„°ëŠ” 'í˜„ì¬ ë°©' ê³ ì •
var walletRoomData = data.rooms["ë‚´ë¦¬ë‹¤"]; 
var sessionRoomData = data.rooms[roomName] || data.rooms["ë‚´ë¦¬ë‹¤"];

// í•˜ë‹¨ ë¡œì§ í˜¸í™˜ì„±ì„ ìœ„í•´ roomDataëŠ” ê¸°ì¡´ì²˜ëŸ¼ ìœ ì§€í•˜ë˜, ì„¸ì…˜ ì ‘ê·¼ ì‹œ sessionRoomDataë¥¼ ì“°ë„ë¡ ìœ ë„
var roomData = (roomName === "ë² ë¦­ë°©" || ALLOWED_ROOMS.indexOf(roomName) === -1) 
               ? data.rooms["ë‚´ë¦¬ë‹¤"] 
               : (data.rooms[roomName] || { users: {} });

if (!roomData) roomData = { users: {} };
if (ALLOWED_ROOMS.indexOf(roomName) !== -1 && roomName !== "ë² ë¦­ë°©") {
    data.rooms[roomName] = roomData;
}

if (ALLOWED_ROOMS.indexOf(roomName) === -1) {
    var mainUsers = (data.rooms["ë‚´ë¦¬ë‹¤"] && data.rooms["ë‚´ë¦¬ë‹¤"].users) ? data.rooms["ë‚´ë¦¬ë‹¤"].users : {};
    var cleanTarget = cleanSender.replace(/\s/g, "");
    var foundMainUser = false;

    for (var mUid in mainUsers) {
        if (mainUsers[mUid].name.replace(/\s/g, "") === cleanTarget) {
            targetUid = mUid;
            user = mainUsers[mUid];
            foundMainUser = true;
            break; 
        }
    }

    if (!foundMainUser) {
        var failMsg = "ğŸš« [ì—°ë™ ì‹¤íŒ¨: ë¯¸ê°€ì…]\n" +
                      "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                      "ë©”ì¸ ì„œë²„ 'ë‚´ë¦¬ë‹¤' ì—ì„œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\n" +
                      "âœ… ì´ìš© ê°€ëŠ¥: ì¹´ì§€ë…¸, ì€í–‰, ë‚´ì •ë³´, ë„ì›€ë§\n" +
                      "ğŸš« ì´ìš© ë¶ˆê°€: ìœ„ ëª…ë ¹ì–´ë¥¼ ì œì™¸í•œ ëª¨ë“  ëª…ë ¹ì–´\n\n" +
                      "ğŸ’¡ í•´ê²° ë°©ë²•:\n" +
                      "   ë‹¨ì²´ë°© ë‹‰ë„¤ì„ê³¼ í˜„ì¬ ë‹‰ë„¤ì„ì´ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.\n" +
                      "   (ë„ì–´ì“°ê¸° ë¬´ê´€, íŠ¹ìˆ˜ë¬¸ì í¬í•¨ ì¼ì¹˜ í•„ìš”)";
        replier.reply(failMsg);
        return; 
    }

    if (user && !user.hasSeenSyncNotice) {
        replier.reply("ğŸ”— [ì‹œìŠ¤í…œ] ë©”ì¸ ì„œë²„ ê³„ì •(" + user.name + ")ê³¼ ì„±ê³µì ìœ¼ë¡œ ì—°ë™ë˜ì—ˆìŠµë‹ˆë‹¤.");
        user.hasSeenSyncNotice = true;
    }
} else {
    // [ì¶”ê°€] ë‹¨ì²´ë°© ì ‘ì† ì‹œ ê¸°ì¡´ ìœ ì € ê°ì²´ë¥¼ 'user' ë³€ìˆ˜ì— í• ë‹¹ (ì°¸ì¡° ì˜¤ë¥˜ í•´ê²° í•µì‹¬)
    if (targetUid && roomData.users[targetUid]) user = roomData.users[targetUid];
}

// [2] í˜„ì¬ ì ‘ì†í•œ ë°©(1:1ë°© í¬í•¨)ì˜ ê¸°ëŠ¥ ê°ì²´ê°€ ì—†ìœ¼ë©´ ì¦‰ì‹œ ìƒì„±
if (!roomData.features) {
    roomData.features = (typeof ROOM_FEATURE_TEMPLATE === 'function') ? ROOM_FEATURE_TEMPLATE() : {};
}
// í•˜ìœ„ states êµ¬ì¡°ê°€ ëˆ„ë½ëœ ê²½ìš° ê°•ì œ ë³´ê°•
if (!roomData.features.states) {
    roomData.features.states = { 
        menuWait: {}, bankProcess: {}, selectWait: {}, lottoPurchase: {},
        activeThefts: {}, duelData: {}, mining: {}, loanRegister: {}, loanContractWait: {} 
    };
}

// [3] 1:1ë°©ì´ë¼ë©´ í¬ì¸íŠ¸ ê´€ë¦¬ëŠ” ë©”ì¸ë°©ìœ¼ë¡œ, ì„¸ì…˜ ê´€ë¦¬ëŠ” í˜„ì¬ë°©ìœ¼ë¡œ ë¶„ë¦¬
if (ALLOWED_ROOMS.indexOf(roomName) === -1) {
    var redirectedData = data.rooms["ë‚´ë¦¬ë‹¤"];
    if (redirectedData && redirectedData.users[targetUid]) {
        // user ê°ì²´ëŠ” ë©”ì¸ë°©ì˜ ë°ì´í„°(ëˆ, í…œ ë“±)ë¥¼ ì°¸ì¡°
        user = redirectedData.users[targetUid];
    }
}

if (user) {
    if (typeof util_scrubNativeObject === 'function') {
        util_scrubNativeObject(user);
    }
    // 2ì°¨ í™•ì¸ ì‚¬ì‚´
    if (user.replier) delete user.replier;
    if (user.imageDB) delete user.imageDB;
}

// ì¶”ê°€: ì¹´ì§€ë…¸ VIP ì•ˆë‚´ ê°€ë“œìš© ë¬¼ë¦¬ ë°© ìƒíƒœ ì €ì¥ (ìˆ˜ì •)
if (user) user.isGroupChatTemp = isGroupChat;

// 2. [ì‹ ë¶„ ë³µêµ¬] ì‹ë³„ ì‹¤íŒ¨ ì‹œ ì˜êµ¬ ëª…ë¶€(Registry) ëŒ€ì¡°
var isIdentityRecovered = false;

if (!targetUid) {
    var regKey = roomName + "_" + cleanSender;
    try {
        var regFile = new java.io.File(REGISTRY_PATH);
        if (regFile.exists()) {
            var registry = JSON.parse(FileStream.read(REGISTRY_PATH));
            
            // 1ì°¨ ì‹œë„: í˜„ì¬ ë°© ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰ (ë‹¨ì²´ë°© ë³µêµ¬ìš©)
            if (registry[regKey]) {
                targetUid = registry[regKey]; 
                globalData.nameToIdCache[cacheKey] = targetUid; 
                isIdentityRecovered = true;
                Log.info("[Identity Restore] " + cleanSender + "ë‹˜ ì‹ ë¶„ ë³µêµ¬ ì™„ë£Œ (Local).");
            } 
            // [ì¶”ê°€] 2ì°¨ ì‹œë„: 'ë‚´ë¦¬ë‹¤' ë©”ì¸ í‚¤ë¡œ ê²€ìƒ‰ (1:1ë°© ì—°ë™ í•µì‹¬)
            else {
                var mainKey = "ë‚´ë¦¬ë‹¤_" + cleanSender;
                if (registry[mainKey]) {
                    targetUid = registry[mainKey];
                    globalData.nameToIdCache[cacheKey] = targetUid;
                    isIdentityRecovered = true;
                    Log.info("[Identity Restore] " + cleanSender + "ë‹˜ ì‹ ë¶„ ë³µêµ¬ ì™„ë£Œ (Main Linked).");
                    
                    // [í•µì‹¬ íŒ¨ì¹˜] 1:1 ë°©ì´ë¼ë©´, UIDë¥¼ ì°¾ì€ ì¦‰ì‹œ 'ë‚´ë¦¬ë‹¤' ë°©ì˜ ë°ì´í„°(ì§€ê°‘)ë¥¼ ê°•ì œ ì—°ë™í•©ë‹ˆë‹¤.
                    if (ALLOWED_ROOMS.indexOf(roomName) === -1) {
                        var mainData = data.rooms["ë‚´ë¦¬ë‹¤"];
                        if (mainData && mainData.users[targetUid]) {
                            user = mainData.users[targetUid]; // ì§€ê°‘ ì—°ê²° ì„±ê³µ
                        } else {
                            // ëª…ë¶€ì—” ìˆëŠ”ë° ì‹¤ì œ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° (ì¢€ë¹„ UID) -> ì°¨ë‹¨
                            replier.reply("ğŸš« [ì—°ë™ ì‹¤íŒ¨: ë°ì´í„° ì—†ìŒ]\nëª…ë¶€ì—ëŠ” ë“±ë¡ë˜ì–´ ìˆìœ¼ë‚˜ ë©”ì¸ ì„œë²„('ë‚´ë¦¬ë‹¤')ì— ì‹¤ì œ ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\nê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì—¬ ë°ì´í„°ë¥¼ ë³µêµ¬í•˜ì„¸ìš”.");
                            return; 
                        }
                    }
                }
            }
        }
    } catch(e) { Log.error("Registry Read Error"); }
}

// 3. [ì‹ ê·œ ìƒì„±] ì§„ì§œ ì‹ ê·œ ìœ ì €ì¼ ê²½ìš°
if (!targetUid) {
    // [í•µì‹¬ ê°€ë“œ] 1:1 ëŒ€í™”ë°©ì—ì„œëŠ” ì ˆëŒ€ë¡œ ì‹ ê·œ UIDë¥¼ ìƒì„±í•˜ì§€ ì•Šê³  ì°¨ë‹¨ (ì¤‘ë³µ ê°€ì… ë°©ì§€)
    if (ALLOWED_ROOMS.indexOf(roomName) === -1) {
        replier.reply("ğŸš« [ì—°ë™ ì‹¤íŒ¨: ë¯¸ê°€ì…]\në©”ì¸ ì„œë²„('ë‚´ë¦¬ë‹¤')ì— ê³„ì •ì´ ì—†ê±°ë‚˜ ëª…ë¶€ì™€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\në¨¼ì € ë‹¨ì²´ë°©ì— ì…ì¥í•˜ê±°ë‚˜ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
        return;
    }

    targetUid = generateUUID();
    globalData.nameToIdCache[cacheKey] = targetUid;
    
    try {
        var regKey = roomName + "_" + cleanSender;
        var regFile = new java.io.File(REGISTRY_PATH);
        var registry = regFile.exists() ? JSON.parse(FileStream.read(REGISTRY_PATH)) : {};
        registry[regKey] = targetUid;
        FileStream.write(REGISTRY_PATH, JSON.stringify(registry));
    } catch(e) {}
}

// [C] UIDëŠ” í™•ë³´ë˜ì—ˆìœ¼ë‚˜ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ì´ˆê¸°í™”
// [ìˆ˜ì •] 1:1 ë°©(ALLOWED_ROOMSì— ì—†ìŒ)ì¼ ê²½ìš°, ìœ„ì—ì„œ userë¥¼ ì—°ë™í•˜ì§€ ëª»í–ˆë‹¤ë©´ ì ˆëŒ€ ìƒì„±í•˜ì§€ ì•Šë„ë¡ ì¡°ê±´ ê°•í™”
if (ALLOWED_ROOMS.indexOf(roomName) !== -1 && !roomData.users[targetUid]) {
    var newUser = { uid: targetUid, name: cleanSender, imageHash: currentImgHash, lastDate: "" };

    USER_SCHEMA.forEach(function(item) {
        if (typeof item.default === 'object' && item.default !== null) {
            newUser[item.key] = JSON.parse(JSON.stringify(item.default));
        } else {
            newUser[item.key] = item.default;
        }
    });

    roomData.users[targetUid] = newUser;
    user = newUser; // ìƒˆë¡œ ìƒì„±ëœ ìœ ì € ë°”ì¸ë”©

    if (typeof util_updatePoint === 'function') {
        util_updatePoint(roomData.users[targetUid], roomData, 100000, "ì…ì¥ ì¶•í•˜ ë³´ë„ˆìŠ¤", roomName);
    }
    
    globalData.nameToIdCache[cacheKey] = targetUid;
    
    var welcomeTitle = isIdentityRecovered ? "ğŸŠ [" + cleanSender + "]ë‹˜ ì‹ ë¶„ ë³µêµ¬ ì™„ë£Œ!" : "ğŸŠ [" + cleanSender + "]ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!";
    var welcomeSub = isIdentityRecovered ? "ğŸ›¡ï¸ ì˜êµ¬ ëª…ë¶€ì—ì„œ ê³¼ê±° ê³ ìœ  ì½”ë“œë¥¼ ì°¾ì•„ ì—°ê²°í–ˆìŠµë‹ˆë‹¤." : "ğŸ ì…ì¥ ì¶•í•˜ ë³´ë„ˆìŠ¤: " + fP(100000) + "P ì§€ê¸‰!";
    
    var welcomeMsg = (welcomeTitle + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                      welcomeSub + "\n" +
                      "ğŸ•¹ï¸ ë¯¸ë‹ˆê²Œì„ ë° ì¶œì„ì²´í¬ ê¸°ëŠ¥ ì œê³µ\n" +
                      "ğŸ’³ ì‹ ìš© ë“±ê¸‰: 4ë“±ê¸‰ (600ì ) ë¶€ì—¬\n\n" + 
                      "ğŸ“– ì´ìš© ì „ ë°˜ë“œì‹œ '/ë„ì›€ë§'ì„ í™•ì¸í•´ì£¼ì„¸ìš”!");
                      
    replier.reply(welcomeMsg); 
    safeSaveData(data);
}

// [ìˆ˜ì •] ë‹¨ì²´ë°© ì ‘ì† ì‹œ ê¸°ì¡´ ìœ ì € ê°ì²´ë¥¼ 'user' ë³€ìˆ˜ì— í• ë‹¹ (ì°¸ì¡° ì˜¤ë¥˜ í•´ê²° í•µì‹¬)
// íŠ¹ì • ìœ ì €(ê³µë°± í¬í•¨ ë‹‰ë„¤ì„ ë“±)ì˜ ë°ì´í„° ë§¤ì¹­ ì‹œ var ì„ ì–¸ ëˆ„ë½ ë°©ì§€(ìˆ˜ì •)
if (ALLOWED_ROOMS.indexOf(roomName) !== -1) {
    if (targetUid && roomData.users[targetUid]) {
        user = roomData.users[targetUid];
    }
}

// 1. ê¸°ì¡´ replier ê¸°ëŠ¥ì„ ê°€ë¡œì±„ì„œ 1:1 ë°©ì˜ ë‹µë³€ë§Œ ì¤‘ê³„ë°©ìœ¼ë¡œ ë³µì œí•˜ëŠ” ë„êµ¬ ìƒì„±
var customReplier = {
    reply: function(content) {
        replier.reply(content); // ì›ë˜ ìœ ì €ì—ê²Œ ëŒ€ë‹µ (1:1 ë°© ë˜ëŠ” ë‹¨ì²´ë°©)
        
        // ì¤‘ê³„ ì¡°ê±´: 1:1 ë°©(ë¹„í—ˆìš© ë°©)ì´ë©´ì„œ, ì¤‘ê³„ë°© ìì²´ê°€ ì•„ë‹ ë•Œë§Œ ì‹¤í–‰
        if (ALLOWED_ROOMS.indexOf(realRoom) === -1 && realRoom !== CASINO_RELAY_ROOM) {
            try {
                Api.replyRoom(CASINO_RELAY_ROOM, "ğŸ¤– [1:1ì¶œë ¥] To. " + cleanSender + "\n" + content);
            } catch(e) { Log.error("Relay Output Error: " + e); }
        }
    }
};

// 2. í•µì‹¬ ë¡œì§ í•¨ìˆ˜ í˜¸ì¶œ (ì›ë³¸ replier ëŒ€ì‹  ê°€ë¡œì±„ê¸° ë„êµ¬ì¸ customReplierë¥¼ ì „ë‹¬)
if (user) {
    _processMainLogic(msg, user, data, customReplier, roomName, targetUid, cleanSender, isGroupChat, realRoom, imageDB, sender, roomData);
}

   } catch (e) {
        var errorDetail = e.name + ": " + e.message + " (Line: " + e.lineNumber + ")";
        Log.error("ğŸš¨ [ëŸ°íƒ€ì„ ì—ëŸ¬] " + errorDetail);

        // ê´€ë¦¬ì(95 ë‚¨ ê´‘ì–´)ì—ê²Œ ì—ëŸ¬ì˜ ì›ì¸ê³¼ ì¤„ë²ˆí˜¸ë¥¼ ì¦‰ì‹œ ë³´ê³ 
        try {
            if (isAdmin(sender, data, targetUid)) {
                replier.reply("ğŸš« [ë¡œì§ ì¶©ëŒ ë³´ê³ ]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâ€¢ ìœ í˜•: " + e.name + "\nâ€¢ ë‚´ìš©: " + e.message + "\nâ€¢ ìœ„ì¹˜: Line " + e.lineNumber + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâš ï¸ ì´ ë©”ì‹œì§€ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.");
            } else {
                // ì¼ë°˜ ìœ ì €ì—ê²ŒëŠ” ê¸°ì¡´ ë³´ì•ˆ ë©”ì‹œì§€ ì¶œë ¥
                var safeUser = { name: cleanSender, point: 0, bank: 0 }; 
                if (typeof formatError === 'function') {
                    replier.reply(formatError(safeUser, "ì‹œìŠ¤í…œ ë³´í˜¸ ì‘ë™", "ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ê°ì§€ë˜ì–´ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.\në‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."));
                }
            }
        } catch(inner) {}

        // [Rollback] ì—ëŸ¬ ë°œìƒ ì‹œ ë°ì´í„° ë³µêµ¬
        if (typeof util_stagingRollback === 'function' && user && user.uid) {
            util_stagingRollback(user, roomName);
        }
    } finally {
        // [Lock Release] ë½ í•´ì œ ë° ì§€ì—° ì‹œê°„ ì¸¡ì •
        try {
            if (typeof _perfStartTime !== 'undefined') {
                var _pDur = java.lang.System.currentTimeMillis() - _perfStartTime;
                if (typeof PERF_METRICS !== 'undefined') {
                    PERF_METRICS.avgLag = Math.floor((PERF_METRICS.avgLag * 9 + _pDur) / 10);
                    if (_pDur > PERF_METRICS.peakLag) PERF_METRICS.peakLag = _pDur;
                    PERF_METRICS.msgPerMin++;
                }
            }
            // í˜„ì¬ ìŠ¤ë ˆë“œê°€ ë½ì„ ì¥ê³  ìˆì„ ë•Œë§Œ í•´ì œí•˜ì—¬ IllegalMonitorStateException ë°©ì§€
            if (typeof lock !== 'undefined' && lock !== null && lock.isHeldByCurrentThread()) {
                lock.unlock(); 
            }
        } catch (err) { Log.error("Lock Release Fail: " + err); }
    }
} // LogicQueue.run ì¢…ë£Œ
    })); // LogicQueue.execute ì¢…ë£Œ
} // ParallelPool.run ì¢…ë£Œ
    })); // ParallelPool.execute ì¢…ë£Œ
}; // action í•¨ìˆ˜ ì™„ì „ ì¢…ë£Œ

//==========ì„¹í„°20-2==========

/* [ìˆ˜ì •] ì¸ì ë¦¬ìŠ¤íŠ¸ì— imageDB, senderë¥¼ ì¶”ê°€í•˜ì—¬ ë‚´ë¶€ ë¡œì§ ì˜¤ë¥˜ë¥¼ í•´ê²°í•©ë‹ˆë‹¤. */
function _processMainLogic(msg, user, data, replier, roomName, targetUid, cleanSender, isGroupChat, realRoom, imageDB, sender, roomData) {

   // [1] 1:1ë°© ë°ì´í„° ë™ê¸°í™” (ìµœìš°ì„  ìˆœìœ„: ê²Œì´íŠ¸ í†µê³¼ë¥¼ ìœ„í•´ í•„ìˆ˜)
    if (ALLOWED_ROOMS.indexOf(realRoom) === -1 || realRoom === "ë² ë¦­ë°©") {
        var mainRoomData = data.rooms["ë‚´ë¦¬ë‹¤"];
        if (mainRoomData && mainRoomData.users[targetUid]) {
            user = mainRoomData.users[targetUid]; 
        }
    }

    // [A] ì±„íŒ… ë³´ë„ˆìŠ¤ ì¹´ìš´íŠ¸ (ì¼ë°˜ ì±„íŒ…ë„ ê¸°ë¡í•˜ê¸° ìœ„í•´ ê²Œì´íŠ¸ ìœ„ì— ë°°ì¹˜)
    if (user && msg.indexOf("/") !== 0) {
        user.chatCount = (user.chatCount || 0) + 1;
        user.chatCycleCount = (user.chatCycleCount || 0) + 1;
    }

    // [C] ë”¥ í—¬ëŸ¬ (ë°ì´í„° ìˆ˜ë¦¬ - ëª…ë ¹ì–´ë¥¼ ì¹  ë•Œë§Œ ì‘ë™í•˜ì—¬ ë¡œê·¸ ë…¸ì´ì¦ˆ ì œê±°)
    var isCmd = msg.startsWith("/");
    var isKeyword = ["ì¤ê¸°", "ìˆ˜ë½", "ê±°ì ˆ", "ì·¨ì†Œ", "ì¡ì•˜ë‹¤ìš”ë†ˆ", "ë°°íŒ…ì·¨ì†Œ", "í•œë²ˆë”", "ê·¸ë§Œ", "ì „ë¶€", "ì¶œí•­", "í˜¸ìœ„", "ë’¤ë¡œ", "ì²˜ìŒìœ¼ë¡œ", "ì œì‘"].indexOf(msg.trim()) !== -1;
    var isInputWait = false;
    
    // í˜„ì¬ ìœ ì €ê°€ ë¬´ì–¸ê°€ ì…ë ¥ ëŒ€ê¸° ì¤‘ì¸ì§€ í™•ì¸ (ìˆ«ì ì…ë ¥ ëŒ€ì‘)
    if (roomData && roomData.features && roomData.features.states) {
        var st = roomData.features.states;
        if (st.menuWait[targetUid] || st.bankProcess[targetUid] || st.selectWait[targetUid] || st.lottoPurchase[targetUid]) {
            isInputWait = true;
        }
    }

    // ëª…ë ¹ì–´ê±°ë‚˜, í‚¤ì›Œë“œê±°ë‚˜, ëŒ€ê¸° ìƒíƒœì¼ ë•Œë§Œ ë¬´ê±°ìš´ ì‘ì—…ì„ ìˆ˜í–‰
    if (user && targetUid && (isCmd || isKeyword || isInputWait)) {
        
        // 1. ê³ ì† ì„¸ì²™ (Heavy Task)
        util_fastClean(user);
        if (user.voyage) util_fastClean(user.voyage);
        if (user.lastAction) util_fastClean(user.lastAction);

        // 2. ë”¥ í—¬ëŸ¬ (Schema Check)
        var isDeepHealed = false;
        USER_SCHEMA.forEach(function(item) {
            var val = user[item.key];
            if (val === undefined || val === null) {
                user[item.key] = (typeof item.default === 'object' && item.default !== null) 
                                 ? JSON.parse(JSON.stringify(item.default)) : item.default;
                isDeepHealed = true;
            }
        });
        if (isDeepHealed) {
            safeSaveData(data, false);
        }
    }

/* [ë°ì´í„° & ê°€ë“œ í†µí•© ì—”ì§„] 1:1ë°© ë™ê¸°í™” ë° ìˆ«ì í•¸ë“¤ëŸ¬ í”„ë¦¬íŒ¨ìŠ¤ */
// roomDataê°€ ìœ ì‹¤ëœ ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ì•ˆì „ ì¥ì¹˜
if (!roomData) roomData = data.rooms[roomName] || { users: {} };

/* [v11.0] ì£¼ì‹ -> ëœë“œë§ˆí¬ ë°ì´í„° ìë™ ë§ˆì´ê·¸ë ˆì´ì…˜ */
if (user.landHoldings === undefined) {
    // 1. ê¸°ì¡´ ì£¼ì‹ ë°ì´í„°ë¥¼ ë¶€ë™ì‚° ë°ì´í„°ë¡œ ì•ˆì „í•˜ê²Œ ì´ì „
    user.landHoldings = user.stockHoldings || {};
    user.landAvg = user.stockAvg || {};
    user.totalLandInvest = user.totalInvestAmount || 0;
    user.landDeedCount = user.stockCertCount || 0;
    
    // 2. ì´ì „ ì™„ë£Œ í›„ êµ¬ ë°ì´í„° í•„ë“œ ì‚­ì œ (ë©”ëª¨ë¦¬ ìµœì í™” ë° ì¤‘ë³µ ì´ì „ ë°©ì§€)
    delete user.stockHoldings;
    delete user.stockAvg;
    delete user.totalInvestAmount;
    delete user.stockCertCount;
}

/* ë°ì´í„° êµ¬ì¡° ë³´ì • ë° í•„ìˆ˜ ë³€ìˆ˜ ì´ˆê¸°í™” */
if (!user.inventory) user.inventory = [];
if (user.landDeedCount === undefined) user.landDeedCount = 0;
if (user.totalLandInvest === undefined) user.totalLandInvest = 0;

if (msg === "ì¤ê¸°") {
    var rFeatures = roomData.features;
    if (rFeatures && rFeatures.sprinkleData && rFeatures.sprinkleData.active) {
        if (typeof _gameActionLogic_Part3 === 'function') {
            _gameActionLogic_Part3(msg, user, data, replier, roomName, targetUid);
            return; // ì¤ê¸° ì²˜ë¦¬ ì‹œ ë¡œì§ ì¢…ë£Œí•˜ì—¬ ê°€ë“œ ìš°íšŒ ë° í•˜ë‹¨ ë¡œì§ ì¤‘ë³µ ë°©ì§€
        }
    }
}

/* [ìˆ˜ì •] ë°ì´í„° êµ¬ì¡° ë³´ì • ë° ì´ˆê¸°í™” */
if (!user.inventory) user.inventory = [];
if (user.tierGuard === undefined) user.tierGuard = 0;
if (user.gameAuthCount === undefined) user.gameAuthCount = 0;
if (user.purchasedAuthCount === undefined) user.purchasedAuthCount = 0;

/* [ì‹ ê·œ: Gemini ìš”ì²­ ì‚¬í•­] ê²½ê³ ì‚­ì œê¶Œ êµ¬ë§¤ ì—¬ë¶€ í•„ë“œ ë§ˆì´ê·¸ë ˆì´ì…˜ */
if (user.boughtWarningRemoval === undefined) user.boughtWarningRemoval = false;

/* [ê°œí¸] ëœë¤ë°•ìŠ¤ ì‹œìŠ¤í…œ ê´€ë ¨ ë³€ìˆ˜ ì•ˆì „ ì´ˆê¸°í™” ë° ìë™ ë§ˆì´ê·¸ë ˆì´ì…˜ */
if (user.boxFragments === undefined) user.boxFragments = 0;
if (user.boxTickets === undefined) user.boxTickets = 0;

// 1. ê¸°ë¡ì¥(collectedIcons)ì´ ì—†ìœ¼ë©´ ìƒì„±
if (user.collectedIcons === undefined) {
    user.collectedIcons = [];
}

// 2. [Gemini ìš”ì²­ ì‚¬í•­] ê¸°ì¡´ ë³´ìœ  ì•„ì´ì½˜ ê¸°ë¡ ìë™ ë§ˆì´ê·¸ë ˆì´ì…˜
// ê°€ë°©ì— ìˆëŠ” ì•„ì´ì½˜ë“¤ì„ ì „ìˆ˜ ì¡°ì‚¬í•˜ì—¬ í•œ ë²ˆì´ë¼ë„ ë½‘ì€ ê¸°ë¡ì— ìë™ ë“±ë¡í•©ë‹ˆë‹¤.
if (user.inventory && user.inventory.length > 0) {
    user.inventory.forEach(function(it) {
        if (it.effect === "icon" && user.collectedIcons.indexOf(it.icon) === -1) {
            user.collectedIcons.push(it.icon);
        }
    });
}

/* [í•µì‹¬] ê°•ì œ ì¶”ì‹¬ í”Œë˜ê·¸ ì´ˆê¸°í™” ë° ë³´ì • */
if (user.isTransferred === undefined) user.isTransferred = false;

/* [ê¸°ëŠ¥] ê¸°ì¡´ ì•„ì´ì½˜ ë° ì¹­í˜¸ ê°€ë°© ìë™ ë§ˆì´ê·¸ë ˆì´ì…˜ */
if (user.inventory) {
    // 1. ì•„ì´ì½˜ ë§ˆì´ê·¸ë ˆì´ì…˜
    if (user.icon && user.icon !== "") {
        var hasIconInInv = false;
        for (var j = 0; j < user.inventory.length; j++) {
            if (user.inventory[j].icon === user.icon) { hasIconInInv = true; break; }
        }
        if (!hasIconInInv) {
            for (var k = 0; k < SHOP_ITEMS.length; k++) {
                if (SHOP_ITEMS[k].effect === "icon" && SHOP_ITEMS[k].icon === user.icon) {
                    user.inventory.push({
                        id: SHOP_ITEMS[k].id, name: SHOP_ITEMS[k].name, icon: SHOP_ITEMS[k].icon,
                        effect: "icon", title: ""
                    });
                    // ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œ ê¸°ë¡ì¥ì—ë„ ë™ì‹œ ë“±ë¡
                    if (user.collectedIcons.indexOf(user.icon) === -1) user.collectedIcons.push(user.icon);
                    break;
                }
            }
        }
    }
    
    // 2. ì¹­í˜¸ ë§ˆì´ê·¸ë ˆì´ì…˜ (ëˆ„ë½ë¶„ ì¶”ê°€)
    if (user.title && user.title !== "") {
        var hasTitleInInv = false;
        for (var j = 0; j < user.inventory.length; j++) {
            if (user.inventory[j].title === user.title) { hasTitleInInv = true; break; }
        }
        if (!hasTitleInInv) {
            for (var k = 0; k < SHOP_ITEMS.length; k++) {
                if (SHOP_ITEMS[k].effect === "title" && SHOP_ITEMS[k].title === user.title) {
                    user.inventory.push({
                        id: SHOP_ITEMS[k].id, name: SHOP_ITEMS[k].name, icon: SHOP_ITEMS[k].icon || "",
                        effect: "title", title: SHOP_ITEMS[k].title
                    });
                    break;
                }
            }
        }
    }
}

/* [v11.9.9 ê¸´ê¸‰] ì•ˆì „ ëª¨ë“œ ì§„ì… ë° í†µí•© ì†Œë… */
var today = getSimpleDate();
user.point = Number(user.point || 0);

if (user) {
    user.skipHealing = true;
    // [Deep-Scrub] ì¬ê·€ì  ìë°” ê°ì²´ ì†Œë©¸ ë° ìµœìƒë‹¨ í•¨ìˆ˜/ë„¤ì´í‹°ë¸Œ ì†ì„± ì œê±° í†µí•©
    (function deepScrub(obj) {
        for (var k in obj) {
            if (obj[k] && typeof obj[k] === 'object') {
                if (obj[k].getClass || (obj[k].constructor && obj[k].constructor.name === 'SessionCacheReplier')) {
                    delete obj[k];
                } else { deepScrub(obj[k]); }
            } else if (typeof obj[k] === 'function') {
                delete obj[k];
            }
        }
    })(user);
}

// ì´ì œ ê¹¨ë—í•´ì§„ ìƒíƒœì—ì„œ ìŠ¤í…Œì´ì§• ë° ì„¸ì…˜ ê´€ë¦¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.
util_stagingStart(user);
var isProcessed = false; 

/* ë¯¼ìƒì§€ì›ê¸ˆ ì¦‰ì‹œ ì²´í¬ */
if (user && user.lastDate !== today) {
    checkEconomicStimulus(user, roomName, false);
}

/* [ì‹ ê·œ] ê¸°ì¡´ ì˜ˆê¸ˆì ì´ì ì—”ì§„ ê°•ì œ í™œì„±í™” */
// ì˜ˆê¸ˆì€ ìˆëŠ”ë° ê¸°ì¤€ ì‹œê°„ì´ 0ì¸ ê²½ìš°, ì§€ê¸ˆ ì´ ìˆœê°„ë¶€í„° ì´ìê°€ ìŒ“ì´ë„ë¡ ê¸°ì¤€ì  ì„¤ì •
if (user.bank > 0 && (!user.lastBankUpdateTime || user.lastBankUpdateTime === 0)) {
    user.lastBankUpdateTime = Date.now();
}

// [ê°ì‹œ ì—”ì§„] 3ë¶„ ë¯¸ì‚¬ìš© ì‹œ ì„¸ì…˜ ìë™ ì´ˆê¸°í™” ë¡œì§
var nowTs = Date.now();
if (user.lastBotUseTime > 0 && (nowTs - user.lastBotUseTime > 180000)) {
    // 3ë¶„(180,000ms) ì´ˆê³¼ ì‹œ ê°ì‹œ ë°ì´í„° ë¦¬ì…‹
    user.casinoAuditStartTime = 0;
    user.casinoAuditStartAssets = 0;
    user.casinoAuditAlertHistory = [];
}
// ëª¨ë“  í™œë™ ì‹œ ë§ˆì§€ë§‰ ë´‡ ì‚¬ìš© ì‹œê°„ ê°±ì‹  (ì„¸ì…˜ ìœ ì§€ í•„ìˆ˜)
user.lastBotUseTime = nowTs;

/**
 * [ë…ë¦½í˜• í•¨ìˆ˜] ì¤‘ë³µ ìœ ì € ì„ íƒ ì²˜ë¦¬ ì—”ì§„ (ì „ì—­ ì›ê²© ê´€ì œ v10.5)
 * ì„¤ëª…: ë‹‰ë„¤ì„ ê²€ìƒ‰ ì‹œ ì¤‘ë³µ ë°œìƒ ê±´ì— ëŒ€í•œ ìœ ì €ì˜ ìˆ«ì ì„ íƒì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
 * ë°˜ì˜: ëª¨ë“  ê´€ë¦¬ì ëª…ë ¹ì–´ê°€ ìœ ì €ê°€ ì†í•œ ì‹¤ì œ ë°©(Target Room)ì˜ ë°ì´í„°ë¥¼ ìˆ˜ì •í•˜ë„ë¡ êµì •.
 */
function _handleSelectionLogic(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];
    if (!roomData || !roomData.features || !roomData.features.states.selectWait) return false;

    var selectWaitState = roomData.features.states.selectWait;
    if (!selectWaitState[targetUid]) return false;

    // [ë³´ì•ˆ] ìë°” ê°ì²´ ì˜¤ì—¼ ë°©ì§€ìš© ê³ ì† ì†Œê°
    if (typeof util_fastClean === 'function') util_fastClean(user);

    if (Date.now() - selectWaitState[targetUid].timestamp > 30000 || msg === "ì·¨ì†Œ") {
        delete selectWaitState[targetUid];
        if (msg === "ì·¨ì†Œ") replier.reply(formatCommand("ğŸš« ì„ íƒ ì·¨ì†Œ", user, "ì‘ì—…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    var choice = parseInt(msg.replace(/[^0-9]/g, ""));
    if (!isNaN(choice) && choice >= 1 && choice <= selectWaitState[targetUid].results.length) {
        var state = selectWaitState[targetUid];
        var selected = state.results[choice - 1]; 
        var type = state.type;
        var extra = state.extra;
        
        // [í•µì‹¬ êµì •]: ë³µì‚¬ë³¸ì´ ì•„ë‹Œ ìœ ì €ê°€ ì‹¤ì œ ì†í•œ ë°©ì˜ ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ì§ì ‘ ì°¸ì¡°
        var targetRoom = selected.roomName || "ë‚´ë¦¬ë‹¤";
        var targetRoomData = data.rooms[targetRoom];
        
        if (!targetRoomData) {
            replier.reply(formatError(user, "ë°ì´í„° ì ‘ê·¼ ì˜¤ë¥˜", "í•´ë‹¹ ë°©(" + targetRoom + ")ì˜ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
            delete selectWaitState[targetUid];
            return true;
        }

        var targetUser = targetRoomData.users[selected.id];
        
        if (!targetUser) return true;
        if (typeof util_fastClean === 'function') util_fastClean(targetUser);
        
        delete selectWaitState[targetUid];

        if (type === "admin_mani_select") {
            var mode = extra.mode;
            if (mode === "ON") {
                targetUser.isManipulated = true;
                targetUser.gambleWinRate = SYSTEM_CONFIG.MANIPULATION.DEFAULT_GAMBLE;
                targetUser.fishLuck = SYSTEM_CONFIG.MANIPULATION.DEFAULT_FISH;
                targetUser.horseWinRate = SYSTEM_CONFIG.MANIPULATION.DEFAULT_RACING;
                targetUser.spittoWinRate = SYSTEM_CONFIG.MANIPULATION.DEFAULT_SPITTO;
                targetUser.skipHealing = true; // ë³´ì•ˆ ì—”ì§„ ë¡¤ë°± ë°©ì§€
                replier.reply(formatAdmin("ğŸ¯ ì¡°ì‘ ê°€ë™", "[" + targetRoom + "] " + targetUser.name + "ë‹˜ì˜ ì¡°ì‘ì„ [ê¸°ë³¸ê°’]ìœ¼ë¡œ í™œì„±í™”í–ˆìŠµë‹ˆë‹¤."));
            } else if (mode === "OFF") {
                targetUser.isManipulated = false;
                targetUser.skipHealing = true;
                replier.reply(formatAdmin("ğŸ¯ ì¡°ì‘ í•´ì œ", "[" + targetRoom + "] " + targetUser.name + "ë‹˜ì˜ ëª¨ë“  ì¡°ì‘ì„ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤."));
            } else {
                var status = "ğŸ‘¤ ëŒ€ìƒ: [" + targetRoom + "] " + targetUser.name + "\n" +
                             "âœ¨ ìƒíƒœ: " + (targetUser.isManipulated ? "ğŸŸ¢ ê°€ë™ ì¤‘" : "âšª ë¯¸ê°€ë™") + "\n\n" +
                             "1. ğŸ² í™€ì§ ìŠ¹ë¥ : " + (targetUser.gambleWinRate || 0) + "%\n" +
                             "2. ğŸ£ ë‚šì‹œ ë³´ì •: " + (targetUser.fishLuck || 0) + "%\n" +
                             "3. ğŸ‡ ê²½ë§ˆ ë³´ì •: " + (targetUser.horseWinRate || 0) + "%\n" +
                             "4. ğŸ§§ ìŠ¤í”¼ë˜ ë³´ì •: " + (targetUser.spittoWinRate || 0) + "%\n" +
                             "5. âŒ ì¡°ì‘ ì „ì²´ í•´ì œ\n\n" +
                             "ğŸ’¡ ìˆ˜ì •í•  ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
                
                var currentMenuWait = data.rooms[roomName].features.states.menuWait;
                currentMenuWait[targetUid] = { 
                    type: 'admin_mani_menu', 
                    time: Date.now(), 
                    extra: { targetId: selected.id, targetRoom: targetRoom } 
                };
                replier.reply(formatAdmin("ğŸ¯ ì¡°ì‘ ì„¤ì • ì„¼í„°", status));
            }
            safeSaveData(data, true); // ë³€ê²½ ì‚¬í•­ ì¦‰ì‹œ íŒŒì¼ì— ë°•ì œ
            return true;
        }
        else if (type === "stock_buy" || type === "stock_sell") {
            var landName = selected; 
            var cmdPrefix = (type === "stock_buy") ? "/íˆ¬ì " : "/ë§¤ê° ";
            _gameLandmarkLogic(cmdPrefix + landName + " " + extra.amount, targetUser, data, replier, targetRoom, selected.id);
            return true;
        }
        else if (type === "info") {
            var cr = getCreditInfo(targetUser.creditScore);
            var info = "ğŸ“ ì†Œì†: " + targetRoom + "\nğŸ’° í¬ì¸íŠ¸: " + fp(targetUser.point) + "P\nğŸ¦ ì˜ˆê¸ˆ: " + fp(targetUser.bank) + "P\nğŸ’³ ì‹ ìš©: " + cr.label + " (" + targetUser.creditScore + "ì )\nğŸ… í‹°ì–´: " + (TIERS[targetUser.tier] || "ì•„ì´ì–¸");
            replier.reply(formatCommand("ğŸ” ìœ ì € ìƒì„¸ ì •ë³´", targetUser, info, null));
        }
        else if (type === "mining_info") {
            var isMin = (targetUser.mining && targetUser.mining.active === true);
            var dur = isMin ? Math.floor((Date.now() - targetUser.mining.startTime) / 60000) : 0;
            var tot = (targetUser.totalMiningTime || 0) + dur;
            var pol = util_getActivePolicy(targetRoomData);
            var mult = util_getEcoMultiplier(targetRoom) * (pol.mineMult || 1.0);
            if (targetUser.loan && Number(targetUser.loan.debt) > 0) mult *= 1.5;
            var est = isMin ? Math.floor(dur * SYSTEM_CONFIG.ECO.MINE.BASE_PER_MIN * mult) : 0;

            var body = "\n" + (isMin ? "ì±„êµ´ ì§„í–‰: " + dur + "ë¶„ì§¸...\n" : "âœ¨ ìƒíƒœ: í˜„ì¬ íœ´ì‹ ì¤‘ì…ë‹ˆë‹¤.\n") +
                       "ğŸ“ˆ ëˆ„ì  ì±„êµ´: " + fp(tot) + "ë¶„ ê²½ê³¼\n" +
                       "ğŸ’° ì˜ˆìƒ ìˆ˜ìµ: +" + fp(est) + "P\n" +
                       "âš–ï¸ ì •ì±… íš¨ê³¼: x" + mult.toFixed(1) + " (ì ìš© ì¤‘)\n\n" +
                       "âœ¨ ê´‘ë¬¼ ë°œê²¬ ìˆ˜ìµì€ ì¢…ë£Œ ì‹œ í•©ì‚°ë©ë‹ˆë‹¤.";
            replier.reply(formatCommand("ğŸ” ìœ ì € ê´‘ì‚° ì§„í–‰ í˜„í™©", targetUser, body, null));
        }
        else if (type === "transfer") {
            if (selected.id === targetUid) return replier.reply(formatError(user, "ì†¡ê¸ˆ ë¶ˆê°€", "ìê¸° ìì‹ ì—ê²ŒëŠ” ì†¡ê¸ˆí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
            util_updatePoint(user, roomData, -extra.amount, "ì†¡ê¸ˆ ë³´ëƒ„", roomName);
            var res = processRepayment(targetUser, extra.amount, selected.id, targetRoom);
            util_updatePoint(targetUser, targetRoomData, Number(res.actualGain), "ì†¡ê¸ˆ ë°›ìŒ", targetRoom);
            replier.reply(formatCommand("ğŸ’¸ ì†¡ê¸ˆ ì™„ë£Œ", user, "[" + targetRoom + "] " + getDisplayName(targetUser) + "ë‹˜ê»˜ " + fp(extra.amount) + "P ë³´ëƒˆìŠµë‹ˆë‹¤.", "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
        }
        else if (type === "admin_userdata") { 
            replier.reply(formatAdmin("ìœ ì € ë°ì´í„° ì¡°íšŒ", JSON.stringify(targetUser, null, 2))); 
        }
        else if (type === "admin_point_give") {
            util_updatePoint(targetUser, targetRoomData, extra.amount, "ê´€ë¦¬ì ì§€ê¸‰", targetRoom);
            replier.reply(formatAdmin("í¬ì¸íŠ¸ ì§€ê¸‰ ì™„ë£Œ", "[" + targetRoom + "] " + getDisplayName(targetUser) + "ë‹˜: +" + fp(extra.amount) + "P\n(í˜„ì¬: " + fp(targetUser.point) + "P)"));
            try { Api.replyRoom("ë² ë¦­ë°©", "âš™ï¸ [Admin Action: Selected]\nâ€¢ ì‹¤í–‰ì: " + user.name + "\nâ€¢ ëŒ€ìƒ: [" + targetRoom + "] " + targetUser.name + "\nâ€¢ ë‚´ìš©: " + fp(extra.amount) + "P ì§€ê¸‰ ì™„ë£Œ"); } catch(e) {}
        }
        else if (type === "admin_point_take") {
            util_updatePoint(targetUser, targetRoomData, -extra.amount, "ê´€ë¦¬ì ì°¨ê°", targetRoom);
            replier.reply(formatAdmin("í¬ì¸íŠ¸ ì°¨ê° ì™„ë£Œ", "[" + targetRoom + "] " + getDisplayName(targetUser) + "ë‹˜ ì°¨ê° ì²˜ë¦¬ë¨"));
        }
        else if (type === "admin_attend_edit") {
            targetUser.totalAttendance = extra.days;
            replier.reply(formatAdmin("ì¶œì„ ìˆ˜ì • ì™„ë£Œ", "[" + targetRoom + "] " + getDisplayName(targetUser) + "ë‹˜: " + extra.days + "ì¼"));
        }
        else if (type === "admin_credit_edit") {
            var oldScore = Number(targetUser.creditScore || 600);
            targetUser.creditScore = Math.min(1000, Math.max(0, oldScore + extra.score));
            if (typeof checkAndHandleDefaulter === 'function') checkAndHandleDefaulter(targetUser, targetRoom);
            var crInfo = getCreditInfo(targetUser.creditScore);
            replier.reply(formatAdmin("âš™ï¸ ì‹ ìš© ì ìˆ˜ ì¡°ì • ì™„ë£Œ", "ëŒ€ìƒ: [" + targetRoom + "] " + getDisplayName(targetUser) + "\në³€ë™: " + extra.score + "ì \ní˜„ì¬: " + targetUser.creditScore + "ì  (" + crInfo.label + ")"));
        }
        else if (type === "admin_title_take") {
            var titleToTake = extra.title;
            var inv = targetUser.inventory || [];
            var removed = false;
            targetUser.inventory = inv.filter(function(it) {
                if (it.effect === "title" && (it.title === titleToTake || it.name.indexOf(titleToTake) !== -1)) {
                    removed = true; return false;
                }
                return true;
            });
            if (targetUser.title === titleToTake) { targetUser.title = ""; removed = true; }
            if (removed) {
                replier.reply(formatAdmin("ğŸ–ï¸ ì¹­í˜¸ íšŒìˆ˜ ì™„ë£Œ", "[" + targetRoom + "] " + getDisplayName(targetUser) + "ë‹˜ì—ê²Œì„œ [" + titleToTake + "] ì¹­í˜¸ë¥¼ ë°•íƒˆí–ˆìŠµë‹ˆë‹¤."));
            } else {
                replier.reply(formatAdmin("íšŒìˆ˜ ì‹¤íŒ¨", "[" + targetRoom + "] " + getDisplayName(targetUser) + "ë‹˜ì€ í•´ë‹¹ ì¹­í˜¸ë¥¼ ë³´ìœ í•˜ê³  ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."));
            }
        }
        else if (type === "admin_delete") {
            var tName = targetUser.name;
            var targetId = selected.id;
            var refundLog = "";
            var refundCount = 0;
            var totalRefunded = 0;
            // [êµì •] targetRoomDataì˜ ì‚¬ì±„ ê³„ì•½ ì²˜ë¦¬
            if (targetRoomData.loanContracts) {
                for (var cid in targetRoomData.loanContracts) {
                    var c = targetRoomData.loanContracts[cid];
                    if (c.borrowerUid === targetId) {
                        var lender = targetRoomData.users[c.lenderUid];
                        if (lender) {
                            var debtAmt = Number(c.currentDebt);
                            util_updatePoint(lender, targetRoomData, debtAmt, "ì‚¬ì±„ ê°•ì œ ì •ì‚°", targetRoom);
                            totalRefunded += debtAmt;
                            refundCount++;
                            try { Api.replyRoom(targetRoom, "ğŸš¬ [ì‚¬ì±„ ê°•ì œ ì •ì‚°]\n" + tName + "ë‹˜ì˜ ë°ì´í„° ì‚­ì œë¡œ ì¸í•´ " + lender.name + "ë‹˜ê»˜ ë¯¸ìˆ˜ê¸ˆ " + fp(debtAmt) + "Pê°€ ì „ì•¡ ë°˜í™˜ë˜ì—ˆìŠµë‹ˆë‹¤."); } catch(e){}
                        }
                        delete targetRoomData.loanContracts[cid];
                    }
                }
            }
            if (targetUser.loan && Number(targetUser.loan.debt) > 0) {
                var bankDebt = Number(targetUser.loan.debt);
                util_updateReserve(targetRoomData, bankDebt, "ëŒ€ì¶œê¸ˆ êµ­ê³  íšŒìˆ˜", targetRoom);
                refundLog += "\n\nğŸ¦ ì€í–‰ ëŒ€ì¶œê¸ˆ " + fp(bankDebt) + "Pê°€ êµ­ê³ ë¡œ ìë™ íšŒìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.";
            }
            if (refundCount > 0) refundLog += "\nâš ï¸ ì‚¬ì±„ ë³´ì „ ì™„ë£Œ: " + refundCount + "ê±´ (" + fp(totalRefunded) + "P)";
            
            // ìºì‹œ ì‚­ì œ
            if (typeof uidCache !== 'undefined') {
                for (var key in uidCache) { if (uidCache[key] === targetId) delete uidCache[key]; }
            }
            // [êµì •] ì‹¤ì œ ìœ ì €ê°€ ìˆëŠ” ë°©ì—ì„œ ì‚­ì œ
            delete targetRoomData.users[targetId];
            try {
                var regFile = new java.io.File(REGISTRY_PATH);
                if (regFile.exists()) {
                    var regData = JSON.parse(FileStream.read(REGISTRY_PATH));
                    // [êµì •] íƒ€ê²Ÿ ë°© ì´ë¦„ í‚¤ë¡œ ëª…ë¶€ ì‚­ì œ
                    delete regData[targetRoom + "_" + tName];
                    FileStream.write(REGISTRY_PATH, JSON.stringify(regData));
                }
            } catch (e) { Log.error("Registry Delete Error: " + e); }
            replier.reply(formatAdmin("ìœ ì € ì‚­ì œ ì™„ë£Œ", "[" + targetRoom + "] ë°©ì—ì„œ [" + tName + "]ë‹˜ì˜ ë°ì´í„°ë¥¼ ì˜êµ¬ ì‚­ì œí–ˆìŠµë‹ˆë‹¤." + refundLog));
        }

        else if (type === "admin_land_take") {
            var holdings = targetUser.landHoldings || {};
            var matchedLand = util_findStockByShorthand(holdings, extra.land);
            
            if (matchedLand.length === 0) {
                replier.reply(formatAdmin("ğŸš« íšŒìˆ˜ ì‹¤íŒ¨", "[" + targetUser.name + "]ë‹˜ì€ í•´ë‹¹ ì§€ë¶„ì´ ì—†ìŠµë‹ˆë‹¤."));
            } else {
                var sName = matchedLand[0];
                var currentQty = Number(holdings[sName] || 0);
                var takeQty = (extra.qty === "ì „ë¶€") ? currentQty : parseInt(extra.qty.replace(/,/g, ""));
                if (takeQty > currentQty) takeQty = currentQty;

                targetUser.skipHealing = true;
                util_updateLandmark(targetUser, sName, -takeQty, "ê´€ë¦¬ì ê°•ì œ íšŒìˆ˜", targetRoom);
                
                if (Number(targetUser.landHoldings[sName]) <= 0) {
                    delete targetUser.landHoldings[sName];
                    if (targetUser.landAvg) delete targetUser.landAvg[sName];
                }
                replier.reply(formatAdmin("âš™ï¸ ë¶€ë™ì‚° íšŒìˆ˜ ì™„ë£Œ", "[" + targetRoom + "] " + targetUser.name + "ë‹˜ì˜ [" + sName + "] ì§€ë¶„ì„ íšŒìˆ˜í–ˆìŠµë‹ˆë‹¤."));
            }
        }

        else if (type === "admin_attend_reset") {
            targetUser.lastDate = "";
            replier.reply(formatAdmin("ì¶œì„ ì´ˆê¸°í™”", "[" + targetRoom + "] " + getDisplayName(targetUser) + "ë‹˜ì˜ ì˜¤ëŠ˜ ì¶œì„ ê¸°ë¡ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤."));
        }
        else if (type === "user_restore") {
            var stablePath = BASE_DIR + "backup/last_stable_backup.json";
            var stableFile = new java.io.File(stablePath);

            if (!stableFile.exists() || stableFile.length() === 0) {
                replier.reply(formatAdmin("ğŸš« ë³µêµ¬ ì‹¤íŒ¨", "ì•ˆì „ ë°±ì—… íŒŒì¼(last_stable_backup.json)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
                return true;
            }

            try {
                var sourceCode = (extra && extra.sourceCode) ? extra.sourceCode : selected.id;
                var targetId = selected.id;
                var fullNick = selected.data.name; 

                var backupContent = FileStream.read(stablePath);
                var backupData = JSON.parse(backupContent);
                var rawBackupUser = null;

                for (var r in backupData.rooms) {
                    if (backupData.rooms[r].users[sourceCode]) {
                        rawBackupUser = backupData.rooms[r].users[sourceCode];
                        break;
                    }
                }

                if (!rawBackupUser) throw new Error("ë°±ì—…ë³¸ì— í•´ë‹¹ ë°ì´í„°(ID:" + sourceCode + ")ê°€ ì—†ìŠµë‹ˆë‹¤.");

                // [ìˆ˜ì •] ë°±ì—… ìœ ì € ê°ì²´ ì „ì²´ ë³µì œ (Deep Clone)
                var backupUser = JSON.parse(JSON.stringify(rawBackupUser));
                
                // ë°ì´í„° ê²€ì¦ìš© ìŠ¤ëƒ…ìƒ· (ì¶œë ¥ìš©)
                var tInf = backupUser.tradeCount || 0;
                var sInf = backupUser.shipLevel || 1;
                var iInf = (backupUser.collectedIcons && backupUser.collectedIcons.length) || 0;
                var aInf = backupUser.artifactPieces || 0;

                // USER_SCHEMA ì „ì²´ ìˆœíšŒí•˜ë©° ëª¨ë“  í•„ë“œ ê°•ì œ ì´ì‹
                USER_SCHEMA.forEach(function(item) {
                    if (backupUser[item.key] === undefined) {
                        backupUser[item.key] = (typeof item.default === 'object' && item.default !== null) 
                                               ? JSON.parse(JSON.stringify(item.default)) : item.default;
                    }
                });

                backupUser.name = fullNick;
                backupUser.uid = targetId;
                backupUser.skipHealing = true; 

                // í˜„ì¬ ë°© ë°ì´í„°ë² ì´ìŠ¤ì— ë°±ì—…ë³¸ ê°•ì œ ì£¼ì…
                targetRoomData.users[targetId] = backupUser;

                safeSaveData(data, false);
                if (typeof globalData !== 'undefined') globalData = data;

                // ìƒˆë¡œìš´ ê²€ì¦í˜• UI ë¦¬í¬íŠ¸ êµ¬ì„±
                var debugBody = "ğŸ‘¤ ëŒ€ìƒ: " + fullNick + "\n" +
                                 "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                                 "ğŸ’° ë³µêµ¬ ì”ì•¡: " + fp(backupUser.point) + "P\n" +
                                 "ğŸš¢ ë¬´ì—­ íšŸìˆ˜: " + tInf + "íšŒ\n" +
                                 "ğŸ—ï¸ ì„ ë°• ë“±ê¸‰: " + sInf + "ë‹¨ê³„\n" +
                                 "ğŸ’ ìˆ˜ì§‘ ì•„ì´ì½˜: " + iInf + "ì¢…\n" +
                                 "ğŸ§© ìœ ë¬¼ ì¡°ê°: " + aInf + "ê°œ\n" +
                                 "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                                 "ğŸ’¡ ëª¨ë“  ë¬´ì—­/ìˆ˜ì§‘ ê¸°ë¡ì´ ë°±ì—… ì‹œì ìœ¼ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ì¹˜ê°€ 0ì´ë¼ë©´ ë” ì´ì „ ë°±ì—… íŒŒì¼ì„ ì‚¬ìš©í•˜ì„¸ìš”.";

                replier.reply(formatAdmin("âœ… íŠ¹ì • ìœ ì € ì •ë°€ ë³µì› ì™„ë£Œ", debugBody));

            } catch (e) {
                replier.reply(formatAdmin("ğŸš« ë³µêµ¬ ì¤‘ë‹¨", "ë³µêµ¬ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì‚¬ìœ : " + e.message));
                Log.error("Select Restore Error: " + e);
            }
        }
        else if (type === "admin_nick_log") {
            var hist = data.nickHistory[selected.id] || [];
            if (hist.length === 0) {
                replier.reply(formatAdmin("ë‹‰ë„¤ì„ ê¸°ë¡", "[" + targetRoom + "] " + getDisplayName(targetUser) + "ë‹˜ì€ ë³€ê²½ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤."));
            } else {
                var logMsg = [];
                for(var i=0; i<hist.length; i++) logMsg.push((i+1) + ". " + hist[i].old + " (" + hist[i].date + ")");
                replier.reply(formatAdmin("ğŸ“‹ ë‹‰ë„¤ì„ ë³€ê²½ ì´ë ¥", "ğŸ“ ì†Œì†: " + targetRoom + "\ní˜„ì¬: " + targetUser.name + "\n\n[ê³¼ê±° ê¸°ë¡]\n" + logMsg.join("\n")));
            }
        }
        else if (type === "admin_blackbox") {
            _executeBlackboxSearch(selected.id, targetUser, replier);
        }
        else if (type === "admin_reg_delete") {
            var targetKey = selected.id; 
            var targetFullNick = selected.data.name;
            try {
                var regFile = new java.io.File(REGISTRY_PATH);
                if (regFile.exists()) {
                    var regData = JSON.parse(FileStream.read(REGISTRY_PATH));
                    delete regData[targetKey];
                    FileStream.write(REGISTRY_PATH, JSON.stringify(regData));
                    replier.reply(formatAdmin("ëª…ë¶€ ì‚­ì œ ì™„ë£Œ", "ì°¾ì€ ìœ ì €: [" + targetFullNick + "]\nê´€ë ¨ ì‹ë³„ ì½”ë“œë¥¼ ëª…ë¶€ì—ì„œ íŒŒê¸°í–ˆìŠµë‹ˆë‹¤."));
                }
            } catch (e) { Log.error("Registry Delete Error: " + e); }
        }

        else if (type === "admin_cargo_fix") {
Â  Â  Â  Â  var itemName = String(extra.item);
Â  Â  Â  Â  Â  Â  var count = Number(extra.qty);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (isNaN(count)) {
Â  Â  Â  Â  Â  Â      replier.reply(formatAdmin("ğŸš« ë³µêµ¬ ì‹¤íŒ¨", "ìˆ˜ëŸ‰ ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (NaN)"));
Â  Â  Â  Â  Â  Â      return true;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  var isSpec = false;
Â  Â  Â  Â  Â  Â  for (var n in TRADE_RELATION) { 
Â  Â  Â  Â  Â  Â  Â  Â  if (TRADE_RELATION[n].set === itemName) { isSpec = true; break; } 
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (isSpec) {
Â  Â  Â  Â  Â  Â  Â  Â  if (!targetUser.specialties) targetUser.specialties = {};
Â  Â  Â  Â  Â  Â  Â  Â  targetUser.specialties[itemName] = (Number(targetUser.specialties[itemName]) || 0) + count;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  if (!targetUser.cargo) targetUser.cargo = {};
Â  Â  Â  Â  Â  Â  Â  Â  targetUser.cargo[itemName] = (Number(targetUser.cargo[itemName]) || 0) + count;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  targetUser.skipHealing = true;
Â  Â  Â  Â  replier.reply(formatAdmin("ğŸ“¦ í™”ë¬¼ ê°•ì œ ë³µêµ¬ ì™„ë£Œ", "ëŒ€ìƒ: [" + targetRoom + "] " + targetUser.name + "\ní’ˆëª©: " + (isSpec ? "[íŠ¹] " : "") + itemName + "\nìˆ˜ëŸ‰: " + count + "ê°œ ì¶”ê°€ ì™„ë£Œ"));
Â  Â  }

        safeSaveData(data);
        return true; 
    } // if (!isNaN(choice)...) ë¸”ë¡ ë§ˆê°
}

//==========ì„¹í„°21==========

/**
 * [ë…ë¦½í˜• í•¨ìˆ˜] ë¡œë˜ ë²ˆí˜¸ ì…ë ¥ ì²˜ë¦¬ ì—”ì§„
 */
function _handleLottoInput(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];
    if (!roomData || !roomData.features) return false;

    // ë°©ë³„ ë…ë¦½ ìƒíƒœ ì €ì¥ì†Œ ì°¸ì¡°
    var lottoPurchaseState = roomData.features.states.lottoPurchase;
    
    // í˜„ì¬ ìœ ì €ê°€ ë¡œë˜ êµ¬ë§¤ ëŒ€ê¸° ì¤‘ì¸ì§€ í™•ì¸
    if (!lottoPurchaseState || !lottoPurchaseState[targetUid]) return false;

    // 1. ì‹œê°„ ì´ˆê³¼ ë° ì·¨ì†Œ ê°€ë“œ
    if (Date.now() - lottoPurchaseState[targetUid].time > 30000) {
        delete lottoPurchaseState[targetUid];
        replier.reply(formatError(user, "ì…ë ¥ ì‹œê°„ ì´ˆê³¼", "30ì´ˆê°€ ì§€ë‚˜ êµ¬ë§¤ê°€ ìë™ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."));
        return true;
    }
    if (msg === "ì·¨ì†Œ") {
        delete lottoPurchaseState[targetUid];
        replier.reply(formatCommand("ğŸš« êµ¬ë§¤ ì·¨ì†Œ", user, "ë¡œë˜ êµ¬ë§¤ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    // 2. í™œë™ ìƒíƒœ ê²€ì¦
    var stateRes = util_checkUserState(user, targetUid, roomName);
    if (!stateRes.canAction) {
        delete lottoPurchaseState[targetUid];
        replier.reply(formatError(user, "êµ¬ë§¤ ë¶ˆê°€", stateRes.reason));
        return true;
    }

    // 3. ë²ˆí˜¸ íŒŒì‹±
    var rawNums = msg.match(/\d+/g);
    if (!rawNums || rawNums.length !== 3) {
        replier.reply(formatError(user, "ì…ë ¥ ì˜¤ë¥˜", "ìˆ«ì 3ê°œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.\nì˜ˆ) 1 5 10"));
        return true;
    }
    
    var nums = rawNums.map(Number).sort(function(a, b) { return a - b; });
    var isInvalid = (nums[0] === nums[1] || nums[1] === nums[2] || nums[0] === nums[2]);
    for (var i = 0; i < 3; i++) { if (nums[i] < 1 || nums[i] > 15) isInvalid = true; }
    
    if (isInvalid) {
        replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "1~15 ì‚¬ì´ì˜ ì¤‘ë³µ ì—†ëŠ” ìˆ«ì 3ê°œë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
        return true;
    }

    // 4. ê°€ê²© í™•ì¸ ë° ì”ì•¡ ì²´í¬
    var lottoPrice = (lottoPurchaseState[targetUid].price !== undefined) ? lottoPurchaseState[targetUid].price : 2000;
    if (Number(user.point) < lottoPrice) {
         delete lottoPurchaseState[targetUid];
         replier.reply(formatError(user, "ì”ì•¡ ë¶€ì¡±", fp(lottoPrice) + "Pê°€ í•„ìš”í•©ë‹ˆë‹¤."));
         return true;
    }

    // 5. ë¡œë˜ ë°ì´í„° ë“±ë¡
    var lotto = roomData.features.lotto;
    if (!lotto.entries) lotto.entries = {};
    if (!lotto.entries[targetUid]) lotto.entries[targetUid] = [];

    lotto.entries[targetUid].push(nums);
    lotto.dailyPool = (Number(lotto.dailyPool) || 0) + lottoPrice;

    // 6. ê²°ì œ ë° ì™„ë£Œ
    var prePoint = Number(user.point);
    util_updatePoint(user, roomData, -lottoPrice, "ë¡œë˜ êµ¬ë§¤", roomName);
    var actualDeducted = prePoint - Number(user.point);

    delete lottoPurchaseState[targetUid];
    
    replier.reply(formatCommand("ğŸ« ë¡œë˜ êµ¬ë§¤ ì™„ë£Œ", user, 
        "ì„ íƒ ë²ˆí˜¸: [" + nums.join(", ") + "]\n" +
        "ì°¨ê° ê¸ˆì•¡: " + fp(actualDeducted) + "P\n" +
        "ì¶”ì²¨ ì‹œê°„: ë§¤ì¼ ë°¤ 22:00", 
        "ë‚´ ì”ì•¡: " + fP(user.point) + "P"
    ));

    safeSaveData(data);
    return true; 
}

/* [v14.5] ì±„íŒ… ë³´ë„ˆìŠ¤ ë¡œì§ (1:1ë°© ì™„ì „ ì œì™¸ ë²„ì „) */
function _runChatBonusLogic(msg, user, data, replier, roomName, targetUid, realRoom) {
    // [ê°•ë ¥ ê°€ë“œ] ì‹¤ì œ ë©”ì‹œì§€ê°€ ë°œìƒí•œ ë°©(realRoom)ì´ ALLOWED_ROOMSì— ì—†ìœ¼ë©´ ì¦‰ì‹œ ì¢…ë£Œ
    // roomNameì´ 'ë‚´ë¦¬ë‹¤'ë¡œ ì¹˜í™˜ë˜ì–´ ë“¤ì–´ì˜¤ë”ë¼ë„ realRoomì„ í†µí•´ 1:1ë°©ì„ì„ ì‹ë³„í•©ë‹ˆë‹¤.
    if (!realRoom || ALLOWED_ROOMS.indexOf(realRoom) === -1) return;

    if (msg.indexOf("/") !== 0) {
        user.chatCount = (user.chatCount || 0) + 1;
        user.chatCycleCount = (user.chatCycleCount || 0) + 1;
        
        if (user.chatCycleCount > 13 || !user.chatBonusTarget) {
            user.chatCycleCount = 1; 
            user.chatBonusTarget = Math.floor(Math.random() * 12) + 1;
            user.chatBonusGiven = false; 
        }
        
        if (user.chatCycleCount >= user.chatBonusTarget && !user.chatBonusGiven) {
            var stateRes = util_checkUserState(user, targetUid, roomName);
            if (!stateRes.canAction && stateRes.reason.indexOf("ì§•ì—­") !== -1) return;

            var multiplier = util_getEcoMultiplier(roomName);
            var basePrize = Math.floor(Math.random() * 501) + 1500;
            var prize = Math.floor(basePrize * multiplier);

            var penaltyMsg = "";
            if (Number(user.creditScore || 600) < 500) {
                var penalty = Math.floor(prize * 0.2);
                prize -= penalty;
                penaltyMsg = "\nâš ï¸ ì‹ ìš©ë¶ˆëŸ‰ í˜ë„í‹° ì ìš© (-20%)";
            }
            
            var res = processRepayment(user, prize, targetUid, roomName);
            util_updatePoint(user, data.rooms[roomName], Number(res.actualGain), "ì±„íŒ… ë³´ë„ˆìŠ¤", roomName);

            user.creditScore = Math.min(1000, Number(user.creditScore || 600) + 1);
            
            var output = "ğŸ ì±„íŒ… ë³´ë„ˆìŠ¤\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + getDisplayName(user) + "ë‹˜\n" + fp(prize) + "Pë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!" + (res.repayMsg ? res.repayMsg : "") + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”";
            replier.reply(output + "\në‚´ ì”ì•¡: " + fP(user.point) + "P");
            
            user.chatBonusGiven = true; 
        }
    }
}

//==========ì„¹í„°22-1==========

/* [ë…ë¦½í˜• í•¨ìˆ˜] í†µí•© ì—…ë¬´ ì²˜ë¦¬ í•¸ë“¤ëŸ¬ 1ë‹¨ê³„: ì†¡ê¸ˆ, ì˜ˆê¸ˆ ë° ê¸°ë¶€ */
function _handleBankStep1(msg, user, data, replier, roomName, targetUid) {
    var bankProcessState = data.rooms[roomName].features.states.bankProcess;
    if (!bankProcessState || !bankProcessState[targetUid]) return false;

    var state = bankProcessState[targetUid];
    var types = ['transfer', 'deposit', 'donate', 'blackjack_bet_input'];
    if (types.indexOf(state.type) === -1) return false; // ë‚´ ë‹´ë‹¹ ì—…ë¬´ê°€ ì•„ë‹ˆë©´ íŒ¨ìŠ¤

    // 1. ê³µí†µ ê°€ë“œ (ì‹œê°„ ì´ˆê³¼ ë° ì·¨ì†Œ)
    if (Date.now() - state.time > 30000 || msg === "ì·¨ì†Œ") {
        delete bankProcessState[targetUid];
        if (msg === "ì·¨ì†Œ") {
            replier.reply(formatCommand("ğŸš« ì—…ë¬´ ì·¨ì†Œ", user, "ì—…ë¬´ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."));
        } else {
            replier.reply(formatError(user, "ì„ íƒ ì‹œê°„ ì´ˆê³¼", "30ì´ˆ ì´ë‚´ì— ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì§€ ì•Šì•„ ë©”ë‰´ê°€ ë‹«í˜”ìŠµë‹ˆë‹¤."));
        }
        return true;
    }
    if (msg.startsWith("/")) return false; // ëª…ë ¹ì–´ëŠ” í˜ë ¤ë³´ëƒ„

    // 2. ìŠ¤ë§ˆíŠ¸ ê°€ë“œ (ì§•ì—­)
    if (user.jailReleaseTime && Date.now() < user.jailReleaseTime) {
        delete bankProcessState[targetUid];
        var diff = user.jailReleaseTime - Date.now();
        var remainMin = Math.ceil(diff / (1000 * 60));
        replier.reply(formatError(user, "ì—…ë¬´ ë¶ˆê°€", "í˜„ì¬ ì§•ì—­ ì¤‘ì…ë‹ˆë‹¤. (" + remainMin + "ë¶„ ë‚¨ìŒ)"));
        return true;
    }

    var roomData = data.rooms[roomName];
    if (roomData.bankReserve === undefined) roomData.bankReserve = SYSTEM_CONFIG.ECO.BANK.INITIAL_RESERVE;

    if (state.type === 'blackjack_bet_input') {
        var amt = parseInt(msg.replace(/,/g, ""));
        var bjCfg = SYSTEM_CONFIG.CASINO.BLACKJACK;
        var minB = bjCfg.MIN_BET || 2000;
        var maxB = bjCfg.LIMIT || 50000;

        if (isNaN(amt) || amt < minB || amt > maxB) {
            replier.reply(formatError(user, "ë°°íŒ… ê¸ˆì•¡ ì˜¤ë¥˜", fp(minB) + "P ~ " + fp(maxB) + "P ì‚¬ì´ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
            return true;
        }
        if (Number(user.point) < amt) {
            replier.reply(formatError(user, "ì”ì•¡ ë¶€ì¡±", "ë³´ìœ  í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."));
            return true;
        }

        delete bankProcessState[targetUid]; // ì…ë ¥ ì„¸ì…˜ ì¢…ë£Œ
        // ì„¹í„° 52ì— ì •ì˜ëœ ë¸”ë™ì­ ì‹œì‘ í•¨ìˆ˜ í˜¸ì¶œ
        _startBlackjackGame(user, data, replier, roomName, targetUid, amt);
        return true;
    }

    /* [ê¸°ëŠ¥ 1] ì†¡ê¸ˆ ì²˜ë¦¬ */
    if (state.type === 'transfer') {
        var ps = msg.split(" ");
        if (ps.length < 2) {
            replier.reply(formatError(user, "ì…ë ¥ ì˜¤ë¥˜", "í˜•ì‹: [ë‹‰ë„¤ì„] [ê¸ˆì•¡]"));
            return true;
        }
        var am = parseInt(ps.pop().replace(/,/g, ""));
        var tn = ps.join(" ").trim();
        var found = findUserByName(roomData, tn);

        if (found.length === 0) {
            replier.reply(formatError(user, "ëŒ€ìƒ ì—†ìŒ", "[" + tn + "]ë‹˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        } else if (found.length > 1) {
            handleUserSelection(replier, targetUid, found, "transfer", { amount: am }, user, roomName);
            delete bankProcessState[targetUid];
        } else if (found[0].id === targetUid) {
            replier.reply(formatError(user, "ë³¸ì¸ ì†¡ê¸ˆ ë¶ˆê°€", "ìì‹ ì—ê²ŒëŠ” ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        } else if (isNaN(am) || am <= 0) {
            replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜", "ì •í™•í•œ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
        } else if (user.point < am) {
            replier.reply(formatError(user, "ì”ì•¡ ë¶€ì¡±", "ë³´ìœ  í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."));
        } else {
            var rc = found[0].data;
            util_updatePoint(user, roomData, -am, "ì†¡ê¸ˆ ë³´ëƒ„", roomName);
            var res = processRepayment(rc, am, found[0].id, roomName);
            util_updatePoint(rc, roomData, Number(res.actualGain), "ì†¡ê¸ˆ ë°›ìŒ", roomName);
            replier.reply(formatCommand("ğŸ’¸ ì†¡ê¸ˆ ì™„ë£Œ", user, getDisplayName(rc) + "ë‹˜ê»˜ " + fp(am) + "Pë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤." + res.repayMsg, "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
            delete bankProcessState[targetUid];
            safeSaveData(data);
        }
        return true;
    }

        /* [ê¸°ëŠ¥ 2] ì˜ˆê¸ˆ ì²˜ë¦¬ */
    else if (state.type === 'deposit') {
        var amt = parseInt(msg.replace(/,/g, ""));
        if (isNaN(amt) || amt <= 0) {
            replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜", "ì˜ˆê¸ˆí•  ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
        } else if (user.point < amt) {
            replier.reply(formatError(user, "í¬ì¸íŠ¸ ë¶€ì¡±", "ë³´ìœ í•˜ì‹  í¬ì¸íŠ¸ë³´ë‹¤ ë§ìŠµë‹ˆë‹¤."));
        } else {
            util_updateBank(user, roomData, amt, "ì€í–‰ ì˜ˆê¸ˆ", roomName);
            util_updatePoint(user, roomData, -amt, "ì€í–‰ ì˜ˆê¸ˆ", roomName);
            replier.reply(formatCommand("ğŸ’° ì˜ˆê¸ˆ ì™„ë£Œ", user, fp(amt) + "Pë¥¼ í†µì¥ì— ì…ê¸ˆí–ˆìŠµë‹ˆë‹¤.\n(ì¤‘ì•™ì€í–‰ ê°€ìš© ì¬ì›ìœ¼ë¡œ í¸ì…ë¨)", "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
            delete bankProcessState[targetUid];
            safeSaveData(data);
        }
        return true;
    }

        /* [ê¸°ëŠ¥ 3] ê¸°ë¶€ ì²˜ë¦¬ */
    else if (state.type === 'donate') {
        var amt = parseInt(msg.replace(/,/g, ""));
        if (isNaN(amt) || amt <= 0) {
            replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜", "ê¸°ë¶€í•  ê¸ˆì•¡ì„ ìˆ«ìë¡œ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”."));
        } else if (user.point < amt) {
            replier.reply(formatError(user, "ì”ì•¡ ë¶€ì¡±", "ë³´ìœ í•˜ì‹  í¬ì¸íŠ¸ë³´ë‹¤ ë§ì€ ê¸ˆì•¡ì€ ê¸°ë¶€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        } else {
            var replierStub = { reply: function(m) { Api.replyRoom(roomName, m); } };
            util_updatePoint(user, roomData, -amt, "ì€í–‰ ê¸°ë¶€", roomName);
            var nextDonation = (user.totalDonation || 0) + amt;
            util_setData(user, 'totalDonation', nextDonation, "ê¸°ë¶€ê¸ˆ ëˆ„ì ", roomName);
            
            // 1. [ì‹ ê·œ] ê¸°ë¶€ ê¸ˆì•¡ì— ë”°ë¥¸ ì‹ ìš©ë„ íšŒë³µ ë¡œì§ (10,000Pë‹¹ 2ì )
            var creditGain = Math.floor(amt / 10000) * 2;
            if (creditGain > 0) {
                var nextScore = Math.min(1000, Number(user.creditScore || 600) + creditGain);
                util_setData(user, 'creditScore', nextScore, "ê¸°ë¶€ ë³´ìƒ ì‹ ìš© íšŒë³µ", roomName);
                if (typeof checkAndHandleDefaulter === 'function') checkAndHandleDefaulter(user, roomName);
            }

            // 2. [ìˆ˜ì •] ê¸°ë¶€ ì¹­í˜¸ ì¡°ê±´ ë° ê¸°ë¶€ì™• í˜œíƒ ë³€ê²½
            var donation = user.totalDonation;
            
            if (donation >= 5000000) {
                util_checkAndAwardTitle(user, replierStub, "ê¸°ë¶€ì™•", 5004, "ğŸ‘‘", "ë‚´ë¦¬ë‹¤ ì‚¬íšŒë³µì§€ í˜‘ì˜íšŒ", "ëˆ„ì  ê¸°ë¶€ ê¸ˆì•¡ " + fp(5000000) + "P", "[ì¥ì°© íš¨ê³¼]: ëª¨ë“  ì¢…ë¥˜ì˜ ì„¸ê¸ˆ(ì†Œë“ì„¸, ë¬´ì—­ì„¸, ì¹´ì§€ë…¸ì„¸)ì´ 50% ìƒì‹œ ê°ë©´ë©ë‹ˆë‹¤.", roomName);
            } else if (donation >= 3000000) {
                util_checkAndAwardTitle(user, replierStub, "ìì„ ê°€", 5003, "âœ¨", "ë‚´ë¦¬ë‹¤ ì‚¬íšŒë³µì§€ í˜‘ì˜íšŒ", "ëˆ„ì  ê¸°ë¶€ ê¸ˆì•¡ " + fp(3000000) + "P", "ì‚¬íšŒ ì „ë°˜ì— ê±¸ì³ ì„ í•œ ì˜í–¥ë ¥ì„ ë„ë¦¬ í¼ëœ¨ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.", roomName);
            } else if (donation >= 1000000) {
                util_checkAndAwardTitle(user, replierStub, "ê¸°ë¶€ì²œì‚¬", 5002, "ğŸ‘¼", "ë‚´ë¦¬ë‹¤ ì‚¬íšŒë³µì§€ í˜‘ì˜íšŒ", "ëˆ„ì  ê¸°ë¶€ ê¸ˆì•¡ " + fp(1000000) + "P", "ì–´ë ¤ìš´ ì´ë“¤ì—ê²Œ í¬ë§ì˜ ë¹›ì„ ì„ ì‚¬í–ˆìŠµë‹ˆë‹¤.", roomName);
            } else if (donation >= 500000) {
                util_checkAndAwardTitle(user, replierStub, "ì„ í•œì†ê¸¸", 5001, "ğŸŒ±", "ë‚´ë¦¬ë‹¤ ì‚¬íšŒë³µì§€ í˜‘ì˜íšŒ", "ëˆ„ì  ê¸°ë¶€ ê¸ˆì•¡ " + fp(500000) + "P", "ë‹¹ì‹ ì˜ ë”°ëœ»í•œ ë§ˆìŒì´ ì‚¬íšŒì˜ ì†Œì¤‘í•œ ë°€ì•Œì´ ë©ë‹ˆë‹¤.", roomName);
            }

            var thanksMsg = "ì¤‘ì•™ì€í–‰ì— " + fp(amt) + "Pë¥¼ ê¸°ë¶€í•˜ì…¨ìŠµë‹ˆë‹¤.\n" +
                            "ë³´ë‚´ì£¼ì‹  ì†Œì¤‘í•œ ìì‚°ì€ êµ­ê°€ ê²½ì œ ìœ„ê¸° ê·¹ë³µê³¼ \n" +
                            "ì „ì²´ ìœ ì € ë³µì§€ í–¥ìƒì„ ìœ„í•´ ê·€í•˜ê²Œ ì‚¬ìš©ë©ë‹ˆë‹¤.\n\n" +
                            "ğŸ“ˆ [ì‹ ìš© íšŒë³µ]: +" + creditGain + "ì  ìƒìŠ¹\n" +
                            "ğŸ¦ [êµ­ê³  ì…ê³ ]: ê¸°ë¶€ê¸ˆì´ ì¤‘ì•™ì€í–‰ ì¬ì›ìœ¼ë¡œ ê·€ì†ë¨\n" +
                            "ğŸ“Š ëˆ„ì  ê¸°ë¶€ì•¡: " + fp(donation) + "P";
                replier.reply(formatCommand("ğŸ ê¸°ë¶€ ì™„ë£Œ", user, thanksMsg, "(í˜„ì¬ ì”ì•¡: " + fp(user.point) + "P)"));
                delete bankProcessState[targetUid];
                safeSaveData(data)
            }
        return true;
    }
    return false;
}
            
//==========ì„¹í„°22-2==========

/* [ë…ë¦½í˜• í•¨ìˆ˜] í†µí•© ì—…ë¬´ ì²˜ë¦¬ í•¸ë“¤ëŸ¬ 2ë‹¨ê³„: ì¶œê¸ˆ, ëŒ€ì¶œ, ìƒí™˜ */
function _handleBankStep2(msg, user, data, replier, roomName, targetUid) {
    var bankProcessState = data.rooms[roomName].features.states.bankProcess;
    if (!bankProcessState || !bankProcessState[targetUid]) return false;

    var state = bankProcessState[targetUid];
    var types = ['withdraw', 'loan', 'repay'];
    if (types.indexOf(state.type) === -1) return false;

    // ê³µí†µ ê°€ë“œ
    if (Date.now() - state.time > 30000) {
        delete bankProcessState[targetUid];
        replier.reply(formatError(user, "ì…ë ¥ ì‹œê°„ ì´ˆê³¼", "ì…ë ¥ ì‹œê°„ì´ 30ì´ˆë¥¼ ì´ˆê³¼í•˜ì—¬ ì€í–‰ ì—…ë¬´ê°€ ìë™ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."));
        return true;
    }
    if (msg === "ì·¨ì†Œ") {
        delete bankProcessState[targetUid];
        replier.reply(formatCommand("ğŸš« ì—…ë¬´ ì·¨ì†Œ", user, "ìš”ì²­í•˜ì‹  ì€í–‰ ì—…ë¬´ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."));
        return true;
    }
    if (msg.startsWith("/")) return false;

    var roomData = data.rooms[roomName];
    if (roomData.bankReserve === undefined) roomData.bankReserve = SYSTEM_CONFIG.ECO.BANK.INITIAL_RESERVE;

    /* [ê¸°ëŠ¥ 1] ì¶œê¸ˆ ì²˜ë¦¬ */
    if (state.type === 'withdraw') {
        var amt = parseInt(msg.replace(/,/g, ""));
        if (isNaN(amt) || amt <= 0) {
            replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜", "ì¶œê¸ˆí•  ìˆ«ìë¥¼ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”."));
        } else if (user.bank < amt) {
            replier.reply(formatError(user, "ì”ê³  ë¶€ì¡±", "í†µì¥ ì”ê³ ë³´ë‹¤ ë§ì€ ê¸ˆì•¡ì€ ì¶œê¸ˆí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        } else if (roomData.bankReserve < amt) {
            replier.reply(formatError(user, "ì€í–‰ ì§€ê¸‰ ë¶ˆëŠ¥", "ì£„ì†¡í•©ë‹ˆë‹¤. í˜„ì¬ ì€í–‰ì˜ í˜„ê¸ˆ ìœ ë™ì„±(ì‹¤ì¬ê³ )ì´ ë¶€ì¡±í•˜ì—¬ ì¶œê¸ˆì´ ì¼ì‹œ ì œí•œë©ë‹ˆë‹¤.\nëŒ€ì¶œê¸ˆ íšŒìˆ˜ ë° ìˆ˜ìˆ˜ë£Œ ì ë¦½ ì‹œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.\n\nğŸ¦ í˜„ì¬ ì€í–‰ ê¸ˆê³ : " + fp(roomData.bankReserve) + "P"));
        } else {
           // 1. ì€í–‰ ì”ê³  ê°ì‚¬ ì—”ì§„ ê°€ë™ (- ì°¨ê°)
            util_updateBank(user, roomData, -amt, "ì€í–‰ ì¶œê¸ˆ", roomName);
            
            // 2. í¬ì¸íŠ¸ ê²Œì´íŠ¸ì›¨ì´ ê°€ë™ (+ ì§€ê¸‰ ë° êµ­ê³  ì°¨ê° ì—°ë™)
            util_updatePoint(user, roomData, amt, "ì€í–‰ ì¶œê¸ˆ", roomName);
            
            replier.reply(formatCommand("ğŸ§ ì¶œê¸ˆ ì™„ë£Œ", user, fp(amt) + "Pë¥¼ í˜„ê¸ˆìœ¼ë¡œ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", "ë³´ìœ  í¬ì¸íŠ¸: " + fp(user.point) + "P"));
            
            delete bankProcessState[targetUid]; // ìƒíƒœ í•´ì œ
            safeSaveData(data); // ì¦‰ì‹œ ì €ì¥
        }
        return true;
    }

        /* [ê¸°ëŠ¥ 2] ëŒ€ì¶œ ì‹¤í–‰ */
    else if (state.type === 'loan') {
        var amt = parseInt(msg.replace(/,/g, ""));
        var cr = getCreditInfo(user.creditScore);
        var bConf = SYSTEM_CONFIG.ECO.BANK;
        var lConf = SYSTEM_CONFIG.ECO.PRIVATE_LOAN;

        var totalDeposits = 0;
        for (var id in roomData.users) { totalDeposits += (roomData.users[id].bank || 0); }
        var requiredReserve = Math.floor(totalDeposits * bConf.RESERVE_RATIO);
        var lendableAmount = roomData.bankReserve - requiredReserve;

        var cr = getCreditInfo(user.creditScore, roomName);

        if (isNaN(amt) || amt <= 0) {
            replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜", "ëŒ€ì¶œë°›ì„ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
        } else if (amt > lendableAmount) {
            var reserveInfo = "í˜„ì¬ ì€í–‰ì˜ ëŒ€ì¶œ ê°€ëŠ¥ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.\n(ì§€ê¸‰ì¤€ë¹„ìœ¨ " + (bConf.RESERVE_RATIO * 100) + "% ì¤€ìˆ˜ ì¤‘)\n\n" + "ğŸ¦ í˜„ì¬ ê¸ˆê³ : " + fp(roomData.bankReserve) + "P\n" + "ğŸ›¡ï¸ ë²•ì • ì¤€ë¹„ê¸ˆ: " + fp(requiredReserve) + "P\n" + "ğŸ’° ì‹¤ì œ ëŒ€ì¶œ ê°€ëŠ¥ì•¡: " + fp(Math.max(0, lendableAmount)) + "P";
            replier.reply(formatError(user, "ì€í–‰ ìê¸ˆ ë™ê²°", reserveInfo));
        } else if ((user.dailyLoanCount || 0) >= lConf.DAILY_LIMIT) {
            delete bankProcessState[targetUid];
            replier.reply(formatError(user, "ëŒ€ì¶œ ì œí•œ", "ëŒ€ì¶œì€ í•˜ë£¨ì— ìµœëŒ€ " + lConf.DAILY_LIMIT + "íšŒê¹Œì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."));
        } else if (amt > cr.limit) {
            replier.reply(formatError(user, "í•œë„ ì´ˆê³¼", cr.label + "ì˜ ìµœëŒ€ í•œë„ëŠ” " + fp(cr.limit) + "Pì…ë‹ˆë‹¤."));
        } else {
            user.dailyLoanCount = (user.dailyLoanCount || 0) + 1;
            
            // [ìˆ˜ì •] ëŒ€ì¶œ ì‹¤í–‰ ì‹œ íšŸìˆ˜ì™€ ìƒê´€ì—†ì´ ì¦‰ì‹œ ì‹ ìš©ì ìˆ˜ -20ì  í•˜ë½ í˜ë„í‹° ì ìš©
            user.creditScore = Math.max(0, Number(user.creditScore || 600) - 100);
            checkAndHandleDefaulter(user, roomName);

            var dynMult = (typeof util_getDynamicRateMultiplier === 'function') ? util_getDynamicRateMultiplier(roomName) : 1.0;

            // [ê¸°ë¶€ì™•] ì‹¤í–‰ ì‹œ ì„ ì´ì 30% ê°ë©´
            var rateGap = (cr.rate - 1) * dynMult;
            var finalRate = 1 + rateGap;

            var total = Math.floor(amt * finalRate);
            if (!user.loan || typeof user.loan !== 'object') user.loan = { debt: 0, items: [] };
            if (!user.loan.items) user.loan.items = [];

            var isHighValue = (amt >= (cr.limit * 0.8)); 
            
            // ê¸°ì¡´ ë‹¨ìˆœ ìˆ«ì push ëŒ€ì‹  ê°ì²´ í˜•íƒœë¡œ ì €ì¥í•˜ì—¬ ì†ì„± ë¶€ì—¬
            user.loan.items.push({ 
                amount: Number(total), 
                isHigh: isHighValue,
                date: Date.now() 
            });

            user.loan.debt = Number(user.loan.debt || 0) + Number(total);
            util_updatePoint(user, roomData, amt, "ì€í–‰ ëŒ€ì¶œ ì‹¤í–‰", roomName);

            // [ì¶”ê°€]: ìœ ì € ìƒíƒœì— ë”°ë¥¸ ìë™ ìƒí™˜ ë¹„ìœ¨ íŒì • ë° ì•ˆë‚´ ë¬¸êµ¬ ì¡°ë¦½
            var autoRepayRate = user.isTransferred ? "70%" : (user.creditScore < 500 ? "50%" : "30%");
            var successContent = fp(amt) + "P ì…ê¸ˆ ì™„ë£Œ\n(ìƒí™˜ ì˜ˆì •ì•¡: " + fp(total) + "P)\n\n" +
                                 "ğŸ“¢ [ìë™ ìƒí™˜ ì•ˆë‚´]\n" +
                                 "í–¥í›„ ë°œìƒí•˜ëŠ” ëª¨ë“  ìˆ˜ìµì˜ " + autoRepayRate + "ê°€\n" +
                                 "ëŒ€ì¶œê¸ˆìœ¼ë¡œ ìë™ ìƒí™˜ë©ë‹ˆë‹¤.\n\n" +
                                 "ğŸ“‰ [ì‹ ìš© í•˜ë½]: ëŒ€ì¶œ ì‹¤í–‰ìœ¼ë¡œ ì ìˆ˜ê°€ -100ì  í•˜ë½í–ˆìŠµë‹ˆë‹¤.";

            replier.reply(formatCommand("ğŸ¦ ëŒ€ì¶œ ìŠ¹ì¸", user, successContent, "ë³´ìœ  í¬ì¸íŠ¸: " + fp(user.point) + "P"));
            delete bankProcessState[targetUid];
            safeSaveData(data);
        }
        return true;
    }

        /* [ê¸°ëŠ¥ 3] ìƒí™˜ ì²˜ë¦¬ */
    else if (state.type === 'repay') {
        var amt = parseInt(msg.replace(/,/g, ""));
        if (isNaN(amt) || amt <= 0) {
            replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜", "ìƒí™˜í•  ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
        } else if (user.point < amt) {
            replier.reply(formatError(user, "í¬ì¸íŠ¸ ë¶€ì¡±", "ë³´ìœ í•˜ì‹  í¬ì¸íŠ¸ê°€ ìƒí™˜ì•¡ë³´ë‹¤ ì ìŠµë‹ˆë‹¤."));
        } else {
            var res = distributeRepayment(user, amt, roomName);
            util_updatePoint(user, roomData, -Number(res.actualRepay), "ëŒ€ì¶œ ìƒí™˜", roomName);
            var currentDebt = (user.loan && user.loan.debt) ? Number(user.loan.debt) : 0;
            var repaySuccessMsg = fp(res.actualRepay) + "P ìƒí™˜ë˜ì—ˆìŠµë‹ˆë‹¤.";
            
            // ì‹ ìš© íšŒë³µ ì¡°ê±´ ë‹¬ì„± ì‹œì—ë§Œ ë¬¸êµ¬ ì‚½ì…
            if (res.creditGain > 0) {
                repaySuccessMsg += "\nğŸ“ˆ ì‹ ìš© ì ìˆ˜ +" + res.creditGain + " ìƒìŠ¹";
            }
            
            repaySuccessMsg += "\n\nğŸ¦ ì€í–‰ ì¬ì› ì¶©ì „: +" + fp(res.actualRepay) + "P";

            replier.reply(formatCommand("ğŸ“‰ ìƒí™˜ ì™„ë£Œ", user, repaySuccessMsg, "ë‚¨ì€ ëŒ€ì¶œê¸ˆ: " + fp(currentDebt) + "P"));
            delete bankProcessState[targetUid];
            safeSaveData(data);
        }
        return true;
    }
    return false;
}
            
//==========ì„¹í„°22-3==========

/* [ë…ë¦½í˜• í•¨ìˆ˜] í†µí•© ì—…ë¬´ ì²˜ë¦¬ í•¸ë“¤ëŸ¬ 3ë‹¨ê³„: ì‚¬ì±„ ë“±ë¡ ë° ë¹Œë¦¬ê¸° */
function _handleBankStep3(msg, user, data, replier, roomName, targetUid) {
    var bankProcessState = data.rooms[roomName].features.states.bankProcess;
    if (!bankProcessState || !bankProcessState[targetUid]) return false;

    var state = bankProcessState[targetUid];
    var types = ['p2p_reg_input', 'p2p_borrow_amt'];
    if (types.indexOf(state.type) === -1) return false;

    if (Date.now() - state.time > 30000) {
        delete bankProcessState[targetUid];
        replier.reply(formatError(user, "ì…ë ¥ ì‹œê°„ ì´ˆê³¼", "ì…ë ¥ ì‹œê°„ì´ 30ì´ˆë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤."));
        return true;
    }
    if (msg === "ì·¨ì†Œ") {
        delete bankProcessState[targetUid];
        replier.reply(formatCommand("ğŸš« ì—…ë¬´ ì·¨ì†Œ", user, "ì—…ë¬´ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    var roomData = data.rooms[roomName];

    /* [ê¸°ëŠ¥ 1] ì‚¬ì±„ ë“±ë¡ */
    if (state.type === 'p2p_reg_input') {
        var parts = msg.split(" ");
        if (parts.length < 2) {
            replier.reply(formatError(user, "ì…ë ¥ ì˜¤ë¥˜", "í˜•ì‹: [ê¸ˆì•¡] [ì´ìœ¨]\nì˜ˆ) 10000 5"));
        } else {
            var amt = parseInt(parts[0]);
            var rate = parseInt(parts[1]);
            var conf = SYSTEM_CONFIG.ECO.PRIVATE_LOAN;

            if (isNaN(amt) || amt < conf.MIN_AMOUNT) {
                replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜", "ìµœì†Œ " + fp(conf.MIN_AMOUNT) + "P ì´ìƒ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤."));
            } else if (isNaN(rate) || rate < 5 || rate > conf.MAX_RATE) {
                replier.reply(formatError(user, "ì´ìœ¨ ì˜¤ë¥˜", "ì´ìœ¨ì€ 5% ~ " + conf.MAX_RATE + "% ì‚¬ì´ë¡œ ì„¤ì •í•˜ì„¸ìš”."));
            } else if (user.point < amt) {
                replier.reply(formatError(user, "í¬ì¸íŠ¸ ë¶€ì¡±", "ë³´ìœ  í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."));
            } else {
                util_updatePoint(user, roomData, -amt, "ì‚¬ì±„ í’€ ë“±ë¡", roomName);
                var poolId = generateUUID();
                if (!roomData.loanPools) roomData.loanPools = {};
                roomData.loanPools[poolId] = {
                    lenderUid: targetUid, lenderName: user.name, totalAmount: amt,
                    remainingAmount: amt, rate: rate, time: Date.now()
                };

                // 3. ìƒíƒœ í•´ì œ (ì¤‘ë³µ ì…ë ¥ ë°©ì§€)
                if (bankProcessState) delete bankProcessState[targetUid];

                // 4. [ë³´ì•ˆ] ë¬¼ë¦¬ ì €ì¥ ì „ ë©´ì œê¶Œ ë¶€ì—¬ ë° ì¦‰ì‹œ ì €ì¥ ì§‘í–‰
                user.skipHealing = true; 
                safeSaveData(data, true); // ë¹„ë™ê¸° íë¥¼ ê±°ì¹˜ì§€ ì•Šê³  ì¦‰ì‹œ ë¬¼ë¦¬ íŒŒì¼ ê¸°ë¡

                replier.reply(formatCommand("ğŸ’° ì‚¬ì±„ ë“±ë¡ ì™„ë£Œ", user, fp(amt) + "P (ì´ì " + rate + "%/3h) ë§¤ë¬¼ì„ ì˜¬ë ¸ìŠµë‹ˆë‹¤.", "ë‚¨ì€ ì”ì•¡: " + fp(user.point) + "P"));
            }
        }
        return true;
    }

        /* [ê¸°ëŠ¥ 2] ì‚¬ì±„ ë¹Œë¦¬ê¸° */
    else if (state.type === 'p2p_borrow_amt') {
        var amt = parseInt(msg);
        var pool = roomData.loanPools[state.extra.poolId];
        var conf = SYSTEM_CONFIG.ECO.PRIVATE_LOAN;

        if (!pool) {
            replier.reply(formatError(user, "ë§¤ë¬¼ ì •ë³´ ì—†ìŒ", "ìœ íš¨í•˜ì§€ ì•Šì€ ë§¤ë¬¼ì…ë‹ˆë‹¤."));
        } else if (isNaN(amt) || amt < conf.MIN_BORROW) {
            replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜", "ìµœì†Œ " + fp(conf.MIN_BORROW) + "P ì´ìƒ ë¹Œë ¤ì•¼ í•©ë‹ˆë‹¤."));
        } else if (amt > pool.remainingAmount) {
            replier.reply(formatError(user, "ê¸ˆì•¡ ì´ˆê³¼", "ì”ì—¬ ê¸ˆì•¡(" + fp(pool.remainingAmount) + "P)ê¹Œì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."));
        } else if (pool.lenderUid === targetUid) {
            replier.reply(formatError(user, "ê³„ì•½ ë¶ˆê°€", "ë³¸ì¸ ì‚¬ì±„ëŠ” ë¹Œë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        } else {
            pool.remainingAmount -= amt;
            if (pool.remainingAmount <= 0) delete roomData.loanPools[state.extra.poolId];
            var initialDebt = Math.floor(amt * 1.1);
            var contractId = generateUUID();
            if (!roomData.loanContracts) roomData.loanContracts = {};
            roomData.loanContracts[contractId] = {
                lenderUid: pool.lenderUid, lenderName: pool.lenderName,
                borrowerUid: targetUid, borrowerName: user.name,
                principal: amt, currentDebt: initialDebt, rate: pool.rate,
                startTime: Date.now(), status: 'active'
            };
            util_updatePoint(user, roomData, amt, "ì‚¬ì±„ ë¹Œë¦¼ íšŒìˆ˜ ìŠ¹ì¸", roomName);
            replier.reply(formatCommand("ğŸ“ ì‚¬ì±„ ê³„ì•½ ì²´ê²°", user, pool.lenderName + "ë‹˜ìœ¼ë¡œë¶€í„° " + fp(amt) + "Pë¥¼ ë¹Œë ¸ìŠµë‹ˆë‹¤.\n(ì„ ì´ì 10% í¬í•¨ ì±„ë¬´: " + fp(initialDebt) + "P)", "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
            delete bankProcessState[targetUid];
            safeSaveData(data);
        }
        return true;
    }
    return false;
}

//==========ì„¹í„°22-4==========

/* [ë…ë¦½í˜• í•¨ìˆ˜] í†µí•© ì—…ë¬´ ì²˜ë¦¬ í•¸ë“¤ëŸ¬ 4ë‹¨ê³„: ì‚¬ì±„ ìƒí™˜/íšŒìˆ˜/ìˆ˜ê±° */
function _handleBankStep4(msg, user, data, replier, roomName, targetUid) {
    var bankProcessState = data.rooms[roomName].features.states.bankProcess;
    if (!bankProcessState || !bankProcessState[targetUid]) return false;

    var state = bankProcessState[targetUid];
    var types = ['p2p_repay_amt', 'p2p_withdraw_amt', 'p2p_collect_manual'];
    if (types.indexOf(state.type) === -1) return false;

    if (Date.now() - state.time > 30000 || msg === "ì·¨ì†Œ") {
        delete bankProcessState[targetUid];
        if (msg === "ì·¨ì†Œ") replier.reply(formatCommand("ğŸš« ì—…ë¬´ ì·¨ì†Œ", user, "ì—…ë¬´ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."));
        else replier.reply(formatError(user, "ì…ë ¥ ì‹œê°„ ì´ˆê³¼", "ì…ë ¥ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    var roomData = data.rooms[roomName];

    /* [ê¸°ëŠ¥ 1] ì‚¬ì±„ ìƒí™˜ */
    if (state.type === 'p2p_repay_amt') {
        var amt = parseInt(msg);
        var contract = roomData.loanContracts[state.extra.contractId];
        if (!contract) {
            replier.reply(formatError(user, "ê³„ì•½ ì •ë³´ ì—†ìŒ"));
        } else if (isNaN(amt) || amt <= 0 || user.point < amt) {
            replier.reply(formatError(user, "ê¸ˆì•¡/í¬ì¸íŠ¸ ì˜¤ë¥˜"));
        } else {
            var actualRepay = Math.min(amt, contract.currentDebt);
            util_updatePoint(user, roomData, -actualRepay, "ì‚¬ì±„ ìƒí™˜ ì§€ë¶ˆ", roomName);
            var lender = roomData.users[contract.lenderUid];
            if (lender) util_updatePoint(lender, roomData, actualRepay, "ì‚¬ì±„ ì´ì ìˆ˜ì…", roomName);
            
            contract.currentDebt -= actualRepay;
            var footerMsg = "ë‚¨ì€ ë¹š: " + fp(contract.currentDebt) + "P";
            if (contract.currentDebt <= 0) {
                delete roomData.loanContracts[state.extra.contractId];
                footerMsg = "ëª¨ë“  ì±„ë¬´ê°€ ë³€ì œë˜ì—ˆìŠµë‹ˆë‹¤.";
            }
            replier.reply(formatCommand("ğŸ“‰ ì‚¬ì±„ ìƒí™˜ ì™„ë£Œ", user, contract.lenderName + "ë‹˜ê»˜ " + fp(actualRepay) + "Pë¥¼ ê°šì•˜ìŠµë‹ˆë‹¤.\n" + footerMsg, "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
            delete bankProcessState[targetUid];
            safeSaveData(data);
        }
        return true;
    }

        /* [ê¸°ëŠ¥ 2] ì‚¬ì±„ ë§¤ë¬¼ íšŒìˆ˜ */
    else if (state.type === 'p2p_withdraw_amt') {
        var amt = (msg === "ì „ì•¡") ? state.extra.max : parseInt(msg);
        var pool = roomData.loanPools[state.extra.poolId];
        if (!pool) {
            replier.reply(formatError(user, "ë§¤ë¬¼ ì •ë³´ ì—†ìŒ"));
        } else if (isNaN(amt) || amt <= 0 || amt > pool.remainingAmount) {
            replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜"));
        } else {
            pool.remainingAmount -= amt;
            util_updatePoint(user, roomData, amt, "ì‚¬ì±„ í’€ ì§ì ‘ ìˆ˜ê±°", roomName);
            if (pool.remainingAmount <= 0) delete roomData.loanPools[state.extra.poolId];
            replier.reply(formatCommand("âœ… ì‚¬ì±„ íšŒìˆ˜ ì™„ë£Œ", user, fp(amt) + "Pë¥¼ íšŒìˆ˜í–ˆìŠµë‹ˆë‹¤.", "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
            delete bankProcessState[targetUid];
            safeSaveData(data);
        }
        return true;
    }

        /* [ê¸°ëŠ¥ 3] ì±„ë¬´ì ê°•ì œ ìˆ˜ê±° */
    else if (state.type === 'p2p_collect_manual') {
        var contract = roomData.loanContracts[state.extra.contractId];
        if (!contract) {
            replier.reply(formatError(user, "ê³„ì•½ ì •ë³´ ì—†ìŒ"));
        } else {
            var debtor = roomData.users[contract.borrowerUid];
            if (!debtor) {
                replier.reply(formatError(user, "ì±„ë¬´ì ì •ë³´ ì—†ìŒ"));
            } else {
                var collectAmt = Math.min(Number(debtor.point), contract.currentDebt);
                if (collectAmt <= 0) {
                    replier.reply(formatError(user, "ìˆ˜ê±° ì‹¤íŒ¨", "ì±„ë¬´ìì˜ ì§€ê°‘ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤."));
                } else {
                    util_updatePoint(debtor, roomData, -collectAmt, "ì‚¬ì±„ ê°•ì œ ìˆ˜ê±° ë‹¹í•¨", roomName);
                    util_updatePoint(user, roomData, collectAmt, "ì‚¬ì±„ ì§ì ‘ ìˆ˜ê±° ìˆ˜ìµ", roomName);
                    contract.currentDebt -= collectAmt;
                    var footer = "ë‚¨ì€ ë¹š: " + fp(contract.currentDebt) + "P";
                    if (contract.currentDebt <= 0) {
                        delete roomData.loanContracts[state.extra.contractId];
                        footer = "ëª¨ë“  ì±„ë¬´ê°€ ë³€ì œë˜ì—ˆìŠµë‹ˆë‹¤.";
                    }
                    replier.reply(formatCommand("ğŸš¬ ê°•ì œ ìˆ˜ê±° ì™„ë£Œ", user, debtor.name + "ë‹˜ì—ê²Œì„œ " + fp(collectAmt) + "Pë¥¼ ìˆ˜ê±°í–ˆìŠµë‹ˆë‹¤.\n" + footer, "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
                    safeSaveData(data);
                }
            }
        }
        delete bankProcessState[targetUid];
        return true;
    }
    return false;
}

//==========ì„¹í„°22-5==========

/* [ë…ë¦½í˜• í•¨ìˆ˜] í†µí•© ì—…ë¬´ ì²˜ë¦¬ í•¸ë“¤ëŸ¬ 5ë‹¨ê³„: ìƒì  ì•„ì´í…œ êµ¬ë§¤ ë° ìˆ˜ëŸ‰ ì²˜ë¦¬ */
function _handleBankStep5(msg, user, data, replier, roomName, targetUid) {
    var bankProcessState = data.rooms[roomName].features.states.bankProcess;
    if (!bankProcessState || !bankProcessState[targetUid]) return false;

    var state = bankProcessState[targetUid];
    var types = ['shop_buy', 'shop_quantity', 'ship_rename_input', 'ship_rename_confirm', 'trade_invest_amount', 'trade_invest_confirm', 'trade_cargo_done'];
    if (types.indexOf(state.type) === -1) return false;

    if (ALLOWED_ROOMS.indexOf(roomName) === -1) {
        delete bankProcessState[targetUid];
        replier.reply("ğŸš« [ê¸°ëŠ¥ ì œí•œ]\nìƒì  ë° ì„ ë°• ê´€ë¦¬ ê¸°ëŠ¥ì€ ë‹¨ì²´ë°©('ë‚´ë¦¬ë‹¤')ì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        return true;
    }

    // ë¬´ì—­ ìƒì (ì¹´í…Œê³ ë¦¬ 6) ì—¬ë¶€ë¥¼ 100% ì‹ë³„í•˜ëŠ” ì§€ëŠ¥í˜• í”Œë˜ê·¸
    var isTradeFlow = (function() {
        if (state.extra && state.extra.item && state.extra.item.cat === 6) return true;
        if (state.extra && state.extra.cat === 6) return true;
        var currentItems = (state.extra && (state.extra.items || state.extra.prevItems));
        if (currentItems && currentItems.length > 0 && currentItems[0].cat === 6) return true;
        return (state.type.indexOf('trade_') !== -1 || state.type.indexOf('ship_') !== -1);
    })();

    var SHOP_NAV = "\n\nâ†©ï¸ ë’¤ë¡œ / ğŸ  ì²˜ìŒìœ¼ë¡œ / âì·¨ì†Œ";

    if (msg === "ì²˜ìŒìœ¼ë¡œ" || msg === "ğŸ  ì²˜ìŒìœ¼ë¡œ") {
        delete bankProcessState[targetUid];
        // ë¬´ì—­ íë¦„ì´ë©´ ë¬´ì—­ ë©”ì¸ìœ¼ë¡œ, ì•„ë‹ˆë©´ ì¼ë°˜ ìƒì  ë©”ì¸ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        if (isTradeFlow) return _gameTradeLogic("/ë¬´ì—­", user, data, replier, roomName, targetUid);
        return _gameShopLogic("/ìƒì ", user, data, replier, roomName, targetUid);
    }

    if (msg === "ì·¨ì†Œ" || msg === "âì·¨ì†Œ") {
        delete bankProcessState[targetUid];
        replier.reply(formatCommand("ğŸš« ì‘ì—… ì·¨ì†Œ", user, isTradeFlow ? "ë¬´ì—­ ì—…ë¬´ë¥¼ ì¤‘ë‹¨í–ˆìŠµë‹ˆë‹¤." : "ìƒì  ì´ìš©ì„ ì¢…ë£Œí•©ë‹ˆë‹¤."));
        return true;
    }

    if (msg === "ë’¤ë¡œ" || msg === "â†©ï¸ ë’¤ë¡œ") {
        // [3ë‹¨ê³„ -> 2ë‹¨ê³„] ìˆ˜ëŸ‰ ì…ë ¥ ì¤‘ í’ˆëª© ì„ íƒ ëª©ë¡ìœ¼ë¡œ ë³µê·€
        if (state.type === 'shop_quantity') {
            var prevItems = state.extra.prevItems || [];
            bankProcessState[targetUid] = { type: 'shop_buy', time: Date.now(), extra: { items: prevItems } };
            var list = prevItems.map(function(it, i) { return (i + 1) + ". " + it.icon + " " + it.name + " : " + fp(getItemPrice(it, user, roomName)) + "P"; });
            var title = isTradeFlow ? "ë¬´ì—­ ë¬¼í’ˆ ì ì¬ ì„¼í„°" : (SHOP_CATEGORIES[state.extra.item.cat] || "ìƒì ");
            replier.reply(formatCommand("ğŸ›’ " + title, user, list.join("\n") + SHOP_NAV, "êµ¬ë§¤í•  ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
        } 

        // ì´ë¦„ ì…ë ¥ ë‹¨ê³„ì—ì„œ 'ë’¤ë¡œ' ì…ë ¥ ì‹œ ë¬´ì—­ ë¬¼í’ˆ ëª©ë¡ìœ¼ë¡œ ë³µê·€í•˜ëŠ” ë¡œì§ ì‚½ì…
        else if (state.type === 'ship_rename_input') {
            var tradeItems = state.extra.prevItems || SHOP_ITEMS.filter(function(it){ return it.cat === 6; });
            bankProcessState[targetUid] = { type: 'shop_buy', time: Date.now(), extra: { items: tradeItems } };
            var list = tradeItems.map(function(it, i) { return (i + 1) + ". " + it.icon + " " + it.name + " : " + fp(getItemPrice(it, user, roomName)) + "P"; });
            replier.reply(formatCommand("ğŸ›’ ë¬´ì—­ ë¬¼í’ˆ ì ì¬ ì„¼í„°", user, list.join("\n") + SHOP_NAV, "êµ¬ë§¤í•  ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
        }

        // [íŠ¹ìˆ˜ ë‹¨ê³„] ì„ ë°• ì´ë¦„ í™•ì • -> ì…ë ¥ ë‹¨ê³„ë¡œ ë³µê·€
        else if (state.type === 'ship_rename_confirm') {
            bankProcessState[targetUid] = { type: 'ship_rename_input', time: Date.now(), extra: state.extra };
            replier.reply(formatCommand("ğŸ“ ì„ ë°• ì´ë¦„ ì…ë ¥", user, "ë³€ê²½í•˜ì‹¤ ì„ ë°•ì˜ ì´ë¦„ì„ ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”." + SHOP_NAV));
        } 
        // [2ë‹¨ê³„ -> 1ë‹¨ê³„] í’ˆëª© ëª©ë¡ -> ê° ì‹œìŠ¤í…œ ë©”ì¸ ë©”ë‰´ë¡œ ë³µê·€
        else {
            delete bankProcessState[targetUid];
            if (isTradeFlow) return _gameTradeLogic("/ë¬´ì—­", user, data, replier, roomName, targetUid);
            return _gameShopLogic("/ìƒì ", user, data, replier, roomName, targetUid);
        }
        return true;
    }

    // 2. ì„ ë°• ì´ë¦„ ì…ë ¥ ì²˜ë¦¬ (ë„ì–´ì“°ê¸° ìˆ˜ìš© ë° í™•ì¸ ë‹¨ê³„ë¡œ ì´ë™)
    if (state.type === 'ship_rename_input') {
        var inputName = msg.trim(); // ì•ë’¤ ê³µë°±ë§Œ ì œê±°í•˜ì—¬ ì¤‘ê°„ ë„ì–´ì“°ê¸° ë³´ì¡´
        if (inputName.length < 2 || inputName.length > 8) {
            replier.reply(formatError(user, "ì´ë¦„ ê¸¸ì´ ì˜¤ë¥˜", "2~8ê¸€ì ì‚¬ì´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”." + SHOP_NAV));
            return true;
        }
        if (!/^[a-zA-Z0-9ê°€-í£\s]+$/.test(inputName)) {
            replier.reply(formatError(user, "ì‚¬ìš© ë¶ˆê°€ ë¬¸ì", "íŠ¹ìˆ˜ë¬¸ìëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤." + SHOP_NAV));
            return true;
        }
        
        // [ìˆ˜ì •] ì¤‘ë³µ ì²´í¬ ì‹œ, í˜„ì¬ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•œ ìœ ì €(targetUid)ëŠ” ê²€ì‚¬ ëŒ€ìƒì—ì„œ ì œì™¸
        var isDup = false;
        for (var r in data.rooms) { 
            for (var uId in data.rooms[r].users) { 
                // ì´ë¦„ì´ ê°™ì§€ë§Œ, UIDê°€ ë‹¤ë¥¸ 'íƒ€ì¸'ì´ ì“°ê³  ìˆì„ ë•Œë§Œ ì¤‘ë³µìœ¼ë¡œ íŒì •
                if (data.rooms[r].users[uId].shipName === inputName && uId !== targetUid) { 
                    isDup = true; 
                    break; 
                } 
            } 
            if (isDup) break; 
        }
        if (isDup) { replier.reply(formatError(user, "ì´ë¦„ ì¤‘ë³µ", "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë¦„ì…ë‹ˆë‹¤." + SHOP_NAV)); return true; }

        // í™•ì¸ ë‹¨ê³„(Confirm) ìƒíƒœë¡œ ì „ì´
        bankProcessState[targetUid] = { 
            type: 'ship_rename_confirm', 
            time: Date.now(), 
            extra: { newName: inputName, price: state.extra.price } 
        };
        
        var confirmMsg = "ìƒˆë¡œìš´ ì„ ë°• ì´ë¦„: [" + inputName + "]\n\nì´ ì´ë¦„ìœ¼ë¡œ ìµœì¢… ê²°ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê²°ì • ì‹œ ì´ë¦„ë³€ê²½ê¶Œì´ ì¦‰ì‹œ ì‚¬ìš©ë©ë‹ˆë‹¤.\n\n1. ì˜ˆ (ë³€ê²½ ìŠ¹ì¸)\n2. ì•„ë‹ˆì˜¤ (ì¬ì…ë ¥)" + SHOP_NAV;
        replier.reply(formatCommand("âš“ ì„ ë°• ëª…ëª… í™•ì¸", user, confirmMsg, "ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”."));
        return true;
    }

    // 3. ì„ ë°• ì´ë¦„ ìµœì¢… í™•ì • (ë¡œì§ ì¢…ë£Œ ì§€ì  - ëŒ€ê¸° ì‚­ì œ ë° ë„¤ë¹„ê²Œì´ì…˜ ì œê±°)
    if (state.type === 'ship_rename_confirm') {
        if (msg === "1" || msg === "ì˜ˆ") {
            var finalName = state.extra.newName;
            var cost = state.extra.price || 0;
            
            // [ì¢…ë£Œ ì²˜ë¦¬] ê²°ì œ ì§ì „ ëŒ€ê¸°ì—´ì„ ë¨¼ì € ì‚­ì œí•˜ì—¬ ì¤‘ë³µ ì…ë ¥ì„ ì°¨ë‹¨í•©ë‹ˆë‹¤.
            delete bankProcessState[targetUid];

            if (Number(user.point) < cost) {
                replier.reply(formatError(user, "ê²°ì œ ì‹¤íŒ¨", "ì”ì•¡ì´ ë¶€ì¡±í•˜ì—¬ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."));
                return true;
            }
            
            util_updatePoint(user, data.rooms[roomName], -cost, "ì„ ë°• ì´ë¦„ ë³€ê²½ê¶Œ ì‚¬ìš©", roomName);
            user.shipName = finalName;
            
            // [ì™„ë£Œ ë©”ì‹œì§€] ëë‚˜ëŠ” ì§€ì ì´ë¯€ë¡œ SHOP_NAV ì—†ì´ ê¹”ë”í•˜ê²Œ ì¶œë ¥
            replier.reply(formatCommand("ğŸš¢ ì„ ë°• ëª…ëª…ì‹ ì™„ë£Œ", user, "ì„±ê³µì ìœ¼ë¡œ [" + finalName + "](ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!", "ë¬´ì—­ í˜„í™©: [/ë¬´ì—­]"));
            safeSaveData(data);
        return true; // ë¡œì§ ì¢…ë£Œ ëª…ì‹œ
        } else if (msg === "2" || msg === "ì•„ë‹ˆì˜¤") {
            bankProcessState[targetUid] = { type: 'ship_rename_input', time: Date.now(), extra: state.extra };
            replier.reply(formatCommand("ğŸ“ ì„ ë°• ì´ë¦„ ì…ë ¥", user, "ë³€ê²½í•˜ì‹¤ ì´ë¦„ì„ ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”." + SHOP_NAV));
            return true; // ë¡œì§ ì¢…ë£Œ ëª…ì‹œ
        }
        return true;
    }
    if (msg.startsWith("/")) {
        delete bankProcessState[targetUid];
        return false;
    }

    var roomData = data.rooms[roomName];

    /**
     * [ê¸°ëŠ¥] í•­êµ¬ íˆ¬ì ê¸ˆì•¡ ì²˜ë¦¬ (ì‹œê°„ ë° ì¤‘ë³µ ì´ë… ê²€ì¦)
     */
    if (state.type === 'trade_invest_amount') {
        var amt = parseInt(msg.replace(/,/g, ""));
        var dest = state.extra.dest;
        var cfg = SYSTEM_CONFIG.TRADE.INVEST;

        if (isNaN(amt) || amt <= 0) {
            replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜", "íˆ¬ìí•  ê¸ˆì•¡ì„ ìˆ«ìë¡œ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”."));
            return true;
        }

        // [ë³µêµ¬] íˆ¬ì ê°€ëŠ¥ ì‹œê°„ ê²€ì¦ (07:00 ~ 23:59)
        var h = new Date().getHours();
        if (h < cfg.OPEN_HOUR) {
            delete bankProcessState[targetUid];
            replier.reply(formatError(user, "íˆ¬ì ë¶ˆê°€ ì‹œê°„", "í˜„ì¬ í•­ë§Œì´ íì‡„ë˜ì—ˆìŠµë‹ˆë‹¤. ì˜¤ì „ 07ì‹œ ì´í›„ì— ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."));
            return true;
        }

        if (Number(user.point) < amt) {
            replier.reply(formatError(user, "ì”ì•¡ ë¶€ì¡±", "ë³´ìœ  í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."));
            return true;
        }

        // ê¸°ì¡´ ì´ë… ë³´ìœ  í˜„í™© í™•ì¸
        var myGovernedPorts = util_getUserGovernorPorts(targetUid, roomData);

        // [ê²½ê³  ê°€ë“œ]: ì´ë¯¸ íƒ€êµ­ ì´ë…ì¸ ê²½ìš° ì„ íƒì§€ë¡œ ë¶„ê¸°
        if (myGovernedPorts.length > 0 && myGovernedPorts.indexOf(dest) === -1) {
            bankProcessState[targetUid] = {
                type: 'trade_invest_confirm',
                time: Date.now(),
                extra: { dest: dest, amount: amt, oldPorts: myGovernedPorts }
            };

            var warnMsg = "âš ï¸ [ì´ë… ì§ìœ„ ì´ì „ ê²½ê³ ]\n" +
                          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                          "í˜„ì¬ ì˜ì›ë‹˜ì€ [" + myGovernedPorts.join(", ") + "]ì˜ ì´ë…ì…ë‹ˆë‹¤.\n\n" +
                          "ìì¹˜ë ¹ì´ ì•„ë‹Œ '" + dest + "' í•­êµ¬ì— íˆ¬ìë¥¼ ì§„í–‰í•  ê²½ìš°,\n" +
                          "í˜„ì¬ íˆ¬ìê°€ ì™„ë£Œë˜ë©´ ê¸°ì¡´ ì´ë…ë„ì‹œëŠ” ì´ˆê¸°í™” ë©ë‹ˆë‹¤.\n\n" +
                          "ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n" +
                          "1. íˆ¬ì ì§„í–‰ (ê¸°ì¡´ ì§€ìœ„ í¬ê¸°)\n" +
                          "2. íˆ¬ì ì·¨ì†Œ (í˜„ìƒ ìœ ì§€)";

            replier.reply(formatCommand("ğŸ—ï¸ íˆ¬ì í™•ì¸", user, warnMsg, "ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
            return true;
        }

        // ì´ë…ì´ ì•„ë‹ˆê±°ë‚˜ ë³¸ì¸ ë„ì‹œë¼ë©´ ì¦‰ì‹œ ìµœì¢… ì²˜ë¦¬
        _finalizeHarborInvestment(user, data, replier, roomName, targetUid, dest, amt, myGovernedPorts);
        return true;
    }

    /**
     * [ì‹ ê·œ] íˆ¬ì í™•ì • ì„ íƒì§€ ì²˜ë¦¬ í•¸ë“¤ëŸ¬
     */
    if (state.type === 'trade_invest_confirm') {
        var choice = msg.trim();
        var info = state.extra;

        if (choice === "1") {
            _finalizeHarborInvestment(user, data, replier, roomName, targetUid, info.dest, info.amount, info.oldPorts);
        } else if (choice === "2" || choice === "ì·¨ì†Œ") {
            delete bankProcessState[targetUid];
            replier.reply(formatCommand("ğŸš« íˆ¬ì ì·¨ì†Œ", user, "ê¸°ì¡´ ì´ë… ì§ìœ„ë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•´ íˆ¬ìë¥¼ ì¤‘ë‹¨í–ˆìŠµë‹ˆë‹¤."));
        } else {
            replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "1ë²ˆ(ì§„í–‰) ë˜ëŠ” 2ë²ˆ(ì·¨ì†Œ)ì„ ì„ íƒí•˜ì„¸ìš”."));
        }
        return true;
    }

    /* [ê¸°ëŠ¥ 1] ìƒì  ì•„ì´í…œ ë²ˆí˜¸ ì„ íƒ ì²˜ë¦¬ */
    if (state.type === 'shop_buy') {
        var idx = parseInt(msg.replace(/[^0-9]/g, "")) - 1;
        var filteredItems = (state.extra && state.extra.items) ? state.extra.items : [];

        if (isNaN(idx) || idx < 0 || idx >= filteredItems.length) {
            replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "ëª©ë¡ì— ìˆëŠ” ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”." + SHOP_NAV));
        } else {
            var item = filteredItems[idx];

            /* ì˜ˆì™¸ ì²˜ë¦¬ 1: ì‹ ìš© ì ìˆ˜ íšŒë³µì œ ì¼ì¼ ì œí•œ */
            if (item.effect === "credit" && (user.dailyCreditRestoreCount || 0) >= 1) {
                delete bankProcessState[targetUid];
                replier.reply(formatError(user, "êµ¬ë§¤ ì œí•œ", "ì‹ ìš© ì ìˆ˜ íšŒë³µì œëŠ” í•˜ë£¨ì— 1ê°œë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤."));
                return true;
            }

            /* ì˜ˆì™¸ ì²˜ë¦¬ 2: ê²½ê³ ì‚­ì œê¶Œ ì œí•œ ë¡œì§ (í‰ìƒ 1íšŒ + ì‚¬ì±„ ë³´ìœ  ì‹œ ë¶ˆê°€) */
            if (item.effect === "warnClear") {
                if (user.boughtWarningRemoval === true) {
                    delete bankProcessState[targetUid];
                    replier.reply(formatError(user, "êµ¬ë§¤ ë¶ˆê°€", "ê²½ê³ ì‚­ì œê¶Œì€ í‰ìƒ ë‹¨ 1íšŒë§Œ êµ¬ë§¤ ê°€ëŠ¥í•©ë‹ˆë‹¤."));
                    return true;
                }
                var hasSache = false;
                if (roomData.loanContracts) {
                    for (var cid in roomData.loanContracts) {
                        if (roomData.loanContracts[cid].borrowerUid === targetUid) { hasSache = true; break; }
                    }
                }
                if (hasSache) {
                    delete bankProcessState[targetUid];
                    replier.reply(formatError(user, "êµ¬ë§¤ ì œí•œ", "ì‚¬ì±„ë¥¼ ëª¨ë‘ ìƒí™˜í•œ í›„ì—ë§Œ êµ¬ë§¤ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤."));
                    return true;
                }
            }

            /* ì˜ˆì™¸ ì²˜ë¦¬ 3: ê²Œì„ ì¸ì¦ê¶Œ ì‹œì¦Œ 2íšŒ ì œí•œ */
            if (item.effect === "gameAuth" && (user.purchasedAuthCount || 0) >= 2) {
                delete bankProcessState[targetUid];
                replier.reply(formatError(user, "êµ¬ë§¤ í•œë„ ì´ˆê³¼", "ì¸ì¦ê¶Œì€ ì‹œì¦Œë‹¹ ìµœëŒ€ 2íšŒê¹Œì§€ë§Œ êµ¬ë§¤ ê°€ëŠ¥í•©ë‹ˆë‹¤."));
                return true;
            }

            // ìˆ˜ëŸ‰ ì…ë ¥ ë‹¨ê³„ë¡œ ì „í™˜ ì‹œ í˜„ì¬ ì•„ì´í…œ ëª©ë¡ì„ ì €ì¥(ë’¤ë¡œê°€ê¸°ìš©)
            if (["promotion", "tierGuard", "randomBox", "spitto", "trade_cargo"].indexOf(item.effect) !== -1) {
                var itemPrice = getItemPrice(item, user, roomName); 
                var discountTag = (user.title === "ìˆ˜ì§‘ëŒ€ë§ˆì™•") ? " ğŸµï¸ìˆ˜ì§‘ëŒ€ë§ˆì™• í˜œíƒ(15%í• ì¸)" : "";

                // [ì¶”ê°€] ë¬´ì—­ ë¬¼í’ˆì¼ ê²½ìš°ì—ë§Œ ì„ ì  í˜„í™© ê³„ì‚° (ì‚­ì œ ê¸ˆì§€, ì¶”ê°€ë§Œ í•˜ì„¸ìš”)
                var cargoStatusLine = "";
                if (item.effect === "trade_cargo") {
                    var tradeCfg = SYSTEM_CONFIG.TRADE;
                    var shipCfg = tradeCfg.SHIPS[user.shipLevel || 1];
                    var totalCap = shipCfg.capacity + (user.enhLimit || 0); 
                    var currentCount = 0;
                    for (var k in (user.cargo || {})) currentCount += Number(user.cargo[k] || 0);
                    cargoStatusLine = "ğŸ“¦ í˜„ì¬: " + currentCount + " / " + totalCap + "ì¹¸\n";
                }

                // [ìœ ì§€] ì´ ì„¸ì…˜ ì €ì¥ ì½”ë“œê°€ ìˆì–´ì•¼ ìˆ«ìë¥¼ ì…ë ¥ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                bankProcessState[targetUid] = { 
                    type: 'shop_quantity', 
                    time: Date.now(), 
                    extra: { item: item, prevItems: filteredItems } 
                };
                
                // [ìˆ˜ì •] ìœ„ì—ì„œ ê³„ì‚°í•œ cargoStatusLineì„ ì •ë³´ì°½ì— í¬í•¨
                var quantityInfo = "êµ¬ë§¤í•˜ì‹¤ [" + item.name + "]ì˜ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n\n" +
                                   cargoStatusLine +
                                   "ğŸ’µ ê°œë‹¹ ê°€ê²©: " + fp(itemPrice) + "P" + discountTag + "\n" +
                                   "ğŸ’° ë³´ìœ  í¬ì¸íŠ¸: " + fp(user.point) + "P" + SHOP_NAV;

                replier.reply(formatCommand("ğŸ”¢ ìˆ˜ëŸ‰ ì…ë ¥", user, quantityInfo, "ì·¨ì†Œ: [ì·¨ì†Œ]"));
            } else {
                /* ë‹¨ê¶Œ êµ¬ë§¤ ë¡œì§ */
                var finalPrice = getItemPrice(item, user, roomName);
                var isUsingTicket = (item.effect === "randomBox" && (user.boxTickets || 0) > 0);

                if (!isUsingTicket && Number(user.point) < finalPrice) {
                    delete bankProcessState[targetUid];
                    replier.reply(formatError(user, "í¬ì¸íŠ¸ ë¶€ì¡±", fp(finalPrice) + "Pê°€ í•„ìš”í•©ë‹ˆë‹¤."));
                } else {
                    var hasItem = false;
                    if (item.effect === "icon" || item.effect === "title") {
                        var inv = user.inventory || [];
                        for (var i = 0; i < inv.length; i++) { if (inv[i].id === item.id) { hasItem = true; break; } }
                    }

                    if (hasItem) {
                        delete bankProcessState[targetUid];
                        replier.reply(formatError(user, "ì¤‘ë³µ ì†Œìœ ", "ì´ë¯¸ ë³´ìœ  ì¤‘ì¸ ì•„ì´í…œì…ë‹ˆë‹¤."));
                    } else {
                        var isDelayedBilling = (item.effect === "ship_rename");

                       if (!isUsingTicket && !isDelayedBilling) {
                            util_updatePoint(user, roomData, -finalPrice, "ìƒì  êµ¬ë§¤: " + item.name, roomName);
                        }
                        delete bankProcessState[targetUid];
                        if (typeof _handleShopEffect === 'function') _handleShopEffect(item, user, roomName, replier, data, targetUid, finalPrice, isUsingTicket, 1);
                    }
                }
            }
            return true;
        }
    }

    /* [ê¸°ëŠ¥ 2] ìˆ˜ëŸ‰ ì…ë ¥ ì²˜ë¦¬ (ë¡œì§ ì¢…ë£Œ ì§€ì ) */
    else if (state.type === 'shop_quantity') {
        var item = (state.extra && state.extra.item) ? state.extra.item : null;
        if (!item) { delete bankProcessState[targetUid]; return true; }

        var qty = parseInt(msg.replace(/[^0-9]/g, ""));
        if (isNaN(qty) || qty <= 0) {
            // ë‹¤ì‹œ ì…ë ¥ì„ ê¸°ë‹¤ë¦¬ëŠ” êµ¬ê°„ì€ ë‚´ë¹„ê²Œì´ì…˜ ë°” í¬í•¨
            replier.reply(formatError(user, "ì…ë ¥ ì˜¤ë¥˜", "ìˆ«ìë¡œ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." + SHOP_NAV));
        } else {
            var multiplier = util_getEcoMultiplier(roomName);
            var basePrice = Math.floor(Number(item.price) * multiplier);
            if (user.title === "ìˆ˜ì§‘ëŒ€ë§ˆì™•") basePrice = Math.floor(basePrice * 0.85);
            
            var totalPrice = 0;

            if (item.id === 8) { 
                var count = Number(user.purchasedPromotionAttempts || 0);
                var d = Math.floor(basePrice * 0.10); // í• ì¦ ë‹¨ìœ„ (10%)
                
                // ë“±ì°¨ìˆ˜ì—´ì˜ í•© ê³µì‹: Sn = n/2 * [2a + (n-1)d]
                // a = í˜„ì¬ ì‚´ ìˆ˜ ìˆëŠ” ì²« ë²ˆì§¸ ìœ ë‹›ì˜ ê°€ê²©
                var a = basePrice + (d * count);
                totalPrice = Math.round((qty / 2) * (2 * a + (qty - 1) * d));
            } else {
                totalPrice = getItemPrice(item, user, roomName) * qty; 
            }

            if (Number(user.point) < totalPrice) {

                replier.reply(formatError(user, "í¬ì¸íŠ¸ ë¶€ì¡±", "ì´ " + fp(totalPrice) + "Pê°€ í•„ìš”í•©ë‹ˆë‹¤." + SHOP_NAV));
            } else {
                // [ì¢…ë£Œ ì²˜ë¦¬] ê²°ì œê°€ ì„±ê³µí–ˆìœ¼ë¯€ë¡œ ëŒ€ê¸° ìƒíƒœë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.
                delete bankProcessState[targetUid]; 

                if (item.effect !== "trade_cargo") {
                    util_updatePoint(user, roomData, -totalPrice, "ìƒì  êµ¬ë§¤: " + item.name + " x" + qty, roomName);
                }
                
                // ìµœì¢… íš¨ê³¼ ë°œë™ (ë©”ì‹œì§€ëŠ” ì„¹í„° 30ì—ì„œ ë„¤ë¹„ê²Œì´ì…˜ ì—†ì´ ì¶œë ¥ë¨)
                if (typeof _handleShopEffect === 'function') {
                    _handleShopEffect(item, user, roomName, replier, data, targetUid, totalPrice, false, qty);
                }
                return true;
            }
        }
        return true;
    }
    return false;
}

// ì¶”ê°€: ì„¹í„° 22-5 ìµœí•˜ë‹¨(í•¨ìˆ˜ ì™¸ë¶€)ì— íˆ¬ì ì •ì‚° ì—”ì§„ ë°°ì¹˜
/**
 * [ì‹œìŠ¤í…œ] í•­êµ¬ íˆ¬ì ë° ì´ë…ì§€ ì´ˆê¸°í™” ìµœì¢… ì²˜ë¦¬ ì—”ì§„
 */
function _finalizeHarborInvestment(user, data, replier, roomName, targetUid, dest, amt, oldPorts) {
    var roomData = data.rooms[roomName];
    var pData = roomData.features.portData[dest];
    var cfg = SYSTEM_CONFIG.TRADE.INVEST;
    var oldGovUid = pData.governorUid;
    var oldLevel = pData.level;
    var bankProcessState = roomData.features.states.bankProcess;

    if (bankProcessState && bankProcessState[targetUid]) delete bankProcessState[targetUid];

    // 1. í¬ì¸íŠ¸ ê²Œì´íŠ¸ì›¨ì´ ì •ì‚°
    util_updatePoint(user, roomData, -amt, "í•­êµ¬ íˆ¬ì: " + dest, roomName);

    // 2. íˆ¬ìì•¡ ë° ë ˆë²¨ ë°˜ì˜
    if (!pData.userInvests) pData.userInvests = {};
    pData.userInvests[targetUid] = (pData.userInvests[targetUid] || 0) + amt;
    pData.totalInvest += amt;
    pData.level = Math.min(cfg.MAX_LEVEL, Math.floor(pData.totalInvest / cfg.LEVEL_UP_STEP) + 1);

    // 3. [í•µì‹¬] ì´ë… êµì²´ ë° ê¸°ì¡´ ë„ì‹œ ì´ˆê¸°í™” (í›„ìˆœìœ„ ìš°ì„ )
    var isGovChanged = false;
    var govReason = "";
    var currentMaxInvest = (oldGovUid && pData.userInvests[oldGovUid]) ? pData.userInvests[oldGovUid] : 0;

    if (pData.userInvests[targetUid] > currentMaxInvest) {
        if (oldPorts && oldPorts.length > 0) {
            oldPorts.forEach(function(pName) {
                if (roomData.features.portData[pName]) {
                    roomData.features.portData[pName].governorUid = ""; 
                }
            });
            govReason = "\n\nâœ¨ [ì§ìœ„ ì´ì „]\nê¸°ì¡´ í•­êµ¬ì˜ ì´ë…ì§ì„ ì‚¬ì„í•˜ê³ \nìƒˆë¡œìš´ ìì¹˜ë ¹ '" + dest + "'ì˜ ì´ë…ìœ¼ë¡œ ë¶€ì„í–ˆìŠµë‹ˆë‹¤!";
        }
        pData.governorUid = targetUid;
        if (oldGovUid !== targetUid) isGovChanged = true;
    }

    var resMsg = dest + " í•­êµ¬ì— " + fp(amt) + "Pë¥¼ íˆ¬ìí–ˆìŠµë‹ˆë‹¤!\n\n" +
                 "ğŸ“Š " + dest + " ë°œì „ë„: Lv." + oldLevel + " â” Lv." + pData.level + "\n" +
                 "ğŸ“ˆ ì„ í˜¸í’ˆ ë§¤ì… ë³´ë„ˆìŠ¤: +" + (pData.level - 1) + "%" + govReason;

    if (isGovChanged && govReason === "") {
        var oldName = (oldGovUid && roomData.users[oldGovUid]) ? roomData.users[oldGovUid].name : "ê³µì„";
        resMsg += "\n\nğŸŠ [ì‘ìœ„ ìˆ˜ì—¬]\n" + user.name + "ë‹˜ì´ " + oldName + "ì„ ë°€ì–´ë‚´ê³ \n" + dest + "ì˜ ìƒˆë¡œìš´ [ì´ë…]ì´ ë˜ì—ˆìŠµë‹ˆë‹¤!";
    }

    replier.reply(formatCommand("ğŸ—ï¸ í•­êµ¬ íˆ¬ì ì™„ë£Œ", user, resMsg, "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
    user.skipHealing = true;
    safeSaveData(data, true);
}

//==========ì„¹í„°23-1==========

/* [ë…ë¦½í˜• í•¨ìˆ˜] ë©”ë‰´ ì„ íƒ ëŒ€ê¸° ì²˜ë¦¬ 1ë‹¨ê³„ (ë©”ì¸ ë©”ë‰´ ë¶„ê¸°) */
function _handleMenuStep1(msg, user, data, replier, roomName, targetUid) {
    var menuWaitState = data.rooms[roomName].features.states.menuWait;
    if (!menuWaitState || !menuWaitState[targetUid]) return false;

    var state = menuWaitState[targetUid];
    var now = Date.now();

    // 1. [ì‹œê°„ ì´ˆê³¼ ì²´í¬] 30ì´ˆ í†µì¼
    if (now - state.time > 30000) {
        delete menuWaitState[targetUid];
        replier.reply(formatError(user, "ì…ë ¥ ì‹œê°„ ì´ˆê³¼", "30ì´ˆ ì´ë‚´ì— ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì§€ ì•Šì•„ ë©”ë‰´ê°€ ë‹«í˜”ìŠµë‹ˆë‹¤."));
        return true;
    }

    // 2. ì·¨ì†Œ ì…ë ¥ ì‹œ ì²˜ë¦¬
    if (msg === "ì·¨ì†Œ") {
        delete menuWaitState[targetUid];
        replier.reply(formatCommand("ğŸš« ë©”ë‰´ ì„ íƒ ì·¨ì†Œ", user, "ì‘ì—…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    // 3. [ëª…ë ¹ì–´ ê°€ë“œ] ëª…ë ¹ì–´(/) ì…ë ¥ ì‹œ ëŒ€ê¸° ìƒíƒœë¥¼ ìœ ì§€í•˜ë˜, ì²˜ë¦¬ëŠ” í•˜ìœ„ ë¡œì§ì— ìœ„ì„
    if (msg.startsWith("/")) {
        return false;
    }

    var roomData = data.rooms[roomName];
    // ì¤‘ì•™ì€í–‰ ì¬ì› ì´ˆê¸°í™” (UI ì¶œë ¥ìš©)
    if (roomData.bankReserve === undefined) roomData.bankReserve = SYSTEM_CONFIG.ECO.BANK.INITIAL_RESERVE;

    var choice = msg.trim();
    var bankProcessState = roomData.features.states.bankProcess; // ìƒíƒœê°’ í• ë‹¹ì„ ìœ„í•´ ì°¸ì¡°

    /* [1ë‹¨ê³„] ì€í–‰ ë©”ì¸ ë©”ë‰´ ì„ íƒ ì²˜ë¦¬ (v5.2 ê¸°ë¶€ ì„ íƒ ì¶”ê°€) */
    if (state.type === 'bank_menu') {
        delete menuWaitState[targetUid]; // ë©”ë‰´ ì„ íƒ ì™„ë£Œ ì‹œ ëŒ€ê¸° ìƒíƒœ í•´ì œ

        if (choice === "1") {
            bankProcessState[targetUid] = { type: 'deposit', time: Date.now() };
            replier.reply(formatCommand("ğŸ’° ì˜ˆê¸ˆ ì§„í–‰", user, "ì˜ˆê¸ˆí•  ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(ë³´ìœ : " + fp(user.point) + "P)", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
        } else if (choice === "2") {
            bankProcessState[targetUid] = { type: 'withdraw', time: Date.now() };
            replier.reply(formatCommand("ğŸ§ ì¶œê¸ˆ ì§„í–‰", user, "ì¶œê¸ˆí•  ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(ì”ê³ : " + fp(user.bank) + "P)", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
        } else if (choice === "3") {
            bankProcessState[targetUid] = { type: 'transfer', time: Date.now() };
            replier.reply(formatCommand("ğŸ’¸ ì†¡ê¸ˆ ì§„í–‰", user, "ë°›ì„ ì‚¬ëŒì˜ [ë‹‰ë„¤ì„]ê³¼ [ê¸ˆì•¡]ì„ ë„ì–´ì“°ê¸°ë¡œ ì…ë ¥í•˜ì„¸ìš”.\n(ì˜ˆ: í™ê¸¸ë™ 5000)", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
        } else if (choice === "4") {
            var cr = getCreditInfo(user.creditScore);
            if (cr.limit <= 0) {
                replier.reply(formatError(user, "ëŒ€ì¶œ ë¶ˆê°€", "ì‹ ìš©ë“±ê¸‰ì´ ë„ˆë¬´ ë‚®ìŠµë‹ˆë‹¤."));
            } else {
                bankProcessState[targetUid] = { type: 'loan', time: Date.now() };
                var loanMsg = "í¬ë§ ëŒ€ì¶œê¸ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n" +
                              "ë‚´ í•œë„: " + fp(cr.limit) + "P (ì´ìœ¨: " + ((cr.rate - 1) * 100).toFixed(0) + "%)\n" +
                              "ğŸ¦ ì€í–‰ ê°€ìš© ì¬ì›: " + fp(roomData.bankReserve) + "P";
                replier.reply(formatCommand("ğŸ¦ ëŒ€ì¶œ ì§„í–‰", user, loanMsg, "ì·¨ì†Œ: [ì·¨ì†Œ]"));
            }
        } else if (choice === "5") {
            if (!user.loan || user.loan.debt <= 0) {
                replier.reply(formatError(user, "ìƒí™˜ ë¶ˆê°€", "ê°šì„ ëŒ€ì¶œê¸ˆì´ ì—†ìŠµë‹ˆë‹¤."));
            } else {
                bankProcessState[targetUid] = { type: 'repay', time: Date.now() };
                replier.reply(formatCommand("ğŸ“‰ ìƒí™˜ ì§„í–‰", user, "ìƒí™˜í•  ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(ëŒ€ì¶œ ì”ì•¡: " + fp(user.loan.debt) + "P)\në³´ìœ  í¬ì¸íŠ¸: " + fp(user.point) + "P", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
            }
        } else if (choice === "6") {
            // [ì¤‘ìš”] ì‚¬ì±„ ë©”ë‰´ ì„ íƒ ì‹œì—ëŠ” bankProcessê°€ ì•„ë‹Œ menuWaitStateë¥¼ ê°±ì‹ í•´ì•¼ í•¨ (ì„œë¸Œ ë©”ë‰´ ì´ë™)
            menuWaitState[targetUid] = { type: 'p2p_loan_menu', time: Date.now() };
            var p2pMenu = "1. ğŸ’° ì‚¬ì±„ ë“±ë¡ (ë§¤ë¬¼ ì˜¬ë¦¬ê¸°)\n" +
                          "2. ğŸ“‹ ì‚¬ì±„ ëª©ë¡ (ë¶„í•  ëŒ€ì¶œ ë°›ê¸°)\n" +
                          "3. ğŸ“‰ ì‚¬ì±„ ìƒí™˜ (ë¹Œë¦° ëˆ ê°šê¸°)\n" +
                          "4. ğŸ“¥ ì‚¬ì±„ íšŒìˆ˜ (ë“±ë¡ ë§¤ë¬¼ íšŒìˆ˜)\n" +
                          "5. ğŸ‘¥ ë‚´ ì±„ë¬´ì í˜„í™© (ì§ì ‘ ìˆ˜ê±° ê°€ëŠ¥)";
            replier.reply(formatCommand("ğŸš¬ ì‚¬ì±„ ì‹œì¥ ì—…ë¬´ ì„ íƒ", user, p2pMenu, "ì›í•˜ì‹œëŠ” ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
            return true; // ì—¬ê¸°ì„œ true ë°˜í™˜í•˜ì—¬ ì¢…ë£Œ (ë‹¤ìŒ ë¡œì§ ìˆ˜í–‰ X)
        } else if (choice === "7") {
            bankProcessState[targetUid] = { type: 'donate', time: Date.now() };
            replier.reply(formatCommand("ğŸ ê¸°ë¶€ ì§„í–‰", user, "ê¸°ë¶€í•  ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(ë³´ìœ : " + fp(user.point) + "P)", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
        } else {
            // ì˜ëª»ëœ ë²ˆí˜¸ ì…ë ¥ ì‹œ ë‹¤ì‹œ ë©”ë‰´ ëŒ€ê¸° ìƒíƒœë¡œ ë³µêµ¬? 
            // ê¸°íš ì˜ë„ìƒ ë©”ë‰´ê°€ ë‹«íˆëŠ” ê²Œ ì¼ë°˜ì ì´ë¯€ë¡œ ì—ëŸ¬ ë©”ì‹œì§€ í›„ ì¢…ë£Œ ì²˜ë¦¬
            replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "ì˜¬ë°”ë¥¸ ë©”ë‰´ ë²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."));
        }
        return true;
    }
    return false; // ì´ í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬í•˜ì§€ ì•Šì€ state.typeì¸ ê²½ìš° (ì˜ˆ: p2p_loan_menu ë“±)
}

//==========ì„¹í„°23-2==========

/* [ë…ë¦½í˜• í•¨ìˆ˜] ë©”ë‰´ ì„ íƒ ëŒ€ê¸° ì²˜ë¦¬ 2ë‹¨ê³„ (ì‚¬ì±„ ì‹œì¥ ì„œë¸Œ ë©”ë‰´) */
function _handleMenuStep2(msg, user, data, replier, roomName, targetUid) {
    var menuWaitState = data.rooms[roomName].features.states.menuWait;
    if (!menuWaitState || !menuWaitState[targetUid]) return false;

    var state = menuWaitState[targetUid];
    // ì´ í•¨ìˆ˜ëŠ” 'p2p_loan_menu' íƒ€ì…ë§Œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
    if (state.type !== 'p2p_loan_menu') return false;

    // 1. [ì‹œê°„ ì´ˆê³¼ ë° ì·¨ì†Œ ê°€ë“œ]
    if (Date.now() - state.time > 30000 || msg === "ì·¨ì†Œ") {
        delete menuWaitState[targetUid];
        if (msg === "ì·¨ì†Œ") replier.reply(formatCommand("ğŸš« ì‚¬ì±„ ì—…ë¬´ ì·¨ì†Œ", user, "ì‘ì—…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."));
        else replier.reply(formatError(user, "ì…ë ¥ ì‹œê°„ ì´ˆê³¼", "30ì´ˆ ì´ë‚´ì— ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì§€ ì•Šì•„ ë©”ë‰´ê°€ ë‹«í˜”ìŠµë‹ˆë‹¤."));
        
        // ëª…ë ¹ì–´ ì…ë ¥ ì‹œì—ëŠ” falseë¥¼ ë°˜í™˜í•˜ì—¬ í•˜ìœ„ ë¡œì§ìœ¼ë¡œ ì „ë‹¬
        if (msg.startsWith("/")) return false;
        return true;
    }

    // 2. [ëª…ë ¹ì–´ í†µë¡œ]
    if (msg.startsWith("/")) {
        delete menuWaitState[targetUid];
        return false;
    }

    var choice = msg.trim();
    var roomData = data.rooms[roomName];
    var bankProcessState = roomData.features.states.bankProcess;

    // ì„ íƒì§€ ì²˜ë¦¬ ì‹œì‘ (ì¼ë‹¨ í˜„ì¬ ëŒ€ê¸° ìƒíƒœ í•´ì œ)
    delete menuWaitState[targetUid];

    if (choice === "1") {
        bankProcessState[targetUid] = { type: 'p2p_reg_input', time: Date.now() };
        replier.reply(formatCommand("ğŸ’° ì‚¬ì±„ ë§¤ë¬¼ ë“±ë¡", user, "ë“±ë¡í•  [ê¸ˆì•¡]ê³¼ [ì´ìœ¨]ì„ ì…ë ¥í•˜ì„¸ìš”.\n(ì˜ˆ: 10000 5)", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
    }
    else if (choice === "2") {
        var pools = Object.keys(roomData.loanPools || {});
        if (pools.length === 0) {
            replier.reply(formatSimple("ğŸ“‹ ì‚¬ì±„ ì‹œì¥", "í˜„ì¬ ë“±ë¡ëœ ë§¤ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.", null));
        } else {
            var list = []; 
            var tempPools = [];
            for(var i=0; i<pools.length; i++) {
                var p = roomData.loanPools[pools[i]];
                list.push((i+1) + ". [" + p.lenderName + "] ì”ì—¬: " + fp(p.remainingAmount) + "P (" + p.rate + "%)");
                tempPools.push(pools[i]);
            }
            menuWaitState[targetUid] = { type: 'p2p_select_pool', time: Date.now(), extra: { pools: tempPools } };
            replier.reply(formatCommand("ğŸ“‹ ì‚¬ì±„ ë§¤ë¬¼ ëª©ë¡", user, list.join("\n"), "ë¹Œë¦¬ê³  ì‹¶ì€ ë§¤ë¬¼ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
        }
    }
    else if (choice === "3") {
        var myContracts = [];
        if (roomData.loanContracts) {
            for(var id in roomData.loanContracts) {
                if(roomData.loanContracts[id].borrowerUid === targetUid) myContracts.push({ id: id, data: roomData.loanContracts[id] });
            }
        }
        if (myContracts.length === 0) {
            replier.reply(formatError(user, "ë‚´ì—­ ì—†ìŒ", "í˜„ì¬ ì´ ë°©ì—ì„œ ë¹Œë ¤ ì“°ê³  ìˆëŠ” ì‚¬ì±„ê°€ ì—†ìŠµë‹ˆë‹¤."));
        } else {
            var list = [];
            for(var i=0; i<myContracts.length; i++) {
                var c = myContracts[i].data;
                list.push((i+1) + ". [" + c.lenderName + "] ì±„ë¬´ì•¡: " + fp(c.currentDebt) + "P (ì´ìœ¨ " + c.rate + "%)");
            }
            menuWaitState[targetUid] = { type: 'p2p_select_repay', time: Date.now(), extra: { contracts: myContracts.map(function(x){return x.id;}) } };
            replier.reply(formatCommand("ğŸ“‰ ì‚¬ì±„ ìƒí™˜ ì„ íƒ", user, list.join("\n"), "ê°šì„ ì‚¬ì±„ì˜ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”."));
        }
    }
    else if (choice === "4") {
        var myPools = [];
        if (roomData.loanPools) {
            for(var id in roomData.loanPools) {
                if(roomData.loanPools[id].lenderUid === targetUid) myPools.push({ id: id, data: roomData.loanPools[id] });
            }
        }
        if (myPools.length === 0) {
            replier.reply(formatError(user, "ë‚´ì—­ ì—†ìŒ", "ì´ ë°©ì— ì˜¬ë ¤ë‘” ì‚¬ì±„ í’€ì´ ì—†ìŠµë‹ˆë‹¤."));
        } else {
            var list = [];
            for(var i=0; i<myPools.length; i++) {
                var p = myPools[i].data;
                list.push((i+1) + ". ì”ì—¬: " + (p.remainingAmount) + "P (ì´ìœ¨ " + p.rate + "%/3h)");
            }
            menuWaitState[targetUid] = { type: 'p2p_select_withdraw', time: Date.now(), extra: { pools: myPools.map(function(x){return x.id;}) } };
            replier.reply(formatCommand("ğŸ“¥ ì‚¬ì±„ í’€ íšŒìˆ˜", user, list.join("\n"), "íšŒìˆ˜í•  ì‚¬ì±„ í’€ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”."));
        }
    }
    else if (choice === "5") {
        var myDebtors = [];
        if (roomData.loanContracts) {
            for(var id in roomData.loanContracts) {
                if(roomData.loanContracts[id].lenderUid === targetUid) myDebtors.push({ id: id, data: roomData.loanContracts[id] });
            }
        }
        if (myDebtors.length === 0) {
            replier.reply(formatSimple("ğŸ‘¥ ë‚´ ì±„ë¬´ì í˜„í™©", "í˜„ì¬ ëˆì„ ë¹Œë ¤ ê°„ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.", null));
        } else {
            var list = [];
            var tempContracts = [];
            for(var i=0; i<myDebtors.length; i++) {
                var d = myDebtors[i].data;
                var status = (Date.now() - d.startTime > 24*60*60*1000) ? " (ğŸš¨ì—°ì²´)" : "";
                list.push((i+1) + ". [" + d.borrowerName + "] ë¹š: " + fp(d.currentDebt) + "P" + status);
                tempContracts.push(myDebtors[i].id);
            }
            menuWaitState[targetUid] = { type: 'p2p_select_collect', time: Date.now(), extra: { contracts: tempContracts } };
            replier.reply(formatCommand("ğŸ‘¥ ë‚´ ì±„ë¬´ì ëª…ë‹¨", user, list.join("\n"), "ê°•ì œ ìˆ˜ê±°ë¥¼ ì›í•˜ì‹œë©´ ìœ ì € ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
        }
    }
    else {
        // ì˜ëª»ëœ ë²ˆí˜¸ ì…ë ¥ ì²˜ë¦¬
        replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "ì˜¬ë°”ë¥¸ ë©”ë‰´ ë²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."));
    }

    return true;
}

//==========ì„¹í„°23-3==========

/* [ë…ë¦½í˜• í•¨ìˆ˜] ë©”ë‰´ ì„ íƒ ëŒ€ê¸° ì²˜ë¦¬ 3ë‹¨ê³„ (ì‚¬ì±„ ëª©ë¡ ì„ íƒ) */
function _handleMenuStep3(msg, user, data, replier, roomName, targetUid) {
    var menuWaitState = data.rooms[roomName].features.states.menuWait;
    if (!menuWaitState || !menuWaitState[targetUid]) return false;

    var state = menuWaitState[targetUid];
    // ì´ í•¨ìˆ˜ê°€ ì²˜ë¦¬í•  íƒ€ì… ëª©ë¡ ì •ì˜ (ì‚¬ì±„ ê´€ë ¨ ì„ íƒì§€ë“¤)
    var types = ['p2p_select_pool', 'p2p_select_repay', 'p2p_select_withdraw', 'p2p_select_collect'];
    if (types.indexOf(state.type) === -1) return false;

    // 1. [ì‹œê°„ ì´ˆê³¼ ë° ì·¨ì†Œ ê°€ë“œ]
    if (Date.now() - state.time > 30000 || msg === "ì·¨ì†Œ") {
        delete menuWaitState[targetUid];
        if (msg === "ì·¨ì†Œ") replier.reply(formatCommand("ğŸš« ì‚¬ì±„ ì—…ë¬´ ì·¨ì†Œ", user, "ì‘ì—…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."));
        else replier.reply(formatError(user, "ì…ë ¥ ì‹œê°„ ì´ˆê³¼", "30ì´ˆ ì´ë‚´ì— ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì§€ ì•Šì•„ ë©”ë‰´ê°€ ë‹«í˜”ìŠµë‹ˆë‹¤."));
        
        if (msg.startsWith("/")) return false;
        return true;
    }

    // 2. [ëª…ë ¹ì–´ í†µë¡œ]
    if (msg.startsWith("/")) {
        delete menuWaitState[targetUid];
        return false;
    }

    var choice = msg.trim();
    var roomData = data.rooms[roomName];
    var bankProcessState = roomData.features.states.bankProcess;

    /* [ì„ íƒ ë¶„ê¸° 1] ì‚¬ì±„ ë¹Œë¦¬ê¸° ë§¤ë¬¼ ì„ íƒ */
    if (state.type === 'p2p_select_pool') {
        delete menuWaitState[targetUid];
        var idx = parseInt(choice) - 1;
        var poolId = (state.extra && state.extra.pools) ? state.extra.pools[idx] : null;
        
        if (!poolId || !roomData.loanPools[poolId]) {
            replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "ëª©ë¡ì— ìˆëŠ” ë²ˆí˜¸ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”."));
        } else {
            bankProcessState[targetUid] = { type: 'p2p_borrow_amt', time: Date.now(), extra: { poolId: poolId } };
            replier.reply(formatCommand("ğŸ’° ì‚¬ì±„ ê¸ˆì•¡ ì„¤ì •", user, "ì„ íƒ ë§¤ë¬¼: [" + roomData.loanPools[poolId].lenderName + "]\nì”ì—¬ ê¸ˆì•¡: " + fp(roomData.loanPools[poolId].remainingAmount) + "P\n\në¹Œë¦´ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
        }
        return true;
    }

    /* [ì„ íƒ ë¶„ê¸° 2] ì‚¬ì±„ ìƒí™˜ ëŒ€ìƒ ì„ íƒ */
    else if (state.type === 'p2p_select_repay') {
        delete menuWaitState[targetUid];
        var idx = parseInt(choice) - 1;
        var contractId = (state.extra && state.extra.contracts) ? state.extra.contracts[idx] : null;
        
        if (!contractId || !roomData.loanContracts[contractId]) {
            replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "ìƒí™˜í•  ê³„ì•½ ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."));
        } else {
            bankProcessState[targetUid] = { type: 'p2p_repay_amt', time: Date.now(), extra: { contractId: contractId } };
            var contract = roomData.loanContracts[contractId];
            replier.reply(formatCommand("ğŸ“‰ ì‚¬ì±„ ìƒí™˜ì•¡ ì…ë ¥", user, "ì±„ê¶Œì: [" + contract.lenderName + "]\në‚¨ì€ ë¹š: " + fp(contract.currentDebt) + "P\nğŸ’° ë‚´ ì”ì•¡: " + fp(user.point) + "P\n\nê°šì„ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
        }
        return true;
    }

    /* [ì„ íƒ ë¶„ê¸° 3] ì‚¬ì±„ ë§¤ë¬¼ íšŒìˆ˜ ëŒ€ìƒ ì„ íƒ */
    else if (state.type === 'p2p_select_withdraw') {
        delete menuWaitState[targetUid];
        var idx = parseInt(choice) - 1;
        var poolId = (state.extra && state.extra.pools) ? state.extra.pools[idx] : null;
        
        if (!poolId || !roomData.loanPools[poolId]) {
            replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜"));
        } else {
            bankProcessState[targetUid] = { type: 'p2p_withdraw_amt', time: Date.now(), extra: { poolId: poolId, max: roomData.loanPools[poolId].remainingAmount } };
            replier.reply(formatCommand("ğŸ“¥ íšŒìˆ˜ ê¸ˆì•¡ ì…ë ¥", user, "í˜„ì¬ í’€ ì”ì•¡: " + fp(roomData.loanPools[poolId].remainingAmount) + "P\n\níšŒìˆ˜í•  ê¸ˆì•¡ì„ ì…ë ¥í•˜ê±°ë‚˜ [ì „ì•¡]ì„ ì…ë ¥í•˜ì„¸ìš”.", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
        }
        return true;
    }

    /* [ì„ íƒ ë¶„ê¸° 4] ì±„ë¬´ì ê°•ì œ ìˆ˜ê±° ëŒ€ìƒ ì„ íƒ */
    else if (state.type === 'p2p_select_collect') {
        delete menuWaitState[targetUid];
        var idx = parseInt(choice) - 1;
        var contractId = (state.extra && state.extra.contracts) ? state.extra.contracts[idx] : null;
        
        if (!contractId || !roomData.loanContracts[contractId]) {
            replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜"));
        } else {
            bankProcessState[targetUid] = { type: 'p2p_collect_manual', time: Date.now(), extra: { contractId: contractId } };
            replier.reply(formatCommand("ğŸš¬ ì‚¬ì±„ ê°•ì œ ìˆ˜ê±° í™•ì¸", user, "[" + roomData.loanContracts[contractId].borrowerName + "]ë‹˜ì˜ ì§€ê°‘ì—ì„œ ìì‚°ì„ ìˆ˜ê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì§„í–‰í•˜ì‹œë ¤ë©´ ì•„ë¬´ ë©”ì‹œì§€ë‚˜ ì…ë ¥í•´ì£¼ì„¸ìš”.", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
        }
        return true;
    }

    return false;
}

//==========ì„¹í„°23-4==========

/* [ë…ë¦½í˜• í•¨ìˆ˜] ë©”ë‰´ ì„ íƒ ëŒ€ê¸° ì²˜ë¦¬ 4ë‹¨ê³„ (ìƒì /ë„ì›€ë§/ê°€ì´ë“œ) */

function _handleMenuStep4(msg, user, data, replier, roomName, targetUid) {

    // [í•µì‹¬] ìˆ«ì ì…ë ¥ ì‹œì—ëŠ” ë©”ì¸ ë°©ì´ ì•„ë‹ˆë¼ 'í˜„ì¬ ìœ ì €ê°€ ìˆëŠ” ë°©(1:1ë°©)'ì˜ ëŒ€ê¸° ìƒíƒœë¥¼ í™•ì¸í•´ì•¼ í•¨

    var currentRoomData = data.rooms[roomName]; 

    if (!currentRoomData || !currentRoomData.features) return false;

    

    var menuWaitState = currentRoomData.features.states.menuWait;



    // ì¶”ê°€: í†µí•© ë„ì›€ë§ ì§„ì…ì  (/ê°€ì´ë“œ ì‚­ì œ í†µí•©)

    if (msg === "/ë„ì›€ë§") {

        menuWaitState[targetUid] = { type: 'help_main', time: Date.now() };

        var menu = "1. ğŸ“˜ ê¸°ì´ˆ ì…ë¬¸ ê°€ì´ë“œ\n" +

                   "2. ğŸ¦ ì¤‘ì•™ì€í–‰ ë° ì‹ ìš© ê²½ì œ\n" +

                   "3. ğŸ¢ ëœë“œë§ˆí¬ ë¶€ë™ì‚° íˆ¬ì\n" +

                   "4. âš“ ë¬´ì—­ ë° í•´ìƒ êµì—­\n" +

                   "5. ğŸ° í†µí•© ì¹´ì§€ë…¸ ë° ë¡œë˜\n" +

                   "6. â›ï¸ ìƒì‚° ë° ì•½íƒˆ í™œë™\n" +

                   "7. ğŸ’ ê°€ë°© ë° ì•„ì´í…œ ìˆ˜ì§‘\n" +

                   "8. ğŸ›ï¸ ê°€ìƒ ì •ë¶€ ë° ì •ì±…\n" +
                   "9. ğŸ‘‘ ê³µì‹ ì‘ìœ„ ë° ì¹­í˜¸ ê°€ì´ë“œ";

        replier.reply(formatCommand("ğŸ“– ë‚´ë¦¬ë‹¤ë´‡ ì¢…í•© ë„ì›€ë§", user, "ì›í•˜ì‹œëŠ” ê°€ì´ë“œ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.\n\n" + menu, "ì…ë ¥ ëŒ€ê¸°: 30ì´ˆ"));

        return true;

    }



    if (!menuWaitState || !menuWaitState[targetUid]) return false;



    var state = menuWaitState[targetUid];

    // ì²˜ë¦¬ ê°€ëŠ¥ íƒ€ì… ë¦¬ìŠ¤íŠ¸ ìµœì í™” (help_main í†µí•©)

    var types = [

        'shop_category', 'shop_detail', 'help_main', 

        'trade_main', 'trade_market', 'trade_depart', 'trade_status', 'trade_ship',

        'trade_select_cargo', 'trade_governor_office', 'trade_escort_select', 

        'trade_job_enlist', 'trade_pirate_menu', 'trade_navy_menu', 

        'trade_raid_list', 'trade_battle_list', 'trade_escort_confirm',

        'casino_main', 'casino_ladder', 'casino_baccarat',

        'casino_ladder_sub', 'casino_baccarat_sub' 

    ];



    // ìˆ˜ì •: ê°œë³„ ë„¤ë¹„ê²Œì´ì…˜(ì²˜ìŒìœ¼ë¡œ/ì·¨ì†Œ) ë¡œì§ì„ ì œê±°í•˜ê³  'ë’¤ë¡œ' ê°€ê¸° ë¡œì§ì˜ ê³„ì¸µë§Œ ì •ë°€í™”í•¨ (ì„¹í„° 24ì—ì„œ ì¤‘ì•™ ì²˜ë¦¬í•˜ë¯€ë¡œ ì‚­ì œ)
    if (msg === "ë’¤ë¡œ" || msg === "â†©ï¸ ë’¤ë¡œ") {
        if (state.type === 'trade_select_cargo') {
            state.type = 'trade_depart'; state.depth = 2; state.time = Date.now();
            _prepareVoyage(user, replier, SYSTEM_CONFIG.TRADE, data.rooms[(ALLOWED_ROOMS.indexOf(roomName) === -1) ? "ë‚´ë¦¬ë‹¤" : roomName]);
            return true;
        }
        delete menuWaitState[targetUid];
        if (state.type.startsWith('trade_')) return _gameTradeLogic("/ë¬´ì—­", user, data, replier, roomName, targetUid);
        if (state.type.startsWith('casino_')) return _gameCasinoLogic("/ì¹´ì§€ë…¸", user, data, replier, roomName, targetUid);
        if (state.type === 'shop_detail') return _gameShopLogic("/ìƒì ", user, data, replier, roomName, targetUid);
        if (state.type.startsWith('help')) { replier.reply("ğŸ“– ì´ìš©ì„ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤."); return true; }
        
        replier.reply(formatCommand("ğŸšª ë©”ë‰´ ì¢…ë£Œ", user, "ì´ìš©ì„ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    // ìˆ˜ì •: ì „ì—­ ë³€ìˆ˜(SYSTEM_CONFIG, ALLOWED_ROOMS) ë¯¸ì„ ì–¸ìœ¼ë¡œ ì¸í•œ ë´‡ ë©ˆì¶¤ ë°©ì§€ ê°€ë“œ ì ìš©
var choice = msg.replace(/[^0-9]/g, "").trim();
var logicRoom = (typeof ALLOWED_ROOMS !== 'undefined' && ALLOWED_ROOMS.indexOf(roomName) === -1) ? "ë‚´ë¦¬ë‹¤" : roomName;
var roomData = data.rooms[logicRoom]; 
var tradeCfg = (typeof SYSTEM_CONFIG !== 'undefined') ? SYSTEM_CONFIG.TRADE : null;
var bankProcessState = (roomData && roomData.features) ? roomData.features.states.bankProcess : null;

// í•µì‹¬ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ ì‹œ ìˆ«ì ë¡œì§ ì§„ì… ë°©ì§€
if (choice !== "" && (!tradeCfg || !roomData || !bankProcessState)) return false;


    // 1. 1:1 ì±„íŒ…ë°© ê¸°ëŠ¥ ì œí•œ ê°€ë“œ

    if (ALLOWED_ROOMS.indexOf(roomName) === -1) {

        if (state.type.startsWith('trade_') || state.type.startsWith('shop_')) {

            delete menuWaitState[targetUid];

            replier.reply("ğŸš« [ê¸°ëŠ¥ ì œí•œ]\në¬´ì—­ ë° ìƒì  ê´€ë¦¬ ê¸°ëŠ¥ì€ ë‹¨ì²´ë°©('ë‚´ë¦¬ë‹¤')ì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.\n\nâœ… 1:1 ê°€ëŠ¥: ì¹´ì§€ë…¸, ì€í–‰, ë‚´ì •ë³´");

            return true;
        }
    }

    // [ê³„ì¸µí˜• ë’¤ë¡œê°€ê¸° í†µí•© í•¸ë“¤ëŸ¬]
   if (msg === "ë’¤ë¡œ" || msg === "â†©ï¸ ë’¤ë¡œ") {
        // [íŠ¹ìˆ˜] í•˜ì—­ ì„¤ì • ì¤‘ì´ë©´ ì¶œí•­ì§€ ì„ íƒìœ¼ë¡œ ë³µêµ¬
        if (state.type === 'trade_select_cargo') {
            state.type = 'trade_depart'; state.depth = 2; state.time = Date.now();
            _prepareVoyage(user, replier, SYSTEM_CONFIG.TRADE, data.rooms[logicRoom]);
            return true;
        }
        // [ë¬´ì—­ ì„œë¸Œë©”ë‰´] ë¬´ì—­ ë©”ì¸ìœ¼ë¡œ í•œ ë‹¨ê³„ë§Œ ë³µêµ¬ (ì„¸ì…˜ íŒŒê¸° ë°©ì§€)
        if (state.type.startsWith('trade_') && state.type !== 'trade_main') {
            delete menuWaitState[targetUid];
            return _gameTradeLogic("/ë¬´ì—­", user, data, replier, roomName, targetUid);
        }
        // ê¸°íƒ€ ì‹œìŠ¤í…œ (ì¹´ì§€ë…¸, ë„ì›€ë§ ë“±)
        delete menuWaitState[targetUid];
        if (state.type.startsWith('casino_')) return _gameCasinoLogic("/ì¹´ì§€ë…¸", user, data, replier, roomName, targetUid);
        if (state.type === 'shop_detail') return _gameShopLogic("/ìƒì ", user, data, replier, roomName, targetUid);
        
        replier.reply(formatCommand("ğŸšª ë©”ë‰´ ì¢…ë£Œ", user, "ì´ì „ í™”ë©´ì´ ì—†ì–´ í‡´ê±°í•©ë‹ˆë‹¤."));
        return true;
    }

    // 3. [ë¶„ê¸° 1] ë„ì›€ë§ ìƒì„¸ ì¡°íšŒ (help_main)
    if (state.type === 'help_main') {
        var helpData = {
            "1": { 
                title: "ğŸ“˜ [ë‚´ë¦¬ë‹¤ë´‡ ê¸°ì´ˆ ì…ë¬¸ ê°€ì´ë“œ]", 
                text: "1. ì‹œìŠ¤í…œ ì‹œì‘ ë° ê³„ì • ë³´ì•ˆ\nâ€¢ [ì‹ ê·œ ê°€ì…]: ë‹¨ì²´ë°©ì—ì„œ ì±„íŒ…ì„ ì¹˜ë©´ ì¦‰ì‹œ ê³ ìœ  ì½”ë“œ(UID)ê°€ ë°œê¸‰ë˜ë©° 100,000Pì˜ ì •ì°©ê¸ˆì´ ì§€ê¸‰ë©ë‹ˆë‹¤.\nâ€¢ [/ì½”ë“œí™•ì¸]: ê¸°ê¸° ë³€ê²½ì´ë‚˜ ë‹‰ë„¤ì„ ë³€ê²½ì— ëŒ€ë¹„í•˜ì—¬ ë‚˜ë§Œì˜ 1:1 ê³ ìœ  ë³µêµ¬ ì½”ë“œë¥¼ í™•ì¸í•©ë‹ˆë‹¤.\nâ€¢ [/ê³„ì •ì—°ë™ ì½”ë“œ]: ì´ì „ ê³„ì •ì˜ ë°ì´í„°(ìì‚°, í‹°ì–´, ì•„ì´í…œ)ë¥¼ í˜„ì¬ ê³„ì •ìœ¼ë¡œ ì™„ë²½í•˜ê²Œ ë³µì œí•´ì˜µë‹ˆë‹¤.\n\n2. ì„±ì¥ì˜ ê¸°ë°˜: ì¶œì„ì²´í¬\nâ€¢ [/ì¶œì„]: ë§¤ì¼ 1íšŒ í¬ì¸íŠ¸ì™€ ì‹ ìš©ì ìˆ˜(+2)ë¥¼ íšë“í•©ë‹ˆë‹¤.\nâ€¢ [ë¬¼ê°€ ì—°ë™]: ë³´ìƒì•¡ì€ ê³ ì •ê°’ì´ ì•„ë‹ˆë©°, ì„œë²„ ì „ì²´ í†µí™”ëŸ‰ê³¼ ì¤‘ì•™ì€í–‰ì˜ ì¬ê³ ëŸ‰ì— ë”°ë¼ ë§¤ì¼ ë³€ë™ë©ë‹ˆë‹¤.\nâ€¢ [ì‹ ë¶ˆì ì œí•œ]: ì‹ ìš©ì ìˆ˜ê°€ 500ì  ë¯¸ë§Œì¸ ê²½ìš°, ë³µì§€ ì‚­ê° ì •ì±…ì— ì˜í•´ ë³´ìƒì˜ 20%ê°€ êµ­ê³ ë¡œ ìë™ í™˜ìˆ˜ë©ë‹ˆë‹¤.\n\n3. ì‹ ë¶„ ìƒìŠ¹: í‹°ì–´ ì‹œìŠ¤í…œ\nâ€¢ [/ìŠ¹ê¸‰]: ì•„ì´ì–¸ë¶€í„° ì±Œë¦°ì €ê¹Œì§€ ë“±ê¸‰ ìƒìŠ¹ì— ë„ì „í•©ë‹ˆë‹¤. \nâ€¢ [ìŠ¹ê¸‰ ê¸°íšŒ]: ë§¤ì¼ 1íšŒ ë¬´ë£Œ ê¸°íšŒê°€ ì£¼ì–´ì§€ë©°, ë¶€ì¡±í•  ê²½ìš° ìƒì ì—ì„œ ìŠ¹ê¸‰ê¶Œì„ êµ¬ë§¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (êµ¬ë§¤ ì‹œë§ˆë‹¤ ê°€ê²© í• ì¦ ë°œìƒ)\nâ€¢ [ê°•ë“± ë°©ì–´]: ì‹¤ë²„ í‹°ì–´ ì´ìƒë¶€í„°ëŠ” ì‹¤íŒ¨ ì‹œ í•˜ë½ ìœ„í—˜ì´ ì¡´ì¬í•˜ë©°, ìƒì ì˜ 'ê°•ë“± ë°©ì–´ê¶Œ'ìœ¼ë¡œ ë³´í˜¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\nâ€¢ [í”¼ë²„ íƒ€ì„]: ë§¤ì£¼ ì¼ìš”ì¼ì—ëŠ” êµ­ê°€ ì´ë²¤íŠ¸ë¡œ ì¸í•´ ìŠ¹ê¸‰ ì„±ê³µ í™•ë¥ ì´ ì†Œí­ ìƒìŠ¹í•©ë‹ˆë‹¤.\n\nğŸ’¡ ê´€ë ¨ ëª…ë ¹ì–´: /ì¶œì„, /ë‚´ì •ë³´, /ì½”ë“œí™•ì¸, /ê³„ì •ì—°ë™, /ìŠ¹ê¸‰"
            },
            "2": { 
                title: "ğŸ¦ [ì¤‘ì•™ì€í–‰ ë° ì‹ ìš© ê²½ì œ ê°€ì´ë“œ]", 
                text: "1. ì¤‘ì•™ì€í–‰ êµ­ê³  ì‹œìŠ¤í…œ\nâ€¢ [ìˆœí™˜ ê²½ì œ]: ìœ ì €ê°€ ìƒì  êµ¬ë§¤, ë„ë°• íŒ¨ë°°, ì„¸ê¸ˆ ë‚©ë¶€ë¡œ ì§€ë¶ˆí•œ ëˆì€ 'ì¤‘ì•™ì€í–‰ ê¸ˆê³ 'ë¡œ ì°¨ê³¡ì°¨ê³¡ ìŒ“ì…ë‹ˆë‹¤.\nâ€¢ [ì§€ê¸‰ì¤€ë¹„ìœ¨]: ì€í–‰ì€ ì´ ì˜ˆê¸ˆì˜ 20%ë¥¼ ë²•ì • ì¤€ë¹„ê¸ˆìœ¼ë¡œ ë³´ìœ í•´ì•¼ í•©ë‹ˆë‹¤. ì¬ê³ ê°€ ë¶€ì¡±í•˜ë©´ ì¶œê¸ˆ ë° ëŒ€ì¶œì´ ì¼ì‹œì ìœ¼ë¡œ ì •ì§€(ë±…í¬ëŸ° ë°©ì§€)ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\nâ€¢ [êµ­ê°€ ë¶€ë„]: êµ­ê³ ê°€ ë°”ë‹¥ë‚˜ë©´ ë¶€ë„ê°€ ì„ í¬ë˜ì–´ ë¶€ë™ì‚°, ì¹´ì§€ë…¸ ë“± ëª¨ë“  íˆ¬ì í™œë™ì´ ë™ê²°ë©ë‹ˆë‹¤.\n\n2. ì‹ ìš© ì ìˆ˜ì™€ ë“±ê¸‰ (/ì‹ ìš©ë“±ê¸‰)\nâ€¢ [ë“±ê¸‰ ì˜í–¥]: ë“±ê¸‰ì´ ë†’ì„ìˆ˜ë¡ ëŒ€ì¶œ í•œë„ëŠ” ëŠ˜ì–´ë‚˜ê³ , ëŒ€ì¶œ ì´ìœ¨ì€ ë‚®ì•„ì§€ë©°, ë¬´ì—­ ìˆ˜ìµ ë°°ìœ¨ì´ ìƒìŠ¹í•©ë‹ˆë‹¤.\nâ€¢ [ì‹ ìš© ê´€ë¦¬]: ëŒ€ì¶œ ìƒí™˜ ì‹œ ì ìˆ˜ê°€ í¬ê²Œ ìƒìŠ¹í•˜ë©°, ê¸°ë¶€ í™œë™(1ë§ŒPë‹¹ +10ì )ì„ í†µí•´ì„œë„ íšŒë³µ ê°€ëŠ¥í•©ë‹ˆë‹¤.\nâ€¢ [ì‹ ìš©ë¶ˆëŸ‰ì]: 500ì  ë¯¸ë§Œ ì‹œ ì§€ì •ë˜ë©°, ëª¨ë“  ìˆ˜ìµì˜ 50%ê°€ ì±„ë¬´ ìƒí™˜ìœ¼ë¡œ ê°•ì œ ì§•ìˆ˜ë©ë‹ˆë‹¤.\n\n3. ì˜ˆê¸ˆê³¼ ëŒ€ì¶œ (/ì€í–‰)\nâ€¢ [ë³µë¦¬ ì´ì]: ì˜ˆê¸ˆì•¡ì— ëŒ€í•´ ì‹¤ì‹œê°„ìœ¼ë¡œ ì´ìê°€ ëˆ„ì ë˜ì–´ ë§¤ì¼ ìì • ì§€ê¸‰ë©ë‹ˆë‹¤. ([ìì‚°ì™•] ì¹­í˜¸ ì¥ì°© ì‹œ 1.5ë°° ë³´ë„ˆìŠ¤)\nâ€¢ [ìë™ ìƒí™˜]: ë¹šì´ ìˆëŠ” ìƒíƒœì—ì„œ ìˆ˜ìµ ë°œìƒ ì‹œ ì•„ë˜ ë¹„ìœ¨ë¡œ ì„ ì°¨ê°ë©ë‹ˆë‹¤.\n  - ì¼ë°˜ ì€í–‰ ëŒ€ì¶œ: ìˆ˜ìµì˜ 30%\n  - ì‚¬ì±„ ë° ì‹ ìš©ë¶ˆëŸ‰: ìˆ˜ìµì˜ 50%\n  - ì€í–‰ ëŒ€í™˜ ì±„ë¬´(ì—°ì²´ ëŒ€ë‚©ê±´): ìˆ˜ìµì˜ 70%\n\nğŸ’¡ ê´€ë ¨ ëª…ë ¹ì–´: /ì€í–‰, /ì‹ ìš©ë“±ê¸‰, /ëŒ€ì¶œí•œë„, /ìƒí™˜, /ê¸°ë¶€"
            },
            "3": { 
                title: "ğŸ¢ [ëœë“œë§ˆí¬ ë¶€ë™ì‚° íˆ¬ì ê°€ì´ë“œ]", 
                text: "1. ë¶€ë™ì‚° ì‹œì¥ ê±°ë˜\nâ€¢ [ìš´ì˜ ì‹œê°„]: ë§¤ì¼ 07:00 ~ 23:59 (ì•¼ê°„ì—ëŠ” ì‹œì„¸ê°€ ê³ ì •ë˜ë©° ê±°ë˜ê°€ ì¤‘ë‹¨ë©ë‹ˆë‹¤.)\nâ€¢ [ì‹œì„¸ ë³€ë™]: 10ë¶„ë§ˆë‹¤ ì‹œì¥ ìˆ˜ìš”, ìœ ì € ê±°ë˜ëŸ‰, ì •ë¶€ ì •ì±…ì— ë”°ë¼ ê°€ê²©ì´ ìš”ë™ì¹©ë‹ˆë‹¤.\nâ€¢ [ì–‘ë„ì†Œë“ì„¸]: ì§€ë¶„ ë§¤ê° ì‹œ ë§ˆì§„ì˜ 5~10%ê°€ ì„¸ê¸ˆìœ¼ë¡œ ì§•ìˆ˜ë©ë‹ˆë‹¤. ([ê¸°ë¶€ì™•] ì¹­í˜¸ ì‹œ 50% ê°ë©´)\n\n2. 6ëŒ€ í•µì‹¬ ì‹œì„¤ê³¼ í™•ì • ë°°ë‹¹\nâ€¢ [ëŒ€ìƒ ê±´ë¬¼]: ê´‘ì‚°, ë‚šì‹œí„°, ì¹´ì§€ë…¸, ì¤‘ì•™ì€í–‰, ë°±í™”ì , ê²½ë§ˆì¥\nâ€¢ [ë°°ë‹¹ ì›ë¦¬]: ê° ì‹œì„¤ì˜ ì§€ë¶„ 1ìœ„(ìµœëŒ€ì£¼ì£¼)ëŠ” ë§¤ì¼ ìì • 24ì‹œê°„ ë™ì•ˆ ëˆ„ì ëœ ìš´ì˜ ìˆ˜ìµì„ ë…ì  ë°°ë‹¹ë°›ìŠµë‹ˆë‹¤.\nâ€¢ [ì§€ë¶„ ë³´ë„ˆìŠ¤]: ë³´ìœ  ì§€ë¶„ì´ 10ê°œë¥¼ ì´ˆê³¼í•  ê²½ìš°, 1ì§€ë¶„ë‹¹ 10%ì”© ë°°ë‹¹ íš¨ìœ¨ì´ ë‹¨ë¦¬ë¡œ ìƒìŠ¹í•©ë‹ˆë‹¤.\nâ€¢ [ì „ì„¤ì˜ í°ì†]: í•µì‹¬ ì‹œì„¤ íˆ¬ì ì¤‘ ì–»ëŠ” 'ë“±ê¸°ë¶€' 10ì¥ì„ ëª¨ìœ¼ë©´ íšë“í•˜ë©°, ë°°ë‹¹ê¸ˆ 10% ì¶”ê°€ ë³´ë„ˆìŠ¤ë¥¼ ë°›ìŠµë‹ˆë‹¤.\n\n3. ì§€ëŠ¥í˜• ê²½ì œ êµì • (ì§€ë‹ˆ ê³„ìˆ˜)\nâ€¢ [ê³„ì¸µ ê´€ë¦¬]: ìì‚° ë¶ˆí‰ë“±ì´ ì‹¬í™”ë˜ë©´ ìƒë¥˜ì¸µ(ìƒìœ„ 15%)ì—ê²ŒëŠ” ì¶”ê°€ ëˆ„ì§„ì„¸ê°€, ì„œë¯¼ì¸µì—ê²ŒëŠ” ë³´ìƒ ê°•í™” ë°°ìœ¨ì´ ìë™ìœ¼ë¡œ ì ìš©ë©ë‹ˆë‹¤.\n\nğŸ’¡ ê´€ë ¨ ëª…ë ¹ì–´: /ëœë“œë§ˆí¬, /íˆ¬ì, /ë§¤ê°, /ë‚´ë¶€ë™ì‚°, /ë°°ë‹¹í˜„í™©, /ì§€ë¶„í˜„í™©"
            },
            "4": { 
                title: "âš“ [ëŒ€í•­í•´ì‹œëŒ€: ë¬´ì—­ ë° í•´ìƒ êµì „ ê°€ì´ë“œ]", 
                text: "1. í•´ìƒ ë¬´ì—­ì˜ ì›ë¦¬ (/ë¬´ì—­)\nâ€¢ [ì‹œì„¸ ê³ ì •]: ë§¤ì‹œ 30ë¶„ì— ì„¸ê³„ ì‹œì„¸ê°€ ë³€ë™ë˜ì§€ë§Œ, ì¶œí•­í•˜ëŠ” ìˆœê°„ì˜ ê°€ê²©ì´ ë„ì°© ì‹œê¹Œì§€ ë³´ì¡´ë˜ì–´ ì „ëµì  ë¬´ì—­ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.\nâ€¢ [ì„ ë°• ê°œì¡°]: ì¹´ë¼ë²¨(10ì¹¸) â†’ í”„ë¦¬ê¹ƒ(25ì¹¸) â†’ ê°¤ë¦¬ì˜¨(40ì¹¸)ìœ¼ë¡œ ê°•í™”í•˜ì—¬ ì ì¬ëŸ‰ê³¼ í•­í•´ ì†ë„ë¥¼ ë†’ì´ì„¸ìš”.\nâ€¢ [íŠ¹ì‚°í’ˆ]: ë„ì°©ì§€ í•­êµ¬ì—ì„œ ë‚®ì€ í™•ë¥ ë¡œ ë°œê²¬í•˜ë©°, [ì´ë…]ì¸ ê²½ìš° ìµœëŒ€ 3ë°°ê¹Œì§€ íšë“ëŸ‰ì´ ëŠ˜ì–´ë‚©ë‹ˆë‹¤.\n\n2. í•­í•´ ì¬í•´ ë° íŠ¹ê¶Œ\nâ€¢ [ëŒë°œ ì´ë²¤íŠ¸]: 25% í™•ë¥ ë¡œ í­í’ìš°(ìˆ˜ë¦¬ë¹„), í™”ì¬(í™”ë¬¼ ì†Œì‹¤), ë¶€ì‹(ê°€ì¹˜ í•˜ë½) ë“±ì˜ ì¬í•´ê°€ ë°œìƒí•©ë‹ˆë‹¤.\nâ€¢ [í•´ìƒì™•]: ëˆ„ì  ë¬´ì—­ 200íšŒ ë‹¬ì„± ì‹œ ìˆ˜ì—¬ë˜ëŠ” [í•´ìƒì™•] ì¹­í˜¸ ì¥ì°© ì‹œ ëª¨ë“  ì¬í•´(ë””ë²„í”„) ë°œìƒ í™•ë¥ ì´ 50% ê°ì†Œí•©ë‹ˆë‹¤.\n\n3. í•´ìƒ êµì „: í•´ì ê³¼ í•´êµ°\nâ€¢ [í•´ì (Pirate)]: í•­í•´ ì¤‘ì¸ ìƒì„ ì„ ìŠµê²©í•˜ì—¬ ë§ˆì§„ì˜ 30%ë¥¼ ê°•íƒˆí•©ë‹ˆë‹¤. ì„±ê³µ ì‹œ í˜„ìƒê¸ˆì´ ëˆ„ì ë©ë‹ˆë‹¤.\nâ€¢ [í•´êµ°(Navy)]: ìŠµê²© ì¤‘ì¸ í•´ì ì„ í† ë²Œí•˜ì—¬ í˜„ìƒê¸ˆì„ ìˆ˜ë ¹í•©ë‹ˆë‹¤. ìƒì¸ì—ê²Œ ê³ ìš©ë˜ì–´ 'ë³´í˜¸ì„¸'ë¥¼ ë°›ê³  í˜¸ìœ„ ì„ë¬´ë¥¼ ìˆ˜í–‰í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.\nâ€¢ [êµì „ ê³µì‹]: ì„ ë°•ì˜ ë ˆë²¨ì´ ë†’ì„ìˆ˜ë¡ ì „íˆ¬ ìŠ¹ë¥ ì´ ìƒìŠ¹í•©ë‹ˆë‹¤. íŒ¨ë°°í•œ í•´êµ°ì€ 15ë¶„ê°„ í‡´ê°(ì •ë¹„) ìƒíƒœê°€ ë©ë‹ˆë‹¤.\n\nğŸ’¡ ê´€ë ¨ ëª…ë ¹ì–´: /ë¬´ì—­, /í•­í•´í˜„í™©, /ì„ ë°•ê´€ë¦¬, /íˆ¬ì(í•­êµ¬), /ì¡°í•©ì‚¬ë¬´ì†Œ"
            },
            "5": { 
                title: "ğŸ° [í†µí•© ì¹´ì§€ë…¸ ë° ë¡œë˜ ê°€ì´ë“œ]", 
                text: "1. ì¤‘ì•™ ì¹´ì§€ë…¸ (1:1 ì±„íŒ… ì „ìš©)\nâ€¢ [ì‚¬ë‹¤ë¦¬]: 2ë¶„ ì£¼ê¸°ë¡œ ê²°ê³¼ê°€ ë‚˜ì˜µë‹ˆë‹¤. ë‹¨ì¼(í™€/ì§) 1.9ë°°, ì¡°í•©(ì¢Œ3ì§ ë“±) 4.0ë°°ì˜ ë°°ë‹¹ì„ ì œê³µí•©ë‹ˆë‹¤.\nâ€¢ [ë°”ì¹´ë¼]: 3ë¶„ ì£¼ê¸°ë¡œ ê²°ê³¼ê°€ ë‚˜ì˜µë‹ˆë‹¤. í”Œë ˆì´ì–´(2.0ë°°), ë±…ì»¤(1.95ë°°), íƒ€ì´(8.0ë°°)ì— ë°°íŒ… ê°€ëŠ¥í•©ë‹ˆë‹¤.\nâ€¢ [ë¸”ë™ì­]: ë”œëŸ¬ì™€ 1:1 ì§„ê²€ìŠ¹ë¶€ë¥¼ í¼ì¹©ë‹ˆë‹¤. 21ì— ê°€ê¹Œìš´ ìˆ˜ë¥¼ ë§Œë“œì„¸ìš”. [ë„ë°•ì™•] ì¹­í˜¸ ì¥ì°© ì‹œ ëª¨ë“  ê²Œì„ ë°°ë‹¹ì— +0.05ê°€ ì¶”ê°€ë©ë‹ˆë‹¤.\n\n2. ë‹¹ì²¨ì˜ ì£¼ì¸ê³µ: ë¡œë˜ ë° ìŠ¤í”¼ë˜\nâ€¢ [ë¡œë˜]: 1~15 ì‚¬ì´ì˜ ìˆ«ì 3ê°œë¥¼ ë§ì¶”ëŠ” ê²Œì„ì…ë‹ˆë‹¤. ë§¤ì¼ 22ì‹œì— ì¶”ì²¨í•˜ë©°, 1ë“± ë‹¹ì²¨ìê°€ ì—†ìœ¼ë©´ ì­íŒŸ ìƒê¸ˆì´ ë¬´ì œí•œ ì´ì›”ë©ë‹ˆë‹¤.\nâ€¢ [ìŠ¤í”¼ë˜]: ì¦‰ì„ì—ì„œ ê¸ì–´ í™•ì¸í•˜ëŠ” ë³µê¶Œì…ë‹ˆë‹¤. ë‚™ì²¨ ì‹œ ì–»ëŠ” 'ìœ„ë¡œì˜ í¸ì§€' 15ì¥ì„ ëª¨ìœ¼ë©´ 1ì‹œê°„ ë™ì•ˆ ë„ë°•ìš´ì´ ìƒìŠ¹í•˜ëŠ” [í–‰ìš´ì˜ ë¶€ì ]ì„ ì–»ìŠµë‹ˆë‹¤.\n\nâš ï¸ ì£¼ì˜ì‚¬í•­: ì¹´ì§€ë…¸ì™€ ë„ë°•ì€ ì¤‘ì•™ì€í–‰ì˜ ì¬ì› ìƒíƒœì— ë”°ë¼ ë°°ë‹¹ê¸ˆì´ êµ­ê³  ë³´ì „ê¸ˆ í˜•ì‹ìœ¼ë¡œ ì§€ê¸‰ë˜ë¯€ë¡œ, êµ­ê°€ ë¶€ë„ ì‹œ ì´ìš©ì´ ì œí•œë©ë‹ˆë‹¤.\n\nğŸ’¡ ê´€ë ¨ ëª…ë ¹ì–´: /ì¹´ì§€ë…¸, /ë¡œë˜ì •ë³´, /ìŠ¤í”¼ë˜, /êµ¬ë§¤(7, 14)"
            },
            "6": { 
                title: "â›ï¸ [ìƒì‚° ë° ì•½íƒˆ í™œë™ ê°€ì´ë“œ]", 
                text: "1. ë°©ì¹˜í˜• ê´‘ì‚° (/ê´‘ì‚°ì‹œì‘)\nâ€¢ [ìˆ˜ìµ ëˆ„ì ]: ì‹œì‘ í›„ ë´‡ì„ ì‚¬ìš©í•˜ì§€ ì•Šì•„ë„ ë¶„ë‹¹ í¬ì¸íŠ¸ê°€ ìë™ ì ë¦½ë©ë‹ˆë‹¤.\nâ€¢ [ì±„ë¬´ì ë²„í”„]: í˜„ì¬ ë¹š(ëŒ€ì¶œ+ì‚¬ì±„)ì´ ë‚´ ì‹ ìš©í•œë„ì˜ 80%ë¥¼ ë„˜ìœ¼ë©´ ì ˆë°•í•œ ê·¼ë¡œ ì˜ì§€ê°€ ë°œë™í•˜ì—¬ ì±„êµ´ íš¨ìœ¨ì´ 1.5ë°°ë¡œ í­ì¦í•©ë‹ˆë‹¤.\nâ€¢ [í¬ê·€ ê´‘ë¬¼]: êµ¬ë¦¬, ê¸ˆ, ë‹¤ì´ì•„ëª¬ë“œ ë°œê²¬ ì‹œ ìˆ˜ì‹­ ë°°ì˜ ë³´ë„ˆìŠ¤ ìˆ˜ìµì„ ì–»ìŠµë‹ˆë‹¤.\nâ€¢ [ìœ ë¬¼ ì¡°ê°]: 0.1% í™•ë¥ ë¡œ ë°œê²¬í•˜ë©°, 50ê°œë¥¼ ëª¨ìœ¼ë©´ [ë„êµ´ì™•] ì‘ìœ„ë¥¼ ìˆ˜ì—¬ë°›ìŠµë‹ˆë‹¤.\n\n2. ê°•íƒœê³µì˜ ë‚šì‹œ (/ë‚šì‹œ)\nâ€¢ [ì¿¨íƒ€ì„]: 10ë¶„ë§ˆë‹¤ 1íšŒ ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. \nâ€¢ [ì–´ì¢… ë“±ê¸‰]: ì†¡ì‚¬ë¦¬ë¶€í„° ì „ì„¤ì˜ ë—ë”(ìµœëŒ€ 6ë§ŒP)ê¹Œì§€ ì¡´ì¬í•©ë‹ˆë‹¤. [ë‚šì‹œì™•] ì¹­í˜¸ ì¥ì°© ì‹œ íŒë§¤ ìˆ˜ìµì´ 20% ì¶”ê°€ë©ë‹ˆë‹¤.\n\n3. ê·¸ë¦¼ì í™œë™: ë„ë‘‘ì§ˆ (/ë„ë‘‘ì§ˆ)\nâ€¢ [ê°•íƒˆ]: íƒ€ì¸ì˜ í˜„ê¸ˆ ì¤‘ 10%ë¥¼ ëª°ë˜ í›”ì³ì˜µë‹ˆë‹¤. ì„±ê³µê¹Œì§€ 30ì´ˆê°€ ê±¸ë¦¬ë©°, ë„êµ´ì™• ì¡°ê°ì„ í•¨ê»˜ í›”ì¹  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.\nâ€¢ [ë°©ì–´]: í”¼í•´ìëŠ” 30ì´ˆ ë‚´ì— [ì¡ì•˜ë‹¤ìš”ë†ˆ]ì„ ì…ë ¥í•˜ì—¬ í˜„í–‰ë²”ìœ¼ë¡œ ì²´í¬ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì²´í¬ëœ ë„ë‘‘ì€ ë²Œê¸ˆê³¼ í•¨ê»˜ 1ì‹œê°„ ë™ì•ˆ ì§•ì—­ì— ì²˜í•´ì§‘ë‹ˆë‹¤.\n\nğŸ’¡ ê´€ë ¨ ëª…ë ¹ì–´: /ê´‘ì‚°ì‹œì‘, /ê´‘ì‚°ì •ë³´, /ê´‘ì‚°ì¢…ë£Œ, /ë‚šì‹œ, /ë„ë‘‘ì§ˆ, ì¡ì•˜ë‹¤ìš”ë†ˆ"
            },
            "7": { 
                title: "ğŸ’ [ê°€ë°© ë° ì•„ì´í…œ ìˆ˜ì§‘ ê°€ì´ë“œ]", 
                text: "1. ì¸ë²¤í† ë¦¬ ê´€ë¦¬ (/ê°€ë°©)\nâ€¢ [ì¥ì°© ë° ê´€ë¦¬]: ë³´ìœ í•œ ì•„ì´ì½˜ê³¼ ì¹­í˜¸, ì†Œëª¨í’ˆ(ë°©ì–´ê¶Œ, ìŠ¹ê¸‰ê¶Œ), ìˆ˜ì§‘í’ˆ(ìœ ë¬¼ ì¡°ê°, ë“±ê¸°ë¶€)ì„ í™•ì¸í•©ë‹ˆë‹¤.\nâ€¢ [/ì¥ì°© ë²ˆí˜¸]: ê°€ë°© ì†ì˜ ì•„ì´í…œì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ë‹‰ë„¤ì„ì— ì ìš©í•©ë‹ˆë‹¤. (ì‹ ìš©ë¶ˆëŸ‰ìëŠ” ì¥ì°© ë¶ˆê°€)\n\n2. ì•„ì´í…œ ë¶„í•´ ë° ëœë¤ë°•ìŠ¤\nâ€¢ [/ë¶„í•´ ë²ˆí˜¸]: í•„ìš” ì—†ëŠ” ì•„ì´ì½˜ì„ ë¶„í•´í•˜ì—¬ 'ë°•ìŠ¤ ì¡°ê°'ì„ ì–»ìŠµë‹ˆë‹¤. ì¡°ê° 5ê°œë¥¼ ëª¨ìœ¼ë©´ 'ëœë¤ë°•ìŠ¤ ì´ìš©ê¶Œ' 1ë§¤ë¡œ ìë™ ë³€í™˜ë©ë‹ˆë‹¤.\nâ€¢ [ëœë¤ë°•ìŠ¤]: ì´ìš©ê¶Œì„ ì‚¬ìš©í•´ ë…¸ë§ë¶€í„° ë ˆì „ë”ë¦¬ ë“±ê¸‰ê¹Œì§€ì˜ í¬ê·€ ì•„ì´ì½˜ì„ ë½‘ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¯¸ ê°€ì§„ ì•„ì´ì½˜ì´ ë‚˜ì˜¤ë©´ ë‹¤ì‹œ ì¡°ê°ìœ¼ë¡œ í™˜ë¶ˆë©ë‹ˆë‹¤.\n\n3. ìˆ˜ì§‘ ì—…ì  ì¹­í˜¸\nâ€¢ [ìˆ˜ì§‘ëŒ€ë§ˆì™•]: ì„œë²„ì˜ ëª¨ë“  ì•„ì´ì½˜ì„ í•œ ë²ˆì´ë¼ë„ ë³´ìœ í–ˆë˜ ìœ ì €ì—ê²Œ ë¶€ì—¬ë©ë‹ˆë‹¤. íš¨ê³¼ë¡œ ëª¨ë“  ìƒì  ë¬¼í’ˆ 15% ìƒì‹œ í• ì¸ì„ ì œê³µí•©ë‹ˆë‹¤.\nâ€¢ [ë„êµ´ì™•]: ìœ ë¬¼ ì¡°ê° 50ê°œë¥¼ ëª¨ì€ ì „ì„¤ì ì¸ ê³ ê³ í•™ìì—ê²Œ ë¶€ì—¬ë˜ë©°, ê´‘ë¬¼ ë°œê²¬ í™•ë¥ ì´ ëŒ€í­ ìƒìŠ¹í•©ë‹ˆë‹¤.\n\nğŸ’¡ ê´€ë ¨ ëª…ë ¹ì–´: /ê°€ë°©, /ì¥ì°©, /ë¶„í•´, /ì•„ì´ì½˜ì´ˆê¸°í™”"
            },
            "8": { 
                title: "ğŸ›ï¸ [ê°€ìƒ ì •ë¶€ ë° ì •ì±… ê°€ì´ë“œ]", 
                text: "1. ì˜íšŒ ì•ˆê±´ ë° íˆ¬í‘œ (/ì˜íšŒ)\nâ€¢ [ì¼ì •]: ë§¤ì¼ 20:00 ì•ˆê±´ ìƒì • â†’ 23:50 íˆ¬í‘œ ë§ˆê° â†’ ìµì¼ 00:05 ì •ì±… ë°œíš¨.\nâ€¢ [ê°€ì¤‘ íˆ¬í‘œ]: í‹°ì–´ê°€ ë†’ì„ìˆ˜ë¡ 1ì¸ì´ í–‰ì‚¬í•˜ëŠ” í‘œìˆ˜ê°€ ë§ì•„ì§‘ë‹ˆë‹¤. (ì•„ì´ì–¸ 1í‘œ ~ ë‹¤ì´ì•„ ì´ìƒ 3í‘œ)\nâ€¢ [ì°¸ì—¬ ë³´ìƒ]: íˆ¬í‘œì— ì°¸ì—¬í•œ ëª¨ë“  ìœ ì €ì—ê²ŒëŠ” êµ­ê³ ì—ì„œ ê±°ë§ˆë¹„ 2,000Pë¥¼ ì¦‰ì‹œ ì§€ê¸‰í•©ë‹ˆë‹¤.\n\n2. ì •ì±…ì˜ ì˜í–¥ë ¥\nâ€¢ íˆ¬í‘œ ê²°ê³¼ì— ë”°ë¼ ë¶€ë™ì‚° ì–‘ë„ì„¸, ê´‘ì‚° íš¨ìœ¨, ëŒ€ì¶œ í•œë„, ê²½ì°° ì¶œë™ í™•ë¥  ë“±ì´ ì„œë²„ ì „ì²´ì ìœ¼ë¡œ ë³€ë™ë©ë‹ˆë‹¤. ë‹¹ì‹ ì˜ í•œ í‘œê°€ êµ­ê°€ ê²½ì œë¥¼ ë°”ê¿‰ë‹ˆë‹¤.\n\n3. êµ­ê°€ ë¯¼ìƒ ì§€ì›ê¸ˆ\nâ€¢ [ìì‚° ë°°ë¶„]: ì‹¤ì§ˆ ìˆœìì‚°ì´ ì„œë²„ í‰ê· ì˜ 40% ë¯¸ë§Œìœ¼ë¡œ ë–¨ì–´ì§„ ìœ ì €ì—ê²ŒëŠ” ì¤‘ì•™ì€í–‰ì´ í•˜ë£¨ í•œ ë²ˆ ê¸´ê¸‰ ìƒê³„ë¹„ë¥¼ ì§€ì›í•©ë‹ˆë‹¤. ì±„íŒ… ì…ë ¥ ì‹œ ìë™ ê°ì§€ë˜ì–´ ì§€ê¸‰ë©ë‹ˆë‹¤.\n\nğŸ’¡ ê´€ë ¨ ëª…ë ¹ì–´: /ì˜íšŒ, /íˆ¬í‘œ ì°¬ì„±/ë°˜ëŒ€"
            },
            "9": {
                title: "ğŸ‘‘ [ë‚´ë¦¬ë‹¤ ì„œë²„: ê³µì‹ ì‘ìœ„ ë° ì¹­í˜¸ ë§ˆìŠ¤í„° ê°€ì´ë“œ]",
                text: "ë¶„ì•¼ë³„ ì„±ì·¨ë¥¼ í†µí•´ ê³ ìœ í•œ íŠ¹ê¶Œê³¼ ëª…ì˜ˆë¥¼ ìŸì·¨í•˜ì‹­ì‹œì˜¤.\nâ€» ì¹­í˜¸ëŠ” ë°˜ë“œì‹œ ì¥ì°©í•´ì•¼ íš¨ê³¼ê°€ ë°œë™ë©ë‹ˆë‹¤. ([/ì¥ì°© ë²ˆí˜¸])\n\nâœ¨ [ì „ì„¤ì˜ ë…ë¦½ ì‘ìœ„: ê³ ìœ  íš¨ê³¼]\në¶„ì•¼ë³„ ì •ì ì— ë„ë‹¬í•˜ê±°ë‚˜ íŠ¹ìˆ˜ ì¡°ê±´ì„ ë§Œì¡±í•´ì•¼ ì–»ì„ ìˆ˜ ìˆëŠ” ìœ ì¼ë¬´ì´í•œ ì¹­í˜¸ì…ë‹ˆë‹¤.\n\nâ€¢ ğŸ° ì „ì„¤ì˜ í°ì†\n  - ì¡°ê±´: ë¶€ë™ì‚° ë“±ê¸°ë¶€ 10ì¥ ìˆ˜ì§‘ ì™„ë£Œ\n  - íš¨ê³¼: ë§¤ì¼ ìì • ëœë“œë§ˆí¬ ë°°ë‹¹ê¸ˆ 10% ì¶”ê°€ ì§€ê¸‰ (ì¥ì°© ì‹œ ì‹¤ì‹œê°„ ì¡°íšŒ ë°˜ì˜)\n  - â€» ë‹‰ë„¤ì„ ì• ì „ìš© ì•„ì´ì½˜(ğŸ°) ìë™ í‘œì‹œ\n\nâ€¢ ğŸ´â€â˜ ï¸ í•´ì ì™•\n  - ì¡°ê±´: ëˆ„ì  ì•½íƒˆ ì„±ê³µ 150íšŒ ë‹¬ì„±\n  - íš¨ê³¼: ì•½íƒˆ ì†Œìš” ì‹œê°„ 30% ë‹¨ì¶• & ê¸°ë³¸ ì¼ê¸‰ 50% ì¶”ê°€ ë³´ë„ˆìŠ¤\n  - â€» ë‹‰ë„¤ì„ ì• ì „ìš© ì•„ì´ì½˜(ğŸ´â€â˜ ï¸) ìë™ í‘œì‹œ\n\nâ€¢ âš“ ì œí•´ì™•\n  - ì¡°ê±´: ëˆ„ì  í† ë²Œ ì„±ê³µ 150íšŒ ë‹¬ì„±\n  - íš¨ê³¼: í† ë²Œ í˜„ìƒê¸ˆ 20% ë³´ë„ˆìŠ¤ & ê¸°ë³¸ ì¼ê¸‰ 50% ì¶”ê°€ ë³´ë„ˆìŠ¤\n  - â€» ë‹‰ë„¤ì„ ì• ì „ìš© ì•„ì´ì½˜(âš“) ìë™ í‘œì‹œ\n\nâ€¢ ğŸ”± í•´ìƒì™•\n  - ì¡°ê±´: ëˆ„ì  ë¬´ì—­ 200íšŒ ë‹¬ì„±\n  - íš¨ê³¼: í•­í•´ ì¬í•´(ë””ë²„í”„) ë°œìƒ í™•ë¥  50% ê°ì†Œ\n  - â€» ë‹‰ë„¤ì„ ì• ì „ìš© ì•„ì´ì½˜(ğŸ”±) ìë™ í‘œì‹œ\n\nâ€¢ âšœï¸ ë„êµ´ì™•\n  - ì¡°ê±´: ìœ ë¬¼ ì¡°ê° 50ê°œ ìˆ˜ì§‘ ì™„ë£Œ\n  - íš¨ê³¼: ì±„êµ´ ì‹œ í¬ê·€ ê´‘ë¬¼(êµ¬ë¦¬/ê¸ˆ/ë‹¤ì´ì•„) ë°œê²¬ í™•ë¥  20% ìƒìŠ¹\n  - â€» ë‹‰ë„¤ì„ ì• ì „ìš© ì•„ì´ì½˜(âšœï¸) ìë™ í‘œì‹œ\n\nâ€¢ ğŸ‡ ê²½ë§ˆì™•\n  - ì¡°ê±´: ê²½ë§ˆ ì „ìš© ì¥ë¹„ 4ì¢… ìˆ˜ì§‘ ì™„ë£Œ\n  - íš¨ê³¼: ê²½ë§ˆ ë°°íŒ… ì·¨ì†Œ ìœ„ì•½ê¸ˆ(10%) ì „ì•¡ ë©´ì œ\n\nâ€¢ ğŸµï¸ ìˆ˜ì§‘ëŒ€ë§ˆì™•\n  - ì¡°ê±´: ì„œë²„ ë‚´ ëª¨ë“  ì¢…ë¥˜ì˜ ì•„ì´ì½˜ ìˆ˜ì§‘ ì™„ë£Œ\n  - íš¨ê³¼: ëª¨ë“  ìƒì  ë¬¼í’ˆ êµ¬ë§¤ ì‹œ 15% ìƒì‹œ í• ì¸\n  - â€» ë‹‰ë„¤ì„ ì• ì „ìš© ì•„ì´ì½˜(ğŸµï¸) ìë™ í‘œì‹œ\n\n\nğŸ“ˆ [ë‹¨ê³„ë³„ ì„±ì·¨ ì‘ìœ„: ì„±ì¥ ê°€ì´ë“œ]\në…¸ë ¥ì„ í†µí•´ í•œ ë‹¨ê³„ì”© ì˜¬ë¼ê°€ëŠ” ì„±ì¥í˜• ì¹­í˜¸ ê³„ë³´ì…ë‹ˆë‹¤.\n\nâ‘  ë¶€ë™ì‚° íˆ¬ì ê³„ë³´\n   ì„ëŒ€ì¸ (100ë§ŒP) â” ê±´ë¬¼ì£¼ (500ë§ŒP) â” íˆ¬ê¸°ì™• (1,000ë§ŒP)\n   â€» íˆ¬ê¸°ì™• íš¨ê³¼: ì§€ë¶„ ë§¤ê° ì‹œ ìµœì¢… ìˆ˜ë ¹ì•¡ì˜ 5% ë³´ë„ˆìŠ¤ ì§€ê¸‰\n\nâ‘¡ ê´‘ì‚° ê·¼ë¡œ ê³„ë³´ (ëˆ„ì  ì‹œê°„)\n   ë‘ë”ì§€ (3,000ë¶„) â” ì„ê³µ (7,000ë¶„) â” ì±„êµ´ì™• (10,000ë¶„)\n   â€» ì±„êµ´ì™• íš¨ê³¼: ì±„êµ´ ì‹œ ë¶„ë‹¹ íšë“ í¬ì¸íŠ¸ 20% ìƒì‹œ ìƒìŠ¹\n\nâ‘¢ ê³ ê³ í•™ ë°œêµ´ ê³„ë³´ (ìœ ë¬¼ ì¡°ê°)\n   ë„êµ´ê¾¼ (10ê°œ) â” íƒì‚¬ì› (20ê°œ) â” ë°œêµ´ê°€ (30ê°œ) â” íŠ¸ë ˆì €í—Œí„° (40ê°œ) â” âšœï¸ë„êµ´ì™• (50ê°œ)\n\nâ‘£ ê²½ì œ ìì‚° ê³„ë³´ (ì‹¤ì§ˆ ìˆœìì‚°)\n   ì¬ë²Œ (50ë§ŒP) â” ê±°ìƒ (100ë§ŒP) â” ë¶€í˜¸ (200ë§ŒP) â” ëŒ€ë¶€í˜¸ (350ë§ŒP) â” ìì‚°ì™• (500ë§ŒP)\n   â€» ìì‚°ì™• íš¨ê³¼: ë§¤ì¼ ìì • ì€í–‰ ì˜ˆê¸ˆ ì´ì 1.5ë°° ë³´ë„ˆìŠ¤ ì§€ê¸‰\n\nâ‘¤ ì‚¬íšŒ ë³µì§€ ê³„ë³´ (ëˆ„ì  ê¸°ë¶€)\n   ì„ í•œì†ê¸¸ (50ë§ŒP) â” ê¸°ë¶€ì²œì‚¬ (100ë§ŒP) â” ìì„ ê°€ (300ë§ŒP) â” ê¸°ë¶€ì™• (500ë§ŒP)\n   â€» ê¸°ë¶€ì™• íš¨ê³¼: ëª¨ë“  ì¢…ë¥˜ì˜ ì„¸ê¸ˆ(ì†Œë“ì„¸/ì–‘ë„ì„¸ ë“±) 50% ê°ë©´\n\nâ‘¥ í•´ìƒ ë¬´ì—­ ê³„ë³´ (ëˆ„ì  íšŸìˆ˜)\n   ê²¬ìŠµì„ ì› (50íšŒ) â” í•­í•´ì‚¬ (100íšŒ) â” ëŒ€í•­í•´ì‚¬ (150íšŒ) â” ğŸ”±í•´ìƒì™• (200íšŒ)\n\nâ‘¦ ê°•íƒœê³µ ë‚šì‹œ ê³„ë³´ (ì„±ê³µ íšŸìˆ˜)\n   ê°•íƒœê³µ (50íšŒ) â” ë„ì‹œì–´ë¶€ (150íšŒ) â” ë‚šì‹œì™• (300íšŒ)\n   â€» ë‚šì‹œì™• íš¨ê³¼: ë¬¼ê³ ê¸° íŒë§¤ ë³´ìƒ í¬ì¸íŠ¸ 20% ìƒìŠ¹\n\nâ‘§ ê·¸ë¦¼ì ê¸¸ë“œ ê³„ë³´ (ë„ë‘‘ì§ˆ ì„±ê³µ)\n   ì¢€ë„ë‘‘ (10íšŒ) â” ëŒ€ë„ (30íšŒ) â” ì•½íƒˆì™• (50íšŒ)\n   â€» ì•½íƒˆì™• íš¨ê³¼: ë„ë‘‘ì§ˆ ì‹œ ê²½ì°° ì¶œë™ í™•ë¥  ê°ì†Œ (50% â” 30%)\n\nâ‘¨ ğŸ´â€â˜ ï¸ í•´ì  ì•½íƒˆ ê³„ë³´ (ì„±ê³µ íšŸìˆ˜)\n   ë¬´ë²•ì (30íšŒ) â” ë°”ì¹´ë‹ˆì–´ (50íšŒ) â” ë¸”ë™ì„¸ì¼ (70íšŒ) â” ì»¤ì„¸ì–´ (100íšŒ) â” ğŸ´â€â˜ ï¸í•´ì ì™• (150íšŒ)\n\nâ‘© ğŸ‘® í•´êµ° í† ë²Œ ê³„ë³´ (ì„±ê³µ íšŸìˆ˜)\n   í•´ì•ˆê²½ë¹„ëŒ€ (30íšŒ) â” í•¨ëŒ€ì§€íœ˜ê´€ (50íšŒ) â” í•¨ëŒ€ì‚¬ë ¹ê´€ (70íšŒ) â” ë¡œì—´ë„¤ì´ë¹„ (100íšŒ) â” âš“ì œí•´ì™• (150íšŒ)"
            }
        };

        if (helpData[choice]) {
            var sel = helpData[choice];
            delete menuWaitState[targetUid];
            replier.reply(formatCommand(sel.title, user, sel.text, "ë‹¤ì‹œ ë³´ë ¤ë©´ [/ë„ì›€ë§]"));
        } else {
            if (msg.startsWith("/")) return false;
            replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "1~8ë²ˆ ì‚¬ì´ì˜ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."));
        }
        return true;
    }

    /* v16.7 ê³ ëŒ€ ì§€ë„ ì œì‘ ì„¸ì…˜ ì²˜ë¦¬ (ë„êµ´ì™• íšë“ì ì „ìš©) */
    else if (state.type === 'artifact_book') {
        if (msg === "ì œì‘") {
            // 1. ë„êµ´ì™• íšë“(ë³´ìœ ) ì—¬ë¶€ ì¬ê²€ì¦ (ì¸ë²¤í† ë¦¬ ìŠ¤ìº”)
            var hasDugKing = (user.inventory || []).some(function(it) { 
                return it.effect === "title" && it.title === "ë„êµ´ì™•"; 
            });

            if (!hasDugKing) {
                replier.reply(formatError(user, "ì œì‘ ê¶Œí•œ ì—†ìŒ", "ê³ ëŒ€ ì§€ë„ëŠ” [ë„êµ´ì™•] ì¹­í˜¸ë¥¼ íšë“í•œ ë¶„ë§Œ ì œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."));
                return true;
            }

            var pieces = Number(user.artifactPieces || 0);
            if (pieces < 10) {
                replier.reply(formatError(user, "ì¬ë£Œ ë¶€ì¡±", "ì§€ë„ë¥¼ ì œì‘í•˜ë ¤ë©´ ìœ ë¬¼ ì¡°ê° 10ê°œê°€ í•„ìš”í•©ë‹ˆë‹¤.\n(í˜„ì¬ ë³´ìœ : " + pieces + "ê°œ)"));
                return true;
            }

            // 2. ì œì‘ ì§‘í–‰ (ì¡°ê° 10 -> ì§€ë„ 1)
            user.artifactPieces -= 10;
            user.ancientMaps = (user.ancientMaps || 0) + 1;
            user.skipHealing = true; // ë³´ì•ˆ ì—”ì§„ ì˜ˆì™¸ í—ˆìš©
            
            var craftMsg = "ìœ ë¬¼ ì¡°ê° 10ê°œë¥¼ ì†Œëª¨í•˜ì—¬\n[ê³ ëŒ€ ì§€ë„] 1ì¥ì„ ì„±ê³µì ìœ¼ë¡œ ì œì‘í–ˆìŠµë‹ˆë‹¤!\n\n" +
                           "ğŸ—ºï¸ í˜„ì¬ ê³ ëŒ€ ì§€ë„: " + user.ancientMaps + " / 10 ì¥\n" +
                           "ğŸ§© ë‚¨ì€ ìœ ë¬¼ ì¡°ê°: " + user.artifactPieces + "ê°œ";

            replier.reply(formatCommand("ğŸ—ºï¸ ê³ ëŒ€ ì§€ë„ ì œì‘ ì„±ê³µ", user, craftMsg, "ì¶”ê°€ ì œì‘ì€ ë‹¤ì‹œ [ì œì‘]ì„ ì…ë ¥í•˜ì„¸ìš”."));
            state.time = Date.now(); // ì„¸ì…˜ ì‹œê°„ ì—°ì¥ (ì—°ì† ì œì‘ ì§€ì›)
            safeSaveData(data);
            return true;
        }
    }

    // [ìˆ˜ì •] ê¸°ì¡´ì˜ ë‹¨ë… ifë¥¼ 'else if'ë¡œ ì—°ê²°í•˜ì—¬ ë…¼ë¦¬ì  ì¶©ëŒ ë°©ì§€
    else if (state.type === 'trade_main') {
        if (user.job && (choice === "2" || choice === "3" || choice === "5")) {
            var jobTitle = (user.job === 'pirate' ? "í•´ì " : "í•´êµ°");
            replier.reply(formatError(user, "ìƒì—… í™œë™ ì œí•œ", 
                "í˜„ì¬ [" + jobTitle + "] ì‹ ë¶„ì´ë¯€ë¡œ ìƒì—…ìš© í™”ë¬¼ì„ ì ì¬í•˜ê±°ë‚˜ ì¶œí•­í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n" +
                "ì¡°í•© ì‚¬ë¬´ì†Œì—ì„œ ì€í‡´ í›„ ì´ìš©í•˜ì„¸ìš”."));
            return true; // ë¡œì§ ì¤‘ë‹¨
        }
        var myPorts = util_getUserGovernorPorts(targetUid, roomData);
        var hasGov = myPorts.length > 0;
        var tradeCfg = SYSTEM_CONFIG.TRADE;

        if (choice === "1") {
            _showTradeMarket(user, replier, roomData, tradeCfg);
            menuWaitState[targetUid] = { type: 'trade_market', time: Date.now(), depth: 2, originRoom: state.originRoom || roomName };
        } else if (choice === "2") {
            if (user.voyage && user.voyage.active === true) {
                _showVoyageStatus(user, replier, data, roomName); 
                delete menuWaitState[targetUid];
                return true;
            }
            _prepareVoyage(user, replier, tradeCfg, roomData);
            menuWaitState[targetUid] = { type: 'trade_depart', time: Date.now(), depth: 2, originRoom: state.originRoom || roomName };
        } else if (choice === "3") {
            _showVoyageStatus(user, replier, data, roomName);
            delete menuWaitState[targetUid];
        } else if (choice === "4") {
            _manageShip(user, replier, tradeCfg);
            menuWaitState[targetUid] = { type: 'trade_ship', time: Date.now(), depth: 2, originRoom: state.originRoom || roomName };
        } else if (choice === "5") {
            _showTradeShop(user, replier, roomData, tradeCfg);
            roomData.features.states.bankProcess[targetUid] = { 
                type: 'shop_buy', time: Date.now(), extra: { items: SHOP_ITEMS.filter(function(it){ return it.cat === 6; }) } 
            };
            delete menuWaitState[targetUid];
        } else if (choice === "6") {
            if (hasGov) {
                _showGovernorOffice(user, replier, roomData, myPorts);
                menuWaitState[targetUid] = { type: 'trade_governor_office', time: Date.now(), depth: 2, myPorts: myPorts, originRoom: state.originRoom || roomName };
            } else {
                _showJobEnlistmentMenu(user, replier, roomData, targetUid);
            }
        } else if (choice === "7" && hasGov) {
            _showJobEnlistmentMenu(user, replier, roomData, targetUid);
        } else {
            if (msg.startsWith("/")) return false;
            replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "1~" + (hasGov ? 7 : 6) + "ë²ˆ ì‚¬ì´ë¥¼ ì„ íƒí•˜ì„¸ìš”."));
        }
        return true;
    }

    /* [ì„œë¸Œ ìƒíƒœ í•¸ë“¤ëŸ¬ ë¡œì§êµ° - ì „ì²´ else if ì—°ê²°] */
    else if (state.type === 'trade_job_enlist') { _handleJobJoin(choice, user, data, replier, roomName, targetUid); return true; }
    else if (state.type === 'trade_governor_office') { _handleGovernorSettlement(msg, user, data, replier, roomName, targetUid); return true; }
    else if (state.type === 'trade_job_settlement') { _handleJobSettlement(msg, user, data, replier, roomName, targetUid); return true; }
    else if (state.type === 'trade_select_cargo') { _handleTradeCargoSelection(msg, user, data, replier, roomName, targetUid, tradeCfg); return true; }
    else if (state.type === 'trade_pirate_menu') {
        if (choice === "1") _showRaidList(user, replier, data, roomName, targetUid);
        else if (choice === "2") _showPirateInfo(user, replier);
        else if (choice === "3") _processPirateRetire(user, data, replier, roomName, targetUid);
        else if (choice === "4") _processPirateDailyWage(user, data, replier, roomName, targetUid); // í•´ì  ë„ì‹œ ì •ì‚°
        else if (choice === "5") {
            var item = SHOP_ITEMS.filter(function(it){ return it.id === 106; })[0];
            var price = getItemPrice(item, user, logicRoom);
            if (Number(user.point) < price) {
                replier.reply(formatError(user, "ìê¸ˆ ë¶€ì¡±", fp(price) + "Pê°€ í•„ìš”í•©ë‹ˆë‹¤."));
            } else {
                bankProcessState[targetUid] = { type: 'ship_rename_input', time: Date.now(), extra: { price: price } };
                delete menuWaitState[targetUid];
                var renameBody = "ìƒˆë¡œìš´ ì„ ë°•ì˜ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(2~8ì, ë„ì–´ì“°ê¸° ì¸ì‹ ê°€ëŠ¥)\n\n" + "â†©ï¸ ë’¤ë¡œ / ğŸ  ì²˜ìŒìœ¼ë¡œ / âì·¨ì†Œ";
                replier.reply(formatCommand("ğŸ“ ì„ ë°• ì´ë¦„ ë³€ê²½", user, renameBody, "ì·¨ì†Œ: [ì·¨ì†Œ]"));
            }
        }
        else if (choice === "6") _processPirateBail(user, data, replier, roomName, targetUid); // ë³´ì„ê¸ˆ ë‚©ë¶€
        else replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "ì˜¬ë°”ë¥¸ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”."));
        return true;
    }
    else if (state.type === 'trade_navy_menu') {
        if (choice === "1") _showBattleList(user, replier, roomData, targetUid, roomName);
        else if (choice === "2") _showNavyInfo(user, replier);
        else if (choice === "3") _processNavyRetire(user, data, replier, roomName, targetUid);
        else if (choice === "4") _processNavyDailyWage(user, data, replier, roomName, targetUid);
        else if (choice === "5") {
            var item = SHOP_ITEMS.filter(function(it){ return it.id === 106; })[0];
            var price = getItemPrice(item, user, logicRoom);
            if (Number(user.point) < price) {
                replier.reply(formatError(user, "ìê¸ˆ ë¶€ì¡±", fp(price) + "Pê°€ í•„ìš”í•©ë‹ˆë‹¤."));
            } else {
                bankProcessState[targetUid] = { type: 'ship_rename_input', time: Date.now(), extra: { price: price } };
                delete menuWaitState[targetUid];
                var renameBody = "ìƒˆë¡œìš´ ì„ ë°•ì˜ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(2~8ì, ë„ì–´ì“°ê¸° ì¸ì‹ ê°€ëŠ¥)\n\n" + "â†©ï¸ ë’¤ë¡œ / ğŸ  ì²˜ìŒìœ¼ë¡œ / âì·¨ì†Œ";
                replier.reply(formatCommand("ğŸ“ ì„ ë°• ì´ë¦„ ë³€ê²½", user, renameBody, "ì·¨ì†Œ: [ì·¨ì†Œ]"));
            }
        }
        else replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "ì˜¬ë°”ë¥¸ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”."));
       return true;
    }

    else if (state.type === 'trade_raid_list') {
        // [ë°©ì–´] ë©”ì¸ë°© ë°ì´í„°ì— ì•½íƒˆ ì„¸ì…˜ ì €ì¥ì†Œê°€ ì—†ëŠ” ê²½ìš° ì¦‰ì‹œ ìƒì„±í•˜ì—¬ í¬ë˜ì‹œ ë°©ì§€
        if (!data.rooms["ë‚´ë¦¬ë‹¤"].features.activePillages) data.rooms["ë‚´ë¦¬ë‹¤"].features.activePillages = {};
        _handlePillageSelect(choice, user, data, replier, roomName, targetUid);
        return true;
    }
    else if (state.type === 'trade_battle_list') {
        if (!data.rooms["ë‚´ë¦¬ë‹¤"].features.activePillages) data.rooms["ë‚´ë¦¬ë‹¤"].features.activePillages = {};
        _handleCombatSelect(choice, user, data, replier, roomName, targetUid);
        return true;
    }

   /* í•¨ì„  ì´ˆì›” ê°•í™” í™•ì • í•¸ë“¤ëŸ¬ (ì—°ì† ê°•í™” ë£¨í”„ í†µí•©) */
    else if (state.type === 'trade_enh_confirm') {
        if (msg === "1" || msg === "ì˜ˆ") {
            var res = user.tempEnh;
            if (!res) {
                replier.reply(formatError(user, "ë°ì´í„° ìœ ì‹¤", "ê°•í™” ì„ì‹œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."));
                delete menuWaitState[targetUid];
            } else {
                // ê°•í™” ìˆ˜ì¹˜ ëˆ„ì  ë°˜ì˜
                user.enhLimit = (user.enhLimit || 0) + res.limit;
                user.enhTime = (user.enhTime || 0) + res.time;
                user.enhProfit = (user.enhProfit || 0) + res.profit;
                user.tempEnh = null; // ì„ì‹œ ë°ì´í„° ì†Œê°

                // ì„¸ì…˜ ìœ ì§€ ë° ì¬ì‹œë„ ìƒíƒœë¡œ ì „í™˜
                state.type = 'trade_enh_retry';
                state.time = Date.now();
                
                var successBody = "ì„ ë°•ì— ìƒˆë¡œìš´ ì„±ëŠ¥ì´ ê°ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n" +
                                 "ğŸ” ê°•í™” / â ì·¨ì†Œ";
                replier.reply(formatCommand("âœ… ì´ˆì›” ê°•í™” ì™„ë£Œ", user, successBody, "ì¶”ê°€ ê°•í™”ë¥¼ ì›í•˜ì‹œë©´ [ê°•í™”]ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
            }
        } else {
            // [ìˆ˜ì •] ì•„ë‹ˆì˜¤(ìœ ì§€) ì„ íƒ ì‹œì—ë„ ì„¸ì…˜ì„ ìœ ì§€í•˜ì—¬ ì¦‰ì‹œ ì¬ë„ì „ ê¸°íšŒ ì œê³µ
            user.tempEnh = null;
            state.type = 'trade_enh_retry';
            state.time = Date.now();

            var maintainBody = "ê¸°ì¡´ ìˆ˜ì¹˜ë¥¼ ê·¸ëŒ€ë¡œ ìœ ì§€í•©ë‹ˆë‹¤.\n\n" +
                               "ğŸ” ê°•í™” / â ì·¨ì†Œ";
            replier.reply(formatCommand("ğŸš« ìœ ì§€ ê²°ì •", user, maintainBody, "ì¶”ê°€ ê°•í™”ë¥¼ ì›í•˜ì‹œë©´ [ê°•í™”]ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
        }
        safeSaveData(data);
        return true;
    }

    /* ì´ˆì›” ê°•í™” ì—°ì† ì‹œë„ í•¸ë“¤ëŸ¬ (ê°•í™” ì…ë ¥ ì‹œ ë¡¤ë§ ë£¨í”„ ë°œìƒ) */
    else if (state.type === 'trade_enh_retry') {
        var input = msg.trim();
        if (input === "ê°•í™”" || input === "ğŸ”") {
            // ì„¹í„° 51ì˜ ê°•í™” ë¡œì§ ì‹¤í–‰ (ë¹„ìš© ì°¨ê° í›„ ë‹¤ì‹œ 'trade_enh_confirm'ìœ¼ë¡œ ë³µê·€í•¨)
            _processShipEnhanceRoll(user, data, replier, roomName);
        } else if (input === "ì·¨ì†Œ" || input === "â") {
            delete menuWaitState[targetUid];
            replier.reply(formatCommand("ğŸšª ê°•í™” ì¢…ë£Œ", user, "í•¨ì„  ì´ˆì›” ê°•í™” ì‘ì—…ì„ ë§ˆì¹©ë‹ˆë‹¤."));
        } else {
            // ë‹¤ë¥¸ ì…ë ¥ ì‹œ ê°€ì´ë“œ ì¶œë ¥ ë° ì„¸ì…˜ ìœ ì§€ (30ì´ˆ ìë™ ë§Œë£Œ ì‹œìŠ¤í…œ ì‘ë™ ì¤‘)
            replier.reply(formatError(user, "ì…ë ¥ ì˜¤ë¥˜", "[ê°•í™”] ë˜ëŠ” [ì·¨ì†Œ]ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.\n\nğŸ” ê°•í™” / â ì·¨ì†Œ"));
        }
        return true;
    }

    // 3. í†µí•© ë„¤ë¹„ê²Œì´ì…˜: ì²˜ìŒìœ¼ë¡œ ì´ë™

    if (msg === "ì²˜ìŒìœ¼ë¡œ" || msg === "ğŸ  ì²˜ìŒìœ¼ë¡œ") {

        if (state.type.startsWith('help')) return _handleHelpEntry(replier, targetUid, menuWaitState);

        if (state.type.startsWith('guide')) return _handleGuideEntry(replier, targetUid, menuWaitState);

        if (state.type.startsWith('shop')) { delete menuWaitState[targetUid]; return _gameShopLogic("/ìƒì ", user, data, replier, roomName, targetUid); }

        if (state.type.startsWith('trade')) { delete menuWaitState[targetUid]; return _gameTradeLogic("/ë¬´ì—­", user, data, replier, roomName, targetUid); }

        if (state.type.startsWith('casino')) { delete menuWaitState[targetUid]; return _gameCasinoLogic("/ì¹´ì§€ë…¸", user, data, replier, roomName, targetUid); }

    }



    // 4. í†µí•© ë„¤ë¹„ê²Œì´ì…˜: ë’¤ë¡œê°€ê¸° ì´ë™

    if (msg === "ë’¤ë¡œ" || msg === "â†©ï¸ ë’¤ë¡œ") {

        // A. ë¬´ì—­ ì„œë¸Œë©”ë‰´ -> ë¬´ì—­ ë©”ì¸

        if (state.type.startsWith('trade_') && state.type !== 'trade_main') {

            // [3ë‹¨ê³„ -> 2ë‹¨ê³„] í•˜ì—­ ì„¤ì • ì¤‘ì´ë¼ë©´ ì¶œí•­ì§€ ì„ íƒ í™”ë©´ìœ¼ë¡œ ë³µê·€

            if (state.type === 'trade_select_cargo') {

                state.type = 'trade_depart'; 

                state.depth = 2; 

                state.time = Date.now();

                _prepareVoyage(user, replier, SYSTEM_CONFIG.TRADE, data.rooms[logicRoom]);

                return true;

            }

            

            // [2ë‹¨ê³„ -> 1ë‹¨ê³„] ê·¸ ì™¸ ëª¨ë“  ì„œë¸Œë©”ë‰´(ì´ë…ì‹¤, ì‹œì„¸ ë“±)ì—ì„œëŠ” ë¬´ì—­ ë©”ì¸ìœ¼ë¡œ ë³µê·€

            delete menuWaitState[targetUid];

            return _gameTradeLogic("/ë¬´ì—­", user, data, replier, roomName, targetUid);

        }



        // B. ì¹´ì§€ë…¸ ì„œë¸Œë©”ë‰´ -> ì¹´ì§€ë…¸ ë©”ì¸

        if (state.type.startsWith('casino_') && state.type !== 'casino_main') {

            return _gameCasinoLogic("/ì¹´ì§€ë…¸", user, data, replier, roomName, targetUid);

        }



        // C. ìƒì  ìƒì„¸ -> ìƒì  ì¹´í…Œê³ ë¦¬

        if (state.type === 'shop_detail') {

            return _gameShopLogic("/ìƒì ", user, data, replier, roomName, targetUid);

        }



        // D. ì¡°íšŒí˜• ë©”ë‰´ (ë„ì›€ë§/ê°€ì´ë“œ) ê³„ì¸µ ì´ë™

        if (state.type === 'help_cat') return _handleHelpEntry(replier, targetUid, menuWaitState);

        if (state.type === 'guide_detail') return _handleGuideEntry(replier, targetUid, menuWaitState);

        if (state.type === 'help_item') {

            return _handleHelpCategory(replier, user, state.extra.cat, targetUid, menuWaitState, NAV_BAR);

        }

        if (state.type === 'help') { delete menuWaitState[targetUid]; replier.reply("ğŸ“– ì´ìš©ì„ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤."); return true; }



        // E. ê·¸ ì™¸ ìµœìƒìœ„ ë©”ë‰´ì—ì„œ ë’¤ë¡œëŠ” ì¢…ë£Œ ì²˜ë¦¬

        delete menuWaitState[targetUid];

        replier.reply(formatCommand("ğŸšª ë©”ë‰´ ì¢…ë£Œ", user, "ì´ì „ í™”ë©´ì´ ì—†ì–´ í‡´ê±°í•©ë‹ˆë‹¤."));

        return true;

    }

     /* [ê¸°ëŠ¥ 1] ìƒì  ì¹´í…Œê³ ë¦¬ ì„ íƒ */
    else if (state.type === 'shop_category') {
        var catId = parseInt(choice);
        if (isNaN(catId) || !SHOP_CATEGORIES[catId]) {
            delete menuWaitState[targetUid];
            replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "ì˜¬ë°”ë¥¸ ì¹´í…Œê³ ë¦¬ ë²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."));
        } 
        // 5ë²ˆ(íŠ¹ìˆ˜/ë³µê¶Œ) ì¹´í…Œê³ ë¦¬ ì„ íƒ ì‹œ ì„œë¸Œ ë©”ë‰´ë¡œ ë¶„ê¸°
        else if (catId === 5) {
            menuWaitState[targetUid] = { type: 'shop_detail', category: '5', time: Date.now() };
            
            // [ìˆ˜ì •] ìŠ¤í”¼ë˜ ê°€ê²© ìë™ ê³„ì‚° (ì„¤ì •ê°’ * ë¬¼ê°€ë°°ìœ¨)
            var spittoBase = SYSTEM_CONFIG.ECO.SPITTO.PRICE;
            var spittoPrice = Math.floor(spittoBase * util_getEcoMultiplier(roomName));

            var lotteryMenu = "ì›í•˜ì‹œëŠ” ë³µê¶Œ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.\n\n" +
                              "1. ë¡œë˜ (ì¶”ì²¨ì‹: 22:00 ë°œí‘œ)\n" +
                              "2. ìŠ¤í”¼ë˜ (ì¦‰ì„ì‹: " + fp(spittoPrice) + "P)";
            
            replier.reply(formatCommand("ğŸ« íŠ¹ìˆ˜/ë³µê¶Œ ìƒì ", user, lotteryMenu, "ì·¨ì†Œ: [ì·¨ì†Œ] / ì…ë ¥ ëŒ€ê¸°: 30ì´ˆ"));
        }

        else if (catId === 6) {
            var filteredItems = [];
            for (var i = 0; i < SHOP_ITEMS.length; i++) {
                if (SHOP_ITEMS[i].cat === 6) filteredItems.push(SHOP_ITEMS[i]);
            }
            var list = [];
            for (var j = 0; j < filteredItems.length; j++) {
                var item = filteredItems[j];
                list.push((j + 1) + ". " + item.icon + " " + item.name + " : " + fp(getItemPrice(item, user, roomName)) + "P");
            }
            // ìƒì  êµ¬ë§¤ ëŒ€ê¸° ìƒíƒœë¡œ ì „í™˜
            bankProcessState[targetUid] = { type: 'shop_buy', time: Date.now(), extra: { items: filteredItems } };
            delete menuWaitState[targetUid]; 
            var shopContent = list.join("\n") + "\n\nğŸ’° ë³´ìœ  í¬ì¸íŠ¸: " + fp(user.point) + "P";
            replier.reply(formatCommand("ğŸ›’ " + SHOP_CATEGORIES[6], user, shopContent, "êµ¬ë§¤í•  ë¬¼í’ˆì˜ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
        }

        else {
            var filteredItems = [];
            for (var i = 0; i < SHOP_ITEMS.length; i++) {
                if (SHOP_ITEMS[i].cat === catId) filteredItems.push(SHOP_ITEMS[i]);
            }

            if (filteredItems.length === 0) {
                delete menuWaitState[targetUid];
                replier.reply(formatSimple("ğŸ›’ ìƒì  ì•Œë¦¼", "í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì— ë¬¼í’ˆì´ ì—†ìŠµë‹ˆë‹¤.", "ë‹¤ë¥¸ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”."));
            } else {
                var list = [];
                for (var j = 0; j < filteredItems.length; j++) {
                    var item = filteredItems[j];
                    list.push((j + 1) + ". " + item.icon + " " + item.name + " : " + fp(getItemPrice(item, user, roomName)) + "P");
                }
                bankProcessState[targetUid] = { type: 'shop_buy', time: Date.now(), extra: { items: filteredItems } };
                delete menuWaitState[targetUid]; // ë©”ë‰´ ëŒ€ê¸° í•´ì œ -> ìƒì  êµ¬ë§¤ ëŒ€ê¸° ì§„ì…
                var shopContent = list.join("\n") + "\n\nğŸ’° ë³´ìœ  í¬ì¸íŠ¸: " + fp(user.point) + "P";
                replier.reply(formatCommand("ğŸ›’ " + SHOP_CATEGORIES[catId], user, shopContent, "êµ¬ë§¤í•  ë¬¼í’ˆì˜ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
            }
        }
        return true;
    } 

    /* [ê¸°ëŠ¥ 2] í•­êµ¬ íˆ¬ì ëŒ€ìƒ ì„ íƒ ì²˜ë¦¬ */
   else if (state.type === 'trade_market') {
        var nations = Object.keys(tradeCfg.NATIONS);
        var idx = parseInt(choice) - 1;

        if (isNaN(idx) || idx < 0 || idx >= nations.length) {
            replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "1~5ë²ˆ ì‚¬ì´ì˜ í•­êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”."));
            return true;
        }

        // ìˆ˜ì •: user.job !== null ëŒ€ì‹  Truthy ì²´í¬ë¥¼ ì‚¬ìš©í•˜ì—¬ undefined ë° ë¹ˆê°’ ëŒ€ì‘
        if (user.job) {
            var jobName = (user.job === 'pirate') ? "í•´ì " : "í•´êµ°";
            replier.reply(formatError(user, "íˆ¬ì ê¶Œí•œ ì œí•œ", 
                "í˜„ì¬ [" + jobName + "] ì‹ ë¶„ì´ë¯€ë¡œ í•­êµ¬ íˆ¬ìê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.\n" +
                "ì¡°í•© ì‚¬ë¬´ì†Œì—ì„œ ì€í‡´í•˜ì—¬ ìƒì¸ ì‹ ë¶„ì´ ëœ í›„ ì´ìš©í•˜ì„¸ìš”."));
            return true;
        }

        var destName = nations[idx];

        // [Gemini ìš”ì²­ ì‚¬í•­] íˆ¬ì ì‹œê°„ ì œí•œ ì²´í¬ (07:00 ~ 23:59)
        var h = new Date().getHours();
        if (h < 7) {
            replier.reply(formatError(user, "íˆ¬ì ë¶ˆê°€ ì‹œê°„", "í•­êµ¬ íˆ¬ìëŠ” 07:00 ~ 23:59 ì‚¬ì´ì—ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.\n(í˜„ì¬ ì‹œê° ê¸°ì¤€ í•­ë§Œ íì‡„)"));
            return true;
        }

        var destName = nations[idx];
        var pData = (roomData.features.portData && roomData.features.portData[destName]) ? roomData.features.portData[destName] : { level: 1, totalInvest: 0, governorUid: "" };
        
        // ë©”ë‰´ ëŒ€ê¸° í•´ì œ í›„ ì‹¤ì œ ê¸ˆì•¡ ì…ë ¥ì„ ìœ„í•´ bankProcessStateë¡œ ì œì–´ê¶Œ ì´ê´€
        delete menuWaitState[targetUid];
        bankProcessState[targetUid] = { 
            type: 'trade_invest_amount', 
            time: Date.now(), 
            extra: { dest: destName } 
        };

        var govName = "ì—†ìŒ (ê³µì„)";
        if (pData.governorUid && roomData.users[pData.governorUid]) {
            var govUser = roomData.users[pData.governorUid];
            // í•­êµ¬ ì „ì²´ íˆ¬ìì•¡(totalInvest) ëŒ€ì‹  í•´ë‹¹ ì´ë…ì˜ ê°œë³„ íˆ¬ìì•¡(userInvests[uid])ì„ ê°€ì ¸ì˜´
            var govPersonalInvest = (pData.userInvests && pData.userInvests[pData.governorUid]) ? pData.userInvests[pData.governorUid] : 0;
            govName = govUser.name + " (" + fp(govPersonalInvest) + "P)";
        }

        var investBody = "ğŸ“ ëŒ€ìƒ: " + destName + " (í˜„ì¬ Lv." + pData.level + ")\n" +
                         "ğŸ“ˆ í˜„ì¬ ì„ í˜¸í’ˆ ë§¤ì…ê°€ ë³´ë„ˆìŠ¤: +" + (pData.level - 1) + "%\n" +
                         "ğŸ‘¤ í˜„ì¬ ì´ë…: " + govName + "\n\n" +
                         "íˆ¬ìí•˜ì‹¤ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n" +
                         "(ë³´ìœ  í¬ì¸íŠ¸: " + fp(user.point) + "P)\n" +
                         "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                         "ğŸ’¡ íˆ¬ìê¸ˆì€ êµ­ê³ ë¡œ ê·€ì†ë˜ë©° ë°˜í™˜ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n" +
                         "[ì·¨ì†Œ] ì…ë ¥ ì‹œ ì¤‘ë‹¨";

        replier.reply(formatCommand("ğŸ’° " + destName + " í•­êµ¬ íˆ¬ì", user, investBody));
        return true;
    }

    /* [ê¸°ëŠ¥ 1-1] ìƒì  ìƒì„¸ ì„ íƒ (ë³µê¶Œ ì¹´í…Œê³ ë¦¬ ë‚´ ë²ˆí˜¸ ì„ íƒ ì²˜ë¦¬) */
    else if (state.type === 'shop_detail') {
        delete menuWaitState[targetUid]; // ìƒì„¸ ì„ íƒ ì§„ì… ì‹œ ë©”ë‰´ ëŒ€ê¸° í•´ì œ
        
        if (state.category === '5') { // ë³µê¶Œ ì¹´í…Œê³ ë¦¬ì¸ ê²½ìš°
            if (choice === "1") { // ë¡œë˜ ì„ íƒ ì‹œ
                var lottoItem = null;
                for(var i=0; i<SHOP_ITEMS.length; i++) { 
                    if(SHOP_ITEMS[i].effect === "lotto") { lottoItem = SHOP_ITEMS[i]; break; } 
                }
                // ë¡œë˜ëŠ” ë‹¨ê¶Œ êµ¬ë§¤ì´ë¯€ë¡œ ë°”ë¡œ êµ¬ë§¤ í™•ì¸ ë‹¨ê³„ë¡œ ì´ë™
                bankProcessState[targetUid] = { type: 'shop_buy', time: Date.now(), extra: { items: [lottoItem] } };
                _handleBankStep5("1", user, data, replier, roomName, targetUid);
            } 
            else if (choice === "2") { // ìŠ¤í”¼ë˜ ì„ íƒ ì‹œ
                var spittoItem = null;
                for(var i=0; i<SHOP_ITEMS.length; i++) { 
                    if(SHOP_ITEMS[i].effect === "spitto") { spittoItem = SHOP_ITEMS[i]; break; } 
                }
                // ìŠ¤í”¼ë˜ëŠ” ì—¬ëŸ¬ ê°œ êµ¬ë§¤ê°€ ê°€ëŠ¥í•˜ë¯€ë¡œ ìˆ˜ëŸ‰ ì…ë ¥ ë‹¨ê³„ë¡œ ì´ë™
                bankProcessState[targetUid] = { type: 'shop_quantity', time: Date.now(), extra: { item: spittoItem } };
                replier.reply(formatCommand("ğŸ”¢ ìŠ¤í”¼ë˜ ìˆ˜ëŸ‰ ì…ë ¥", user, "êµ¬ë§¤í•˜ì‹¤ [ìŠ¤í”¼ë˜ ë³µê¶Œ]ì˜ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "ì·¨ì†Œ: [ì·¨ì†Œ]"));
            } 
            else {
                replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "1ë²ˆ(ë¡œë˜) ë˜ëŠ” 2ë²ˆ(ìŠ¤í”¼ë˜)ì„ ì„ íƒí•´ì£¼ì„¸ìš”."));
            }
        }
        return true;
    }

    else if (state.type === 'trade_depart') {
        if (!tradeCfg) return false; // ì „ì—­ ë³€ìˆ˜ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ê°€ë“œ
        
        var nations = Object.keys(tradeCfg.NATIONS);
        var idx = parseInt(choice) - 1;

        if (isNaN(idx) || idx < 0 || idx >= nations.length) {
            replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "1~5ë²ˆ ì‚¬ì´ì˜ ì¶œí•­ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”."));
            return true;
        }

        var destName = nations[idx];
        state.type = 'trade_select_cargo';
        state.dest = destName;       // ëª©ì ì§€ ì €ì¥
        state.selCargo = {};         // ì„ íƒí•œ ì¼ë°˜í™”ë¬¼ ì´ˆê¸°í™”
        state.selSpec = {};          // ì„ íƒí•œ íŠ¹ì‚°í’ˆ ì´ˆê¸°í™”
        state.time = Date.now();

        // ì„¹í„° 51ì— ìˆëŠ” í•¨ìˆ˜ëª…ìœ¼ë¡œ ì •í™•íˆ í˜¸ì¶œ (ì¸ì 7ê°œ ì „ë‹¬)
        _showTradeCargoSelectUI(user, replier, roomData, tradeCfg, destName, state.selCargo, state.selSpec);
        return true;
    }

        else if (state.type === 'trade_ship') {
        // [ì¶”ê°€] 'ê°•í™”' í‚¤ì›Œë“œ ì…ë ¥ ì‹œ ì²˜ë¦¬ (ìµœìš°ì„  íŒì •)
        if (msg === "ê°•í™”") {
            _processShipEnhanceRoll(user, data, replier, roomName);
            return true; // ê°•í™” í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ ì°¨ê¸° ì„¸ì…˜ì„ ìƒì„±í•˜ë¯€ë¡œ ì—¬ê¸°ì„œ ë¦¬í„´
        }

        // [ê¸°ì¡´] ê°œì¡° ë²ˆí˜¸(1ë²ˆ) ì…ë ¥ ì‹œ ì²˜ë¦¬
        if (choice === "1") {
            _processShipUpgrade(user, data, replier, roomName, tradeCfg);
            delete menuWaitState[targetUid]; // ê°œì¡° ì™„ë£Œ í›„ ì„¸ì…˜ ì¢…ë£Œ
        } else {
            // [ìˆ˜ì •] ì•ˆë‚´ ë¬¸êµ¬ì— 'ê°•í™”' í‚¤ì›Œë“œ ê°€ì´ë“œ ì¶”ê°€
            replier.reply(formatError(user, "ì…ë ¥ ì˜¤ë¥˜", "ê°œì¡°ë¥¼ ì›í•˜ì‹œë©´ [1]ë²ˆ, ê°•í™”ë¥¼ ì›í•˜ì‹œë©´ [ê°•í™”]ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
            delete menuWaitState[targetUid]; // ì˜ëª»ëœ ì…ë ¥ ì‹œ ì„¸ì…˜ ì¢…ë£Œ
        }
        return true;
    }

    /* [ê¸°íƒ€ ë¬´ì—­ ê´€ë ¨ í•¸ë“¤ëŸ¬] */
    else if (state.type === 'trade_job_enlist') { _handleJobJoin(choice, user, data, replier, roomName, targetUid); return true; }
    else if (state.type === 'trade_governor_office') { _handleGovernorSettlement(msg, user, data, replier, roomName, targetUid); return true; }
    else if (state.type === 'trade_select_cargo') { _handleTradeCargoSelection(msg, user, data, replier, roomName, targetUid, tradeCfg); return true; }
    else if (state.type === 'trade_pirate_menu') {
        if (choice === "1") _showRaidList(user, replier, data, roomName, targetUid);
        else if (choice === "2") _showPirateInfo(user, replier);
        else if (choice === "3") _processPirateRetire(user, data, replier, roomName, targetUid);
        else replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "ì˜¬ë°”ë¥¸ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”." + NAV_BAR));
        return true;
    }
    else if (state.type === 'trade_navy_menu') {
        if (choice === "1") _showBattleList(user, replier, roomData, targetUid);
        else if (choice === "2") _showNavyInfo(user, replier);
        else if (choice === "3") _processNavyRetire(user, data, replier, roomName, targetUid);
        else replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "ì˜¬ë°”ë¥¸ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”." + NAV_BAR));
        return true;
    }
    else if (state.type === 'trade_raid_list') { _handlePillageSelect(choice, user, data, replier, roomName, targetUid); return true; }
    else if (state.type === 'trade_battle_list') { _handleCombatSelect(choice, user, data, replier, roomName, targetUid); return true; }
    else if (state.type === 'trade_escort_select') { _handleEscortHire(choice, user, data, replier, roomName, targetUid); return true; }
    else if (state.type === 'trade_escort_confirm') { _handleEscortConfirm(msg, user, data, replier, roomName, targetUid, tradeCfg); return true; }
    else if (state.type.startsWith('casino_')) {
        return _gameCasinoLogic(msg, user, data, replier, roomName, targetUid);
    }

    return false;
}

//==========ì„¹í„°24==========

// ìˆ˜ì •: ì—¬ê¸°ì„œ ëª¨ë“  ì°¨ë‹¨ ë° ê°€ë“œ ë¡œì§ì„ ì¼ê´„ ì²˜ë¦¬ (ì„¹í„° 20-2ì˜ ê¸°ëŠ¥ì„ ì´ê´€ë°›ìŒ)
    if (!user) return; 

    var MAIN_NAME = "ë‚´ë¦¬ë‹¤"; 
    var is1to1 = (ALLOWED_ROOMS.indexOf(realRoom) === -1);
    var logicRoom = is1to1 ? MAIN_NAME : roomName; 

    var isGroupRoom = (ALLOWED_ROOMS.indexOf(realRoom) !== -1);

    var isAllowedCmd = (msg.startsWith("/ì¹´ì§€ë…¸") || msg.startsWith("/ë‚´ì •ë³´") || msg.startsWith("/ì€í–‰") || msg.startsWith("/ì—°ë™ì§„ë‹¨") || msg.startsWith("/ë°©ëª©ë¡") || msg.startsWith("/ê´€ë¦¬ì"));
    var inState = false;

  // 1. [ì„¸ì…˜ ê³ í–¥ ë³´ì¡´ ë° ì–‘ë°©í–¥ ë¯¸ëŸ¬ë§]
    // 1:1 ë°©ì˜ ì…ë ¥ì´ 'ë‚´ë¦¬ë‹¤' ë°©ì˜ ë°ì´í„° ì„œëì„ ë¹Œë ¤ ì“°ë”ë¼ë„, 'ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ì£¼ì†Œ'ëŠ” ë°˜ë“œì‹œ ì‹¤ì œ 1:1ë°©ìœ¼ë¡œ ê³ ì •
    var localSt = (data.rooms[roomName] && data.rooms[roomName].features) ? data.rooms[roomName].features.states : null;
    var mainSt = (data.rooms[MAIN_NAME] && data.rooms[MAIN_NAME].features) ? data.rooms[MAIN_NAME].features.states : null;

    if (is1to1 && localSt && mainSt) {
        var sKeys = ["menuWait", "selectWait", "bankProcess", "lottoPurchase"];
        sKeys.forEach(function(key) {
            var pS = localSt[key][targetUid]; // 1:1 ë°© ì„¸ì…˜
            var mS = mainSt[key][targetUid]; // ë©”ì¸ ë°© ì„¸ì…˜

            if (pS && !mS) { 
                // 1:1ë°©ì—ì„œ ì„¸ì…˜ ì‹œì‘ -> ë©”ì¸ë°© ì„œëì— ë³µì‚¬í•˜ë˜, ì£¼ì†ŒëŠ” 1:1ë°©(roomName)ìœ¼ë¡œ ë°•ì œ
                if (!pS.originRoom) pS.originRoom = roomName; 
                mainSt[key][targetUid] = pS;
            } else if (!pS && mS) { 
                // ë©”ì¸ë°©(ë‚´ë¦¬ë‹¤) ì„œëì—ë§Œ ì„¸ì…˜ì´ ìˆëŠ” ê²½ìš° 1:1ë°©ìœ¼ë¡œ ê°€ì ¸ì˜´
                // ì´ë•Œ originRoomì´ "ë‚´ë¦¬ë‹¤"ë¡œ ê¼¬ì—¬ìˆë‹¤ë©´ ê°•ì œë¡œ 1:1ë°©(roomName)ìœ¼ë¡œ êµì •
                if (!mS.originRoom || mS.originRoom === MAIN_NAME) mS.originRoom = roomName;
                localSt[key][targetUid] = mS;
            } else if (pS && mS) {
                // ì–‘ìª½ì— ë‹¤ ìˆì„ ê²½ìš°, ë¬´ì¡°ê±´ ì‹¤ì œ ë°©(roomName)ì„ ì£¼ì¸ìœ¼ë¡œ ì„ ì–¸
                pS.originRoom = roomName;
                mS.originRoom = roomName;
            }
        });
    }

    // 2. [ì„¸ì…˜ íŒì • ì—”ì§„]
    var checkSession = function(st) {
        if (!st) return null;
        var sKeys = ["menuWait", "bankProcess", "selectWait", "lottoPurchase"];
        for (var i = 0; i < sKeys.length; i++) {
            var entry = st[sKeys[i]] ? st[sKeys[i]][targetUid] : null;
            if (entry) return entry;
        }
        return null;
    };

    var isGroupRoom = (ALLOWED_ROOMS.indexOf(realRoom) !== -1);
    var isAllowedCmd = (msg.startsWith("/ì¹´ì§€ë…¸") || msg.startsWith("/ë‚´ì •ë³´") || msg.startsWith("/ì€í–‰") || msg.startsWith("/ì—°ë™ì§„ë‹¨") || msg.startsWith("/ë°©ëª©ë¡") || msg.startsWith("/ê´€ë¦¬ì") || msg.startsWith("/ë„ì›€ë§") || msg.startsWith("/ê°€ì´ë“œ"));

    var activeSession = checkSession(localSt) || checkSession(mainSt);
    var inState = !!activeSession || (user && user.blackjackState);

    // [ë³´ì¡´] í•´ìƒ í™œë™ ì•Œë¦¼ (ëˆ„ë½ ë°©ì§€)
    if (typeof util_notifySeaReward === 'function') util_notifySeaReward(user, replier);

    // [ë³´ì¡´] ë¬´ì—­ ì •ì‚° ê²©ë¦¬ - ë‹¨ì²´ë°©ì—ì„œë§Œ ì •ì‚° ì‹¤í–‰ (ëˆ„ë½ ë°©ì§€)
    if (realRoom === MAIN_NAME && user && user.voyage && user.voyage.active === true) {
        if (Date.now() >= (user.voyage.arrival || 0)) {
            try { if (typeof _processTradeArrival === 'function') _processTradeArrival(user, data, replier, MAIN_NAME, targetUid); } catch (e) {}
        }
    }

    // 3. [1:1 ë³´ì•ˆ ê°€ë“œ] - ì„¸ì…˜ ì¤‘(inState)ì´ë¼ë©´ í•œê¸€/ìˆ«ì ì…ë ¥ì„ ì°¨ë‹¨í•˜ì§€ ì•Šê³  í†µê³¼ì‹œí‚´
    if (!isGroupRoom && !isAllowedCmd && !inState) {
        if (msg.startsWith("/")) {
            var infoBody = "í˜„ì¬ ê³„ì‹  ê³³ì€ [ë³´ì•ˆ êµ¬ì—­]ì…ë‹ˆë‹¤.\n\n" +
                           "âœ… ì´ìš© ê°€ëŠ¥: ì¹´ì§€ë…¸, ì€í–‰, ë‚´ì •ë³´, ë„ì›€ë§\n" +
                           "ğŸš« ì´ìš© ë¶ˆê°€: ìœ„ ëª…ë ¹ì–´ë¥¼ ì œì™¸í•œ ëª¨ë“  ëª…ë ¹ì–´\n\n" +
                           "ğŸ’¡ ë‹¨ì²´ë°© ì „ìš© ê¸°ëŠ¥ì€ 'ë‚´ë¦¬ë‹¤' ë°©ì„ ì´ìš©í•´ ì£¼ì„¸ìš”.";
            replier.reply(formatError(user, "ì ‘ê·¼ ì œí•œ ëª…ë ¹ì–´", infoBody));
        }
        return; 
    }

// í˜„ì¬ ì±„íŒ… ì¤‘ì¸ ë¬¼ë¦¬ì ì¸ ë°©ì˜ ë°ì´í„° (1:1 ë°© ê·¸ ìì²´)
var physicalRoom = data.rooms[roomName];
var actualFeatures = physicalRoom ? physicalRoom.features : null;

// [v11.9.6] ìˆ«ì í•¸ë“¤ëŸ¬ ì„¸ì…˜ ì¸ì‹ ë° ë°©ê°„ ë™ê¸°í™” ë³´ì •
if (actualFeatures && actualFeatures.states) { 
    var currentStates = actualFeatures.states;
    if (!currentStates.menuWait) currentStates.menuWait = {};
    if (!currentStates.bankProcess) currentStates.bankProcess = {};
    if (!currentStates.selectWait) currentStates.selectWait = {};

    // [ë³´ì •] 1:1 ëŒ€í™”ë°© ë¿ë§Œ ì•„ë‹ˆë¼ 'ë² ë¦­ë°©'(ê´€ì œì‹¤) ìœ ì €ì˜ ê²½ìš° ë©”ì¸ë°©('ë‚´ë¦¬ë‹¤')ì˜ ì„¸ì…˜ì„ ìµœìš°ì„  ë™ê¸°í™”
    if (is1to1 || roomName === "ë² ë¦­ë°©") {
        var mRoom = data.rooms[MAIN_NAME];
        if (mRoom && mRoom.features && mRoom.features.states) {
            var mS = mRoom.features.states;
            // ëª¨ë“  ëŒ€ê¸°ì—´ í‚¤(menuWait, bankProcess ë“±)ë¥¼ ì „ìˆ˜ ì¡°ì‚¬í•˜ì—¬ ë™ê¸°í™”
            var sKeys = ["menuWait", "bankProcess", "selectWait", "lottoPurchase"];
            sKeys.forEach(function(k) {
                var mainS = mS[k] ? mS[k][targetUid] : null;
                var localS = currentStates[k] ? currentStates[k][targetUid] : null;

                if (mainS && localS) {
                    var tM = mainS.time || mainS.timestamp || 0;
                    var tL = localS.time || localS.timestamp || 0;
                    // ë” ìµœì‹ ì¸ ê²ƒë§Œ ë‚¨ê¸°ê³  ë°˜ëŒ€í¸ì€ ì‚­ì œí•˜ì—¬ ë‹¨ê³„ ê¼¬ì„ ë°©ì§€
                    if (tM > tL) { delete currentStates[k][targetUid]; currentStates[k][targetUid] = mainS; }
                    else { delete mS[k][targetUid]; mS[k][targetUid] = localS; }
                } else if (mainS && !localS) {
                    currentStates[k][targetUid] = mainS;
                } else if (!mainS && localS) {
                    mS[k][targetUid] = localS;
                }
            });
        var activeKeys = sKeys.filter(function(k) { 
                return currentStates[k] && currentStates[k][targetUid]; 
            });

            if (activeKeys.length > 1) {
                var newestKey = activeKeys.reduce(function(a, b) {
                    var timeA = currentStates[a][targetUid].time || currentStates[a][targetUid].timestamp || 0;
                    var timeB = currentStates[b][targetUid].time || currentStates[b][targetUid].timestamp || 0;
                    return timeA > timeB ? a : b;
                });
                
                activeKeys.forEach(function(k) {
                    if (k !== newestKey) {
                        delete currentStates[k][targetUid];
                        delete mS[k][targetUid];
                    }
                });
            }
        } // if (mRoom && ...) ì¢…ë£Œ
    } // if (is1to1 || roomName === "ë² ë¦­ë°©") ì¢…ë£Œ

    // [í™•ì •] ëª¨ë“  ë™ê¸°í™” ë° ì²­ì†Œê°€ ì™„ë£Œëœ ìƒíƒœë¥¼ í™œì„± ì„¸ì…˜ìœ¼ë¡œ ì •ì˜
    var activeSession = currentStates.menuWait[targetUid] || currentStates.bankProcess[targetUid] || currentStates.selectWait[targetUid];


// ì¶”ê°€: ëª¨ë“  ìˆ«ì/ë©”ë‰´ í•¸ë“¤ëŸ¬ê°€ ì‘ë™í•˜ê¸° ì „, ë„¤ë¹„ê²Œì´ì…˜ í‚¤ì›Œë“œë¥¼ ìµœìƒë‹¨ì—ì„œ ê°€ë¡œì±” (ìˆ˜ì •/ì¶”ê°€)
   var NAV_KEYWORDS = ["ë’¤ë¡œ", "â†©ï¸ ë’¤ë¡œ", "ì²˜ìŒìœ¼ë¡œ", "ğŸ  ì²˜ìŒìœ¼ë¡œ", "ì·¨ì†Œ", "âì·¨ì†Œ"];
    if (inState && NAV_KEYWORDS.indexOf(msg.trim()) !== -1) {
        var input = msg.trim();
        // í˜„ì¬ ì„¸ì…˜ì˜ íƒ€ì…ì„ í™•ì¸í•˜ì—¬ ì–´ë–¤ ì‹œìŠ¤í…œ(ë¬´ì—­/ì¹´ì§€ë…¸/ìƒì )ì¸ì§€ íŒë³„
        var stType = (activeSession && activeSession.type) ? activeSession.type : "";

        // ì „ì²´ ì´ˆê¸°í™” í—¬í¼ í•¨ìˆ˜: í˜„ì¬ ë°©ê³¼ ë©”ì¸ ë°©ì˜ ëª¨ë“  ëŒ€ê¸°ì—´ ì‚­ì œ
        var clearAll = function(uid, rName) {
            var rooms = [data.rooms[rName], data.rooms["ë‚´ë¦¬ë‹¤"]];
            rooms.forEach(function(r) { 
                if(r && r.features && r.features.states) {
                    var s = r.features.states; 
                    ["menuWait", "bankProcess", "selectWait", "lottoPurchase"].forEach(function(k) { 
                        if(s[k]) delete s[k][uid]; 
                    });
                }
            });
        };

        if (input.indexOf("ì·¨ì†Œ") !== -1) {
            clearAll(targetUid, roomName);
            replier.reply(formatCommand("ğŸš« ì‘ì—… ì¢…ë£Œ", user, "ì§„í–‰ ì¤‘ì´ë˜ ëŒ€ê¸° ìƒíƒœë¥¼ ëª¨ë‘ í•´ì œí–ˆìŠµë‹ˆë‹¤."));
            return true;
        } 
        
        if (input.indexOf("ì²˜ìŒìœ¼ë¡œ") !== -1) {
            clearAll(targetUid, roomName);
            // ì‹œìŠ¤í…œ íƒ€ì…ì— ë”°ë¼ ì ì ˆí•œ ë©”ì¸ ë©”ë‰´ í•¨ìˆ˜ í˜¸ì¶œ (ì¹´í…Œê³ ë¦¬ ì´íƒˆ ë°©ì§€)
            if (stType.startsWith('trade') || stType.indexOf('ship_') !== -1) return _gameTradeLogic("/ë¬´ì—­", user, data, replier, roomName, targetUid);
            if (stType.startsWith('casino')) return _gameCasinoLogic("/ì¹´ì§€ë…¸", user, data, replier, roomName, targetUid);
            if (stType.startsWith('shop')) return _gameShopLogic("/ìƒì ", user, data, replier, roomName, targetUid);
            
            replier.reply(formatCommand("ğŸ  ì²˜ìŒìœ¼ë¡œ", user, "ë©”ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ì™”ìŠµë‹ˆë‹¤.")); 
            return true;
        }
        // 'ë’¤ë¡œ' ì…ë ¥ ì‹œì—ëŠ” ê° Stepë³„ í•¸ë“¤ëŸ¬(ì„¹í„° 23-4 ë“±)ê°€ ê³„ì¸µì„ íŒë‹¨í•  ìˆ˜ ìˆë„ë¡ ë¡œì§ì„ í•˜ë‹¨ìœ¼ë¡œ í†µê³¼ì‹œí‚µë‹ˆë‹¤.
    }

    // 1. ê´€ë¦¬ì ë° ì¡°ì‘ í•¸ë“¤ëŸ¬ (ë„¤ë¹„ê²Œì´ì…˜ ë°”ë¡œ ë‹¤ìŒ ìš°ì„ ìˆœìœ„)
    if (typeof _handleAdminMain === 'function' && _handleAdminMain(msg, user, data, replier, roomName, targetUid)) return;
    if (typeof _handleAdminManiStep === 'function' && _handleAdminManiStep(msg, user, data, replier, roomName, targetUid)) return;

    // 2. ë¸”ë™ì­ ì¬ë„ì „/ì•¡ì…˜ (1:1ë°© ì„¸ì…˜ ìš°ì„ )
    if (currentStates.menuWait[targetUid]) {
        var mType = currentStates.menuWait[targetUid].type;
       if (mType === 'blackjack_retry' && typeof _handleBlackjackRetry === 'function') {
            if (_handleBlackjackRetry(msg, user, data, replier, logicRoom, targetUid)) {
                return; 
            }
        }
        // [ìˆ˜ì •] ì•¡ì…˜(Hit/Stay) ì‹œ ê²Œì„ ì¢…ë£Œ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ì—¬ ì„¸ì…˜ ì‚­ì œ ì—¬ë¶€ ê²°ì •
        if (mType === 'blackjack_action' && typeof _handleBlackjackAction === 'function') {
            if (_handleBlackjackAction(msg, user, data, replier, logicRoom, targetUid)) {
                // [í•µì‹¬] ë©”ì¸ë°©(logicRoom)ì˜ ì„¸ì…˜ì´ ì‚¬ë¼ì¡Œì„ ë•Œë§Œ(ê²Œì„ ì¢…ë£Œ) 1:1ë°© ì„¸ì…˜ë„ í•¨ê»˜ ì‚­ì œ
                if (is1to1 && !data.rooms[logicRoom].features.states.menuWait[targetUid]) {
                    delete currentStates.menuWait[targetUid];
                }
                return;
            }
        }
        }

    // 3. í†µí•© ì¹´ì§€ë…¸ ë°°íŒ… (ì±„íŒ…ìœ¼ë¡œ 'í™€ 5000' ë“± ì…ë ¥ ì‹œ)
    if (typeof _handleCasinoBet === 'function' && _handleCasinoBet(msg, user, data, replier, roomName, targetUid)) return;
    
    // 4. ê³µìš© ë©”ë‰´ í•¸ë“¤ëŸ¬ (Step 1~4)
    if (typeof _handleMenuStep1 === 'function' && _handleMenuStep1(msg, user, data, replier, logicRoom, targetUid)) return;
    if (typeof _handleMenuStep2 === 'function' && _handleMenuStep2(msg, user, data, replier, logicRoom, targetUid)) return;
    if (typeof _handleMenuStep3 === 'function' && _handleMenuStep3(msg, user, data, replier, logicRoom, targetUid)) return;
    if (typeof _handleMenuStep4 === 'function' && _handleMenuStep4(msg, user, data, replier, logicRoom, targetUid)) return;

    // 5. ì€í–‰ ì—…ë¬´ ë° ìƒì  êµ¬ë§¤ ìˆ˜ëŸ‰ í•¸ë“¤ëŸ¬
    if (typeof _handleBankStep1 === 'function' && _handleBankStep1(msg, user, data, replier, logicRoom, targetUid)) return;
    if (typeof _handleBankStep2 === 'function' && _handleBankStep2(msg, user, data, replier, logicRoom, targetUid)) return;
    if (typeof _handleBankStep3 === 'function' && _handleBankStep3(msg, user, data, replier, logicRoom, targetUid)) return;
    if (typeof _handleBankStep4 === 'function' && _handleBankStep4(msg, user, data, replier, logicRoom, targetUid)) return;
    if (typeof _handleBankStep5 === 'function' && _handleBankStep5(msg, user, data, replier, logicRoom, targetUid)) return;

    // 6. ê¸°íƒ€ ì‹œìŠ¤í…œ í•¸ë“¤ëŸ¬
    if (typeof _handleSelectionLogic === 'function' && _handleSelectionLogic(msg, user, data, replier, logicRoom, targetUid)) return;
    if (typeof _handleLottoInput === 'function' && _handleLottoInput(msg, user, data, replier, logicRoom, targetUid)) return;
}

// 7. ì¼ë°˜ ê²Œì„ ëª…ë ¹ì–´ ì²˜ë¦¬
if (typeof _handleGameLogic === 'function') {
    if (_handleGameLogic(msg, user, data, replier, roomName, targetUid, cleanSender)) return;
}

/* 8. ì±„íŒ… ë³´ë„ˆìŠ¤ ë¡œì§ (í•¨ìˆ˜ ì—°ê²°) */
if (typeof _runChatBonusLogic === 'function') {
    _runChatBonusLogic(msg, user, data, replier, roomName, targetUid, realRoom);
}

//==========ì„¹í„°25==========

    // [ê´€ë¦¬ì ì „ìš©] ë´‡ ë©ˆì¶¤(ë°ë“œë½) ë°œìƒ ì‹œ ê°•ì œ ì ê¸ˆ í•´ì œ ëª…ë ¹ì–´
    if (isAdmin(sender, data, targetUid) && msg === "/ë½í•´ì œ") {
        if (typeof lock !== 'undefined') {
            while (lock.isLocked()) { lock.unlock(); }
            replier.reply("ğŸ”“ [ì‹œìŠ¤í…œ] ëª¨ë“  ë°ì´í„° ì ê¸ˆì´ ê°•ì œë¡œ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            return;
        }
    }

    /* [v10.1] C. ê´€ë¦¬ì ëª…ë ¹ì–´ ì²˜ë¦¬ (íŠ¸ëœì­ì…˜ flow ìœ ì§€) */
    if (!isProcessed && isAdmin(sender, data, targetUid)) {
        if (typeof _handleAdminLogic === 'function') {
            if (_handleAdminLogic(msg, user, data, replier, roomName, targetUid, sender)) {
                isProcessed = true; 
            }
        }
    }

    /* [v10.1] D. ëª…ë ¹ì–´ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ìë™ ì‹¤í–‰ (íŠ¸ëœì­ì…˜ flow ìœ ì§€) */
    if (!isProcessed && msg.startsWith("/")) {
        var cmdKey = msg.split(" ")[0];
        
        // 1. ë“±ë¡ëœ ì‚¬ìš©ì ëª…ë ¹ì–´ ì‹¤í–‰
        if (USER_COMMANDS && USER_COMMANDS[cmdKey]) {
            USER_COMMANDS[cmdKey].execute(msg, user, data, replier, roomName, targetUid, sender);
            isProcessed = true; 
        } 
        
        // 2. ê´€ë¦¬ì/ì‚¬ìš©ì ëª…ë ¹ì–´ ëª¨ë‘ ì—†ëŠ” ê²½ìš° ì²˜ë¦¬
        else if (!ADMIN_COMMANDS[cmdKey]) {
            var unknownCmdMsg = "'" + cmdKey + "'ì€(ëŠ”) ë“±ë¡ë˜ì§€ ì•Šì€ ëª…ë ¹ì–´ì…ë‹ˆë‹¤.";
            replier.reply(formatError(user, "ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì–´", unknownCmdMsg + "\n'/ë„ì›€ë§'ì„ ì…ë ¥í•˜ì—¬ ì „ì²´ ëª…ë ¹ì–´ ëª©ë¡ì„ í™•ì¸í•˜ì„¸ìš”."));
            isProcessed = true; 
        }
    }

//==========ì„¹í„°26==========

    // 1. [Atomic Commit] ëª¨ë“  ë¡œì§ ì •ìƒ ì¢…ë£Œ ì‹œ íŠ¸ëœì­ì…˜ í™•ì •
    if (typeof util_stagingCommit === 'function') {
        // [ìˆ˜ì •] í•¨ìˆ˜ ì¢…ë£Œ ì§ì „, ë°ì´í„° ê°ì²´ë¥¼ ì•ˆì „í•˜ê²Œ ì§ì ‘ ì°¸ì¡°í•˜ì—¬ ì»¤ë°‹
        util_stagingCommit(user, data.rooms[roomName]);
    }

} // _processMainLogic í•¨ìˆ˜ ì¢…ë£Œ (ë‹¨ í•˜ë‚˜ì˜ ì¤‘ê´„í˜¸ë§Œ ìˆìœ¼ë©´ ë©ë‹ˆë‹¤)

//==========ì„¹í„°27==========

/**
 * [ë…ë¦½í˜• í•¨ìˆ˜ 1] ì¸ë²¤í† ë¦¬ ë¡œì§ (ìì‚°ê°€ ì˜êµ¬ ì¹­í˜¸ í†µí•©ë³¸)
 * ê¸°ëŠ¥: ë³´ìœ  ì•„ì´í…œ í™•ì¸, ì¥ì°©, ë¶„í•´ ì²˜ë¦¬
 * ìˆ˜ì •: ì˜êµ¬ ì¹­í˜¸(700ë²ˆëŒ€) ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜ ë° ë³´í˜¸ ë¡œì§ ì¶”ê°€
 */
function _handleInventoryLogic(msg, user, data, replier, roomName, targetUid) {
    // 1. ê°€ë°© ì¡°íšŒ (ë¶„ë¥˜ ë° ìë™ ì •ë ¬ ì ìš©)
    if (msg === "/ê°€ë°©") {
        var inv = user.inventory || [];
        
        // ID ê¸°ì¤€ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬ (ìì‚°ê°€ ì¹­í˜¸ 700~703ë²ˆì´ ì¹­í˜¸ ìƒë‹¨ì— ì˜¤ë„ë¡ ì •ë ¬)
        inv.sort(function(a, b) {
            var idA = Number(a.id) || 9999;
            var idB = Number(b.id) || 9999;
            if (idA !== idB) return idA - idB;
            return (a.name || "").localeCompare(b.name || "");
        });

        var iconEntries = [];
        var titleEntries = [];
        
        if (inv.length === 0) {
            iconEntries.push("(ë³´ìœ  ì¤‘ì¸ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤)");
        } else {
            for (var i = 0; i < inv.length; i++) {
                var it = inv[i];
                var activeMark = "";
                
                // í˜„ì¬ ì¥ì°© ìƒíƒœ í™•ì¸ (âœ… í‘œì‹œ)
                if (it.effect === "icon" && user.icon === it.icon) activeMark = " (âœ… ì¥ì°© ì¤‘)";
                else if (it.effect === "title" && user.title === it.title) activeMark = " (âœ… ì¥ì°© ì¤‘)";
                
                var displayIcon = it.icon || "";
                var entry = "";

                if (it.effect === "icon") {
                    // ì•„ì´ì½˜ ì¹´í…Œê³ ë¦¬: [ì•„ì´ì½˜] ì´ë¦„ í¬ë§·
                    entry = (i + 1) + ". " + (displayIcon || "ğŸ“¦") + " " + it.name + activeMark;
                    iconEntries.push(entry);
                } else if (it.effect === "title") {

                    // 1. ëª¨ë“  ì¹­í˜¸ê°€ ë³´ì´ë„ë¡ í•„í„°(continue) ì œê±°
                    // 2. ìˆ˜ì§‘ëŒ€ë§ˆì™•, ë„êµ´ì™•ì„ ì œì™¸í•œ ì¹­í˜¸ì˜ ì•„ì´ì½˜ ìˆ¨ê¹€ ì²˜ë¦¬
                    var finalDisplayIcon = "";
                    if (it.title === "ìˆ˜ì§‘ëŒ€ë§ˆì™•" || it.title === "ë„êµ´ì™•") {
                        finalDisplayIcon = it.icon || "";
                    }

                    var entry = "";
                    if (finalDisplayIcon) {
                        // ì•„ì´ì½˜ì´ í—ˆìš©ëœ ì¹­í˜¸: [ì•„ì´ì½˜+ì´ë¦„] í¬ë§·
                        entry = (i + 1) + ". [" + finalDisplayIcon + it.title + "] ì¹­í˜¸" + activeMark;
                    } else {
                        // ê·¸ ì™¸ ëª¨ë“  ì¹­í˜¸: ì•„ì´ì½˜ ì—†ì´ [ì´ë¦„] í¬ë§·
                        entry = (i + 1) + ". [" + it.title + "] ì¹­í˜¸" + activeMark;
                    }
                    titleEntries.push(entry);
                }
            }
        }

        var horseInfo = "ğŸ ê²½ë§ˆ ì¥ë¹„: [" + (user.horseParts.length > 0 ? user.horseParts.join(", ") : "ì—†ìŒ") + "] " + (user.horseParts.length) + " / 4 ê°œ";
        var landInfo = "ğŸ™ï¸ ë¶€ë™ì‚° ë“±ê¸°ë¶€: " + (user.landDeedCount || 0) + " / 10 ê°œ";
        var letterInfo = "ğŸ“© ìœ„ë¡œì˜ í¸ì§€: " + (user.lottoFailCount || 0) + " / 15 ê°œ";
        
        var charmStatus = "";
        if (user.luckyCharmEnd && Date.now() < user.luckyCharmEnd) {
            var remainMin = Math.ceil((user.luckyCharmEnd - Date.now()) / 60000);
            charmStatus = "\nğŸ”® í–‰ìš´ì˜ë¶€ì : í™œì„± ì¤‘ (" + remainMin + "ë¶„ ë‚¨ìŒ)";
        }

        var invDisplay = "[ì•„ì´í…œ ë³´ê´€í•¨]\n";
        invDisplay += "ğŸ–¼ï¸ ì•„ì´ì½˜ ëª©ë¡ (ë“±ê¸‰ìˆœ)\n";
        invDisplay += (iconEntries.length > 0 ? iconEntries.join("\n") : "- ì—†ìŒ") + "\n\n";
        
        invDisplay += "ğŸ–ï¸ ì¹­í˜¸ ëª©ë¡ (ë“±ê¸‰ìˆœ)\n";
        invDisplay += (titleEntries.length > 0 ? titleEntries.join("\n") : "- ì—†ìŒ");

        var consumables = "\n\n[ë‚´ ì†Œëª¨í’ˆ ì •ë³´]\n" +
                          "ğŸ›¡ï¸ ê°•ë“± ë°©ì–´ê¶Œ: " + (user.tierGuard || 0) + "ê°œ\n" +
                          "ğŸ”‚ ì¶”ê°€ ìŠ¹ê¸‰ê¶Œ: " + (user.purchasedPromotionAttempts || 0) + "íšŒ\n" +
                          "ğŸ§© ë¶„í•´ ì¡°ê°: " + (user.boxFragments || 0) + " / 5 ê°œ\n" +
                          "ğŸ« ëœë¤ë°•ìŠ¤ ì´ìš©ê¶Œ: " + (user.boxTickets || 0) + "ë§¤" + charmStatus;

        // 2. ìˆ˜ì§‘ ì§„í–‰ë„ ì„¹ì…˜ ì¡°ë¦½ (ë¶€ë™ì‚° ìš©ì–´ ë°˜ì˜)
        var progress = "\n\n[ğŸ“Š ìˆ˜ì§‘ ë° ì¹­í˜¸ ì§„í–‰ë„]\n" +
                       horseInfo + "\n" +
                       landInfo + "\n" +
                       letterInfo;
        
        var content = invDisplay + consumables + progress + "\n\n(ì¥ì°©: [/ì¥ì°© ë²ˆí˜¸]) (ë¶„í•´: [/ë¶„í•´ ë²ˆí˜¸])";
        
        replier.reply(formatCommand("ğŸ’ ë‚´ ê°€ë°©", user, content, "íˆ¬ì: [/íˆ¬ì ê±´ë¬¼ëª… ìˆ˜ëŸ‰]"));
        return true;
    }

    // 2. ì•„ì´í…œ ì¥ì°© (ì‹ ìš©ë¶ˆëŸ‰ì ì œí•œ ë° ì¸ë±ìŠ¤ ì •í•©ì„± ìœ ì§€)
    if (msg.indexOf("/ì¥ì°© ") === 0) {
        if (Number(user.creditScore || 600) < 500) {
            replier.reply(formatError(user, "ì¥ì°© ë¶ˆê°€", "í˜„ì¬ ì‹ ìš©ë¶ˆëŸ‰ì ìƒíƒœì´ë¯€ë¡œ ì•„ì´ì½˜ ë° ì¹­í˜¸ ë³€ê²½ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤. ì‹ ìš©ì„ ë¨¼ì € íšŒë³µí•˜ì„¸ìš”."));
            return true;
        }

        var parts = msg.trim().split(/\s+/);
        if (parts.length < 2) {
            replier.reply(formatError(user, "í˜•ì‹ ì˜¤ë¥˜", "/ì¥ì°© [ë²ˆí˜¸]"));
            return true;
        }

        var idx = parseInt(parts[1]);
        var inv = user.inventory || [];
        if (isNaN(idx) || idx < 1 || idx > inv.length) {
            replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "ê°€ë°©ì— í‘œì‹œëœ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."));
            return true;
        }

        var selected = inv[idx - 1];
        if (selected.effect === "icon") {
            user.icon = selected.icon;
            replier.reply(formatCommand("âœ¨ ì•„ì´ì½˜ ì¥ì°©", user, "[" + selected.icon + "] ì•„ì´ì½˜ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.", "ë‚´ ì •ë³´: [/ë‚´ì •ë³´]"));
        } else if (selected.effect === "title") {
            user.title = selected.title || "";
            replier.reply(formatCommand("ğŸ–ï¸ ì¹­í˜¸ ì¥ì°©", user, "[" + (selected.title || selected.name) + "] ì¹­í˜¸ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.", "ë‚´ ì •ë³´: [/ë‚´ì •ë³´]"));
        }
        safeSaveData(data);
        return true;
    }

    // 3. ì•„ì´ì½˜ ë¶„í•´ ë¡œì§ (ì˜êµ¬ ì¹­í˜¸ ë³´í˜¸ ë¡œì§ ì¶”ê°€)
    if (msg.indexOf("/ë¶„í•´ ") === 0) {
        var inv = user.inventory || [];
        if (inv.length === 0) return replier.reply(formatError(user, "ë¶„í•´ ë¶ˆê°€", "ë¶„í•´í•  ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤."));

        user.skipHealing = true;

        var numbers = msg.match(/\d+/g);
        if (!numbers) return replier.reply(formatError(user, "ì…ë ¥ ì˜¤ë¥˜", "/ë¶„í•´ [ë²ˆí˜¸]"));

        var targetIndices = [];
        var protectedCount = 0;

        numbers.forEach(function(n) {
            var idx = parseInt(n) - 1;
            if (idx >= 0 && idx < inv.length && targetIndices.indexOf(idx) === -1) {
                var item = inv[idx];
                // [ì•ˆì „ ì¥ì¹˜] ID 700~799ë²ˆëŒ€(ìì‚°ê°€/ì—…ì  ì˜êµ¬ ì¹­í˜¸)ëŠ” ë¶„í•´ ëŒ€ìƒì—ì„œ ì œì™¸
                if (item.effect === "title" && item.id >= 700 && item.id < 800) {
                    protectedCount++;
                } else {
                    targetIndices.push(idx);
                }
            }
        });

        if (protectedCount > 0 && targetIndices.length === 0) {
            return replier.reply(formatError(user, "ë¶„í•´ ë¶ˆê°€", "ì˜êµ¬ ì—…ì  ì¹­í˜¸ëŠ” ë¶„í•´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        }
        if (targetIndices.length === 0) return replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "ì •í™•í•œ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));

        var disassembledNames = [];
        var earnedFragments = targetIndices.length;
        
        // ì—­ìˆœ ì •ë ¬í•˜ì—¬ splice ì‹œ ì¸ë±ìŠ¤ ë°€ë¦¼ ë°©ì§€
        targetIndices.sort(function(a, b) { return b - a; });

        targetIndices.forEach(function(idx) {
            var item = inv[idx];
            disassembledNames.push((item.icon || "ğŸ“¦") + " " + item.name);
            if (item.effect === "icon" && user.icon === item.icon) user.icon = "";
            if (item.effect === "title" && user.title === item.title) user.title = "";
            inv.splice(idx, 1);
        });

        user.boxFragments = (user.boxFragments || 0) + earnedFragments;
        var earnedTickets = 0;
        
        while (user.boxFragments >= 5) {
            user.boxFragments -= 5;
            user.boxTickets = (user.boxTickets || 0) + 1;
            earnedTickets++;
        }

        var resultMsg = "ì•„ì´í…œ " + targetIndices.length + "ê°œë¥¼ ë¶„í•´í–ˆìŠµë‹ˆë‹¤.\n\n" +
                        "[ë¶„í•´ ëª©ë¡]\n" + disassembledNames.join(", ") + "\n\n" +
                        "ğŸ§© íšë“ ì¡°ê°: +" + earnedFragments + " ê°œ\n" +
                        "(í˜„ì¬ ì¡°ê°: " + user.boxFragments + " / 5 ê°œ)";

        if (protectedCount > 0) resultMsg += "\n\nâš ï¸ ì•Œë¦¼: ì„ íƒí•˜ì‹  ì˜êµ¬ ì¹­í˜¸ " + protectedCount + "ê°œëŠ” ë¶„í•´ ëŒ€ìƒì—ì„œ ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤.";
        if (earnedTickets > 0) resultMsg += "\nğŸ« ëœë¤ë°•ìŠ¤ ì´ìš©ê¶Œ: +" + earnedTickets + "ë§¤ íšë“! (ì¡°ê° ë³€í™˜ ì™„ë£Œ)";

        replier.reply(formatCommand("â™»ï¸ ì•„ì´ì½˜ ë¶„í•´ ì™„ë£Œ", user, resultMsg, "ì´ìš©ê¶Œ í™•ì¸: [/ê°€ë°©]"));
        safeSaveData(data);
        return true;
    }
}

//==========ì„¹í„°28==========

/**
Â * [ë…ë¦½í˜• í•¨ìˆ˜ 2] ë¡œë˜ ë° ì•„ì´ì½˜ ë¡œì§
Â */
function _handleLottoLogic(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];

    // 1. ë°© ë°ì´í„° ë° ê¸°ëŠ¥ í…œí”Œë¦¿ ì¡´ì¬ ì—¬ë¶€ ì²´í¬ (ì•ˆì „ ê°€ë“œ)
    if (!roomData || !roomData.features) return false;

    // 2. [í•µì‹¬] ì´ í•¨ìˆ˜ ì „ìš© ì§€ì—­ ë³€ìˆ˜ë¡œ ë¡œë˜ ë°ì´í„° ì—°ê²° (ë¨¹í†µ ë°©ì§€)
    var lotto = roomData.features.lotto;

Â  Â  if (msg === "/ì•„ì´ì½˜ì´ˆê¸°í™”") {
Â  Â  Â  Â  user.icon = "";
Â  Â  Â  Â  replier.reply(formatCommand("âœ… ì•„ì´ì½˜ ì´ˆê¸°í™”", user, "ì„¤ì •ëœ ì•„ì´ì½˜ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.", "ìƒì  ì´ìš©: [/ìƒì ]"));
Â  Â  Â  Â  safeSaveData(data);
Â  Â  Â  Â  return true;
Â  Â  }

Â  Â  if (msg === "/ë¡œë˜ì •ë³´") {
Â  Â  Â  Â  var currentHour = new Date().getHours();
Â  Â  Â  Â  var isAfterDraw = (currentHour >= 22);
Â  Â  Â  Â  var myLottos = (lotto.entries && lotto.entries[targetUid]) ? lotto.entries[targetUid] : [];
Â  Â  Â  Â  var winNums = lotto.lastWinNums || [];

Â  Â  Â  Â  var result = "ğŸ« ë¡œë˜ ì •ë³´\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + getDisplayName(user) + "ë‹˜\n[ë‚˜ì˜ êµ¬ë§¤ ë²ˆí˜¸]\n";
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (myLottos.length === 0) {
Â  Â  Â  Â  Â  Â  result += "(êµ¬ë§¤í•œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤)\n";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  for (var i = 0; i < myLottos.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  var nums = myLottos[i];
Â  Â  Â  Â  Â  Â  Â  Â  var line = (i + 1) + ") " + nums.join(", ");
Â  Â  Â  Â  Â  Â  Â  Â  if (isAfterDraw && winNums.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  var matchCount = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for(var j=0; j < nums.length; j++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (winNums.indexOf(nums[j]) !== -1) matchCount++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (matchCount === 3) line += " ğŸ¥‡1ë“±!";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (matchCount === 2) line += " ğŸ¥ˆ2ë“±!";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (matchCount === 1) line += " ğŸ¥‰3ë“±!";
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  result += line + "\n";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  result += "\n[ë‹¹ì¼ ë‹¹ì²¨ ë²ˆí˜¸]\n";
Â  Â  Â  Â  if (isAfterDraw) {
Â  Â  Â  Â  Â  Â  if (winNums.length > 0) result += "ğŸ† " + winNums.join(", ");
Â  Â  Â  Â  Â  Â  else result += "ğŸ† ì§‘ê³„ ì¤‘ì…ë‹ˆë‹¤.";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  result += "ğŸ† ì•„ì§ ì¶”ì²¨ ì „ì…ë‹ˆë‹¤.";
Â  Â  Â  Â  }
Â  Â  Â  Â  result += "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’¡ [ê°€ì´ë“œ]: êµ¬ë§¤: [/êµ¬ë§¤ 5]";
Â  Â  Â  Â  replier.reply(result);
        return true;
Â  Â  }
}

//==========ì„¹í„°29==========

/**
 * [ë…ë¦½í˜•] ë°©ì¹˜í˜• ê´‘ì‚° ì‹œìŠ¤í…œ ë¡œì§ êµ¬í˜„ë¶€ (ëˆ„ì  ì‹œê°„ ë° ì„±ì·¨ ì¹­í˜¸ í†µí•© ë²„ì „)
 * ì„¤ëª…: ì„¹í„° 46(êµ¬ ì„¹í„° 27 í˜¸ì¶œë¶€)ì—ì„œ í˜¸ì¶œë˜ë©°, ê´‘ì‚° ì‹œì‘/ì •ë³´/ì¢…ë£Œ ë° ë³´ìƒ ì •ì‚° ë¡œì§ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
 * ë°˜ì˜ ì‚¬í•­: ìœ ë¬¼ ì¡°ê° 5ë‹¨ê³„ ì¹­í˜¸ ì²´ê³„ ì ìš© (ë„êµ´ì™•ë§Œ ì „ìš© ì•„ì´ì½˜ [âšœï¸] ë¶€ì—¬)
 */
function _handleMiningLogic(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName]; 

    // 1. ê´‘ì‚° ì‹œì‘
    if (msg === "/ê´‘ì‚°ì‹œì‘") {
        var stateRes = util_checkUserState(user, targetUid, roomName);
        if (!stateRes.canAction) {
            replier.reply(formatError(user, "ì…ì¥ ë¶ˆê°€", stateRes.reason));
            return true; // [ìˆ˜ì •] trueë¥¼ ëª…ì‹œì ìœ¼ë¡œ ë°˜í™˜í•˜ì—¬ ì¤‘ë³µ ì¶œë ¥ ì°¨ë‹¨
        }

        user.mining = { active: true, startTime: Date.now(), room: roomName };
        replier.reply(formatCommand("â›ï¸ ê´‘ì‚° ì…ì„±", user, "ê´‘ì‚°ì—ì„œ ì±„êµ´ì„ ì‹œì‘í–ˆìŠµë‹ˆë‹¤.\nì±„êµ´ ì¤‘ì—ëŠ” ë„ë°•, ëœë“œë§ˆí¬, ë„ë‘‘ì§ˆ ë“± ìˆ˜ìµí˜• í™œë™ì´ ì œí•œë©ë‹ˆë‹¤.", "ì¢…ë£Œ: [/ê´‘ì‚°ì¢…ë£Œ]"));
        safeSaveData(data);
        return true;
    }

    // 2. ê´‘ì‚° ì •ë³´ (ìƒëŒ€ë°© ì¡°íšŒ ê¸°ëŠ¥ ì¶”ê°€)
    if (msg.indexOf("/ê´‘ì‚°ì •ë³´") === 0) {
        var parts = msg.trim().split(/\s+/);
        var tData = user, tIdR = targetUid;

        if (parts.length > 1) {
            var sNick = parts.slice(1).join(" ").trim();
            var fnd = findUserByName(roomData, sNick);
            if (fnd.length === 0) { 
                replier.reply(formatError(user, "ì¡°íšŒ ì‹¤íŒ¨", "[" + sNick + "] ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); 
                return true; 
            }
            if (fnd.length > 1) { 
                handleUserSelection(replier, targetUid, fnd, "mining_info", null, user, roomName); 
                return true; 
            }
            tData = fnd[0].data; tIdR = fnd[0].id;
        }

        var isMe = (tIdR === targetUid);
        var isMin = (tData.mining && tData.mining.active === true);
        // [ìˆ˜ì •]: ì±„êµ´ ì¤‘ì´ ì•„ë‹ ê²½ìš° ì¦‰ì‹œ í‘œì¤€ ì—ëŸ¬ í¬ë§·ìœ¼ë¡œ ì‘ë‹µí•˜ê³  ë¡œì§ ì¢…ë£Œ
        if (!isMin) {
            replier.reply(formatError(tData, "ìƒíƒœ ì˜¤ë¥˜", "í˜„ì¬ ê´‘ì‚°ì—ì„œ ì‘ì—… ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤."));
            return true;
        }

        // [ìµœì í™”]: ìœ„ì—ì„œ ê±¸ëŸ¬ì¡Œìœ¼ë¯€ë¡œ ì•„ë˜ ë¡œì§ì€ ë¬´ì¡°ê±´ ì±„êµ´ ì¤‘ì¸ ìƒíƒœì„ (isMin ì²´í¬ ìƒëµ)
        var dur = Math.floor((Date.now() - tData.mining.startTime) / 60000);
        var tot = (tData.totalMiningTime || 0) + dur;
        
        var pol = util_getActivePolicy(roomData);
        var mult = util_getEcoMultiplier(roomName) * (pol.mineMult || 1.0);
        
        // [êµì •] ë³´ë„ˆìŠ¤ ì¡°ê±´ ë³€ê²½: (ì€í–‰ëŒ€ì¶œ + ì‚¬ì±„) í•©ê³„ê°€ ì‹ ìš©í•œë„ì˜ 80%ë¥¼ ì´ˆê³¼í•  ë•Œë§Œ 1.5ë°° ì ìš©
        var bDebt = (tData.loan && tData.loan.debt) ? Number(tData.loan.debt) : 0;
        var pDebt = 0;
        if (roomData.loanContracts) {
            for (var cid in roomData.loanContracts) {
                if (roomData.loanContracts[cid].borrowerUid === tIdR) pDebt += Number(roomData.loanContracts[cid].currentDebt || 0);
            }
        }
        var limit80 = getCreditInfo(tData.creditScore, roomName).limit * 0.8;
        if ((bDebt + pDebt) > limit80) mult *= 1.5;
        
        var est = Math.floor(dur * SYSTEM_CONFIG.ECO.MINE.BASE_PER_MIN * mult);

        var body = "\nì±„êµ´ ì§„í–‰: " + dur + "ë¶„ì§¸...\n" +
                   "ğŸ“ˆ ëˆ„ì  ì±„êµ´: " + fp(tot) + "ë¶„ ê²½ê³¼\n" +
                   "ğŸ’° ì˜ˆìƒ " + (isMe ? "ê¸°ë³¸ìˆ˜ìµ" : "ìˆ˜ìµ") + ": +" + fp(est) + "P\n" +
                   "âš–ï¸ ì •ì±… íš¨ê³¼: x" + mult.toFixed(1) + " (ì ìš© ì¤‘)\n\n" +
                   "âœ¨ ê´‘ë¬¼ ë°œê²¬ ìˆ˜ìµì€ ì¢…ë£Œ ì‹œ í•©ì‚°ë©ë‹ˆë‹¤.";

        replier.reply(formatCommand(isMe ? "â›ï¸ ê´‘ì‚° ì§„í–‰ í˜„í™©" : "ğŸ” ìœ ì € ê´‘ì‚° ì§„í–‰ í˜„í™©", tData, body, isMe ? "ì¢…ë£Œ ë° ì •ì‚°ì€ [/ê´‘ì‚°ì¢…ë£Œ]" : null));
        return true;
    }

    // 3. ê´‘ì‚° ì¢…ë£Œ (ìœ ë¬¼ 5ë‹¨ê³„ ì¹­í˜¸ ì •ì‚° ë° ëˆ„ì  ì‹œê°„ ë°˜ì˜)
    if (msg === "/ê´‘ì‚°ì¢…ë£Œ") {
        if (!user.mining || !user.mining.active) {
            replier.reply(formatError(user, "ìƒíƒœ ì˜¤ë¥˜", "í˜„ì¬ ì‘ì—… ì¤‘ì´ì§€ ì•ŠìŠµë‹ˆë‹¤."));
            return true;
        }

        // [ìˆ˜ì •]: í¬ì¸íŠ¸ ë³µì‚¬ ë°©ì§€ ë° ë½ í•´ì œë¥¼ ìœ„í•œ ìƒíƒœ ì„ ì í˜• ì¢…ë£Œ ë¡œì§ ì ìš©
        user.mining.active = false; // 1. ì§„ì… ì¦‰ì‹œ ë¹„í™œì„±í™”í•˜ì—¬ ì¤‘ë³µ í˜¸ì¶œ ì°¨ë‹¨
        user.skipHealing = true;    // ë³´ì•ˆ ì—”ì§„ ì¼ì‹œ í—ˆìš©

        // [v5.9] í†µí•© ìƒíƒœ ê°€ë“œ: ì§•ì—­í˜• ì„ ê³  ì‹œ ì¦‰ì‹œ í‡´ê±° ì²˜ë¦¬
        var stateRes = util_checkUserState(user, targetUid);
        if (!stateRes.canAction && stateRes.reason.indexOf("ì§•ì—­") !== -1) {
            safeSaveData(data, true); // ìƒíƒœ ë³€í™” ì¦‰ì‹œ ê°•ì œ ì €ì¥
            return replier.reply(formatError(user, "ê²€ê±° í™•ì¸", "ì§•ì—­í˜• ì„ ê³ ë¡œ ì¸í•´ ê´‘ì‚°ì—ì„œ ê°•ì œ í‡´ê±°ë˜ì—ˆìŠµë‹ˆë‹¤."));
        }

        var now = Date.now();
        var durationMin = Math.floor((now - user.mining.startTime) / 60000); 

        if (durationMin < 1) {
            safeSaveData(data, true); // ì§§ì€ ì‹œê°„ ì‘ì—… ì‹œì—ë„ ìƒíƒœ ë™ê¸°í™”
            replier.reply(formatCommand("â›ï¸ ê´‘ì‚° í‡´ê±°", user, "ì±„êµ´ ì‹œê°„ì´ ë„ˆë¬´ ì§§ì•„ ìˆ˜ìµì´ ë°œìƒí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n(ìµœì†Œ 1ë¶„ ì´ìƒ ìœ ì§€ í•„ìš”)", "ë‹¤ì‹œ ì‹œì‘: [/ê´‘ì‚°ì‹œì‘]"));
            return true;
        }

        // [ê°€ìƒ ì •ë¶€] í˜„ì¬ ì •ì±… ë°°ìœ¨ ë¡œë“œ ë° ì ìš©
        var pol = util_getActivePolicy(roomData);
        var multiplier = util_getEcoMultiplier(roomName) * (pol.mineMult || 1.0);

        // [ì •ë¶€ ì •ì±… ì—°ë™] ì‹ ê·œ ì •ì±… ë³€ìˆ˜ ë°˜ì˜ (ì¸í”Œë ˆì´ì…˜ ì–µì œ ë° ê·¼ë¡œ ì‚­ê° ì •ì±…)
        if (pol.globalRewardMult) multiplier *= pol.globalRewardMult; // ì¸í”Œë ˆì´ì…˜ ì–µì œ (x0.8)
        if (pol.workMult) multiplier *= pol.workMult;                 // ê·¼ë¡œ ìˆ˜ìµ ê°ì†Œ (x0.75)

        var hasDebt = (user.loan && Number(user.loan.debt) > 0);
        if (!hasDebt && roomData.loanContracts) {
            for (var cid in roomData.loanContracts) {
                if (roomData.loanContracts[cid].borrowerUid === targetUid) { hasDebt = true; break; }
            }
        }
        if (hasDebt) multiplier *= 1.5;

        var basePrice = SYSTEM_CONFIG.ECO.MINE.BASE_PER_MIN;
        var conf = SYSTEM_CONFIG.ECO.MINE;
        var totalEarn = 0;
        var copperCount = 0, goldCount = 0, diaCount = 0;
        var artifactFound = 0;

        for (var i = 0; i < durationMin; i++) {
            var rand = Math.random();
            // [ì±„êµ´ì™•] ê¸°ë³¸ í¬ì¸íŠ¸ 20% ìƒìŠ¹
            var miningBonus = (user.title === "ì±„êµ´ì™•") ? 1.2 : 1.0;
            var minIncome = basePrice * multiplier * miningBonus;

            // [ë„êµ´ì™•] ë°œê²¬ í™•ë¥  20% ìƒìŠ¹ (ìƒëŒ€ì  ìƒìŠ¹)
            var luck = (user.title === "ë„êµ´ì™•") ? 1.2 : 1.0;
            
            // [ì •ë¶€ ì •ì±… ì—°ë™] í¬ê·€ ê´‘ë¬¼ ë°œê²¬ ë°°ìœ¨ ë° ìœ ë¬¼ í™•ë¥  ë°°ìœ¨ ì ìš©
            var rareMult = pol.rareMineMult || 1.0;     // ì§€í•˜ ê²½ì œ í™œì„±í™”ë²• (x2.0)
            var artifMult = pol.artifactMult || 1.0;    // ê³¨ë™í’ˆ ë°œêµ´ ì¥ë ¤ë ¹ (x3.0)
            
            if (rand < (conf.DIA_PROB * luck * rareMult)) { 
                diaCount++; 
                totalEarn += (minIncome * conf.DIA_MULT); 
            } 
            else if (rand < ((conf.DIA_PROB + conf.GOLD_PROB) * luck * rareMult)) { 
                goldCount++; 
                totalEarn += (minIncome * conf.GOLD_MULT); 
            } 
            else if (rand < ((conf.DIA_PROB + conf.GOLD_PROB + conf.COPPER_PROB) * luck * rareMult)) { 
                copperCount++; 
                totalEarn += (minIncome * conf.COPPER_MULT); 
            }
            else { 
                // 4. ì¼ë°˜ ëŒë©ì´ íŒì • (ë‚˜ë¨¸ì§€)
                totalEarn += minIncome; 
            }

            // ìœ ë¬¼ ë°œê²¬ í™•ë¥ ì— ì •ì±… ë°°ìœ¨ ì ìš©
            if (Math.random() < (conf.ARTIFACT_CHANCE * artifMult)) {
                artifactFound++;
            }
        }

        totalEarn = Math.floor(totalEarn);

        var matchingBonus = 0;
        var isStimulusActive = (data.stimulusEndTime && Date.now() < data.stimulusEndTime);
        
        if (isStimulusActive && roomData.bankReserve > totalEarn) {
            matchingBonus = totalEarn; 
        }

        var borrowerUid = targetUid || user.uid; 
        var totalWithBonus = totalEarn + matchingBonus;
        // 1. [ì°¨ë“± ì„¸ê¸ˆ ê³„ì‚°] ì„¹í„° 11ì˜ ì—”ì§„ í˜¸ì¶œ
        var taxInfo = util_applyIncomeTax(user, totalWithBonus, roomName);
        
        // 2. ì„¸ê¸ˆ êµ­ê³  í™˜ìˆ˜ ì§‘í–‰
        util_updateReserve(roomData, taxInfo.taxAmount, "ê´‘ì‚° ì±„êµ´ ì†Œë“ì„¸ ì§•ìˆ˜", roomName);

        // 3. [ìƒí™˜ ì²˜ë¦¬] ì„¸ê¸ˆì„ ëº€ ë‚˜ë¨¸ì§€ ê¸ˆì•¡(taxInfo.netIncome)ìœ¼ë¡œ ë¹š ìƒí™˜ ì§„í–‰
        var res = processRepayment(user, taxInfo.netIncome, borrowerUid, roomName); 
        
        var actualTotal = Number(res.actualGain);
        var bonusPart = (matchingBonus > 0) ? Math.floor(actualTotal / 2) : 0;
        var basePart = actualTotal - bonusPart;

        util_updatePoint(user, roomData, basePart, "ê´‘ì‚° ì±„êµ´ ì •ì‚°", roomName);
        if (bonusPart > 0) util_updatePoint(user, roomData, bonusPart, "ì •ë¶€ ê·¼ë¡œ ì¥ë ¤ê¸ˆ(ê´‘ì‚°)", roomName);

        // [UI êµ¬ì„±] ì„¸ê¸ˆ ë° ì •ì‚° ë‚´ì—­ í…ìŠ¤íŠ¸ ì¡°ë¦½
        var taxLog = "\nâš–ï¸ ì„¸ê¸ˆ(" + taxInfo.ratePct + "%): -" + fp(taxInfo.taxAmount) + "P (ìƒìœ„ " + taxInfo.rankPct + "%)";
        var stimulusLog = (matchingBonus > 0) ? "\nğŸ¦ [ì´ë²¤íŠ¸]: 1:1 ë§¤ì¹­ ì¥ë ¤ê¸ˆ +" + fp(matchingBonus) + "P" : "";
        var repayInfo = res.repayMsg ? "\n" + res.repayMsg : "";
        var finalGainLog = "\nğŸ’° ìµœì¢… ìˆ˜ìµ: +" + fp(actualTotal) + "P" + miningKingTag;

        var nextMiningTime = Number(user.totalMiningTime || 0) + durationMin;
        util_setData(user, 'totalMiningTime', nextMiningTime, "ê´‘ì‚° ì±„êµ´ ì‹œê°„ í•©ì‚°", roomName);

        var nextArtifacts = Number(user.artifactPieces || 0) + artifactFound;
        util_setData(user, 'artifactPieces', nextArtifacts, "ìœ ë¬¼ ì¡°ê° íšë“", roomName);

        var replierStub = { reply: function(m) { Api.replyRoom(roomName, m); } };

        // 3. ì±„êµ´ ì‹œê°„ ì¹­í˜¸ ì²´í¬
        if (user.totalMiningTime >= 10000) {
            util_checkAndAwardTitle(user, replierStub, "ì±„êµ´ì™•", 2903, "â›ï¸", "ë‚´ë¦¬ë‹¤ ê´‘ì—… ê´€ë¦¬ì²­", "ëˆ„ì  ì±„êµ´ 10,000ë¶„", "[ì¥ì°© íš¨ê³¼]: ê´‘ì‚° ì±„êµ´ ì‹œ ë¶„ë‹¹ íšë“í•˜ëŠ” ê¸°ë³¸ í¬ì¸íŠ¸ê°€ 20% ìƒìŠ¹í•©ë‹ˆë‹¤.");
        } else if (user.totalMiningTime >= 7000) {
            util_checkAndAwardTitle(user, replierStub, "ì„ê³µ", 2902, "â›ï¸", "ë‚´ë¦¬ë‹¤ ê´‘ì—… ê´€ë¦¬ì²­", "ëˆ„ì  ì±„êµ´ 7,000ë¶„", "ë°”ìœ„ì¡°ì°¨ ë‹¹ì‹ ì˜ ê³¡ê´­ì´ ì•ì—ì„œëŠ” ê¸¸ì„ ë‚´ì–´ì¤ë‹ˆë‹¤.");
        } else if (user.totalMiningTime >= 3000) {
            util_checkAndAwardTitle(user, replierStub, "ë‘ë”ì§€", 2901, "â›ï¸", "ë‚´ë¦¬ë‹¤ ê´‘ì—… ê´€ë¦¬ì²­", "ëˆ„ì  ì±„êµ´ 3,000ë¶„", "ë•…ì†ì˜ ê¸°ìš´ê³¼ í•˜ë‚˜ê°€ ë˜ì–´ ë¬µë¬µíˆ ê¸¸ì„ ëš«ê³  ìˆìŠµë‹ˆë‹¤.");
        }

        // 4. ìœ ë¬¼ ì¡°ê° ì¹­í˜¸ ì²´í¬
        if (user.artifactPieces >= 50) {
            util_checkAndAwardTitle(user, replierStub, "ë„êµ´ì™•", 2915, "âšœï¸", "ë‚´ë¦¬ë‹¤ ê³ ê³ í•™ ì—°êµ¬ì†Œ", "ìœ ë¬¼ ì¡°ê° 50ê°œ ë‹¬ì„±", "[ì¥ì°© íš¨ê³¼]: ê´‘ì‚° ì±„êµ´ ì‹œ í¬ê·€ ê´‘ë¬¼(êµ¬ë¦¬/ê¸ˆ/ë‹¤ì´ì•„) ë°œê²¬ í™•ë¥ ì´ 20% ìƒìŠ¹í•©ë‹ˆë‹¤.", roomName);
        } 
        if (user.artifactPieces >= 40) {
            util_checkAndAwardTitle(user, replierStub, "íŠ¸ë ˆì €í—Œí„°", 2914, "ğŸ’", "ë‚´ë¦¬ë‹¤ ê³ ê³ í•™ ì—°êµ¬ì†Œ", "ìœ ë¬¼ ì¡°ê° 40ê°œ ë‹¬ì„±", "ì „ì„¤ì˜ ë³´ë¬¼ì„ ì°¾ì•„ ì „ ì„¸ê³„ë¥¼ ëˆ„ë¹„ëŠ” íƒí—˜ê°€ì…ë‹ˆë‹¤.", roomName);
        } 
        if (user.artifactPieces >= 30) {
            util_checkAndAwardTitle(user, replierStub, "ë°œêµ´ê°€", 2913, "ğŸº", "ë‚´ë¦¬ë‹¤ ê³ ê³ í•™ ì—°êµ¬ì†Œ", "ìœ ë¬¼ ì¡°ê° 30ê°œ ë‹¬ì„±", "ì—­ì‚¬ì˜ íŒŒí¸ì„ ë§ì¶°ë‚˜ê°€ë©° ì‹ ë¹„ë¥¼ ë°íˆê³  ìˆìŠµë‹ˆë‹¤.", roomName);
        } 
        if (user.artifactPieces >= 20) {
            util_checkAndAwardTitle(user, replierStub, "íƒì‚¬ì›", 2912, "ğŸ”", "ë‚´ë¦¬ë‹¤ ê³ ê³ í•™ ì—°êµ¬ì†Œ", "ìœ ë¬¼ ì¡°ê° 20ê°œ ë‹¬ì„±", "ìœ ì ì˜ í”ì ë“¤ì´ ë³´ì´ê¸° ì‹œì‘í•©ë‹ˆë‹¤.", roomName);
        } 
        if (user.artifactPieces >= 10) {
            // [ë³µêµ¬ ëŒ€ìƒ] 10ê°œ íšë“ ì‹œ ë„êµ´ê¾¼ ì¹­í˜¸ ë¶€ì—¬
            util_checkAndAwardTitle(user, replierStub, "ë„êµ´ê¾¼", 2911, "ğŸ§¤", "ë‚´ë¦¬ë‹¤ ê³ ê³ í•™ ì—°êµ¬ì†Œ", "ìœ ë¬¼ ì¡°ê° 10ê°œ ë‹¬ì„±", "ë“œë””ì–´ ì²« ë²ˆì§¸ ìœ ë¬¼ ì¹­í˜¸ë¥¼ íšë“í•˜ì…¨ìŠµë‹ˆë‹¤.", roomName);
        }

        var miningKingTag = (user.title === "ì±„êµ´ì™•") ? " âœ¨ì±„êµ´ì™• í˜œíƒ" : "";
        var artifactKingTag = (user.title === "ë„êµ´ì™•") ? " âœ¨ë„êµ´ì™• í˜œíƒ" : "";
        
        var artifactFoundMsg = (artifactFound > 0) ? "\n\nâœ¨ [ìœ ë¬¼ ë°œê²¬]" + artifactKingTag + "\nğŸ§© ì¡°ê° íšë“ (+" + artifactFound + "ê°œ / ì´ " + user.artifactPieces + "ê°œ)" : "";
        var repayInfo = res.repayMsg ? "\n" + res.repayMsg : "";
        
        var finalOutput = "â›ï¸ ì±„êµ´ ê²°ê³¼\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + getDisplayName(user) + "ë‹˜\n\n" +
                          "â›ï¸ ì±„êµ´ ì‹œê°„: " + durationMin + "ë¶„\n" +
                          "ğŸŸ« êµ¬ë¦¬ " + copperCount + "íšŒ ğŸ—‚ï¸ í™©ê¸ˆ " + goldCount + "íšŒ\n" +
                          "ğŸ’ ë‹¤ì´ì•„ " + diaCount + "íšŒ\n" +
                          "ğŸ’° ì±„êµ´ ìˆ˜ìµ: +" + fp(totalEarn) + "P\n" +
                          taxLog + stimulusLog + repayInfo + 
                          "\nğŸ’° ìµœì¢… ìˆ˜ìµ: +" + fp(actualTotal) + "P" + miningKingTag + 
                          artifactFoundMsg + 
                          "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                          "ğŸ’¡ [ê°€ì´ë“œ]: ë‚´ ì”ì•¡: " + fP(user.point) + "P";

        if (artifactFound > 0) {
            // ë‹¤ìŒ ì¹­í˜¸ ëª©í‘œì¹˜ ê³„ì‚° ë¡œì§
            var pieces = Number(user.artifactPieces || 0);
            var targetGoal = 10;
            if (pieces >= 50) targetGoal = 50;
            else if (pieces >= 40) targetGoal = 50;
            else if (pieces >= 30) targetGoal = 40;
            else if (pieces >= 20) targetGoal = 30;
            else if (pieces >= 10) targetGoal = 20;
            else targetGoal = 10;
          }
                                          
        replier.reply(finalOutput);
        safeSaveData(data, true); // 2. ë¬¼ë¦¬ì  ì¦‰ì‹œ ì €ì¥ ì‹¤í–‰ (ë³µì‚¬ ë° ê¸°ëŠ¥ ì°¨ë‹¨ í•´ê²° í•µì‹¬)
        return true;
    }
}

//==========ì„¹í„°30==========

/**
 * [ì „ì—­ ë…ë¦½ í•¨ìˆ˜] ìƒì  ì•„ì´í…œ íš¨ê³¼ ì²˜ë¦¬ ì—”ì§„
 * ê¸°ëŠ¥: êµ¬ë§¤í•œ ì•„ì´í…œì˜ íš¨ê³¼ ë°œë™ ë° ì¤‘ì•™ì€í–‰ ì¬ì› ì •ì‚°
 * ìˆ˜ì • ì‚¬í•­: [Gemini ìš”ì²­ ì‚¬í•­] ìˆ˜ì§‘ëŒ€ë§ˆì™• íŒì • ë¡œì§ì„ "ë³´ìœ +ë¶„í•´ ëˆ„ì " ë° "ì „ì¢… ìˆ˜ì§‘" ê¸°ì¤€ìœ¼ë¡œ ì •ë°€í™”
 */
function _handleShopEffect(item, user, roomName, replier, data, targetUid, finalPrice, isUsingTicket, quantity) {
    var roomData = data.rooms[roomName];
    if (!roomData) return;

    var bankProcessState = roomData.features.states.bankProcess;

    // [ë³´ì•ˆ íŒ¨ì¹˜] ìƒì  íš¨ê³¼ ì§„ì… ì‹œ ê°•ì œë¡œ í—¬ëŸ¬ ë°©ì–´ë§‰ ê°€ë™ (êµ¬ë§¤ ì™„ë£Œ ì‹œê¹Œì§€ ìœ ì§€)
    user.skipHealing = true;

    // ìˆ˜ëŸ‰ ë° ëˆ„ì  ë§¤ì¶œ ì •ì‚° ë¡œì§ ìµœì í™”
    var qty = (quantity !== undefined && quantity !== null) ? quantity : 1;

    // ì¤‘ì•™ì€í–‰ ì¬ì› ì´ˆê¸°í™” (ê¸°ë³¸ 10,000P)
    if (roomData.bankReserve === undefined || roomData.bankReserve === null) {
        roomData.bankReserve = 10000;
    }
    
    /* [1. ìì‚° ì •ì‚°] ì´ìš©ê¶Œ ì°¨ê° ë¡œì§ (ìœ ì €ë‹˜ì˜ ê¸°ì¡´ ì‚¬ìœ  ë¬¸êµ¬ ë³´ì¡´) */
    if (isUsingTicket && item.effect === "randomBox") {
        var currentTickets = Number(user.boxTickets || 0);
        // êµ¬ë§¤ ìˆ˜ëŸ‰(qty)ë§Œí¼ ì°¨ê°í•˜ë˜, ë³´ìœ ëŸ‰ë³´ë‹¤ ë§ì´ ëº„ ìˆ˜ ì—†ë„ë¡ ì œí•œ
        var ticketsToUse = Math.min(qty, currentTickets); 
        util_setData(user, 'boxTickets', currentTickets - ticketsToUse, "ëœë¤ë°•ìŠ¤ ì´ìš©ê¶Œ ì‚¬ìš©", roomName);
    }

    /* [Gemini ìš”ì²­ ì‚¬í•­] ìˆ˜ì§‘ëŒ€ë§ˆì™• íŒì • í•¨ìˆ˜ - ì „ì¢… ìˆ˜ì§‘(ë³´ìœ +ë¶„í•´) ì²´í¬ */
    var checkCollectionMaster = function() {
        // 1. ìƒì  íŒë§¤ ì•„ì´ì½˜ ì¶”ì¶œ
        var shopIcons = SHOP_ITEMS.filter(function(it) { return it.effect === "icon"; }).map(function(it) { return it.icon; });
        
        // 2. ëœë¤ ë°•ìŠ¤ ëª¨ë“  ì•„ì´ì½˜ ì¶”ì¶œ
        var boxIcons = [];
        if (RANDOM_BOX_CONFIG && RANDOM_BOX_CONFIG.PROBS) {
            RANDOM_BOX_CONFIG.PROBS.forEach(function(grade) {
                if (grade.items) boxIcons = boxIcons.concat(grade.items);
            });
        }
        
        // 3. ì¤‘ë³µ ì œê±°ëœ ì „ì²´ ê³ ìœ  ì•„ì´ì½˜ ëª©ë¡ ìƒì„±
        var allUniqueIcons = {};
        shopIcons.concat(boxIcons).forEach(function(icon) {
            if (icon) allUniqueIcons[icon] = true;
        });
        
        var totalTargetCount = Object.keys(allUniqueIcons).length;
        
        // 4. ìœ ì €ì˜ ëˆ„ì  ìˆ˜ì§‘ ê¸°ë¡(collectedIcons)ê³¼ ë¹„êµ íŒì •
        if (user.collectedIcons && user.collectedIcons.length >= totalTargetCount) {
            
            var replierStub = { reply: function(m) { Api.replyRoom(roomName, m); } };
            util_checkAndAwardTitle(user, replierStub, "ìˆ˜ì§‘ëŒ€ë§ˆì™•", 3001, "ğŸµï¸", "ë‚´ë¦¬ë‹¤ ë§Œë¬¼ ìƒì—… ì—°í•©", "ëª¨ë“  ì•„ì´ì½˜ ìˆ˜ì§‘ ì™„ë£Œ", "[ì¥ì°© íš¨ê³¼]: ëª¨ë“  ìƒì  ë¬¼í’ˆ êµ¬ë§¤ ì‹œ 15% ìƒì‹œ í• ì¸ì´ ì ìš©ë©ë‹ˆë‹¤.");
        }
    };

    /* [2. ì•„ì´í…œ íš¨ê³¼ë³„ ì‹¤í–‰ ë¡œì§] */

    /* ë¬´ì—­ ë¬¼í’ˆ ì ì¬ ë¡œì§ ì¶”ê°€ */
    if (item.effect === "trade_cargo") {
        if (user.voyage && user.voyage.active) {
             replier.reply(formatError(user, "ì ì¬ ë¶ˆê°€", "í˜„ì¬ ì„ ë°•ì´ í•­í•´ ì¤‘ì…ë‹ˆë‹¤.\nê·€í•­ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."));
             return; // ëˆ ì°¨ê° ì „ ì¢…ë£Œ
        }

        // í•­í•´ ì¤‘ì´ ì•„ë‹˜ì´ í™•ì¸ëœ ì´ ì‹œì ì— ì‹¤ì œ ê²°ì œ ì§„í–‰
        util_updatePoint(user, roomData, -finalPrice, "ë¬´ì—­ í™”ë¬¼ ë§¤ì…: " + item.value + " x" + qty, roomName);

        var tradeCfg = SYSTEM_CONFIG.TRADE;
        var shipCfg = tradeCfg.SHIPS[user.shipLevel || 1];
        
        // [v15.9] ì´ˆì›” ê°•í™” ì ì¬ëŸ‰ í•©ì‚° ê°€ë“œ ì ìš©
        var totalCap = shipCfg.capacity + (user.enhLimit || 0);
        
        // í˜„ì¬ ì´ ì ì¬ëŸ‰ ê³„ì‚°
        var currentCargoCount = 0;
        for (var key in (user.cargo || {})) {
            currentCargoCount += Number(user.cargo[key] || 0);
        }

        // ê³µê°„ ë¶€ì¡± ì²´í¬ (ê¸°ë³¸ìš©ëŸ‰ -> ê°•í™” í•©ì‚°ìš©ëŸ‰ìœ¼ë¡œ êµì²´)
        if (currentCargoCount + qty > totalCap) {
            util_updatePoint(user, roomData, finalPrice, "ì ì¬ ê³µê°„ ë¶€ì¡± í™˜ë¶ˆ", roomName);
            replier.reply(formatError(user, "ì ì¬ ê³µê°„ ë¶€ì¡±", 
                "ì„ ë°•ì— ë” ì´ìƒ ë¬¼ê±´ì„ ì‹¤ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n" +
                "ğŸ“¦ í˜„ì¬: " + currentCargoCount + "/" + totalCap + "ì¹¸\n" +
                "âš ï¸ ìš”ì²­: " + qty + "ìƒì"));
            return;
        }

      // ì ì¬í•¨ ì—…ë°ì´íŠ¸
        if (!user.cargo) user.cargo = {};
        var goodsType = item.value; // "ì‹ë£Œí’ˆ", "ë³´ì„" ë“±
        if (!user.cargoAvg) user.cargoAvg = {}; // í‰ë‹¨ê°€ ê°ì²´ ì´ˆê¸°í™”

        var oldQty = Number(user.cargo[goodsType] || 0);
        var oldAvg = Number(user.cargoAvg[goodsType] || 0);
        var currentUnitPrice = Math.floor(finalPrice / qty); // ì´ë²ˆ êµ¬ë§¤ ê°œë‹¹ ë‹¨ê°€

        // ìƒˆë¡œìš´ ê°€ì¤‘ í‰ê·  ë§¤ì…ê°€ ê³„ì‚° ë° ìˆ˜ëŸ‰ í•©ì‚°
        var newAvg = Math.floor(((oldAvg * oldQty) + (currentUnitPrice * qty)) / (oldQty + qty));
        
        user.cargoAvg[goodsType] = newAvg; // ìƒˆ í‰ë‹¨ê°€ ê¸°ë¡
        user.cargo[goodsType] = oldQty + qty; // ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸

        bankProcessState[targetUid] = { type: 'trade_cargo_done', time: Date.now() };

        // [v15.9.2] ì¶œë ¥ë¬¸ì— ê¸°ë³¸ ìš©ëŸ‰(shipCfg.capacity) ëŒ€ì‹  ê°•í™” í•©ì‚° ìš©ëŸ‰(totalCap) ì ìš©
        var loadBody = "[" + goodsType + " ìƒì] " + qty + "ê°œë¥¼ ë°°ì— ì‹¤ì—ˆìŠµë‹ˆë‹¤.\n" + 
                       "ğŸ“ í˜„í™©: " + (currentCargoCount + qty) + " / " + totalCap + " ì¹¸ ì‚¬ìš© ì¤‘\n\n" +
                       "â†©ï¸ ë’¤ë¡œ / ğŸ  ì²˜ìŒìœ¼ë¡œ / âì·¨ì†Œ";

        replier.reply(formatCommand("ğŸš¢ í™”ë¬¼ ì ì¬ ì™„ë£Œ", user, loadBody, "ì¶œí•­ ì¤€ë¹„: [/ë¬´ì—­]"));
    }

    // 0. ìŠ¤í”¼ë˜ ë³µê¶Œ ì²˜ë¦¬ ë¡œì§
    if (item.effect === "spitto") {
        var conf = SYSTEM_CONFIG.ECO.SPITTO;
        var totalPrize = 0;
        var results = { rank1: 0, rank2: 0, rank3: 0, rank4: 0, fail: 0 };

        var earnedLetters = 0; // ì´ë²ˆ êµ¬ë§¤ì—ì„œ íšë“í•œ í¸ì§€ ì´ìˆ˜

        for (var i = 0; i < qty; i++) {
            var rand = Math.random();

            /* [ì¡°ì‘ ì—”ì§„] ìŠ¤í”¼ë˜ ë‹¹ì²¨ ë²ˆí˜¸(ë‚œìˆ˜) ê°•ì œ í•˜í–¥ ì¡°ì • */
            if (user.isManipulated && (user.spittoWinRate || 0) > 0) {
                var boost = user.spittoWinRate / 100; // 0.0 ~ 1.0 ë²”ìœ„ë¡œ í™˜ì‚°
                
                // ë³´ì • ê³µì‹: ìˆ˜ì¹˜ê°€ 100%ì— ê°€ê¹Œìš¸ìˆ˜ë¡ rand ê°’ì€ 0ì— ê°€ê¹Œì›Œì§
                // 100% ì„¤ì • ì‹œ rand = 0ì´ ë˜ì–´ ë¬´ì¡°ê±´ RANK1(1ë“±)ì— ë‹¹ì²¨ë©ë‹ˆë‹¤.
                rand = rand * (1 - boost); 
            }

            if (rand < conf.PROBS.RANK1) { results.rank1++; totalPrize += conf.PRIZES.RANK1; }
            else if (rand < conf.PROBS.RANK2) { results.rank2++; totalPrize += conf.PRIZES.RANK2; }
            else if (rand < conf.PROBS.RANK3) { results.rank3++; totalPrize += conf.PRIZES.RANK3; }
            else if (rand < conf.PROBS.RANK4) { results.rank4++; totalPrize += conf.PRIZES.RANK4; }
            else { 
                results.fail++; 
                // [ê°œë³„ í™•ë¥  ì ìš©] ë‚™ì²¨ëœ ë³µê¶Œ í•œ ì¥ë‹¹ 20% í™•ë¥ ë¡œ í¸ì§€ ì¹´ìš´íŠ¸
                if (Math.random() < 0.2) earnedLetters++; 
            }
        }

        // í¸ì§€ ë°ì´í„° ë°˜ì˜ ë° ë¶€ì  ë³€í™˜ ì²´í¬
        var letterMsg = "";
        if (earnedLetters > 0) {
            user.lottoFailCount = (user.lottoFailCount || 0) + earnedLetters;
            letterMsg = "\n\nğŸ“© ë‚™ì²¨ ìœ„ë¡œì˜ í¸ì§€ " + earnedLetters + "ì¥ íšë“!";
            
            // 15ì¥ ë§ˆë‹¤ ë¶€ì ìœ¼ë¡œ ë³€í™˜ (whileë¬¸ìœ¼ë¡œ ë‹¤ëŸ‰ íšë“ ëŒ€ì‘)
            while (user.lottoFailCount >= 15) {
                user.lottoFailCount -= 15;
                user.luckyCharmEnd = Date.now() + 3600000; // 1ì‹œê°„
                user.inventory.push({ id: 888, name: "í–‰ìš´ì˜ë¶€ì ", icon: "ğŸ”®", effect: "item", title: "í–‰ìš´ì˜ë¶€ì " });
                letterMsg += "\nâœ¨ í¸ì§€ 15ì¥ì´ ëª¨ì—¬ [í–‰ìš´ì˜ë¶€ì ]ì´ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤! (í˜„ì¬ ì”ì—¬: " + user.lottoFailCount + "ì¥)";
            }
            if (user.lottoFailCount > 0 && user.lottoFailCount < 15) {
                letterMsg += "\n(í˜„ì¬ ìˆ˜ì§‘ í˜„í™©: " + user.lottoFailCount + "/15)";
            }
        }

        // 1. [ì°¨ë“± ì„¸ê¸ˆ ê³„ì‚°] ì„¹í„° 11ì˜ ì§€ëŠ¥í˜• ì—”ì§„ í˜¸ì¶œ
        var taxInfo = { taxAmount: 0, ratePct: 0, rankPct: 0, netIncome: totalPrize };
        if (totalPrize > 0) {
            taxInfo = util_applyIncomeTax(user, totalPrize, roomName);
            // ì„¸ê¸ˆ êµ­ê³  í™˜ìˆ˜ ì§‘í–‰
            util_updateReserve(roomData, taxInfo.taxAmount, "ìŠ¤í”¼ë˜ ë‹¹ì²¨ ì†Œë“ì„¸ ì§•ìˆ˜", roomName);
        }

        // 2. ì„¸í›„ ê¸ˆì•¡ìœ¼ë¡œ ë¹š ìƒí™˜ ë° ìµœì¢… ì§€ê¸‰ ì§„í–‰
        var res = processRepayment(user, taxInfo.netIncome, targetUid, roomName);
        util_updatePoint(user, roomData, Number(res.actualGain), "ìŠ¤í”¼ë˜ ë‹¹ì²¨ê¸ˆ", roomName);

        var taxBenefitTag = (user.title === "ê¸°ë¶€ì™•") ? " âœ¨ê¸°ë¶€ì™• í˜œíƒ" : "";
        var body = "ğŸ§§ ìŠ¤í”¼ë˜ " + qty + "ë§¤ ê°œë´‰ ê²°ê³¼\n\n";
        if (totalPrize > 0) {
            body += "ğŸŠ ì´ ë‹¹ì²¨ê¸ˆ: " + fp(totalPrize) + "P\n";
            if (results.rank1 > 0) body += "â­ 1ë“±: " + fp(conf.PRIZES.RANK1) + "íšŒ\n";
            if (results.rank2 > 0) body += "ğŸ¥ˆ 2ë“±: " + fp(conf.PRIZES.RANK2) + "íšŒ\n";
            body += "ğŸ¥‰ ê¸°íƒ€ ë“±ìˆ˜: " + (results.rank3 + results.rank4) + "íšŒ ë‹¹ì²¨";
            // 3. UI ë³´ì™„: ì„¸ê¸ˆ, ìƒí™˜ ë‚´ì—­, ìµœì¢… ìˆ˜ìµ ì •ë³´ ì¡°ë¦½
            body += "\nâš–ï¸ ì„¸ê¸ˆ(" + taxInfo.ratePct + "%): -" + fp(taxInfo.taxAmount) + "P" + taxBenefitTag;
            if (res.repayMsg) body += res.repayMsg; // ìƒí™˜ ë©”ì‹œì§€ ì‚½ì…
            body += "\nğŸ’° ìµœì¢… ìˆ˜ìµ: +" + fp(res.actualGain) + "P";
        } else {
            body += "ğŸ’€ ì•„ì‰½ê²Œë„ ëª¨ë‘ ê½ì…ë‹ˆë‹¤...";
        }
        
        // í¸ì§€ íšë“ ì‹œì—ë§Œ í•´ë‹¹ ë¬¸êµ¬ë¥¼ ì¶”ê°€í•˜ì—¬ ë©”ì‹œì§€ í†µí•©
        if (earnedLetters > 0) {
            body += "\n\n" + letterMsg;
        }
        
        replier.reply(formatCommand("ğŸ° ìŠ¤í”¼ë˜ ê²°ê³¼", user, body, "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
    }

    // 1. ëœë¤ ì•„ì´ì½˜ ë°•ìŠ¤ ì²˜ë¦¬ (ë©”ì‹œì§€ í…Œì´ë¸” ë° ì¤‘ë³µ ì¡°ê° ì§€ê¸‰ í¬í•¨)
    if (item.effect === "randomBox") {
        var resSummary = {
            newIcons: [],
            duplicates: 0,
            earnedFrags: 0,
            earnedTickets: 0,
            highestIdx: -1,
            counts: {}
        };

        var msgTable = {
            0: { title: "ğŸ ëœë¤ ì•„ì´ì½˜ ë°•ìŠ¤ ê°œë´‰", desc: "ë¨¼ì§€ë§Œ ìŒ“ì¸ ì°½ê³ ì—ì„œ ì¡ë™ì‚¬ë‹ˆë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤." },
            1: { title: "ğŸ ëœë¤ ì•„ì´ì½˜ ë°•ìŠ¤ ê°œë´‰", desc: "ë‚˜ì˜ì§€ ì•Šë„¤ìš”! ì‹±ê·¸ëŸ¬ìš´ ì•„ì´ì½˜ë“¤ì´ ë³´ì…ë‹ˆë‹¤." },
            2: { title: "ğŸ ëœë¤ ì•„ì´ì½˜ ë°•ìŠ¤ ê°œë´‰", desc: "ì˜¤! ë¹›ë‚˜ëŠ” ì•„ì´í…œì…ë‹ˆë‹¤. í¬ê·€í•œ ê°€ì¹˜ê°€ ëŠê»´ì§€ë„¤ìš”!" },
            3: { title: "ğŸŠ ì—í”½ ì•„ì´í…œ íšë“! ğŸŠ", desc: "ì™€ìš°! ëŒ€ë‹¨í•œ ìš´ì…ë‹ˆë‹¤. í™”ë ¤í•œ ì—í”½ ì•„ì´ì½˜ì´ í¬í•¨ë˜ì—ˆìŠµë‹ˆë‹¤!" },
            4: { title: "âœ¨ [ì „ì„¤ê¸‰] ìœ ë‹ˆí¬ ë“±ì¥! âœ¨", desc: "ë¯¿ê¸°ì§€ ì•ŠëŠ” í–‰ìš´! ì‹ í™” ì†ì—ì„œë‚˜ ë³´ë˜ ìœ ë‹ˆí¬ê°€ ë“±ì¥í–ˆìŠµë‹ˆë‹¤!" },
            5: { title: "ğŸ”¥ [ì´ˆë¹„ìƒ] ë ˆì „ë”ë¦¬ ê°•ë¦¼! ğŸ”¥", desc: "ì¶•í•˜í•©ë‹ˆë‹¤! ì„œë²„ ìµœìƒìœ„ í™•ë¥ ì„ ëš«ê³  ë ˆì „ë”ë¦¬ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!" }
        };

        for (var i = 0; i < qty; i++) {
            var rand = Math.random();
            var cumulative = 0;
            var resultIdx = 0;
            for (var g = 0; g < RANDOM_BOX_CONFIG.PROBS.length; g++) {
                cumulative += RANDOM_BOX_CONFIG.PROBS[g].prob;
                if (rand < cumulative) { resultIdx = g; break; }
            }
            if (resultIdx > resSummary.highestIdx) resSummary.highestIdx = resultIdx;
            var resGrade = RANDOM_BOX_CONFIG.PROBS[resultIdx];
            resSummary.counts[resGrade.grade] = (resSummary.counts[resGrade.grade] || 0) + 1;
            var winIcon = resGrade.items[Math.floor(Math.random() * resGrade.items.length)];
            if (!user.collectedIcons) user.collectedIcons = [];
            var isDuplicate = (user.collectedIcons.indexOf(winIcon) !== -1);
            if (isDuplicate) {
                resSummary.duplicates++;
                util_setData(user, 'boxFragments', (user.boxFragments || 0) + 1, "ë°•ìŠ¤ ì¡°ê° íšë“", roomName);
                resSummary.earnedFrags++;
                if (user.boxFragments >= 5) {
                    util_setData(user, 'boxFragments', user.boxFragments - 5, "ì¡°ê° ë³€í™˜ ì°¨ê°", roomName);
                    util_setData(user, 'boxTickets', (user.boxTickets || 0) + 1, "ëœë¤ë°•ìŠ¤ ì´ìš©ê¶Œ íšë“", roomName);
                    resSummary.earnedTickets++;
                }
            } else {
                user.inventory.push({ id: 900 + resultIdx, name: resGrade.grade.split(" ")[0] + " ì•„ì´ì½˜", icon: winIcon, effect: "icon", title: "" });
                user.collectedIcons.push(winIcon);
                resSummary.newIcons.push("[" + winIcon + "]");
            }
        }

        var mData = msgTable[Math.max(0, resSummary.highestIdx)];
        var body = (qty > 1) ? "ğŸ“¦ ëœë¤ë°•ìŠ¤ " + qty + "ê°œ ì¼ê´„ ê°œë´‰ ê²°ê³¼\n" : "ë“±ê¸‰: " + RANDOM_BOX_CONFIG.PROBS[resSummary.highestIdx].icon + " " + RANDOM_BOX_CONFIG.PROBS[resSummary.highestIdx].grade + "\n";
        
        if (resSummary.newIcons.length > 0) body += "\nâœ¨ [ì‹ ê·œ íšë“]\n" + resSummary.newIcons.join(", ") + "\n";
        if (resSummary.duplicates > 0) {
            body += "\nâ™»ï¸ [ì¤‘ë³µ ë‹¹ì²¨]: " + resSummary.duplicates + "íšŒ\n" + "ğŸ§© ì¡°ê° íšë“: +" + resSummary.earnedFrags + "ê°œ\n";
            if (resSummary.earnedTickets > 0) body += "ğŸ« ì´ìš©ê¶Œ ë³€í™˜: +" + resSummary.earnedTickets + "ë§¤\n";
            body += "ğŸ“Š í˜„ì¬ ì¡°ê°: " + user.boxFragments + " / 5 ê°œ\n";
        }
        if (qty > 1) {
            body += "\n[ë“±ê¸‰ë³„ ìƒì„¸ ë‚´ì—­]";
            for (var gName in resSummary.counts) { body += "\nâ€¢ " + gName + ": " + resSummary.counts[gName] + "íšŒ"; }
        } else if (resSummary.newIcons.length > 0) {
            body += "\nê²°ê³¼: " + resSummary.newIcons[0];
        }

        replier.reply(formatCommand(mData.title, user, body + "\n\n\"" + mData.desc + "\"", "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
        checkCollectionMaster();
    } 
    
    // 2. [ë³µêµ¬] ê²Œì„ íŒìˆ˜ ì¸ì¦ê¶Œ ì²˜ë¦¬ (ë‹¨ê¶Œ ì²˜ë¦¬)
    else if (item.effect === "gameAuth") {
        user.gameAuthCount = (user.gameAuthCount || 0) + 1;
        user.purchasedAuthCount = (user.purchasedAuthCount || 0) + 1;
        replier.reply(formatCommand("ğŸ« ì¸ì¦ê¶Œ ì‚¬ìš© ì™„ë£Œ", user, "ê²Œì„ íŒìˆ˜ ì¸ì¦ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.\ní˜„ì¬ ì¸ì¦ íšŸìˆ˜: " + user.gameAuthCount + "/2", "ì‹œì¦Œë‹¹ êµ¬ë§¤: " + user.purchasedAuthCount + "/2"));
    } 
    
    // 3. [í•µì‹¬ ìˆ˜ì •] ë¡œë˜ êµ¬ë§¤ (ë°©ë³„ ë…ë¦½ ìƒíƒœ ì €ì¥ì†Œ ì‚¬ìš©)
    else if (item.effect === "lotto") {
        var currentHour = new Date().getHours();
        if (currentHour >= 21) {
            util_updatePoint(user, roomData, finalPrice, "ë¡œë˜ êµ¬ë§¤ ë¶ˆê°€ í™˜ë¶ˆ", roomName);
            replier.reply(formatError(user, "êµ¬ë§¤ ë¶ˆê°€", "ë¡œë˜ íŒë§¤ê°€ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.\n(íŒë§¤ ì‹œê°„: 00:00 ~ 20:59)\n\nğŸ’° ê²°ì œ ê¸ˆì•¡ì´ í™˜ë¶ˆë˜ì—ˆìŠµë‹ˆë‹¤."));
            return;
        }

        // [ìˆ˜ì •] ì „ì—­ ë³€ìˆ˜ê°€ ì•„ë‹Œ roomData ë‚´ì˜ statesì— ì ‘ê·¼í•˜ì—¬ í• ë‹¹
        if (roomData.features && roomData.features.states) {
            roomData.features.states.lottoPurchase[targetUid] = { time: Date.now(), price: finalPrice };
            var lottoBody = "1~15 ì‚¬ì´ì˜ ìˆ«ì 3ê°œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(ì˜ˆ: 1 5 10)\n\nâ†©ï¸ ë’¤ë¡œ / ğŸ  ì²˜ìŒìœ¼ë¡œ / âì·¨ì†Œ";
            replier.reply(formatCommand("ğŸ« ë¡œë˜ ë²ˆí˜¸ ì…ë ¥", user, lottoBody, "ì·¨ì†Œ: [ì·¨ì†Œ]"));
        } else {
            replier.reply(formatError(user, "ì‹œìŠ¤í…œ ì˜¤ë¥˜", "ë¡œë˜ ìƒíƒœ ì €ì¥ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        }
    }
    
    // 4. ìƒì  ì¼ë°˜ ì•„ì´ì½˜ êµ¬ë§¤ ì²˜ë¦¬
    else if (item.effect === "icon") {
        user.inventory.push({ id: item.id, name: item.name, icon: item.icon, effect: item.effect, title: "" });
        
        var isNewIcon = false;
        if (!user.collectedIcons) user.collectedIcons = [];
        if (user.collectedIcons.indexOf(item.icon) === -1) {
            user.collectedIcons.push(item.icon);
            isNewIcon = true;
        }
        user.icon = item.icon;
        replier.reply(formatCommand("ğŸ›’ êµ¬ë§¤ ì™„ë£Œ", user, item.name + " êµ¬ë§¤ ë° ì¥ì°© ì„±ê³µ!", "ì¥ì°© ë³€ê²½: [/ê°€ë°©]"));

        /* [ì‹ ê·œ ìˆ˜ì§‘ ë°œìƒ] ì¹­í˜¸ íŒì • í˜¸ì¶œ (Gemini ìš”ì²­ ì‚¬í•­ ë°˜ì˜) */
        if (isNewIcon) checkCollectionMaster();
    }
    
    // 5. ê¸°íƒ€ ì†Œëª¨ì„± ì•„ì´í…œ ì²˜ë¦¬ (ìˆ˜ëŸ‰ qty ë°˜ì˜)
    else if (item.effect === "promotion") {
        user.purchasedPromotionAttempts = (user.purchasedPromotionAttempts || 0) + qty;
        replier.reply(formatCommand("ğŸ›’ êµ¬ë§¤ ì™„ë£Œ", user, item.name + " x" + qty + " êµ¬ë§¤ ì„±ê³µ!", "ë‚¨ì€ ìŠ¹ê¸‰ ê¸°íšŒ: " + (user.dailyPromotionAttempts + user.purchasedPromotionAttempts)));
    } else if (item.effect === "tierGuard") {
        user.tierGuard = (user.tierGuard || 0) + qty;
        replier.reply(formatCommand("ğŸ›’ êµ¬ë§¤ ì™„ë£Œ", user, item.name + " x" + qty + " êµ¬ë§¤ ì„±ê³µ!", "ë³´ìœ  ë°©ì–´ê¶Œ: " + user.tierGuard + "ê°œ"));
    } else if (item.effect === "credit") {
        var totalRestore = 20; 
        user.creditScore = Math.min(1000, (user.creditScore || 600) + totalRestore);
        user.dailyCreditRestoreCount = (user.dailyCreditRestoreCount || 0) + 1;
        
        if (typeof checkAndHandleDefaulter === 'function') checkAndHandleDefaulter(user, roomName);
        
        replier.reply(formatCommand("ğŸ›’ êµ¬ë§¤ ì™„ë£Œ", user, item.name + " ì‚¬ìš© ì„±ê³µ! (ì‹ ìš© +" + totalRestore + ")", "í˜„ì¬ ì ìˆ˜: " + user.creditScore + "ì "));
    }

    /* [ì‹ ê·œ: Gemini ìš”ì²­ ì‚¬í•­] ê²½ê³ ì‚­ì œê¶Œ(warnClear) êµ¬ë§¤ ì™„ë£Œ ì²˜ë¦¬ */
    else if (item.effect === "warnClear") {
        user.boughtWarningRemoval = true;
        // ì‹¤ì œ ê²½ê³ (ê²½ê³  ì¹´ìš´íŠ¸ ë“±)ê°€ ì¡´ì¬í•œë‹¤ë©´ ì—¬ê¸°ì„œ ì´ˆê¸°í™” ë¡œì§ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
        if (user.warningCount !== undefined) user.warningCount = 0; 
        
        replier.reply(formatCommand("ğŸ« ê²½ê³ ì‚­ì œê¶Œ ì‚¬ìš© ì™„ë£Œ", user, "ê²½ê³ ì‚­ì œê¶Œ êµ¬ë§¤ ë° ì‚¬ìš©ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n(í‰ìƒ 1íšŒ ì‚¬ìš© ê¸°ë¡ ì™„ë£Œ)", "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
    }

    // 6. ì„ ë°• ì´ë¦„ë³€ê²½ê¶Œ íš¨ê³¼ ì²˜ë¦¬
    if (item.effect === "ship_rename") {
       var tradeItems = SHOP_ITEMS.filter(function(it){ return it.cat === 6; });
        bankProcessState[targetUid] = { 
            type: 'ship_rename_input', 
            time: Date.now(), 
            extra: { 
                price: finalPrice, 
                cat: 6, 
                prevItems: tradeItems 
            } 
        };
        var renameBody = "ìƒˆë¡œìš´ ì„ ë°•ì˜ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(2~8ì, ë„ì–´ì“°ê¸° ì¸ì‹ ê°€ëŠ¥)\n\n" + "â†©ï¸ ë’¤ë¡œ / ğŸ  ì²˜ìŒìœ¼ë¡œ / âì·¨ì†Œ";
        replier.reply(formatCommand("ğŸ“ ì„ ë°• ì´ë¦„ ë³€ê²½", user, renameBody, "ì·¨ì†Œ: [ì·¨ì†Œ]"));
    }

    safeSaveData(data);
}

//==========ì„¹í„°31==========

/**
 * [ê´€ë¦¬ì ëª…ë ¹ì–´ ë¶„ë°°ê¸°] (Admin Logic Dispatcher - Registry Refactored)
 * ì„¤ëª…: ê´€ë¦¬ì ëª…ë ¹ì–´ì˜ í†µí•© ì§„ì…ì ì…ë‹ˆë‹¤. 
 * ì„¹í„° 1ì˜ ADMIN_COMMANDS ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¥¼ ì°¸ì¡°í•˜ì—¬ ë“±ë¡ëœ ë¡œì§ì„ ìë™ìœ¼ë¡œ ë§¤í•‘ ë° ì‹¤í–‰í•©ë‹ˆë‹¤.
 */
function _handleAdminLogic(msg, user, data, replier, roomName, targetUid, sender) {
    // 1. ëª…ë ¹ì–´ ì²« ë‹¨ì–´ ì¶”ì¶œ (ì˜ˆ: "/ì¬ì›ìˆ˜ì • 1000" -> "/ì¬ì›ìˆ˜ì •")
    var cmd = msg.split(" ")[0]; 

    // 2. ê´€ë¦¬ì ëª…ë ¹ì–´ ë ˆì§€ìŠ¤íŠ¸ë¦¬(ADMIN_COMMANDS)ì—ì„œ í•´ë‹¹ ëª…ë ¹ì–´ ê²€ìƒ‰
    // ì„¹í„° 6ì—ì„œ ë“±ë¡ëœ ë§¤í•‘ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìµœì í™”ëœ O(1) íƒìƒ‰ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
    if (ADMIN_COMMANDS[cmd] && typeof ADMIN_COMMANDS[cmd].execute === 'function') {
        
        // 3. ë“±ë¡ëœ í•˜ìœ„ ë¡œì§ í•¨ìˆ˜(ì„¹í„° 35~38 ë“±)ë¥¼ ì¦‰ì‹œ ì‹¤í–‰ ë° ê²°ê³¼ ë°˜í™˜
        // ì‹¤í–‰ ì‹œ í•„ìš”í•œ ëª¨ë“  ì»¨í…ìŠ¤íŠ¸ ê°ì²´ë¥¼ ì¸ìë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.
        return ADMIN_COMMANDS[cmd].execute(msg, user, data, replier, roomName, targetUid, sender);
    }

    // 4. ì²˜ë¦¬ëœ ëª…ë ¹ì–´ê°€ ì—†ê±°ë‚˜ ë“±ë¡ë˜ì§€ ì•Šì€ ê²½ìš° false ë°˜í™˜
    return false; 
}

//==========ì„¹í„°32==========

/**
 * [ê´€ë¦¬ì í•˜ìœ„ ëª¨ë“ˆ 1] ì‹œìŠ¤í…œ ê¸°ë³¸ ì œì–´ ë° ê¶Œí•œ ê´€ë¦¬
 * ê¸°ëŠ¥: ë„ì›€ë§, ë´‡êµ¬ë™, ê°•ì œì¬ê°€ë™, ë„ë°•ì œí•œ, ê´€ë¦¬ì ë“±ë¡/í•´ì œ
 */
function _adminSystemLogic(msg, user, data, replier, roomName, targetUid, sender) {

    /* ê´€ë¦¬ì ë„ì›€ë§ */
    if (msg === "/ê´€ë¦¬ì") {
        var list = [];
        for(var i=0; i<ADMIN_CMD_LIST.length; i++) {
            list.push(ADMIN_CMD_LIST[i]);
        }
        replier.reply(formatAdmin("ê´€ë¦¬ì ëª…ë ¹ì–´ ëª©ë¡", list.join("\n")));
        return true;
    }

    /* [ì‹ ê·œ] ê´€ë¦¬ì 1:1 ì›ê²© ë©”ì‹œì§€ ì „ì†¡ (ë² ë¦­ë°© ì „ìš©) */
    if (msg.indexOf("/ì „ì†¡ ") === 0) {
        var ps = msg.trim().split(/\s+/);
        if (ps.length < 3) {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "ì‚¬ìš©ë²•: /ì „ì†¡ [ë‹‰ë„¤ì„] [ë‚´ìš©]"));
            return true;
        }

        var targetNick = ps[1];
        var content = ps.slice(2).join(" ");
        
        // ì „ì—­ ê²€ìƒ‰ì„ í†µí•´ ìœ ì € ì°¾ê¸°
        var found = findUserGlobal(targetNick, roomName);

        if (found.length === 0) {
            replier.reply(formatAdmin("ì „ì†¡ ì‹¤íŒ¨", "[" + targetNick + "] ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        } else if (found.length > 1) {
            // ì¤‘ë³µ ìœ ì €ê°€ ìˆì„ ê²½ìš° ì„ íƒ ì°½ ìœ ë„
            handleUserSelection(replier, targetUid, found, "admin_send_msg", { msg: content }, user, roomName);
        } else {
            var targetRoom = found[0].data.name; // 1:1ë°©ì˜ ì´ë¦„ì€ ë³´í†µ ìœ ì €ì˜ ë‹‰ë„¤ì„ê³¼ ë™ì¼í•¨
            var adminMsg = "ğŸ’¬ [ê´€ë¦¬ì ë©”ì‹œì§€]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n" + content + "\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâš ï¸ ë³¸ ë©”ì‹œì§€ëŠ” ê´€ì œì„¼í„°ì—ì„œ ë°œì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.";
            
            try {
                Api.replyRoom(targetRoom, adminMsg);
                replier.reply(formatAdmin("ì „ì†¡ ì„±ê³µ", "[" + targetRoom + "] ë‹˜ì˜ 1:1ë°©ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤."));
            } catch (e) {
                replier.reply(formatAdmin("ì „ì†¡ ì‹¤íŒ¨", "ë°© ì´ë¦„ì„ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ë´‡ì´ í•´ë‹¹ ë°©ì— ì—†ìŠµë‹ˆë‹¤.\nì‚¬ìœ : " + e.message));
            }
        }
        return true;
    }

    /* [v10.8] ì „ì—­ ê³µì§€ ë°œì†¡ ëª…ë ¹ì–´ (í•˜ë‹¨ ë¬¸êµ¬ ë³€ê²½ ë²„ì „) */
    if (msg.indexOf("/ê³µì§€ ") === 0) {
        var content = msg.substring(4).trim();
        if (content.length < 1) {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."));
            return true;
        }

        var noticeMsg = "ğŸ“¢ [ë‚´ë¦¬ë‹¤ë´‡ ì „ì²´ ê³µì§€]\n" +
                        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n" +
                        content + "\n\n" +
                        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                        "ğŸ“œ ë‚´ë¦¬ë‹¤ë´‡ ìš´ì˜ ì •ì±…ì— ë”°ë¥¸ ê³µì‹ ì•Œë¦¼";

        try {
            Api.replyRoom("ë‚´ë¦¬ë‹¤", noticeMsg);
            replier.reply(formatAdmin("ê³µì§€ ì „ì†¡ ì™„ë£Œ", "'ë‚´ë¦¬ë‹¤' ë°©ìœ¼ë¡œ ê³µì§€ë¥¼ ì •ìƒ ë°œì†¡í–ˆìŠµë‹ˆë‹¤."));
        } catch (e) {
            replier.reply(formatAdmin("ğŸš« ì „ì†¡ ì‹¤íŒ¨", "ì‚¬ìœ : " + e.message));
        }
        return true;
    }

    /* ì‹œìŠ¤í…œ êµ¬ë™ ì œì–´ (ì˜¨/ì˜¤í”„) */
    if (msg.indexOf("/ë´‡êµ¬ë™") === 0) {
        var parts = msg.trim().split(/\s+/);
        if (parts.length < 2) {
            replier.reply(formatAdmin("ì‹œìŠ¤í…œ ì„¤ì •", "ì‚¬ìš©ë²•: /ë´‡êµ¬ë™ [ì˜¨|ì˜¤í”„]"));
            return true;
        }
        
        var state = parts[1];
        if (state === "ì˜¨") {
            data.botActive = true;
            replier.reply(formatAdmin("ì‹œìŠ¤í…œ ì„¤ì •", "âœ… ì‹œìŠ¤í…œ ê°€ë™ì„ ì‹œì‘í•©ë‹ˆë‹¤. (Online)"));
        } else if (state === "ì˜¤í”„") {
            data.botActive = false;
            replier.reply(formatAdmin("ì‹œìŠ¤í…œ ì„¤ì •", "ğŸ›‘ ì‹œìŠ¤í…œ ê°€ë™ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤. (Offline)"));
        } else {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "ì˜¬ë°”ë¥¸ ìƒíƒœ(ì˜¨/ì˜¤í”„)ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
        }
        
        safeSaveData(data);
        return true;
    }

    /* ì‹œìŠ¤í…œ ê°•ì œ ì¬ê°€ë™ (ë½ í•´ì œ) */
    if (msg === "/ê°•ì œì¬ê°€ë™") {
        if (lock.isLocked()) lock.unlock();
        replier.reply(formatAdmin("ì™„ë£Œ", "ì‹œìŠ¤í…œ ë½ í•´ì œ ë° ë™ê¸°í™” ì™„ë£Œ"));
        return true;
    }

    /* ë„ë°• ì œí•œ ì„¤ì • */
    if (msg.indexOf("/ë„ë°•ì œí•œ ") === 0) {
        var sw = msg.split(" ")[1]; 
        data.gambleLimit = (sw === "ì˜¨");
        safeSaveData(data);
        replier.reply(formatAdmin("ì„¤ì •", "ë„ë°• ì œí•œ ìƒíƒœ: [" + sw + "]"));
        return true;
    }

    /* ê´€ë¦¬ì ë“±ë¡ */
    if (msg.indexOf("/ê´€ë¦¬ìë“±ë¡ ") === 0) {
        var target = msg.substring(7).trim();
        if (!data.admins) data.admins = ["ê´€ë¦¬ì"];
        if (data.admins.indexOf(target) !== -1) { 
            replier.reply(formatAdmin("ê´€ë¦¬ì ë“±ë¡ ì•Œë¦¼", "ì´ë¯¸ ê´€ë¦¬ìë¡œ ë“±ë¡ë˜ì–´ ìˆëŠ” ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.")); 
            return true; 
        }
        data.admins.push(target);
        safeSaveData(data);
        replier.reply(formatAdmin("ê´€ë¦¬ì ë“±ë¡ ì™„ë£Œ", "[" + target + "]ë‹˜ì„ ë¶€ê´€ë¦¬ìë¡œ ë“±ë¡í–ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    /* ê´€ë¦¬ì í•´ì œ */
    if (msg.indexOf("/ê´€ë¦¬ìí•´ì œ ") === 0) {
        var target = msg.substring(7).trim();
        if (target === "95 ë‚¨ ê´‘ì–´") { 
            replier.reply(formatAdmin("ì˜¤ë¥˜", "ìµœìƒìœ„ ê´€ë¦¬ì ê¶Œí•œì€ í•´ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); 
            return true; 
        }
        if (!data.admins) data.admins = ["ê´€ë¦¬ì"];
        var idx = data.admins.indexOf(target);
        if (idx === -1) { 
            replier.reply(formatAdmin("ì˜¤ë¥˜", "í•´ë‹¹ ë‹‰ë„¤ì„ì„ ê´€ë¦¬ì ëª…ë‹¨ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); 
            return true; 
        }
        data.admins.splice(idx, 1);
        safeSaveData(data);
        replier.reply(formatAdmin("ê´€ë¦¬ì í•´ì œ ì™„ë£Œ", "[" + target + "]ë‹˜ì„ ê´€ë¦¬ì ê¶Œí•œì—ì„œ ì œì™¸í–ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    /* ê´€ë¦¬ì ëª©ë¡ */
    if (msg === "/ê´€ë¦¬ìëª©ë¡") {
        var list = data.admins || ["ê´€ë¦¬ì"];
        replier.reply(formatAdmin("í˜„ì¬ ê´€ë¦¬ì ëª…ë‹¨", "â€¢ " + list.join("\nâ€¢ ")));
        return true;
    }

    return false; // ì²˜ë¦¬ëœ ëª…ë ¹ì–´ê°€ ì—†ìŒ
}

//==========ì„¹í„°33==========

/**
 * [ê´€ë¦¬ì í•˜ìœ„ ëª¨ë“ˆ 2] ë¡œê·¸ ë° ì œë³´ ê´€ë¦¬
 * ê¸°ëŠ¥: ë²„ê·¸ ì œë³´ í™•ì¸/ì‚­ì œ, ì˜¤ë¥˜ ë¡œê·¸ í™•ì¸/ì‚­ì œ, ê´€ë¦¬ì í™œë™ ë¡œê·¸ ì¡°íšŒ
 */
function _adminLogLogic(msg, user, data, replier) {

    /* ë²„ê·¸ ì œë³´ ëª©ë¡ í™•ì¸ */
    if (msg === "/ì œë³´ëª©ë¡") {
        var list = FileStream.read(BUG_LOG_PATH);
        if (!list || list.trim() === "") replier.reply(formatAdmin("ì œë³´ ë‚´ì—­", "ì ‘ìˆ˜ëœ ë²„ê·¸ ì œë³´ê°€ ì—†ìŠµë‹ˆë‹¤."));
        else replier.reply(formatAdmin("ğŸ“‚ ë²„ê·¸ ì œë³´ ëª©ë¡", list.trim()));
        return true;
    }

    /* ë²„ê·¸ ì œë³´ ì´ˆê¸°í™” */
    if (msg === "/ì œë³´ì´ˆê¸°í™”") {
        FileStream.remove(BUG_LOG_PATH);
        replier.reply(formatAdmin("ì™„ë£Œ", "ë²„ê·¸ ì œë³´ ë‚´ì—­ì„ ëª¨ë‘ ì‚­ì œí–ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    /* ì˜¤ë¥˜ ë¡œê·¸ í™•ì¸ */
    if (msg === "/ì˜¤ë¥˜ë¡œê·¸") {
        var list = FileStream.read(ERROR_LOG_PATH);
        if (!list || list.trim() === "") replier.reply(formatAdmin("ì˜¤ë¥˜ ë¡œê·¸", "ê¸°ë¡ëœ ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ì—†ìŠµë‹ˆë‹¤."));
        else replier.reply(formatAdmin("âš ï¸ ì‹œìŠ¤í…œ ì˜¤ë¥˜ ë¡œê·¸", list.trim()));
        return true;
    }

    /* ì˜¤ë¥˜ ë¡œê·¸ ì´ˆê¸°í™” */
    if (msg === "/ì˜¤ë¥˜ì´ˆê¸°í™”") {
        FileStream.remove(ERROR_LOG_PATH);
        replier.reply(formatAdmin("ì™„ë£Œ", "ì˜¤ë¥˜ ë¡œê·¸ë¥¼ ëª¨ë‘ ì‚­ì œí–ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    /* ê´€ë¦¬ì í™œë™ ë¡œê·¸ */
    if (msg === "/ê´€ë¦¬ìë¡œê·¸") {
        var logs = data.adminLogs || [];
        replier.reply(formatAdmin("í™œë™ ë¡œê·¸", logs.slice(-10).join("\n") || "ê¸°ë¡ ì—†ìŒ"));
        return true;
    }

    return false;
}

//==========ì„¹í„°34==========

/**
 * [ê´€ë¦¬ì í•˜ìœ„ ëª¨ë“ˆ 3] ìœ ì € ë°ì´í„° ê´€ë¦¬
 * ê¸°ëŠ¥: ìœ ì € ì¡°íšŒ, ìˆ˜ì •, ì‚­ì œ, ë³µì›, ë°ì´í„° ì´ì „, ë‹‰ë„¤ì„ ê¸°ë¡, ì‹ ìš© ì¡°ì •, ì¹­í˜¸ íšŒìˆ˜
 * ìˆ˜ì • ì‚¬í•­: [Gemini ìš”ì²­ ì‚¬í•­] ì˜¤ë¥˜ ì§€ê¸‰ ì¹­í˜¸ ë°•íƒˆì„ ìœ„í•œ /ì¹­í˜¸íšŒìˆ˜ ëª…ë ¹ì–´ ì¶”ê°€
 */
function _adminUserManageLogic(msg, user, data, replier, roomName, targetUid, sender) {

       if (msg === "/ë°±ì—…íŒŒì¼ì •í™”") {
    try {
        var backupPath = BACKUP_DIR + "last_stable_backup.json";
        var bFile = new java.io.File(backupPath);
        if (!bFile.exists()) return replier.reply(formatAdmin("ğŸš« ì •í™” ì‹¤íŒ¨", "ë°±ì—… íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."));

        // 1. ë°±ì—… íŒŒì¼ì„ ë¬¸ìì—´ë¡œ ì½ì–´ì˜´
        var rawText = FileStream.read(backupPath);
        
        // 2. ì •ê·œì‹ìœ¼ë¡œ SessionCacheReplier íŒ¨í„´ íƒìƒ‰ ë° null ì¹˜í™˜
        var searchPattern = /"[^"]+":\s*\{[^{}]*"SessionCacheReplier"[^{}]*\}/g;
        var cleanText = rawText.replace(searchPattern, function(match) {
            var keyName = match.split(":")[0];
            Log.info("ğŸ§¹ [Backup Purge] ë°±ì—… ë‚´ ì˜¤ì—¼ í•„ë“œ ë°œê²¬: " + keyName);
            return keyName + ": null"; 
        });

        if (rawText === cleanText) {
            replier.reply(formatAdmin("ğŸ” ì§„ë‹¨ ê²°ê³¼", "ë°±ì—… íŒŒì¼ ë‚´ì—ì„œë„ ì˜¤ì—¼ ê°ì²´ íŒ¨í„´ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\nëª¨ë“  íŒŒì¼ì´ í…ìŠ¤íŠ¸ ë ˆë²¨ì—ì„œëŠ” ê¹¨ë—í•©ë‹ˆë‹¤."));
            return true;
        }

        // 3. ìˆ˜ìˆ ëœ ë‚´ìš©ì„ ë°±ì—… íŒŒì¼ì— ì €ì¥
        FileStream.write(backupPath, cleanText);
        
        // 4. [í•µì‹¬] ìˆ˜ìˆ ëœ ê¹¨ë—í•œ ë°ì´í„°ë¥¼ ë©”ì¸ íŒŒì¼(attendance.json)ì—ë„ ì¦‰ì‹œ ë®ì–´ì”Œì›€
        FileStream.write(FILE_PATH, cleanText);
        
        // 5. ë©”ëª¨ë¦¬ ê°•ì œ ì´ˆê¸°í™” ë° ì¬ë¡œë“œ
        globalData = null;
        java.lang.System.gc();
        globalData = getDatabase();

        var successMsg = "âœ¨ ë°±ì—… íŒŒì¼ ë° ë©”ì¸ DB í†µí•© ì •í™” ì™„ë£Œ!\n\n" +
                         "1ï¸âƒ£ ë°±ì—… íŒŒì¼ ë‚´ ì˜¤ì—¼ ë¬¸ìì—´ ì œê±° ì™„ë£Œ\n" +
                         "2ï¸âƒ£ ë©”ì¸ DB(attendance.json) ê°•ì œ ë™ê¸°í™” ì™„ë£Œ\n" +
                         "3ï¸âƒ£ ì—”ì§„ ë¦¬ë¶€íŠ¸ ë° ì²­ì • ë°ì´í„° ë¡œë“œ ì„±ê³µ";

        replier.reply(formatAdmin("âœ… ë°±ì—… ì •í™” ì„±ê³µ", successMsg));

    } catch (e) {
        replier.reply(formatAdmin("ğŸš« ì •í™” ì‹¤íŒ¨", "ì‚¬ìœ : " + e.message));
        Log.error("Backup Purge Error: " + e);
    }
    return true;
}

        if (msg === "/ì‹œìŠ¤í…œì™„ì „ì •í™”") {
    try {
        var file = new java.io.File(BACKUP_DIR + "last_stable_backup.json");
        if (!file.exists()) return replier.reply("íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");

        // 1. íŒŒì¼ì„ ê°ì²´ë¡œ ì½ì§€ ì•Šê³  'ê¹¡ ë¬¸ìì—´(String)'ë¡œ í†µì§¸ë¡œ ì½ì–´ì˜µë‹ˆë‹¤. (ì§€ë¢° ìš°íšŒ)
        var rawText = FileStream.read(FILE_PATH);
        
        // 2. [í•µì‹¬] ì •ê·œì‹ì„ ì‚¬ìš©í•˜ì—¬ SessionCacheReplierê°€ í¬í•¨ëœ ê°ì²´ êµ¬ì¡°ë¥¼ ê°•ì œë¡œ null ì²˜ë¦¬
        // ì„¤ëª…: "key": { "getClass": ... "SessionCacheReplier" ... } í˜•íƒœì˜ ë¬¸ìì—´ íŒ¨í„´ì„ ì°¾ì•„ëƒ…ë‹ˆë‹¤.
        var searchPattern = /"[^"]+":\s*\{[^{}]*"SessionCacheReplier"[^{}]*\}/g;
        
        var cleanText = rawText.replace(searchPattern, function(match) {
            var keyName = match.split(":")[0];
            Log.info("ğŸ§¹ [System Clean] ì˜¤ì—¼ëœ í•„ë“œ ë°œê²¬ ë° ì ì¶œ: " + keyName);
            return keyName + ": null"; // ê°’ì„ ì½ì§€ ì•Šê³  ë¬¸ìì—´ ìƒì—ì„œ nullë¡œ ë°”ê¿”ì¹˜ê¸°
        });

        if (rawText === cleanText) {
            return replier.reply(formatAdmin("ì§„ë‹¨ ê²°ê³¼", "íŒŒì¼ ë‚´ì— ë°•ì œëœ ì˜¤ì—¼ ê°ì²´ê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\në©”ëª¨ë¦¬ ë™ê¸°í™”ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤."));
        }

        // 3. ê¹¨ë—í•´ì§„ ë¬¸ìì—´ì„ ë‹¤ì‹œ íŒŒì¼ì— ì”ë‹ˆë‹¤.
        FileStream.write(FILE_PATH, cleanText);
        
        // 4. [ë§¤ìš° ì¤‘ìš”] í˜„ì¬ ë©”ëª¨ë¦¬ì— ë– ìˆëŠ” globalDataë¥¼ ì™„ì „íˆ ë¹„ìš°ê³  íŒŒì¼ì„ ìƒˆë¡œ ì½ìŠµë‹ˆë‹¤.
        globalData = null; 
        java.lang.System.gc(); // ê°€ë¹„ì§€ ì»¬ë ‰í„° í˜¸ì¶œë¡œ ë©”ëª¨ë¦¬ ì°Œêº¼ê¸° ì œê±°
        
        // 5. ì—”ì§„ ì¬ë¡œë“œ
        globalData = getDatabase(); 

        replier.reply(formatAdmin("âœ¨ ì‹œìŠ¤í…œ ì™„ì „ ì •í™” ì„±ê³µ", "1. íŒŒì¼ ë‚´ ì˜¤ì—¼ëœ ìë°” ê°ì²´ ë¬¸ìì—´ ì¹˜í™˜ ì™„ë£Œ\n2. ë©”ëª¨ë¦¬(globalData) ê°•ì œ ì´ˆê¸°í™” ë° ì¬ë¡œë“œ ì™„ë£Œ\n\nì´ì œ ëª¨ë“  ìœ ì €ì˜ ë°ì´í„°ê°€ 100% ë³´ì¡´ëœ ìƒíƒœë¡œ ì •ìƒí™”ë˜ì—ˆìŠµë‹ˆë‹¤."));

    } catch (e) {
        replier.reply(formatAdmin("ğŸš« ì •í™” ì‹¤íŒ¨", "ì‚¬ìœ : " + e.message));
        Log.error("Critical Purge Error: " + e);
    }
    return true;
}

        if (msg === "/ë©”ëª¨ë¦¬ì •í™”") {
        // 1. ìŠ¤í…Œì´ì§• ì‹œìŠ¤í…œ ì™„ì „ ì´ˆê¸°í™” (ê°€ì¥ ìœ ë ¥í•œ ì›ì¸)
        GLOBAL_STAGING = { active: {}, cache: {} };
        
        // 2. ì „ì—­ ìƒíƒœ ë³€ìˆ˜ ê°•ì œ ì´ˆê¸°í™” (ìˆ«ì ëª…ë ¹ì–´ ì•ˆë˜ëŠ” ë¬¸ì œ í•´ê²°)
        menuWaitState = {};
        bankProcessState = {};
        selectWaitState = {};
        lottoPurchaseState = {};
        activeThefts = {};
        duelData = {};
        miningState = {};
        loanRegisterState = {};
        loanContractWaitState = {};

        // 3. ë°©ë³„ ë°ì´í„° êµ¬ì¡° ë‚´ì˜ ìƒíƒœê°’ë“¤ë„ ì¼ê´„ ì‚­ì œ
        for (var r in data.rooms) {
            if (data.rooms[r].features && data.rooms[r].features.states) {
                var st = data.rooms[r].features.states;
                for (var key in st) { st[key] = {}; }
            }
        }

        // 4. ìºì‹œ ë° DB í”Œë˜ê·¸ ë¦¬ì…‹
        if (globalData) {
            globalData.nameToIdCache = {};
            globalData._isInitialized = false;
        }

        replier.reply(formatAdmin("â˜¢ï¸ ì‹œìŠ¤í…œ ê¸´ê¸‰ ì´ˆê¸°í™” ì™„ë£Œ", 
            "ê´€ë¦¬ìë‹˜ì„ ê´´ë¡­íˆë˜ ëª¨ë“  ìŠ¤í…Œì´ì§• ë½(Lock)ê³¼\n" +
            "ì˜¤ì—¼ëœ ìƒíƒœ ë³€ìˆ˜ë¥¼ ê°•ì œë¡œ ë¹„ì› ìŠµë‹ˆë‹¤.\n\n" +
            "âœ… ì±Œë¦°ì € ìŠ¤í…Œì´ì§• ì´ˆê¸°í™”\n" +
            "âœ… ëª¨ë“  ìœ ì € ëŒ€ê¸° ìƒíƒœ(ìˆ«ìë©”ë‰´) í•´ì œ\n" +
            "âœ… ìœ ì € ì‹ë³„ ì—”ì§„ ë¦¬ë¶€íŠ¸"));
        return true;
    };

    /* [ì‹ ê·œ] ëª…ë¶€ ê°•ì œ ë“±ë¡ (íŠ¹ì • ë‹‰ë„¤ì„ì„ íŠ¹ì • UIDë¡œ ê°•ì œ ë°”ì¸ë”©) */
    if (msg.indexOf("/ëª…ë¶€ê°•ì œë“±ë¡ ") === 0) {
        var ps = msg.split(" ");
        if (ps.length < 3) return replier.reply(formatAdmin("ì˜¤ë¥˜", "ì‚¬ìš©ë²•: /ëª…ë¶€ê°•ì œë“±ë¡ [ë‹‰ë„¤ì„] [UID]"));
        var inputId = ps.pop().trim();
        var inputNick = ps.slice(1).join(" ").trim();

        var regKey = "ë‚´ë¦¬ë‹¤_" + inputNick;
        var regFile = new java.io.File(REGISTRY_PATH);
        var regData = regFile.exists() ? JSON.parse(FileStream.read(REGISTRY_PATH)) : {};
        
        regData[regKey] = inputId;
        FileStream.write(REGISTRY_PATH, JSON.stringify(regData));
        
        // ìºì‹œë„ ì¦‰ì‹œ ê°±ì‹ 
        if (!globalData.nameToIdCache) globalData.nameToIdCache = {};
        globalData.nameToIdCache["GLOBAL_" + inputNick] = inputId;

        replier.reply(formatAdmin("âœ… ëª…ë¶€ ê°•ì œ êµì • ì™„ë£Œ", "[" + inputNick + "]ë‹˜ì„\nID: [" + inputId + "]ë¡œ ê°•ì œ ì—°ê²°í–ˆìŠµë‹ˆë‹¤.\n\nì´ì œ í•´ë‹¹ ê³„ì •ìœ¼ë¡œ ì—°ë™ë©ë‹ˆë‹¤."));
        return true;
    }


   // ìˆ˜ì •: /ì¡°ì‘ ëª…ë ¹ì–´ì—ì„œ findUserGlobal í˜¸ì¶œ ì‹œ roomName ì¸ì ì¶”ê°€
   if (msg.indexOf("/ì¡°ì‘ ") === 0) {
        var ps = msg.trim().split(/\s+/);
        if (ps.length < 2) {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "ì‚¬ìš©ë²•: /ì¡°ì‘ [ë‹‰ë„¤ì„] ë˜ëŠ” /ì¡°ì‘ [ë‹‰ë„¤ì„] ì˜¨/ì˜¤í”„"));
            return true;
        }

        var lastArg = ps[ps.length - 1];
        var targetNick = "";
        var mode = "VIEW"; 

        if (lastArg === "ì˜¨") { mode = "ON"; ps.pop(); }
        else if (lastArg === "ì˜¤í”„") { mode = "OFF"; ps.pop(); }
        
        targetNick = ps.slice(1).join(" ").trim();
        var found = findUserGlobal(targetNick, roomName);

        if (!found.length) { replier.reply(formatAdmin("ì˜¤ë¥˜", "ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (found.length > 1) { 
            handleUserSelection(replier, targetUid, found, "admin_mani_select", { mode: mode }, user, roomName); 
            return true; 
        }

        var targetUser = found[0].data;
        var tRoom = found[0].roomName;
        var targetId = found[0].id;

        if (mode === "ON") {
            targetUser.isManipulated = true;
            targetUser.gambleWinRate = SYSTEM_CONFIG.MANIPULATION.DEFAULT_GAMBLE;
            targetUser.fishLuck = SYSTEM_CONFIG.MANIPULATION.DEFAULT_FISH;
            targetUser.horseWinRate = SYSTEM_CONFIG.MANIPULATION.DEFAULT_RACING;
            targetUser.spittoWinRate = SYSTEM_CONFIG.MANIPULATION.DEFAULT_SPITTO;
            targetUser.skipHealing = true;
            replier.reply(formatAdmin("ğŸ¯ ì¡°ì‘ ê°€ë™", targetUser.name + "ë‹˜ì˜ ì¡°ì‘ì„ [ê¸°ë³¸ê°’]ìœ¼ë¡œ í™œì„±í™”í–ˆìŠµë‹ˆë‹¤."));
        } else if (mode === "OFF") {
            targetUser.isManipulated = false;
            replier.reply(formatAdmin("ğŸ¯ ì¡°ì‘ í•´ì œ", targetUser.name + "ë‹˜ì˜ ëª¨ë“  ì¡°ì‘ì„ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤."));
        } else {
            // [VIEW ëª¨ë“œ] ìƒíƒœ ë¸Œë¦¬í•‘ ë° ë©”ë‰´ ì¶œë ¥
            var status = "ğŸ‘¤ ëŒ€ìƒ: [" + tRoom + "] " + targetUser.name + "\n" +
                         "âœ¨ ìƒíƒœ: " + (targetUser.isManipulated ? "ğŸŸ¢ ê°€ë™ ì¤‘" : "âšª ë¯¸ê°€ë™") + "\n\n" +
                         "1. ğŸ² í™€ì§ ìŠ¹ë¥ : " + (targetUser.gambleWinRate || 0) + "%\n" +
                         "2. ğŸ£ ë‚šì‹œ ë³´ì •: " + (targetUser.fishLuck || 0) + "%\n" +
                         "3. ğŸ‡ ê²½ë§ˆ ë³´ì •: " + (targetUser.horseWinRate || 0) + "%\n" +
                         "4. ğŸ§§ ìŠ¤í”¼ë˜ ë³´ì •: " + (targetUser.spittoWinRate || 0) + "%\n" +
                         "5. âŒ ì¡°ì‘ ì „ì²´ í•´ì œ\n\n" +
                         "ğŸ’¡ ìˆ˜ì •í•  ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ [ì·¨ì†Œ] í•˜ì„¸ìš”.";
            
            var menuWaitState = data.rooms[roomName].features.states.menuWait;
            menuWaitState[targetUid] = { 
                type: 'admin_mani_menu', 
                time: Date.now(), 
                extra: { targetId: targetId, targetRoom: tRoom } 
            };
            replier.reply(formatAdmin("ğŸ¯ ì¡°ì‘ ì„¤ì • ì„¼í„°", status));
        }
        safeSaveData(data);
        return true;
    }

    // [ê´€ë¦¬ì ê¸°ëŠ¥] ì „ì²´ ë°© ëª©ë¡ ë° ìœ ì € ìˆ˜ ìŠ¤ìº” (ë°ì´í„° ìœ„ì¹˜ ì¶”ì ìš©)
            if (msg === "/ë°©ëª©ë¡") {
                if (!user.isAdmin) return; // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸

                var list = "ğŸ“‹ [ë°ì´í„°ë² ì´ìŠ¤ ë°© ëª©ë¡]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
                var count = 0;
                var totalUsers = 0;
                
                for (var rName in data.rooms) {
                    var roomObj = data.rooms[rName];
                    var uCount = 0;
                    if (roomObj && roomObj.users) {
                        uCount = Object.keys(roomObj.users).length;
                    }
                    
                    list += (count + 1) + ". " + rName + " (ìœ ì €: " + uCount + "ëª…)\n";
                    count++;
                    totalUsers += uCount;
                }
                
                list += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
                list += "ğŸ“Š ì´ " + count + "ê°œ ë°© / " + totalUsers + "ëª… ë°ì´í„° ë¡œë“œë¨";
                
                replier.reply(formatAdmin("ğŸ’¾ DB ë°ì´í„° í˜„í™©", list));
                return;
            }

    if (msg === "/ì—°ë™ì§„ë‹¨") {
        var targetRoom = "ë‚´ë¦¬ë‹¤"; // ë©”ì¸ ë°© ì´ë¦„ (ì •í™•í•´ì•¼ í•¨)
        var mainData = data.rooms[targetRoom];
        
        // [ìˆ˜ì •] sender ëŒ€ì‹  user.name ì‚¬ìš© (ì°¸ì¡° ì˜¤ë¥˜ í•´ê²°)
        var myName = user.name.trim(); 

        var report = "ğŸ” [ì‹œìŠ¤í…œ ë°ì´í„° ì •ë°€ ì§„ë‹¨]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";

        // 1. ë°© ë°ì´í„° ì¡´ì¬ ì—¬ë¶€ ê²€ì‚¬
        if (!mainData) {
            report += "âŒ [ì¹˜ëª…ì ] '" + targetRoom + "' ë°© ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\n";
            report += "ğŸ’¡ í˜„ì¬ ì €ì¥ëœ ë°© ëª©ë¡:\n[" + Object.keys(data.rooms).join(", ") + "]";
        } else {
            report += "âœ… '" + targetRoom + "' ë°© ë°ì´í„°ê°€ ì¡´ì¬í•©ë‹ˆë‹¤.\n";
            
            // 2. ìœ ì € ë§¤ì¹­ ì‹œë„
            var exactMatch = null;
            var trimMatch = null;
            var similarList = [];

            for (var uid in mainData.users) {
                var uName = mainData.users[uid].name;
                
                if (uName === user.name) exactMatch = uid;
                if (uName.trim() === myName) trimMatch = uid;
                
                // ë””ë²„ê¹…ìš©: ë‚´ ì´ë¦„ì´ í¬í•¨ëœ ìœ ì €ê°€ ìˆëŠ”ì§€ í™•ì¸
                if (uName.indexOf(myName) !== -1 || myName.indexOf(uName) !== -1) {
                    similarList.push("[" + uName + "]");
                }
            }

            report += "\nğŸ‘¤ ìœ ì € ì°¾ê¸° ê²°ê³¼:\n";
            if (exactMatch) {
                report += "âœ… ì™„ë²½ ì¼ì¹˜ ì„±ê³µ! (UID: " + exactMatch + ")\n";
                report += "ğŸ’° ë³´ìœ  í¬ì¸íŠ¸: " + fp(mainData.users[exactMatch].point) + "P";
            } else if (trimMatch) {
                report += "âš ï¸ ê³µë°± ì œê±° í›„ ì¼ì¹˜ ì„±ê³µ (UID: " + trimMatch + ")\n";
                report += "ğŸ‘‰ ì›ë³¸: [" + mainData.users[trimMatch].name + "] / ë‚˜: [" + user.name + "]\n";
                report += "ğŸ’¡ í•´ê²°ì±…: ë‹‰ë„¤ì„ì˜ ë„ì–´ì“°ê¸°ë¥¼ í™•ì¸í•˜ì„¸ìš”.";
            } else {
                report += "âŒ ì¼ì¹˜í•˜ëŠ” ë‹‰ë„¤ì„ ì—†ìŒ.\n";
                report += "ğŸ‘‰ í˜„ì¬ ë‚´ ë‹‰ë„¤ì„: [" + user.name + "] (ê¸¸ì´:" + user.name.length + ")\n";
                if (similarList.length > 0) {
                    report += "â“ í˜¹ì‹œ ì´ ë‹‰ë„¤ì„ì¸ê°€ìš”?: " + similarList.join(", ");
                } else {
                    report += "ğŸ’¡ ë©”ì¸ë°©ì— ì ‘ì† ê¸°ë¡ì´ ì•„ì˜ˆ ì—†ìŠµë‹ˆë‹¤.";
                }
            }
        }

        replier.reply(report);
    }

    if (msg.indexOf("/ì§„ë‹¨ ") === 0) {
        var tn = msg.substring(4).trim();
        var roomData = data.rooms[roomName];
        var found = findUserByName(roomData, tn);

        if (found.length === 0) {
            replier.reply("âŒ [" + tn + "] ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return true;
        }

        // [ì‹ë³„ ê°œì„ ] ê²€ìƒ‰ëœ ìœ ì €ê°€ ì—¬ëŸ¬ ëª…ì¼ ê²½ìš° ëª©ë¡ê³¼ IDë¥¼ ë¨¼ì € ì¶œë ¥
        if (found.length > 1) {
            var multiList = found.map(function(f, i) { 
                return (i+1) + ". " + f.data.name + " (" + fp(f.data.point) + "P)\n   â”” ID: " + f.id; 
            }).join("\n\n");
            replier.reply(formatAdmin("ğŸ” ì¤‘ë³µ ìœ ì € ì‹ë³„", "ë°© ì•ˆì— ë™ì¼ ë‹‰ë„¤ì„ ë°ì´í„°ê°€ " + found.length + "ê°œ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.\nìƒì„¸ ì§„ë‹¨ì€ ì •í™•í•œ í’€ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.\n\n" + multiList));
            return true;
        }

        var t = found[0].data;
        var tId = found[0].id;
        var rFeatures = roomData.features;
        var st = rFeatures.states;
        var now = Date.now();

        var report = "ğŸ” [" + tn + "] ìœ ì € ì •ë°€ ì§„ë‹¨ ë³´ê³ ì„œ\n" +
                     "ğŸ“Œ ê³ ìœ  ID: " + tId + "\n" + // ID ìƒë‹¨ ë°°ì¹˜
                     "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n";
        
        // 1. ìŠ¤íŒ¸ ë¶„ì„
        var isSpam = (t.timeoutEndTime && now < t.timeoutEndTime);
        report += "[ğŸš« ìŠ¤íŒ¸ ë° ì‹œìŠ¤í…œ ì œí•œ]\n" +
                  "â€¢ í•„í„°: " + (isSpam ? "ì°¨ë‹¨ë¨ (ì œí•œ ì¤‘)" : "ì •ìƒ") + " (Timeout: " + (isSpam ? Math.ceil((t.timeoutEndTime - now)/1000) : 0) + ")\n\n";

        // 2. í™œë™ ë¶„ì„
        report += "[â›“ï¸ êµ¬ì† ë° ê°•ì œ í™œë™]\n" +
                  "â€¢ ì§•ì—­: " + (t.jailReleaseTime && now < t.jailReleaseTime ? "ìˆ˜ê° ì¤‘ (" + Math.ceil((t.jailReleaseTime - now)/60000) + "ë¶„)" : "ì •ìƒ (ì”ì—¬: 0ë¶„)") + "\n\n";

        // 3. ë…¼ë¦¬ì  ëŒ€ê¸° ìƒíƒœ (ëª¨ë“  State ì£¼ë¨¸ë‹ˆ ìŠ¤ìº”)
        report += "[â³ ë…¼ë¦¬ì  ëŒ€ê¸° ìƒíƒœ]\n";
        report += "â€¢ ë©”ë‰´: " + (st.menuWait[tId] ? "ì„ íƒ ëŒ€ê¸° ì¤‘" : "ì—†ìŒ") + "\n";
        report += "â€¢ ì€í–‰/ìƒì : " + (st.bankProcess[tId] ? "ìˆ˜ëŸ‰ ì…ë ¥ ëŒ€ê¸° ì¤‘ (ê¼¬ì„ ë°œìƒ ê°€ëŠ¥!)" : "ì—†ìŒ") + "\n";
        report += "â€¢ ë¡œë˜: " + (st.lottoPurchase[tId] ? "ë²ˆí˜¸ ì…ë ¥ ì¤‘" : "ì—†ìŒ") + "\n";
        report += "â€¢ ì¤‘ë³µì„ íƒ: " + (st.selectWait[tId] ? "ìœ ì € ì„ íƒ ëŒ€ê¸° ì¤‘ (í™•ì¸ í•„ìš”)" : "ì—†ìŒ") + "\n";
        report += "â€¢ ì‚¬ì±„ë“±ë¡: " + (st.loanRegister[tId] ? "ë“±ë¡ ì ˆì°¨ ì§„í–‰ ì¤‘" : "ì—†ìŒ") + "\n\n";

        // 4. ë°ì´í„° ë¬´ê²°ì„± ì ê²€
        report += "[ğŸ› ï¸ ë°ì´í„° ë¬´ê²°ì„± ì ê²€]\n";
        var isInvOk = Array.isArray(t.inventory);
        var isLoanOk = (t.loan && typeof t.loan === 'object');
        var lastStat = t.lastAction ? t.lastAction.status : "NONE";
        
        // NaN/Infinite ì—°ì‚° ê²°í•¨ ì²´í¬ (ì¶”ê°€ ê¼¬ì„ ë°©ì§€)
        var isCalcOk = (!isNaN(t.point) && isFinite(t.point) && !isNaN(t.bank));

        report += "â€¢ ì¸ë²¤í† ë¦¬: " + (isInvOk ? "ì •ìƒ (Array í™•ì¸)" : "â—íŒŒì†") + "\n";
        report += "â€¢ ëŒ€ì¶œê°ì²´: " + (isLoanOk ? "ì •ìƒ (Object í™•ì¸)" : "â—ëˆ„ë½") + "\n";
        report += "â€¢ ì§ì „ì‘ì—…: " + lastStat + " (" + (t.lastAction ? t.lastAction.cmd : "ë¡œì§ ì¤‘ë‹¨ ì˜ì‹¬") + ")\n";
        report += "â€¢ ì—°ì‚°ê²°í•¨: " + (isCalcOk ? "ì •ìƒ (NaN/Infinite ì—†ìŒ)" : "â—ê²°í•¨ë°œê²¬") + "\n";

        report += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                  "ğŸ’¡ ì§„ë‹¨: ";
        
        if (isSpam) report += "ìŠ¤íŒ¸ í•„í„° ì‘ë™ ì¤‘.";
        else if (st.menuWait[tId] || st.bankProcess[tId] || st.selectWait[tId]) report += "ì…ë ¥ ëŒ€ê¸° ë¡œì§ì— ê°‡í˜€ ìˆìŠµë‹ˆë‹¤. [ì·¨ì†Œ]ë¥¼ ì…ë ¥í•˜ê²Œ í•˜ì„¸ìš”.";
        else if (lastStat === "PENDING") report += "ë¡œì§ì´ ìˆ˜í–‰ ì¤‘ ë©ˆì·„ìŠµë‹ˆë‹¤. ì‹œìŠ¤í…œ ì¬ê°€ë™ì„ ê¶Œì¥í•©ë‹ˆë‹¤.";
        else if (!isCalcOk) report += "í¬ì¸íŠ¸ ë³€ìˆ˜ê°€ ì˜¤ì—¼ë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ì ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.";
        else report += "ë°ì´í„°ìƒ ì •ìƒì…ë‹ˆë‹¤. íŠ¹ì • ìœ ì €ë§Œ ì•ˆ ëœë‹¤ë©´ ì‹ë³„ ìºì‹œë¥¼ í™•ì¸í•˜ì„¸ìš”.";

        replier.reply(report);
        return true;
    }

    if (msg.indexOf("/ë¬´ì—­ë³µêµ¬ ") === 0) {
    var tn = msg.substring(6).trim();
    var found = findUserGlobal(tn);

    if (found.length === 0) {
        replier.reply(formatAdmin("ğŸš« ëŒ€ìƒ ì—†ìŒ", "[" + tn + "] ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        return true;
    }
    
    var tUser = found[0].data;
    if (!tUser.voyage || tUser.voyage.active !== true) {
        replier.reply(formatAdmin("âŒ ë³µêµ¬ ë¶ˆê°€", "í•´ë‹¹ ìœ ì €ëŠ” í˜„ì¬ í•­í•´ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤."));
        return true;
    }

    // ê°•ì œ ë½ í•´ì œ ë° ì •ì‚° ê°€ëŠ¥ ìƒíƒœë¡œ ì´ˆê¸°í™”
    tUser.voyage.isProcessing = false;
    tUser.voyage.isAlerted = false;
    tUser.voyage.arrival = Date.now() - 1000; // ë„ì°© ì‹œê°„ì„ ê³¼ê±°ë¡œ ëŒë ¤ ì¦‰ì‹œ ì •ì‚° ìœ ë„
    tUser.skipHealing = true;

    safeSaveData(data, true);
    replier.reply(formatAdmin("âš“ ë¬´ì—­ ì •ì‚° ë½ í•´ì œ ì™„ë£Œ", tUser.name + "ë‹˜ì˜ ì •ì‚° ëŒ€ê¸° ìƒíƒœë¥¼ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.\nì´ì œ í•´ë‹¹ ìœ ì €ê°€ ì±„íŒ…ì„ ì¹˜ë©´ ì¦‰ì‹œ ì •ì‚°ë©ë‹ˆë‹¤."));
    return true;
}

    /* ìƒì„¸ ìœ ì € ë°ì´í„° ì¡°íšŒ */
    if (msg.indexOf("/ìœ ì €ë°ì´í„° ") === 0) {
        var tn = msg.substring(7).trim();
        var roomData = data.rooms[roomName];
        var found = findUserByName(roomData, tn);
        if (!found.length) replier.reply(formatAdmin("ì˜¤ë¥˜", "ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        else if (found.length > 1) handleUserSelection(replier, targetUid, found, "admin_userdata", null, user, roomName);
        else replier.reply(formatAdmin("ìœ ì € ë°ì´í„° ì¡°íšŒ", JSON.stringify(found[0].data, null, 2)));
        return true;
    }

    /* ë‹‰ë„¤ì„ ë³€ê²½ ì´ë ¥ */
    if (msg.indexOf("/ë‹‰ë„¤ì„ê¸°ë¡ ") === 0) {
        var tn = msg.substring(7).trim();
        var roomData = data.rooms[roomName];
        var found = findUserByName(roomData, tn);
        if (!found.length) { replier.reply(formatAdmin("ì˜¤ë¥˜", "ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (found.length > 1) { handleUserSelection(replier, targetUid, found, "admin_nick_log", null, user, roomName); return true; }
        var targetId = found[0].id;
        var history = data.nickHistory[targetId] || [];
        if (history.length === 0) { replier.reply(formatAdmin("ë‹‰ë„¤ì„ ê¸°ë¡", getDisplayName(found[0].data) + "ë‹˜ì€ ë³€ê²½ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        var logMsg = [];
        for(var i=0; i<history.length; i++) logMsg.push((i+1) + ". " + history[i].old + " (" + history[i].date + ")");
        replier.reply(formatAdmin("ğŸ“‹ ë‹‰ë„¤ì„ ë³€ê²½ ì´ë ¥", "í˜„ì¬: " + found[0].data.name + "\n\n[ê³¼ê±° ê¸°ë¡]\n" + logMsg.join("\n")));
        return true;
    }

    /* [ì‹ ê·œ] ì‹ ìš© ì ìˆ˜ ì§ì ‘ ì¡°ì • (v5.2) */
    if (msg.indexOf("/ì‹ ìš©ì¡°ì • ") === 0) {
        var ps = msg.split(" ");
        if (ps.length < 3) {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "í˜•ì‹: /ì‹ ìš©ì¡°ì • [ë‹‰ë„¤ì„] [ì ìˆ˜]\nì˜ˆ) /ì‹ ìš©ì¡°ì • í™ê¸¸ë™ -50"));
            return true;
        }
        var scoreChange = parseInt(ps.pop());
        var targetName = ps.slice(1).join(" ").trim();
        var roomData = data.rooms[roomName];
        var found = findUserByName(roomData, targetName);

        if (isNaN(scoreChange)) { replier.reply(formatAdmin("ì˜¤ë¥˜", "ì¡°ì •í•  ì ìˆ˜ë¥¼ ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”.")); return true; }
        if (!found.length) { replier.reply(formatAdmin("ì˜¤ë¥˜", "ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (found.length > 1) { 
            handleUserSelection(replier, targetUid, found, "admin_credit_edit", { score: scoreChange }, user, roomName);
        return true; 
    }

        var targetUser = found[0].data;
        var oldScore = Number(targetUser.creditScore || 600);
        targetUser.creditScore = Math.min(1000, Math.max(0, oldScore + scoreChange));
        
        if (typeof checkAndHandleDefaulter === 'function') {
            checkAndHandleDefaulter(targetUser, roomName);
        }

        safeSaveData(data);
        var crInfo = getCreditInfo(targetUser.creditScore);
        var resText = "ëŒ€ìƒ: " + getDisplayName(targetUser) + "ë‹˜\n" +
                      "ë³€ë™: " + (scoreChange > 0 ? "+" : "") + scoreChange + "ì \n" +
                      "í˜„ì¬: " + targetUser.creditScore + "ì  (" + crInfo.label + ")";
        
        replier.reply(formatAdmin("âš™ï¸ ì‹ ìš© ì ìˆ˜ ì¡°ì • ì™„ë£Œ", resText));
        return true;
    }

    /* [Gemini ìš”ì²­ ì‚¬í•­] ê´€ë¦¬ì ì „ìš© ì¹­í˜¸ íšŒìˆ˜ ë¡œì§ (ì˜¤ë¥˜ ì§€ê¸‰ë¶„ ë°•íƒˆìš©) */
    if (msg.indexOf("/ì¹­í˜¸íšŒìˆ˜ ") === 0) {
        var ps = msg.split(" ");
        if (ps.length < 3) {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "í˜•ì‹: /ì¹­í˜¸íšŒìˆ˜ [ë‹‰ë„¤ì„] [ì¹­í˜¸ëª…]"));
            return true;
        }
        var titleToTake = ps.pop().trim();
        var targetName = ps.slice(1).join(" ").trim();
        var roomData = data.rooms[roomName];
        var found = findUserByName(roomData, targetName);

        if (!found.length) { replier.reply(formatAdmin("ì˜¤ë¥˜", "ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
    if (found.length > 1) {
        handleUserSelection(replier, targetUid, found, "admin_title_take", { title: titleToTake }, user, roomName);
        return true;
    }

        var targetUser = found[0].data;
        var inv = targetUser.inventory || [];
        var removed = false;

        // 1. ì¸ë²¤í† ë¦¬(ê°€ë°©)ì—ì„œ í•´ë‹¹ ì¹­í˜¸ ì‚­ì œ
        targetUser.inventory = inv.filter(function(it) {
            if (it.effect === "title" && (it.title === titleToTake || it.name.indexOf(titleToTake) !== -1)) {
                removed = true;
                return false;
            }
            return true;
        });

        // 2. í˜„ì¬ ì¥ì°© ì¤‘ì¸ ê²½ìš° í•´ì œ
        if (targetUser.title === titleToTake) {
            targetUser.title = "";
            removed = true;
        }

        if (removed) {
            safeSaveData(data);
            replier.reply(formatAdmin("ğŸ–ï¸ ì¹­í˜¸ íšŒìˆ˜ ì™„ë£Œ", getDisplayName(targetUser) + "ë‹˜ì—ê²Œì„œ [" + titleToTake + "] ì¹­í˜¸ë¥¼ ë°•íƒˆí–ˆìŠµë‹ˆë‹¤."));
        } else {
            replier.reply(formatAdmin("íšŒìˆ˜ ì‹¤íŒ¨", getDisplayName(targetUser) + "ë‹˜ì€ í•´ë‹¹ ì¹­í˜¸ë¥¼ ë³´ìœ í•˜ê³  ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."));
        }
        return true;
    }

    /* ì¶œì„ ì´ˆê¸°í™” */
    if (msg.indexOf("/ì¶œì„ì´ˆê¸°í™” ") === 0) {
        var tn = msg.substring(7).trim();
        var roomData = data.rooms[roomName];
        var found = findUserByName(roomData, tn);
        if (!found.length) { replier.reply(formatAdmin("ì˜¤ë¥˜", "ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (found.length > 1) { handleUserSelection(replier, targetUid, found, "admin_attend_reset", null, user, roomName); return true; }
        found[0].data.lastDate = "";
        safeSaveData(data);
        replier.reply(formatAdmin("ì¶œì„ ì´ˆê¸°í™” ì™„ë£Œ", getDisplayName(found[0].data) + "ë‹˜ì˜ ì˜¤ëŠ˜ ì¶œì„ ê¸°ë¡ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    /* ì¶œì„ ì¼ìˆ˜ ìˆ˜ì • */
    if (msg.indexOf("/ì¶œì„ì¼ìˆ˜ìˆ˜ì • ") === 0) {
        var ps = msg.split(" "), days = parseInt(ps.pop()), tn = ps.slice(1).join(" ");
        var roomData = data.rooms[roomName];
        var found = findUserByName(roomData, tn);
        if (!found.length) { replier.reply(formatAdmin("ì˜¤ë¥˜", "ëŒ€ìƒ ì—†ìŒ")); return true; }
        if (found.length > 1) { handleUserSelection(replier, targetUid, found, "admin_attend_edit", { days: days }, user, roomName); return true; }
        found[0].data.totalAttendance = days; safeSaveData(data);
        replier.reply(formatAdmin("ìˆ˜ì • ì™„ë£Œ", getDisplayName(found[0].data) + ": " + days + "ì¼"));
        return true;
    }

    /* ì „ì²´ ì¶œì„ ìˆ˜ì • */
    if (msg.indexOf("/ì „ì²´ì¶œì„ìˆ˜ì • ") === 0) {
        var days = parseInt(msg.split(" ")[1]);
        for (var r in data.rooms) {
            for (var id in data.rooms[r].users) { data.rooms[r].users[id].totalAttendance = days; }
        }
        safeSaveData(data);
        replier.reply(formatAdmin("ì™„ë£Œ", "ì „ì²´ ì¶œì„ " + days + "ì¼ë¡œ ê³ ì •"));
        return true;
    }

    /* ë°ì´í„° ì´ì „ */
    if (msg.indexOf("/ë°ì´í„°ì´ì „ ") === 0) {
        if (msg.indexOf(" > ") === -1) { replier.reply(formatAdmin("ì˜¤ë¥˜", "í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.\nì˜ˆ) /ë°ì´í„°ì´ì „ êµ¬ë‹‰ë„¤ì„ > ì‹ ë‹‰ë„¤ì„")); return true; }
        var names = msg.substring(7).split(" > ");
        var oldName = names[0].trim();
        var newName = names[1].trim();
        var roomData = data.rooms[roomName];
        
        var oldFound = findUserByName(roomData, oldName);
        var newFound = findUserByName(roomData, newName);

        if (oldFound.length === 0) { replier.reply(formatAdmin("ì˜¤ë¥˜", "êµ¬ ë‹‰ë„¤ì„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (newFound.length === 0) { replier.reply(formatAdmin("ì˜¤ë¥˜", "ì‹  ë‹‰ë„¤ì„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (oldFound.length > 1 || newFound.length > 1) { replier.reply(formatAdmin("ì˜¤ë¥˜", "ì¤‘ë³µ ë‹‰ë„¤ì„ì´ ì¡´ì¬í•©ë‹ˆë‹¤. ì •í™•í•œ í’€ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")); return true; }

        var oldId = oldFound[0].id;
        var oldData = oldFound[0].data;
        var newData = newFound[0].data;

        newData.point = oldData.point;
        newData.bank = oldData.bank;
        newData.tier = oldData.tier;
        newData.creditScore = oldData.creditScore;
        newData.totalAttendance = oldData.totalAttendance;
        newData.loan = oldData.loan;
        newData.stockHoldings = oldData.stockHoldings;
        newData.stockAvg = oldData.stockAvg;
        newData.icon = oldData.icon;
        newData.title = oldData.title;

        if (typeof uidCache !== 'undefined') {
            for (var key in uidCache) {
                if (uidCache[key] === oldId) delete uidCache[key];
            }
        }
        delete roomData.users[oldId];
        safeSaveData(data);
        replier.reply(formatAdmin("ë°ì´í„° ì´ì „ ì„±ê³µ", oldName + " â” " + newName + "\nëª¨ë“  ìì‚° ë° ë“±ê¸‰ì´ ì´ì „ë˜ì—ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    // [ìˆ˜ì •] ìœ ì € ì‚­ì œ ë° ì¡°ì‘ ë¡œì§ ë‚´ ë³€ìˆ˜ ì„ ì–¸ ëˆ„ë½ ë³´ê°•
    if (msg.indexOf("/ìœ ì €ì‚­ì œ ") === 0) {
        var input = msg.substring(6).trim();
        var roomData = data.rooms[roomName];
        var targetId = null;
        var targetData = null;
        var targetRoomName = roomName; // [êµì •] var ì¶”ê°€

        if (roomName === "ë‚´ë¦¬ë‹¤") {
            if (roomData.users[input]) {
                targetId = input;
                targetData = roomData.users[input];
                targetRoomName = "ë‚´ë¦¬ë‹¤";
            }
        } else {
            // ê´€ì œì„¼í„°(ë² ë¦­ë°©) ë“±ì—ì„œëŠ” ì „ì—­ ìŠ¤ìº” ìœ ì§€
            for (var rName in data.rooms) {
                if (data.rooms[rName].users && data.rooms[rName].users[input]) {
                    targetId = input;
                    targetData = data.rooms[rName].users[input];
                    targetRoomName = rName;
                    break;
                }
            }
        }

        // 2ìˆœìœ„ - ë‹‰ë„¤ì„ ê²€ìƒ‰ ì‹œì—ë„ í˜„ì¬ ë°© ì •ë³´ë¥¼ ë„˜ê²¨ í•„í„°ë§ ì‘ë™ ìœ ë„
        if (!targetId) {
            var found = findUserGlobal(input, roomName);
            
            if (found.length === 0) {
                replier.reply(formatAdmin("ğŸš« ëŒ€ìƒ ì—†ìŒ", "[" + input + "] ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n(UIDê°€ ì •í™•í•œì§€ í™•ì¸í•˜ì„¸ìš”)"));
                return true;
            }
            
            // ì¤‘ë³µ ë‹‰ë„¤ì„ ë°œê²¬ ì‹œ ì„ íƒ ì°½ í˜¸ì¶œ
            if (found.length > 1) {
                handleUserSelection(replier, targetUid, found, "admin_delete", null, user, roomName);
                return true;
            }
            
            targetId = found[0].id;
            targetData = found[0].data;
            targetRoomName = roomName;
        }

        // ì‹¤ì œ ë°ì´í„°ê°€ ìœ„ì¹˜í•œ ë°©ì˜ ê°ì²´ ì°¸ì¡°
        var actualRoomData = data.rooms[targetRoomName];
        var tName = targetData.name;
        var refundLog = "";
        var refundCount = 0;
        var totalRefunded = 0;

        // 1. ì‚¬ì±„ ê³„ì•½ ì •ì‚° ë° ë³´ì „ (ì‹¤ì œ ë°ì´í„°ê°€ ìˆëŠ” ë°© ê¸°ì¤€)
        if (actualRoomData.loanContracts) {
            for (var cid in actualRoomData.loanContracts) {
                var c = actualRoomData.loanContracts[cid];
                if (c.borrowerUid === targetId) {
                    var lender = actualRoomData.users[c.lenderUid];
                    if (lender) {
                        var debtAmt = Number(c.currentDebt);
                        util_updatePoint(lender, actualRoomData, debtAmt, "ì‚¬ì±„ ê°•ì œ ì •ì‚°", targetRoomName);
                        totalRefunded += debtAmt;
                        refundCount++;
                        try { Api.replyRoom(targetRoomName, "ğŸš¬ [ì‚¬ì±„ ê°•ì œ ì •ì‚°]\n" + tName + "ë‹˜ì˜ ë°ì´í„° ì‚­ì œë¡œ ì¸í•´ " + lender.name + "ë‹˜ê»˜ ë¯¸ìˆ˜ê¸ˆ " + fp(debtAmt) + "Pê°€ ì „ì•¡ ë°˜í™˜ë˜ì—ˆìŠµë‹ˆë‹¤."); } catch(e){}
                    }
                    delete actualRoomData.loanContracts[cid];
                }
            }
        }

        // 2. ì€í–‰ ëŒ€ì¶œê¸ˆ êµ­ê³  íšŒìˆ˜
        if (targetData.loan && Number(targetData.loan.debt) > 0) {
            var bankDebt = Number(targetData.loan.debt);
            util_updateReserve(actualRoomData, bankDebt, "ëŒ€ì¶œê¸ˆ êµ­ê³  íšŒìˆ˜", targetRoomName);
            refundLog += "\nğŸ¦ ì€í–‰ ëŒ€ì¶œê¸ˆ " + fp(bankDebt) + "Pê°€ êµ­ê³ ë¡œ ìë™ íšŒìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.";
        }

        if (refundCount > 0) refundLog += "\nâš ï¸ ì‚¬ì±„ ë³´ì „ ì™„ë£Œ: " + refundCount + "ê±´ (" + fp(totalRefunded) + "P)";

        // 3. ìºì‹œ ë° ë©”ëª¨ë¦¬ íŒŒê¸°
        if (typeof uidCache !== 'undefined') {
            for (var key in uidCache) { if (uidCache[key] === targetId) delete uidCache[key]; }
        }
        if (globalData.nameToIdCache) {
            delete globalData.nameToIdCache["GLOBAL_" + tName];
        }

        // 4. ë°ì´í„°ë² ì´ìŠ¤ ë° ì˜êµ¬ ëª…ë¶€ ì‚­ì œ
        delete actualRoomData.users[targetId];
        try {
            var regFile = new java.io.File(REGISTRY_PATH);
            if (regFile.exists()) {
                var regData = JSON.parse(FileStream.read(REGISTRY_PATH));
                // ëª…ë¶€ì—ì„œ [ë°©ì´ë¦„_ìœ ì €ì´ë¦„] ì¡°í•© í‚¤ë¥¼ ì°¾ì•„ ì‚­ì œ
                delete regData[targetRoomName + "_" + tName];
                FileStream.write(REGISTRY_PATH, JSON.stringify(regData));
            }
        } catch (e) { Log.error("Registry Delete Error: " + e); }

        safeSaveData(data);
        replier.reply(formatAdmin("ìœ ì € ì‚­ì œ ì™„ë£Œ", "ğŸ“ ì†Œì†: [" + targetRoomName + "]\n[" + tName + "]ë‹˜ì˜ ë°ì´í„°ë¥¼ ì˜êµ¬ ì‚­ì œí•˜ê³  ëª…ë¶€ì—ì„œ íŒŒê¸°í–ˆìŠµë‹ˆë‹¤." + refundLog));
        return true;
        }

    if (msg.indexOf("/ì±„êµ´ì‹œê°„ë³µêµ¬ ") === 0) {
        var ps = msg.split(" "), addMin = parseInt(ps.pop()), tn = ps.slice(1).join(" ");
        var roomData = data.rooms[roomName];
        var found = findUserByName(roomData, tn);
        
        if (!found.length) { replier.reply(formatAdmin("ì˜¤ë¥˜", "ëŒ€ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (isNaN(addMin)) { replier.reply(formatAdmin("ì˜¤ë¥˜", "ë³µêµ¬í•  ë¶„(Min)ì„ ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”.")); return true; }

        var targetUser = found[0].data;
        var oldMin = targetUser.totalMiningTime || 0;
        targetUser.totalMiningTime = oldMin + addMin;
        targetUser.skipHealing = true; // ë³´ì•ˆ ì—”ì§„ ì˜ˆì™¸ í—ˆìš©
        
        safeSaveData(data);
        replier.reply(formatAdmin("â³ ì±„êµ´ ì‹œê°„ ë³µêµ¬ ì™„ë£Œ", 
            "ëŒ€ìƒ: " + targetUser.name + "\n" +
            "ê¸°ì¡´: " + oldMin + "ë¶„\n" +
            "ì¶”ê°€: +" + addMin + "ë¶„\n" +
            "ìµœì¢…: " + targetUser.totalMiningTime + "ë¶„"));
        return true;
    }

    // [ì¶”ê°€] ë¬´ì—­ íšŸìˆ˜ ìˆ˜ë™ ë³µêµ¬ ëª…ë ¹ì–´
    if (msg.indexOf("/ë¬´ì—­íšŸìˆ˜ìˆ˜ì • ") === 0) {
        var ps = msg.split(" ");
        if (ps.length < 3) return replier.reply(formatAdmin("ì˜¤ë¥˜", "í˜•ì‹: /ë¬´ì—­íšŸìˆ˜ìˆ˜ì • [ë‹‰ë„¤ì„] [íšŸìˆ˜]"));
        
        var count = parseInt(ps.pop());
        var tn = ps.slice(1).join(" ").trim();
        var found = findUserGlobal(tn, roomName);

        if (found.length === 0) return replier.reply(formatAdmin("ì˜¤ë¥˜", "ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        if (found.length > 1) {
            handleUserSelection(replier, targetUid, found, "admin_trade_edit", { count: count }, user, roomName);
            return true;
        }

        var tUser = found[0].data;
        var oldTrade = tUser.tradeCount || 0;
        tUser.tradeCount = count;
        tUser.skipHealing = true;

        safeSaveData(data, true);
        replier.reply(formatAdmin("âš“ ë¬´ì—­ ê¸°ë¡ ë³µêµ¬ ì™„ë£Œ", 
            "ëŒ€ìƒ: " + tUser.name + "\n" +
            "ê¸°ì¡´: " + oldTrade + "íšŒ\n" +
            "ë³€ê²½: " + count + "íšŒ"));
        return true;
    }

if (msg === "/ì „ì²´ì±„êµ´ë³µêµ¬") {
        var backupPath = BACKUP_DIR + "last_stable_backup.json";
        var backupFile = new java.io.File(backupPath);
        var logFile = new java.io.File(JOURNAL_PATH);

        if (!backupFile.exists()) {
            replier.reply(formatAdmin("ğŸš« ë³µêµ¬ ë¶ˆê°€", "2ì›” 2ì¼ì ë°±ì—… íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."));
            return true;
        }

        try {
            var backupData = JSON.parse(FileStream.read(backupPath));
            var revokeKeywords = ["ê´‘ì‚°", "ê°€ê²°ì‚°", "ì±„êµ´", "ë³µêµ¬"];
            var pointRevoked = 0, titleRevoked = 0, totalFixed = 0;

            // [Step 1] ì˜¤ëŠ˜(00ì‹œ ì´í›„) ì˜ëª» ì§€ê¸‰ëœ í¬ì¸íŠ¸ ë¡œê·¸ ì „ìˆ˜ ì¡°ì‚¬
            var blackListProfits = {}; // { uid: amount }
            if (logFile.exists()) {
                var logs = FileStream.read(JOURNAL_PATH).split("\n");
                logs.forEach(function(line) {
                    if (!line.trim()) return;
                    var p = line.split("|");
                    if (p.length < 5) return;
                    
                    var reason = p[4];
                    var isTargetReason = revokeKeywords.some(function(k) { return reason.indexOf(k) !== -1; });
                    
                    // ì˜¤ëŠ˜ ë‚ ì§œì´ë©´ì„œ ê´‘ì‚° ê´€ë ¨ìœ¼ë¡œ 'ì§€ê¸‰(+)'ëœ ë‚´ì—­ë§Œ í•©ì‚°
                    if (isTargetReason && Number(p[2]) > 0) {
                        blackListProfits[p[0]] = (blackListProfits[p[0]] || 0) + Number(p[2]);
                    }
                });
            }

            for (var rName in data.rooms) {
                var currentRoom = data.rooms[rName];
                var backupRoom = backupData.rooms[rName];
                if (!backupRoom) continue;

                for (var uid in currentRoom.users) {
                    var u = currentRoom.users[uid];
                    var bu = backupRoom.users[uid];

                    if (bu && bu.mining) {
                        u.skipHealing = true;

                        // 1. ë¶€ë‹¹ í¬ì¸íŠ¸ íšŒìˆ˜ ë° êµ­ê³  í™˜ìˆ˜
                        if (blackListProfits[uid]) {
                            var amt = blackListProfits[uid];
                            u.point = Number(u.point) - amt;
                            currentRoom.bankReserve = (currentRoom.bankReserve || 0) + amt;
                            pointRevoked++;
                        }

                        // 2. ëˆ„ì  ë°ì´í„° ë¡¤ë°± (ë°±ì—… ì‹œì ì˜ ìˆœìˆ˜ ëˆ„ì ì¹˜ë¡œ ê³ ì •)
                    u.totalMiningTime = Number(bu.totalMiningTime || 0);
                    u.artifactPieces = Number(bu.artifactPieces || 0);

                    // 3. [êµì •] ì‹œê°„ ì¶• ì •ìƒí™”: í˜„ì¬ ì±„êµ´ ì¤‘ì´ë¼ë©´ 'ì§€ê¸ˆ ì´ ìˆœê°„'ë¶€í„° ë‹¤ì‹œ ì‹œì‘
                    // ê³¼ê±° startTimeìœ¼ë¡œ ì†Œê¸‰í•˜ë©´ í˜„ì¬ ì„¸ì…˜ ì‹œê°„ì´ ë¹„ì •ìƒì ìœ¼ë¡œ í•©ì‚°ë˜ëŠ” ë²„ê·¸ê°€ ë°œìƒí•¨
                    if (u.mining && u.mining.active === true) {
                        u.mining.startTime = Date.now(); 
                        u.mining.active = true;
                    }

                        // 4. ìê²© ë¯¸ë‹¬ ì¹­í˜¸ ì „ìˆ˜ íšŒìˆ˜ (ì±„êµ´ì™• ì •ë°€ ì‚­ì œ)
                        if (u.totalMiningTime < 10000) {
                            var hasTitle = false;
                            u.inventory = u.inventory.filter(function(it) {
                                if (it.title === "ì±„êµ´ì™•" || it.name.indexOf("ì±„êµ´ì™•") !== -1) {
                                    hasTitle = true;
                                    return false;
                                }
                                return true;
                            });
                            if (u.title === "ì±„êµ´ì™•") u.title = "";
                            if (hasTitle) titleRevoked++;
                        }
                        totalFixed++;
                    }
                }
            }

            safeSaveData(data, true);
            if (typeof globalData !== 'undefined') globalData = data;

            var report = "ğŸ›°ï¸ [ê´‘ì‚° ì‹œê³„ì—´ í†µí•© ë° ì •í™” ì™„ë£Œ]\n" +
                         "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                         "â€¢ ëŒ€ìƒ ì¸ì›: " + totalFixed + "ëª…\n" +
                         "â€¢ í¬ì¸íŠ¸ í™˜ìˆ˜: " + pointRevoked + "ëª… (ì •ì‚°ê¸ˆ íšŒìˆ˜)\n" +
                         "â€¢ ì¹­í˜¸ ë°•íƒˆ: " + titleRevoked + "ëª… (ìê²©ë¯¸ë‹¬ ì œê±°)\n" +
                         "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                         "ğŸ’¡ 00ì‹œ ë¦¬ì…‹ ì´ì „ì˜ ì‹œì‘ ì‹œê°„ìœ¼ë¡œ ì†Œê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.\n" +
                         "ì´ì œ ëª¨ë“  ìœ ì €ëŠ” ì–´ì œë¶€í„° ì´ì–´ì˜¨ ìƒíƒœë¡œ ì±„êµ´ë©ë‹ˆë‹¤.";
            replier.reply(formatAdmin("ì‹œìŠ¤í…œ íƒ€ì„ë¼ì¸ ë³µêµ¬ ë³´ê³ ", report));

        } catch (e) {
            Log.error("Mining Timeline Merge Error: " + e);
            replier.reply(formatAdmin("ğŸš« ì˜¤ë¥˜ ë°œìƒ", "ë¡œê·¸ ë¶„ì„ ë° ë°ì´í„° ë³‘í•© ì¤‘ ê²°í•¨ ë°œìƒ"));
        }
        return true;
    }

    if (msg.indexOf("/ê´‘ì‚°ìë™ë³µêµ¬ ") === 0) {
    var tn = msg.substring(8).trim();
    var found = findUserGlobal(tn, roomName);
    
    if (found.length === 0) return replier.reply("âŒ í˜„ì¬ ë°ì´í„°ì—ì„œ ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    var tUser = found[0].data;
    var tId = found[0].id;

    try {
        var dataPath = "/sdcard/msgbot/data/";
        var targetFileName = "last_stable_backup.json";
        
        // 1. [ìë™ ì²­ì†Œ] ë¡œê·¸ ì°Œêº¼ê¸°(.txt)ë§Œ ê³¨ë¼ ì‚­ì œ (ë°ì´í„° ì„ì‹œíŒŒì¼ .jsonì€ ì ˆëŒ€ ë³´ì¡´)
        var dir = new java.io.File(dataPath);
        var files = dir.listFiles();
        var cleanCount = 0;
        var jsonFiles = []; // ë””ë²„ê¹…ìš© JSON ëª©ë¡ ì €ì¥

        if (files) {
            for (var i = 0; i < files.length; i++) {
                var f = files[i];
                var fName = f.getName();
                
                // ë¡œê·¸ ì°Œêº¼ê¸° ì†Œê°
                if (fName.indexOf("LOG_TEMP_") === 0 && fName.endsWith(".txt")) {
                    if (f.delete()) cleanCount++;
                }
                
                // ì¡´ì¬í•˜ëŠ” ëª¨ë“  JSON íŒŒì¼ ìˆ˜ì§‘ (íŒŒì¼ ì°¾ê¸° ì‹¤íŒ¨ ì‹œ ë³´ê³ ìš©)
                if (fName.endsWith(".json")) {
                    jsonFiles.push(fName + " (" + (f.length() / 1024).toFixed(1) + "KB)");
                }
            }
        }

        // 2. [ì •ë°€ íƒ€ê²©] ì—¬ëŸ¬ ê²½ë¡œ í›„ë³´ì—ì„œ ë°±ì—… íŒŒì¼ íƒìƒ‰
        var backupPaths = [
            dataPath + targetFileName,
            "/storage/emulated/0/msgbot/data/" + targetFileName,
            "/sdcard/msgbot/" + targetFileName
        ];
        
        var backupRaw = null;
        var finalPath = "";
        for (var j = 0; j < backupPaths.length; j++) {
            var raw = FileStream.read(backupPaths[j]);
            if (raw && raw.length > 100) {
                backupRaw = raw;
                finalPath = backupPaths[j];
                break;
            }
        }

        // 3. [ì‹¤íŒ¨ ì‹œ ì •ë°€ ì§„ë‹¨] íŒŒì¼ì„ ëª» ì°¾ì•˜ë‹¤ë©´ í˜„ì¬ í´ë”ì˜ ì§„ì§œ ìƒí™©ì„ ë³´ê³ 
        if (!backupRaw) {
            var errorDetail = "âŒ ë°±ì—… íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\n";
            errorDetail += "ğŸ“‚ íƒìƒ‰ ìœ„ì¹˜: " + dataPath + "\n";
            errorDetail += "ğŸ“‹ ë°œê²¬ëœ JSON ëª©ë¡:\n" + (jsonFiles.length > 0 ? jsonFiles.join("\n") : "ì—†ìŒ");
            errorDetail += "\n\nğŸ’¡ íŒ: ëª©ë¡ì— íŒŒì¼ì´ ì—†ë‹¤ë©´ 'ëª¨ë“  íŒŒì¼ ì ‘ê·¼ ê¶Œí•œ'ì„ í™•ì¸í•˜ê±°ë‚˜ íŒŒì¼ëª…ì„ ì¬í™•ì¸í•˜ì„¸ìš”.";
            throw new Error(errorDetail);
        }
        
        var backupData = JSON.parse(backupRaw);
        var backupUser = null;

        // 4. [ë³µêµ¬] ë°±ì—…ë³¸ì—ì„œ ìœ ì € ë°ì´í„° ì¶”ì¶œ
        for (var r in backupData.rooms) {
            if (backupData.rooms[r].users && backupData.rooms[r].users[tId]) {
                backupUser = backupData.rooms[r].users[tId];
                break;
            }
        }

        if (!backupUser) throw new Error("ë°±ì—…ë³¸ ë‚´ì— í•´ë‹¹ ìœ ì €ì˜ ê¸°ë¡ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");

        tUser.totalMiningTime = Number(backupUser.totalMiningTime || 0);
        tUser.artifactPieces = Number(backupUser.artifactPieces || 0);
        tUser.skipHealing = true;

        safeSaveData(data, true); 

        var resBody = "ğŸ‘¤ ëŒ€ìƒ: " + tUser.name + "\n" +
                      "ğŸ§¹ ë¡œê·¸ ì²­ì†Œ: " + cleanCount + "ê°œ ì‚­ì œ ì™„ë£Œ\n" +
                      "ğŸ“‚ ë¡œë“œ íŒŒì¼: " + finalPath.split('/').pop() + "\n" +
                      "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                      "â›ï¸ ëˆ„ì  ì±„êµ´: " + fp(tUser.totalMiningTime) + "ë¶„\n" +
                      "ğŸ§© ìœ ë¬¼ ì¡°ê°: " + tUser.artifactPieces + "ê°œ\n" +
                      "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                      "âœ… ë°ì´í„° ë³µêµ¬ê°€ ì•ˆì „í•˜ê²Œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.";

        replier.reply(formatAdmin("ğŸ¤– ì§€ëŠ¥í˜• ê´‘ì‚° ìë™ ë³µêµ¬", resBody));

    } catch (e) {
        replier.reply(formatAdmin("âŒ ë³µêµ¬ í”„ë¡œì„¸ìŠ¤ ì‹¤íŒ¨", e.message));
    }
    return true;
}

    if (msg === "/ê²½ë¡œìˆ˜ì‚¬") {
    try {
        var testPaths = [
            "/sdcard/msgbot/data/",
            "/storage/emulated/0/msgbot/data/",
            "/sdcard/messengerbot/data/",
            "sdcard/msgbot/data/"
        ];
        
        var report = ["ğŸ“‚ [ê²½ë¡œ ìˆ˜ì‚¬ ë³´ê³ ì„œ]"];
        
        testPaths.forEach(function(path) {
            var files = java.io.File(path).list();
            if (files) {
                report.push("âœ… ì ‘ê·¼ ê°€ëŠ¥: " + path);
                report.push("ğŸ“„ íŒŒì¼ëª©ë¡: " + files.slice(0, 5).join(", ") + (files.length > 5 ? " ì™¸ " + (files.length-5) + "ê°œ" : ""));
            } else {
                report.push("âŒ ì ‘ê·¼ ë¶ˆê°€: " + path);
            }
        });
        
        replier.reply(formatAdmin("ğŸ” ì‹œìŠ¤í…œ ê²½ë¡œ ì§„ë‹¨", report.join("\n\n")));
    } catch (e) {
        replier.reply("âŒ ìˆ˜ì‚¬ ì‹¤íŒ¨: " + e.message);
    }
    return true;
}

    if (msg === "/ë°°ë‹¹ê¸ˆê°•ì œì •ì‚°") {
        data.lastDailyReset = ""; 
        _runSector17Logic(data, { today: getSimpleDate(), now: new Date(), targetRoom: roomName, season: getSimpleSeason() });
        replier.reply(formatAdmin("ğŸš€ ë°°ë‹¹ê¸ˆ ìˆ˜ë™ ì§€ê¸‰ ì™„ë£Œ", "í˜„ì¬ ì£¼ë¨¸ë‹ˆì˜ ìˆ˜ìµì„ ë°°ë‹¹í•˜ê³  00ì‹œ ì •ì‚°ì„ ê°•ì œ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    /* [ì‹ ê·œ] ì§€ëŠ¥í˜• ê±°ë˜ ì—­ì¶”ì  ëª…ë ¹ì–´ */
   if (msg.indexOf("/ë¸”ë™ë°•ìŠ¤ ") === 0) {
        var tn = msg.substring(6).trim();
        var roomData = data.rooms[roomName];
        var found = findUserByName(roomData, tn);

        if (found.length === 0) {
            replier.reply(formatAdmin("ğŸš« ëŒ€ìƒ ì—†ìŒ", "[" + tn + "] ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        } else if (found.length > 1) {
            handleUserSelection(replier, targetUid, found, "admin_blackbox", null, user, roomName);
        } else {
            _executeBlackboxSearch(found[0].id, found[0].data, replier);
        }
        return true;
    }

    /* [í•µì‹¬] ë¸”ë™ë°•ìŠ¤ íŒŒì¼ ë¶„ì„ ë° ì¶œë ¥ ì—”ì§„ (ì‹¤ì‹œê°„+ëˆ„ì  í†µí•© ë²„ì „) */
    function _executeBlackboxSearch(uid, targetUser, replier) {
        try {
            var logs = [];
            // JOURNAL_PATH(ì‹¤ì‹œê°„)ì™€ total_history.log(ëˆ„ì )ë¥¼ ëª¨ë‘ ìŠ¤ìº”
            var filesToRead = [JOURNAL_PATH, BASE_DIR + "total_history.log"];

            filesToRead.forEach(function(path) {
                var file = new java.io.File(path);
                if (file.exists() && file.length() > 0) {
                    var lines = FileStream.read(path).split("\n");
                    lines.forEach(function(line) {
                        if (!line.trim()) return;
                        var parts = line.split("|");
                        if (parts[0] === uid) {
                            var delta = Number(parts[2]);
                            var sign = delta > 0 ? "â•" : "â–";
                            // ê¸°ë¡ì˜ ì¼ê´€ì„±ì„ ìœ„í•´ ì›ë³¸ ì‚¬ìœ ì™€ ê¸ˆì•¡ì„ ë°°ì—´ì— ì¶”ê°€
                            logs.push("â€¢ [" + parts[4] + "] " + sign + fp(Math.abs(delta)) + "P");
                        }
                    });
                }
            });

            var readMore = "\u200b".repeat(500); 
            // ìµœì‹  ê¸°ë¡ì´ ìœ„ë¡œ ì˜¤ë„ë¡ ë°°ì—´ ë°˜ì „ ì²˜ë¦¬
            var displayLogs = logs.reverse();

            var resultBody = "ğŸ‘¤ ëŒ€ìƒ: " + targetUser.name + "\n" +
                             "ğŸ†” ID: " + uid + "\n" +
                             "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" + readMore + "\n" +
                             (displayLogs.length > 0 ? displayLogs.join("\n") : "ì˜¤ëŠ˜ ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.") + "\n" +
                             "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                             "ğŸ’° í˜„ì¬ ì”ì•¡: " + fp(targetUser.point) + "P";

            replier.reply(formatAdmin("ğŸ“‹ ìœ ì € í†µí•© ë¸”ë™ë°•ìŠ¤", resultBody));
        } catch (e) {
            replier.reply(formatAdmin("ğŸš« ë¶„ì„ ì‹¤íŒ¨", "ë¡œê·¸ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e));
        }
    }

    /* [ê°œì¸ ë³µêµ¬] 4ëŒ€ ë³´ì•ˆ ê°€ë“œê°€ ì ìš©ëœ ì§€ëŠ¥í˜• ìœ ì € ë³µêµ¬ (Smart User Restore v5.9.1) */
    if (msg.indexOf("/ìœ ì €ë³µì› ") === 0) {
        var fullInput = msg.substring(6).trim();
        var roomData = data.rooms[roomName];

        var words = fullInput.split(/\s+/);
        var lastWord = words[words.length - 1];
        var isUUID = (lastWord.split("-").length >= 5 && lastWord.length >= 36);

        var targetNick = isUUID ? fullInput.substring(0, fullInput.lastIndexOf(lastWord)).trim() : fullInput;
        var sourceCode = isUUID ? lastWord : "";

        // í˜„ì¬ ë°©ì—ì„œ ëŒ€ìƒ ê²€ìƒ‰
        var currentFound = findUserByName(roomData, targetNick);
        if (currentFound.length > 1) { 
            handleUserSelection(replier, targetUid, currentFound, "user_restore", { sourceCode: sourceCode }, user, roomName);
            return true; 
        }

        var targetId = isUUID ? sourceCode : (currentFound.length > 0 ? currentFound[0].id : null);
        var stablePath = BASE_DIR + "backup/last_stable_backup.json";
        var stableFile = new java.io.File(stablePath);

        if (!stableFile.exists() || stableFile.length() === 0) {
            replier.reply(formatAdmin("ğŸš« ë³µêµ¬ ì‹¤íŒ¨", "ì•ˆì „ ë°±ì—… íŒŒì¼(last_stable_backup.json)ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."));
            return true;
        }

        try {
            var backupContent = FileStream.read(stablePath);
            var backupData = JSON.parse(backupContent);
            var backupUser = null;
            var finalUid = targetId;

            // [A] UIDê°€ ìˆìœ¼ë©´ ê·¸ê±¸ë¡œ ë°±ì—… ë°ì´í„° ì°¾ê¸°
            if (finalUid) {
                for (var r in backupData.rooms) {
                    if (backupData.rooms[r].users[finalUid]) {
                        backupUser = backupData.rooms[r].users[finalUid];
                        break;
                    }
                }
            } 
            
            // [B] UID ì—†ìœ¼ë©´ ë‹‰ë„¤ì„ìœ¼ë¡œ ë°±ì—… ì „ì²´ ë’¤ì§€ê¸°
            if (!backupUser) {
                for (var r in backupData.rooms) {
                    for (var uid in backupData.rooms[r].users) {
                        if (backupData.rooms[r].users[uid].name === targetNick) {
                            backupUser = backupData.rooms[r].users[uid];
                            finalUid = uid;
                            break;
                        }
                    }
                    if (backupUser) break;
                }
            }

            if (!backupUser) throw new Error("ë°±ì—…ë³¸ì—ì„œë„ [" + targetNick + "] ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

            var displayNick = backupUser.name || targetNick;
            var MAIN_ZONE = "ë‚´ë¦¬ë‹¤";
            if (!data.rooms[MAIN_ZONE]) data.rooms[MAIN_ZONE] = { users: {} };
            var mainTargetRoom = data.rooms[MAIN_ZONE];

            // [í•µì‹¬ ë³€ê²½] ìŠ¤í‚¤ë§ˆë§Œ ë³´ëŠ”ê²Œ ì•„ë‹ˆë¼, ë°±ì—…ë³¸ì˜ 'ëª¨ë“  ë°ì´í„°'ë¥¼ ë³µì œ (Deep Clone)
            // ì´ë¥¼ í†µí•´ mining, voyage, cargo, landHoldings ë“± ëª¨ë“  ê°ì²´ê°€ ëˆ„ë½ ì—†ì´ ë„˜ì–´ì˜µë‹ˆë‹¤.
            var clonedUser = JSON.parse(JSON.stringify(backupUser));

            // í˜„ì¬ ì ‘ì† ì •ë³´(ì´ë¦„, UID)ëŠ” ìœ ì§€í•˜ë˜, ë‚˜ë¨¸ì§€ëŠ” ë°±ì—…ë³¸ìœ¼ë¡œ ì „ë©´ êµì²´
            clonedUser.name = displayNick;
            clonedUser.uid = finalUid;
            clonedUser.skipHealing = true; // ë³´ì•ˆ ì—”ì§„ ë¡¤ë°± ë°©ì§€

            // [ê°•ì œ ì£¼ì…] í˜„ì¬ ë°ì´í„°ë² ì´ìŠ¤ì— í†µì§¸ë¡œ ë®ì–´ì“°ê¸°
            mainTargetRoom.users[finalUid] = clonedUser;

            // ëª…ë¶€ ë° ìºì‹œ ë™ê¸°í™”
            var regFile = new java.io.File(REGISTRY_PATH);
            var regData = regFile.exists() ? JSON.parse(FileStream.read(REGISTRY_PATH)) : {};
            regData[MAIN_ZONE + "_" + displayNick] = finalUid;
            FileStream.write(REGISTRY_PATH, JSON.stringify(regData));
            
            if (globalData.nameToIdCache) globalData.nameToIdCache["GLOBAL_" + displayNick] = finalUid;

            safeSaveData(data, true); 
            globalData = data; 

            // ë°ì´í„° ê²€ì¦ìš© ë¡œê·¸ ì¶”ì¶œ
            var tInf = clonedUser.tradeCount || 0;
            var mTime = clonedUser.totalMiningTime || 0;
            var lCount = Object.keys(clonedUser.landHoldings || {}).length;
            var aPieces = clonedUser.artifactPieces || 0;

            var debugBody = "ğŸ‘¤ ëŒ€ìƒ: " + displayNick + "\n" +
                            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                            "ğŸ’° ìì‚° ë³µì›: " + fp(clonedUser.point) + "P\n" +
                            "â›ï¸ ê´‘ì‚° ì •ë³´: " + fp(mTime) + "ë¶„ ëˆ„ì \n" +
                            "ğŸ—ï¸ ë¶€ë™ì‚° ì •ë³´: " + lCount + "ê°œ ê±´ë¬¼ ë³´ìœ \n" +
                            "ğŸš¢ ë¬´ì—­ ê¸°ë¡: " + tInf + "íšŒ\n" +
                            "ğŸ§© ìœ ë¬¼/ê°€ë°©: ì „ì²´ ë°ì´í„° ì´ê´€ ì™„ë£Œ\n" +
                            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                            "âœ… ë°±ì—… ì‹œì ì˜ ëª¨ë“  ìƒíƒœ(ê°ì²´ í¬í•¨)ê°€ ì™„ë²½íˆ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.";

            replier.reply(formatAdmin("âœ… ìœ ì € ì „ìˆ˜ ë°ì´í„° ë³µì› ì™„ë£Œ", debugBody));

        } catch (e) {
            replier.reply(formatAdmin("ğŸš« ë³µêµ¬ ì¤‘ë‹¨", "ì‚¬ìœ : " + e.message));
            Log.error("Restore Error: " + e);
        }
        return true;
    }

if (msg.startsWith("/í™”ë¬¼ë³µêµ¬")) {
        var ps = msg.trim().split(/\s+/);
        if (ps.length < 4) {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "í˜•ì‹: /í™”ë¬¼ë³µêµ¬ [ë‹‰ë„¤ì„] [í’ˆëª©ëª…] [ìˆ˜ëŸ‰]"));
            return true;
        }

        var arg1 = ps.pop(); // ë§ˆì§€ë§‰ ì¸ì
        var arg2 = ps.pop(); // ë§ˆì§€ë§‰ ì• ì¸ì
        
        var count, itemName;
        // ìˆ«ìê°€ í¬í•¨ëœ ì¸ìë¥¼ ì°¾ì•„ countì— í• ë‹¹ (ì½¤ë§ˆ ì œê±° í›„ íŒì •)
        if (!isNaN(parseInt(arg1.replace(/,/g, "")))) {
            count = parseInt(arg1.replace(/,/g, ""));
            itemName = arg2;
        } else {
            count = parseInt(arg2.replace(/,/g, ""));
            itemName = arg1;
        }

        var tn = ps.slice(1).join(" ").trim();
        var found = findUserGlobal(tn, roomName);

        if (found.length === 0) {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "ìœ ì € [" + tn + "]ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
            return true;
        }
        
        if (found.length > 1) {
            handleUserSelection(replier, targetUid, found, "admin_cargo_fix", { item: itemName, qty: count }, user, roomName);
            return true;
        }

        var tUser = found[0].data;
        var isSpec = false;
        // íŠ¹ì‚°í’ˆ ì—¬ë¶€ íŒë³„ (TRADE_RELATION ì°¸ì¡°)
        for (var n in TRADE_RELATION) { 
            if (TRADE_RELATION[n].set === itemName) { isSpec = true; break; } 
        }

        if (isSpec) {
            if (!tUser.specialties) tUser.specialties = {};
            tUser.specialties[itemName] = (Number(tUser.specialties[itemName]) || 0) + count;
        } else {
            if (!tUser.cargo) tUser.cargo = {};
            tUser.cargo[itemName] = (Number(tUser.cargo[itemName]) || 0) + count;
        }
        
        tUser.skipHealing = true;
        safeSaveData(data, true);
        replier.reply(formatAdmin("ğŸ“¦ í™”ë¬¼ ê°•ì œ ë³µêµ¬ ì™„ë£Œ", "ëŒ€ìƒ: " + tUser.name + "\ní’ˆëª©: " + (isSpec ? "[íŠ¹] " : "") + itemName + "\nìˆ˜ëŸ‰: " + count + "ê°œ ì¶”ê°€ ì™„ë£Œ"));
        return true;
    }

// [ì‹ ê·œ] ì „ ì„œë²„ ì§ì—… ì´ˆê¸°í™” (ì§ì—… ë¯¸í™œë™ ìœ ì € ì •ë¦¬ìš©)
    if (msg === "/ì „ì²´ì§ì—…ì´ˆê¸°í™”") {
        var count = 0;
        for (var r in data.rooms) {
            for (var uid in data.rooms[r].users) {
                var u = data.rooms[r].users[uid];
                if (u.job) {
                    u.job = null;
                    u.infamy = 0;
                    u.fame = 0;
                    u.currentBounty = 0;
                    u.jobJoinDate = "";
                    u.skipHealing = true;
                    count++;
                }
            }
        }
        safeSaveData(data, true);
        replier.reply(formatAdmin("ğŸ§¹ ì „ ì„œë²„ ì§ì—… ì •í™” ì™„ë£Œ", "ì´ " + count + "ëª…ì˜ ì§ì—… ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    return false;
}

//==========ì„¹í„°35==========

/**
 * [ê´€ë¦¬ì í•˜ìœ„ ëª¨ë“ˆ 4] ê²½ì œ ë° í¬ì¸íŠ¸ ê´€ë¦¬
 * ê¸°ëŠ¥: ê²½ì œì§€í‘œ, ë°ì´í„°êµì •, ë¬¼ê°€ì¡°ì •, í¬ì¸íŠ¸ ì§€ê¸‰/ì°¨ê°/ë¿Œë¦¬ê¸°, ê°ì¢… ì´ˆê¸°í™”, ì¬ì›ìˆ˜ì • ë° ì¶©ì „, ìê°€ë³µì›
 */
function _adminEconomyLogic(msg, user, data, replier, roomName, targetUid, sender) {
// [í•µì‹¬] 1:1ë°© ë˜ëŠ” ë² ë¦­ë°©ì—ì„œ ì‹¤í–‰ ì‹œì—ë„ ì‹¤ì œ ì€í–‰ ë°ì´í„°ê°€ ìˆëŠ” "ë‚´ë¦¬ë‹¤" ë°©ì„ ì°¸ì¡°í•˜ë„ë¡ ê³ ì •
    var logicZone = (roomName === "ë² ë¦­ë°©" || ALLOWED_ROOMS.indexOf(roomName) === -1) ? "ë‚´ë¦¬ë‹¤" : roomName;
    var roomData = data.rooms[logicZone];

    
     /* * [v13.8] ì§€ëŠ¥í˜• ì›ê²© ë¡œê·¸ ìˆ˜í˜ˆ (Time-Filter Edition)
     * ì‚¬ìš©ë²•: /ë¡œê·¸ì›ê²©ë³µêµ¬ [ì˜¤ëŠ˜ì‹œì‘ì‹œê°„(HH:mm)] [íŒŒì¼URL]
     * ì˜ˆì‹œ: /ë¡œê·¸ì›ê²©ë³µêµ¬ 10:30 https://cdn.discord...
     */
    if (msg.indexOf("/ë¡œê·¸ì›ê²©ë³µêµ¬ ") === 0) {
        var ps = msg.split(" ");
        if (ps.length < 3) return replier.reply(formatAdmin("ì˜¤ë¥˜", "ì‚¬ìš©ë²•: /ë¡œê·¸ì›ê²©ë³µêµ¬ [ì‹œì‘ì‹œê°„(HH:mm)] [URL]"));

        var timeStr = ps[1]; // "10:30"
        var fileUrl = ps[2]; // "http..."
        
        // ì…ë ¥ë°›ì€ ì‹œê°„ì„ íƒ€ì„ìŠ¤íƒ¬í”„ë¡œ ë³€í™˜
        var now = new Date();
        var tParts = timeStr.split(":");
        var startTs = new Date(now.getFullYear(), now.getMonth(), now.getDate(), parseInt(tParts[0]), parseInt(tParts[1])).getTime();

        replier.reply("ğŸ“¡ [" + timeStr + "] ì´í›„ì˜ ë°ì´í„°ë§Œ ì„ ë³„ ë³µêµ¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...");

        Executor.execute(new java.lang.Runnable({
            run: function() {
                try {
                    var tempPath = BASE_DIR + "recovery/REMOTE_LOG_" + Date.now() + ".txt";
                    var conn = new java.net.URL(fileUrl).openConnection();
                    var is = conn.getInputStream();
                    var fos = new java.io.FileOutputStream(tempPath);
                    var buffer = java.lang.reflect.Array.newInstance(java.lang.Byte.TYPE, 4096);
                    var len;
                    while ((len = is.read(buffer)) > 0) { fos.write(buffer, 0, len); }
                    fos.close(); is.close();

                    var recoveryFile = new java.io.File(tempPath);
                    // _processLogFileì— ì‹œì‘ ì‹œê°„(startTs)ì„ ì „ë‹¬í•˜ì—¬ í•„í„°ë§
                    var recoveredCount = _processLogFile(recoveryFile, data, startTs);
                    
                    if (recoveredCount > 0) {
                        safeSaveData(data, true);
                        recoveryFile.delete();
                        Api.replyRoom(roomName, formatAdmin("âœ… ì„ ë³„ ë³µêµ¬ ì™„ë£Œ", "ë¶„ì„ ê²°ê³¼: " + recoveredCount + "ê±´ì˜ ìƒˆë¡œìš´ ê±°ë˜ê°€ ë³‘í•©ë˜ì—ˆìŠµë‹ˆë‹¤.\n(ê¸°ì¤€ ì‹œê°„: " + timeStr + " ì´í›„)"));
                    } else {
                        recoveryFile.delete();
                        Api.replyRoom(roomName, formatAdmin("â“ ê²°ê³¼ ì—†ìŒ", "í•´ë‹¹ ì‹œê°„ ì´í›„ì— ë°œìƒí•œ ê±°ë˜ê°€ íŒŒì¼ ë‚´ì— ì—†ìŠµë‹ˆë‹¤."));
                    }
                } catch (e) {
                    Api.replyRoom(roomName, formatAdmin("ğŸš« ì›ê²© ë³µêµ¬ ì‹¤íŒ¨", "ì˜¤ë¥˜: " + e.message));
                }
            }
        }));
        return true;
    }

    /* [í…ŒìŠ¤íŠ¸] ìì • ë¦¬ì…‹ ë¡œì§ ê°•ì œ ì‹¤í–‰ */
    if (msg === "/ìì •í…ŒìŠ¤íŠ¸") {
        // 1. ì˜¤ëŠ˜ ë¦¬ì…‹ ê¸°ë¡ì„ ì§€ì›Œ ë¡œì§ì´ ì‹¤í–‰ ê°€ëŠ¥í•˜ê²Œ ë§Œë“¬
        data.lastDailyReset = "2000-01-01"; 
        
        // 2. ê°€ìƒ ì»¨í…ìŠ¤íŠ¸ ìƒì„± (í˜„ì¬ ì‹œê°„ ê¸°ì¤€)
        var testCtx = {
            today: getSimpleDate(),
            now: new Date(),
            targetRoom: roomName,
            season: getSimpleSeason()
        };

        // 3. ë¦¬ì…‹ ë¡œì§ ê°•ì œ í˜¸ì¶œ
        _runSector17Logic(data, testCtx);
        
        replier.reply(formatAdmin("ğŸ§ª ìì • ë¡œì§ í…ŒìŠ¤íŠ¸", "ìì • ë¦¬ì…‹ ë¡œì§ì„ ê°•ì œë¡œ ì‹¤í–‰í–ˆìŠµë‹ˆë‹¤.\në¡œê·¸ì™€ ê´‘ì‚° ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”."));
        return true;
    }

    /* [1] ì€í–‰ ê°€ìš© ì¬ì› ìˆ˜ë™ ìˆ˜ì • (ê°•ì œ ì„¤ì •) */
    if (msg.indexOf("/ì¬ì›ìˆ˜ì • ") === 0) {
        var val = parseInt(msg.split(" ")[1].replace(/,/g, ""));
        if (isNaN(val)) {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "ìˆ˜ì •í•  ê¸ˆì•¡ì„ ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”.\nì˜ˆ) /ì¬ì›ìˆ˜ì • 3000"));
            return true;
        }

        if (!roomData) return true;

        // [êµì •] roomNameì´ ì•„ë‹Œ logicZone(ë‚´ë¦¬ë‹¤)ì˜ ì¬ì›ì„ ìˆ˜ì •í•¨
        var currentRes = Number(roomData.bankReserve || 0);
        var delta = val - currentRes;
        util_updateReserve(roomData, delta, "ì¬ì› ìˆ˜ì •", logicZone);
        
        roomData.bankReserve = val;
        safeSaveData(data);
        
        replier.reply(formatAdmin("ğŸ¦ ì€í–‰ ì¬ì› ìˆ˜ì • ì™„ë£Œ", 
            "í˜„ì¬ ë°©ì˜ ê°€ìš© ì¬ì›ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n" +
            "ğŸ’° ì„¤ì • ê¸ˆì•¡: " + fp(val) + "P\n" +
            "ğŸ“¢ ì´ì œ ìœ ì €ë“¤ì´ ì´ ê¸ˆì•¡ ë‚´ì—ì„œ ëŒ€ì¶œ ê°€ëŠ¥í•©ë‹ˆë‹¤."));
        return true;
    }

   if (msg === "/êµ­ê³ ë¡œê·¸") {
    try {
        var logs = [];
        // [êµì •] History(ê³¼ê±°)ë¥¼ ë¨¼ì € ë„£ê³  Journal(í˜„ì¬)ì„ ë‚˜ì¤‘ì— ë„£ì–´ Newestê°€ ë°°ì—´ ëì— ì˜¤ê²Œ í•¨
        var filesToRead = [BASE_DIR + "total_history.log", JOURNAL_PATH];

        filesToRead.forEach(function(path) {
            var file = new java.io.File(path);
            if (file.exists() && file.length() > 0) {
                var content = FileStream.read(path).split("\n");
                logs = logs.concat(content);
            }
        });

        var filteredLogs = [];
        // ì˜¤ëŠ˜ ë°œìƒí•œ ëª¨ë“  êµ­ê³  ë³€ë™ ì¶”ì¶œ (ìµœì‹ ìˆœ: ë°°ì—´ ëë¶€í„° íƒìƒ‰)
        for (var i = logs.length - 1; i >= 0; i--) {
            var line = logs[i].trim();
            if (!line) continue;
            var parts = line.split("|");
            // [êµì •] v13.8 6ì—´ êµ¬ì¡°ì— ë§ì¶° ìµœì†Œ ê¸¸ì´ ê²€ì¦ì„ 6ìœ¼ë¡œ ë³€ê²½
            if (parts.length < 6) continue; 

            // [êµì •] êµ­ê³  ë³€ë™ì•¡(brDelta)ì€ ì´ì œ 4ë²ˆ ì¸ë±ìŠ¤ì— ìœ„ì¹˜í•¨
            var brDelta = Number(parts[4]); 
            if (!isNaN(brDelta) && brDelta !== 0) {
                var sign = brDelta > 0 ? "â•" : "â–";
                var uName = "ì•Œ ìˆ˜ ì—†ìŒ";
                
                // [êµì •] ìœ ì € UIDëŠ” ì´ì œ 1ë²ˆ ì¸ë±ìŠ¤ì— ìœ„ì¹˜í•¨
                var logUid = parts[1];
                for (var r in data.rooms) {
                    if (data.rooms[r].users[logUid]) {
                        uName = data.rooms[r].users[logUid].name;
                        break;
                    }
                }
                // [êµì •] ì‚¬ìœ (Reason)ëŠ” ì´ì œ 5ë²ˆ ì¸ë±ìŠ¤ì— ìœ„ì¹˜í•¨
                filteredLogs.push("â€¢ [" + parts[5] + "] " + uName + " | " + sign + fp(Math.abs(brDelta)) + "P");
            }
            // ë„ˆë¬´ ë§ì€ ë¡œê·¸ ì¶œë ¥ ë°©ì§€ (ìµœê·¼ 30ê±´)
            if (filteredLogs.length >= 30) break;
        }

        var readMore = "\u200b".repeat(500); 
        var resultBody = "ğŸ¦ í˜„ì¬ ê¸ˆê³  ì”ì•¡: " + fp(roomData.bankReserve) + "P\n" +
                         "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" + readMore + "\n" +
                         (filteredLogs.length > 0 ? filteredLogs.join("\n") : "ìµœê·¼ êµ­ê³  ë³€ë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");

        replier.reply(formatAdmin("ğŸ›ï¸ ì˜¤ëŠ˜ êµ­ê³  ì „ì²´ ë³€ë™ ì¥ë¶€", resultBody));
    } catch (e) {
        replier.reply(formatAdmin("ğŸš« ì¡°íšŒ ì‹¤íŒ¨", "ë¡œê·¸ í†µí•© ë¶„ì„ ì˜¤ë¥˜: " + e));
    }
    return true;
   }

    /* [ì‹ ê·œ] ì€í–‰ ê¸´ê¸‰ ì¬ì› ì¶©ì „ (ê¸°ì¡´ ì”ì•¡ì— ì¶”ê°€ í•©ì‚°) */
    if (msg.indexOf("/ì¬ì›ì¶©ì „ ") === 0) {
        var val = parseInt(msg.split(" ")[1].replace(/,/g, ""));
        if (isNaN(val) || val <= 0) {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "ì¶©ì „í•  ê¸ˆì•¡ì„ ì–‘ì˜ ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”.\nì˜ˆ) /ì¬ì›ì¶©ì „ 100000"));
            return true;
        }
        if (!roomData) return true;

        // [êµì •] logicZone(ë‚´ë¦¬ë‹¤) ì¬ì›ì— í•©ì‚°
        util_updateReserve(roomData, val, "ì¬ì› ì¶©ì „", logicZone);
        
        safeSaveData(data);
        
        var resMsg = "ê²°ê³¼: êµ­ê³  ë³´ì¶© ì™„ë£Œ\n" +
                     "ìˆ˜í˜ˆ ê¸ˆì•¡: +" + fp(val) + "P\n" +
                     "ğŸ¦ í˜„ì¬ ê¸ˆê³  ì´ì•¡: " + fp(roomData.bankReserve) + "P";
        
        replier.reply(formatAdmin("âš™ï¸ ì¤‘ì•™ì€í–‰ ê¸´ê¸‰ ì¬ì› ìˆ˜í˜ˆ", resMsg));
        return true;
    }

   /* [ì‹ ê·œ] ëˆ„ë½ëœ ì˜¤ëŠ˜ì¹˜ ë°°ë‹¹ê¸ˆ ê°•ì œ í•©ì‚° ëª…ë ¹ì–´ */
    if (msg === "/ë°°ë‹¹ë³µêµ¬") {
        var count = util_restoreDailyPoolsFromHistory(data, roomName);
        safeSaveData(data);
        replier.reply(formatAdmin("âœ… ë°°ë‹¹ê¸ˆ ì†Œê¸‰ ì ìš© ì™„ë£Œ", 
            "ë°±ì—… íŒŒì¼ì—ì„œ ì˜¤ëŠ˜ ë°œìƒí•œ " + count + "ê±´ì˜ ê±°ë˜ë¥¼ ë¶„ì„í•˜ì—¬\n" +
            "ë©”ëª¨ë¦¬ ë°°ë‹¹ ì£¼ë¨¸ë‹ˆì— í•©ì‚°ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.\n\n" +
            "ğŸ’¡ ì´ì œ /ë°°ë‹¹í˜„í™©ì—ì„œ ì •í™•í•œ ê¸ˆì•¡ì„ í™•ì¸í•˜ì„¸ìš”."));
        return true;
    }

    /* [ì‹ ê·œ] ë°°ë‹¹ í•­ëª© ìˆ˜ë™ ì´ˆê¸°í™” ëª…ë ¹ì–´ */
    if (msg.indexOf("/ë°°ë‹¹ì´ˆê¸°í™” ") === 0) {
        var roomData = data.rooms[roomName];
        if (!roomData || !roomData.features || !roomData.features.dailyPools) return true;

        var targetKey = msg.substring(7).trim(); // "ì¹´ì§€ë…¸", "ê´‘ì‚°" ë“±
        var keyMap = { "ì¹´ì§€ë…¸": "casino", "ê´‘ì‚°": "mine", "ë‚šì‹œí„°": "fish", "ì€í–‰": "bank", "ë°±í™”ì ": "shop", "ê²½ë§ˆì¥": "race" };
        var engKey = keyMap[targetKey];

        if (!engKey) {
            replier.reply(formatAdmin("ğŸš« ì´ˆê¸°í™” ì‹¤íŒ¨", "ì˜¬ë°”ë¥¸ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.\n(ì¹´ì§€ë…¸, ê´‘ì‚°, ë‚šì‹œí„°, ì€í–‰, ë°±í™”ì , ê²½ë§ˆì¥)"));
            return true;
        }

        // í•´ë‹¹ í•­ëª© 0ìœ¼ë¡œ ë¦¬ì…‹
        roomData.features.dailyPools[engKey] = 0;
        safeSaveData(data);
        
        replier.reply(formatAdmin("âœ… ë°°ë‹¹ ì´ˆê¸°í™” ì™„ë£Œ", "[" + targetKey + "] í•­ëª©ì˜ ë°°ë‹¹ ì£¼ë¨¸ë‹ˆë¥¼ 0Pë¡œ ë¹„ì› ìŠµë‹ˆë‹¤.\nì´ì œ ë‹¤ì‹œ [/ë°°ë‹¹ë³µêµ¬]ë¥¼ ì‹¤í–‰í•˜ì—¬ ê¹¨ë—í•˜ê²Œ í•©ì‚°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."));
        return true;
    }

   /* [2] íŠ¹ì • ë§¤ë¬¼ ì‹ ê·œ ë“±ë¡/ë¶€í™œ ëª…ë ¹ì–´ */
    if (msg.indexOf("/ë§¤ë¬¼ì¶”ê°€ ") === 0) {
        var parts = msg.split(" ");
        if (parts.length < 3) {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "í˜•ì‹: /ë§¤ë¬¼ì¶”ê°€ [ê±´ë¬¼ëª…] [ê°€ê²©] [íƒ€ì…ë²ˆí˜¸(ì„ íƒ)]\n1: ëœë“œë§ˆí¬ / 2: ë¹„ì¦ˆë‹ˆìŠ¤íƒ€ì›Œ / 3: ìƒê°€"));
            return true;
        }
        var name = parts[1];
        var price = parseInt(parts[2].replace(/,/g, ""));
        var typeNum = parts[3] || "1"; // ê¸°ë³¸ê°’ 1ë²ˆ

        var typeMap = { "1": "normal", "2": "bluechip", "3": "hotspot" };
        var selectedType = typeMap[typeNum] || "normal";
        var trait = SYSTEM_CONFIG.ECO.LANDMARK.TRAITS[selectedType];

        data.landmarkMarket[name] = {
            price: price, 
            lastPrice: price, 
            type: selectedType, 
            delistTick: 0, 
            delistLimit: 9999, 
            trend: "none", 
            trendTick: 0, 
            openPrice: price
        };

        replier.reply(formatAdmin("ğŸ™ï¸ ë§¤ë¬¼ ìˆ˜ë™ ë“±ë¡ ì™„ë£Œ", 
            "ê±´ë¬¼ëª…: " + trait.icon + " " + name + "\n" +
            "ìœ í˜•: " + trait.label + " (ë³€ë™ì„±: x" + trait.volatility + ")\n" +
            "ì‹œê°€: " + fp(price) + "P"));

             safeSaveData(data);
        return true;
    }

    /* [ì‹ ê·œ] íŠ¹ì • ë§¤ë¬¼ ê°•ì œ ìƒí ë° ì‚­ì œ */
    if (msg.indexOf("/ë§¤ë¬¼ì‚­ì œ ") === 0) {
        var name = msg.substring(6).trim();
        if (!data.landmarkMarket[name]) {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "[" + name + "] ë§¤ë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
            return true;
        }

        // ìœ ì €ë“¤ì˜ ë³´ìœ  ì§€ë¶„ë„ í•¨ê»˜ ì‚­ì œ (ë°ì´í„° ë¬´ê²°ì„±)
        for (var r in data.rooms) {
            for (var uid in data.rooms[r].users) {
                var u = data.rooms[r].users[uid];
                if (u.landHoldings && u.landHoldings[name]) {
                    delete u.landHoldings[name];
                    if (u.landAvg) delete u.landAvg[name];
                }
            }
        }

        delete data.landmarkMarket[name];
        safeSaveData(data);
        replier.reply(formatAdmin("ğŸ™ï¸ ë§¤ë¬¼ ì‚­ì œ ì™„ë£Œ", "[" + name + "] ê±´ë¬¼ì´ ì‹œì¥ì—ì„œ ì™„ì „íˆ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    /* [ê´€ë¦¬ì] íŠ¹ì • ë§¤ë¬¼ ì´ë¦„ ë° ì‹œì„¸ ìˆ˜ì • */
    if (msg.indexOf("/ë§¤ë¬¼ìˆ˜ì • ") === 0) {
        var parts = msg.split(" ");
        if (parts.length < 4) {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "í˜•ì‹: /ë§¤ë¬¼ìˆ˜ì • [ê¸°ì¡´ì´ë¦„] [ìƒˆì´ë¦„] [ìƒˆê°€ê²©]"));
            return true;
        }
        var oldName = parts[1];
        var newName = parts[2];
        var newPrice = parseInt(parts[3].replace(/,/g, ""));

        if (!data.landmarkMarket[oldName]) {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "[" + oldName + "] ë§¤ë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
            return true;
        }

        var landData = data.landmarkMarket[oldName];
        var oldPrice = Number(landData.price);
        var ratio = oldPrice / newPrice;

        landData.price = newPrice;
        landData.lastPrice = newPrice;
        landData.openPrice = newPrice;

        var fixCount = 0;
        for (var r in data.rooms) {
            var users = data.rooms[r].users;
            for (var uid in users) {
                var u = users[uid];
                if (u.landHoldings && u.landHoldings[oldName] !== undefined) {
                    u.skipHealing = true;
                    var oldQty = Number(u.landHoldings[oldName]);
                    var oldAvg = Number(u.landAvg[oldName] || oldPrice);

                    var newQty = Math.max(1, Math.round(oldQty * ratio));
                    var newAvg = Math.floor(oldAvg / ratio);

                    u.landHoldings[newName] = newQty;
                    u.landAvg[newName] = newAvg;

                    if (oldName !== newName) {
                        delete u.landHoldings[oldName];
                        if (u.landAvg[oldName]) delete u.landAvg[oldName];
                    }
                    fixCount++;
                }
            }
        }

        if (oldName !== newName) {
            data.landmarkMarket[newName] = landData;
            delete data.landmarkMarket[oldName];
        }

        safeSaveData(data);
        replier.reply(formatAdmin("ğŸ™ï¸ ë¶€ë™ì‚° ë§¤ë¬¼ êµì • ì™„ë£Œ", "ëŒ€ìƒ: " + oldName + " â” " + newName + "\nê°€ê²©: " + fp(oldPrice) + "P â” " + fp(newPrice) + "P\nìœ ì € " + fixCount + "ëª…ì˜ ìì‚° ê°€ì¹˜ ë³´ì¡´ ì™„ë£Œ"));
        return true;
    }

    /* [3] ìœ ì € ë³´ìœ  ìì‚° ê¸°ë°˜ ë¶€ë™ì‚° ì‹œì¥ ì¬ê±´ */
    if (msg === "/ë¶€ë™ì‚°ìì‚°ë³µêµ¬") {
        var roomData = data.rooms[roomName];
        if (!roomData) return true;
        var pumpCount = 0;
        var healthyPrice = 175000; 

        for (var lName in data.landmarkMarket) {
            var oldPrice = data.landmarkMarket[lName].price;
            if (oldPrice < 52500) {
                var ratio = oldPrice / healthyPrice; 
                for (var r in data.rooms) {
                    for (var uid in data.rooms[r].users) {
                        var u = data.rooms[r].users[uid];
                        if (u.landHoldings && u.landHoldings[lName]) {
                            u.skipHealing = true; 
                            u.landHoldings[lName] = Math.max(1, Math.floor(u.landHoldings[lName] * ratio));
                            u.landAvg[lName] = healthyPrice; 
                        }
                    }
                }
                data.landmarkMarket[lName].price = healthyPrice;
                data.landmarkMarket[lName].lastPrice = healthyPrice;
                data.landmarkMarket[lName].delistTick = 0;
                pumpCount++;
            }
        }
        safeSaveData(data);
        replier.reply(formatAdmin("ğŸ™ï¸ ë¶€ë™ì‚° ì‹œì¥ ì •ìƒí™” ì™„ë£Œ", "ë³´ì • ë§¤ë¬¼: " + pumpCount + "ê°œ\nì‹œì„¸ ì¬ì„¤ì •: " + fp(healthyPrice) + "P"));
        return true;
    }

    /* [4] ê²½ì œ ì§€í‘œ ìƒì„¸ ì¡°íšŒ */
    if (msg === "/ê²½ì œì •ë³´") {
        // [ìˆ˜ì •] ë² ë¦­ë°©ì´ë‚˜ 1:1ë°©ì—ì„œ ì¡°íšŒ ì‹œ, ë©”ì¸ êµ¬ì—­('ë‚´ë¦¬ë‹¤')ì˜ ê²½ì œ ë°ì´í„°ë¥¼ ë¡œë“œ
        var targetZone = (roomName === "ë² ë¦­ë°©" || ALLOWED_ROOMS.indexOf(roomName) === -1) ? "ë‚´ë¦¬ë‹¤" : roomName;

        var eco = calculateEconomy(data, targetZone);
        var rData = data.rooms[targetZone];
        var base = rData.economyBase || 0;
        
        var multiplier = 1.0;
        if (base > 0) {
            var rawRatio = eco.total / base;
            var damping = (data.economyDamping !== undefined) ? data.economyDamping : 0.5;
            multiplier = 1 + (rawRatio - 1) * damping;
            if (multiplier < 0.5) multiplier = 0.5;
        }

        var ecoMsg = "ğŸ’° [ë°©ë³„ ë…ë¦½ ê²½ì œ ë¦¬í¬íŠ¸]\n" +
                     "ğŸ“ ëŒ€ìƒ êµ¬ì—­: " + roomName + "\n" +
                     "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                     "ğŸ’µ ì´ìì‚°: " + fp(eco.total) + "P\n" +
                     "ğŸ¦ ì€í–‰ì¬ê³ : " + fp(rData.bankReserve || 0) + "P\n" +
                     "âš–ï¸ ë¬¼ê°€ê¸°ì¤€: " + (base > 0 ? fp(base) + "P" : "ì„¤ì • ì—†ìŒ") + "\n" +
                     "ğŸ“ˆ ë¬¼ê°€ë°°ìœ¨: x" + multiplier.toFixed(2) + "\n" +
                     "ğŸ‘¥ í™œì„±ìœ ì €: " + eco.count + "ëª…\n" +
                     "ğŸ’ í‰ê· ìì‚°: " + fp(eco.average) + "P";

        replier.reply(formatAdmin("ì‹¤ì‹œê°„ ê²½ì œ ìƒí™©", ecoMsg));
        return true;
    }

   // [ê¸´ê¸‰] ë¶€ë™ì‚° ë°ì´í„° ì •ë°€ ìˆ˜ë¦¬ ë¡œì§
    if (msg === "/ì‹œì¥ë°ì´í„°êµì •") {
        var fixUserCount = 0;
        var healthyPrice = 175000; 

        for (var r in data.rooms) {
            for (var uid in data.rooms[r].users) {
                var u = data.rooms[r].users[uid];
                if (!u.landHoldings) continue;

                var isUserFixed = false;
                for (var lName in u.landHoldings) {
                    var land = data.landmarkMarket[lName];
                    var curQty = Number(u.landHoldings[lName]);
                    if (land && land.price >= 150000 && curQty > 5) {
                        u.skipHealing = true; 
                        var estimatedOldValue = curQty * 1000; 
                        u.landHoldings[lName] = Math.max(1, Math.round(estimatedOldValue / land.price));
                        if (!u.landAvg) u.landAvg = {};
                        u.landAvg[lName] = land.price;
                        isUserFixed = true;
                    }
                }
                if (isUserFixed) fixUserCount++;
            }
        }
        safeSaveData(data, false); 
        replier.reply(formatAdmin("ğŸ› ï¸ ë¶€ë™ì‚° ì§€ë¶„ ì •ë°€ ìˆ˜ë¦¬", "ëŒ€ìƒ ì¸ì›: " + fixUserCount + "ëª…\nì¡°ì¹˜: ë¹„ì •ìƒ ê³ ì•¡ ì§€ë¶„ ê°•ì œ ì••ì¶• ì™„ë£Œ"));
        return true;
    }

    /* [v11.0] ì „ êµ¬ì—­ ìœ ì € ë¶€ë™ì‚° ë³´ìœ  í˜„í™© ì´ê´„ ì¡°íšŒ */
    if (msg === "/ì „ì²´ë¶€ë™ì‚°") {
        var targetRoomData = (roomName === "ë² ë¦­ë°©") ? data.rooms["ë‚´ë¦¬ë‹¤"] : data.rooms[roomName];
        var allUsers = [];
        var totalMarketValue = 0;
        var ownerCount = 0;

        for (var r in data.rooms) {
            var roomUsers = data.rooms[r].users;
            for (var uid in roomUsers) {
                var u = roomUsers[uid];
                var holdings = u.landHoldings || {};
                var keys = Object.keys(holdings);
                
                if (keys.length > 0) {
                    var userTotalValue = 0;
                    var holdingList = [];
                    
                    for (var i = 0; i < keys.length; i++) {
                        var lName = keys[i];
                        var qty = Number(holdings[lName]);
                        if (qty <= 0) continue;
                        
                        var land = data.landmarkMarket[lName];
                        var curPrice = land ? Number(land.price) : 0;
                        var trait = (land && land.type && SYSTEM_CONFIG.ECO.LANDMARK.TRAITS[land.type]) 
                                    ? SYSTEM_CONFIG.ECO.LANDMARK.TRAITS[land.type] : {icon: "ğŸ¢"};
                        
                        userTotalValue += (qty * curPrice);
                        holdingList.push("â€¢ " + trait.icon + " " + lName + " : " + qty + "ì§€ë¶„");
                    }

                    if (holdingList.length > 0) {
                        allUsers.push({
                            name: getDisplayName(u),
                            list: holdingList.join("\n"),
                            total: userTotalValue
                        });
                        totalMarketValue += userTotalValue;
                        ownerCount++;
                    }
                }
            }
        }

        if (allUsers.length === 0) {
            replier.reply(formatAdmin("ì¡°íšŒ ê²°ê³¼", "í˜„ì¬ ë¶€ë™ì‚° ì§€ë¶„ì„ ë³´ìœ í•œ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤."));
            return true;
        }

        var body = allUsers.map(function(u) {
            return "ğŸ‘¤ " + u.name + "ë‹˜\n" + u.list + "\nğŸ’° ìì‚°ê°€ì¹˜: " + fp(u.total) + "P";
        }).join("\n\n");

        var summary = "ğŸ“ˆ ì „ì²´ í†µê³„ ìš”ì•½\n" +
                      "â€¢ ë¶€ë™ì‚° ë³´ìœ  ìœ ì €: " + ownerCount + "ëª…\n" +
                      "â€¢ ì „ êµ¬ì—­ ì§€ë¶„ ì´ì•¡: " + fp(totalMarketValue) + "P";

        replier.reply(formatAdmin("ğŸ“Š ì „ êµ¬ì—­ ë¶€ë™ì‚° ë³´ìœ  í˜„í™©", body + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + summary));
        return true;
    }

   /* [v11.0] ìœ ì € ë¶€ë™ì‚° ì§€ë¶„ ê°•ì œ íšŒìˆ˜ ë¡œì§ */
    if (msg.indexOf("/ë¶€ë™ì‚°íšŒìˆ˜ ") === 0) {
        var ps = msg.trim().split(/\s+/);
        if (ps.length < 4) {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "í˜•ì‹: /ë¶€ë™ì‚°íšŒìˆ˜ [ë‹‰ë„¤ì„] [ê±´ë¬¼ëª…] [ìˆ˜ëŸ‰|ì „ë¶€]"));
            return true;
        }

        var qtyInput = ps.pop(); // ë§ˆì§€ë§‰ ì¸ì: ìˆ˜ëŸ‰ ë˜ëŠ” 'ì „ë¶€'
        var landInput = ps.pop(); // ì¤‘ê°„ ì¸ì: ê±´ë¬¼ëª…
        var targetNick = ps.slice(1).join(" ").trim(); // ë‚˜ë¨¸ì§€: ë‹‰ë„¤ì„

        var roomData = data.rooms[roomName];
        var found = findUserByName(roomData, targetNick);

        if (found.length === 0) {
            replier.reply(formatAdmin("ğŸš« ëŒ€ìƒ ì—†ìŒ", "[" + targetNick + "] ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        } else if (found.length > 1) {
            handleUserSelection(replier, targetUid, found, "admin_land_take", { land: landInput, qty: qtyInput }, user, roomName);
        } else {
            var f = found[0];
            var tUser = f.data; // ì •í™•íˆ 1ëª…ì˜ ë°ì´í„°ë§Œ ì°¸ì¡°
            var tRoom = f.roomName;
            var holdings = tUser.landHoldings || {};
            
            var matchedLand = util_findStockByShorthand(holdings, landInput);
            if (matchedLand.length === 0) {
                replier.reply(formatAdmin("ğŸš« ë³´ìœ  ì •ë³´ ì—†ìŒ", "[" + tUser.name + "]ë‹˜ì€ [" + landInput + "] ì§€ë¶„ì´ ì—†ìŠµë‹ˆë‹¤."));
                return true;
            }
            
            var sName = matchedLand[0];
            var currentQty = Number(holdings[sName] || 0);
            var takeQty = (qtyInput === "ì „ë¶€") ? currentQty : parseInt(qtyInput.replace(/,/g, ""));
            if (takeQty > currentQty) takeQty = currentQty;

            tUser.skipHealing = true;
            // í•´ë‹¹ ìœ ì €(tUser)ì˜ ì§€ë¶„ë§Œ ìˆ˜ì •
            util_updateLandmark(tUser, sName, -takeQty, "ê´€ë¦¬ì ê°•ì œ íšŒìˆ˜", tRoom);
            
            if (Number(tUser.landHoldings[sName]) <= 0) {
                delete tUser.landHoldings[sName];
                if (tUser.landAvg) delete tUser.landAvg[sName];
            }

            replier.reply(formatAdmin("âš™ï¸ ë¶€ë™ì‚° ê°•ì œ íšŒìˆ˜ ì™„ë£Œ", "ëŒ€ìƒ: " + tUser.name + "\nê±´ë¬¼: " + sName + "\nìˆ˜ëŸ‰: " + takeQty + "ì§€ë¶„ íšŒìˆ˜"));
            safeSaveData(data);
            return true;
        }
    }

    /* [v11.5] 6ëŒ€ í•µì‹¬ ëœë“œë§ˆí¬ ì‹¤ì‹œê°„ ë°°ë‹¹ í˜„í™© ì¡°íšŒ (ë¬¸ë²• ì˜¤ë¥˜ ìˆ˜ì •ë³¸) */
    if (msg === "/ë°°ë‹¹í˜„í™©") {
        var targetZone = (roomName === "ë² ë¦­ë°©" || ALLOWED_ROOMS.indexOf(roomName) === -1) ? "ë‚´ë¦¬ë‹¤" : roomName;
        var roomData = data.rooms[targetZone];
        if (!roomData || !roomData.features || !roomData.features.dailyPools) return true;

        // 1. ì‹œê°„ ë° í™˜ê²½ ë³€ìˆ˜ ì•ˆì „ ë¡œë“œ
        var now = new Date();
        var startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        var hoursPassed = (now - startOfDay) / 3600000; 

        // SYSTEM_CONFIGê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ í•˜ë“œì½”ë”© ë°±ì—…
        var baseHourly = 10000;
        var threshold = 10;
        var bonusRate = 0.1;

        if (typeof SYSTEM_CONFIG !== 'undefined' && SYSTEM_CONFIG.ECO) {
            baseHourly = SYSTEM_CONFIG.ECO.HOURLY_DIVIDEND || 10000;
            threshold = SYSTEM_CONFIG.ECO.BONUS_THRESHOLD || 10;
            bonusRate = SYSTEM_CONFIG.ECO.BONUS_RATE || 0.1;
        }

        // 2. ë‚´ë¶€ ì „ìš© ìˆ«ì í¬ë§·í„° (fp í•¨ìˆ˜ê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ì„ ê²½ìš° ëŒ€ë¹„)
        var formatP = function(val) {
            if (isNaN(val)) return "0";
            return String(Math.floor(val)).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        };

        // 3. ë‚´ë¶€ ì „ìš© ì´ë¦„ ì¶”ì¶œê¸° (getDisplayName í•¨ìˆ˜ê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ì„ ê²½ìš° ëŒ€ë¹„)
        var getName = function(u) {
            if (!u) return "ì•Œ ìˆ˜ ì—†ìŒ";
            return u.name || "ì´ë¦„ì—†ìŒ";
        };

        var targets = [
            { name: "ê´‘ì‚°", icon: "â›ï¸" }, { name: "ë‚šì‹œí„°", icon: "ğŸ£" },
            { name: "ì¹´ì§€ë…¸", icon: "ğŸ°" }, { name: "ì¤‘ì•™ì€í–‰", icon: "ğŸ¦" },
            { name: "ë°±í™”ì ", icon: "ğŸ¢" }, { name: "ê²½ë§ˆì¥", icon: "ğŸ‡" }
        ];

        targets.sort(function(a, b) { return a.name.localeCompare(b.name); });

        var report = [];
        targets.forEach(function(t) {
            var owner = util_getMajorityOwner(roomData, t.name);
            var ownerTag = "âš ï¸ ì£¼ì¸ ì—†ìŒ";
            var finalDividend = 0;
            var landlordBonusTag = "";

            // [ìˆ˜ì •]: ì¹­í˜¸ëª…ì„ 'ì „ì„¤ì˜ í°ì†'ìœ¼ë¡œ ë³€ê²½í•˜ê³  ì‹¤ì‹œê°„ ë³´ë„ˆìŠ¤ ê³„ì‚° ë° ì•ˆë‚´ íƒœê·¸ ì¶”ê°€
            var landlordBonusTag = "";

            if (owner && owner.data) {
                var nameTag = getName(owner.data);
                ownerTag = "ğŸ‘‘ " + nameTag + " (" + owner.qty + "ì§€ë¶„)";
                
                // ë³´ë„ˆìŠ¤ ë°°ìœ¨ ê³„ì‚° (10ì§€ë¶„ ì´ˆê³¼ ì‹œ 10% ê°€ì‚°)
                var shareMult = owner.qty > threshold ? 1.0 + (owner.qty - threshold) * bonusRate : 1.0;
                finalDividend = Math.floor(baseHourly * hoursPassed * shareMult);
                
                // [ì°©ìš© íš¨ê³¼]: 'ì „ì„¤ì˜ í°ì†' ì¹­í˜¸ ì¥ì°© ì‹œ ì‹¤ì‹œê°„ ì¡°íšŒ ìˆ˜ì¹˜ì— 1.1ë°° ì¦‰ì‹œ ë°˜ì˜
                if (owner.data.title === "ì „ì„¤ì˜ í°ì†") {
                    finalDividend = Math.floor(finalDividend * 1.1);
                    landlordBonusTag = " (ğŸ°ì „ì„¤ì˜ í°ì† íš¨ê³¼ ì ìš©)";
                }
            }

            report.push(t.icon + " " + t.name + "\n  ğŸ’° í˜„ì¬ê¹Œì§€ ì ë¦½: " + formatP(finalDividend) + "P" + landlordBonusTag + "\n  ğŸ‘¤ í˜„ì¬ ì£¼ì£¼: " + ownerTag);
        });

        var header = "ğŸ“Š ì‹¤ì‹œê°„ ëœë“œë§ˆí¬ ë°°ë‹¹ í˜„í™©\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâ€» ì‹œê°„ë‹¹ " + formatP(baseHourly) + "P í™•ì • ìˆ˜ìµ ëª¨ë¸";
        var footer = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâœ¨ ì˜¤ëŠ˜ ì´ ê²½ê³¼ ì‹œê°„: " + hoursPassed.toFixed(1) + "ì‹œê°„\nğŸ’¡ ìì •(00:00) ì •ì‚° ì‹œì ì— ìë™ ì§€ê¸‰ë©ë‹ˆë‹¤.";

        replier.reply(formatAdmin("ë°°ë‹¹ ë¦¬í¬íŠ¸", header + "\n\n" + report.join("\n\n") + "\n" + footer));
        return true;
    }

    if (msg === "/ê²½ì œì „ì²´ë¦¬ì…‹") {
        var roomData = data.rooms[roomName];
        if (!roomData) return true;
        
        var userCount = 0;
        var setPoint = 100000; // ì„¤ì •ëœ í˜„ê¸ˆ 10ë§Œ
        var setBank = 100000;  // ì„¤ì •ëœ ì˜ˆê¸ˆ 10ë§Œ

        for (var r in data.rooms) {
            for (var uid in data.rooms[r].users) {
                var u = data.rooms[r].users[uid];
                
                // 1. í—¬ëŸ¬ ë°©ì–´ë§‰ ê°€ë™ (ê¸‰ê° ë³µêµ¬ ì°¨ë‹¨)
                u.skipHealing = true; 
                
                // 2. ëª¨ë“  ìì‚° ë° ë¶€ì±„ ì²­ì‚°
                u.point = setPoint;
                u.bank = setBank;
                u.loan = { debt: 0, items: [] }; // ë¹š íƒ•ê°
                u.stockHoldings = {};           // ëœë“œë§ˆí¬ ì „ëŸ‰ ëª°ìˆ˜
                u.stockAvg = {};
                u.isTransferred = false;        // ëŒ€í™˜ ì±„ë¬´ ì‚­ì œ
                u.isDefaulter = false;          // ì‹ ë¶ˆì í•´ì œ
                u.creditScore = 600;            // ì‹ ìš©ì ìˆ˜ ì´ˆê¸°í™”
                u.tier = 0;                     // í‹°ì–´ ë¦¬ì…‹ (ì„ íƒ ì‚¬í•­)
                
                userCount++;
            }
        }

        // 3. ì¤‘ì•™ì€í–‰ ì¬ì› ì •ìƒí™” (ë¬¼ê°€ ê¸°ì¤€ì ì˜ 30% ìˆ˜ì¤€ìœ¼ë¡œ ìˆ˜í˜ˆ)
        var roomBase = roomData.economyBase || 3953977;
        roomData.bankReserve = Math.floor(roomBase * 0.3);

        safeSaveData(data, true); // ê°•ì œ ë°±ì—… ë™ì‹œ ìˆ˜í–‰
        
        var resMsg = "ğŸš¨ [êµ­ê°€ ê²½ì œ ëŒ€ê³µí™© ë° ê°•ì œ ë¦¬ì…‹ ì™„ë£Œ]\n" +
                     "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                     "â€¢ ëŒ€ìƒ ì¸ì›: " + userCount + "ëª… ì „ì²´\n" +
                     "â€¢ ê³µí†µ ì§€ê¸‰: í˜„ê¸ˆ 10ë§Œ + ì˜ˆê¸ˆ 10ë§Œ\n" +
                     "â€¢ íŠ¹ë³„ ì¡°ì¹˜: ë¹š íƒ•ê° / ëœë“œë§ˆí¬ ì´ˆê¸°í™” / ì‹ ë¶ˆ í•´ì œ\n" +
                     "â€¢ êµ­ê³  ìƒíƒœ: " + fp(roomData.bankReserve) + "P (ìˆ˜í˜ˆ ì™„ë£Œ)\n" +
                     "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                     "ğŸ’¡ ëª¨ë“  ìœ ì €ê°€ ë™ì¼í•œ ì¶œë°œì„ ì—ì„œ ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤.";
        replier.reply(formatAdmin("ê²½ì œ ì‹œìŠ¤í…œ ì¬ì‹œì‘", resMsg));
        return true;
    }

    if (msg === "/ì§€ë¶„í˜„í™©") {
        var landMarket = data.landmarkMarket;
        var landNames = Object.keys(landMarket);
        var report = [];
        
        // ì •ë ¬ ìš°ì„ ìˆœìœ„ ì •ì˜ (1:ê³ ì •, 2:ë¹„ì¦ˆë‹ˆìŠ¤, 3:ìƒê°€)
        var getPriority = function(name, type) {
            if (["ê´‘ì‚°", "ë‚šì‹œí„°", "ì¹´ì§€ë…¸", "ì¤‘ì•™ì€í–‰", "ë°±í™”ì ", "ê²½ë§ˆì¥"].indexOf(name) !== -1) return 1;
            if (type === "bluechip") return 2;
            if (type === "hotspot") return 3;
            return 4;
        };

        landNames.sort(function(a, b) {
            var priA = getPriority(a, landMarket[a].type);
            var priB = getPriority(b, landMarket[b].type);
            if (priA !== priB) return priA - priB;
            return a.localeCompare(b);
        });

        landNames.forEach(function(landName) {
            var owners = [];
            var totalLandShares = 0;
            for (var r in data.rooms) {
                for (var uId in data.rooms[r].users) {
                    var u = data.rooms[r].users[uId];
                    if (u.landHoldings && u.landHoldings[landName]) {
                        var q = Number(u.landHoldings[landName]);
                        if (q > 0) { owners.push(u.name + "(" + q + ")"); totalLandShares += q; }
                    }
                }
            }
            var ownerText = owners.length > 0 ? owners.join(", ") : "ì†Œìœ ì ì—†ìŒ";
            report.push("ğŸ¢ [" + landName + "] (ì´ " + totalLandShares + "ì§€ë¶„)\n   ğŸ‘¤ " + ownerText);
        });
        
        replier.reply(formatAdmin("ğŸ—ï¸ ì „ êµ¬ì—­ ë¶€ë™ì‚° ì§€ë¶„ ì¥ë¶€", report.join("\n\n")));
        return true;
    }

    /* [ë³´ì•ˆ] ìœ ì € ê³ ìœ  ì½”ë“œ ëª…ë¶€ ì¡°íšŒ (Ghost Filter ì ìš©) */
    if (msg === "/ëª…ë¶€í™•ì¸") {
        try {
            var regFile = new java.io.File(REGISTRY_PATH);
            if (!regFile.exists() || regFile.length() === 0) {
                replier.reply(formatAdmin("ğŸ“œ ìœ ì € ëª…ë¶€", "ë“±ë¡ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."));
                return true;
            }

            var registry = JSON.parse(FileStream.read(REGISTRY_PATH));
            var list = [];
            for (var key in registry) {
                // [í•µì‹¬] "ë‚´ë¦¬ë‹¤_"ë¡œ ì‹œì‘í•˜ëŠ” í‚¤ê°’ë§Œ ë¦¬ìŠ¤íŠ¸ì— í¬í•¨ (ìœ ë ¹ë°© ë°ì´í„° ì€í)
                if (key.indexOf("ë‚´ë¦¬ë‹¤_") !== 0) continue;

                var parts = key.split("_");
                var rName = parts[0]; 
                var uName = parts.slice(1).join("_"); 
                var uid = registry[key];

                var uData = (data.rooms[rName] && data.rooms[rName].users[uid]) ? data.rooms[rName].users[uid] : null;
                var statusTag = uData ? " [" + fp(uData.point) + "P]" : " [ë°ì´í„° ìœ ì‹¤]";
                
                list.push("â€¢ " + uName + statusTag + "\n  â”” " + uid);
            }

            if (list.length === 0) {
                replier.reply(formatAdmin("ğŸ“œ ìœ ì € ëª…ë¶€", "ì¡°íšŒëœ ì‹¤ì‚¬ìš© ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤."));
            } else {
                replier.reply(formatAdmin("ğŸ“œ ë‚´ë¦¬ë‹¤ êµ¬ì—­ ì‹¤ì‚¬ìš©ì ëª…ë¶€", list.join("\n\n")));
            }
        } catch (e) {
            replier.reply(formatAdmin("ğŸš« ì¡°íšŒ ì˜¤ë¥˜", "ëª…ë¶€ ë¡œë“œ ì‹¤íŒ¨"));
        }
        return true;
    }

    /* [ë³´ì•ˆ] íŠ¹ì • ë‹‰ë„¤ì„ ëª…ë¶€ ê°•ì œ ì‚­ì œ */
    if (msg.indexOf("/ëª…ë¶€ì‚­ì œ ") === 0) {
        var targetNick = msg.substring(6).trim();
        var regFile = new java.io.File(REGISTRY_PATH);
        if (!regFile.exists()) return replier.reply(formatAdmin("ì˜¤ë¥˜", "ëª…ë¶€ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."));

        var regData = JSON.parse(FileStream.read(REGISTRY_PATH));
        var matches = [];
        for (var key in regData) {
            var nickPart = key.substring(key.indexOf("_") + 1);
            if (nickPart.indexOf(targetNick) !== -1) {
                // ê³µí†µ ì—”ì§„ ê·œê²©ì— ë§ì¶° ë°ì´í„° í¬ë§·íŒ…
                matches.push({ id: key, data: { name: nickPart } });
            }
        }

        if (matches.length === 0) {
            replier.reply(formatAdmin("ì‚­ì œ ì‹¤íŒ¨", "ëª…ë¶€ì—ì„œ [" + targetNick + "]ì´(ê°€) í¬í•¨ëœ ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        } else if (matches.length > 1) {
            // ì„¹í„° 11ì˜ ê³µí†µ ì¤‘ë³µ ì„ íƒ ì—”ì§„ í˜¸ì¶œ (ì´ì œ ìˆ«ìê°€ ì‘ë™í•©ë‹ˆë‹¤!)
            handleUserSelection(replier, targetUid, matches, "admin_reg_delete", null, user, roomName);
        } else {
            // 1ëª…ì¼ ë•ŒëŠ” ì¦‰ì‹œ ì‚­ì œ ì‹¤í–‰
            var targetKey = matches[0].id;
            var targetFullNick = matches[0].data.name;
            delete regData[targetKey];
            FileStream.write(REGISTRY_PATH, JSON.stringify(regData));
            replier.reply(formatAdmin("ëª…ë¶€ ì‚­ì œ ì™„ë£Œ", "ì°¾ì€ ìœ ì €: [" + targetFullNick + "]\nê´€ë ¨ ì‹ë³„ ì½”ë“œë¥¼ ëª…ë¶€ì—ì„œ íŒŒê¸°í–ˆìŠµë‹ˆë‹¤."));
        }
        return true;
    }

    /* [ë³´ì•ˆ] ëª…ë¶€ ì¼ê´„ ìµœì í™” (ìœ ë ¹ ë°ì´í„° ì „ëŸ‰ ì œê±°) */
    if (msg === "/ëª…ë¶€ì—…ë°ì´íŠ¸") {
        var newRegistry = {};
        var count = 0;
        
        // í˜„ì¬ ë©”ëª¨ë¦¬ì— ë¡œë“œëœ(ì‹¤ì œ ì¡´ì¬í•˜ëŠ”) ìœ ì €ë“¤ë¡œë§Œ ëª…ë¶€ë¥¼ ìƒˆë¡œ ë§Œë“­ë‹ˆë‹¤.
        for (var rName in data.rooms) {
            var users = data.rooms[rName].users;
            for (var uid in users) {
                var regKey = rName + "_" + users[uid].name;
                newRegistry[regKey] = uid;
                count++;
            }
        }

        FileStream.write(REGISTRY_PATH, JSON.stringify(newRegistry));
        replier.reply(formatAdmin("âœ… ëª…ë¶€ ìµœì í™” ì™„ë£Œ", "í˜„ì¬ ì¡´ì¬í•˜ëŠ” " + count + "ëª…ì˜ ìœ ì € ì •ë³´ë¡œ ëª…ë¶€ë¥¼ ìƒˆë¡œ ê³ ì¹¨í–ˆìŠµë‹ˆë‹¤.\n(ìœ ë ¹ ë°ì´í„° ì „ëŸ‰ ì œê±°ë¨)"));
        return true;
    }

    /* [5] ë°ì´í„° êµì • ë° ë¬´ê²°ì„± ê²€ì‚¬ */
    if (msg.trim() === "/ë°ì´í„°êµì •") {
        var fixCount = 0;
        var refundCount = 0;
        var totalRefunded = 0;

        for (var r in data.rooms) {
            var currentRoom = data.rooms[r];
            if (!currentRoom.loanPools) currentRoom.loanPools = {};
            if (!currentRoom.loanContracts) currentRoom.loanContracts = {};

            for (var id in currentRoom.users) {
                var u = currentRoom.users[id];
                if (!u) continue;

                if (Number(u.totalAttendance || 0) <= 3) {
                    for (var cid in currentRoom.loanContracts) {
                        var c = currentRoom.loanContracts[cid];
                        if (c.borrowerUid === id) {
                            var lender = currentRoom.users[c.lenderUid];
                            if (lender) {
                                lender.point = Number(lender.point) + Number(c.currentDebt);
                                totalRefunded += Number(c.currentDebt);
                                refundCount++;
                            }
                            delete currentRoom.loanContracts[cid];
                        }
                    }
                }
                u.point = Math.floor(Number(u.point || 0));
                u.bank = Math.floor(Number(u.bank || 0));
                u.creditScore = Math.min(1000, Math.max(0, Number(u.creditScore || 600)));
                u.isDefaulter = (u.creditScore < 500);
                if (!u.loan) u.loan = { debt: 0, items: [] };
                if (!u.stockHoldings) u.stockHoldings = {};

                // êµì • ì‹œì ì— ì˜ˆê¸ˆìê°€ ê¸°ì¤€ ì‹œê°„ì´ ì—†ë‹¤ë©´ í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ê°•ì œ ì£¼ì…
                if (u.bank > 0 && (!u.lastBankUpdateTime || u.lastBankUpdateTime === 0)) {
                    u.lastBankUpdateTime = Date.now();
                }

                fixCount++;
            }
        }
        
        safeSaveData(data);
        var resMsg = "ì „ì²´ ìœ ì € " + fixCount + "ëª… ë™ê¸°í™” ì™„ë£Œ\n" +
                     "ğŸ“‰ ì‚¬ì±„ í™˜ìˆ˜: " + refundCount + "ê±´ (" + fp(totalRefunded) + "P ë°˜í™˜)";
        replier.reply(formatAdmin("ë°ì´í„° êµì • ë° ë¶„ë¦¬ ì™„ë£Œ", resMsg));
        return true;
    }

    /* [6] ë¬¼ê°€ ì¡°ì • */
    if (msg.indexOf("/ë¬¼ê°€ì¡°ì •") === 0) {
        var args = msg.split(" ");
        var currentEco = calculateEconomy(data, roomName); 
        if (args[1] === "ì´ˆê¸°í™”") { data.rooms[roomName].economyBase = 0; safeSaveData(data); replier.reply(formatAdmin("âš–ï¸ ë¬¼ê°€ ì´ˆê¸°í™”", "ê¸°ë³¸ê°€ë¡œ ê³ ì •ë©ë‹ˆë‹¤.")); return true; }
        var oldBase = data.rooms[roomName].economyBase || currentEco.total;
        var newBase = (args.length > 1 && !isNaN(parseInt(args[1]))) ? parseInt(args[1]) : Math.floor(Math.sqrt(oldBase * currentEco.total));
        data.rooms[roomName].economyBase = newBase;
        safeSaveData(data);
        replier.reply(formatAdmin("âš–ï¸ ë¬¼ê°€ ì¡°ì • ì™„ë£Œ", "ìƒˆ ê¸°ì¤€: " + fp(newBase) + "P"));
        return true;
    }

    /* [7] ë¬¼ê°€ ì™„ì¶© ë¹„ìœ¨ ì„¤ì • */
    if (msg.indexOf("/ë¬¼ê°€ì™„ì¶©") === 0) {
        var val = parseFloat(msg.split(" ")[1]);
        if (isNaN(val) || val < 0.0 || val > 1.0) { replier.reply(formatAdmin("ì˜¤ë¥˜", "0.0 ~ 1.0 ì‚¬ì´ì˜ ì†Œìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")); return true; }
        data.economyDamping = val;
        safeSaveData(data);
        replier.reply(formatAdmin("ğŸ›¡ï¸ ë¬¼ê°€ ì™„ì¶© ì„¤ì • ì™„ë£Œ", "ì ìš© ë¹„ìœ¨: " + (val*100) + "%"));
        return true;
    }

    /* [8] ì „ì—­ í¬ì¸íŠ¸ ì§€ê¸‰ */
    if (msg.indexOf("/í¬ì¸íŠ¸ì§€ê¸‰ ") === 0) {
        var parts = msg.trim().split(/\s+/);
        if (parts.length < 3) return replier.reply(formatError(user, "í˜•ì‹ ì˜¤ë¥˜", "/í¬ì¸íŠ¸ì§€ê¸‰ [ë‹‰ë„¤ì„] [ê¸ˆì•¡]"));
        var am = parseInt(parts.pop());
        var tn = parts.slice(1).join(" ").trim();
        
        var found = findUserGlobal(tn, roomName);
        if (!found.length) { replier.reply(formatError(user, "ëŒ€ìƒ ì—†ìŒ", "ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (found.length > 1) { handleUserSelection(replier, targetUid, found, "admin_point_give", { amount: am }, user, roomName); return true; }
        
        var f = found[0];
        util_updatePoint(f.data, data.rooms[f.roomName], am, "ê´€ë¦¬ì ì „ì—­ ì§€ê¸‰", f.roomName);
        replier.reply(formatAdmin("ì§€ê¸‰ ì™„ë£Œ", "[" + f.roomName + "] " + f.data.name + "ë‹˜: +" + fp(am) + "P"));
        try { Api.replyRoom("ë² ë¦­ë°©", "âš™ï¸ [Admin Action]\nâ€¢ ì‹¤í–‰ì: " + sender + "\nâ€¢ ë‚´ìš©: " + msg); } catch(e) {}
        safeSaveData(data);
        return true;
    }

    /* [9] ì „ì—­ í¬ì¸íŠ¸ ì°¨ê° */
    if (msg.indexOf("/í¬ì¸íŠ¸ì°¨ê° ") === 0) {
        var parts = msg.trim().split(/\s+/);
        if (parts.length < 3) return replier.reply(formatError(user, "í˜•ì‹ ì˜¤ë¥˜", "/í¬ì¸íŠ¸ì°¨ê° [ë‹‰ë„¤ì„] [ê¸ˆì•¡]"));
        var am = parseInt(parts.pop());
        var tn = parts.slice(1).join(" ").trim();
        
        var found = findUserGlobal(tn);
        if (!found.length) { replier.reply(formatError(user, "ëŒ€ìƒ ì—†ìŒ", "ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (found.length > 1) { handleUserSelection(replier, targetUid, found, "admin_point_take", { amount: am }, user, roomName); return true; }
        
        var f = found[0];
        util_updatePoint(f.data, data.rooms[f.roomName], -am, "ê´€ë¦¬ì ì „ì—­ ì°¨ê°", f.roomName);
        replier.reply(formatAdmin("ì°¨ê° ì™„ë£Œ", "[" + f.roomName + "] " + f.data.name + "ë‹˜ ì°¨ê° ì²˜ë¦¬ë¨"));
        safeSaveData(data);
        return true;
    }

    /* [10] ì „ì²´ í¬ì¸íŠ¸ ì§€ê¸‰ */
    if (msg.indexOf("/ì „ì²´í¬ì¸íŠ¸ì§€ê¸‰ ") === 0) {
        var amt = parseInt(msg.split(" ")[1]);
        if (isNaN(amt)) return true;
        var count = 0;
        for (var r in data.rooms) {
            for (var id in data.rooms[r].users) {
                util_updatePoint(data.rooms[r].users[id], data.rooms[r], amt, "ì „ì²´ í¬ì¸íŠ¸ ì§€ê¸‰", r);
                count++;
            }
        }
        safeSaveData(data);
        replier.reply(formatAdmin("ì „ì²´ ì§€ê¸‰ ì™„ë£Œ", "ì´ " + count + "ëª…ì—ê²Œ " + fp(amt) + "P ì§€ê¸‰ ì™„ë£Œ"));
        return true;
    }

    /* [ì‹ ê·œ: Gemini ìš”ì²­ ì‚¬í•­] ê²½ë§ˆ ì´ì›”ê¸ˆ ìˆ˜ë™ ì¡°ì • ëª…ë ¹ì–´ */
    if (msg.indexOf("/ì´ì›”ê¸ˆìˆ˜ì • ") === 0) {
        var val = parseInt(msg.split(" ")[1].replace(/,/g, ""));
        if (isNaN(val)) {
            replier.reply(formatAdmin("ì˜¤ë¥˜", "ìˆ˜ì •í•  ì´ì›” ê¸ˆì•¡ì„ ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”."));
            return true;
        }
        // ë©”ì¸ ìš´ì˜ ë°©("ë‚´ë¦¬ë‹¤")ì˜ ê²½ë§ˆ ì´ì›”ê¸ˆ ê°•ì œ ìˆ˜ì •
        var targetRoom = data.rooms["ë‚´ë¦¬ë‹¤"];
        if (targetRoom && targetRoom.features && targetRoom.features.racing) {
            targetRoom.features.racing.carryOver = val;
            safeSaveData(data);
            replier.reply(formatAdmin("ğŸ‡ ê²½ë§ˆ ì´ì›”ê¸ˆ ìˆ˜ì • ì™„ë£Œ", "í˜„ì¬ ì ë¦½ëœ ì´ì›”ê¸ˆì„ " + fp(val) + "Pë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤."));
        }
        return true;
    }

    /* [11] í¬ì¸íŠ¸ ë¿Œë¦¬ê¸° (ë°©ë³„ ë…ë¦½ ì£¼ë¨¸ë‹ˆ ì—°ë™ - ë¨¹í†µ í•´ê²° í•µì‹¬) */
    if (msg === "/ë¿Œë¦¬ê¸°") {
        var roomData = data.rooms[roomName];
        var sprinkleData = roomData.features.sprinkleData; // ë°©ë³„ ë°ì´í„° ì—°ê²°

        if (sprinkleData.active) { 
            replier.reply(formatAdmin("ì˜¤ë¥˜", "ì´ë¯¸ ë¿Œë¦¬ê¸°ê°€ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.")); 
            return true; 
        }
        
        var count = Math.floor(Math.random() * 3) + 2; 
        var multiplier = util_getEcoMultiplier(roomName);
        
        var portions = [];
        var totalSprinkle = 0;
        for(var i=0; i<count; i++) {
            // ê¸°ë³¸ ë²”ìœ„ë¥¼ 5000 ~ 8000Pë¡œ ìƒí–¥
            var baseP = Math.floor(Math.random() * 3001) + 4000; 
            var finalP = Math.floor(baseP * multiplier);
            portions.push(finalP);
            totalSprinkle += finalP;
        }

        // [v5.9 ìˆ˜ì •] ì „ì—­ sprinkleDataê°€ ì•„ë‹Œ í˜„ì¬ ë°©ì˜ rFeatures.sprinkleDataì— í• ë‹¹
        sprinkleData.active = true;
        sprinkleData.totalPoint = totalSprinkle;
        sprinkleData.remainingPoint = totalSprinkle;
        sprinkleData.limit = count;
        sprinkleData.currentWinners = 0;
        sprinkleData.winners = [];
        sprinkleData.portions = portions;

        Api.replyRoom(roomName, formatAdmin("ğŸ‰ í¬ì¸íŠ¸ ë¿Œë¦¬ê¸° ì‹œì‘!", "ì„ ì°©ìˆœ " + count + "ëª…!\nì±„íŒ…ì°½ì— [ì¤ê¸°]ë¥¼ ì…ë ¥í•˜ì„¸ìš”!\nğŸ’° ì´ ë°°ì •: " + fp(totalSprinkle) + "P"));
        
        // 1ë¶„ í›„ ìë™ ì¢…ë£Œ íƒ€ì´ë¨¸ (ë°© ì´ë¦„ì„ í´ë¡œì €ë¡œ ì „ë‹¬)
        (function(targetRoom, targetData) {
            setTimeout(function() { 
                var rData = targetData.rooms[targetRoom];
                if (rData && rData.features.sprinkleData.active) { 
                    rData.features.sprinkleData.active = false; 
                    Api.replyRoom(targetRoom, formatAdmin("ğŸ ë¿Œë¦¬ê¸° ì‹œê°„ ì´ˆê³¼", "ì´ë²¤íŠ¸ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")); 
                    safeSaveData(targetData);
                } 
            }, 60000);
        })(roomName, data);
        
        safeSaveData(data);
        return true;
    }

    /* [12] ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì„¸íŠ¸ */
    if (msg === "/ë¡œë˜ë°ì´í„°ì´ˆê¸°í™”") {
        lotto = { round: (lotto.round || 0) + 1, entries: {}, dailyPool: 0, jackpot: 0, lastWinNums: [] };
        safeSaveData(data);
        replier.reply(formatAdmin("ì™„ë£Œ", "ë¡œë˜ ì‹œìŠ¤í…œ ë¦¬ì…‹ ì™„ë£Œ"));
        return true;
    }
    if (msg === "/ìŠ¹ê¸‰íšŸìˆ˜ì´ˆê¸°í™”") {
        for (var r in data.rooms) {
            for (var id in data.rooms[r].users) {
                data.rooms[r].users[id].dailyPromotionAttempts = 1;
                data.rooms[r].users[id].purchasedPromotionAttempts = 0;
            }
        }
        safeSaveData(data);
        replier.reply(formatAdmin("ì™„ë£Œ", "ì „ì²´ ìŠ¹ê¸‰ ê¸°íšŒ ì´ˆê¸°í™”"));
        return true;
    }

//==========ì„¹í„°36==========

    if (msg.trim() === "/ì‹œì¦Œê°•ì œì¢…ë£Œ") {
        var resetCount = 0;
        for (var r in data.rooms) {
            var rObj = data.rooms[r];
            if (!rObj.users) continue;
            for (var id in rObj.users) {
                var u = rObj.users[id];
                
                // 1. í‹°ì–´ ë° ëª…ì˜ˆì˜ ì „ë‹¹ ì´ˆê¸°í™”
                u.tier = 0; 
                u.challengerCount = 0; 
                u.challengerIconSeason = ""; 

                // 2. [í•µì‹¬] ìŠ¹ê¸‰ê¶Œ êµ¬ë§¤ íšŸìˆ˜ ì´ˆê¸°í™” (ê°€ê²©ì„ ë‹¤ì‹œ 2,000Pë¡œ ë³µêµ¬)
                u.purchasedPromotionAttempts = 0; 

                // 3. ì‹œì¦Œ í•œì • ì†Œëª¨í’ˆ/ì¸ì¦ ì´ˆê¸°í™”
                u.gameAuthCount = 0; 
                u.purchasedAuthCount = 0; 

                // 4. ë³´ì•ˆ ì—”ì§„(Healer)ì˜ ê°•ì œ ë³µêµ¬ ì¼ì‹œ ì°¨ë‹¨
                u.skipHealing = true; 
                
                resetCount++;
            }
        }
        
        // ë³€ê²½ ì‚¬í•­ ì¦‰ì‹œ ì €ì¥ ë° ë°±ì—…
        safeSaveData(data, true); 
        
        var resMsg = "ì‹œì¦Œì„ ê°•ì œ ì¢…ë£Œí•˜ê³  ëª¨ë“  ê¸°ë¡ì„ ë¦¬ì…‹í–ˆìŠµë‹ˆë‹¤.\n\n" +
                     "â€¢ ëŒ€ìƒ ìœ ì €: " + resetCount + "ëª…\n" +
                     "â€¢ ì´ˆê¸°í™” í•­ëª©: í‹°ì–´, ëª…ì˜ˆì˜ì „ë‹¹, ìŠ¹ê¸‰ê¶Œ í• ì¦ê°€\n" +
                     "â€¢ ìƒíƒœ: ìƒˆ ì‹œì¦Œ ì¤€ë¹„ ì™„ë£Œ";
        
        replier.reply(formatAdmin("ğŸ† ì‹œì¦Œ ê°•ì œ ì¢…ë£Œ ì™„ë£Œ", resMsg));
        return true;
    }

    /* [ë³´ì•ˆ] ë°ì´í„° ë³´í˜¸ ì—”ì§„ ìê°€ì§„ë‹¨ ëª…ë ¹ì–´ (v6.0 ì •ë°€ ì§„ë‹¨í˜•) */
   if (msg === "/ë³´ì•ˆì ê²€") {
        var st = function(ok) { return ok ? "ğŸŸ¢ ê°€ë™" : "ğŸ”´ ì ê²€"; };
        
        // 1. ê²Œì´íŠ¸ì›¨ì´ ì²´í¬ (Logic)
        var gw = {
            p: (typeof util_updatePoint === 'function'),
            u: (typeof util_setData === 'function'),
            r: (typeof util_updateReserve === 'function'),
            s: (typeof util_updateLandmark === 'function'),
            b: (typeof util_updateBank === 'function'),
            g: (typeof util_checkUserState === 'function')
        };

        // 2. ì¸í”„ë¼ ë° ì˜ì†ì„± ì²´í¬ (Infra)
        var infra = {
            lock: (typeof lock !== 'undefined' && !lock.isLocked()) || true,
            save: (typeof SaveExecutor !== 'undefined'),
            spam: (SYSTEM_CONFIG.SPAM !== undefined),
            backup: (SYSTEM_CONFIG.BACKUP.DISCORD_WEBHOOK_URL && SYSTEM_CONFIG.BACKUP.DISCORD_WEBHOOK_URL.indexOf("http") === 0),
            atomic: (new java.io.File(FILE_PATH).exists()),
            reg: (new java.io.File(REGISTRY_PATH).exists()),
            // [ì¶”ê°€] ë¸”ë™ë°•ìŠ¤ ë¡œê·¸ ê¸°ë¡ ê°€ëŠ¥ ì—¬ë¶€ ì²´í¬
            journal: (function() { try { return new java.io.File(BASE_DIR).canWrite(); } catch(e){return false;} })()
        };

        var report = "ğŸ›¡ï¸ [ë³´ì•ˆ ê´€ì œ ì„¼í„°] v6.0\n" +
                     "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                     "ğŸ“ [ë°ì´í„° ê²Œì´íŠ¸ì›¨ì´]\n" +
                     "â€¢ í¬ì¸íŠ¸: " + st(gw.p) + " | ë²”ìš©: " + st(gw.u) + "\n" +
                     "â€¢ êµ­ê³ ì¬ì›: " + st(gw.r) + " | ëœë“œë§ˆí¬: " + st(gw.s) + "\n" +
                     "â€¢ ì€í–‰ì”ê³ : " + st(gw.b) + " | ìƒíƒœ: " + st(gw.g) + "\n\n" +
                     "âš™ï¸ [ì‹¤ì‹œê°„ ë°©ì–´ ë° ì—”ì§„]\n" +
                     "â€¢ ë™ê¸°í™” ë½: " + st(infra.lock) + " (Lock)\n" +
                     "â€¢ ë¹„ë™ê¸° ì €ì¥: " + st(infra.save) + " (Save)\n" +
                     "â€¢ ì‹ ë¶„ ë³µêµ¬: " + st(infra.reg) + " (Registry)\n\n" +
                     "ğŸ“¦ [ì˜ì†ì„± ë° ë°±ì—…]\n" +
                     "â€¢ ë¸”ë™ë°•ìŠ¤: " + st(infra.journal) + " (Journal)\n" + // ë¸”ë™ë°•ìŠ¤ ì¶”ê°€
                     "â€¢ íŒŒì† ë°©ì§€: " + st(infra.atomic) + " (Atomic)\n" +
                     "â€¢ ì›ê²© ë°±ì—…: " + st(infra.backup) + " (Discord)\n" +
                     "â€¢ ìê°€ ì¹˜ìœ : ğŸŸ¢ í™œì„±í™” (Healer)\n" +
                     "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                     "âœ… ëª¨ë“  ì‹œìŠ¤í…œì´ ë³´í˜¸ë˜ê³  ìˆìŠµë‹ˆë‹¤.";
        
        replier.reply(report);
        return true;
    }

    /* [ì‹ ê·œ] ë³´ì•ˆ ì—”ì§„ ë‹¨ê³„ë³„ íŒŒê´´ ì‹œë®¬ë ˆì´ì…˜ (Stress Test) */
    if (msg.indexOf("/ë³´ì•ˆí…ŒìŠ¤íŠ¸ ") === 0) {
        var step = msg.split(" ")[1];
        var roomData = data.rooms[roomName];

        if (step === "1") { // [1ë‹¨ê³„: ë”¥í—¬ëŸ¬ ê²€ì¦]
            replier.reply("ğŸ§ª [í…ŒìŠ¤íŠ¸ 1: ë”¥í—¬ëŸ¬]\në‚´ ë©”ëª¨ë¦¬ ë°ì´í„°ì˜ 'ê°€ë°©'ê³¼ 'ì€í–‰' í•„ë“œë¥¼ ê°•ì œë¡œ ì‚­ì œí•©ë‹ˆë‹¤...");
            delete user.inventory;
            delete user.bank;
            replier.reply("âš ï¸ í•„ë“œ ì‚­ì œ ì™„ë£Œ. ì´ì œ ì•„ë¬´ ë©”ì‹œì§€ë‚˜ ì…ë ¥í•˜ì—¬ 'ë”¥í—¬ëŸ¬'ê°€ ìŠ¤í‚¤ë§ˆë¥¼ ë³µêµ¬í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.\n(ë³µêµ¬ ì„±ê³µ ì‹œ /ê°€ë°© ì¡°íšŒ ê°€ëŠ¥)");
        } 
        
        else if (step === "2") { // [2ë‹¨ê³„: ê²Œì´íŠ¸ì›¨ì´ ê²€ì¦]
            replier.reply("ğŸ§ª [í…ŒìŠ¤íŠ¸ 2: ê²Œì´íŠ¸ì›¨ì´]\ní¬ì¸íŠ¸ì— ìˆ«ìê°€ ì•„ë‹Œ 'ì˜¤ì—¼ëœ ë¬¸ìì—´' ì£¼ì…ì„ ì‹œë„í•©ë‹ˆë‹¤...");
            util_updatePoint(user, roomData, "BAD_DATA", "ë³´ì•ˆ í…ŒìŠ¤íŠ¸ ê³µê²©", roomName);
            replier.reply("âœ… ê²°ê³¼: ê²Œì´íŠ¸ì›¨ì´ê°€ ì˜¤ì—¼ëœ ì—°ì‚°ì„ ì°¨ë‹¨í–ˆìŠµë‹ˆë‹¤. ìƒë‹¨ ë¡œê·¸(Log.error) ë˜ëŠ” ë¸”ë™ë°•ìŠ¤ ê¸°ë¡ì„ í™•ì¸í•˜ì„¸ìš”.");
        } 

        else if (step === "3") { // [3ë‹¨ê³„: ìµœì¢… ê²€ì—­ì†Œ ê²€ì¦]
            replier.reply("ğŸ§ª [í…ŒìŠ¤íŠ¸ 3: ìµœì¢… ê²€ì—­ì†Œ]\në‚´ í¬ì¸íŠ¸ë¥¼ ê°•ì œë¡œ 'NaN(ë¹„ìˆ«ì)'ìœ¼ë¡œ ì˜¤ì—¼ì‹œí‚¨ ë’¤ ì €ì¥ì„ ì‹œë„í•©ë‹ˆë‹¤...");
            user.point = NaN; 
            safeSaveData(data, false);
            replier.reply("ğŸ›¡ï¸ ê²°ê³¼: 'ë°ì´í„° ìê°€ ì¹˜ìœ ' ì•Œë¦¼ì´ ëœ¨ë©° íŒŒì¼ ì €ì¥ì´ ì°¨ë‹¨ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.");
        }
        
        return true;
    }

    if (msg.trim() === "/ì‹œìŠ¤í…œìê°€ë³µì›") {
        // 1. íœ˜ë°œì„± ìƒíƒœê°’ ë° í™œë™ ë½(Lock) ì¼ê´„ í•´ì œ
        lottoPurchaseState = {}; 
        sprinkleData = { active: false, winners: [] };
        activeThefts = {}; 
        duelData = {}; 
        selectWaitState = {};
        bankProcessState = {}; 
        menuWaitState = {};
        miningState = {}; // ê´‘ì‚° í™œë™ ì´ˆê¸°í™”

        // 2. UID ìºì‹œ ì´ˆê¸°í™” (ë©”ëª¨ë¦¬ ì •ë¦¬)
        if (typeof uidCache !== 'undefined') {
            for (var k in uidCache) delete uidCache[k];
        }

        // 3. ì‹œìŠ¤í…œ í•µì‹¬ ê²½ì œ ì§€í‘œ ë³µêµ¬
        if (!data.marketOpenPrice || data.marketOpenPrice <= 0) data.marketOpenPrice = 1000;
        marketOpenPrice = data.marketOpenPrice; // ì „ì—­ ë³€ìˆ˜ ë™ê¸°í™”

        // 4. ì „ ìœ ì € ë°ì´í„° ìˆ˜ì¹˜ ì •ê·œí™” ë° ë°©ë³„ ë…ë¦½ ìƒíƒœ ì´ˆê¸°í™”
        var fixCount = 0;
        for (var r in data.rooms) {
            var roomObj = data.rooms[r];
            
            // [í•µì‹¬ í•´ê²°] /ì„œë²„ì§„ë‹¨ ìˆ˜ì¹˜ì— ë°˜ì˜ë˜ëŠ” ë°©ë³„ states ì£¼ë¨¸ë‹ˆ ê°•ì œ ë¹„ìš°ê¸°
            if (roomObj.features && roomObj.features.states) {
                var st = roomObj.features.states;
                for (var sKey in st) { st[sKey] = {}; }
            }
            
            // ì¤‘ì•™ì€í–‰ ì¬ì› ëˆ„ë½ ì‹œ ë³µêµ¬
            if (roomObj.bankReserve === undefined || roomObj.bankReserve === null) {
                roomObj.bankReserve = (SYSTEM_CONFIG && SYSTEM_CONFIG.ECO.BANK.INITIAL_RESERVE) ? SYSTEM_CONFIG.ECO.BANK.INITIAL_RESERVE : 10000;
            }
            // ìœ„ê¸° ì•Œë¦¼ ìƒíƒœ ë¦¬ì…‹
            roomObj.lastBankAlert = "normal";

            for (var id in roomObj.users) {
                var u = roomObj.users[id];
                if (!u) continue;
                u.point = Math.floor(Number(u.point || 0));
                u.bank = Math.floor(Number(u.bank || 0));
                u.creditScore = Math.min(1000, Math.max(0, Number(u.creditScore || 600)));
                
                if (!u.loan) u.loan = { debt: 0, items: [] };
                if (!u.stockHoldings) u.stockHoldings = {};
                fixCount++;
            }
        }

        // 5. íŒŒì¼ ì‹œìŠ¤í…œ ë½(Lock) ê°•ì œ í•´ì œ ì‹œë„
        if (lock.isLocked()) {
            try { lock.unlock(); } catch(e) {}
        }

        safeSaveData(data);
        replier.reply(formatAdmin("âš™ï¸ ì‹œìŠ¤í…œ ìê°€ ë³µì› ì™„ë£Œ", 
            "1. ëª¨ë“  ì…ë ¥ ëŒ€ê¸° ë° í™œë™ ìƒíƒœ ì´ˆê¸°í™” (ë°©ë³„ ë…ë¦½ ìƒíƒœ í¬í•¨)\n" +
            "2. ì¤‘ì•™ì€í–‰ ì¬ì› ë° ëœë“œë§ˆí¬ ì‹œì„¸ ì§€í‘œ ë³µêµ¬\n" +
            "3. êµ­ê°€ ìœ„ê¸° ì•Œë¦¼ ì—”ì§„ ë¦¬ì…‹\n" +
            "4. ìœ ì € " + fixCount + "ëª…ì˜ ë°ì´í„° ì •ìˆ˜í™” ì™„ë£Œ"));
        return true;
    }

    /* [ì‹ ê·œ] ëª¨ë“  ëª…ë ¹ì–´ ì‘ë‹µ ë¬´ê²°ì„± ì ê²€ ë¡œì§ */
    if (msg === "/ëª…ë ¹ì–´ì ê²€") {
        var statusReport = [];
        var totalCmds = CMD_LIST.user.concat(CMD_LIST.admin);
        var brokenCount = 0;

        statusReport.push("ğŸ” [ì „ì²´ ëª…ë ¹ì–´ ì—°ê²° ìƒíƒœ ì ê²€]\n");

        for (var i = 0; i < totalCmds.length; i++) {
            var c = totalCmds[i];
            var cmdName = c.cmd;
            var funcName = c.func;
            
            // 1. ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë“±ë¡ í™•ì¸ ë° 2. í•¨ìˆ˜ ê°ì²´ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
            var isRegistered = (USER_COMMANDS[cmdName] || ADMIN_COMMANDS[cmdName]);
            var functionExists = false;
            try { functionExists = (typeof eval(funcName) === 'function'); } catch(e) {}

            if (isRegistered && functionExists) {
                // ì •ìƒì ìœ¼ë¡œ ì—°ê²°ëœ ê²½ìš° (ì¶œë ¥ ìƒëµ ê°€ëŠ¥í•˜ë‚˜ í™•ì¸ì„ ìœ„í•´ í‘œì‹œ)
                // statusReport.push("âœ… " + cmdName + " : ì •ìƒ");
            } else {
                // ì—°ê²°ì´ ëŠê²¼ê±°ë‚˜ í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ëŠ” ê²½ìš°
                var reason = !isRegistered ? "ë“±ë¡ëˆ„ë½" : "ë¡œì§ì‹¤íŒ¨";
                statusReport.push("âŒ " + cmdName + " : " + reason + " (í™•ì¸ í•„ìš”)");
                brokenCount++;
            }
        }

        if (brokenCount === 0) {
            statusReport.push("âœ… ëª¨ë“  ëª…ë ¹ì–´ì˜ ë¡œì§ ì—°ê²°ì´ ì •ìƒì…ë‹ˆë‹¤.\n(ì‘ë‹µ ë¶ˆê°€ í˜„ìƒ ì—†ìŒ)");
        } else {
            statusReport.push("\nâš ï¸ ì´ " + brokenCount + "ê°œì˜ ëª…ë ¹ì–´ê°€ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        }

        replier.reply(formatAdmin("ğŸ›°ï¸ ëª…ë ¹ì–´ ë¬´ê²°ì„± ë¦¬í¬íŠ¸", statusReport.join("\n")));
        return true;
    }

    /* [v10.0 IPM] ì§€ëŠ¥í˜• ì„œë²„ ìƒíƒœ ëŒ€ì‹œë³´ë“œ */
    if (msg === "/ì„œë²„ìƒíƒœ") {
        // 1. ìƒíƒœ ì•„ì´ì½˜ íŒë³„
        var statusIcon = (PERF_METRICS.avgLag < 200) ? "ğŸŸ¢ ì¾Œì " : (PERF_METRICS.avgLag < 450 ? "ğŸŸ¡ ë³´í†µ" : "ğŸ”´ ê³¼ë¶€í•˜");
        
        // 2. ë¡œê·¸ ìš©ëŸ‰ ê³„ì‚° (MB)
        var logFile = new java.io.File(JOURNAL_PATH);
        var logMB = (logFile.exists() ? (logFile.length() / (1024 * 1024)).toFixed(2) : "0.00");
        
        // 3. ë¦¬í¬íŠ¸ ë³¸ë¬¸ (ê´€ë¦¬ìë‹˜ ì›ë³¸ ì–‘ì‹ 100% ì ìš© ë° data ë³€ìˆ˜ ì°¸ì¡° êµì •)
        var report = "âš™ï¸ [ì‹œìŠ¤í…œ ì‹¤ì‹œê°„ ê±´ê°• ì§„ë‹¨]\n" +
                     "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                     "ğŸ“Š í¼í¬ë¨¼ìŠ¤ ìƒíƒœ: " + statusIcon + "\n" +
                     "â€¢ í‰ê·  ì‘ë‹µ: " + PERF_METRICS.avgLag + "ms\n" +
                     "â€¢ ìµœê³  ì§€ì—°: " + PERF_METRICS.peakLag + "ms\n\n" +
                     "ğŸ“‚ ìì› ì‚¬ìš©ëŸ‰\n" +
                     "â€¢ ë¸”ë™ë°•ìŠ¤ ë¡œê·¸: " + logMB + " / 1.50 MB\n" +
                     "â€¢ ë¶„ë‹¹ ì²˜ë¦¬ëŸ‰: " + PERF_METRICS.msgPerMin + " msg/min\n" +
                     "â€¢ ì‹ë³„ ìºì‹œ: " + Object.keys(data.nameToIdCache || {}).length + " ê±´\n" +
                     "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                     "ğŸ’¡ ì‹œìŠ¤í…œì´ ìŠ¤ìŠ¤ë¡œ ìµœì í™” ì¤‘ì…ë‹ˆë‹¤.";
                     
        replier.reply(formatAdmin("ì§€ëŠ¥í˜• ê°ì‹œ ì„¼í„°", report));
        return true;
    }

    /* [ê¸´ê¸‰] ì „ ì„œë²„/ì „ ìˆ˜ì¹˜(ì¶œì„, ëœë“œë§ˆí¬ í¬í•¨) ê°•ì œ ë³µêµ¬ ì—”ì§„ v7.0 */
    if (msg.startsWith("/ì „ì²´ë³µêµ¬êµ¬")) {
        var stablePath = BACKUP_DIR + "last_stable_backup.json";
        var stableFile = new java.io.File(stablePath);

        if (!stableFile.exists() || stableFile.length() === 0) {
            replier.reply(formatAdmin("ğŸš« ë³µêµ¬ ì‹¤íŒ¨", "ì•ˆì „ ë°±ì—… íŒŒì¼(last_stable_backup.json)ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."));
            return true;
        }

        try {
            var content = FileStream.read(stablePath);
            var backupObj = JSON.parse(content);

            // 1. ì‹œìŠ¤í…œ ì „ì²´ í•„ë“œ ê°•ì œ ë®ì–´ì“°ê¸° (ëœë“œë§ˆí¬ ì‹œì¥ê°€, ì­íŒŸ ë“± í¬í•¨)
            // globalDataë¥¼ ì£¼ì†Œê°’ ìì²´ë¡œ êµì²´í•˜ì—¬ ë©”ëª¨ë¦¬ ì¦‰ì‹œ ë™ê¸°í™”
            globalData = backupObj;
            globalData._isInitialized = true;

            // 2. í—¬ëŸ¬(Healer)ì˜ ì—­ê³µìŠµ ì°¨ë‹¨ì„ ìœ„í•œ ë©´ì œê¶Œ ì „ìˆ˜ ë¶€ì—¬
            for (var r in globalData.rooms) {
                var rObj = globalData.rooms[r];
                for (var uid in rObj.users) {
                    rObj.users[uid].skipHealing = true; // ë³µêµ¬ ë°ì´í„° ë³´í˜¸
                }
            }

            // 3. ë¬¼ë¦¬ íŒŒì¼ ì¦‰ì‹œ ê°•ì œ ê¸°ë¡ (ë¹„ë™ê¸° ëŒ€ê¸° ì—†ì´ ì¦‰ì‹œ ì‹¤í–‰)
            FileStream.write(FILE_PATH, JSON.stringify(globalData));
            
            // 4. ì‹ë³„ ìºì‹œ ì´ˆê¸°í™” (UID ê¼¬ì„ ë°©ì§€)
            globalData.nameToIdCache = {};

            var resBody = "âœ… ì‹œìŠ¤í…œ ì „ì²´ í•˜ë“œ ë³µêµ¬ ì™„ë£Œ\n" +
                          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                          "â€¢ ë²”ìœ„: ì¶œì„, ëœë“œë§ˆí¬ ì§€ë¶„, ì‹œì„¸, ì€í–‰ ì¬ì›\n" +
                          "â€¢ ì¡°ì¹˜: ë©”ëª¨ë¦¬ ë° ë¬¼ë¦¬ DB ì¼ì¹˜í™” ì™„ë£Œ\n" +
                          "â€¢ ì£¼ì˜: ë³µêµ¬ëœ íŒŒì¼ì´ 'ë‚ ì•„ê°€ê¸° ì „' ê²ƒì¸ì§€ í™•ì¸ìš”ë§";

            replier.reply(formatAdmin("ğŸ›°ï¸ ì„œë²„ í†µí•© ë³µêµ¬ ë³´ê³ ", resBody));
            Log.info("[Emergency] ì‹œìŠ¤í…œ ì „ì²´ ë³µêµ¬ê°€ ê´€ë¦¬ìì— ì˜í•´ ìŠ¹ì¸ ë° ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");

        } catch (e) {
            Log.error("Full Restore Logic Crash: " + e);
            replier.reply(formatAdmin("ğŸš« ë³µêµ¬ ì¤‘ë‹¨", "ë°ì´í„° ì—”ì§„ ê²°í•¨: " + e.message));
        }
        return true;
    }

    /* [ê¸´ê¸‰] ì§€ëŠ¥í˜• ì „ì²´ ë°ì´í„° ë³µêµ¬ (Smart Restore v5.9+) */
    if (msg.startsWith("/ì „ì²´ë³µì›")) {
Â  Â  Â  Â  var stablePath = BACKUP_DIR + "last_stable_backup.json";
Â  Â  Â  Â  var stableFile = new java.io.File(stablePath);

Â  Â  Â  Â  if (!stableFile.exists() || stableFile.length() === 0) {
Â  Â  Â  Â  Â  Â  replier.reply(formatAdmin("ğŸš« ë³µêµ¬ ì‹¤íŒ¨", "ì•ˆì „ ë°±ì—… íŒŒì¼(last_stable_backup.json)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
Â  Â  Â  Â  Â  Â  return true;
Â  Â  Â  Â  }

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  var content = FileStream.read(stablePath);
Â  Â  Â  Â  Â  Â  if (!content) throw new Error("íŒŒì¼ ë‚´ìš©ì´ ë¹„ì–´ìˆìŒ");

Â  Â  Â  Â  Â  Â  // 1. ë©”ëª¨ë¦¬ êµì²´ ë° ë©”ì¸ íŒŒì¼ ë¬¼ë¦¬ì  ë™ê¸°í™”
Â  Â  Â  Â  Â  Â  var backupObj = JSON.parse(content);
Â  Â  Â  Â  Â  Â  globalData = backupObj;
Â  Â  Â  Â  Â  Â  FileStream.write(FILE_PATH, content);

Â  Â  Â  Â  Â  Â  // 2. [í•µì‹¬] ì‹¤ì‹œê°„ ë¸”ë™ë°•ìŠ¤(Journal) ë³‘í•©
Â  Â  Â  Â  Â  Â  // ë°±ì—… ì‹œì  ì´í›„ë¶€í„° í˜„ì¬ê¹Œì§€ ë°œìƒí•œ ëª¨ë“  í¬ì¸íŠ¸ ë³€ë™ì„ ì†Œê¸‰ ì ìš©í•©ë‹ˆë‹¤.
Â  Â  Â  Â  Â  Â  if (typeof recoverFromJournal === 'function') {
Â  Â  Â  Â  Â  Â  Â  Â  recoverFromJournal(globalData);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // 3. ìµœì¢… ì •í™”ëœ ë°ì´í„°ë¥¼ ì„¸ì…˜ì— ë°˜ì˜í•˜ê³  ì¦‰ì‹œ ì €ì¥
Â  Â  Â  Â  Â  Â  safeSaveData(globalData, false);

Â  Â  Â  Â  Â  Â  var resBody = "âœ… ì§€ëŠ¥í˜• ë°ì´í„° ë³µêµ¬ ì™„ë£Œ\n" +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "â€¢ ì†ŒìŠ¤: last_stable_backup.json\n" +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "â€¢ ë³‘í•©: ì‹¤ì‹œê°„ ë¸”ë™ë°•ìŠ¤ ë¡œê·¸ í†µí•©\n" +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "â€¢ ìƒíƒœ: ì˜¤ì—¼ ë°ì´í„° ì •í™” ì„±ê³µ";

Â  Â  Â  Â  Â  Â  replier.reply(formatAdmin("ğŸ› ï¸ ì‹œìŠ¤í…œ ë³µêµ¬ ë³´ê³ ", resBody));

Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Log.error("Restore Logic Crash: " + e);
Â  Â  Â  Â  Â  Â  replier.reply(formatAdmin("ğŸš« ë³µêµ¬ ì¤‘ë‹¨", "ë°ì´í„° íŒŒì‹± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì‚¬ìœ : " + e.message));
Â  Â  Â  Â  }
Â  Â  Â  Â  return true;
Â  Â  }

    return false;
}

//==========ì„¹í„°37==========

/**
 * [ê²Œì„ ëª…ë ¹ì–´ ë¶„ë°°ê¸°] (Game Logic Dispatcher - Registry Refactored)
 * ì„¤ëª…: ìœ ì €ë“¤ì˜ ê²Œì„/ê²½ì œ í™œë™ ëª…ë ¹ì–´ë¥¼ ê° ì „ë¬¸ ë‹´ë‹¹ í•¨ìˆ˜ë¡œ ì—°ê²°í•©ë‹ˆë‹¤.
 * ì„¹í„° 1ì˜ USER_COMMANDS ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¥¼ ì°¸ì¡°í•˜ì—¬ ë“±ë¡ëœ ë¡œì§ì„ ìë™ìœ¼ë¡œ ë§¤í•‘ ë° ì‹¤í–‰í•©ë‹ˆë‹¤.
 */
function _handleGameLogic(msg, user, data, replier, roomName, targetUid, sender) {
    var roomData = data.rooms[roomName];
    if (!roomData || !roomData.features || !roomData.features.states) return false;
    var duelData = roomData.features.states.duelData || {};
    
    // 1. ëª…ë ¹ì–´ ì²« ë‹¨ì–´ ì¶”ì¶œ
    var cmd = msg.split(" ")[0];

    // [ê°€ìƒ ì •ë¶€ ì‹œìŠ¤í…œ] ì •ì±… ë° íˆ¬í‘œ ëª…ë ¹ì–´ ë¶„ê¸° ì²˜ë¦¬
    if (cmd === "/ì˜íšŒ" || cmd === "/íˆ¬í‘œ") {
        if (typeof _gameGovernmentLogic === 'function') {
            return _gameGovernmentLogic(msg, user, data, replier, roomName, targetUid);
        }
    }

    // 2. ìœ ì € ëª…ë ¹ì–´ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ê²€ìƒ‰
    if (USER_COMMANDS[cmd] && typeof USER_COMMANDS[cmd].execute === 'function') {
        
        // [ê²°íˆ¬ í‚¤ì›Œë“œ ê°€ë“œ] localized duelData ì‚¬ìš©
        if (cmd === "ìˆ˜ë½" || cmd === "ê±°ì ˆ" || cmd === "ì·¨ì†Œ") {
            var hasDuel = false;
            if (duelData[targetUid]) hasDuel = true;
            else {
                for (var d in duelData) {
                    if (duelData[d].challengerUid === targetUid) { hasDuel = true; break; }
                }
            }
            if (!hasDuel) return false;
        }
        
        // 3. ê²€ì¦ëœ ëª…ë ¹ì–´ë§Œ í•˜ìœ„ ë¡œì§ í•¨ìˆ˜(ì„¹í„° 40~44 ë“±)ë¡œ ì‹¤í–‰ ìœ„ì„
        return USER_COMMANDS[cmd].execute(msg, user, data, replier, roomName, targetUid);
    }

    // 4. ë“±ë¡ë˜ì§€ ì•Šì€ ëª…ë ¹ì–´ì´ê±°ë‚˜ ì²˜ë¦¬í•  ë¡œì§ì´ ì—†ëŠ” ê²½ìš° false ë°˜í™˜
    return false;
}

//==========ì„¹í„°38==========

/**
 * [ê²Œì„ í•˜ìœ„ ëª¨ë“ˆ 1] ì€í–‰ ë° ì‚¬ì±„ ê´€ë¦¬
 * ê¸°ëŠ¥: ì€í–‰ ë©”ë‰´ í˜¸ì¶œ, ëŒ€ì¶œê¸ˆ ì§ì ‘ ìƒí™˜
 * ì„¤ëª…: ë©”ë‰´ UIì— ê¸°ë¶€ í•­ëª©ì„ ì¶”ê°€í•˜ê³ , ìƒí™˜ ì‹œ ì¤‘ì•™ì€í–‰ ì¬ê³ ë¡œ í™˜ìˆ˜ë˜ë„ë¡ ì—°ë™í•¨.
 */
function _gameBankLogic(msg, user, data, replier, roomName, targetUid) {
    // 1. ê¸°ì´ˆ ë°ì´í„° ë° ê²½ì œ êµ¬ì—­ ì„ ì–¸ (ì°¸ì¡° ì˜¤ë¥˜ ë°©ì§€ í•µì‹¬)
    var currentRoom = data.rooms[roomName]; 
    var economyRoomName = (ALLOWED_ROOMS.indexOf(roomName) === -1) ? "ë‚´ë¦¬ë‹¤" : roomName;
    var economyRoomData = data.rooms[economyRoomName];

    // 2. í•˜ë‹¨ ë¡œì§ í˜¸í™˜ì„±ì„ ìœ„í•´ roomData ì •ì˜ (1:1ë°©ì´ë©´ ë©”ì¸ë°© ë°ì´í„°ë¥¼ ì°¸ì¡°)
    var roomData = (ALLOWED_ROOMS.indexOf(roomName) === -1) ? economyRoomData : currentRoom;

    // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì¤‘ë‹¨ (ì¥ì•  ë°©ì§€)
    if (!roomData || !roomData.features) return false;

    // 3. ì„¸ì…˜ ì €ì¥ì†Œ(States) ì´ˆê¸°í™”
    if (!currentRoom.features) {
        if (typeof ROOM_FEATURE_TEMPLATE === 'function') currentRoom.features = ROOM_FEATURE_TEMPLATE();
        else currentRoom.features = { states: { menuWait: {}, bankProcess: {} } };
    }
    
    var menuWaitState = currentRoom.features.states.menuWait;
    var bankProcessState = currentRoom.features.states.bankProcess;

    /* [ê¸°ëŠ¥ 1] ì€í–‰ ì‹œìŠ¤í…œ ì§„ì… (v5.2 ê¸°ë¶€ ë©”ë‰´ ì¶”ê°€) */
    if (msg === "/ì€í–‰") {
        var crTargetRoom = (ALLOWED_ROOMS.indexOf(roomName) === -1) ? "ë‚´ë¦¬ë‹¤" : roomName;
Â  Â  Â  Â  var cr = getCreditInfo(user.creditScore, crTargetRoom);
        
        menuWaitState[targetUid] = { type: 'bank_menu', time: Date.now(), originRoom: roomName };

        var bankMenu = "1. ğŸ’° ì˜ˆê¸ˆ (í¬ì¸íŠ¸ â” ì€í–‰)\n" +
                       "2. ğŸ§ ì¶œê¸ˆ (ì€í–‰ â” í¬ì¸íŠ¸)\n" +
                       "3. ğŸ’¸ ì†¡ê¸ˆ (íƒ€ì¸ì—ê²Œ ì´ì²´)\n" +
                       "4. ğŸ¦ ëŒ€ì¶œ (í•œë„: " + fp(cr.limit) + "P)\n" + // ë©”ë‰´ì— ì‹¤ì‹œê°„ í•œë„ ì§ì ‘ í‘œì‹œ
                       "5. ğŸ“‰ ìƒí™˜ (ëŒ€ì¶œê¸ˆ ê°šê¸°)\n" +
                       "6. " + (SYSTEM_CONFIG.MSG.PREFIX.LOAN || "ğŸš¬") + " ì‚¬ì±„ ì‹œì¥ (P2P ëŒ€ì¶œ)\n" +
                       "7. ğŸ ê¸°ë¶€ (êµ­ê³  í›„ì›)";
        
        var myPoint = Number(user.point || 0);
        var myBank = Number(user.bank || 0);
        
        var donationLine = (Number(user.totalDonation || 0) > 0) ? "ğŸ ëˆ„ì  ê¸°ë¶€: " + fp(user.totalDonation) + "P\n" : "";

        var content = bankMenu + "\n\n" +
               donationLine +
               "ğŸ¦ ì€í–‰ ì”ê³  : " + fp(roomData.bankReserve) + "P\n\n" +
               "ë³´ìœ : " + fp(myPoint) + "P / ì˜ˆê¸ˆ: " + fp(myBank) + "P\n" +
               "(ë²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”)";

        // formatCommandë¥¼ í˜¸ì¶œí•˜ì—¬ ìµœì¢… ë©”ì‹œì§€ ì¡°ë¦½
        replier.reply(formatCommand("ğŸ¦ ì€í–‰ ì—…ë¬´ ì„ íƒ", user, content, "ì…ë ¥ ëŒ€ê¸°: 30ì´ˆ"));
        return true;
    }

    /* [ê¸°ëŠ¥ 2] ëŒ€ì¶œê¸ˆ ìƒí™˜ (ì§ì ‘ ëª…ë ¹ì–´) */
    if (msg.indexOf("/ìƒí™˜ ") === 0) {
        var myDebt = (user.loan && user.loan.debt) ? Number(user.loan.debt) : 0;
        if (myDebt <= 0) { 
            replier.reply(formatError(user, "ìƒí™˜ ë¶ˆê°€", "ê°šì•„ì•¼ í•  ì€í–‰ ëŒ€ì¶œê¸ˆì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")); 
            return true; 
        }

        var parts = msg.split(" ");
        // ì‰¼í‘œê°€ í¬í•¨ëœ ì…ë ¥ë„ ì²˜ë¦¬ ê°€ëŠ¥í•˜ë„ë¡ ê°œì„ 
        var amt = parseInt(parts[1].replace(/,/g, "")); 
        
        if (isNaN(amt) || amt <= 0) { 
            replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜", "ì •í™•í•œ ìƒí™˜ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.")); 
            return true; 
        }
        
        var myPoint = Number(user.point || 0);
        if (myPoint < amt) { 
            replier.reply(formatError(user, "í¬ì¸íŠ¸ ë¶€ì¡±", "ë³´ìœ  í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.")); 
            return true; 
        }
        
        // ë¶„ì‚° ìƒí™˜ ë¡œì§ í˜¸ì¶œ (ì„¹í„° 13 ì •ì˜) - ë©”ì¸ ë°© ê¸°ì¤€ìœ¼ë¡œ ì‹ ìš©ì ìˆ˜ ê³„ì‚°
        var targetRoomName = (ALLOWED_ROOMS.indexOf(roomName) === -1) ? "ë‚´ë¦¬ë‹¤" : roomName;
Â  Â  Â  Â  var res = distributeRepayment(user, amt, targetRoomName);
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* [ì¤‘ì•™ì€í–‰ ì—°ë™] í†µí•© í¬ì¸íŠ¸ í•¨ìˆ˜ ì‚¬ìš© */
Â  Â  Â  Â  // ìœ ì € í¬ì¸íŠ¸ ì°¨ê°ê³¼ ë™ì‹œì— ì°¨ê°ëœ ê¸ˆì•¡(res.actualRepay)ì´ bankReserveì— ìë™ ì…ê¸ˆë¨.
        // ë¡œê·¸ ê¸°ë¡ ì‹œ 1:1 ë°© ì´ë¦„ì´ ì•„ë‹Œ ì‹¤ì œ ë©”ì¸ ë°© ì´ë¦„ìœ¼ë¡œ ê¸°ë¡ë˜ê²Œ í•¨
Â  Â  Â  Â  util_updatePoint(user, roomData, -Number(res.actualRepay), "ëŒ€ì¶œ ìƒí™˜", targetRoomName);
        
        var remainingDebt = (user.loan && user.loan.debt) ? Number(user.loan.debt) : 0;
        replier.reply(formatCommand("ğŸ“‰ ìƒí™˜ ì™„ë£Œ", user, fp(res.actualRepay) + "P ìƒí™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\n(ì‹ ìš© ì ìˆ˜ +" + res.creditGain + ")", "ë‚¨ì€ ëŒ€ì¶œ: " + fp(remainingDebt) + "P / ì”ì•¡: " + fp(user.point) + "P"));
        
        safeSaveData(data);
        return true;
    }

    return false;
}

//==========ì„¹í„°39==========

/**
 * [ê²Œì„ í•˜ìœ„ ëª¨ë“ˆ 2] ì •ë³´ ë° ë­í‚¹ ì¡°íšŒ (UI ìµœì í™” ë° ì¶œì„ ìƒíƒœ ì¶”ê°€)
 * ê¸°ëŠ¥: ë‚´ì •ë³´, ìœ ë¬¼ë„ê°, ì‹ ìš©ë“±ê¸‰, ëŒ€ì¶œí•œë„, ëª…ì˜ˆì˜ì „ë‹¹, ìˆœìœ„, ìœ ì €ì •ë³´, ê²½ë§ˆì¡°íšŒ
 * ìˆ˜ì • ì‚¬í•­: ë„êµ´ì™• ë‹¬ì„± ì‹œ íŠ¹ë³„ ì¶•í•˜ ë©˜íŠ¸ ì ìš© ë° ìœ ë¬¼ ë„ê° UI ìµœì¢… ìµœì í™”
 */
function _gameInfoLogic(msg, user, data, replier, roomName, targetUid) {
    // [1:1 ì—°ë™ í•µì‹¬] ë°ì´í„° ì†ŒìŠ¤ ë¦¬ë‹¤ì´ë ‰íŠ¸
    var targetRoomData = null;
    if (ALLOWED_ROOMS.indexOf(roomName) === -1) {
        var linkedRoom = data.rooms["ë‚´ë¦¬ë‹¤"];
        if (linkedRoom) {
            targetRoomData = linkedRoom;
        } else {
            return false;
        }
    } else {
        targetRoomData = data.rooms[roomName];
    }
    
    var roomData = targetRoomData; // ë³€ìˆ˜ëª… í†µì¼

    // 1. ë°© ë°ì´í„° ë° ê¸°ëŠ¥ í…œí”Œë¦¿ ì¡´ì¬ ì—¬ë¶€ ì²´í¬ (ì•ˆì „ ê°€ë“œ)
    if (!roomData || !roomData.features) return false;

    // 2. [í•µì‹¬ ê³ ì •] ì „ì—­ ë³€ìˆ˜ê°€ ì•„ë‹Œ ì´ í•¨ìˆ˜ ì „ìš© ì§€ì—­ ë³€ìˆ˜ë¡œ ë°ì´í„° ì—°ê²°
    // ì´ ì½”ë“œê°€ ìˆì–´ì•¼ /ê²½ë§ˆ, /ë¡œë˜ ë“±ì˜ ëª…ë ¹ì–´ê°€ ë¨¹í†µì´ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    var racingData = roomData.features.racing;
    var rConf = (SYSTEM_CONFIG.ECO && SYSTEM_CONFIG.ECO.RACING) ? SYSTEM_CONFIG.ECO.RACING : (SYSTEM_CONFIG.RACING || {});
    
    // ë§Œì•½ ìƒìˆ˜ê°€ ì•„ì˜ˆ ë¡œë“œë˜ì§€ ì•Šì•˜ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ìµœì†Œí•œì˜ ê¸°ë³¸ê°’ ë³´ì •
    if (!rConf.MIN_BET) {
        rConf.MIN_BET = 10000;
        rConf.MAX_BET = 30000;
        rConf.TAX_RATE = 0.1;
        rConf.CANCEL_FEE = 0.1;
    }

    /* [Gemini ìš”ì²­ ì‚¬í•­] ê²½ë§ˆ ì •ë³´ ì‹¤ì‹œê°„ ë¸Œë¦¬í•‘ ê¸°ëŠ¥ í†µí•© (ë‚´ ë°°íŒ… ì •ë³´ í¬í•¨) */
    if (msg === "/ê²½ë§ˆ") {
        if (!racingData.isOperating) {
            replier.reply(formatSimple("ğŸ‡ ê²½ë§ˆì¥ íœ´ì¥ ì•ˆë‚´", "í˜„ì¬ ê²½ë§ˆ ìš´ì˜ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤.\n(ìš´ì˜ì‹œê°„: 09:00 ~ 23:59)", "ì˜¤ì „ 9ì‹œ ì •ê°ì— ê°œì¥í•©ë‹ˆë‹¤."));
            return true;
        }

        var hList = racingData.horses.map(function(h) {
            var horseBetSum = 0;
            for (var uid in racingData.bets) {
                if (racingData.bets[uid].horseId === h.id) horseBetSum += Number(racingData.bets[uid].amount);
            }
            return h.id + ". " + h.name + " [" + h.icon + "]\n    â”” í˜„ ë°°íŒ…ì•¡: " + fp(horseBetSum) + "P";
        }).join("\n");

        var now = new Date();
        var nowMin = now.getMinutes();
        var remainMin = 49 - nowMin;
        var remainSec = 59 - now.getSeconds();
        if (remainMin < 0) { remainMin = 0; remainSec = 0; }

        var myBet = racingData.bets[targetUid];
        var myBetInfo = "";
        if (myBet) {
            var myHorse = racingData.horses[myBet.horseId - 1]; 
            myBetInfo = "ğŸ‘¤ ë‚´ ë°°íŒ…: " + myBet.horseId + "ë²ˆ " + myHorse.name + " (" + fp(myBet.amount) + "P)";
        } else {
            myBetInfo = "ğŸ‘¤ ë‚´ ë°°íŒ…: ì°¸ì—¬ ë‚´ì—­ ì—†ìŒ";
        }

        var raceHeader = (nowMin >= 50) ? "ğŸ ë°°íŒ… ë§ˆê° ë° ì •ì‚° ì¤‘" : "ì œ " + racingData.round + "íšŒì°¨ ê²½ê¸° ë°°íŒ… ì§„í–‰ ì¤‘";
        var totalPrizePool = racingData.totalPool + racingData.carryOver;
        var racingBody = raceHeader + "\n\n" +
                         "[ğŸ‡ ì¶œì „ë§ˆ ë¼ì¸ì—…]\n" + hList + "\n\n" +
                         myBetInfo + "\n" +
                         "ğŸ’° í˜„ì¬ ì´ ë°°ë‹¹ê¸ˆ: " + fp(totalPrizePool) + "P\n" +
                         (racingData.carryOver > 0 ? "âœ¨ ì´ì›” ì ë¦½ê¸ˆ: " + fp(racingData.carryOver) + "P í¬í•¨\n" : "") +
                         "ğŸ•’ ë°°íŒ… ë§ˆê°: " + remainMin + "ë¶„ " + remainSec + "ì´ˆ ë‚¨ìŒ";

        replier.reply(formatCommand("ğŸ‡ ë‚´ë¦¬ë‹¤ ì¤‘ì•™ ê²½ë§ˆì¥", user, racingBody, "ë°°íŒ…: [/ë°°íŒ… ë²ˆí˜¸ ê¸ˆì•¡]"));
        return true;
    }

    /* [ì‹ ê·œ] ë´‡ ì‘ë‹µ ì†ë„ ì²´í¬ */
Â  Â  if (msg === "/í•‘") {
Â  Â  Â  Â  var ping = Date.now() - _msgReceiveTime;
Â  Â  Â  Â  var status = ping < 150 ? "ğŸš€ ë§¤ìš° ì¾Œì " : (ping < 400 ? "ğŸŸ¢ ì–‘í˜¸" : (ping < 800 ? "ğŸŸ¡ ì§€ì—°" : "ğŸ”´ ê³¼ë¶€í•˜"));
Â  Â  Â  Â  replier.reply(formatSimple("ğŸ“ í! (Pong)", "â±ï¸ ì‘ë‹µ ì†ë„: " + ping + "ms\nğŸ“Š í˜„ì¬ ìƒíƒœ: " + status, "ì„œë²„ì˜ ì²˜ë¦¬ ì§€ì—° ì‹œê°„ì„ ì¸¡ì •í•©ë‹ˆë‹¤."));
Â  Â  Â  Â  return true;
Â  Â  }

    /* [ê¸°ëŠ¥ 3] ë‚´ ì •ë³´ ì¡°íšŒ */
    if (msg === "/ë‚´ì •ë³´") {
        var crTargetRoom = (ALLOWED_ROOMS.indexOf(roomName) === -1) ? "ë‚´ë¦¬ë‹¤" : roomName;
Â  Â  Â  Â  var cr = getCreditInfo(user.creditScore, crTargetRoom);
        var authInfo = "ğŸ® ê²Œì„ ì¸ì¦: " + (user.gameAuthCount || 0) + "/2 (ì‹œì¦Œ)";
        
        var bankDebt = (user.loan && user.loan.debt) ? Math.floor(Number(user.loan.debt)) : 0;
        var sacheDebt = 0;
        var sacheClaims = 0; 
        var overdueSache = 0;

        if (roomData && roomData.loanContracts) {
            for (var cid in roomData.loanContracts) {
                var c = roomData.loanContracts[cid];
                if (c.borrowerUid === targetUid) {
                    sacheDebt += Math.floor(c.currentDebt);
                    if (c.status === 'overdue') overdueSache += Math.floor(c.currentDebt);
                }
                if (c.lenderUid === targetUid) {
                    sacheClaims += Math.floor(c.currentDebt);
                }
            }
        }

        var todayStr = getSimpleDate();
        var attendMark = (user.lastDate === todayStr) ? " (âœ…)" : " (â³)";
        var totalPromotion = (Number(user.dailyPromotionAttempts) || 0) + (Number(user.purchasedPromotionAttempts) || 0);

        var currentAccrued = Number(user.accruedInterest || 0);
        if (user.lastBankUpdateTime > 0 && Number(user.bank) > 0) {
            var passed = Date.now() - user.lastBankUpdateTime;
            currentAccrued += Number(user.bank) * SYSTEM_CONFIG.ECO.BANK.INTEREST_RATE * (passed / 86400000);
        }

        var infoBody = authInfo + "\n" +
                       "ğŸ’° ë³´ìœ  í¬ì¸íŠ¸: " + fp(user.point) + "P\n" +
                       "ğŸ¦ ì˜ˆê¸ˆ: " + fp(user.bank) + "P\n" +
                       "ğŸ§§ ì§€ê¸‰ ì˜ˆì • ì´ì: " + fp(Math.floor(currentAccrued)) + "P\n" +
                       (sacheClaims >= 1 ? "ğŸ¤ ë¯¸ìˆ˜ ì±„ê¶Œ: " + fp(sacheClaims) + "P\n" : "") +
                       "ğŸ’³ ì‹ ìš© ë“±ê¸‰: " + cr.label + " (" + user.creditScore + "ì )\n" +
                       "ğŸ… í˜„ì¬ í‹°ì–´: " + (TIERS[user.tier] || "ì•„ì´ì–¸") + "\n" +
                       "ğŸ“… ëˆ„ì  ì¶œì„: " + (user.totalAttendance || 0) + "ì¼" + attendMark + "\n" +
                       "ğŸ”‚ ìŠ¹ê¸‰ ê¸°íšŒ: " + totalPromotion + "íšŒ";
        
        if (bankDebt > 0) {
            var transferTag = user.isTransferred ? " (ğŸš¨ëŒ€í™˜ ì±„ë¬´: 70% ê°•ì œìƒí™˜)" : "";
            infoBody += "\nğŸ¦ ë¯¸ìƒí™˜ ëŒ€ì¶œ: " + fp(bankDebt) + "P" + transferTag;
        }

        if (sacheDebt > 0) {
            infoBody += "\nğŸš¬ ë¯¸ìƒí™˜ ì‚¬ì±„: " + fp(sacheDebt) + "P";
            if (overdueSache > 0) infoBody += "\nğŸš¨ ì‚¬ì±„ ì—°ì²´: " + fp(overdueSache) + "P (50% ìë™ìƒí™˜)";
        }
        
        replier.reply(formatCommand("ğŸ“Œ ë‚´ ìƒì„¸ ì •ë³´", user, infoBody, "ì•„ì´í…œ êµ¬ë§¤: [/ìƒì ]")); 
        return true;
    }

        /* [v16.7] ìœ ë¬¼ ë„ê° ì¡°íšŒ ë° ì œì‘ ì„¸ì…˜ í™œì„±í™” (ì œì‘ ëª…ë ¹ì–´ ì œê±°ë³¸) */
    if (msg === "/ìœ ë¬¼ë„ê°") {
        var pieces = Number(user.artifactPieces || 0);
        var maps = Number(user.ancientMaps || 0);
        
        // 1. ë„êµ´ì™• ì¹­í˜¸ íšë“ ì—¬ë¶€ ì„ ì œ íŒì • (ì¸ë²¤í† ë¦¬ ì „ìˆ˜ ì¡°ì‚¬)
        var hasDugKing = (user.inventory || []).some(function(it) { 
            return it.effect === "title" && it.title === "ë„êµ´ì™•"; 
        });

        // 2. ì„¸ì…˜ í™œì„±í™”: ì´ì œë¶€í„° ì…ë ¥ë˜ëŠ” "ì œì‘" í‚¤ì›Œë“œëŠ” ì„¹í„° 23-4ì—ì„œ ì²˜ë¦¬ë©ë‹ˆë‹¤.
        var logicRoom = (ALLOWED_ROOMS.indexOf(roomName) === -1) ? "ë‚´ë¦¬ë‹¤" : roomName;
        var menuWaitState = data.rooms[logicRoom].features.states.menuWait;
        menuWaitState[targetUid] = { 
            type: 'artifact_book', 
            time: Date.now(), 
            originRoom: roomName 
        };

        // 3. ê°€ë³€í˜• ë„ê° ìˆ˜ì§‘ í˜„í™© ê³„ì‚°
        var targetGoal = 10;
        var nextTitle = "ë„êµ´ê¾¼";
        if (pieces >= 50 || hasDugKing) { targetGoal = 50; nextTitle = "ë„êµ´ì™• âšœï¸"; }
        else if (pieces >= 40) { targetGoal = 50; nextTitle = "ë„êµ´ì™• âšœï¸"; }
        else if (pieces >= 30) { targetGoal = 40; nextTitle = "íŠ¸ë ˆì €í—Œí„°"; }
        else if (pieces >= 20) { targetGoal = 30; nextTitle = "ë°œêµ´ê°€"; }
        else if (pieces >= 10) { targetGoal = 20; nextTitle = "íƒì‚¬ì›"; }

        var statusTxt = (pieces >= 50 || hasDugKing) ? "ì „ì„¤ ë“±ê·¹!" : "ì§„í–‰ ì¤‘...";
        
        var statusContent = "âœ¨ ìœ ë¬¼ ì¡°ê° í˜„í™©\n" +
                            "ğŸ§© ë³´ìœ  ì¡°ê°: " + pieces + " / " + targetGoal + " ê°œ\n" +
                            "ğŸ“Š ìƒíƒœ: " + statusTxt + "\n" +
                            "ğŸ–ï¸ ëª©í‘œ ì¹­í˜¸: [" + nextTitle + "]\n\n" +
                            "ğŸ—ºï¸ ê³ ëŒ€ ì§€ë„: " + maps + " / 10 ì¥ ë³´ìœ \n" +
                            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                            "ğŸ’ [ì§€ë„ ì œì‘ ì„¼í„°]\n" +
                            "â€¢ ì¡°ê° 10ê°œ â” ê³ ëŒ€ ì§€ë„ 1ì¥\n" +
                            "â€¢ ì…ë ¥: [ì œì‘]";

        // 4. ê°€ì´ë“œ ë©”ì‹œì§€ (ë¯¸íšë“ ê¸°ì¤€ ê²½ê³  ì ìš©)
        var guideText = hasDugKing 
            ? "ì§€ë„ 10ì¥ì„ ëª¨ì•„ 'ì—˜ë„ë¼ë„' í•­ë¡œë¥¼ ê°œë°©í•˜ì„¸ìš”!" 
            : "âš ï¸ [ì£¼ì˜]: ë„êµ´ì™• ì¹­í˜¸ ë¯¸íšë“ ì‹œ ì§€ë„ ì œì‘ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.";

        replier.reply(formatCommand("ğŸº ìœ ë¬¼ ë„ê° ë° ì§€ë„ì‹¤", user, statusContent, guideText));
        return true;
    }

    /* [ê¸°ëŠ¥ 4] ì‹ ìš© ë“±ê¸‰ ë° ëŒ€ì¶œ í•œë„ ì¡°íšŒ */
    if (msg === "/ì‹ ìš©ë“±ê¸‰" || msg === "/ëŒ€ì¶œí•œë„") {
        // 1. ì„¹í„° 10ì˜ í†µí•© ì—”ì§„ í˜¸ì¶œ (ì´ë¯¸ ìŠ¹ìˆ˜ì™€ ì‹ ë¶ˆìê°€ ê³„ì‚°ë˜ì–´ ìˆìŒ)
        // [ìˆ˜ì •] ê°•ì œë¡œ 'ë‚´ë¦¬ë‹¤' ë°© ê¸°ì¤€ ê³„ì‚°
        var targetRoomName = (ALLOWED_ROOMS.indexOf(roomName) === -1) ? "ë‚´ë¦¬ë‹¤" : roomName;
Â  Â  Â  Â  var limitTable = getCreditLimitTable(targetRoomName);
Â  Â  Â  Â  var cr = getCreditInfo(user.creditScore, targetRoomName);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 2. í˜„ì¬ ì‹œì¥ ìŠ¹ìˆ˜ í™•ì¸ (ë©”ì‹œì§€ ìƒë‹¨ ìƒíƒœ í‘œì‹œìš©)
Â  Â  Â  Â  var dynMult = 1.0;
Â  Â  Â  Â  if (typeof util_getDynamicRateMultiplier === 'function') {
Â  Â  Â  Â  Â  Â  dynMult = util_getDynamicRateMultiplier(targetRoomName);
Â  Â  Â  Â  }

        // 3. ì‹œì¥ ìƒí™© í…ìŠ¤íŠ¸ íŒë³„
        var marketStatus = "ğŸŸ¢ ê²½ì œ ì•ˆì •";
        if (dynMult > 1.2) marketStatus = "ğŸš¨ êµ­ê³  ìœ„ê¸° (ê³ ê¸ˆë¦¬)";
        else if (dynMult < 0.8) marketStatus = "âœ… ìœ ë™ì„± í’ë¶€ (ì €ê¸ˆë¦¬)";

        // 4. ìµœì¢… ë©”ì‹œì§€ ì¡°ë¦½ (ì¤‘ë³µ ë£¨í”„ ì œê±°)
        var creditPolicy = "\n\n[ğŸ“Š ì‹ ìš© ë³€ë™ ìˆ˜ì¹˜]\n" +
                           "â€¢ ëŒ€ì¶œì‹¤í–‰: -100ì  | ìƒí™˜: +80ì \n" +
                           "â€¢ ëŒ€í™˜ì§‘í–‰: -120ì  | íšŒë³µì œ: +20ì \n" +
                           "â€¢ ê¸°ë¶€: 10,000Pë‹¹ +10ì \n\n" +
                           "[ğŸš¢ ë“±ê¸‰ë³„ ë¬´ì—­ ìˆ˜ìµ ë°°ìœ¨]\n" +
                           "â€¢ 1ë“±ê¸‰: 90% | 2ë“±ê¸‰: 85% | 3ë“±ê¸‰: 80%\n" +
                           "â€¢ 4ë“±ê¸‰: 75% | 5ë“±ê¸‰: 70% | ì‹ ë¶ˆì: 60%";

        var header = "ğŸŒ ì‹œì¥ ìƒí™©: " + marketStatus + " (x" + dynMult.toFixed(2) + ")\n\n" +
                     limitTable + 
                     creditPolicy;

        var myAppliedRate = ((cr.rate - 1) * 100 * dynMult).toFixed(1);
        var myCredit = "\n\n[ë‚´ ì‹¤ì‹œê°„ ì ìš© ìƒíƒœ]\n" +
                       "â€¢ ì‹ ìš©ì ìˆ˜: " + user.creditScore + "ì  (" + cr.label + ")\n" +
                       "â€¢ ì ìš©ì´ìœ¨: " + myAppliedRate + "%\n" +
                       "â€¢ ê°€ëŠ¥ì•¡ìˆ˜: " + fp(cr.limit) + "P";

        replier.reply(formatCommand("ğŸ’³ ì‹ ìš© ë“±ê¸‰ ë° ì‹¤ì‹œê°„ í•œë„", user, header + myCredit, "ëŒ€ì¶œ ì‹¤í–‰: [/ì€í–‰]"));
        return true;
    }

    /* [ê¸°ëŠ¥ 5] ëª…ì˜ˆì˜ ì „ë‹¹ */
    if (msg === "/ëª…ì˜ˆì˜ì „ë‹¹") {

        var targetZone = (roomName === "ë² ë¦­ë°©" || ALLOWED_ROOMS.indexOf(roomName) === -1) ? "ë‚´ë¦¬ë‹¤" : roomName;
        var targetRoomData = data.rooms[targetZone];

        var challengers = [];
        var roomUsers = roomData.users;
        for (var id in roomUsers) {
            var u = roomUsers[id];
            if (u && u.tier === 9) {
                var count = Math.max(1, u.challengerCount || 0);
                challengers.push("ğŸ† " + u.name + " (ëˆ„ì  " + count + "íšŒ)");
            }
        }
        var content = challengers.length > 0 ? challengers.join("\n") : "í˜„ì¬ ì´ ë°©ì— ë“±ë¡ëœ ì±Œë¦°ì €ê°€ ì—†ìŠµë‹ˆë‹¤.";
        replier.reply(formatSimple("ğŸ… ëª…ì˜ˆì˜ ì „ë‹¹", content, "ìµœê³  í‹°ì–´ ë‹¬ì„± ì‹œ ë“±ë¡ë©ë‹ˆë‹¤."));
        return true;
    }

    /* [ê¸°ëŠ¥ 5-1] ê³„ì • í™•ì¸ ë° ì—°ë™ */
    // [ê¸°ëŠ¥ 1] ë‚´ ê³ ìœ  ë³µêµ¬ ì½”ë“œ í™•ì¸
    if (msg === "/ì½”ë“œí™•ì¸") {
        var codeMsg = "ë‹¹ì‹ ì˜ ê³ ìœ  ë³µêµ¬ ì½”ë“œì…ë‹ˆë‹¤.\në‹‰ë„¤ì„ê³¼ í”„ì‚¬ë¥¼ ë™ì‹œì— ë°”ê¿€ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ë°˜ë“œì‹œ ë”°ë¡œ ì €ì¥í•´ë‘ì„¸ìš”.\n\nğŸ”‘ ì½”ë“œ: " + targetUid;
        replier.reply(formatCommand("ğŸ” ë³´ì•ˆ ë³µêµ¬ ì½”ë“œ", user, codeMsg, "ì—°ë™ ë°©ë²•: [/ê³„ì •ì—°ë™ ì½”ë“œ]"));
        return true;
    }

    // [ê¸°ëŠ¥ 2] ê³„ì • ì—°ë™ ë° ë°ì´í„° ë³µêµ¬ (ì™„ì „ ê²°í•¨ ì œê±° ë²„ì „)
    if (msg.indexOf("/ê³„ì •ì—°ë™") === 0) {
        var parts = msg.split(" ");
        if (parts.length < 2) return replier.reply(formatError(user, "ì…ë ¥ ì˜¤ë¥˜", "/ê³„ì •ì—°ë™ [ë³µêµ¬ì½”ë“œ]"));

        var inputCode = parts[1].split("-").join("").toLowerCase().trim();
        var oldUser = null;

        // 1. ì „ì²´ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì†ŒìŠ¤ ê³„ì • íƒìƒ‰
        for (var rName in data.rooms) {
            var roomUsers = data.rooms[rName].users;
            for (var uid in roomUsers) {
                if (String(uid).split("-").join("").toLowerCase() === inputCode) {
                    oldUser = roomUsers[uid];
                    break;
                }
            }
            if (oldUser) break;
        }

        if (!oldUser) return replier.reply(formatError(user, "ë³µêµ¬ ì‹¤íŒ¨", "ì¼ì¹˜í•˜ëŠ” ì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        if (inputCode === String(targetUid).split("-").join("").toLowerCase()) return replier.reply(formatError(user, "ì‘ì—… ë¬´íš¨", "í˜„ì¬ ì ‘ì† ì¤‘ì¸ ì½”ë“œì™€ ë™ì¼í•©ë‹ˆë‹¤."));

        try {
            // 2. ë°ì´í„° ì •ë°€ ë³µì‚¬ (Deep Copy)
            // í˜„ì¬ ìœ ì €ì˜ ê³ ìœ  ID(targetUid)ì™€ ì´ë¦„ì€ ìœ ì§€í•œ ì±„ ì•Œë§¹ì´ë§Œ ê³¼ê±° ë°ì´í„°ë¡œ êµì²´
            var backupData = JSON.parse(JSON.stringify(oldUser));
            
            // í•„ìˆ˜ í•„ë“œ ì„ ë³„ ë³µì‚¬ (í˜„ì¬ ë‹‰ë„¤ì„ê³¼ ID ë³´ì¡´)
            var preservedName = user.name;
            var preservedHash = user.imageHash;

            // ìˆ˜ì •: ë¬´ì—­, ê²½ë§ˆë¶€í’ˆ, ì¹­í˜¸ì§„í–‰ë„ ë“± USER_SCHEMAì˜ ëª¨ë“  ì •ë³´ë¥¼ ëˆ„ë½ ì—†ì´ ë³µì‚¬
            USER_SCHEMA.forEach(function(item) {
                var f = item.key;
                if (backupData[f] !== undefined) {
                    // ê°ì²´ë‚˜ ë°°ì—´ì¸ ê²½ìš° ì°¸ì¡° ëŠê¸°(Deep Copy) ì ìš©
                    user[f] = (typeof backupData[f] === 'object' && backupData[f] !== null) 
                              ? JSON.parse(JSON.stringify(backupData[f])) : backupData[f];
                }
            });

            user.name = preservedName;
            user.imageHash = preservedHash;

            safeSaveData(data);
            
            var resBody = "ê³¼ê±° ìì‚° ì •ë³´ë¥¼ í˜„ì¬ ê³„ì •ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ë³µì‚¬í•´ì™”ìŠµë‹ˆë‹¤.\n\n" +
                         "ğŸ’° ë³µì œ ì”ì•¡: " + fp(user.point) + "P\n" +
                         "ğŸ… ë³µì œ í‹°ì–´: " + (TIERS[user.tier] || "ì•„ì´ì–¸") + "\n" +
                         "ğŸ“¦ ì¸ë²¤í† ë¦¬: " + (user.inventory ? user.inventory.length : 0) + "ê°œ í•­ëª© ì´ê´€";

            replier.reply(formatCommand("âœ… ë°ì´í„° ì •ë°€ ë³µì œ ì™„ë£Œ", user, resBody, "ê³ ìœ  ì½”ë“œëŠ” í˜„ì¬ ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ìœ ì§€í•©ë‹ˆë‹¤."));
        } catch (e) {
            replier.reply(formatError(user, "ì‹œìŠ¤í…œ ì˜¤ë¥˜", "ë³µì œ ì¤‘ ê¸°ìˆ ì  ê²°í•¨ ë°œìƒ: " + e));
        }
        return true;
    }

    /* [ê¸°ëŠ¥ 6] ìì‚° ìˆœìœ„ */
    if (msg === "/ì¶œì„ìˆœìœ„") {
        var targetZone = (roomName === "ë² ë¦­ë°©" || ALLOWED_ROOMS.indexOf(roomName) === -1) ? "ë‚´ë¦¬ë‹¤" : roomName;
        var targetRoomData = data.rooms[targetZone];
        var users = [];
        var roomUsers = roomData.users;
        for (var id in roomUsers) {
            var u = roomUsers[id];
            var netWorth = util_calculateNetWorth(u, roomData);
            if (netWorth >= 1) users.push({ data: u, total: netWorth });
        }
        users.sort(function(a, b) { return b.total - a.total; });
        var rankList = [];
        for (var i = 0; i < Math.min(10, users.length); i++) {
            rankList.push((i + 1) + ". " + getDisplayName(users[i].data) + " (" + fp(users[i].total) + "P)");
        }
        var rankMsg = (rankList.length > 0 ? rankList.join("\n") : "ìˆœìœ„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        replier.reply(formatSimple("ìì‚° ë­í‚¹ (ì‹¤ì§ˆ ìˆœìì‚° ê¸°ì¤€)", rankMsg, "ë‚´ ì •ë³´: [/ë‚´ì •ë³´]"));
        return true;
    }

    // [ìˆ˜ì •] ìœ ì €ì •ë³´ ì¡°íšŒ ë° ë­í‚¹ ì‚°ì¶œ ì‹œ ì§€ì—­ ë³€ìˆ˜ ì„ ì–¸(var) ëˆ„ë½ í•´ê²°
    if (msg.indexOf("/ìœ ì €ì •ë³´") === 0) {
        var tn = msg.substring(5).trim(); 
        if (tn === "") {
            replier.reply(formatError(user, "ì…ë ¥ ì˜¤ë¥˜", "ì¡°íšŒí•  ìœ ì €ì˜ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”."));
            return true;
        }
        var found = findUserGlobal(tn, roomName);
        if (found.length === 0) { 
            replier.reply(formatError(user, "ëŒ€ìƒ ì—†ìŒ", "[" + tn + "]ë‹˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); 
            return true; 
        }
        if (found.length === 1) {
            var targetUser = found[0].data;
            var targetIdInside = found[0].id;
            var cr = getCreditInfo(targetUser.creditScore);
            
            var sDebt = 0; // [êµì •] var ì¶”ê°€
            var sClaims = 0; // [êµì •] var ì¶”ê°€
            
            if (roomData.loanContracts) {
                for (var cid in roomData.loanContracts) {
                    var c = roomData.loanContracts[cid];
                    if (c.borrowerUid === targetIdInside) sDebt += Math.floor(c.currentDebt);
                    if (c.lenderUid === targetIdInside) sClaims += Math.floor(c.currentDebt);
                }
            }

            var info = "ğŸ’° í¬ì¸íŠ¸: " + fp(targetUser.point) + "P\n" +
                       "ğŸ¦ ì˜ˆê¸ˆ: " + fp(targetUser.bank) + "P\n" +
                       (sClaims >= 1 ? "ğŸ¤ ë¯¸ìˆ˜ ì±„ê¶Œ: " + fp(sClaims) + "P\n" : "") +
                       "ğŸ’³ ì‹ ìš©: " + cr.label + " (" + targetUser.creditScore + "ì )\n" +
                       "ğŸ… í‹°ì–´: " + (TIERS[targetUser.tier] || "ì•„ì´ì–¸") + "\n" +
                       "ğŸ“… ì¶œì„: " + (targetUser.totalAttendance || 0) + "ì¼";
            
            var bDebt = (targetUser.loan && targetUser.loan.debt) ? Math.floor(Number(targetUser.loan.debt)) : 0;
            if (bDebt > 0) info += "\nğŸ¦ ë¯¸ìƒí™˜ ëŒ€ì¶œ: " + fp(bDebt) + "P";
            if (sDebt > 0) info += "\nğŸš¬ ë¯¸ìƒí™˜ ì‚¬ì±„: " + fp(sDebt) + "P";

            replier.reply(formatCommand("ğŸ” ìœ ì € ìƒì„¸ ì •ë³´", targetUser, info, null));
        } else {
            handleUserSelection(replier, targetUid, found, "info", null, user, roomName);
        }
        return true;
    }

    return false;
}

//==========ì„¹í„°40==========

/**
 * [ê²Œì„ í•˜ìœ„ ëª¨ë“ˆ 3] ì•¡ì…˜ ë° ë„ë°• í†µí•© ë¶„ë°°ê¸°
 * ì„¤ëª…: ì„¹í„° 39(ì „ì²´ ë¶„ë°°ê¸°)ë¡œë¶€í„° í˜¸ì¶œë°›ì•„, ì‹¤ì œ ì„¸ë¶€ ë¡œì§(42-1 ~ 42-3)ìœ¼ë¡œ ì—°ê²°í•©ë‹ˆë‹¤.
 * ì´ êµ¬ì¡°ë¥¼ í†µí•´ ê° ê¸°ëŠ¥ë³„ë¡œ ë…ë¦½ì ì¸ ìˆ˜ì • ë° ê´€ë¦¬ê°€ ê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤.
 */
function _gameActionLogic(msg, user, data, replier, roomName, targetUid) {
    var cmd = msg.split(" ")[0]; // ëª…ë ¹ì–´ ì²« ë‹¨ì–´ ì¶”ì¶œ
    
    // 1. í™€ì§, ìŠ¹ê¸‰, ê²½ë§ˆ ê´€ë ¨ ë¡œì§ (ì„¹í„° 40 ìœ„ì„)
    // [ìˆ˜ì •]: /ë°°íŒ… ë° ë°°íŒ…ì·¨ì†Œ ì¡°ê±´ì„ ì¶”ê°€í•˜ì—¬ Part1 í•¨ìˆ˜ê°€ ì‹¤í–‰ë  ìˆ˜ ìˆë„ë¡ ì…êµ¬ë¥¼ ê°œë°©í•¨
    if (cmd === "/í™€ì§" || cmd === "/ìŠ¹ê¸‰" || cmd === "/ë°°íŒ…" || cmd === "ë°°íŒ…ì·¨ì†Œ") {
        return _gameActionLogic_Part1(msg, user, data, replier, roomName, targetUid);
    }
    
    // 2. ê²°íˆ¬ ë¡œì§ (ì„¹í„° 41 ìœ„ì„)
    if (cmd === "/ê²°íˆ¬" || cmd === "ìˆ˜ë½" || cmd === "ê±°ì ˆ" || cmd === "ì·¨ì†Œ") {
        return _gameActionLogic_Part2(msg, user, data, replier, roomName, targetUid);
    }
    
    // 3. ë„ë‘‘ì§ˆ ë° ì¤ê¸° ë¡œì§ (ì„¹í„° 42 ìœ„ì„)
    if (cmd === "/ë„ë‘‘ì§ˆ" || cmd === "ì¡ì•˜ë‹¤ìš”ë†ˆ" || cmd === "ì¤ê¸°") {
        return _gameActionLogic_Part3(msg, user, data, replier, roomName, targetUid);
    }
    
    return false; // í•´ë‹¹ë˜ëŠ” ëª…ë ¹ì–´ê°€ ì—†ìŒ
}

//==========ì„¹í„°41==========

/**
 * [ê²Œì„ í•˜ìœ„ ëª¨ë“ˆ 3-1] ì•¡ì…˜ ë° ë„ë°• ê²Œì„ (í™€ì§ & ìŠ¹ê¸‰ & ê²½ë§ˆ ì•¡ì…˜)
 * v5.9: í†µí•© ì—”ì§„(7, 9, 11) ì—°ê²° ì™„ë£Œ
 */
function _gameActionLogic_Part1(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];
    if (!roomData) return false;

    var racingData = roomData.features.racing;

    var rConf = SYSTEM_CONFIG.ECO.RACING; 

    /* [ì—°ê²°] 1. ê²½ë§ˆ ë°°íŒ… ì•¡ì…˜ (/ë°°íŒ… [ë²ˆí˜¸] [ê¸ˆì•¡]) */
    if (msg.indexOf("/ë°°íŒ… ") === 0) {
        if (util_isBankruptcy(roomName)) {
            replier.reply(formatError(user, "ì‹œìŠ¤í…œ ë™ê²°", "êµ­ê°€ ë¶€ë„ ì„ í¬ ìƒíƒœì—ì„œëŠ” ê²½ë§ˆ ë°°íŒ…ì´ ê¸ˆì§€ë©ë‹ˆë‹¤.\n(íšŒë³µ ê¸°ì¤€: êµ­ê³  50%)"));
            return true;
        }
        if (!racingData.isOperating) {
            replier.reply(formatError(user, "ê²½ë§ˆì¥ íœ´ì¥", "í˜„ì¬ ìš´ì˜ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤. (09:00 ~ 23:59)"));
            return true;
        }

        var nowMin = new Date().getMinutes();
        if (nowMin >= 50) {
            replier.reply(formatError(user, "ë°°íŒ… ë§ˆê°", "í˜„ì¬ ì œ " + racingData.round + "íšŒì°¨ ê²½ê¸°ê°€ ë§ˆê°ë˜ì–´ ì •ì‚° ì¤‘ì…ë‹ˆë‹¤."));
            return true;
        }

        // [ì—”ì§„ ì—°ê²°] í†µí•© ìƒíƒœ ê°€ë“œ ì²´í¬ (ì§•ì—­/ê´‘ì‚° ë“±)
        var stateRes = util_checkUserState(user, targetUid, roomName);
        if (!stateRes.canAction) {
            replier.reply(formatError(user, "ë°°íŒ… ë¶ˆê°€", stateRes.reason));
            return true;
        }

        var ps = msg.trim().split(/\s+/);
        if (ps.length < 3) { 
            replier.reply(formatError(user, "í˜•ì‹ ì˜¤ë¥˜", "/ë°°íŒ… [ë§ë²ˆí˜¸] [ê¸ˆì•¡]")); 
            return true; 
        }
        
        var hId = parseInt(ps[1]);
        var betAmt = parseInt(ps[2].replace(/,/g, ""));

        if (isNaN(hId) || hId < 1 || hId > racingData.horses.length) {
            replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "1~" + racingData.horses.length + "ë²ˆ ì‚¬ì´ì˜ ë§ì„ ì„ íƒí•˜ì„¸ìš”."));
            return true;
        }

        // [ì—”ì§„ ì—°ê²°] ë¬¼ê°€ ë°°ìœ¨ ì—”ì§„ ì ìš©
        var minLimit = rConf.MIN_BET; 
        var maxLimit = rConf.MAX_BET;

        if (isNaN(betAmt) || betAmt < minLimit) {
            replier.reply(formatError(user, "ê¸ˆì•¡ ë¯¸ë‹¬", "ìµœì†Œ " + fp(minLimit) + "P ì´ìƒ ë°°íŒ…í•´ì•¼ í•©ë‹ˆë‹¤."));
            return true;
        }
        if (betAmt > maxLimit) {
            replier.reply(formatError(user, "í•œë„ ì´ˆê³¼", "ìµœëŒ€ " + fp(maxLimit) + "Pê¹Œì§€ ë°°íŒ… ê°€ëŠ¥í•©ë‹ˆë‹¤."));
            return true;
        }
        if (Number(user.point) < betAmt) {
            replier.reply(formatError(user, "í¬ì¸íŠ¸ ë¶€ì¡±", "ë³´ìœ  í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."));
            return true;
        }

        if (racingData.bets[targetUid]) {
            replier.reply(formatError(user, "ì¤‘ë³µ ë°°íŒ… ë¶ˆê°€", "ì´ë¯¸ ë°°íŒ…í•˜ì…¨ìŠµë‹ˆë‹¤. [ë°°íŒ…ì·¨ì†Œ] í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."));
            return true;
        }

        // [ì—”ì§„ ì—°ê²°] ê²Œì´íŠ¸ì›¨ì´ë¥¼ í†µí•œ ì•ˆì „ ì°¨ê° ë° êµ­ê³  ì…ê³ 
        util_updatePoint(user, roomData, -betAmt, "ê²½ë§ˆ ë°°íŒ…", roomName);
        
        var selectedHorse = racingData.horses[hId - 1];
        racingData.bets[targetUid] = { uid: targetUid, horseId: hId, amount: betAmt, name: user.name };
        racingData.totalPool += betAmt;

        // [v11.0] ì¤‘ì•™ê²½ë§ˆì¥ ìµœëŒ€ì£¼ì£¼ ë°°ë‹¹ì„ ìœ„í•œ ì¼ì¼ ë°°íŒ…ê¸ˆì•¡ ëˆ„ì 
        if (roomData.features.dailyPools) {
            var accumRate = SYSTEM_CONFIG.ECO.ACTIVITY_ACCUM_RATES.RACING || 0.02;
            roomData.features.dailyPools.race += Math.floor(betAmt * accumRate);
        }

        var betSuccessContent = "ğŸ‡ ì„ íƒ: " + selectedHorse.id + "ë²ˆ " + selectedHorse.name + "\nğŸ’° ê¸ˆì•¡: " + fp(betAmt) + "P ë°°íŒ… ì„±ê³µ!";

        if (Math.random() < 0.1) { // 10% í™•ë¥ 
            var allParts = ["ì•ˆì¥", "ë“±ì", "ê³ ì‚", "ì±„ì°"];
            if (!user.horseParts) user.horseParts = [];
            var missingParts = allParts.filter(function(p) { return user.horseParts.indexOf(p) === -1; });
            
            if (missingParts.length > 0) {
                var newPart = missingParts[Math.floor(Math.random() * missingParts.length)];
                user.horseParts.push(newPart);
                betSuccessContent += "\n\n ğŸ ê²½ë§ˆì¥ì„ ì§€ë‚˜ë‹¤ '" + newPart + "'ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤!\n(ë³´ìœ  ì•„ì´í…œ: " + user.horseParts.join(", ") + " / ë‚¨ì€ ë¶€í’ˆ: " + (missingParts.length - 1) + "ê°œ)";
                
                if (user.horseParts.length === 4) {
                    betSuccessContent += "\n\n ğŸ ëª¨ë“  ì¥ë¹„ê°€ ê°–ì¶°ì ¸ [ê²½ë§ˆì™•] ìê²©ì„ ì–»ì—ˆìŠµë‹ˆë‹¤!";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  util_checkAndAwardTitle(user, replier, "ê²½ë§ˆì™•", 777, "ğŸ‡", "ë‚´ë¦¬ë‹¤ ê²½ë§ˆ í˜‘íšŒ", "ê²½ë§ˆ ì¥ë¹„ 4ì¢… ìˆ˜ì§‘", "[ì¥ì°© íš¨ê³¼]: ê²½ë§ˆ ë°°íŒ… ì·¨ì†Œ ì‹œ ë°œìƒí•˜ëŠ” ìœ„ì•½ê¸ˆ(10%)ì´ ì „ì•¡ ë©´ì œë©ë‹ˆë‹¤.", roomName);
                }
            }
        }

        replier.reply(formatCommand("âœ… [ê²½ë§ˆ ë°°íŒ… ì™„ë£Œ]", user, betSuccessContent, "ğŸ‡ ì„ íƒ: " + selectedHorse.id + "ë²ˆ " + selectedHorse.name + "\nğŸ’° ê¸ˆì•¡: " + fp(betAmt) + "P ë°°íŒ… ì„±ê³µ!", "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
        safeSaveData(data);
        return true;
    }

    /* [ì—°ê²°] 2. ê²½ë§ˆ ë°°íŒ… ì·¨ì†Œ (ë°°íŒ…ì·¨ì†Œ) */
    if (msg === "ë°°íŒ…ì·¨ì†Œ") {
        if (!racingData.isOperating) return false;
        var nowMin = new Date().getMinutes();
        if (nowMin >= 50) {
            replier.reply(formatError(user, "ì·¨ì†Œ ë¶ˆê°€", "ì •ì‚° ì¤‘ì—ëŠ” ì·¨ì†Œê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤."));
            return true;
        }

        var myBet = racingData.bets[targetUid];
        if (!myBet) {
            replier.reply(formatError(user, "ë‚´ì—­ ì—†ìŒ", "ì´ë²ˆ íšŒì°¨ ë°°íŒ… ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤."));
            return true;
        }

       var isOwner = (user.title === "ê²½ë§ˆì™•");
        var feeRate = isOwner ? 0 : rConf.CANCEL_FEE;
        var fee = Math.floor(myBet.amount * feeRate);
        var refund = myBet.amount - fee;

        var cancelMsg = "ê²½ë§ˆ ë°°íŒ…ì„ ì² íšŒí–ˆìŠµë‹ˆë‹¤.\n\nğŸ’° ì›ë˜ ë°°íŒ…ê¸ˆ: " + fp(myBet.amount) + "P\n";
        if (isOwner) {
            cancelMsg += "ğŸ‘‘ [ê²½ë§ˆì™•] ì¹­í˜¸ íš¨ê³¼ ì ìš©!\nâš–ï¸ ì·¨ì†Œ ìœ„ì•½ê¸ˆ: 0P (ì „ì•¡ ë©´ì œ)\n";
        } else {
            cancelMsg += "âš–ï¸ ì·¨ì†Œ ìœ„ì•½ê¸ˆ(10%): -" + fp(fee) + "P\n";
        }
        cancelMsg += "ğŸ ìµœì¢… í™˜ë¶ˆì•¡: " + fp(refund) + "P";

        // [ì—”ì§„ ì—°ê²°] ê²Œì´íŠ¸ì›¨ì´ë¥¼ í†µí•œ í™˜ë¶ˆ (ìˆ˜ìˆ˜ë£Œ ì œì™¸)
        util_updatePoint(user, roomData, refund, "ê²½ë§ˆ ë°°íŒ… ì·¨ì†Œ", roomName);
        
        racingData.totalPool -= myBet.amount;

        // [v11.0] ë°°íŒ… ì·¨ì†Œ ì‹œ ì¼ì¼ ëˆ„ì  ê¸ˆì•¡ì—ì„œ ì°¨ê° (ì‹¤ì œ ìœ íš¨ ë°°íŒ…ì•¡ ë°˜ì˜)
        if (roomData.features.dailyPools) {
            roomData.features.dailyPools.race -= myBet.amount;
        }

        delete racingData.bets[targetUid];

        var cancelMsg = "ê²½ë§ˆ ë°°íŒ…ì„ ì² íšŒí–ˆìŠµë‹ˆë‹¤.\n\nğŸ’° ì›ë˜ ë°°íŒ…ê¸ˆ: " + fp(myBet.amount) + "P\nâš–ï¸ ì·¨ì†Œ ìœ„ì•½ê¸ˆ(10%): -" + fp(fee) + "P\nğŸ ìµœì¢… í™˜ë¶ˆì•¡: " + fp(refund) + "P";
        replier.reply(formatCommand("ğŸš« ë°°íŒ… ì·¨ì†Œ ì™„ë£Œ", user, cancelMsg, "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
        safeSaveData(data);
        return true;
    }

    /* [ì—°ê²°] 3. í™€ì§ ì‹œìŠ¤í…œ í†µí•© ì•ˆë‚´ (/í™€ì§) */
    /**
     * ì„¤ëª…: ê¸°ì¡´ í™€ì§ ì‹œìŠ¤í…œì„ íê¸°í•˜ê³  í†µí•© ì¹´ì§€ë…¸(/ì¹´ì§€ë…¸)ë¡œ ìœ ë„í•©ë‹ˆë‹¤.
     */
    if (msg.indexOf("/í™€ì§") === 0) {
        var notice = "ê¸°ì¡´ í™€ì§ ë„ë°• ì‹œìŠ¤í…œì´ [ë‚´ë¦¬ë‹¤ ì¤‘ì•™ ì¹´ì§€ë…¸]ë¡œ í†µí•©ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n" +
                     "ğŸªœ ì‚¬ë‹¤ë¦¬ (ë‹¨ì¼ 1.9ë°° / ì¡°í•© 4.0ë°°)\n" +
                     "ğŸƒ ë°”ì¹´ë¼ (P 2.0ë°° / B 1.95ë°° / T 8.0ë°°)\n\n" +
                     "ë”ìš± ì •êµí•´ì§„ ì‹œìŠ¤í…œì—ì„œ ì‹¤ì‹œê°„ ë°°íŒ…ì„ ì¦ê²¨ë³´ì„¸ìš”!";
        
        replier.reply(formatCommand("ğŸŒ“ ì‹œìŠ¤í…œ í†µí•© ì•ˆë‚´", user, notice, "ëª…ë ¹ì–´: [/ì¹´ì§€ë…¸]"));
        return true;
    }

    /* [ê¸°ì¡´ ë¡œì§ ìœ ì§€] 4. í‹°ì–´ ìŠ¹ê¸‰ (/ìŠ¹ê¸‰) */
   if (msg === "/ìŠ¹ê¸‰") {
        // [ìˆ˜ì •] NaN ë°©ì§€ë¥¼ ìœ„í•´ ëª¨ë“  ë³€ìˆ˜ë¥¼ Number()ë¡œ ê°•ì œ í˜•ë³€í™˜ ì²˜ë¦¬
        var dailyAmt = Number(user.dailyPromotionAttempts || 0);
        var purchasedAmt = Number(user.purchasedPromotionAttempts || 0);
        var totalAttempts = dailyAmt + purchasedAmt;

        if (totalAttempts <= 0) { replier.reply(formatError(user, "ê¸°íšŒ ì—†ìŒ", "ìƒì ì—ì„œ ìŠ¹ê¸‰ê¶Œì„ êµ¬ë§¤í•˜ì„¸ìš”.")); return true; }
        if (user.tier >= 9) { replier.reply(formatError(user, "ìµœê³  ë“±ê¸‰", "ì´ë¯¸ ì±Œë¦°ì € ë“±ê¸‰ì…ë‹ˆë‹¤.")); return true; }

        var usedDaily = false;
        if (dailyAmt > 0) { 
            util_setData(user, 'dailyPromotionAttempts', dailyAmt - 1, "ì¼ì¼ ìŠ¹ê¸‰ ê¸°íšŒ ì°¨ê°", roomName);
            usedDaily = true; 
        }
        else { 
            util_setData(user, 'purchasedPromotionAttempts', purchasedAmt - 1, "êµ¬ë§¤ ìŠ¹ê¸‰ê¶Œ ì°¨ê°", roomName);
        }

        var prob = TIER_PROBS[user.tier] || { up: 50, stay: 40, down: 10 };
        var rand = Math.random() * 100;
        var isSundayFever = (new Date().getDay() === 0);
        if (isSundayFever) rand -= 5; 

        startTracking(user, "ìŠ¹ê¸‰ ë„ì „");

        if (rand < prob.up) { 
            // 1. ì°¨ì„¸ëŒ€ í‹°ì–´ ê³„ì‚° ë° ê²Œì´íŠ¸ì›¨ì´ ê²€ì¦
            var nextTier = Number(user.tier || 0) + 1;
            util_setData(user, 'tier', nextTier, "ìŠ¹ê¸‰ ì„±ê³µ", roomName);

            var successBody = "í‹°ì–´: [" + TIERS[nextTier] + "]\n\n";
            
            if (nextTier === 9) { // ì±Œë¦°ì € ë„ë‹¬ íŒì •
                // ì±Œë¦°ì € íšŸìˆ˜ í†µê³„ë„ ê²Œì´íŠ¸ì›¨ì´ë¡œ ë³´í˜¸
                util_setData(user, 'challengerCount', (user.challengerCount || 0) + 1, "ì±Œë¦°ì € ë‹¬ì„±", roomName);
                user.challengerIconSeason = getSimpleSeason();
                successBody += "ğŸŠ ì¶•í•˜í•©ë‹ˆë‹¤! ì±Œë¦°ì € ë“±ê¸‰ ë„ë‹¬! ëª…ì˜ˆì˜ ì „ë‹¹ì— ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.";
            } else {
                // ìŠ¹ê¸‰ ì„±ê³µ ë³´ë„ˆìŠ¤ ê¸°íšŒ ì¦ê°€ë„ ê²Œì´íŠ¸ì›¨ì´ë¡œ ë³´í˜¸
                if (usedDaily) {
                    util_setData(user, 'dailyPromotionAttempts', (user.dailyPromotionAttempts || 0) + 1, "ìŠ¹ê¸‰ ì„±ê³µ ë³´ë„ˆìŠ¤", roomName);
                } else {
                    util_setData(user, 'purchasedPromotionAttempts', (user.purchasedPromotionAttempts || 0) + 1, "ìŠ¹ê¸‰ ì„±ê³µ ë³´ë„ˆìŠ¤", roomName);
                }
                successBody += "ğŸ‰ ìŠ¹ê¸‰ ì„±ê³µ ë³´ë„ˆìŠ¤: ì¬ë„ì „ ê¸°íšŒ ìœ ì§€!";
            }
            replier.reply(formatCommand("ğŸŠ ìŠ¹ê¸‰ ì„±ê³µ!", user, successBody, "ë‚¨ì€ ê¸°íšŒ: " + (Number(user.dailyPromotionAttempts) + Number(user.purchasedPromotionAttempts)) + "íšŒ"));
            endTracking(user, true, "ìŠ¹ê¸‰ ì„±ê³µ");
        } else if (rand > (100 - prob.down)) {
            if (Number(user.tierGuard || 0) > 0) {
                util_setData(user, 'tierGuard', user.tierGuard - 1, "ê°•ë“± ë°©ì–´ê¶Œ ì‚¬ìš©", roomName);
                replier.reply(formatCommand("ğŸ›¡ï¸ ê°•ë“± ë°©ì–´", user, "í‹°ì–´: [" + TIERS[user.tier] + "] ìœ ì§€\në°©ì–´ê¶Œì„ ì‚¬ìš©í•˜ì—¬ ë³´í˜¸í–ˆìŠµë‹ˆë‹¤.", "ë‚¨ì€ ë°©ì–´ê¶Œ: " + user.tierGuard + "ê°œ"));
                endTracking(user, true, "ê°•ë“± ë°©ì–´");
            } else {
                util_setData(user, 'tier', Math.max(0, user.tier - 1), "ìŠ¹ê¸‰ ì‹¤íŒ¨ ê°•ë“±", roomName);
                replier.reply(formatCommand("ğŸ“‰ ê°•ë“± ë°œìƒ", user, "í‹°ì–´: [" + TIERS[user.tier] + "]\nìƒíƒœ: í‹°ì–´ê°€ í•˜ë½í–ˆìŠµë‹ˆë‹¤.", "ë‚¨ì€ ê¸°íšŒ: " + (Number(user.dailyPromotionAttempts) + Number(user.purchasedPromotionAttempts)) + "íšŒ"));
                endTracking(user, false, "ê°•ë“± ë°œìƒ");
            }
        } else {
            replier.reply(formatCommand("ğŸ˜ ìŠ¹ê¸‰ ì‹¤íŒ¨", user, "í‹°ì–´: [" + TIERS[user.tier] + "] ìœ ì§€\nìƒíƒœ: ìŠ¹ê¸‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "ë‚¨ì€ ê¸°íšŒ: " + (Number(user.dailyPromotionAttempts) + Number(user.purchasedPromotionAttempts)) + "íšŒ"));
            endTracking(user, false, "ìŠ¹ê¸‰ ì‹¤íŒ¨");
        }
        safeSaveData(data);
        return true;
    }

    return false;
}

//==========ì„¹í„°42==========

/**
 * [ê²Œì„ í•˜ìœ„ ëª¨ë“ˆ 3-2] ì•¡ì…˜ ë° ë„ë°• ê²Œì„ (ê²°íˆ¬ ì‹œìŠ¤í…œ)
 */
function _gameActionLogic_Part2(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];
    if (!roomData || !roomData.features) return false;

    // [ìƒíƒœ ë¡œì»¬ë¼ì´ì§•] ë°©ë³„ ë…ë¦½ ê²°íˆ¬ ë°ì´í„° ì°¸ì¡°
    var duelData = roomData.features.states.duelData;

    /* [ê¸°ëŠ¥ 11] ê²°íˆ¬ ì‹ ì²­ */
    if (msg.indexOf("/ê²°íˆ¬ ") === 0) {
        if (data.gambleLimit) { replier.reply(formatError(user, "ë„ë°• ì œí•œ", "í˜„ì¬ ë„ë°• ê¸°ëŠ¥ì´ ì œí•œë˜ì–´ ìˆìŠµë‹ˆë‹¤.")); return true; }
        var myState = util_checkUserState(user, targetUid);
        if (!myState.canAction) { replier.reply(formatError(user, "ê²°íˆ¬ ë¶ˆê°€", myState.reason)); return true; }
        var parts = msg.trim().split(/\s+/);
        if (parts.length < 3) { replier.reply(formatError(user, "í˜•ì‹ ì˜¤ë¥˜", "/ê²°íˆ¬ [ë‹‰ë„¤ì„] [ê¸ˆì•¡]")); return true; }
        var am = parseInt(parts.pop().replace(/,/g, ""));
        var tn = parts.slice(1).join(" ").trim();

        var minBet = Math.floor(100 * util_getEcoMultiplier(roomName));

        if (isNaN(am) || am < minBet) { replier.reply(formatError(user, "ê¸ˆì•¡ ì˜¤ë¥˜", "ìµœì†Œ " + fp(minBet) + "P ì´ìƒ ê²°íˆ¬ ê°€ëŠ¥í•©ë‹ˆë‹¤.")); return true; }
        if (Number(user.point) < am) { replier.reply(formatError(user, "í¬ì¸íŠ¸ ë¶€ì¡±", "ë² íŒ…í•  í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.")); return true; }
        
        var found = findUserByName(roomData, tn);
        if (found.length === 0) { replier.reply(formatError(user, "ëŒ€ìƒ ì—†ìŒ", "[" + tn + "]ë‹˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (found.length > 1) { handleUserSelection(replier, targetUid, found, "duel", { bet: am }, user, roomName); return true; }
        var target = found[0];
        if (target.id === targetUid) { replier.reply(formatError(user, "ê²°íˆ¬ ë¶ˆê°€", "ìì‹ ê³¼ëŠ” ì‹¸ìš¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (isUserBusy(target.id)) { replier.reply(formatError(user, "ëŒ€ìƒ í™œë™ ì¤‘", "ìƒëŒ€ë°©ì´ í˜„ì¬ ë‹¤ë¥¸ í™œë™ì„ í•˜ê³  ìˆìŠµë‹ˆë‹¤.")); return true; }

        util_updatePoint(user, roomData, -am, "ê²°íˆ¬ ì‹ ì²­ ë² íŒ…", roomName);

        duelData[target.id] = { challengerUid: targetUid, point: am, expire: Date.now() + 30000, room: roomName };
        replier.reply(formatCommand("âš”ï¸ ê²°íˆ¬ ì‹ ì²­", target.data, getDisplayName(user) + "ë‹˜ì´ " + fp(am) + "P ê²°íˆ¬ë¥¼ ì‹ ì²­í–ˆìŠµë‹ˆë‹¤!\n\nìŠ¹ë‚™í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ìˆ˜ë½/ê±°ì ˆ/ì·¨ì†Œ)", "ë‚´ ì”ì•¡: " + fP(user.point) + "P"));
        safeSaveData(data);
        return true;
    }

    /* [v5.9 ìˆ˜ì •] ê²°íˆ¬ ì·¨ì†Œ (ì‹ ì²­ìê°€ ì§ì ‘ ì² íšŒ) */
    if (msg === "ì·¨ì†Œ") {
        var cancelTargetId = null;
        // í˜„ì¬ ë°©ì˜ ê²°íˆ¬ ë°ì´í„° ì¤‘ ë‚´ê°€ ì‹ ì²­ìì¸ ê±´ì„ íƒìƒ‰
        for (var tid in duelData) {
            if (duelData[tid].challengerUid === targetUid) {
                cancelTargetId = tid;
                break;
            }
        }

        if (cancelTargetId) {
            var d = duelData[cancelTargetId];
            // [ì—”ì§„ ì—°ë™] ì‹ ì²­ìì—ê²Œ ë² íŒ…ê¸ˆ ì¦‰ì‹œ í™˜ê¸‰
            util_updatePoint(user, roomData, d.point, "ê²°íˆ¬ ì·¨ì†Œ í™˜ê¸‰", roomName);
            delete duelData[cancelTargetId];
            
            replier.reply(formatCommand("ğŸš« ê²°íˆ¬ ì·¨ì†Œ ì™„ë£Œ", user, "ê²°íˆ¬ ì‹ ì²­ì„ ì² íšŒí•˜ê³  ë² íŒ…ê¸ˆì„ ë°˜í™˜ë°›ì•˜ìŠµë‹ˆë‹¤.", "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
            safeSaveData(data);
            return true;
        }
    }

    /* [v5.9 ìˆ˜ì •] ê²°íˆ¬ ìˆ˜ë½ (ìƒëŒ€ë°©ì´ ìŠ¹ë‚™) */
    if (msg === "ìˆ˜ë½" && duelData[targetUid]) {
        if (data.gambleLimit) { replier.reply(formatError(user, "ë„ë°• ì œí•œ", "í˜„ì¬ ë„ë°• ê¸°ëŠ¥ì´ ì œí•œë˜ì–´ ìˆìŠµë‹ˆë‹¤.")); return true; }
        
        var d = duelData[targetUid];
        var challenger = roomData.users[d.challengerUid];
        if (!challenger) { delete duelData[targetUid]; return true; }

        // ìˆ˜ë½ìì˜ ê°€ìš© í¬ì¸íŠ¸ ì²´í¬
        if (Number(user.point) < d.point) {
            util_updatePoint(challenger, roomData, d.point, "ìƒëŒ€ í¬ì¸íŠ¸ ë¶€ì¡± í™˜ê¸‰", roomName);
            delete duelData[targetUid];
            replier.reply(formatError(user, "í¬ì¸íŠ¸ ë¶€ì¡±", "ìˆ˜ë½í•˜ê¸° ìœ„í•œ í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•˜ì—¬ ê²°íˆ¬ê°€ ë¬´ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤."));
            return true;
        }

        // [ì—”ì§„ ì—°ë™] ìˆ˜ë½ì ë² íŒ…ê¸ˆ ì°¨ê°
        util_updatePoint(user, roomData, -d.point, "ê²°íˆ¬ ìˆ˜ë½ ë² íŒ…", roomName);

        // ìŠ¹íŒ¨ íŒì • (50:50)
        var isChallengerWin = Math.random() < 0.5;
        var winner = isChallengerWin ? challenger : user;
        var winnerId = isChallengerWin ? d.challengerUid : targetUid;
        var winPrize = d.point * 2;

        // [í•µì‹¬] ìƒí™˜ ì—”ì§„ í†µê³¼ í›„ ê²Œì´íŠ¸ì›¨ì´ë¡œ ìµœì¢… ìŠ¹ë¦¬ê¸ˆ ì§€ê¸‰
        var res = processRepayment(winner, winPrize, winnerId, roomName);
        util_updatePoint(winner, roomData, Number(res.actualGain), "ê²°íˆ¬ ìŠ¹ë¦¬ ë³´ìƒ", roomName);

        var resBody = "âš”ï¸ ê²°íˆ¬ ê²°ê³¼\n" + getDisplayName(challenger) + " VS " + getDisplayName(user) + "\n\nğŸ† ìŠ¹ì: " + getDisplayName(winner) + "\nğŸ’° íšë“: " + fp(winPrize) + "P" + (res.repayMsg || "");
        replier.reply(formatCommand("âš”ï¸ ê²°íˆ¬ ì¢…ë£Œ", winner, resBody, "ë‚´ ì”ì•¡: " + fp(winner.point) + "P"));
        
        delete duelData[targetUid];
        safeSaveData(data);
        return true;
    }

    /* [v5.9 ìˆ˜ì •] ê²°íˆ¬ ê±°ì ˆ (ìƒëŒ€ë°©ì´ ê±°ë¶€) */
    if (msg === "ê±°ì ˆ" && duelData[targetUid]) {
        var d = duelData[targetUid];
        var challenger = roomData.users[d.challengerUid];
        
        if (challenger) {
            // [ì—”ì§„ ì—°ë™] ì‹ ì²­ìì—ê²Œ ë² íŒ…ê¸ˆ ì•ˆì „ í™˜ê¸‰
            util_updatePoint(challenger, roomData, d.point, "ê²°íˆ¬ ê±°ì ˆ í™˜ê¸‰", roomName);
        }
        
        delete duelData[targetUid];
        replier.reply(formatCommand("ğŸš« ê²°íˆ¬ ê±°ì ˆ", user, "ê²°íˆ¬ ì‹ ì²­ì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.\nì‹ ì²­ìì—ê²Œ ë² íŒ…ê¸ˆì´ ë°˜í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.", "ë‹«ê¸°: [ì·¨ì†Œ]"));
        safeSaveData(data);
        return true;
    }
    return false;
}

//==========ì„¹í„°43==========

/**
 * [ê²Œì„ í•˜ìœ„ ëª¨ë“ˆ 3-3] ì•¡ì…˜ ë° ë„ë°• ê²Œì„ (ë„ë‘‘ì§ˆ & ì¤ê¸°)
 * ìˆ˜ì • ì‚¬í•­: ë²Œê¸ˆ ì´ì¤‘ ê°€ì‚° ë²„ê·¸ ìˆ˜ì • ë° ëª¨ë“  í¬ì¸íŠ¸ ë¡œì§ì— ë°© ê²©ë¦¬ ì‹ë³„ì(roomName) ì ìš©
 */
function _gameActionLogic_Part3(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];
    if (!roomData || !roomData.features) return false;

    // [ìƒíƒœ ë¡œì»¬ë¼ì´ì§•] ë°©ë³„ ë…ë¦½ ë¿Œë¦¬ê¸° ë° ë„ë‘‘ì§ˆ ìƒíƒœ ì°¸ì¡°
    var sprinkleData = roomData.features.sprinkleData;
    var activeThefts = roomData.features.states.activeThefts;

    /* [ê¸°ëŠ¥ 12] ë„ë‘‘ì§ˆ ì‹œë„ */
    if (msg.indexOf("/ë„ë‘‘ì§ˆ ") === 0) {
        if (data.gambleLimit) { replier.reply(formatError(user, "ë„ë°• ì œí•œ", "í˜„ì¬ ë„ë°• ê¸°ëŠ¥ì´ ì œí•œë˜ì–´ ìˆìŠµë‹ˆë‹¤.")); return true; }
        
        var myState = util_checkUserState(user, targetUid, roomName);
        if (!myState.canAction) {
            replier.reply(formatError(user, "ë„ë‘‘ì§ˆ ê¸ˆì§€", myState.reason));
            return true;
        }

        // 1. ë„ë‘‘ ê¸€ë¡œë²Œ ì¿¨íƒ€ì„ ì²´í¬ (1ì‹œê°„)
        var now = Date.now();
        if (now - (user.lastTheftActionTime || 0) < 3600000) {
            var remainMin = Math.ceil((3600000 - (now - user.lastTheftActionTime)) / 60000);
            replier.reply(formatError(user, "ì¿¨íƒ€ì„ ì œí•œ", "ë„ë‘‘ì§ˆ í›„ ì¬ì •ë¹„ ì‹œê°„ì´ í•„ìš”í•©ë‹ˆë‹¤.\n" + remainMin + "ë¶„ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."));
            return true;
        }

        var tn = msg.substring(5).trim();
        var found = findUserByName(roomData, tn);
        if (found.length === 0) { replier.reply(formatError(user, "ëŒ€ìƒ ì—†ìŒ", "[" + tn + "]ë‹˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (found.length > 1) { handleUserSelection(replier, targetUid, found, "theft", null, user, roomName); return true; }
        
        var victim = found[0];
        if (victim.id === targetUid) { replier.reply(formatError(user, "ê°•íƒˆ ë¶ˆê°€", "ìì‹ ì˜ ì§€ê°‘ì€ í„¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }

        // 2. í”¼í•´ì ì¡°ê±´ ì²´í¬: ìµœì†Œ ìì‚° 1ë§ŒP ì´ˆê³¼ & í”¼í•´ì ë³´í˜¸ 6ì‹œê°„ ì²´í¬
        if (Number(victim.data.point) <= 10000) { 
            replier.reply(formatError(user, "ê°•íƒˆ ëŒ€ìƒ ë¶€ì í•©", "ë³´ìœ  í¬ì¸íŠ¸ê°€ " + fp(10000) + "Pë¥¼ ì´ˆê³¼í•˜ëŠ” ìœ ì €ë§Œ í„¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")); 
            return true; 
        }
        if (now < (victim.data.lastTheftVictimTime || 0)) {
            var remainSec = Math.ceil((victim.data.lastTheftVictimTime - now) / 1000);
            var h = Math.floor(remainSec / 3600);
            var m = Math.ceil((remainSec % 3600) / 60);
            replier.reply(formatError(user, "ë³´í˜¸ ëŒ€ìƒ", "í•´ë‹¹ ìœ ì €ëŠ” ìµœê·¼ í”¼í•´ë¥¼ ì…ì–´ êµ­ê°€ì˜ ë³´í˜¸ë¥¼ ë°›ê³  ìˆìŠµë‹ˆë‹¤.\n(ë‚¨ì€ ì‹œê°„: " + h + "ì‹œê°„ " + m + "ë¶„)"));
            return true;
        }
        if (activeThefts[victim.id]) { replier.reply(formatError(user, "ì¤‘ë³µ ê°•íƒˆ ë¶ˆê°€", getDisplayName(victim.data) + "ë‹˜ì€ í˜„ì¬ ë‹¤ë¥¸ ë„ë‘‘ì´ ì‘ì—… ì¤‘ì…ë‹ˆë‹¤!")); return true; }

        // 3. ë„ë‘‘ì§ˆ í”„ë¡œì„¸ìŠ¤ ì„¤ì • (30ì´ˆ ë‹¨ì¶• ë° ëœë¤ íƒ€ì´ë¨¸)
        user.lastTheftActionTime = now; // ì¿¨íƒ€ì„ ì‹œì‘ ì‹œì  ê¸°ë¡
        
        // ì„±ê³µ íƒ€ì´ë¨¸: ì •í™•íˆ 30ì´ˆ (30000ms)
Â  Â  Â  Â  var successDelay = 30000;
Â  Â  Â  Â  // ê²½ì°° íƒ€ì´ë¨¸: 15ì´ˆ í›„ ì¶œë™ í™•ë¥  ê³„ì‚° (15000ms)
Â  Â  Â  Â  var policeDelay = 15000;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // [ì‹ ê·œ] ì‹ ìš©ë“±ê¸‰ë³„ ì°¨ë“± ê²½ì°° ì¶œë™ í™•ë¥  ê³„ì‚° (ê¸°ë³¸ 50% ë² ì´ìŠ¤)
        var crInfo = getCreditInfo(user.creditScore || 600);
        var probTable = {
            1: 0.72,   // 1ë“±ê¸‰: 72%
            2: 0.65,   // 2ë“±ê¸‰: 65%
            3: 0.595,  // 3ë“±ê¸‰: 59.5%
            4: 0.555,  // 4ë“±ê¸‰: 55.5%
            5: 0.525,  // 5ë“±ê¸‰: 52.5%
            6: 0.50    // 6ë“±ê¸‰: 50%
        };
        
        var policeProb = probTable[crInfo.grade] || 0.555;
        
        // [ì•½íƒˆì™•] ì¹­í˜¸ íš¨ê³¼: ê²½ì°° ì¶œë™ í™•ë¥  20% ê°ë©´
        if (user.title === "ì•½íƒˆì™•") policeProb = Math.max(0.1, policeProb - 0.20);

Â  Â  Â  Â  var sT = setTimeout(function(){ processTheftResult(roomName, targetUid, victim.id); }, successDelay);
Â  Â  Â  Â  var pT = setTimeout(function(){ if (Math.random() < policeProb) { processPoliceResult(roomName, targetUid, victim.id); } }, policeDelay);
Â  Â  Â  Â Â 
Â  Â  Â  Â  activeThefts[victim.id] = { thiefUid: targetUid, successTimer: sT, policeTimer: pT };
Â  Â  Â  Â  user.creditScore = Math.max(0, Number(user.creditScore || 600) - 10);

Â  Â  Â  Â  var attemptMsg = getDisplayName(victim.data) + "ë‹˜ ê°•íƒˆ ì‹œë„ ì¤‘ (30ì´ˆ ì†Œìš”)\n\n" +
                         "ğŸš“ 15ì´ˆ í›„ ê²½ì°° ì¶œë™ í™•ë¥  " + (policeProb * 100).toFixed(1) + "%!";

Â  Â  Â  Â  replier.reply(formatCommand("ğŸ•µï¸ ë„ë‘‘ì§ˆ ì‹œë„", user, attemptMsg, "ë°©ì–´: 30ì´ˆ ë‚´ [ì¡ì•˜ë‹¤ìš”ë†ˆ] ì…ë ¥"));
        
        // [Gemini ìš”ì²­ ì‚¬í•­] ë°© ì‹ë³„ì roomName ì¶”ê°€
        checkAndHandleDefaulter(user, roomName);
        safeSaveData(data);
        return true;
    }

    /* ë„ë‘‘ì§ˆ ë°©ì–´ (ì¡ì•˜ë‹¤ìš”ë†ˆ) */
    if (msg === "ì¡ì•˜ë‹¤ìš”ë†ˆ") {
        if (!activeThefts[targetUid]) return false;
        var theft = activeThefts[targetUid];
        if (theft.successTimer) clearTimeout(theft.successTimer);
        if (theft.policeTimer) clearTimeout(theft.policeTimer);
        var thief = roomData.users[theft.thiefUid];
        
        var multiplier = util_getEcoMultiplier(roomName);

        // 1. ë²Œê¸ˆ ê³„ì‚°: í˜„ë³´ìœ ì•¡ì˜ 10% ì°¨ê°
Â  Â  Â  Â  var cashFine = Math.floor(Number(thief.point) * 0.1);
Â  Â  Â  Â  // 2. ëŒ€ë‚© ê³„ì‚°: ìµœì†Œ ë²Œê¸ˆ 1,000P ë¯¸ë‹¬ ì‹œ ë¶€ì¡±ë¶„ì„ ëŒ€ì¶œë¡œ ì „í™˜
Â  Â  Â  Â  var loanGap = Math.max(0, 1000 - cashFine);

Â  Â  Â  Â  util_updatePoint(thief, roomData, -cashFine, "ë„ë‘‘ì§ˆ ì²´í¬ ë²Œê¸ˆ", roomName);
Â  Â  Â  Â Â 
Â  Â  Â  Â  var loanMsg = "";
Â  Â  Â  Â  if (loanGap > 0) {
Â  Â  Â  Â  Â  Â  if (!thief.loan) thief.loan = { debt: 0, items: [] };
Â  Â  Â  Â  Â  Â  thief.loan.debt = Number(thief.loan.debt || 0) + loanGap;
Â  Â  Â  Â  Â  Â  if (!thief.loan.items) thief.loan.items = [];
Â  Â  Â  Â  Â  Â  thief.loan.items.push(loanGap);
Â  Â  Â  Â  Â  Â  loanMsg = "\nâš ï¸ ë²Œê¸ˆ ë¶€ì¡±ë¶„ ëŒ€ë‚©: " + fp(loanGap) + "P ëŒ€ì¶œ ì „í™˜";
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  thief.jailReleaseTime = Date.now() + (1 * 60 * 60 * 1000); 
Â  Â  Â  Â  delete activeThefts[targetUid];
Â  Â  Â  Â Â 
Â  Â  Â  Â  var resContent = "ğŸš¨ [í˜„í–‰ë²” ì²´í¬]\nëŒ€ìƒ: " + getDisplayName(thief) + "\nê²°ê³¼: -" + fp(cashFine) + "P ì°¨ê° / ì§•ì—­ 1ì‹œê°„" + loanMsg + "\në‚´ ì”ì•¡: " + fp(thief.point) + "P";
        replier.reply(formatAdmin("ğŸš“ ì²´í¬ ì™„ë£Œ", resContent));
        safeSaveData(data);
        return true;
    }

   /* [Gemini ìš”ì²­ ì‚¬í•­] ë¿Œë¦¬ê¸° ì¤ê¸° (ì°¸ì¡° ê¸°ë°˜ ë°ì´í„° í™•ì¸ ë° êµ­ê³  ì—°ë™) */
    if (msg === "ì¤ê¸°") {
        // 1. ì´ë²¤íŠ¸ í™œì„±í™” ì²´í¬ (ë°©ë³„ ì£¼ë¨¸ë‹ˆ ê¸°ì¤€)
        if (!sprinkleData || sprinkleData.active !== true) return false;

        var currentUser = user || roomData.users[targetUid];
            // ì´ë²¤íŠ¸ê°€ ì—†ì„ ë•Œ ë¬´ì‘ë‹µ ëŒ€ì‹  ì•ˆë‚´ë¥¼ ì£¼ì–´ 'ë¨¹í†µ' ì˜¤í•´ë¥¼ í•´ì†Œí•©ë‹ˆë‹¤.
            // replier.reply(formatError(user, "ì¤ê¸° ì‹¤íŒ¨", "í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ë¿Œë¦¬ê¸° ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤."));
            if (!currentUser) return false;

        // 2. ìœ ì € ë°ì´í„° ë¬´ê²°ì„± ì²´í¬
        var currentUser = user || roomData.users[targetUid];
        if (!currentUser) return false;

        // 3. ì¤‘ë³µ ì°¸ì—¬ ë° ì„ ì°©ìˆœ ê²€ì¦
        if (sprinkleData.winners.indexOf(targetUid) !== -1) {
            replier.reply(formatError(currentUser, "ì¤‘ë³µ ì°¸ì—¬ ë¶ˆê°€", "ì´ë¯¸ ì´ ì´ë²¤íŠ¸ì—ì„œ í¬ì¸íŠ¸ë¥¼ íšë“í•˜ì…¨ìŠµë‹ˆë‹¤."));
            return true;
        }
        if (sprinkleData.currentWinners >= sprinkleData.limit) {
            replier.reply(formatError(currentUser, "ì„ ì°©ìˆœ ë§ˆê°", "ì´ë¯¸ ëª¨ë“  í¬ì¸íŠ¸ê°€ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤."));
            return true;
        }

        // 4. í¬ì¸íŠ¸ ë°°ì • ë° ì§€ê¸‰ (portions ë°°ì—´ì—ì„œ ë§ˆì§€ë§‰ ê°’ ì¶”ì¶œ)
        var prize = sprinkleData.portions.pop();
        if (prize === undefined) return false;

        sprinkleData.winners.push(targetUid);
        sprinkleData.currentWinners++;
        sprinkleData.remainingPoint -= prize;

        // [v5.9] í†µí•© ìƒí™˜ ì—”ì§„ ë° ê²Œì´íŠ¸ì›¨ì´ ì§€ê¸‰
        var res = processRepayment(currentUser, prize, targetUid, roomName);
        util_updatePoint(currentUser, roomData, Number(res.actualGain), "ë¿Œë¦¬ê¸° ì¤ê¸°", roomName);

        replier.reply(formatCommand("ğŸ‰ ì¤ê¸° ì„±ê³µ!", currentUser, fp(prize) + "Pë¥¼ ì£¼ì› ìŠµë‹ˆë‹¤!" + res.repayMsg, "ë‚´ ì”ì•¡: " + fp(currentUser.point) + "P"));

        // 5. ì „ëŸ‰ ì†Œì§„ ì‹œ ì´ë²¤íŠ¸ ìë™ ì¢…ë£Œ
        if (sprinkleData.currentWinners >= sprinkleData.limit) {
            sprinkleData.active = false;
            Api.replyRoom(roomName, formatAdmin("ğŸ ë¿Œë¦¬ê¸° ë§ˆê°", "ëª¨ë“  í¬ì¸íŠ¸ê°€ ì†Œì§„ë˜ì–´ ì´ë²¤íŠ¸ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."));
        }
        safeSaveData(data);
        return true;
    }

    return false;
}

//==========ì„¹í„°44==========

/**
 * [ê²Œì„ í•˜ìœ„ ëª¨ë“ˆ 4] ëœë“œë§ˆí¬ ë¶€ë™ì‚° íˆ¬ì ê´€ë¦¬ (v11.0 Landmark Edition)
 * ê¸°ëŠ¥: ë¶€ë™ì‚° ì‹œì„¸ ì¡°íšŒ, ë‚´ ë¶€ë™ì‚° í™•ì¸, ì§€ë¶„ íˆ¬ì, ì§€ë¶„ ë§¤ê°
 * ì„¤ëª…: íì‡„í˜• ìˆœí™˜ ê²½ì œ ì—°ë™ - ë§¤ì…ê¸ˆì€ ê¸ˆê³  ì…ê³ , ë§¤ê°ê¸ˆì€ ê¸ˆê³  ì§€ì¶œ
 */
function _gameLandmarkLogic(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];
    if (!roomData || !roomData.features) return false;

    // ì¤‘ì•™ì€í–‰ ì¬ì› ì´ˆê¸°í™” (ì•ˆì „ì¥ì¹˜)
    if (roomData.bankReserve === undefined || roomData.bankReserve === null) {
        roomData.bankReserve = 10000;
    }

    /* [ë¶€ë™ì‚° ê±°ë˜ ì‹œìŠ¤í…œ] */

    // 1. ì‹¤ì‹œê°„ ì‹œì„¸ ì¡°íšŒ (/ëœë“œë§ˆí¬)
    if (msg === "/ëœë“œë§ˆí¬") {
        var currentHour = new Date().getHours();
        var isMarketOpen = (currentHour >= 7 && currentHour <= 23);
        var statusText = isMarketOpen ? "ğŸŸ¢ ë¶€ë™ì‚° ìš´ì˜ì¤‘ (07:00 ~ 23:59)" : "ğŸ”´ ë¶€ë™ì‚° ë§ˆê° (00:00~06:59)";
        var landList = generateLandmarkList(data, roomName);
        
        replier.reply("ğŸ¢ ì‹¤ì‹œê°„ ë¶€ë™ì‚° ì‹œì„¸ ì •ë³´\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + statusText + "\n\n" + (landList || "ë“±ë¡ëœ ë§¤ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.") + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’¡ [ê°€ì´ë“œ]: íˆ¬ì: [/íˆ¬ì ê±´ë¬¼ëª… ìˆ˜ëŸ‰]");
        return true;
    }

    // 2. ë‚´ ì†Œìœ  ë¶€ë™ì‚° í™•ì¸ (/ë‚´ë¶€ë™ì‚°)
    if (msg === "/ë‚´ë¶€ë™ì‚°") {
        var holdings = user.landHoldings || {};
        var keys = Object.keys(holdings);
        var title = "ğŸ˜ï¸ " + getDisplayName(user) + "ì˜ ì†Œìœ  ë¶€ë™ì‚°";

        var fixCfg = SYSTEM_CONFIG.ECO.LANDMARK.FIXED_POLICY; // ê³ ì •ê°€ ì •ì±… ì„¤ì • ë¡œë“œ

        if (keys.length === 0) {
            replier.reply(formatCommand(title, null, "ë³´ìœ  ì¤‘ì¸ ë¶€ë™ì‚° ì§€ë¶„ì´ ì—†ìŠµë‹ˆë‹¤.", "íˆ¬ì: [/íˆ¬ì ê±´ë¬¼ëª… ìˆ˜ëŸ‰]"));
            return true;
        }

        var list = [];
        var totalEvaluation = 0;
        var totalPurchase = 0;

        for (var i = 0; i < keys.length; i++) {
            var lName = keys[i];
            var count = Number(holdings[lName]);
            if (count <= 0) continue;

            var landmark = data.landmarkMarket[lName];
            var isDemolished = !landmark; 
            
            // [ê°€ê²© ë™ê¸°í™” í•µì‹¬] íƒ€ì…ì— ë”°ë¥¸ ì‹¤ì‹œê°„ ì‹œì„¸ ê³„ì‚°
            var curPrice = 0;
            if (!isDemolished) {
               if (landmark.type === "normal") {
                    curPrice = 200000; // ëœë“œë§ˆí¬ ì¡°íšŒê°€ 20ë§ŒP ê³ ì •
                } else {
                    curPrice = Math.floor(Number(landmark.price || 0));
                }
            }
            var avgPrice = Math.floor(Number(user.landAvg[lName] || 0));
            
            var purchaseVal = Math.floor(avgPrice * count);
            var evaluationVal = Math.floor(curPrice * count);
            
            totalPurchase += purchaseVal;
            totalEvaluation += evaluationVal;
            
            var profit = evaluationVal - purchaseVal;
            var profitRate = avgPrice > 0 ? ((profit / purchaseVal) * 100).toFixed(1) : "0.0";
            var signIcon = profit > 0 ? "ğŸ”º" : (profit < 0 ? "ğŸ”¹" : "â–");
            var nameDisplay = isDemolished ? "âš ï¸(ì² ê±°) " + lName : lName;
            
            list.push("â€¢ " + nameDisplay + " " + count + "ì§€ë¶„\n" +
                      "  ìˆ˜ìµ: " + fp(Math.floor(profit)) + "P (" + signIcon + profitRate + "%)\n" +
                      "  í‰ë‹¨: " + fp(avgPrice) + "P â” í˜„ì¬: " + fp(curPrice) + "P");
        }

        var totalProfit = totalEvaluation - totalPurchase;
        var totalRate = totalPurchase > 0 ? ((totalProfit / totalPurchase) * 100).toFixed(1) : "0.0";
        var totalSignIcon = totalProfit > 0 ? "ğŸ”º" : (totalProfit < 0 ? "ğŸ”¹" : "â–");

        var summary = "ğŸ’ ì´ í‰ê°€ê¸ˆì•¡: " + fp(Math.floor(totalEvaluation)) + "P\n" +
                      "ğŸ“Š ì „ì²´ ìˆ˜ìµë¥ : " + fp(Math.floor(totalProfit)) + "P (" + totalSignIcon + totalRate + "%)\n" +
                      "ğŸ’° ë³´ìœ  í¬ì¸íŠ¸: " + fp(Math.floor(user.point)) + "P";

        replier.reply(formatCommand(title, null, list.join("\n\n") + "\n\n" + summary, "ë§¤ê°: [/ë§¤ê° ê±´ë¬¼ëª… ìˆ˜ëŸ‰]"));
        return true;
    }

    // 3. ë¶€ë™ì‚° ì§€ë¶„ ë§¤ì… (/íˆ¬ì)
    if (msg.indexOf("/íˆ¬ì ") === 0) {
        if (typeof util_isBankruptcy === 'function' && util_isBankruptcy(roomName)) {
            var bankMsg = "ğŸš¨ [êµ­ê°€ ë¶€ë™ì‚° ê±°ë˜ ë™ê²°]\n" +
                          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                          "í˜„ì¬ ì¤‘ì•™ì€í–‰ì˜ ì§€ë¶ˆ ë¶ˆëŠ¥(ë¶€ë„) ìƒíƒœê°€ ì„ í¬ë˜ì–´\n" +
                          "ì‹ ê·œ ë¶€ë™ì‚° ë§¤ì…ì´ ì „ë©´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n" +
                          "ğŸ“ ì‚¬ìœ : êµ­ê³  ì¬ì› ê³ ê°ˆ\n" +
                          "ğŸ“‰ ì¡°ì¹˜: ë¶€ë™ì‚° ì‹œì¥ ì¼ì‹œ íì‡„";
            
            replier.reply(formatCommand("ğŸ—ï¸ íˆ¬ì ë™ê²° ì•Œë¦¼", user, bankMsg, "í•´ì œ ê¸°ì¤€: êµ­ê³  50% ë³µêµ¬"));
            return true;
        }

        var stateRes = util_checkUserState(user, targetUid, roomName);
        if (!stateRes.canAction) {
            replier.reply(formatError(user, "ê±°ë˜ ë¶ˆê°€", stateRes.reason));
            return true;
        }
        var currentHour = new Date().getHours();
        if (currentHour < 7) { replier.reply(formatError(user, "ë¶€ë™ì‚° ì‹œì¥ ë§ˆê°", "í˜„ì¬ëŠ” ë¶€ë™ì‚° ê±°ë˜ ì •ì§€ ì‹œê°„ì…ë‹ˆë‹¤.\n(ìš´ì˜ì‹œê°„: 07:00 ~ 23:59)")); return true; }

        var parts = msg.split(" ");
        if (parts.length < 3) { replier.reply(formatError(user, "í˜•ì‹ ì˜¤ë¥˜", "/íˆ¬ì [ê±´ë¬¼ëª…] [ìˆ˜ëŸ‰]")); return true; }
        
        var sInput = parts[1], count = parseInt(parts[2].replace(/,/g, ""));
        var matched = util_findStockByShorthand(data.landmarkMarket, sInput);
        
        if (matched.length === 0) { replier.reply(formatError(user, "ë§¤ë¬¼ ì—†ìŒ", "[" + sInput + "] ê±´ë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }
        if (matched.length > 1) { handleStockSelection(replier, targetUid, matched, "stock_buy", count, user, roomName); return true; }
        
        var sName = matched[0];

        var myLandKeys = Object.keys(user.landHoldings || {});
        if (myLandKeys.length > 0 && myLandKeys.indexOf(sName) === -1) {
            var currentLand = myLandKeys[0];
            replier.reply(formatError(user, "íˆ¬ì ì œí•œ", "ì´ë¯¸ [" + currentLand + "]ì˜ ì§€ë¶„ì„ ë³´ìœ í•˜ê³  ìˆìŠµë‹ˆë‹¤.\n\n" +
                "ğŸ’¡ ìš°ë¦¬ ì„œë²„ëŠ” '1ì¸ 1ê±´ë¬¼' íˆ¬ì ì›ì¹™ì„ ì¤€ìˆ˜í•©ë‹ˆë‹¤.\n" +
                "ë‹¤ë¥¸ ê±´ë¬¼ì— íˆ¬ìí•˜ë ¤ë©´ ê¸°ì¡´ ì§€ë¶„ì„ ëª¨ë‘ ë§¤ê°í•˜ì„¸ìš”."));
            return true;
        }

        var landmark = data.landmarkMarket[sName];
        if (isNaN(count) || count <= 0) { replier.reply(formatError(user, "ìˆ˜ëŸ‰ ì˜¤ë¥˜", "ë§¤ì…í•˜ì‹¤ ì§€ë¶„ ìˆ˜ëŸ‰ì„ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”.")); return true; }
        
        var totalPrice = 0;
        var fixCfg = SYSTEM_CONFIG.ECO.LANDMARK.FIXED_POLICY;

        if (landmark.type === "normal") {
            /* [ì°¸ì¡° ì˜¤ë¥˜ í•´ê²°] ì „ì—­ í•¨ìˆ˜ util_getTotalShares í˜¸ì¶œ */
            var currentRoomShares = util_getTotalShares(sName, roomData);
            var unitIncr = fixCfg.BASE_PRICE * fixCfg.PER_SHARE_RATE; 

            for (var i = 0; i < count; i++) {
                totalPrice += (fixCfg.BASE_PRICE + ((currentRoomShares + i) * unitIncr));
            }
        } else {
            /* [ë¹„ì¦ˆë‹ˆìŠ¤/ìƒê°€] ê¸°ì¡´ ê³ ì • ì‹œì„¸ ë§¤ì… */
            totalPrice = Math.floor(Number(landmark.price) * count);
        }
        if (Number(user.point) < totalPrice) { replier.reply(formatError(user, "ìê¸ˆ ë¶€ì¡±", "í•„ìš”: " + fp(totalPrice) + "P")); return true; }
        
        /* [ì¤‘ì•™ì€í–‰ ì—°ë™] ë§¤ì… ëŒ€ê¸ˆì„ êµ­ê³ ë¡œ ì…ê³  */
        util_updatePoint(user, roomData, -totalPrice, "ë¶€ë™ì‚° ë§¤ì…", roomName);

        // ìˆ˜ëŸ‰ ë° í‰ë‹¨ê°€ ì—…ë°ì´íŠ¸ (ëœë“œë§ˆí¬ íƒ€ì…ì€ í‰ë‹¨ê°€ ê¸°ë¡ ì œì™¸)
        if (landmark.type === "normal") {
            // ëœë“œë§ˆí¬(ê³ ì •ê°€) íƒ€ì…ì€ ëª‡ ì§€ë¶„ì„ ì‚¬ë“  í‰ë‹¨ê°€ë¥¼ 20ë§ŒPë¡œ ê³ ì •
            user.landAvg[sName] = 200000; 
        } else {
            // ë¹„ì¦ˆë‹ˆìŠ¤/ìƒê°€(ë³€ë™ê°€) íƒ€ì…ë§Œ ê°€ì¤‘ í‰ê·  ë§¤ì…ê°€ë¥¼ ê³„ì‚°í•˜ì—¬ ê¸°ë¡
            var curCount = Number(user.landHoldings[sName] || 0);
            var curAvg = Number(user.landAvg[sName] || 0);
            var totalCount = curCount + count;
            
            if (totalCount > 0) {
                user.landAvg[sName] = Math.floor(((curAvg * curCount) + totalPrice) / totalCount);
            } else {
                user.landAvg[sName] = Math.floor(totalPrice / count);
            }
        }
        
        util_updateLandmark(user, sName, count, "ë¶€ë™ì‚° ë§¤ì…", roomName);

        // ëˆ„ì  íˆ¬ì ë°ì´í„° ê°±ì‹ 
        var nextInvestAmount = (Number(user.totalLandInvest) || 0) + totalPrice;
        util_setData(user, 'totalLandInvest', nextInvestAmount, "ë¶€ë™ì‚° íˆ¬ì ì´ì•¡ ê°±ì‹ ", roomName);

        var rStub = { reply: function(m) { Api.replyRoom(roomName, m); } };

        // ë¶€ë™ì‚° ì „ìš© ì¹­í˜¸ ì²´í¬
        if (user.totalLandInvest >= 10000000) {
            util_checkAndAwardTitle(user, rStub, "íˆ¬ê¸°ì™•", 4303, "ğŸ™ï¸", "ë‚´ë¦¬ë‹¤ í† ì§€ì£¼íƒê³µì‚¬", "ëˆ„ì  ë§¤ì…ì•¡ 1,000ë§ŒP", "ë¶€ë™ì‚° ì‹œì¥ì„ ì§€ë°°í•˜ëŠ” ì „ì„¤ì ì¸ ê±°ë¬¼ë¡œ ë“±ê·¹í•˜ì…¨ìŠµë‹ˆë‹¤.");
        } else if (user.totalLandInvest >= 5000000) {
            util_checkAndAwardTitle(user, rStub, "ê±´ë¬¼ì£¼", 4302, "ğŸ¢", "ë‚´ë¦¬ë‹¤ í† ì§€ì£¼íƒê³µì‚¬", "ëˆ„ì  ë§¤ì…ì•¡ 500ë§ŒP", "ì£¼ìš” ìš”ì¶©ì§€ì˜ ê±´ë¬¼ì„ ì†Œìœ í•œ ì˜í–¥ë ¥ ìˆëŠ” ìì‚°ê°€ì…ë‹ˆë‹¤.");
        } else if (user.totalLandInvest >= 1000000) {
            util_checkAndAwardTitle(user, rStub, "ì„ëŒ€ì¸", 4301, "ğŸ ", "ë‚´ë¦¬ë‹¤ í† ì§€ì£¼íƒê³µì‚¬", "ëˆ„ì  ë§¤ì…ì•¡ 100ë§ŒP", "ë¶€ë™ì‚° íˆ¬ìì˜ ì²« ë‹¨ì¶”ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¼ìš°ì…¨ìŠµë‹ˆë‹¤.");
        }
        
        if (!data.landmarkTraffic) data.landmarkTraffic = {};
        if (!data.landmarkTraffic[sName]) data.landmarkTraffic[sName] = { buy: 0, sell: 0 };
        data.landmarkTraffic[sName].buy += count;

        var actualUnitPrice = Math.floor(totalPrice / count);
        var buySuccessMsg = "ê±´ë¬¼: " + sName + "\nìˆ˜ëŸ‰: " + count + " ì§€ë¶„\në§¤ì…ê°€: " + fp(actualUnitPrice) + "P (ì´ " + fp(totalPrice) + "P)";

        // [ê°œí¸] ì „ì„¤ì˜ í°ì† ì¡°ê±´: í•µì‹¬ ì‹œì„¤ íˆ¬ì ì‹œ ì§€ë¶„ë‹¹ 30% í™•ë¥ ë¡œ ì£¼ì‚¬ìœ„ êµ´ë¦¼
        var coreLandmarks = ["ê´‘ì‚°", "ë‚šì‹œí„°", "ì¹´ì§€ë…¸", "ì¤‘ì•™ì€í–‰", "ë°±í™”ì ", "ê²½ë§ˆì¥"];
        if (coreLandmarks.indexOf(sName) !== -1) { 
            var earnedInThisTrade = 0;
            // íˆ¬ìí•œ ì§€ë¶„ ìˆ˜ëŸ‰(count)ë§Œí¼ ë°˜ë³µí•˜ì—¬ í™•ë¥  íŒì •
            for (var i = 0; i < count; i++) {
                if (Math.random() < 0.3) earnedInThisTrade++;
            }

            if (earnedInThisTrade > 0) {
                user.landDeedCount = (user.landDeedCount || 0) + earnedInThisTrade;
                buySuccessMsg += "\n\n ğŸ“œ í•µì‹¬ ì‹œì„¤ íˆ¬ìë¡œ 'ë¶€ë™ì‚° ë“±ê¸°ë¶€'ë¥¼ " + earnedInThisTrade + "ì¥ íšë“í–ˆìŠµë‹ˆë‹¤!";
                buySuccessMsg += "\n(í˜„ì¬ ìˆ˜ì§‘: " + user.landDeedCount + " / 10)";
                
                if (user.landDeedCount >= 10) {
                    user.landDeedCount = 0; // ì´ˆê¸°í™”
                    util_checkAndAwardTitle(user, replier, "ì „ì„¤ì˜ í°ì†", 888, "ğŸ¢", "ë‚´ë¦¬ë‹¤ ì˜íšŒ", "ë“±ê¸°ë¶€ 10ì¥ ìˆ˜ì§‘ ì™„ë£Œ", "[ì¥ì°© íš¨ê³¼]: ë§¤ì¼ ìì • ì§€ê¸‰ë˜ëŠ” ëœë“œë§ˆí¬ ë°°ë‹¹ê¸ˆì´ 10% ì¶”ê°€ ì§€ê¸‰ë©ë‹ˆë‹¤.", roomName);
                }
            }
        }
        
        replier.reply(formatCommand("ğŸ™ï¸ ë¶€ë™ì‚° ì§€ë¶„ ë§¤ì… ì™„ë£Œ", user, buySuccessMsg, "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
        safeSaveData(data);
        return true;
    }

    // 4. ë¶€ë™ì‚° ì§€ë¶„ ë§¤ê° (/ë§¤ê°)
    if (msg.indexOf("/ë§¤ê° ") === 0) {
        if (typeof util_isBankruptcy === 'function' && util_isBankruptcy(roomName)) {
            var bankMsg = "ğŸš¨ [êµ­ê°€ ë¶€ë™ì‚° ê±°ë˜ ë™ê²°]\n" +
                          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                          "í˜„ì¬ ì¤‘ì•™ì€í–‰ì˜ ì§€ë¶ˆ ë¶ˆëŠ¥(ë¶€ë„) ìƒíƒœê°€ ì„ í¬ë˜ì–´\n" +
                          "ë¶€ë™ì‚° ë§¤ê° ëŒ€ê¸ˆ ì§€ê¸‰ì´ ì „ë©´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n" +
                          "ğŸ“ ì‚¬ìœ : êµ­ê³  ì¬ì› ê³ ê°ˆ\n" +
                          "ğŸ“‰ ì¡°ì¹˜: ë¶€ë™ì‚° ë§¤ê° ì¼ì‹œ ì •ì§€";
            
            replier.reply(formatCommand("ğŸ—ï¸ ë§¤ê° ë™ê²° ì•Œë¦¼", user, bankMsg, "í•´ì œ ê¸°ì¤€: êµ­ê³  50% ë³µêµ¬"));
            return true; 
        }

        var stateRes = util_checkUserState(user, targetUid, roomName);
        if (!stateRes.canAction) {
            replier.reply(formatError(user, "ê±°ë˜ ë¶ˆê°€", stateRes.reason));
            return true;
        }

        var parts = msg.split(" ");
        if (parts.length < 3) { replier.reply(formatError(user, "í˜•ì‹ ì˜¤ë¥˜", "/ë§¤ê° [ê±´ë¬¼ëª…] [ìˆ˜ëŸ‰]")); return true; }
        
        var sInput = parts[1], count = parseInt(parts[2].replace(/,/g, ""));
        
        // ë³´ìœ  ì¤‘ì¸ ë¶€ë™ì‚° ì§€ë¶„ ë¦¬ìŠ¤íŠ¸ì—ì„œ ê²€ìƒ‰
        var matched = util_findStockByShorthand(user.landHoldings, sInput);
        
        if (matched.length === 0) { replier.reply(formatError(user, "ë³´ìœ  ë§¤ë¬¼ ì—†ìŒ", "[" + sInput + "] ì§€ë¶„ì„ ë³´ìœ í•˜ê³  ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.")); return true; }
        if (matched.length > 1) { handleStockSelection(replier, targetUid, matched, "stock_sell", count, user, roomName); return true; }
        
        var sName = matched[0];
        var holdings = Number(user.landHoldings[sName] || 0);
        if (holdings < count || count <= 0) { replier.reply(formatError(user, "ì§€ë¶„ ë¶€ì¡±", "ë³´ìœ í•˜ì‹  ì§€ë¶„ë³´ë‹¤ ë§ì€ ìˆ˜ëŸ‰ì„ ë§¤ê°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")); return true; }

        var landmark = data.landmarkMarket[sName];
        var sellUnitPrice = 0;
        if (landmark && landmark.type === "normal") {
            // ëœë“œë§ˆí¬ íƒ€ì…: ê¸°ì¡´ì˜ ë³µì¡í•œ ê³„ì‚°ì‹ì„ ì‚­ì œí•˜ê³  20ë§ŒPë¡œ ê³ ì •
            sellUnitPrice = 200000; 
        } else {
            /* [ë¹„ì¦ˆë‹ˆìŠ¤/ìƒê°€] í˜„ì¬ ì‹œì¥ê°€(ë³€ë™ ì‹œì„¸) ê¸°ì¤€ ë§¤ê° */
            sellUnitPrice = landmark ? Math.floor(Number(landmark.price)) : 0;
        }
        
        var totalSell = sellUnitPrice * count;

        // ì„¸ê¸ˆ ê³„ì‚° (ì „ì„¤ì˜ í°ì† ì¹­í˜¸ íš¨ê³¼ ë°˜ì˜)
        var pol = util_getActivePolicy(roomData);
        var baseTaxRate = pol.stockTax || 0.05;
        var appliedTaxRate = baseTaxRate;

        var taxBenefitMsg = "";
        if (user.title === "ê¸°ë¶€ì™•") {
            appliedTaxRate = baseTaxRate * 0.5;
            taxBenefitMsg = "\nâœ¨ [ê¸°ë¶€ì™• íŠ¹ë³„ ì˜ˆìš°] ì–‘ë„ì„¸ 50% ê°ë©´ ì ìš©";
        }
        
        var fee = Math.floor(totalSell * appliedTaxRate);
        var finalPrice = totalSell - fee;

        var speculationBonus = 0;
        if (user.title === "íˆ¬ê¸°ì™•") {
            speculationBonus = Math.floor(finalPrice * 0.05);
            finalPrice += speculationBonus; // ìµœì¢… ì§€ê¸‰ì•¡ì— í•©ì‚°
        }

        // ì¤‘ì•™ì€í–‰ ì§€ë¶ˆ ëŠ¥ë ¥ ì²´í¬ (ë±…í¬ëŸ° ë°©ì–´)
        if (!util_isBankSolvent(roomName, finalPrice)) {
            return replier.reply("ğŸš¨ [ì¤‘ì•™ì€í–‰ ì§€ë¶ˆ ì •ì§€]\nì¤‘ì•™ì€í–‰ì˜ í˜„ê¸ˆ ìœ ë™ì„± ë¶€ì¡±ìœ¼ë¡œ ë§¤ê° ëŒ€ê¸ˆì„ ì§€ë¶ˆí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }

        /* [MODIFIED] ì €ì¥ëœ í‰ë‹¨ê°€ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìˆ˜ìµ ë° ìˆ˜ìµë¥  ì •ë°€ ì¬ê³„ì‚° */
        var avgPrice = Number(user.landAvg[sName] || 200000); 
        var purchaseVal = avgPrice * count; 
        var totalSell = sellUnitPrice * count; // ì„¸ì „ ì´ ë§¤ê°ì•¡
        var profit = totalSell - purchaseVal; 
        var profitRate = purchaseVal > 0 ? ((profit / purchaseVal) * 100).toFixed(1) : "0.0";
        var signIcon = (profit > 0) ? "ğŸ”º" : (profit < 0 ? "ğŸ”¹" : "â–");

        util_updateLandmark(user, sName, -count, "ë¶€ë™ì‚° ë§¤ê°", roomName);
        if (user.landHoldings[sName] <= 0) { 
            delete user.landHoldings[sName]; 
            if (user.landAvg) delete user.landAvg[sName]; 
        }
        
        // ìƒí™˜ ì—”ì§„ í†µê³¼ ë° ìµœì¢… ì§€ê¸‰
        var res = processRepayment(user, finalPrice, targetUid, roomName); 
        util_updatePoint(user, roomData, Number(res.actualGain), "ë¶€ë™ì‚° ë§¤ê° ìˆ˜ìµ", roomName); // ì‚¬ìœ  ì˜¤íƒ€ êµì •
        
        if (!data.landmarkTraffic) data.landmarkTraffic = {};
        if (!data.landmarkTraffic[sName]) data.landmarkTraffic[sName] = { buy: 0, sell: 0 };
        data.landmarkTraffic[sName].sell += count;

        // [ìµœì¢… UI êµì •]: ë°°ë‹¹ ì¹­í˜¸ì™€ ë§¤ê° ì¹­í˜¸ì˜ í˜¼ì„ ì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ë¬¸êµ¬ ì •ë¦¬
        var bonusLog = (user.title === "íˆ¬ê¸°ì™•") ? " âœ¨íˆ¬ê¸°ì™• í˜œíƒ(+" + fp(speculationBonus) + "P)" : "";
        var taxBenefitTag = (user.title === "ê¸°ë¶€ì™•") ? " âœ¨ê¸°ë¶€ì™• í˜œíƒ" : "";
        
        var sellResult = "ğŸ“‰ ë¶€ë™ì‚° ì§€ë¶„ ë§¤ê° ì™„ë£Œ\n" +
                         "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                         getDisplayName(user) + "ë‹˜\n" +
                         "ê±´ë¬¼: " + sName + " " + count + "ì§€ë¶„\n" +
                         "ìˆ˜ìµ : " + fp(Math.abs(profit)) + "P (" + signIcon + Math.abs(profitRate).toFixed(1) + "%)\n" +
                         "ì‹¤í˜„ì†ìµ : " + fp(finalPrice) + "P (ì„¸ìœ¨ " + (appliedTaxRate * 100).toFixed(1) + "% ì ìš©)" + 
                         bonusLog + taxBenefitTag + (res.repayMsg || "") + "\n" +
                         "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                         "ğŸ’¡ [ê°€ì´ë“œ]: ë‚´ ì”ì•¡: " + fp(user.point) + "P";

        replier.reply(sellResult);
        safeSaveData(data);
        return true;
    }

    return false;
}

//==========ì„¹í„°45==========

/**
 * [ê²Œì„ í•˜ìœ„ ëª¨ë“ˆ 5] ìƒì  ë° ê¸°íƒ€ í™œë™
 * ê¸°ëŠ¥: ìƒì  ë©”ë‰´ í˜¸ì¶œ, ì¶œì„ ì²´í¬
 * ì„¤ëª…: íì‡„í˜• ìˆœí™˜ ê²½ì œ ì—°ë™ - ì¶œì„ ë³´ìƒì„ ì¤‘ì•™ì€í–‰ ê¸ˆê³ ì—ì„œ ì§€ê¸‰í•©ë‹ˆë‹¤.
 */
function _gameShopLogic(msg, user, data, replier, roomName, targetUid) {
    if (ALLOWED_ROOMS.indexOf(roomName) === -1) {
        replier.reply("ğŸš« [ê¸°ëŠ¥ ì œí•œ]\nìƒì  ë° ì¶œì„ì²´í¬ëŠ” ë‹¨ì²´ë°©('ë‚´ë¦¬ë‹¤')ì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.\n\nâœ… 1:1 ê°€ëŠ¥: ì¹´ì§€ë…¸, ì€í–‰, ë‚´ì •ë³´");
        return true;
    }

    var roomData = data.rooms[roomName];
    if (!roomData || !roomData.features) return false;

    // [êµì •]: ì „ì—­ ê°ì²´ê°€ ì•„ë‹Œ í•´ë‹¹ ë°©ì˜ ë…ë¦½ ìƒíƒœ ì €ì¥ì†Œë¥¼ ëª…í™•íˆ ì°¸ì¡°
    var menuWaitState = roomData.features.states.menuWait;
    var bankProcessState = roomData.features.states.bankProcess;

    /* [Gemini] ì „ êµ¬ì—­ ì´ ì§€ë¶„ í•©ê³„ ê³„ì‚° ë‚´ë¶€ í•¨ìˆ˜ */
    var getTotalShares = function(landName) {
        var total = 0;
        for (var r in data.rooms) {
            for (var u in data.rooms[r].users) {
                total += Number((data.rooms[r].users[u].landHoldings || {})[landName] || 0);
            }
        }
        return total;
    };

    // ì¤‘ì•™ì€í–‰ ì¬ì› ì´ˆê¸°í™” (ì•ˆì „ì¥ì¹˜)
    if (roomData.bankReserve === undefined || roomData.bankReserve === null) {
        roomData.bankReserve = SYSTEM_CONFIG.ECO.BANK.INITIAL_RESERVE;
    }

    /* [ê¸°ëŠ¥ 14] ìƒì  ë©”ë‰´ í˜¸ì¶œ */
    if (msg === "/ìƒì ") {
        // [êµì •]: ë°©ë³„ ìƒíƒœ ê²€ì¦ì„ ìœ„í•´ roomName ì¸ì ì „ë‹¬
        var stateRes = util_checkUserState(user, targetUid, roomName);
        if (!stateRes.canAction && stateRes.reason.indexOf("ê´‘ì‚°") === -1) {
            replier.reply(formatError(user, "ìƒì  ì´ìš© ë¶ˆê°€", stateRes.reason));
            return true;
        }
        
        // 1. ìƒì  ë©”ì¸ ë©”ë‰´ UI: ì‚¬ìš©ì ìš”ì²­ì— ë”°ë¼ "âì·¨ì†Œ"ë§Œ í‘œì‹œ
        menuWaitState[targetUid] = { type: 'shop_category', time: Date.now(), originRoom: roomName };
        var categoryList = [];
        for (var id in SHOP_CATEGORIES) {
            categoryList.push(id + ". " + SHOP_CATEGORIES[id]);
        }
        var shopMenu = "ì›í•˜ì‹œëŠ” ì¹´í…Œê³ ë¦¬ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.\n\n" + categoryList.join("\n") + "\n\nâì·¨ì†Œ";
        
        replier.reply(formatCommand("ğŸ›’ ë‚´ë¦¬ë‹¤ë´‡ í†µí•© ìƒì ", user, shopMenu, "ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
        return true;
    }

    /* [ì¶”ê°€] ìƒì  ë¬¼í’ˆ ëª©ë¡ ì¶œë ¥ (ì‘ë‹µ ëŒ€ê¸° êµ¬ê°„ - ë‚´ë¹„ê²Œì´ì…˜ í¬í•¨) */
    // ì´ ë¡œì§ì€ ìƒì  ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí–ˆì„ ë•Œ í˜¸ì¶œë˜ì–´ ë¬¼í’ˆ ëª©ë¡ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
    function _showShopItemList(catId, user, roomName, replier, bankProcessState, targetUid) {
        var filteredItems = SHOP_ITEMS.filter(function(it) { return it.cat === parseInt(catId); });
        
        if (filteredItems.length === 0) {
            replier.reply(formatSimple("ğŸ›’ ìƒì  ì•Œë¦¼", "í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì— ë¬¼í’ˆì´ ì—†ìŠµë‹ˆë‹¤.", "ë‹¤ë¥¸ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”."));
            return;
        }

        var list = [];
        try {
            list = filteredItems.map(function(item, j) {
                var price = getItemPrice(item, user, roomName);
                return (j + 1) + ". " + item.icon + " " + item.name + " : " + fp(price) + "P";
            });
        } catch (e) {
            Log.error("ìƒì  ê°€ê²© ê³„ì‚° ì˜¤ë¥˜: " + e);
            replier.reply(formatError(user, "ì‹œìŠ¤í…œ ì˜¤ë¥˜", "ì•„ì´í…œ ê°€ê²©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."));
            return;
        }

        // ìƒíƒœ ì „í™˜ ë° ì•„ì´í…œ ë°ì´í„° ìºì‹±
        bankProcessState[targetUid] = { type: 'shop_buy', time: Date.now(), originRoom: roomName, extra: { items: filteredItems } };
        
        // [ì‘ë‹µ ëŒ€ê¸° ì§€ì ] í•˜ë‹¨ì— ì „ì²´ ë‚´ë¹„ê²Œì´ì…˜ ë°” í¬í•¨
        var SHOP_NAV = "\n\nâ†©ï¸ ë’¤ë¡œ / ğŸ  ì²˜ìŒìœ¼ë¡œ / âì·¨ì†Œ";
        var shopContent = list.join("\n") + "\n\nğŸ’° ë³´ìœ  í¬ì¸íŠ¸: " + fp(user.point) + "P" + SHOP_NAV;
        
        replier.reply(formatCommand("ğŸ›’ " + SHOP_CATEGORIES[catId], user, shopContent, "êµ¬ë§¤í•  ë¬¼í’ˆì˜ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
    }

    /* [ê¸°ëŠ¥ 2] ì¶œì„ ì²´í¬ (ì¤‘ì•™ì€í–‰ ì—°ë™) */
    if (msg === "/ì¶œì„") {
        var stateRes = util_checkUserState(user, targetUid, roomName);
        if (!stateRes.canAction && stateRes.reason.indexOf("ê´‘ì‚°") === -1) {
            replier.reply(formatError(user, "ì¶œì„ ë¶ˆê°€", stateRes.reason));
            return true;
        }

        var today = getSimpleDate();
        // 1. ì¤‘ë³µ ì¶œì„ ì²´í¬
        if (user.lastDate === today) { 
            replier.reply(formatError(user, "ì´ë¯¸ ì¶œì„ ì™„ë£Œ", "ì¶œì„ì€ í•˜ë£¨ì— í•œ ë²ˆë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.")); 
            return true; 
        }

       var eco = calculateEconomy(data, roomName);
        var avgAsset = eco.average || 500000; // ë°ì´í„°ê°€ ì—†ì„ ê²½ìš° ìµœì†Œ ê¸°ì¤€ 50ë§ŒP ì„¤ì •
        
        // í‰ê·  ìì‚°ì˜ 2%ë¥¼ ë³´ìƒì•¡ìœ¼ë¡œ ê²°ì • (ì˜ˆ: í‰ê·  87ë§ŒP ê¸°ì¤€ ì•½ 17,400P)
        var baseReward = Math.floor(avgAsset * 0.02); 
        
        // ì•½ê°„ì˜ ì¬ë¯¸ë¥¼ ìœ„í•´ ë³´ìƒì•¡ì˜ Â±5% ë²”ìœ„ì—ì„œ ë‚œìˆ˜ ë°œìƒ
        var variance = baseReward * 0.05;
        baseReward = Math.floor(baseReward + (Math.random() * (variance * 2) - variance));

        var pol = util_getActivePolicy(roomData); // ì •ë¶€ ì •ì±…
        var multiplier = util_getEcoMultiplier(roomName); // ì‹œì¥ ë¬¼ê°€ ë°°ìœ¨
        var emergencyMult = util_getEmergencyMultiplier(roomName); // êµ­ê³  ìœ„ê¸° ë°°ìœ¨
        var giniCorr = util_getGiniCorrection(user, roomName); // ê³„ì¸µë³„ ë³´ì •
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 1. ì‹œì¥ ë¬¼ê°€ ë° ì •ë¶€ ì •ì±… ë°°ìœ¨ ì ìš©
Â  Â  Â  Â  var baseResult = Math.floor(baseReward * multiplier * (pol.attendMult || 1.0));

Â  Â  Â  Â  // 2. ì‹œìŠ¤í…œ ë°©ì–´(êµ­ê³  ìœ„ê¸°) ë°°ìœ¨ ì ìš©
Â  Â  Â  Â  var reward = Math.floor(baseResult * emergencyMult);Â 

Â  Â  Â  Â  // 3. [ì‹ ê·œ] ì‹ ìš©ë¶ˆëŸ‰ì í˜ë„í‹°: ìµœì¢… ê¸ˆì•¡ì—ì„œ 20% ì¶”ê°€ ì‚­ê°
Â  Â  Â  Â  var penaltyMsg = "";
Â  Â  Â  Â  if (Number(user.creditScore || 600) < 500) {
Â  Â  Â  Â  Â  Â  var penalty = Math.floor(reward * 0.2); 
Â  Â  Â  Â  Â  Â  reward -= penalty; 
Â  Â  Â  Â  Â  Â  penaltyMsg = "\nâš ï¸ ì‹ ìš©ë¶ˆëŸ‰ í˜ë„í‹°: -" + fp(penalty) + "P (20% êµ­ê³  í™˜ì›)";
        }

        if (!util_isBankSolvent(roomName, reward)) {
            return replier.reply("ğŸš¨ [ì¤‘ì•™ì€í–‰ ì§€ë¶ˆ ì •ì§€]\nêµ­ê³ ê°€ ì™„ì „íˆ ê³ ê°ˆë˜ì–´ ì¶œì„ ë³´ìƒì„ ì§€ê¸‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nê´€ë¦¬ìì˜ ì¬ì› ìˆ˜í˜ˆì´ í•„ìš”í•©ë‹ˆë‹¤.");
        }

        /* [í•µì‹¬ ìˆ˜ì •] ì¶œì„ ë³´ìƒ ì§€ê¸‰ ì „ í†µí•© ìƒí™˜ ì—”ì§„ í˜¸ì¶œ */
        var res = processRepayment(user, reward, targetUid, roomName);
        
        /* [í•µì‹¬ ìˆ˜ì •] ì¤‘ì•™ì€í–‰ ì—°ë™: ë³´ìƒê¸ˆì„ ê¸ˆê³ ì—ì„œ ì°¨ê° ì§€ê¸‰ */
        // util_updatePoint í˜¸ì¶œ ì‹œ roomDataë¥¼ ì „ë‹¬í•˜ì—¬ "ì¶œì„ ë³´ìƒ" ì‚¬ìœ ë¡œ ê¸ˆê³  ì”ì•¡ ì°¨ê°
        util_updatePoint(user, roomData, Number(res.actualGain), "ì¶œì„ ë³´ìƒ", roomName);

        // 4. ìœ ì € ìƒíƒœ ë°ì´í„° ì—…ë°ì´íŠ¸
        user.lastDate = today; 
        user.totalAttendance = (user.totalAttendance || 0) + 1;
        user.creditScore = Math.min(1000, (user.creditScore || 600) + 2); 
        
        // ì •ì±… íš¨ê³¼ê°€ ê¸°ë³¸ê°’(1.0)ì´ ì•„ë‹ ë•Œë§Œ UIì— ì •ì±… íƒœê·¸ í‘œì‹œ
        var policyTag = (pol.attendMult && pol.attendMult !== 1.0) ? "\nâš–ï¸ ì •ì±… íš¨ê³¼: x" + pol.attendMult.toFixed(1) + " (ì ìš© ì¤‘)" : "";

        var content = fp(reward) + "Pê°€ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤! (ì‹ ìš© +2)" + (res.repayMsg || "") + penaltyMsg + policyTag + "\n" +
                      "ğŸ¦ êµ­ê³  ì¬ì›ì—ì„œ ì—°ê¸ˆì´ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.";

        replier.reply(formatCommand("âœ… ì¼ì¼ ì¶œì„ ì™„ë£Œ", user, content, "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
        
        safeSaveData(data); 
        return true;
    }

    return false;
}

//==========ì„¹í„°46==========

/* [ì§€ì—° ì‹¤í–‰] ëª…ë ¹ì–´ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì´ˆê¸°í™” (Initialization) */
// ëª¨ë“  ë¡œì§ í•¨ìˆ˜(ì„¹í„° 30~44)ê°€ ë©”ëª¨ë¦¬ì— ì ì¬ëœ í›„ ì‹¤í–‰ë˜ì–´ì•¼ í•˜ë¯€ë¡œ íŒŒì¼ ë§¨ ëì— ë°°ì¹˜í•©ë‹ˆë‹¤.
(function initializeRegistry() {
    try {
        // 1. ìœ ì € ëª…ë ¹ì–´ ë“±ë¡
        // ì„¹í„° 6ì˜ CMD_LIST.userì— ì¶”ê°€ëœ ê²½ë§ˆ ê´€ë ¨ ëª…ë ¹ì–´ë“¤ì„ ìë™ìœ¼ë¡œ ìˆœíšŒí•˜ë©° ë“±ë¡í•©ë‹ˆë‹¤.
        for (var i = 0; i < CMD_LIST.user.length; i++) {
            var c = CMD_LIST.user[i];
            
            var executor = null;
            try { 
                // ì „ì—­ ìŠ¤ì½”í”„(this)ì—ì„œ í•¨ìˆ˜ëª…ì„ ì°¾ê±°ë‚˜, ì•ˆë  ê²½ìš° eval ì‹œë„
                executor = this[c.func] || (typeof eval(c.func) === 'function' ? eval(c.func) : null); 
            } catch(e) { executor = null; }

            if (executor) {
                registerUserCmd(c.cmd, c.desc, c.cat, executor);
            } else {
                // ì •ë§ë¡œ í•¨ìˆ˜ê°€ ì—†ì„ ë•Œë§Œ ë¡œê·¸ ì¶œë ¥ (ë¶ˆí•„ìš”í•œ ì—ëŸ¬ ë°©ì§€)
                if (c.func !== "_handleMenuStep4") { 
                    Log.error("âŒ ëª…ë ¹ì–´ ë“±ë¡ ì‹¤íŒ¨ (í•¨ìˆ˜ ë¯¸ë°œê²¬): " + c.cmd + " -> " + c.func);
                } else {
                    // _handleMenuStep4ëŠ” íŠ¹ìˆ˜ í•¸ë“¤ëŸ¬ì´ë¯€ë¡œ ì „ì—­ ì°¸ì¡°ë¥¼ ê°•ì œ ë°”ì¸ë”©
                    registerUserCmd(c.cmd, c.desc, c.cat, function(m,u,d,r,rn,tu){ 
                        return _handleMenuStep4(m,u,d,r,rn,tu); 
                    });
                }
            }
        }

        // 2. ê´€ë¦¬ì ëª…ë ¹ì–´ ë“±ë¡
        for (var j = 0; j < CMD_LIST.admin.length; j++) {
            var a = CMD_LIST.admin[j];
            
            var adminExecutor = null;
            try { adminExecutor = eval(a.func); } catch(e) {}

            if (typeof adminExecutor === 'function') {
                registerAdminCmd(a.cmd, a.desc, adminExecutor);
            } else {
                Log.error("âŒ ê´€ë¦¬ì ëª…ë ¹ì–´ ë“±ë¡ ì‹¤íŒ¨: " + a.cmd);
            }
        }
        
        // [Gemini ì•Œë¦¼] ê²½ë§ˆ ì‹œìŠ¤í…œ ë¡œë“œ í™•ì¸ ë¡œê·¸ (ë””ë²„ê¹…ìš©)
        Log.info("ğŸ [Racing System] ê²½ë§ˆ ì—”ì§„ ë° ê´€ë ¨ ëª…ë ¹ì–´ ë¡œë“œ ì™„ë£Œ.");
        
    } catch(e) {
        Log.error("Registry Init Critical Error: " + e);
    }
})();

//==========ì„¹í„°47==========

/**
 * [ì‹ ì„¤] ê°€ìƒ ì •ë¶€ ì‹œìŠ¤í…œ í•µì‹¬ ì—”ì§„ (v11.0 Landmark Edition)
 * ê¸°ëŠ¥: ë¶€ë™ì‚° ì •ì±… ì•ˆê±´ ìƒì„±, í‹°ì–´ë³„ ê°€ì¤‘ íˆ¬í‘œ ì²˜ë¦¬, ì°¸ì—¬ ë³´ìƒ ì§€ê¸‰
 */

/**
 * 1. ëª…ë ¹ì–´ í†µí•© í•¸ë“¤ëŸ¬
 * ì²˜ë¦¬: /ì˜íšŒ (í˜„í™© ì¡°íšŒ), /íˆ¬í‘œ (ì˜ì‚¬ ê²°ì •)
 */
function _gameGovernmentLogic(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];
    if (!roomData || !roomData.features) return false;
    
    var gov = roomData.features.government;

    // A. [ì¡°íšŒ] /ì˜íšŒ : í˜„ì¬ ë¶€ë™ì‚° ì •ì±… ë° íˆ¬í‘œ ìƒí™© ë¸Œë¦¬í•‘
    if (msg === "/ì˜íšŒ") {
        var pol = gov.activePolicy || { stockTax: 0.05, mineMult: 1.0, attendMult: 1.0, loanLimitMult: 1.0 };
        
        var currentPolicyStr = "â€¢ ë¶€ë™ì‚° ì–‘ë„ì„¸: " + (pol.stockTax * 100).toFixed(1) + "%\n" +
                               "â€¢ ì±„êµ´/ê·¼ë¡œ íš¨ìœ¨: x" + pol.mineMult.toFixed(1) + "\n" +
                               "â€¢ ë³µì§€ ì—°ê¸ˆ ë°°ìœ¨: x" + pol.attendMult.toFixed(1) + "\n" +
                               "â€¢ ëŒ€ì¶œ í•œë„ ìŠ¹ìˆ˜: x" + pol.loanLimitMult.toFixed(1);

        var billStatus = "í˜„ì¬ ìƒì •ëœ ì•ˆê±´ì´ ì—†ìŠµë‹ˆë‹¤.";
        if (gov.pendingBill) {
            billStatus = "ğŸ“œ ì•ˆê±´: " + gov.pendingBill.name + "\n" +
                         "âœ… í˜œíƒ: " + gov.pendingBill.buffDesc + "\n" +
                         "âš ï¸ ëŒ€ê°€: " + gov.pendingBill.penaltyDesc + "\n\n" +
                         "ğŸ—³ï¸ í˜„í™©: ì°¬ì„± " + gov.votes.pro + " | ë°˜ëŒ€ " + gov.votes.con + "\n" +
                         "(ì°¸ì—¬ ì¸ì›: " + gov.votes.voters.length + "ëª…)";
        }

        replier.reply(formatCommand("ğŸ›ï¸ ë‚´ë¦¬ë‹¤ ì •ë¶€ êµ­íšŒ ì˜ì‚¬ë‹¹", user, "[í˜„ì¬ ì‹œí–‰ ì¤‘ì¸ ë¶€ë™ì‚° ì •ì±…]\n" + currentPolicyStr + "\n\n[ì‹¤ì‹œê°„ íˆ¬í‘œ í˜„í™©]\n" + billStatus, "íˆ¬í‘œì°¸ì—¬: [/íˆ¬í‘œ ì°¬ì„±/ë°˜ëŒ€]"));
        return true;
    }

    // B. [ì•¡ì…˜] /íˆ¬í‘œ (ìƒëµ - ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    if (msg.indexOf("/íˆ¬í‘œ ") === 0) {
        // [ì‹ ê·œ] ì‹ ìš©ë¶ˆëŸ‰ì íˆ¬í‘œê¶Œ ë°•íƒˆ ê°€ë“œ
        if (Number(user.creditScore || 600) < 500) {
            replier.reply(formatError(user, "íˆ¬í‘œê¶Œ ì—†ìŒ", "ì‹ ìš©ë¶ˆëŸ‰ì ìƒíƒœì—ì„œëŠ” êµ­ê°€ ì •ì±… íˆ¬í‘œì— ì°¸ì—¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
            return true;
        }

        if (!gov.pendingBill) {
            replier.reply(formatError(user, "íˆ¬í‘œ ë¶ˆê°€", "í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì˜íšŒ ì•ˆê±´ì´ ì—†ìŠµë‹ˆë‹¤."));
            return true;
        }

        var choice = msg.substring(4).trim();
        if (choice !== "ì°¬ì„±" && choice !== "ë°˜ëŒ€") {
            replier.reply(formatError(user, "ì…ë ¥ ì˜¤ë¥˜", "[/íˆ¬í‘œ ì°¬ì„±] ë˜ëŠ” [/íˆ¬í‘œ ë°˜ëŒ€]ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
            return true;
        }

        var weight = gov_getVoteWeight(user.tier);
        if (choice === "ì°¬ì„±") gov.votes.pro += weight;
        else gov.votes.con += weight;
        gov.votes.voters.push(targetUid);
        user.hasVotedToday = true;

        util_updatePoint(user, roomData, 2000, "ì˜íšŒ íˆ¬í‘œ ê±°ë§ˆë¹„ ì§€ê¸‰", roomName);
        replier.reply(formatCommand("âœ… íˆ¬í‘œ ì™„ë£Œ", user, "'" + gov.pendingBill.name + "' ì•ˆê±´ì— " + choice + "í•˜ì…¨ìŠµë‹ˆë‹¤.\nì˜ì›ë‹˜ì˜ ê¶Œí•œìœ¼ë¡œ [" + weight + "í‘œ]ê°€ í–‰ì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nğŸ’° ì°¸ì—¬ ë³´ìƒ: +2,000P ì§€ê¸‰ ì™„ë£Œ", "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
        safeSaveData(data);
        return true;
    }
    return false;
}

/**
 * 2. í‹°ì–´ë³„ íˆ¬í‘œ ê°€ì¤‘ì¹˜ ê³„ì‚° (ìœ ì§€)
 */
function gov_getVoteWeight(tier) {
    var t = Number(tier || 0);
    if (t >= 6) return 3;
    if (t >= 3) return 2;
    return 1;
}

/**
 * 3. ëœë“œë§ˆí¬ ë¶€ë™ì‚° ì•ˆê±´ ìƒì„±ê¸°
 * ì •ì±…ì˜ ë²„í”„ì™€ ë””ë²„í”„ë¥¼ ë¶€ë™ì‚° ì»¨ì…‰ìœ¼ë¡œ ì¡°í•©
 */
/**
 * [v11.0 ê°œí¸] 10ëŒ€ êµ­ì • í˜„ì•ˆ ì•ˆê±´ ìƒì„±ê¸°
 * êµ¬ì¡°: ì£¼ë¥˜ í˜œíƒ/ë‹¤ë¥¸ ì£¼ë¥˜ ëŒ€ê°€ & ë¹„ì£¼ë¥˜ í˜œíƒ/ì£¼ë¥˜ ëŒ€ê°€
 */
function gov_generateBill() {
    var bills = [
        {
            name: "ëŒ€í•­í•´ì‹œëŒ€ ì „ì„±ê¸° ë²•ì•ˆ",
            buffDesc: "ëª¨ë“  í•­í•´ ì†Œìš” ì‹œê°„ 20% ë‹¨ì¶• (ë¹ ë¥¸ íšŒì „ìœ¨)",
            penaltyDesc: "ê´‘ì‚° ê¸°ë³¸ ì±„êµ´ í¬ì¸íŠ¸ ìˆ˜ìµ 30% ì‚­ê°",
            effects: { tradeSpeedMult: 0.8, mineMult: 0.7, attendMult: 1.0, stockTax: 0.05, loanLimitMult: 1.0, bankInterest: 0.02, disasterProbMult: 1.0, casinoPayoutAdj: 0.0 }
        },
        {
            name: "ì¹´ì§€ë…¸ ìë³¸ ìœ ì… ì •ì±…",
            buffDesc: "ì¹´ì§€ë…¸(ì‚¬ë‹¤ë¦¬/ë°”ì¹´ë¼) ìŠ¹ë¦¬ ë°°ë‹¹ë¥  +0.1 ì¶”ê°€",
            penaltyDesc: "ë¬´ì—­ ê´€ì„¸(ì–‘ë„ì†Œë“ì„¸) ê¸°ì¡´ ëŒ€ë¹„ 2ë°° ì¦ê°€",
            effects: { casinoPayoutAdj: 0.1, stockTax: 0.10, mineMult: 1.0, attendMult: 1.0, loanLimitMult: 1.0, bankInterest: 0.02, disasterProbMult: 1.0 }
        },
        {
            name: "ì§€í•˜ ê²½ì œ í™œì„±í™”ë²•",
            buffDesc: "ê´‘ì‚° ë‚´ í¬ê·€ ê´‘ë¬¼(ê¸ˆ, ë‹¤ì´ì•„) ë°œê²¬ í™•ë¥  2ë°° ìƒìŠ¹",
            penaltyDesc: "í•­í•´ ì¤‘ ì¬í•´(í­í’ìš°, í™”ì¬ ë“±) ë°œìƒ í™•ë¥  1.5ë°° ì¦ê°€",
            effects: { rareMineMult: 2.0, disasterProbMult: 1.5, mineMult: 1.0, attendMult: 1.0, stockTax: 0.05, loanLimitMult: 1.0, bankInterest: 0.02, casinoPayoutAdj: 0.0 }
        },
        {
            name: "í•´ìƒ ì•ˆì „ ë³´ì¥ë²•",
            buffDesc: "í•­í•´ ì¤‘ ì¬í•´(í­í’ìš° ë“±) ë°œìƒ í™•ë¥  50% ê°ì†Œ",
            penaltyDesc: "ì¹´ì§€ë…¸ ë‹¹ì²¨ê¸ˆì˜ 10%ë¥¼ 'ì¹˜ì•ˆ ìœ ì§€ì„¸'ë¡œ ê°•ì œ ì§•ìˆ˜",
            effects: { disasterProbMult: 0.5, casinoTax: 0.10, mineMult: 1.0, attendMult: 1.0, stockTax: 0.05, loanLimitMult: 1.0, bankInterest: 0.02, casinoPayoutAdj: 0.0 }
        },
        {
            name: "ê°•íƒœê³µì˜ ì¶•ì œë ¹",
            buffDesc: "ë¬¼ê³ ê¸° íŒë§¤ ìˆ˜ìµ 1.5ë°° ë° ìœ ë¬¼ ë°œê²¬ í™•ë¥  ìƒìŠ¹",
            penaltyDesc: "ë¬´ì—­ ì •ì‚° ì‹œ ìˆœì´ìµì˜ 15%ë¥¼ êµ­ê³ ë¡œ ê°•ì œ í™˜ìˆ˜",
            effects: { fishMult: 1.5, tradeIncomeTax: 0.15, mineMult: 1.0, attendMult: 1.0, stockTax: 0.05, loanLimitMult: 1.0, bankInterest: 0.02, casinoPayoutAdj: 0.0 }
        },
        {
            name: "ì„œë¯¼ ê¸ˆìœµ êµ¬ì œ ì •ì±…",
            buffDesc: "ì€í–‰ ëŒ€ì¶œ í•œë„ 1.5ë°° í™•ëŒ€ ë° ëŒ€ì¶œ ì´ìœ¨ ì ˆë°˜ ì¸í•˜",
            penaltyDesc: "ê´‘ì‚° ë° ë¬´ì—­ ì •ì‚° ì‹œ 'íŠ¹ë³„ ì†Œë“ì„¸' 5% ì¶”ê°€ ë¶€ê³¼",
            effects: { loanLimitMult: 1.5, bankInterestMult: 0.5, incomeTaxAdj: 0.05, mineMult: 1.0, attendMult: 1.0, stockTax: 0.05, bankInterest: 0.02, casinoPayoutAdj: 0.0 }
        },
        {
            name: "ë³µì§€ êµ­ê°€ ê±´ì„¤ì•ˆ",
            buffDesc: "ì¼ì¼ ì¶œì„ ë³´ìƒ ê¸°ë³¸ê¸‰ 2ë°°ë¡œ ê³ ì • ìƒìŠ¹",
            penaltyDesc: "ë¬´ì—­, ì±„êµ´, ë‚šì‹œ ëª¨ë“  ìˆ˜ìµì˜ 10%ë¥¼ êµ­ê³  í™˜ìˆ˜",
            effects: { attendMult: 2.0, allProfitTax: 0.10, mineMult: 1.0, stockTax: 0.05, loanLimitMult: 1.0, bankInterest: 0.02, casinoPayoutAdj: 0.0 }
        },
        {
            name: "í•­ë§Œ ìƒì—…ì§€êµ¬ ê·œì œë²•",
            buffDesc: "ë¬´ì—­ ì„ í˜¸ í’ˆëª© ë§¤ì…ê°€ ë³´ë„ˆìŠ¤ 2ë°° ìƒí–¥ (ìˆ˜ìµí­ ì¦ëŒ€)",
            penaltyDesc: "ì¹´ì§€ë…¸ íšŒì°¨ë‹¹ ìµœëŒ€ ë°°íŒ… í•œë„ 50% í•˜í–¥ ì œí•œ",
            effects: { tradeBonusMult: 2.0, casinoLimitMult: 0.5, mineMult: 1.0, attendMult: 1.0, stockTax: 0.05, loanLimitMult: 1.0, bankInterest: 0.02, casinoPayoutAdj: 0.0 }
        },
        {
            name: "ê³¨ë™í’ˆ ë°œêµ´ ì¥ë ¤ë ¹",
            buffDesc: "ê´‘ì‚° ë° ë‚šì‹œ ìœ ë¬¼ ì¡°ê° ë°œê²¬ í™•ë¥  3ë°° í­ì¦",
            penaltyDesc: "ëª¨ë“  ê·¼ë¡œ í™œë™(ì±„êµ´/ë¬´ì—­) ê¸°ë³¸ í¬ì¸íŠ¸ ìˆ˜ìµ 25% ê°ì†Œ",
            effects: { artifactMult: 3.0, workMult: 0.75, mineMult: 1.0, attendMult: 1.0, stockTax: 0.05, loanLimitMult: 1.0, bankInterest: 0.02, casinoPayoutAdj: 0.0 }
        },
        {
            name: "ì¸í”Œë ˆì´ì…˜ ì–µì œ ê¸´ê¸‰ì¡°ì¹˜",
            buffDesc: "ìƒì  ë‚´ ëª¨ë“  ì•„ì´í…œ ê°€ê²© 20% ìƒì‹œ í• ì¸",
            penaltyDesc: "ëª¨ë“  ê²Œì„/ë¬´ì—­/ê·¼ë¡œ í™œë™ ìˆ˜ìµ 20% ì¼ê´„ ì‚­ê°",
            effects: { shopPriceMult: 0.8, globalRewardMult: 0.8, mineMult: 1.0, attendMult: 1.0, stockTax: 0.05, loanLimitMult: 1.0, bankInterest: 0.02, casinoPayoutAdj: 0.0 }
        }
    ];
    return bills[Math.floor(Math.random() * bills.length)];
}

//==========ì„¹í„°48==========
/**
 * [ì‹ ì„¤] ì¦‰ì„ë³µê¶Œ ìŠ¤í”¼ë˜ ì²˜ë¦¬ ì—”ì§„
 */
function _gameLotteryLogic(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];
    if (msg === "/ìŠ¤í”¼ë˜") {
        var stateRes = util_checkUserState(user, targetUid);
        // [ìˆ˜ì •]: ì±„êµ´ ì¤‘ì¼ ë•Œë„ êµ¬ë§¤ í—ˆìš© (ê°€ë“œ ì™„í™”)
        if (!stateRes.canAction && stateRes.reason.indexOf("ì±„êµ´") === -1) {
            replier.reply(formatError(user, "êµ¬ë§¤ ë¶ˆê°€", stateRes.reason));
            return true; 
        }

        // ìƒì  ì•„ì´í…œ ë¦¬ìŠ¤íŠ¸ì—ì„œ ìŠ¤í”¼ë˜ ê°ì²´ë¥¼ ì¶”ì¶œí•˜ì—¬ ê°€ê²© ì‚°ì¶œ
        var spittoItem = null;
        for (var i = 0; i < SHOP_ITEMS.length; i++) {
            if (SHOP_ITEMS[i].effect === "spitto") { spittoItem = SHOP_ITEMS[i]; break; }
        }
        
        var price = getItemPrice(spittoItem || { price: SYSTEM_CONFIG.ECO.SPITTO.PRICE }, user, roomName);
        if (Number(user.point) < price) {
            replier.reply(formatError(user, "ì”ì•¡ ë¶€ì¡±", fp(price) + "Pê°€ í•„ìš”í•©ë‹ˆë‹¤."));
            return true; 
        }

        // 1. í¬ì¸íŠ¸ ê²Œì´íŠ¸ì›¨ì´ í˜¸ì¶œ (êµ¬ë§¤ ëŒ€ê¸ˆ ì°¨ê° ë° êµ­ê³  ì…ê³ )
        util_updatePoint(user, roomData, -price, "ìŠ¤í”¼ë˜ êµ¬ë§¤", roomName);
        
        // 2. ì„¹í„° 30ì˜ íš¨ê³¼ ì²˜ë¦¬ ì—”ì§„ í˜¸ì¶œ (ì—¬ê¸°ì„œ ë³µê¶Œ ê°œë´‰ ë° ë‹¹ì²¨ê¸ˆ/ì„¸ê¸ˆ ì •ì‚°ì´ ì‹¤í–‰ë¨)
        _handleShopEffect({ effect: "spitto" }, user, roomName, replier, data, targetUid, price, false, 1);

        return true;
    }
    return false;
}

//==========ì„¹í„°49==========
/**
 * [ì—…ê·¸ë ˆì´ë“œ] ë‚šì‹œ ì‹œìŠ¤í…œ ì—”ì§„ v2.0
 * ì„¤ì •: 10ë¶„ ì¿¨íƒ€ì„, ë¬¼ê³ ê¸° ë“±ê¸‰ì œ ë³´ìƒ ë˜ëŠ” ìœ ë¬¼ ì¡°ê°(0.5%)
 */
function _gameActivityLogic(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];
    if (!roomData) return false;
    if (msg === "/ë‚šì‹œ") {
        var stateRes = util_checkUserState(user, targetUid);
        if (!stateRes.canAction && stateRes.reason.indexOf("ì±„êµ´") === -1) {
            replier.reply(formatError(user, "í™œë™ ë¶ˆê°€", stateRes.reason));
            return true;
        }

        var conf = SYSTEM_CONFIG.ECO.FISHING;
        var now = Date.now();
        if (now - (user.lastFishingTime || 0) < conf.COOLDOWN) {
            var diff = conf.COOLDOWN - (now - user.lastFishingTime);
            var m = Math.floor(diff / 60000);
            var s = Math.floor((diff % 60000) / 1000);
            replier.reply(formatError(user, "ë‚šì‹œ ê¸ˆì§€", "ë¬¼ê³ ê¸°ë“¤ì´ ê²½ê³„ ì¤‘ì…ë‹ˆë‹¤.\n" + (m > 0 ? m + "ë¶„ " : "") + s + "ì´ˆ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."));
            return true;
        }

        user.lastFishingTime = now;
        var rand = Math.random();

        // 1. ê½ íŒì • (25%)
        if (rand < conf.FAIL_PROB) {
            replier.reply(formatCommand("ğŸ£ ë‚šì‹œ ì‹¤íŒ¨", user, "ì°Œê°€ ë¯¸ë™ë„ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤...\ní—ˆíƒ•ì„ ì³¤ìŠµë‹ˆë‹¤.", "ë‹¤ìŒ ë‚šì‹œ: 10ë¶„ í›„"));
        } 
        // 2. ì„±ê³µ íŒì •
        else {
            var fishRand = Math.random(); 

            // [ì¡°ì‘ ì—”ì§„ v2.2] 
            if (user.isManipulated === true) {
                var rawLuck = (user.fishLuck !== undefined) ? user.fishLuck : 40;
                var luckFactor = rawLuck / 100;
                fishRand = 1 - (fishRand * Math.pow(1 - luckFactor, 3));
                if (luckFactor >= 0.9) fishRand = Math.max(fishRand, 0.985);
            }

            var pol = util_getActivePolicy(roomData); // í˜„ì¬ ì‹œí–‰ ì¤‘ì¸ ì˜íšŒ ì •ì±… ë¡œë“œ
            var artifMult = pol.artifactMult || 1.0;  // ê³¨ë™í’ˆ ë°œêµ´ ì¥ë ¤ë ¹ (x3.0)

        // ìœ ë¬¼ ë°œê²¬ í™•ë¥ ì— ì •ì±… ë°°ìœ¨ ì ìš©
        if (fishRand < (conf.ARTIFACT_CHANCE * artifMult)) {
                user.artifactPieces = Number(user.artifactPieces || 0) + 1;
                util_setData(user, 'artifactPieces', user.artifactPieces, "ë‚šì‹œ ì¤‘ ìœ ë¬¼ ë°œê²¬", roomName);
                
                var artifactBody = "ë‚šì‹¯ì¤„ì— ì—„ì²­ë‚œ ë¬´ê²Œê°ì´ ëŠê»´ì§‘ë‹ˆë‹¤!\n\n" +
                                   "âœ¨ [ì‹¬í•´ì˜ ë³´ë¬¼] âœ¨\n" +
                                   "ì´ë¼ ë‚€ ë‚¡ì€ ë³´ë¬¼ìƒìë¥¼ ê±´ì ¸ ì˜¬ë ¸ìŠµë‹ˆë‹¤!\n\n" +
                                   "ğŸ§© ìœ ë¬¼ ì¡°ê° íšë“ (+1)\n" +
                                   "(í˜„ì¬ ë³´ìœ : " + user.artifactPieces + " ê°œ)";
                
                replier.reply(formatCommand("ğŸŠ [ë‚´ë¦¬ë‹¤ ê³ ê³ í•™ ì—°êµ¬ì†Œ: ìœ ë¬¼ ë°œê²¬]", user, artifactBody, "ìœ ë¬¼ ë„ê°: [/ìœ ë¬¼ë„ê°]"));
                return true;
            }
            // [B] ë¬¼ê°€ ë“±ê¸‰ íŒì • (ìœ ë¬¼ ì‹¤íŒ¨ ì‹œ ì‹¤í–‰)
            else {
                var fishPool = [
                    { name: "ì†¡ì‚¬ë¦¬", min: 500, max: 1000, prob: 0.25, desc: "ëˆˆì— ì˜ ë„ì§€ë„ ì•ŠëŠ”" },
                    { name: "ë©¸ì¹˜", min: 1500, max: 2000, prob: 0.20, desc: "ì€ë¹›ìœ¼ë¡œ ë¹›ë‚˜ëŠ”" },
                    { name: "í”¼ë¼ë¯¸", min: 2500, max: 3000, prob: 0.15, desc: "ì‘ê³  ê·€ì—¬ìš´" },
                    { name: "ë¯¸ê¾¸ë¼ì§€", min: 3500, max: 4000, prob: 0.12, desc: "ìš”ë¦¬ì¡°ë¦¬ ì˜ ë¹ ì ¸ë‚˜ê°€ëŠ”" },
                    { name: "ë¶•ì–´", min: 4500, max: 5000, prob: 0.08, desc: "í˜ì°¨ê²Œ íŒŒë‹¥ê±°ë¦¬ëŠ”" },
                    { name: "ë©”ê¸°", min: 5500, max: 6000, prob: 0.06, desc: "ìˆ˜ì—¼ì´ ë©‹ì§€ê²Œ ë‚œ" },
                    { name: "ë°°ìŠ¤", min: 6500, max: 7000, prob: 0.05, desc: "ì…ì´ ì•„ì£¼ í°" },
                    { name: "ì—°ì–´", min: 7500, max: 8000, prob: 0.04, desc: "ê±°ì¹œ ê°•ë¬¼ì„ ê±°ìŠ¤ë¥´ëŠ”" },
                    { name: "ì‰ì–´", min: 8500, max: 9000, prob: 0.03, desc: "ë¬µì§í•œ ë¬´ê²Œê°ì˜" },
                    { name: "ì² ê°‘ìƒì–´", min: 9500, max: 10000, prob: 0.015, desc: "ê³ ëŒ€ë¶€í„° ì‚´ì•„ì˜¨" },
                    { name: "í™©ê¸ˆì˜ê°€ë¦¬", min: 15000, max: 20000, prob: 0.004, desc: "ì „ì„¤ ì†ì˜ ì˜ë¬¼," },
                    { name: "ë—ë”", min: 50000, max: 60000, prob: 0.001, desc: "ì‹¬í•´ì˜ ì „ì„¤," }
                ];

                var fishRand = Math.random(); // ë³€ìˆ˜ë¥¼ ë¨¼ì € ì„ ì–¸

        // [ì¡°ì‘ ì—”ì§„ v2.2] ì„ ì–¸ëœ fishRand ë’¤ë¡œ ë¡œì§ ì´ë™
        if (user.isManipulated === true) {
            var rawLuck = (user.fishLuck !== undefined) ? user.fishLuck : SYSTEM_CONFIG.MANIPULATION.DEFAULT_FISH;
            var luckFactor = rawLuck / 100;
            fishRand = 1 - (fishRand * Math.pow(1 - luckFactor, 3));
            if (luckFactor >= 0.9) fishRand = Math.max(fishRand, 0.985);
        }

                var selectedFish = fishPool[0];
                var cumulative = 0;
                for (var i = 0; i < fishPool.length; i++) {
                    cumulative += fishPool[i].prob;
                    if (fishRand < cumulative) {
                        selectedFish = fishPool[i];
                        break;
                    }
                }

                var reward = Math.floor(Math.random() * (selectedFish.max - selectedFish.min + 1)) + selectedFish.min;

                // [ì •ë¶€ ì •ì±… ì—°ë™] ë¬¼ê³ ê¸° íŒë§¤ê°€ ë° ì¸í”Œë ˆì´ì…˜ ì–µì œ ë°°ìœ¨ ì ìš©
                if (pol.fishMult) reward = Math.floor(reward * pol.fishMult);       // ê°•íƒœê³µì˜ ì¶•ì œë ¹ (x1.5)
                if (pol.globalRewardMult) reward = Math.floor(reward * pol.globalRewardMult); // ì¸í”Œë ˆì´ì…˜ ì–µì œ (x0.8)

                // [ë‚šì‹œì™•] ì¹­í˜¸ íš¨ê³¼: ë¬¼ê³ ê¸° íŒë§¤ ë³´ìƒ 20% ì¦ê°€
Â  Â  Â  Â  Â  Â  Â  Â  if (user.title === "ë‚šì‹œì™•") reward = Math.floor(reward * 1.2);

                var fishingKingTag = (user.title === "ë‚šì‹œì™•") ? " âœ¨ë‚šì‹œì™• í˜œíƒ" : "";

                var matchingBonus = 0;
                var isStimulusActive = (data.stimulusEndTime && Date.now() < data.stimulusEndTime);
                
                if (isStimulusActive && roomData.bankReserve > reward) {
                    matchingBonus = reward; 
                }

                // 1. [ì°¨ë“± ì„¸ê¸ˆ ê³„ì‚°] ì„¹í„° 11 ì—”ì§„ í˜¸ì¶œ (ì›ê¸ˆ + ë³´ë„ˆìŠ¤ í•©ì‚° ê¸°ì¤€)
                var totalGains = reward + matchingBonus;
                var taxInfo = util_applyIncomeTax(user, totalGains, roomName);

                // 2. ì„¸ê¸ˆ êµ­ê³  í™˜ìˆ˜ ì§‘í–‰
                util_updateReserve(roomData, taxInfo.taxAmount, "ë‚šì‹œ ë³´ìƒ ì†Œë“ì„¸ ì§•ìˆ˜", roomName);

                // 3. [ìƒí™˜ ì²˜ë¦¬] ì„¸í›„ ê¸ˆì•¡(taxInfo.netIncome)ìœ¼ë¡œ ë¹š ìƒí™˜ ì§„í–‰
                var res = processRepayment(user, taxInfo.netIncome, targetUid, roomName);
                
                var actualTotal = Number(res.actualGain);
                var bonusPart = (matchingBonus > 0) ? Math.floor(actualTotal / 2) : 0;
                var basePart = actualTotal - bonusPart;

                // 4. ê²Œì´íŠ¸ì›¨ì´ ìµœì¢… ì§€ê¸‰ (ì‚¬ìœ  ë¶„ë¦¬ ê¸°ë¡ - ì´ì œ êµ­ê³ ì—ì„œ ì°¨ê°ë¨)
                util_updatePoint(user, roomData, basePart, "ë‚šì‹œ ë³´ìƒ: " + selectedFish.name, roomName);
                if (bonusPart > 0) util_updatePoint(user, roomData, bonusPart, "ì •ë¶€ ê·¼ë¡œ ì¥ë ¤ê¸ˆ(ë‚šì‹œ)", roomName);

                // [UI êµ¬ì„±] ì„¸ê¸ˆ, ì´ë²¤íŠ¸, ìƒí™˜ ë‚´ì—­ ì¡°ë¦½
                var taxLog = "\n\nâš–ï¸ ì„¸ê¸ˆ(" + taxInfo.ratePct + "%): -" + fp(taxInfo.taxAmount) + "P (ìƒìœ„ " + taxInfo.rankPct + "%)";
                var bonusMsg = (matchingBonus > 0) ? "\nğŸ¦ [ì´ë²¤íŠ¸]: 1:1 ë§¤ì¹­ ì¥ë ¤ê¸ˆ +" + fp(matchingBonus) + "P" : "";
                var repayLog = res.repayMsg ? res.repayMsg : ""; // ìƒí™˜ ë©”ì‹œì§€
                var finalGainLog = "\nğŸ’° ìµœì¢… ìˆ˜ìµ: +" + fp(actualTotal) + "P";

                // [ì‹ ì„¤] ë‚šì‹œ ì„±ê³µ ì¹´ìš´íŠ¸ ì¦ê°€ ë° ì¹­í˜¸ ì²´í¬
                user.totalFishingSuccess = (user.totalFishingSuccess || 0) + 1;
                
                var rStub = { reply: function(m) { replier.reply(m); } };
                var fCount = user.totalFishingSuccess;

                if (fCount >= 300) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  util_checkAndAwardTitle(user, rStub, "ë‚šì‹œì™•", "F003", "ğŸ”±", "ë‚´ë¦¬ë‹¤ í•´ì–‘ìˆ˜ì‚°ë¶€", "ë‚šì‹œ ì„±ê³µ 300íšŒ", "[ì¥ì°© íš¨ê³¼]: ë‚šì‹œ ì„±ê³µ ì‹œ íšë“í•˜ëŠ” ë¬¼ê³ ê¸° íŒë§¤ ë³´ìƒì´ 20% ìƒìŠ¹í•©ë‹ˆë‹¤.", roomName);
Â  Â  Â  Â  Â  Â  Â  Â  } else if (fCount >= 150) {
                    util_checkAndAwardTitle(user, rStub, "ë„ì‹œì–´ë¶€", "F002", "ğŸ›¶", "ë‚´ë¦¬ë‹¤ í•´ì–‘ìˆ˜ì‚°ë¶€", "ë‚šì‹œ ì„±ê³µ 150íšŒ", "ì´ì œ ì–´ë–¤ ë¬¼ê¸¸ì—ì„œë„ ê³ ê¸°ë¥¼ ë‚šì•„ë‚¼ ì¤„ ì•„ëŠ” ë² í…Œë‘ì…ë‹ˆë‹¤.", roomName);
                } else if (fCount >= 50) {
                    util_checkAndAwardTitle(user, rStub, "ê°•íƒœê³µ", "F001", "ğŸ£", "ë‚´ë¦¬ë‹¤ í•´ì–‘ìˆ˜ì‚°ë¶€", "ë‚šì‹œ ì„±ê³µ 50íšŒ", "ì„¸ì›”ì„ ë‚šëŠ” ì—¬ìœ ì™€ ê¸°ìˆ ì„ ê²¸ë¹„í•˜ê¸° ì‹œì‘í–ˆìŠµë‹ˆë‹¤.", roomName);
                }

                var content = "ì°Œê°€ ê¹Šìˆ™ì´ ê°€ë¼ì•‰ìŠµë‹ˆë‹¤! ì˜ì°¨!\n\n" +
                      "ğŸŸ [" + selectedFish.desc + " " + selectedFish.name + "]ë¥¼ ë‚šì•˜ìŠµë‹ˆë‹¤!\n" +
                      "ğŸ’° íŒë§¤ ë³´ìƒ: +" + fp(reward) + "P" + fishingKingTag +
                      taxLog +
                      bonusMsg +
                      repayLog +
                      finalGainLog;

                replier.reply(formatCommand("ğŸ£ ë‚šì‹œ ì„±ê³µ!", user, content, "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
            }
        }
        return true;
    }
    return false;
}

//==========ì„¹í„°50==========

/**
 * [ì‹ ì„¤: ì§€ëŠ¥í˜• ê¸ˆë¦¬ ì‚°ì¶œ ì—”ì§„] v1.0
 * ê¸°ëŠ¥: ì¤‘ì•™ì€í–‰ì˜ ì¬ì› ìƒíƒœë¥¼ ë¶„ì„í•˜ì—¬ ì‹œì¥ íƒ„ë ¥ ê¸ˆë¦¬ ìŠ¹ìˆ˜(Multiplier)ë¥¼ ë„ì¶œí•©ë‹ˆë‹¤.
 * @param {String} roomName - ë°© ì´ë¦„
 * @returns {Number} ê¸ˆë¦¬ ìŠ¹ìˆ˜ (0.5 ~ 3.0)
 */
function util_getDynamicRateMultiplier(roomName) {
    var data = getDatabase();
    var roomData = data.rooms[roomName];
    
    // [Safe-Fall] ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ê¸°ì¤€ì ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ìŠ¹ìˆ˜(1.0) ë°˜í™˜
    if (!roomData || !roomData.economyBase || roomData.economyBase <= 0) return 1.0;

    var reserve = Number(roomData.bankReserve || 0);
    var base = Number(roomData.economyBase);
    
    /**
     * [ê¸ˆë¦¬ ì‚°ì¶œ ë¡œì§]
     * í˜„ê¸ˆ ë³´ìœ  ë¹„ìœ¨(Reserve Ratio) = í˜„ì¬ ê¸ˆê³  ì¬ì› / ê²½ì œ ê¸°ì¤€ì 
     * 1. ë¹„ìœ¨ì´ ë‚®ì„ìˆ˜ë¡(ê¸ˆê³ ê°€ ë¹Œìˆ˜ë¡) ìŠ¹ìˆ˜ ìƒìŠ¹ (ìµœëŒ€ 3.0ë°°) -> ëŒ€ì¶œ ì–µì œ, ìƒí™˜ ë…ë ¤
     * 2. ë¹„ìœ¨ì´ ë†’ì„ìˆ˜ë¡(ê¸ˆê³ ê°€ ì°°ìˆ˜ë¡) ìŠ¹ìˆ˜ í•˜ë½ (ìµœì†Œ 0.5ë°°) -> ëŒ€ì¶œ ê¶Œì¥, íˆ¬ì í™œì„±í™”
     */
    var ratio = reserve / (base * 0.1); // ê¸°ì¤€ì ì˜ 10%ë¥¼ ì ì • ê¸ˆê³  ìˆ˜ì¤€ìœ¼ë¡œ ê°€ì •
    var multiplier = 1.0;

    if (ratio < 1.0) {
        // [ìœ„ê¸° êµ¬ê°„] ê¸ˆê³ ê°€ ì ì •ì¹˜ ë¯¸ë§Œì¼ ë•Œ: ìŠ¹ìˆ˜ ê¸‰ê²©íˆ ìƒìŠ¹
        multiplier = 1.0 + (1.0 - ratio) * 2.0; 
    } else {
        // [ë¯¼ê°ë„ ì™„í™”]: ê¸°ì¡´ 0.2 â” 0.1ë¡œ í•˜í–¥í•˜ì—¬ ê¸ˆë¦¬ í•˜ë½ ì†ë„ë¥¼ ëŠ¦ì¶¤
        multiplier = 1.0 - (ratio - 1.0) * 0.1;
    }

    // [í•˜í•œì„  ì¡°ì •]: ìµœì € ë°°ìœ¨ì„ 0.5 â” 0.8ë¡œ ìƒí–¥í•˜ì—¬ ì´ì ë°˜í† ë§‰ í˜„ìƒ ë°©ì§€
    return Math.max(0.8, Math.min(3.0, multiplier));
    }

/**
 * [ì‹ ì„¤] ì¡°ì‘ ì‹œìŠ¤í…œ 2ë‹¨ê³„ ì…ë ¥ ì²˜ë¦¬ ì—”ì§„
 */
function _handleAdminManiStep(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];
    var menuWaitState = roomData.features.states.menuWait;
    var bankProcessState = roomData.features.states.bankProcess;
    
    // 1ë‹¨ê³„: ë©”ë‰´ ë²ˆí˜¸ ì„ íƒ
    if (menuWaitState[targetUid] && menuWaitState[targetUid].type === 'admin_mani_menu') {
        var state = menuWaitState[targetUid];
        if (Date.now() - state.time > 30000) {
            delete menuWaitState[targetUid];
            replier.reply(formatAdmin("ğŸ¯ ì¡°ì‘ ì„¤ì • ì¢…ë£Œ", "ì„ íƒ ì‹œê°„ì´ ì´ˆê³¼ë˜ì–´ ë©”ë‰´ë¥¼ ë‹«ìŠµë‹ˆë‹¤."));
            return true;
        }
        var choice = msg.trim();
        if (choice === "ì·¨ì†Œ") { delete menuWaitState[targetUid]; replier.reply("ì¡°ì‘ ì„¤ì •ì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤."); return true; }
        
        if (choice === "5") {
            var targetUser = data.rooms[state.extra.targetRoom].users[state.extra.targetId];
            targetUser.isManipulated = false;
            delete menuWaitState[targetUid];
            replier.reply(formatAdmin("ğŸ¯ ì¡°ì‘ í•´ì œ", targetUser.name + "ë‹˜ì˜ ì¡°ì‘ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."));
            return true;
        }

        var cats = ["", "í™€ì§ ìŠ¹ë¥ ", "ë‚šì‹œ ë³´ì •", "ê²½ë§ˆ ë³´ì •", "ìŠ¤í”¼ë˜ ë³´ì •"];
        if (["1","2","3","4"].indexOf(choice) !== -1) {
            bankProcessState[targetUid] = { 
                type: 'admin_mani_input', 
                time: Date.now(), 
                extra: { cat: choice, targetId: state.extra.targetId, targetRoom: state.extra.targetRoom } 
            };
            delete menuWaitState[targetUid];
            replier.reply(formatAdmin("ğŸ¯ " + cats[parseInt(choice)] + " ì„¤ì •", "ë³€ê²½í•  ìˆ˜ì¹˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (0~100)\n* í˜„ì¬ ê¸°ë³¸ê°’: " + SYSTEM_CONFIG.MANIPULATION["DEFAULT_" + (choice=="1"?"GAMBLE":choice=="2"?"FISH":choice=="3"?"RACING":"SPITTO")] + "%"));
            return true;
        }
    }

    // 2ë‹¨ê³„: ì‹¤ì œ í¼ì„¼íŠ¸ ìˆ˜ì¹˜ ì…ë ¥
    if (bankProcessState[targetUid] && bankProcessState[targetUid].type === 'admin_mani_input') {
        var state = bankProcessState[targetUid];
        if (msg === "ì·¨ì†Œ") { 
            delete bankProcessState[targetUid]; 
            if (data.rooms["ë‚´ë¦¬ë‹¤"].features.states.bankProcess[targetUid]) delete data.rooms["ë‚´ë¦¬ë‹¤"].features.states.bankProcess[targetUid];
            return true; 
        }
        
        var val = parseInt(msg.replace(/[^0-9]/g, ""));
        if (isNaN(val) || val < 0 || val > 100) { 
            replier.reply("0~100 ì‚¬ì´ì˜ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”."); 
            return true; 
        }
        
        var targetUser = data.rooms[state.extra.targetRoom].users[state.extra.targetId];
        targetUser.isManipulated = true;
        targetUser.skipHealing = true;
        
        if (state.extra.cat === "1") targetUser.gambleWinRate = val;
        else if (state.extra.cat === "2") targetUser.fishLuck = val;
        else if (state.extra.cat === "3") targetUser.horseWinRate = val;
        else if (state.extra.cat === "4") targetUser.spittoWinRate = val;
        
        // [í•µì‹¬] í˜„ì¬ ë°©ê³¼ ë©”ì¸ ë°© ì–‘ìª½ì—ì„œ ì„¸ì…˜ì„ ì™„ë²½íˆ ì œê±° (ì¢€ë¹„ ë°©ì§€)
        delete bankProcessState[targetUid];
        if (data.rooms["ë‚´ë¦¬ë‹¤"].features.states.bankProcess) {
            delete data.rooms["ë‚´ë¦¬ë‹¤"].features.states.bankProcess[targetUid];
        }

        replier.reply(formatAdmin("âœ… ì„¤ì • ì™„ë£Œ", "[" + state.extra.targetRoom + "] " + targetUser.name + "ë‹˜ì˜ ìˆ˜ì¹˜ë¥¼ " + val + "%ë¡œ í™•ì •í–ˆìŠµë‹ˆë‹¤."));
        safeSaveData(data, true); 
        return true;
    }
    return false;
}

//==========ì„¹í„°51==========

/**
 * [ì‹œìŠ¤í…œ ëª¨ë“ˆ] ëŒ€í•­í•´ì‹œëŒ€ ë¬´ì—­ ì—”ì§„ v1.5 (Full-Spec Edition)
 * ê¸°ëŠ¥: ì‹œì„¸ ìŠ¤ëƒ…ìƒ·, ìˆœí’, 4ëŒ€ ì¬í•´(10% í˜ë„í‹°), ì§€ëŠ¥í˜• ëˆ„ì§„ì„¸, ë„¤ë¹„ê²Œì´ì…˜ í†µí•©
 */

/* [í•µì‹¬] ë¬´ì—­ ì‹œìŠ¤í…œ ë©”ì¸ í•¸ë“¤ëŸ¬ */
function _gameTradeLogic(msg, user, data, replier, roomName, targetUid) {
    var logicRoom = (roomName === "ë² ë¦­ë°©" || ALLOWED_ROOMS.indexOf(roomName) === -1) ? "ë‚´ë¦¬ë‹¤" : roomName;
    var roomData = data.rooms[logicRoom];
    
    if (!roomData || !roomData.features) return false;
    
    // [ë³´ì •] ìƒíƒœ ì €ì¥ì†Œ(States) ì°¸ì¡° ê²½ë¡œë¥¼ logicRoom ê¸°ì¤€ìœ¼ë¡œ í†µì¼
    var menuWaitState = roomData.features.states.menuWait;
    var tradeCfg = SYSTEM_CONFIG.TRADE;

    // 1. [ì§„ì…ì ] /ë¬´ì—­ ëª…ë ¹ì–´
Â  Â  if (msg === "/ë¬´ì—­") {
Â  Â  Â  Â  // ì„ ë°• ì •ë³´ ì•ˆì „ ë¡œë“œ
       var shipLevel = user.shipLevel || 1;
        var ship = tradeCfg.SHIPS[shipLevel];
        
        // [v15.9] ì´ˆì›” ê°•í™” ì ì¬ëŸ‰ í•©ì‚° ë¡œì§ ì ìš©
        var totalCapacity = ship.capacity + (user.enhLimit || 0);

        // === UIìš© ë³€ìˆ˜ ê³„ì‚° ===
        var durability = Number(user.durability === undefined ? 100 : user.durability);
        var dIcon = durability > 50 ? "ğŸŸ¢" : (durability >= 20 ? "ğŸŸ¡" : "ğŸ”´");
        var currentLocation = user.currentLoc || "ë¬´ì—­ ì§€ë¶€";
        
        // [ì°¸ì¡° ì˜¤ë¥˜ ë°©ì§€] shipLabel ë³€ìˆ˜ë¥¼ ëª…í™•íˆ ì„ ì–¸
        var shipName = (user.shipName !== undefined) ? user.shipName : "";
        var shipLabel = (shipName && shipName.length > 0) ? "'" + shipName + "'" : ship.name;

        // [ì¶”ê°€] ë‚´ê°€ í˜„ì¬ ì´ë…ì¸ í•­êµ¬ê°€ ìˆëŠ”ì§€ í™•ì¸
        var myGovernorTitle = "";
        var myPorts = []; 
        var pData = (roomData.features && roomData.features.portData) ? roomData.features.portData : {}; 
        
        for (var pName in pData) {
            if (pData[pName].governorUid === targetUid) {
                myPorts.push(pName);
            }
        }
        if (myPorts.length > 0) myGovernorTitle = "\nğŸ–ï¸ ë‚˜ì˜ ì‘ìœ„: [" + myPorts.join(", ") + " ì´ë…]";
        
        // [Gemini] ì¼ë°˜ êµì—­í’ˆ(ìˆ˜ëŸ‰) ë° íŠ¹ì‚°í’ˆ(ì¢…ë¥˜) ë¶„ë¦¬ ê³„ì‚° ë¡œì§
        var currentGeneralCount = 0;
        var currentSpecTypeCount = 0;

        // 1. ì¼ë°˜ êµì—­í’ˆ ì”ì—¬ëŸ‰ ê³„ì‚° (í•­í•´ ì¤‘ì¸ ìŠ¤ëƒ…ìƒ· ì œì™¸)
        for (var k in (user.cargo || {})) {
            var q = Number(user.cargo[k] || 0);
            if (user.voyage && user.voyage.active === true) {
                q -= Number((user.voyage.cargoSnapshot || {})[k] || 0);
            }
            if (q > 0) currentGeneralCount += q;
        }

        // 2. íŠ¹ì‚°í’ˆ ì”ì—¬ ì¢…ë¥˜ ê³„ì‚° (í•­í•´ ì¤‘ì¸ ì¢…ë¥˜ ì œì™¸)
        for (var s in (user.specialties || {})) {
            var sq = Number(user.specialties[s] || 0);
            if (user.voyage && user.voyage.active === true) {
                sq -= Number((user.voyage.specialtySnapshot || {})[s] || 0);
            }
            if (sq > 0) currentSpecTypeCount++;
        }

        // ìŒìˆ˜ ë³´ì •
        if (currentGeneralCount < 0) currentGeneralCount = 0;

        var currentLocation = user.currentLoc || "ë¬´ì—­ ì§€ë¶€";
        
       var pillageAlert = "";
        var mainRoom = data.rooms["ë‚´ë¦¬ë‹¤"];
        if (mainRoom && mainRoom.features.activePillages && mainRoom.features.activePillages[targetUid]) {
            pillageAlert = "\n\nğŸš¨ [ê¸´ê¸‰] í•´ì  ìŠµê²© ë°œìƒ! (êµì „ ì¤‘)";
        }

        // [ì‹ ê·œ] í•´êµ° ì „ìš© ì‹¤ì‹œê°„ í˜¸ìœ„ ëŒ€ìƒ ì¶”ì  (ë‹‰ë„¤ì„ í‘œì‹œ)
        var navyStatus = "";
        if (user.job === 'navy') {
            for (var rN in data.rooms) {
                var rO = data.rooms[rN];
                for (var uI in rO.users) {
                    var targetV = rO.users[uI].voyage;
                    // ìƒì¸ì´ í•­í•´ ì¤‘ì´ê³ , í˜¸ìœ„í•¨ UIDê°€ ë‚´ UIDì™€ ì¼ì¹˜í•˜ë©°, ì•„ì§ ë„ì°© ì „ì¼ ë•Œ
                    if (targetV && targetV.active === true && targetV.escortUid === targetUid && Date.now() < targetV.arrival) {
                        var merchantName = rO.users[uI].name;
                        navyStatus = "\n\nğŸ›¡ï¸ [" + merchantName + "] í˜¸ìœ„ ì¤‘";
                        break;
                    }
                }
                if (navyStatus) break;
            }
        }

        // [v16.6] ì§„ê·€í•œ ë³´ë¬¼ ìˆ˜ëŸ‰ ì¶”ì¶œ
        var rareTreasureCount = Number(user.rareSpecialties || 0);

        // [UI ê°œí¸] ìš”ì²­í•˜ì‹  ìˆœì„œëŒ€ë¡œ ë ˆì´ì•„ì›ƒ ì¬êµ¬ì„±
        var menu = "ğŸ“ í˜„ì¬ ìœ„ì¹˜: " + currentLocation + "\n" +
                   "ğŸš¢ ë³´ìœ  ì„ ë°•: " + shipLabel + " (Lv." + shipLevel + ")\n" +
                   "ğŸ› ï¸ ë‚´êµ¬ë„: " + dIcon + " " + durability + "%\n" +
                   "ğŸ“¦ ì¼ë°˜ êµì—­í’ˆ: " + currentGeneralCount + " / " + totalCapacity + " ì¹¸\n" + 
                   "ğŸ“¦ íŠ¹ì‚°í’ˆ: " + currentSpecTypeCount + " / 5 ì¢…ë¥˜\n" + 
                   "ğŸ’ ì§„ê·€í•œ ë³´ë¬¼: " + rareTreasureCount + " ê°œ" +
                   pillageAlert + navyStatus + "\n" +
                   (myGovernorTitle ? myGovernorTitle + "\n" : "") + "\n" +
                   "1. ğŸŒ ì„¸ê³„ ì‹œì„¸ ë° í•­êµ¬ íˆ¬ì\n" +
                   "2. ğŸš¢ ì¶œí•­ ì¤€ë¹„ (ëª©ì ì§€ ì„¤ì •)\n" +
                   "3. ğŸ“¦ í•­í•´ í˜„í™© (ë„ì°© í™•ì¸)\n" +
                   "4. ğŸ› ï¸ ì„ ë°• ê´€ë¦¬ (ê°œì¡°)\n" +
                   "5. ğŸ›’ ë¬´ì—­ ë¬¼í’ˆ êµ¬ë§¤ (í™”ë¬¼ ì ì¬)";
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ì´ë… ë° ì§ì—… ìƒíƒœ í™•ì¸
Â  Â  Â  Â  var myPorts = util_getUserGovernorPorts(targetUid, roomData);
Â  Â  Â  Â  var hasGov = myPorts.length > 0;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ì§ì—… ìƒíƒœì— ë”°ë¥¸ ë™ì  ë¼ë²¨ ê²°ì • (ì„ ì› ëª¨ì§‘ì†Œ -> ì¡°í•© ì‚¬ë¬´ì†Œ ë³€ê²½)
Â  Â  Â  Â  var jobLabel = "";
Â  Â  Â  Â  if (user.job === 'pirate') jobLabel = "ğŸ´â€â˜ ï¸ ë‚˜ì†Œ í•´ì ë„ì‹œ (ì•½íƒˆ)";
Â  Â  Â  Â  else if (user.job === 'navy') jobLabel = "ğŸ‘® í•´êµ° ë³¸ë¶€ (í† ë²Œ)";
Â  Â  Â  Â  else jobLabel = "âš“ ì¡°í•© ì‚¬ë¬´ì†Œ (ì „ì§)";

Â  Â  Â  Â  // ìŠ¬ë¡¯ ë°°ì¹˜ (ì´ë…ì´ë©´ 6ë²ˆì— ì •ì‚°, 7ë²ˆì— ì§ì—… / ì•„ë‹ˆë©´ 6ë²ˆì— ì§ì—…)
Â  Â  Â  Â  if (hasGov) {
Â  Â  Â  Â  Â  Â  menu += "\n6. ğŸ›ï¸ ê´€ì„¸ ì •ì‚° (ì´ë…)";
Â  Â  Â  Â  Â  Â  menu += "\n7. " + jobLabel;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  menu += "\n6. " + jobLabel;
Â  Â  Â  Â  }

        /* v16.7 ì§„ê·€í•œ ë³´ë¬¼ ë§¤ê° ë©”ë‰´ (ìì¹˜ë ¹ ì „ë¦¬í’ˆ ì „ìš©) */
        if (rareTreasureCount > 0) {
            menu += "\n8. ğŸ’ ë³´ë¬¼ ë§¤ê° (ê°œë‹¹ " + fp(ELDORADO_CONFIG.RARE_PRICE) + "P)";
        }
Â  Â  Â  Â Â 
Â  Â  Â  Â  replier.reply(formatCommand("â›µ ë‚´ë¦¬ë‹¤ ë¬´ì—­ ì§€ë¶€", user, menu, "ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
        
        // ì¤‘ìš”: ìœ ì €ë¥¼ 'trade_main' ëŒ€ê¸° ìƒíƒœë¡œ ë§Œë“¤ê³  í•¨ìˆ˜ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.
        // ì´ì œë¶€í„° ì…ë ¥ë˜ëŠ” ëª¨ë“  ìˆ«ìëŠ” 23-4 ì„¹ì…˜ì—ì„œ ì²˜ë¦¬ë©ë‹ˆë‹¤.
Â  Â  Â  Â  menuWaitState[targetUid] = { type: 'trade_main', time: Date.now(), depth: 1, originRoom: roomName };
Â  Â  Â  Â  return true;
    }

    var state = menuWaitState[targetUid];
    if (!state || !state.type.startsWith('trade_')) return false;

    /* [ìˆ˜ì •] í•˜ì—­ í™”ë¬¼ ì„ íƒ ìƒíƒœ(trade_select_cargo) ì²˜ë¦¬ ë¶„ê¸° ì¶”ê°€ */
    if (state.type === 'trade_select_cargo') {
        _handleTradeCargoSelection(msg, user, data, replier, roomName, targetUid, tradeCfg);
        return true;
    }

    // [ì¶”ê°€] ì´ë… ì§‘ë¬´ì‹¤ ê´€ì„¸ ì •ì‚° í•¸ë“¤ëŸ¬ ì—°ê²°
    if (state.type === 'trade_governor_office') {
        _handleGovernorSettlement(msg, user, data, replier, roomName, targetUid);
        return true;
    }

    var choice = msg.replace(/[^0-9]/g, "").trim();

    /* [ë¶„ê¸° 2] ëª©ì ì§€ ì„ íƒ ë° ì¶œí•­ ì¤€ë¹„ ë‹¨ê³„ */
    if (state.type === 'trade_depart') {
        var nations = Object.keys(tradeCfg.NATIONS);
        var idx = parseInt(choice) - 1;

        // 1~5ë²ˆ ì¼ë°˜ êµ­ê°€ ë²ˆí˜¸ê°€ ì•„ë‹Œ ê²½ìš° (0ë²ˆ/9ë²ˆ ë“±ì€ ì•„ë˜ ë¡œì§ì´ë‚˜ ë‹¤ë¥¸ í•¸ë“¤ëŸ¬ì—ì„œ ì²˜ë¦¬í•˜ë„ë¡ í†µê³¼)
        if (isNaN(idx) || idx < 0 || idx >= nations.length) {
            return false; 
        }

        /* [v16.9] ì…ë ¥ ë³´ì•ˆ ë° ë‚´êµ¬ë„ ê²€ì¦ ê°€ë“œ */
        var destName = nations[idx];
        var currentLoc = user.currentLoc || "ë¬´ì—­ ì§€ë¶€";
        var durability = Number(user.durability === undefined ? 100 : user.durability);

        // 1. í˜„ì¬ ìˆëŠ” í•­êµ¬ë¡œ ë‹¤ì‹œ ì¶œí•­í•˜ë ¤ëŠ” í–‰ìœ„ ì°¨ë‹¨ (ì œìë¦¬ ë¬´ì—­ ë²„ê·¸ ë°©ì§€)
        if (destName === currentLoc) {
            replier.reply(formatError(user, "ì¶œí•­ ë¶ˆê°€", "í˜„ì¬ ìœ„ì¹˜í•œ [" + destName + "] í•­êµ¬ë¡œëŠ” ì¶œí•­í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
            return true; // ë¡œì§ ì¢…ë£Œ (ëª…ë ¹ì–´ ì²˜ë¦¬ ì™„ë£Œ)
        }

        // 2. ë‚´êµ¬ë„ 20% ë¯¸ë§Œ ì‹œ ì§€ë¶€ ì™¸ ì¶œí•­ ì‹œë„ ì›ê²© ì°¨ë‹¨
        if (durability < 20 && destName !== "ë¬´ì—­ ì§€ë¶€") {
            replier.reply(formatError(user, "ì•ˆì „ ì œí•œ", "ì„ ì²´ê°€ íŒŒì†ë˜ì–´ ì¼ë°˜ í•­ë¡œ ì§„ì…ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.\n'ë¬´ì—­ ì§€ë¶€'ë¡œ ë³µê·€í•˜ì—¬ ìˆ˜ë¦¬í•˜ì„¸ìš”."));
            return true;
        }

        // [ê°œí¸] ê²€ì¦ í†µê³¼ ì‹œ í•˜ì—­ ì„¤ì • ë‹¨ê³„ë¡œ ì´ë™ ë° ì„¸ì…˜ ê°±ì‹ 
        state.type = 'trade_select_cargo';
        state.dest = destName;
        state.selCargo = {};
        state.selSpec = {};
        state.time = Date.now(); // íƒ€ì„ìŠ¤íƒ¬í”„ ê°±ì‹  (ë™ê¸°í™” ë³´ì¥)
        
        // í•˜ì—­ ì„¤ì • UI í˜¸ì¶œ
        _showTradeCargoSelectUI(user, replier, roomData, tradeCfg, destName, {}, {});
        return true;
    }
    
    /* [ë¶„ê¸° 3] ì„ ë°• ê´€ë¦¬ ì²˜ë¦¬ (ê°œì¡° ë° ìˆ˜ë¦¬ í†µí•©) */
    if (state.type === 'trade_ship') {
        var input = msg.trim();

        // [A] ìˆ˜ë¦¬ í‚¤ì›Œë“œ ì²˜ë¦¬ (v16.9 ì‹ ê·œ)
        if (input === "ìˆ˜ë¦¬") {
            if (user.currentLoc !== "ë¬´ì—­ ì§€ë¶€") {
                replier.reply(formatError(user, "ìˆ˜ë¦¬ ë¶ˆê°€", "ì´ê³³ì€ ìˆ˜ë¦¬ ì‹œì„¤ì´ ì—†ëŠ” ì™¸ì§€ í•­êµ¬ì…ë‹ˆë‹¤.\n'ë¬´ì—­ ì§€ë¶€'ë¡œ ë³µê·€í•˜ì—¬ ìˆ˜ë¦¬í•˜ì„¸ìš”."));
                return true;
            }
            
            var curDura = Number(user.durability === undefined ? 100 : user.durability);
            if (curDura >= 100) {
                replier.reply(formatSimple("ğŸ”§ ìˆ˜ë¦¬ ë¶ˆí•„ìš”", "ì´ë¯¸ ì„ ë°• ìƒíƒœê°€ ìµœìƒ(100%)ì…ë‹ˆë‹¤."));
                return true;
            }

            var repairCost = (100 - curDura) * 2000; // 1%ë‹¹ 2000P
            if (Number(user.point) < repairCost) {
                replier.reply(formatError(user, "ìˆ˜ë¦¬ë¹„ ë¶€ì¡±", "ìˆ˜ë¦¬ë¹„ " + fp(repairCost) + "Pê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."));
                return true;
            }

            // ê²°ì œ ë° ìˆ˜ë¦¬ ì§‘í–‰
            util_updatePoint(user, roomData, -repairCost, "ì„ ë°• ë‚´êµ¬ë„ ì™„ì „ ìˆ˜ë¦¬", roomName);
            user.durability = 100;
            user.skipHealing = true;
            
            replier.reply(formatCommand("ğŸ› ï¸ ì„ ì²´ ìˆ˜ë¦¬ ì™„ë£Œ", user, "ê¸°ìˆ ìë“¤ì´ ë°¤ìƒˆ ë§¤ë‹¬ë ¤ ë°°ë¥¼ ìƒˆê²ƒì²˜ëŸ¼ ê³ ì³¤ìŠµë‹ˆë‹¤!\n\nâœ¨ ë‚´êµ¬ë„: 100% ë³µêµ¬\nğŸ’° ì†Œëª¨ ë¹„ìš©: -" + fp(repairCost) + "P", "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
            delete menuWaitState[targetUid]; // ìˆ˜ë¦¬ í›„ ë©”ë‰´ ë‹«ê¸°
            safeSaveData(data, true);
            return true;
        }

        // [B] ê¸°ì¡´ ì„ ë°• ê°œì¡° ë¡œì§ (ë³´ì¡´)
        if (choice === "1") {
            _processShipUpgrade(user, data, replier, roomName, tradeCfg);
            delete menuWaitState[targetUid];
        } else {
            // ìˆ˜ë¦¬/ê°œì¡° ì™¸ ì…ë ¥ ì‹œ ê°€ì´ë“œ ì¶œë ¥
            replier.reply(formatError(user, "ëª…ë ¹ ì˜¤ë¥˜", "ê°œì¡°ë¥¼ ì›í•˜ì‹œë©´ [1]ë²ˆ, ìˆ˜ë¦¬ë¥¼ ì›í•˜ì‹œë©´ [ìˆ˜ë¦¬]ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
        }
        return true;
    }

    return false;
}

/**
 * ğŸš¢ ë¬´ì—­ ë¬¼í’ˆ ì „ìš© ìƒì  ì¶œë ¥ í•¨ìˆ˜ (ì „ì—­ ìŠ¤ì½”í”„ë¡œ ì´ë™)
 * ëª©ì : ìŠ¤ì½”í”„ ì˜¤ë¥˜(ReferenceError)ë¥¼ í•´ê²°í•˜ê³  ë¬´ì—­ ìƒì  UIë¥¼ ì•ˆì •ì ìœ¼ë¡œ ì¶œë ¥í•©ë‹ˆë‹¤.
 */
function _showTradeShop(user, replier, roomData, cfg) {
    var filtered = SHOP_ITEMS.filter(function(it) { return it.cat === 6; });
    var list = filtered.map(function(item, i) {
        var price = getItemPrice(item, user, "ë‚´ë¦¬ë‹¤");
        return (i + 1) + ". " + item.icon + " " + item.name + " : " + fp(price) + "P";
    });
    
    var body = list.join("\n") + "\n\nğŸ’° ë³´ìœ  í¬ì¸íŠ¸: " + fp(user.point) + "P\n\nâ†©ï¸ ë’¤ë¡œ / ğŸ  ì²˜ìŒìœ¼ë¡œ / âì·¨ì†Œ";
    replier.reply(formatCommand("ğŸ›’ ë¬´ì—­ ë¬¼í’ˆ ì ì¬ ì„¼í„°", user, body, "êµ¬ë§¤í•  ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
}

/**
 * [ì¶”ê°€] ğŸš¢ ì´ë… ì§‘ë¬´ì‹¤ UI ì¶œë ¥ ë° ì •ì‚° ëŒ€ê¸° ë¡œì§
 */

function _showGovernorOffice(user, replier, roomData, myPorts) {
    if (!roomData.features.portData) {
        roomData.features.portData = {
            "í¬ë¥´íˆ¬": { level: 1, totalInvest: 0, governorUid: "", collectedTariff: 0 },
            "ì½”ì½œë¼":   { level: 1, totalInvest: 0, governorUid: "", collectedTariff: 0 },
            "ë‚˜í´ë¦¬":   { level: 1, totalInvest: 0, governorUid: "", collectedTariff: 0 },
            "ë² ë¼í¬ë£¨ìŠ¤":     { level: 1, totalInvest: 0, governorUid: "", collectedTariff: 0 },
            "í‚´ë²Œë¦¬":   { level: 1, totalInvest: 0, governorUid: "", collectedTariff: 0 }
        };
    }
    var pData = roomData.features.portData;

    var body = "ì´ë…ë‹˜, ê° ìì¹˜ë ¹ì—ì„œ ì·¨í•©ëœ ì„¸ì… í˜„í™©ì…ë‹ˆë‹¤.\n\n";
    var totalAvailable = 0;
    myPorts.forEach(function(pName, i) {
        // [ë°©ì–´] íŠ¹ì • í•­êµ¬ ë°ì´í„°ê°€ ë¹„ì–´ìˆì„ ê²½ìš° ê¸°ë³¸ê°’ í• ë‹¹
        if (!pData[pName]) pData[pName] = { level: 1, totalInvest: 0, governorUid: "", collectedTariff: 0 };
        
        var tariff = Number(pData[pName].collectedTariff || 0);
        totalAvailable += tariff;
        body += (i + 1) + ". " + pName + " : " + fp(tariff) + "P " + (tariff > 0 ? "ğŸ’°" : "âšª") + "\n";
    });
   body += "\nğŸ’µ ì •ì‚° ê°€ëŠ¥ ì´ì•¡: " + fp(totalAvailable) + "P\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
            "ğŸ’¬ [ìˆ˜ë ¹ ë°©ë²•]\n" +
            "â€¢ ë¶€ë¶„ ìˆ˜ë ¹: [ê¸ˆì•¡] ì…ë ¥\n" +
            "â€¢ ì¼ê´„ ìˆ˜ë ¹: [ì „ë¶€] ì…ë ¥\n\n" +
            "â†©ï¸ ë’¤ë¡œ / âì·¨ì†Œ";
    replier.reply(formatCommand("ğŸ›ï¸ ì´ë… ì§‘ë¬´ì‹¤ (ê´€ì„¸ ì •ì‚°)", user, body, "ìˆ˜ë ¹í•˜ì‹¤ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”."));
}

function _handleGovernorSettlement(msg, user, data, replier, roomName, targetUid) {
    var economyRoomName = (ALLOWED_ROOMS.indexOf(roomName) === -1) ? "ë‚´ë¦¬ë‹¤" : roomName;
    var roomData = data.rooms[economyRoomName];
    
    // 1. ì„¸ì…˜ ì£¼ë¨¸ë‹ˆ í™•ë³´ (1:1ë°© ë™ê¸°í™” ëŒ€ì‘ì„ ìœ„í•´ ë‘ ê³³ ëª¨ë‘ ì°¸ì¡°)
    var localMState = data.rooms[roomName].features.states.menuWait;
    var mainMState = data.rooms["ë‚´ë¦¬ë‹¤"].features.states.menuWait;
    var state = localMState[targetUid] || mainMState[targetUid];
    
    if (!state) return false;

    // 2. [ë„¤ë¹„ê²Œì´ì…˜ êµì •] ë’¤ë¡œ/ì·¨ì†Œ ì…ë ¥ ì‹œ ì–‘ìª½ ì„¸ì…˜ì„ ëª¨ë‘ íŒŒê¸°
    if (msg === "ë’¤ë¡œ" || msg === "â†©ï¸ ë’¤ë¡œ" || msg === "ì²˜ìŒìœ¼ë¡œ" || msg === "ğŸ  ì²˜ìŒìœ¼ë¡œ" || msg === "ì·¨ì†Œ" || msg === "âì·¨ì†Œ") {
        if (localMState && localMState[targetUid]) delete localMState[targetUid];
        if (mainMState && mainMState[targetUid]) delete mainMState[targetUid];

        if (msg.indexOf("ì·¨ì†Œ") === -1) {
            return _gameTradeLogic("/ë¬´ì—­", user, data, replier, roomName, targetUid);
        }
        replier.reply(formatCommand("ğŸ›ï¸ ì´ë… ì§‘ë¬´ì‹¤", user, "ê´€ì„¸ ì •ì‚° ì—…ë¬´ë¥¼ ì¢…ë£Œí•˜ê³  ì§‘ë¬´ì‹¤ì„ ë‚˜ì™”ìŠµë‹ˆë‹¤."));
        return true;
    }

    // 3. [ì˜¤ë¥˜ í•´ê²°] portData ë° í•˜ìœ„ êµ­ê°€ ë°ì´í„° ì¡´ì¬ ì—¬ë¶€ ê°•ì œ ê²€ì¦ (ì‚¬ë§‰ì˜ë³„ ì—ëŸ¬ ì›ì²œ ì°¨ë‹¨)
    if (!roomData.features.portData) roomData.features.portData = {};
    var pData = roomData.features.portData;
    var myPorts = state.myPorts || [];

    // 4. ì´ ê°€ìš© ê¸ˆì•¡ ê³„ì‚° (ê°ì²´ ì¡´ì¬ í™•ì¸ í›„ ê³„ì‚°)
    var totalAvailable = 0;
    myPorts.forEach(function(p) { 
        if (pData[p]) totalAvailable += Number(pData[p].collectedTariff || 0); 
    });

    // 5. ìˆ˜ë ¹ ê¸ˆì•¡ íŒë³„
    var withdrawAmt = 0;
    if (msg === "ì „ë¶€") {
        withdrawAmt = totalAvailable;
    } else {
        // ìˆ«ìê°€ ì•„ë‹Œ ë¬¸ì ì œê±° í›„ íŒŒì‹±
        withdrawAmt = parseInt(msg.replace(/[^0-9]/g, ""));
    }

    // 6. ìœ íš¨ì„± ê²€ì‚¬
    if (isNaN(withdrawAmt) || withdrawAmt <= 0) return false; // ìˆ«ìê°€ ì•„ë‹ˆë©´ ë‹¤ìŒ í•¸ë“¤ëŸ¬ë¡œ ë„˜ê¹€

    if (withdrawAmt > totalAvailable) {
        replier.reply(formatError(user, "ìˆ˜ë ¹ ë¶ˆê°€", "ì •ì‚° ê°€ëŠ¥í•œ ìµœëŒ€ ê¸ˆì•¡(" + fp(totalAvailable) + "P)ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤."));
        return true;
    }

    // 7. ì‹¤ì •ì‚° ì§‘í–‰ (í•­êµ¬ë³„ ìˆœì°¨ ì°¨ê°)
    var remaining = withdrawAmt;
    myPorts.forEach(function(p) {
        if (remaining <= 0 || !pData[p]) return;
        var pool = Number(pData[p].collectedTariff || 0);
        var take = Math.min(remaining, pool);
        pData[p].collectedTariff = pool - take;
        remaining -= take;
    });

    // 8. í¬ì¸íŠ¸ ì§€ê¸‰ ë° ì„¸ì…˜ ì¢…ë£Œ
    user.skipHealing = true;
    util_updatePoint(user, roomData, withdrawAmt, "ì´ë… ìì¹˜ë ¹ ê´€ì„¸ ìˆ˜ë ¹", economyRoomName);
    
    delete localMState[targetUid];
    delete mainMState[targetUid];
    
    replier.reply(formatCommand("âœ… ê´€ì„¸ ì •ì‚° ì™„ë£Œ", user, 
        "ìì¹˜ë ¹ì˜ ê´€ì„¸ë¥¼ êµ­ê³ ë¡œë¶€í„° ì •ì‚°ë°›ì•˜ìŠµë‹ˆë‹¤.\n\n" +
        "ğŸ’° ìˆ˜ë ¹ ê¸ˆì•¡: +" + fp(withdrawAmt) + "P\n" +
        "ğŸ›ï¸ ë‚¨ì€ ì„¸ì…: " + fp(totalAvailable - withdrawAmt) + "P", 
        "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
    
    safeSaveData(data, true);
    return true;
}



/**
 * ğŸš¢ ë¬´ì—­ í•˜ì—­ ì„¤ì • UI ì¶œë ¥ í•¨ìˆ˜ (ë””ìì¸ ê°€ë…ì„± ê°•í™”)
 */
function _showTradeCargoSelectUI(user, replier, roomData, cfg, dest, selC, selS) {
    var market = roomData.features.tradeMarket || cfg.NATIONS;
    var nInfo = market[dest];
    var currentLoc = user.currentLoc || "ë¬´ì—­ ì§€ë¶€";
    var localProduce = TRADE_RELATION[currentLoc] ? TRADE_RELATION[currentLoc].produce : "";
    var body = "ğŸ“ ëª©ì ì§€: [" + dest + "]\n\n" +
               "[ğŸ“¦ ë¬´ì—­í’ˆ ë³´ìœ  í˜„í™©]\n";
    
    var availableItems = []; 
    // 1. ì¼ë°˜ í™”ë¬¼: ìœ ì € ë³´ìœ ëŸ‰(user.cargo)ì—ì„œ í˜„ì¬ ì„ íƒëœ ì–‘(selC)ì„ ëº€ ë‚˜ë¨¸ì§€ë§Œ ê³„ì‚°
    for (var k in (user.cargo || {})) {
        var total = Number(user.cargo[k] || 0);
        var selected = Number(selC[k] || 0);
        var remaining = total - selected;
        
        if (remaining > 0) {
        if (k === localProduce) continue; // í˜„ì¬ í•­êµ¬ ìƒì‚°í’ˆì€ íŒ” ìˆ˜ ì—†ìŒ
            var status = (k === nInfo.favorite) ? "ğŸ”ºì„ í˜¸" : (k === nInfo.hate ? "ğŸ”¹ê¸°í”¼" : "â–ì¼ë°˜");
            availableItems.push({ type: 'cargo', name: k, qty: remaining, status: status });
        }
    }
    // 2. íŠ¹ì‚°í’ˆ: ë³´ìœ ëŸ‰(user.specialties)ì—ì„œ í˜„ì¬ ì„ íƒëœ ì–‘(selS)ì„ ëº€ ë‚˜ë¨¸ì§€ë§Œ ê³„ì‚°
    for (var s in (user.specialties || {})) {
        var totalS = Number(user.specialties[s] || 0);
        var selectedS = Number(selS[s] || 0);
        var remainingS = totalS - selectedS;

        if (remainingS > 0) {
            var pG = "";
            for (var rel in TRADE_RELATION) {
                if (TRADE_RELATION[rel].set === s) { pG = TRADE_RELATION[rel].produce; break; }
            }
            var sStatus = "â–ì¼ë°˜";
            if (pG === nInfo.favorite) sStatus = "ğŸ”ºì„ í˜¸";
            else if (pG === nInfo.hate) sStatus = "ğŸ”¹ê¸°í”¼";
            
            availableItems.push({ type: 'spec', name: s, qty: remainingS, status: sStatus });
        }
    }

    /* v16.7 í•˜ì—­ UI ë‚´ ë³´ë¬¼ ë¦¬ìŠ¤íŠ¸ ë° ì ì¬ í˜„í™© ì¶”ê°€ */
    var rareCount = Number(user.rareSpecialties || 0);
    var selectedRare = Number(selS._rare || 0); // íŠ¹ì‚°í’ˆ ìŠ¤ëƒ…ìƒ· ë‚´ ë‚´ë¶€ í‚¤ ì‚¬ìš©
    var remainingRare = rareCount - selectedRare;

    if (remainingRare > 0) {
        availableItems.push({ type: 'rare', name: "ì§„ê·€í•œ ë³´ë¬¼", qty: remainingRare, status: "ğŸ’°ê³ ì •ê°€ (10ë§ŒP)" });
    }

    if (availableItems.length === 0) {
        body += "- ì ì¬ ê°€ëŠ¥í•œ ë³´ìœ  ë¬¼í’ˆ ì—†ìŒ -\n";
    } else {
        availableItems.forEach(function(it, i) {
            var prefix = (it.type === 'spec' || it.type === 'rare') ? "â­" : "";
            body += (i + 1) + ". " + prefix + it.name + " (" + it.qty + "ìƒì) - " + it.status + "\n";
        });
    }

    body += "\n[âœ… ì„ ë°• ì ì¬ ì™„ë£Œ]\n";
    var selList = [];
    for (var c in selC) selList.push("â€¢ " + c + " x" + selC[c] + "ìƒì");
    for (var s in selS) {
        if (s === "_rare") selList.push("â€¢ ğŸ’ì§„ê·€í•œ ë³´ë¬¼ x" + selS[s] + "ê°œ");
        else selList.push("â€¢ â­" + s + " x" + selS[s] + "ê°œ");
    }
    body += (selList.length > 0 ? selList.join("\n") : "- ì„ íƒëœ í™”ë¬¼ ì—†ìŒ -");

    body += "\n\n\nğŸ’¬ [ì…ë ¥ ë°©ë²•]\n" +
Â  Â  Â  Â  Â  Â  "â€¢ íŒë§¤ í’ˆëª© ì§€ì •: [ë²ˆí˜¸] [ìˆ˜ëŸ‰]\n" +
Â  Â  Â  Â  Â  Â  "â€¢ ëª¨ë“  í™”ë¬¼ ì„ íƒ: [ì „ë¶€]\n" +
            "â€¢ í˜¸ìœ„ : [í˜¸ìœ„] (í•´êµ° ê³ ìš©)\n" +
Â  Â  Â  Â  Â  Â  "â€¢ ì¶œí•­ : [ì¶œí•­]\n\n" +
Â  Â  Â  Â  Â  Â  "â†©ï¸ ë’¤ë¡œ / ğŸ  ì²˜ìŒìœ¼ë¡œ / âì·¨ì†Œ";

Â  Â  var nextStep = "íŒë§¤í•  í’ˆëª©ì„ ê³ ë¥¸ í›„ [í˜¸ìœ„] ë˜ëŠ” [ì¶œí•­]ì„ ì…ë ¥í•˜ì„¸ìš”.";
    replier.reply(formatCommand("ğŸš¢ ë¬´ì—­ í•˜ì—­ ì„¤ì •", user, body, nextStep));
}

/**
 * [ìˆ˜ì •] ğŸš¢ ë¬´ì—­ í•˜ì—­ í™”ë¬¼ ì„ íƒ í•¸ë“¤ëŸ¬ (ì…ë ¥ íŒŒì‹± ìµœì í™”)
 */
function _handleTradeCargoSelection(msg, user, data, replier, roomName, targetUid, cfg) {
    var roomData = data.rooms[roomName];
    var state = roomData.features.states.menuWait[targetUid];
    var input = msg.trim();

    // [êµì •] ì·¨ì†Œ ë˜ëŠ” ë’¤ë¡œ ê°€ê¸° ì‹œ ì„¸ì…˜ì„ ì‚­ì œí•˜ê³  ë¬´ì—­ ë©”ì¸ ë©”ë‰´ë¡œ ê°•ì œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    if (input === "ì·¨ì†Œ" || input === "ë’¤ë¡œ" || input === "â†©ï¸ ë’¤ë¡œ") {
        if (roomData.features.states.menuWait && roomData.features.states.menuWait[targetUid]) {
            delete roomData.features.states.menuWait[targetUid];
        }
        return _gameTradeLogic("/ë¬´ì—­", user, data, replier, roomName, targetUid);
    }

    if (input === "ì „ë¶€") {
        for (var k in (user.cargo || {})) if (user.cargo[k] > 0) state.selCargo[k] = user.cargo[k];
        for (var s in (user.specialties || {})) if (user.specialties[s] > 0) state.selSpec[s] = user.specialties[s];
        _showTradeCargoSelectUI(user, replier, roomData, cfg, state.dest, state.selCargo, state.selSpec);
        return;
    }

    // ì¶”ê°€: 'í˜¸ìœ„' í‚¤ì›Œë“œ ì…ë ¥ ì‹œ í•´êµ° ê³ ìš© í•¸ë“¤ëŸ¬ë¥¼ í˜¸ì¶œí•˜ëŠ” ë¡œì§ ì‚½ì…
    if (input === "í˜¸ìœ„") {
        _handleEscortHire(input, user, data, replier, roomName, targetUid);
        return;
    }

    // [A] ë¬´ì—­ ì§€ë¶€ íšŒí•­ ìŠ¹ì¸ (0ë²ˆ)
    if (input === "0") {
        if (user.currentLoc === "ë¬´ì—­ ì§€ë¶€") {
            replier.reply(formatError(user, "ëª…ë ¹ ë¬´íš¨", "ì´ë¯¸ ë¬´ì—­ ì§€ë¶€ì— ìœ„ì¹˜í•˜ê³  ìˆìŠµë‹ˆë‹¤."));
            return;
        }
        state.dest = "ë¬´ì—­ ì§€ë¶€";
        replier.reply("ğŸ  ëª¨ë“  í™”ë¬¼ì„ ë³´ì¡´í•œ ì±„ ê³ í–¥ í•­êµ¬ë¡œ íšŒí•­í•©ë‹ˆë‹¤.");
        _departVoyage(user, data, replier, roomName, state.dest, cfg, state.selCargo, state.selSpec);
        delete roomData.features.states.menuWait[targetUid];
        return;
    }

    // [B] ì—˜ë„ë¼ë„ ì¶œí•­ ìŠ¹ì¸ (9ë²ˆ)
    if (input === "9") {
        // ë‚´êµ¬ë„ ê°€ë“œ ì¶”ê°€: 20% ë¯¸ë§Œì´ë©´ ì—˜ë„ë¼ë„ ì¶œí•­ ì›ì²œ ì°¨ë‹¨
        if (durability < 20) {
            replier.reply(formatError(user, "ì§„ì… ë¶ˆê°€", "ì„ ì²´ ë‚´êµ¬ë„ê°€ ë‚®ì•„ ì „ì„¤ì˜ í•­ë¡œë¥¼ ë²„í‹¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!\n'ë¬´ì—­ ì§€ë¶€'ë¡œ ë³µê·€í•˜ì—¬ ìˆ˜ë¦¬ë¶€í„° í•˜ì‹­ì‹œì˜¤."));
            return;
        }

        var currentMaps = Number(user.ancientMaps || 0);
        if (currentMaps < ELDORADO_CONFIG.MAP_UNLOCK_COUNT) return; 
        
        var lastHidden = Number(user.lastHiddenVoyage || 0);
        if (Date.now() - lastHidden < ELDORADO_CONFIG.COOLDOWN) {
            replier.reply(formatError(user, "í•­ë¡œ íì‡„", "ì•ˆê°œê°€ ê±·íˆì§€ ì•Šì•„ ì…í•­ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤."));
            return;
        }

        user.ancientMaps -= ELDORADO_CONFIG.MAP_UNLOCK_COUNT;
        user.lastHiddenVoyage = Date.now();
        state.dest = ELDORADO_CONFIG.NAME;
        
        _departVoyage(user, data, replier, roomName, state.dest, cfg, state.selCargo, state.selSpec);
        delete roomData.features.states.menuWait[targetUid];
        return;
    }

    if (input === "ì¶œí•­") {

        // 1. ì¶œí•­ ì‹œ ë¶€ë„ ê°€ë“œ ì¶”ê°€
        if (typeof util_isBankruptcy === 'function' && util_isBankruptcy(roomName)) {
            replier.reply(formatError(user, "ì¶œí•­ ë¶ˆê°€ëŠ¥", "í˜„ì¬ êµ­ê°€ ë¶€ë„ ìƒíƒœì´ë¯€ë¡œ ëª¨ë“  ë¬´ì—­ì„ ë°•ì˜ ì¶œí•­ì´ ì „ë©´ ê¸ˆì§€ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nâš ï¸ ì‚¬ìœ : êµ­ê³  ì¬ì› ë¶€ì¡±ìœ¼ë¡œ ì¸í•œ í•­ë§Œ ë´‰ì‡„"));
            return;
        }
     
        var hasCargo = Object.keys(state.selCargo).length > 0 || Object.keys(state.selSpec).length > 0;
        if (!hasCargo) {
            replier.reply(formatError(user, "ì¶œí•­ ë¶ˆê°€", "íŒë§¤í•  í™”ë¬¼ì„ ìµœì†Œ 1ê°œ ì´ìƒ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤."));
            return;
        }
        _departVoyage(user, data, replier, roomName, state.dest, cfg, state.selCargo, state.selSpec);
        delete roomData.features.states.menuWait[targetUid];
        return;
    }

   // [Bug Fix]: UIì— í‘œì‹œëœ 'ì”ì—¬ëŸ‰ì´ ìˆëŠ” ëª©ë¡'ê³¼ ë¡œì§ìƒì˜ ì¸ë±ìŠ¤ë¥¼ ì™„ë²½íˆ ì¼ì¹˜ì‹œí‚´
    var parts = input.split(/\s+/);
    var idx = parseInt(parts[0]) - 1;
    
    var availableItems = [];
    // 1. ì¼ë°˜ í™”ë¬¼ ì¤‘ ì”ì—¬ëŸ‰ì´ ìˆëŠ” ê²ƒë§Œ ìˆœì„œëŒ€ë¡œ ì¶”ì¶œ
    for (var k in (user.cargo || {})) {
        var rem = Number(user.cargo[k] || 0) - Number(state.selCargo[k] || 0);
        if (rem > 0) availableItems.push({ type: 'cargo', name: k, qty: rem });
    }
    // 2. íŠ¹ì‚°í’ˆ ì¤‘ ì”ì—¬ëŸ‰ì´ ìˆëŠ” ê²ƒë§Œ ì´ì–´ì„œ ì¶”ì¶œ
    for (var s in (user.specialties || {})) {
        var remS = Number(user.specialties[s] || 0) - Number(state.selSpec[s] || 0);
        if (remS > 0) availableItems.push({ type: 'spec', name: s, qty: remS });
    }

    if (isNaN(idx) || idx < 0 || idx >= availableItems.length) {
        if (!isNaN(parseInt(parts[0]))) {
            replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "í˜„ì¬ í™”ë©´ì— í‘œì‹œëœ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
        }
        return;
    }

    var selected = availableItems[idx];
    var inputQty = parts.length > 1 ? parseInt(parts[1].replace(/[^0-9]/g, "")) : 999999;
    var finalQty = Math.min(inputQty, selected.qty);

    /* [ìˆ˜ì •] v16.7 ë³´ë¬¼ ì„ íƒ ì‹œ ì¦‰ì‹œ ë§¤ê°ì´ ì•„ë‹Œ 'ì ì¬ ëª©ë¡'ìœ¼ë¡œ ì¶”ê°€ */
    if (selected.type === 'rare') {
        state.selSpec["_rare"] = (state.selSpec["_rare"] || 0) + finalQty;
    } else if (selected.type === 'cargo') {
        state.selCargo[selected.name] = (state.selCargo[selected.name] || 0) + finalQty;
    } else {
        state.selSpec[selected.name] = (state.selSpec[selected.name] || 0) + finalQty;
    }

    state.time = Date.now();
    _showTradeCargoSelectUI(user, replier, roomData, cfg, state.dest, state.selCargo, state.selSpec);
}

/* [ì„œë¸Œ] ğŸŒ ì„¸ê³„ ì‹œì„¸ ë¦¬í¬íŠ¸ */
function _showTradeMarket(user, replier, roomData, cfg) {
   var market = roomData.features.tradeMarket || cfg.NATIONS;
    var pData = roomData.features.portData || {};
    
    // í˜„ì¬ ì‹œê° ë° íˆ¬ì ê°€ëŠ¥ ì—¬ë¶€ íŒë³„
   var h = new Date().getHours();
    var isInvestOpen = (h >= 7); // 07:00 ~ 23:59
    var investStatus = isInvestOpen ? "ğŸŸ¢ íˆ¬ì ê°€ëŠ¥" : "ğŸ”´ íˆ¬ì ë§ˆê°";

    var header = "ğŸŒ ì„¸ê³„ ì‹œì„¸ ë¦¬í¬íŠ¸ " + investStatus + "\n" +
                 "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                 getDisplayName(user) + "ë‹˜\n\n";

    var list = [];
    var idx = 1;
    for (var n in cfg.NATIONS) { 
        var nInfo = market[n] || cfg.NATIONS[n];
        var pInfo = pData[n] || { level: 1, totalInvest: 0, governorUid: "" };
        
        var govName = "ì—†ìŒ (ê³µì„)";
        if (pInfo.governorUid && roomData.users[pInfo.governorUid]) {
            var gUser = roomData.users[pInfo.governorUid];
            govName = "ğŸ‘‘" + gUser.name;
        }

        var favSpec = ""; var hateSpec = "";
        for (var rel in TRADE_RELATION) {
            if (TRADE_RELATION[rel].produce === nInfo.favorite) favSpec = " (+" + TRADE_RELATION[rel].set + ")";
            if (TRADE_RELATION[rel].produce === nInfo.hate) hateSpec = " (-" + TRADE_RELATION[rel].set + ")";
        }

        var entry = "ğŸ“ " + idx + ". " + n + " [Lv." + pInfo.level + "]\n" +
                    "  ğŸ”º ì„ í˜¸: " + nInfo.favorite + favSpec + "\n" +
                    "  ğŸ”¹ ê¸°í”¼: " + nInfo.hate + hateSpec + "\n" +
                    "  ğŸ‘¤ ì´ë…: " + govName;
        list.push(entry);
        idx++;
    }

// ìˆ˜ì •: ë„¤ë¹„ê²Œì´ì…˜ ë°”ë¥¼ ìœ„ë¡œ ì˜¬ë¦¬ê³  ì„¤ëª… ë° íˆ¬ì ë°©ë²•ì„ í•˜ë‹¨ìœ¼ë¡œ ë°°ì¹˜í•˜ëŠ” ë ˆì´ì•„ì›ƒ ê°œí¸
    var footer = "\n\nâ†©ï¸ ë’¤ë¡œ / ğŸ  ì²˜ìŒìœ¼ë¡œ / âì·¨ì†Œ\n\n" +
                 "ê° êµ­ê°€ì˜ ë°œì „ë„ì™€ ì‹¤ì‹œê°„ ìˆ˜ìš”ì…ë‹ˆë‹¤.\n" +
                 "(ë°œì „ ë ˆë²¨ì´ ë†’ì„ìˆ˜ë¡ ì„ í˜¸í’ˆ ê°€ê²© ìƒìŠ¹!)\n\n" +
                 "ğŸ’¬ [íˆ¬ì ë°©ë²•]\n" +
                 "â€¢ ë²ˆí˜¸ ì…ë ¥ ì‹œ í•´ë‹¹ í•­êµ¬ì— íˆ¬ìí•©ë‹ˆë‹¤.\n" +
                 "â€¢ 100ë§ŒPë‹¹ ë°œì „ ë ˆë²¨ì´ 1ë‹¨ê³„ ìƒìŠ¹í•©ë‹ˆë‹¤. (ìµœëŒ€ Lv.30)\n" +
                 "â€¢ ìµœê³  íˆ¬ììëŠ” í•´ë‹¹ í•­êµ¬ì˜ 'ì´ë…'ì´ ë©ë‹ˆë‹¤.\n" +
                 "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                 "ğŸ’¡ [ê°€ì´ë“œ]: ë©”ë‰´ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.";

    replier.reply(header + list.join("\n\n") + footer);
}

/* [ì„œë¸Œ] ğŸš¢ ì¶œí•­ ì¤€ë¹„ ë° í™”ë¬¼ í™•ì¸ */
function _prepareVoyage(user, replier, cfg, roomData) {
    var durability = Number(user.durability === undefined ? 100 : user.durability);
    var currentLoc = user.currentLoc || "ë¬´ì—­ ì§€ë¶€";
    
    // ë‚´êµ¬ë„ê°€ 20% ë¯¸ë§Œì´ê³  ë¬´ì—­ ì§€ë¶€ê°€ ì•„ë‹ ë•Œ 'íŒŒì† ìƒíƒœ'ë¡œ ì •ì˜
    var isBroken = (durability < 20 && currentLoc !== "ë¬´ì—­ ì§€ë¶€");

    if (isBroken) {
        var warnMsg = "ğŸš¨ [ì¶œí•­ ë¶ˆê°€: ì„ ì²´ ì†ìƒ]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                      "í˜„ì¬ ë‚´êµ¬ë„ê°€ " + durability + "%ë¡œ ë§¤ìš° ìœ„í—˜í•œ ìƒíƒœì…ë‹ˆë‹¤.\n\n" +
                      "âš ï¸ ì‚¬ê³  ì˜ˆë°©ì„ ìœ„í•´ ëª¨ë“  ìƒì—… í•­ë¡œê°€ íì‡„ë˜ì—ˆìŠµë‹ˆë‹¤.\n" +
                      "ì¦‰ì‹œ 'ë¬´ì—­ ì§€ë¶€'ë¡œ ë³µê·€í•˜ì—¬ ìˆ˜ë¦¬ë¥¼ ì§„í–‰í•˜ì„¸ìš”.";
        replier.reply(formatError(user, "ë‚´êµ¬ë„ ë¶€ì¡±", warnMsg, "[0]ë²ˆì„ ì…ë ¥í•˜ì—¬ ë³µê·€í•˜ì„¸ìš”."));
    }

    var cargoList = []; var total = 0;
    var myCargo = user.cargo || {};
    
    for (var k in myCargo) {
        var q = Number(myCargo[k]);
        if (q > 0) { cargoList.push("â€¢ " + k + ": " + q + "ìƒì"); total += q; }
    }
    for (var s in (user.specialties || {})) {
        if (user.specialties[s] > 0) cargoList.push("â­ " + s + ": " + user.specialties[s] + "ìƒì");
    }

    /* 3. v16.7 ì§„ê·€í•œ ë³´ë¬¼(ì„±ë°° ë“±) í‘œì‹œ ë¡œì§ */
    var rareCount = Number(user.rareSpecialties || 0);
    if (rareCount > 0) {
        cargoList.push("â€¢ ğŸ’ ì§„ê·€í•œ ë³´ë¬¼: " + rareCount + "ê°œ");
    }
    
    // í™”ë¬¼ì´ ì•„ì˜ˆ ì—†ëŠ” ê²½ìš° ê°€ë“œ (ë³´ë¬¼ë§Œ ìˆì–´ë„ ì¶œí•­ ê°€ëŠ¥í•˜ë„ë¡ cargoList.length ì²´í¬)
    if (total === 0 && cargoList.length === 0) {
        replier.reply(formatError(user, "ì¶œí•­ ë¶ˆê°€", "ì‹¤ë¦° í™”ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤. ìƒì ì—ì„œ ë¬¼í’ˆì„ êµ¬ë§¤í•˜ì„¸ìš”."));
        return;
    }

    var market = roomData.features.tradeMarket || cfg.NATIONS;
    var pData = roomData.features.portData || {};
    var nations = Object.keys(cfg.NATIONS);
    var nStr = ""; 
    
    for (var i = 0; i < nations.length; i++) {
        var nName = nations[i];
        if (nName === currentLoc) continue;
        if (isBroken) continue;
        var nInfo = market[nName];
        var govMark = (pData[nName] && pData[nName].governorUid === user.uid) ? " ğŸ‘‘" : "";
        nStr += (i + 1) + ". " + nName + " (" + nInfo.favorite + "ğŸ”º " + nInfo.hate + "ğŸ”¹)" + govMark + "\n";
    }

   // 1. [ë³µê·€ ë©”ë‰´] 0ë²ˆ ë¬´ì—­ ì§€ë¶€ë¥¼ ë¦¬ìŠ¤íŠ¸ ìµœìƒë‹¨ìœ¼ë¡œ ë°°ì¹˜
    if (currentLoc !== "ë¬´ì—­ ì§€ë¶€") {
        nStr += "ğŸ  0. ë¬´ì—­ ì§€ë¶€ (íšŒí•­ ë° ìˆ˜ë¦¬ ê°€ëŠ¥)\n";
    }

    // 2. [ì¼ë°˜ í•­êµ¬] ë£¨í”„ë¥¼ ë‹¨ì¼í™”í•˜ì—¬ ì¤‘ë³µ ì¶œë ¥ ë²„ê·¸ í•´ê²°
    for (var i = 0; i < nations.length; i++) {
        var nName = nations[i];
        
        // í˜„ì¬ ìœ„ì¹˜ ì œì™¸ ë° ë‚´êµ¬ë„ íŒŒì†(isBroken) ì‹œ ì¼ë°˜ í•­ë¡œ íì‡„
        if (nName === currentLoc || isBroken) continue; 

        var nInfo = market[nName];
        var govMark = (pData[nName] && pData[nName].governorUid === user.uid) ? " ğŸ‘‘" : "";
        nStr += (i + 1) + ". " + nName + " (" + nInfo.favorite + "ğŸ”º " + nInfo.hate + "ğŸ”¹)" + govMark + "\n";
    }

    /* v16.7 ì—˜ë„ë¼ë„ ì…í•­ í—ˆê°€ ê°€ë“œ (ë²ˆí˜¸ë¥¼ 9ë²ˆìœ¼ë¡œ ë³€ê²½) */
    var maps = Number(user.ancientMaps || 0);
    if (maps >= ELDORADO_CONFIG.MAP_UNLOCK_COUNT) {
        var lastHidden = Number(user.lastHiddenVoyage || 0);
        var isCool = (Date.now() - lastHidden < ELDORADO_CONFIG.COOLDOWN);
        
        if (!isCool) {
            nStr += "ğŸŒŸ 9. " + ELDORADO_CONFIG.NAME + " (ì§€ë„ 10ì¥ ì†Œëª¨)\n"; // 0ì—ì„œ 9ë¡œ ë³€ê²½
        } else {
            var remainMs = ELDORADO_CONFIG.COOLDOWN - (Date.now() - lastHidden);
            var remainH = Math.floor(remainMs / 3600000);
            var remainM = Math.ceil((remainMs % 3600000) / 60000);
            nStr += "ğŸ”’ " + ELDORADO_CONFIG.NAME + " (ì •ë¹„ ì¤‘: " + remainH + "ì‹œê°„ " + remainM + "ë¶„ ë‚¨ìŒ)\n";
        }
    }

    nStr += "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
            "ğŸ’¡ ğŸ‘‘í‘œì‹œëŠ” ë‹¹ì‹ ì´ ì´ë…ì¸ í•­êµ¬ì…ë‹ˆë‹¤.\n" +
            "ë„ì°© ì‹œ íŠ¹ì‚°í’ˆì„ ìµœëŒ€ 3ë°° íšë“í•©ë‹ˆë‹¤!\n\n" +
            "â†©ï¸ ë’¤ë¡œ / ğŸ  ì²˜ìŒìœ¼ë¡œ / âì·¨ì†Œ";
    replier.reply(formatCommand("ğŸš¢ ëª©ì ì§€ ì„¤ì •", user, "[ë‚´ ë³´ê´€í•¨]\n" + cargoList.join("\n") + "\n\n[ì¶œí•­ì§€ ì„ íƒ]\n" + nStr, "êµ­ê°€ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
}

/* ğŸŒŠ í•­í•´ ì‹œì‘ (í˜¸ìœ„ ì •ë³´ ì €ì¥ ë° ë©”ì‹œì§€ ì¶œë ¥ ë³´ê°•) */
function _departVoyage(user, data, replier, roomName, dest, cfg, selC, selS, escortUid, escortFee) {
    var roomData = data.rooms[roomName];
    user.skipHealing = true;
    user.isPillaged = false; 

    var mainRoom = data.rooms["ë‚´ë¦¬ë‹¤"];
    if (mainRoom && mainRoom.features && mainRoom.features.activePillages) {
        if (mainRoom.features.activePillages[user.uid]) {
            delete mainRoom.features.activePillages[user.uid];
        }
    }
    
    var ship = cfg.SHIPS[user.shipLevel || 1];
    
    // [v15.9.3] ì´ˆ ë‹¨ìœ„ ì •ë°€ ê³„ì‚° ì—”ì§„ ë„ì…
    var baseTimeSec = (60 * ship.speedMult) * 60; // ê¸°ë³¸ í•­í•´ ì‹œê°„ (ì´ˆ)
    var enhSec = Number(user.enhTime || 0);       // ì´ˆì›” ê°•í™” ë³´ì • (ì´ˆ)
    
    // 1ë‹¨ê³„: ê¸°ë³¸ ì‹œê°„ + ê°•í™” ë³´ì • í•©ì‚°
    var totalSec = baseTimeSec + enhSec;

    // 2ë‹¨ê³„: ì •ë¶€ ì •ì±… ë°°ìœ¨ ì ìš©
    var pol = util_getActivePolicy(roomData);
    if (pol.tradeSpeedMult) {
        totalSec *= pol.tradeSpeedMult;
    }
    
    // 3ë‹¨ê³„: ìˆœí’(Tailwind) í™•ë¥  íŒì • ë° ì ìš©
    var isSmooth = Math.random() < 0.1;
    if (isSmooth) {
        totalSec *= 0.8; // 20% ë‹¨ì¶•
    }
    
    // 4ë‹¨ê³„: ìµœì¢… ì‹œê°„ í™•ì • (ìµœì†Œ 1ë¶„ ë³´ì¥)
    var finalTimeMin = Math.max(1, Math.floor(totalSec / 60));
    var arrival = Date.now() + (totalSec * 1000);

    // === ë‚´êµ¬ë„ ì°¨ê° ë¡œì§ ===
    var wear = Math.floor(Math.random() * 6) + 10; // 10~15%
    user.durability = Math.max(0, (user.durability || 100) - wear);
    user.skipHealing = true;
    
    // ë°ì´í„° íŒ¨í‚¤ì§• (v.arrivalì— ìµœì¢… ê³„ì‚°ëœ ê°’ ì €ì¥)
    user.voyage = {
        active: true, 
        dest: dest, 
        arrival: arrival, 
        startTime: Date.now(),
        marketSnapshot: JSON.parse(JSON.stringify(roomData.features.tradeMarket || cfg.NATIONS)), 
        ecoMultSnapshot: util_getEcoMultiplier(roomName),
        cargoSnapshot: JSON.parse(JSON.stringify(selC || {})), 
        specialtySnapshot: JSON.parse(JSON.stringify(selS || {})),
        escortUid: escortUid || null,
        escortFee: escortFee || 0,
        isSmooth: isSmooth,
        isProcessing: false 
    };
    
    safeSaveData(data, true); 

    var msg = "ëª©ì ì§€: " + dest + "\n" +
              "ì†Œìš” ì‹œê°„: ì•½ " + finalTimeMin + "ë¶„\n" +
              "ë„ì°© ì˜ˆì •: " + new Date(arrival).toLocaleTimeString();
              
    if (isSmooth) msg += "\n\nğŸŒ¬ï¸ [ìˆœí’] ê¸°ë¶„ ì¢‹ì€ ë°”ëŒìœ¼ë¡œ ì‹œê°„ì´ 20% ë‹¨ì¶•ë˜ì—ˆìŠµë‹ˆë‹¤!";
    
    // í˜¸ìœ„í•¨ ë™í–‰ ì‹œ ì¶œí•­ ë©”ì‹œì§€ì— í˜¸ìœ„ í•´êµ° ë‹‰ë„¤ì„ í‘œì‹œ ë¡œì§ ì¶”ê°€
    if (escortUid) {
        var navyName = "í•´êµ° í˜¸ìœ„í•¨";
        for (var r in data.rooms) { 
            if (data.rooms[r].users[escortUid]) { 
                navyName = data.rooms[r].users[escortUid].name; 
                break; 
            } 
        }
        msg += "\nğŸ›¡ï¸ [í˜¸ìœ„í•¨ ë™í–‰]: " + navyName + " í•¨ëŒ€ê°€ ì„ ë‹¨ì„ ë³´í˜¸í•©ë‹ˆë‹¤.";
    }
    
    replier.reply(formatCommand("ğŸŒŠ ì¶œí•­ ëª…ë ¹ í•˜ë‹¬", user, msg, "í•­í•´ ì¤‘ íƒ€ í™œë™ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤."));
}

/* [ìˆ˜ì •] ğŸ“¦ í•­í•´ í˜„í™©íŒ (í˜¸ìœ„í•¨ í‘œì‹œ ì¶”ê°€) */
function _showVoyageStatus(user, replier, data, roomName) {
    var msg = "";
    if (!user.voyage || user.voyage.active !== true) {
        var emptyBody = "í˜„ì¬ ìš´í•­ ì¤‘ì¸ ì„ ë°•ì´ ì—†ìŠµë‹ˆë‹¤.\në¬´ì—­ ë¬¼ìë¥¼ ì‹£ê³  ë„“ì€ ë°”ë‹¤ë¡œ ë‚˜ê°€ë³´ì„¸ìš”!\n\n" +
                        "â†©ï¸ ë’¤ë¡œ / ğŸ  ì²˜ìŒìœ¼ë¡œ / âì·¨ì†Œ";
        replier.reply(formatCommand("ğŸ“¦ í•­í•´ í˜„í™©", user, emptyBody, "ì¶œí•­ ì¤€ë¹„: [2]ë²ˆ ë©”ë‰´ë¥¼ ì„ íƒí•˜ì„¸ìš”."));
        return;
    }
    var v = user.voyage;
    var remain = (v.arrival || 0) - Date.now();
    var cfg = SYSTEM_CONFIG.TRADE;
    
    // [v15.9] í˜„í™©íŒ ê°•í™” ìˆ˜ì¹˜ ì—°ë™
    var shipCapacity = cfg.SHIPS[user.shipLevel || 1].capacity + (user.enhLimit || 0);
    
    var tRev = 0; var tCost = 0;
    var currentCargoLines = [];
    var totalCargoInShip = 0;
    var shipCapacity = cfg.SHIPS[user.shipLevel || 1].capacity + (user.enhLimit || 0);

    var nSnap = v.marketSnapshot[v.dest];
    var pInfo = (data.rooms[roomName].features.portData && data.rooms[roomName].features.portData[v.dest]) ? data.rooms[roomName].features.portData[v.dest] : { level: 1 };
    var portLevelBonus = Number((pInfo.level - 1) * (cfg.INVEST.BONUS_PER_LEVEL || 0.01));

    var cSnap = v.cargoSnapshot || {};
    for (var g in cSnap) {
        var qty = Number(cSnap[g]); if (qty <= 0) continue;
        currentCargoLines.push("      â€¢ " + g + " " + qty + "ìƒì");
        totalCargoInShip += qty;
        var myPurchasePrice = Number((user.cargoAvg && user.cargoAvg[g]) || cfg.GOODS_COST[g]);
        var itemCost = myPurchasePrice * qty;
        tCost += itemCost;

        var rateInfo = SYSTEM_CONFIG.PROFIT_RATES[g] || { pref: 1.15, norm: 1.05, hate: 0.8 };
        var mult = 1.0;
        if (g === nSnap.favorite) {
            var baseEarn = Math.floor(myPurchasePrice * rateInfo.pref * qty);
            var baseMargin = baseEarn - itemCost;
            var bonusAmt = baseMargin > 0 ? Math.floor(baseMargin * portLevelBonus) : 0;
            mult = itemCost > 0 ? ((baseEarn + bonusAmt) / itemCost) : rateInfo.pref;
        } else if (g === nSnap.hate) mult = rateInfo.hate;
        else mult = rateInfo.norm;
        
        tRev += Math.floor(myPurchasePrice * mult * qty);
    }

    var sSnap = v.specialtySnapshot || {};
    for (var s in sSnap) {
        var sQty = Number(sSnap[s]); if (sQty <= 0) continue;
        currentCargoLines.push("    â­" + s + " " + sQty + "ìƒì");
        totalCargoInShip += sQty;
        var pG = "";
        for (var n in TRADE_RELATION) { if (TRADE_RELATION[n].set === s) { pG = TRADE_RELATION[n].produce; break; } }
        var sBase = cfg.SPECIALTY_COST[pG] || 10000;
        var sMult = (pG === nSnap.favorite) ? cfg.SPECIALTY_PROFIT : (pG === nSnap.hate ? 0.5 : 1.0);
        tCost += (sBase * sQty);
        tRev += Math.floor(sBase * sQty * sMult);
    }

    // 1. ê¸°ì´ˆ ë§ˆì§„ì— ì„ ë°• íš¨ìœ¨ì„ ë¨¼ì € ê³±í•˜ì—¬ 'ì„¸ì „ ê¸°ëŒ€ ìˆ˜ìµ'ì„ í™•ì •í•©ë‹ˆë‹¤.
    var shipEff = (user.shipLevel === 1) ? 3.5 : (user.shipLevel === 2 ? 1.5 : 1.0);
    var baseMarginWithEff = Math.floor((tRev - tCost) * shipEff);

    // 2. í•­êµ¬ ë°œì „ ë ˆë²¨ì„ ì°¸ì¡°í•˜ì—¬ ë³´ë„ˆìŠ¤ ê¸ˆì•¡ì„ ì‚°ì¶œí•©ë‹ˆë‹¤. (ë ˆë²¨ë‹¹ 1%)
    var pInfo = (data.rooms[roomName].features.portData && data.rooms[roomName].features.portData[v.dest]) ? data.rooms[roomName].features.portData[v.dest] : { level: 1 };
    var portLevelRate = Number((pInfo.level - 1) * 0.01);
    var bonusAmt = baseMarginWithEff > 0 ? Math.floor(baseMarginWithEff * portLevelRate) : 0;

   // 3. ìµœì¢… ë§ˆì§„ = (ê¸°ì´ˆ ìˆ˜ìµ * íš¨ìœ¨) + ë°œì „ë„ ë³´ë„ˆìŠ¤
    var margin = baseMarginWithEff + bonusAmt;

    // [v15.9.4] ì´ˆì›” ê°•í™” ìˆ˜ìµ ë³´ë„ˆìŠ¤(enhProfit) í˜„í™©íŒ ë°˜ì˜
    var profitBonusMult = 1 + ((user.enhProfit || 0) / 100);
    var enhancedBaseMargin = Math.floor(baseMarginWithEff * profitBonusMult); // ìˆœìˆ˜ìµì—ë§Œ ê°•í™” ì ìš©
    var margin = enhancedBaseMargin + bonusAmt; // ë°œì „ë„ ë³´ë„ˆìŠ¤ëŠ” ë‹¨ìˆœ í•©ì‚°

    var enhProfitTag = (user.enhProfit > 0) ? " (âœ¨ìˆ˜ìµê°•í™” +" + user.enhProfit + "%)" : "";

    var taxRate = (user.title === "ê¸°ë¶€ì™•") ? 0.05 : 0.10;

    /* afterTaxMargin ë³€ìˆ˜ë¥¼ ì„ ì–¸í•˜ì—¬ ì •ì˜ë˜ì§€ ì•ŠìŒ ì—ëŸ¬ í•´ê²° */
    var taxAmt = margin > 0 ? Math.floor(margin * taxRate) : 0;
    var afterTaxMargin = margin - taxAmt;

    if (v.escortFee) afterTaxMargin -= v.escortFee;
    if (margin > 0) afterTaxMargin -= Math.floor(margin * 0.01); 

    var crInfo = getCreditInfo(user.creditScore, roomName);
    var creditMult = util_getTradeCreditMult(crInfo.grade);
    var estimatedNetProfit = Math.floor(afterTaxMargin * creditMult);
    var finalReceipt = tCost + estimatedNetProfit;

    // í˜¸ìœ„ ì •ë³´ í…ìŠ¤íŠ¸ ì¶”ê°€
    var escortText = "âšª [ë‹¨ë… í•­í•´ ì¤‘]";
    if (v.escortUid) {
        var nObj = null;
        for (var r in data.rooms) { if (data.rooms[r].users[v.escortUid]) { nObj = data.rooms[r].users[v.escortUid]; break; } }
        escortText = "ğŸ›¡ï¸ [í˜¸ìœ„ ì¤‘]: " + (nObj ? nObj.name : "í•´êµ°í•¨");
    }

    var displayBody = "í˜„ì¬ [" + v.dest + "]ë¡œ í•­í•´ ì¤‘\n" + escortText + "\n\n" +
                      "ğŸ“¦ ì ì¬í•¨: " + totalCargoInShip + " / " + shipCapacity + " ì¹¸\n" + currentCargoLines.join("\n") + "\n\n" +
                      "ğŸ’° ì˜ˆìƒ ìˆ˜ë ¹ì•¡: " + fp(finalReceipt) + "P\n" +
                      "ğŸ’µ ì˜ˆìƒ ìˆœì´ìµ: " + fp(estimatedNetProfit) + "P" + enhProfitTag + "\n" +
                      "ğŸ•’ ë‚¨ì€ ì‹œê°„: " + (remain > 0 ? Math.ceil(remain/60000) + "ë¶„" : "ë„ì°© ì™„ë£Œ");

    replier.reply(formatCommand("ğŸ“¦ í•­í•´ í˜„í™©", user, displayBody, "ë„ì°© í›„ ì±„íŒ… ì…ë ¥ ì‹œ ì •ì‚°ë©ë‹ˆë‹¤."));
}

/* [ì„œë¸Œ] ğŸ› ï¸ ì„ ë°• ê´€ë¦¬ ë° ê°œì¡° */
function _manageShip(user, replier, cfg) {
    var curLevel = user.shipLevel || 1;
    var maxLevel = user.job ? 10 : 3; 
    var cur = cfg.SHIPS[curLevel];
    var next = cfg.SHIPS[curLevel + 1];
    // [v16.9] ë‚´êµ¬ë„ ë° ìˆ˜ë¦¬ë¹„ ê³„ì‚°
    var durability = Number(user.durability === undefined ? 100 : user.durability);
    var currentLoc = user.currentLoc || "ë¬´ì—­ ì§€ë¶€";
    var dIcon = durability > 50 ? "ğŸŸ¢" : (durability >= 20 ? "ğŸŸ¡" : "ğŸ”´");
    
    var body = "ë“±ê¸‰: " + cur.name + " (Lv." + curLevel + ")\n" +
               "ì ì¬ëŸ‰: " + (cur.capacity + (user.enhLimit || 0)) + "ì¹¸\n" +
               "ë‚´êµ¬ë„: " + dIcon + " " + durability + "%\n";

    // 1. í˜„ì¬ ì ìš© ì¤‘ì¸ ê°•í™” ìˆ˜ì¹˜ê°€ ìˆë‹¤ë©´ ë¨¼ì € í‘œì‹œ
    if ((user.enhLimit || 0) !== 0 || (user.enhTime || 0) !== 0 || (user.enhProfit || 0) !== 0) {
        body += "\n[âœ¨ ì´ˆì›” ê°•í™” ì ìš© í˜„í™©]\n" +
                "â€¢ ì ì¬ëŸ‰ ë³´ì •: " + (user.enhLimit >= 0 ? "+" : "") + user.enhLimit + "ì¹¸\n" +
                "â€¢ í•­í•´ì‹œê°„ ë³´ì •: " + (user.enhTime >= 0 ? "+" : "") + user.enhTime + "ì´ˆ\n" +
                "â€¢ ì •ì‚°ìˆ˜ìµ ë³´ì •: " + (user.enhProfit >= 0 ? "+" : "") + user.enhProfit + "%\n";
    }
    body += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";

    // [v16.9] ìˆ˜ë¦¬ ì•ˆë‚´ë¬¸ ë™ì  ì‚½ì…
    if (durability < 100) {
        if (currentLoc === "ë¬´ì—­ ì§€ë¶€") {
            var repairCost = (100 - durability) * 2000;
            body += "ğŸ”§ [ì„ ë°• ìˆ˜ë¦¬ ì„œë¹„ìŠ¤ ê°€ë™]\n" +
                    "â€¢ ë¹„ìš©: " + fp(repairCost) + "P (ì „ì•¡ ìˆ˜ë¦¬)\n" +
                    "ğŸ‘‰ ìˆ˜ë¦¬ ì§„í–‰: [ìˆ˜ë¦¬] ì…ë ¥\n\n";
        } else {
            body += "âš ï¸ [ì£¼ì˜] ì„ ì²´ íŒŒì† ìƒíƒœì…ë‹ˆë‹¤.\n" +
                    "ìˆ˜ë¦¬ëŠ” 'ë¬´ì—­ ì§€ë¶€'ì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.\n\n";
        }
    }

    // 2. ìµœê³  ë ˆë²¨ ì‹œ ê°•í™” ìƒì„¸ ì•ˆë‚´ UI
    if (curLevel >= maxLevel) {
        var ec = SHIP_ENHANCE_CONFIG; // ì„¤ì • ê°ì²´ ì°¸ì¡°
        body += "ğŸ”¥ [ìµœê³  ë ˆë²¨ ë„ë‹¬: ì´ˆì›” ê°•í™” í•´ê¸ˆ]\n" +
                fp(ec.COST) + "Pë¥¼ ì‚¬ìš©í•˜ì—¬ ì•„ë˜ 3ì¢… ì˜µì…˜ì„\n" +
                "ëœë¤í•˜ê²Œ ì¬ì„¤ì •(ë¦¬ë¡¤) í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n" +
                "[ğŸ² ê°•í™” ê°€ëŠ¥ ë²”ìœ„]\n" +
                "â€¢ ğŸ“¦ ì ì¬ëŸ‰: " + ec.LIMIT.min + "ì¹¸ ~ " + (ec.LIMIT.max >= 0 ? "+" : "") + ec.LIMIT.max + "ì¹¸\n" +
                "â€¢ ğŸ•’ í•­í•´ì‹œê°„: " + ec.TIME.min + "ì´ˆ ~ " + (ec.TIME.max >= 0 ? "+" : "") + ec.TIME.max + "ì´ˆ\n" +
                "â€¢ ğŸ’° ì •ì‚°ë³´ë„ˆìŠ¤: " + ec.PROFIT.min + "% ~ " + (ec.PROFIT.max >= 0 ? "+" : "") + ec.PROFIT.max + "%\n\n" +
                "ğŸ‘‰ ê°•í™” ì‹œë„: [ê°•í™”] ì…ë ¥";
    }
    // 3. ë ˆë²¨ì—… ê°€ëŠ¥ ì‹œ ê¸°ì¡´ ê°œì¡° ë¡œì§
    else if (next) {
        if (!user.job && curLevel >= 3) {
            body += "âš ï¸ [ê°œì¡° í•œê³„]\nìƒì¸ ì‹ ë¶„ìœ¼ë¡œëŠ” 3ë‹¨ê³„(ê°¤ë¦¬ì˜¨)ê°€ í•œê³„ì…ë‹ˆë‹¤.\nì¶”ê°€ ê°œì¡°ëŠ” í•´êµ°/í•´ì  ì „ì§ í›„ ê°€ëŠ¥í•©ë‹ˆë‹¤.";
        } else {
            body += "[ë‹¤ìŒ ë‹¨ê³„ ê°œì¡°]\nâ€¢ ëŒ€ìƒ: " + next.name + "\nâ€¢ ì ì¬: " + next.capacity + "ì¹¸\nâ€¢ ë¹„ìš©: " + fp(next.upgradeCost) + "P\n\n(ê°œì¡° ì‹œ 1ë²ˆ ì…ë ¥)";
        }
    } else {
        body += "ğŸ‰ ì´ë¯¸ ìµœê³ ë“±ê¸‰ ë‹¨ê³„ í•¨ì„ ì„ ë³´ìœ  ì¤‘ì…ë‹ˆë‹¤.";
    }

    body += "\n\nğŸ’° ë³´ìœ  í¬ì¸íŠ¸: " + fp(user.point) + "P\n\nâ†©ï¸ ë’¤ë¡œ / ğŸ  ì²˜ìŒìœ¼ë¡œ / âì·¨ì†Œ";
    replier.reply(formatCommand("ğŸ› ï¸ ì„ ë°• ê´€ë¦¬ì†Œ", user, body, "ê°•í™” ì‹œë„ ì‹œ [ê°•í™”]ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
}

/**
 * [v16.8] ì„ ë°• ë“±ê¸‰ ì—…ê·¸ë ˆì´ë“œ ì—”ì§„
 * ê¸°ëŠ¥: ìƒì¸(Lv.3 ì œí•œ) ë° ì§ì—…êµ°(Lv.10 ì œí•œ) ì„ ë°• ë“±ê¸‰ ìƒìŠ¹ ì²˜ë¦¬
 */
function _processShipUpgrade(user, data, replier, roomName, cfg) {
    var curLevel = Number(user.shipLevel || 1);
    var maxLevel = user.job ? 10 : 3;
    var next = cfg.SHIPS[curLevel + 1];

    if (!next || curLevel >= maxLevel) {
        var limitMsg = user.job ? "í˜„ì¬ í•¨ì„ ì´ ë„ë‹¬ ê°€ëŠ¥í•œ ìµœì¢… ë“±ê¸‰ì…ë‹ˆë‹¤." : "ìƒì¸ ì‹ ë¶„ìœ¼ë¡œëŠ” 3ë‹¨ê³„ê¹Œì§€ë§Œ ê°œì¡° ê°€ëŠ¥í•©ë‹ˆë‹¤.\nì¶”ê°€ ê°œì¡°ëŠ” í•´êµ°/í•´ì  ì „ì§ì´ í•„ìš”í•©ë‹ˆë‹¤.";
        return replier.reply(formatError(user, "ê°œì¡° ë¶ˆê°€", limitMsg));
    }

    if (Number(user.point) < next.upgradeCost) {
        return replier.reply(formatError(user, "ìê¸ˆ ë¶€ì¡±", "ê°œì¡° ë¹„ìš© " + fp(next.upgradeCost) + "Pê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."));
    }

    var logicRoom = (ALLOWED_ROOMS.indexOf(roomName) === -1) ? "ë‚´ë¦¬ë‹¤" : roomName;
    var roomData = data.rooms[logicRoom];

    // 1. í¬ì¸íŠ¸ ê²Œì´íŠ¸ì›¨ì´ ì •ì‚°
    util_updatePoint(user, roomData, -next.upgradeCost, "ì„ ë°• ë“±ê¸‰ ì—…ê·¸ë ˆì´ë“œ: " + next.name, roomName);

    // 2. ë ˆë²¨ì—… ë°˜ì˜ ë° ë³´ì•ˆ ë©´ì œ
    user.shipLevel = curLevel + 1;
    user.skipHealing = true;

    var resMsg = "í•¨ì„  ì„¤ê³„ë„ë¥¼ ê°±ì‹ í•˜ê³  ê°œì¡°ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!\n\n" +
                 "ğŸš¢ ìƒˆë¡œìš´ ë“±ê¸‰: [" + next.name + "]\n" +
                 "ğŸ“¦ ê¸°ë³¸ ì ì¬ëŸ‰: " + next.capacity + "ì¹¸\n" +
                 "ğŸ’° ì†Œëª¨ ë¹„ìš©: -" + fp(next.upgradeCost) + "P";

    replier.reply(formatCommand("ğŸ—ï¸ ì„ ë°• ë“±ê¸‰ ì—…ê·¸ë ˆì´ë“œ ì™„ë£Œ", user, resMsg, "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
    
    // 3. ì¦‰ì‹œ ì˜ì†í™”
    safeSaveData(data, true);
}

// [ì‹ ì„¤] ê°•í™” ì£¼ì‚¬ìœ„ ë¡œì§ (ì„¹í„° 51 í•˜ë‹¨ ì¶”ê°€)
function _processShipEnhanceRoll(user, data, replier, roomName) {
    var ec = SHIP_ENHANCE_CONFIG;
    var cost = ec.COST;
    if (Number(user.point) < cost) {
        return replier.reply(formatError(user, "ìê¸ˆ ë¶€ì¡±", "ê°•í™” ì‹œë„ì—ëŠ” " + fp(cost) + "Pê°€ í•„ìš”í•©ë‹ˆë‹¤."));
    }

    util_updatePoint(user, data.rooms["ë‚´ë¦¬ë‹¤"], -cost, "í•¨ì„  ì´ˆì›” ê°•í™” ì‹œë„", roomName);

    /**
     * [v15.8] ì§€ëŠ¥í˜• í™•ë¥  ë³´ì • ì—”ì§„ (Subtle Skew Logic)
     * ê°€ì¤‘ì¹˜(skew)ê°€ 1.0ë³´ë‹¤ í¬ë©´ ë‚®ì€ ê°’(Bad)ì´, 1.0ë³´ë‹¤ ì‘ìœ¼ë©´ ë†’ì€ ê°’(Good)ì´ ë” ì˜ ë‚˜ì˜µë‹ˆë‹¤.
     * 1.2 ì •ë„ì˜ ìˆ˜ì¹˜ëŠ” ìˆ˜ë°± ë²ˆ ì´ìƒ ìˆ˜í–‰í•´ì•¼ ì²´ê°ë  ì •ë„ë¡œ ë§¤ìš° ì •êµí•˜ê³  í‹°ê°€ ë‚˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
     */
    var skewBad = 1.3; 

    // 1. ì ì¬ëŸ‰/ìˆ˜ìµ: ë†’ì€ ìˆ˜ì¹˜ê°€ 'ì¢‹ìŒ' -> ë‚®ì€ ìª½(min)ìœ¼ë¡œ í™•ë¥  ë°€ì–´ë‚´ê¸°
    var randLimit = Math.pow(Math.random(), skewBad);
    var rLimit = Math.floor(randLimit * (ec.LIMIT.max - ec.LIMIT.min + 1)) + ec.LIMIT.min;

    var randProfit = Math.pow(Math.random(), skewBad);
    var rProfit = Math.floor(randProfit * (ec.PROFIT.max - ec.PROFIT.min + 1)) + ec.PROFIT.min;

    // 2. í•­í•´ì‹œê°„: ë†’ì€ ìˆ˜ì¹˜ê°€ 'ë‚˜ì¨'(+ì´ˆ) -> ë†’ì€ ìª½(max)ìœ¼ë¡œ í™•ë¥  ë°€ì–´ë‚´ê¸°
    // (1 - ë‚œìˆ˜) ê³µì‹ì„ ì¨ì„œ í™•ë¥ ì˜ ë¬´ê²Œë¥¼ ë°˜ëŒ€í¸ìœ¼ë¡œ ë³´ëƒ…ë‹ˆë‹¤.
    var randTime = 1 - Math.pow(Math.random(), skewBad);
    var rTime = Math.floor(randTime * (ec.TIME.max - ec.TIME.min + 1)) + ec.TIME.min;

    user.tempEnh = { limit: rLimit, time: rTime, profit: rProfit };

    var body = "ğŸ² ì´ˆì›” ê°•í™” ê²°ê³¼ê°€ ë„ì¶œë˜ì—ˆìŠµë‹ˆë‹¤!\n\n" +
               "[í•­ëª©] : [í˜„ì¬] + [ê°•í™”ê°’] â” [ìµœì¢… ì˜ˆìƒ]\n" +
               "ğŸ“¦ ì ì¬: " + (user.enhLimit || 0) + " + (" + (rLimit >= 0 ? "+" : "") + rLimit + ") â” " + ((user.enhLimit || 0) + rLimit) + "ì¹¸\n" +
               "ğŸ•’ ì‹œê°„: " + (user.enhTime || 0) + " + (" + (rTime >= 0 ? "+" : "") + rTime + ") â” " + ((user.enhTime || 0) + rTime) + "ì´ˆ\n" +
               "ğŸ’° ìˆ˜ìµ: " + (user.enhProfit || 0) + " + (" + (rProfit >= 0 ? "+" : "") + rProfit + ") â” " + ((user.enhProfit || 0) + rProfit) + "%\n\n" +
               "âš ï¸ ìƒˆë¡œìš´ ìˆ˜ì¹˜ë¥¼ ëˆ„ì í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n" +
               "(1ë²ˆ ì„ íƒ ì‹œ í˜„ì¬ ìˆ˜ì¹˜ì— ì¦‰ì‹œ ë”í•´ì§‘ë‹ˆë‹¤)\n\n" +
               "1. ì˜ˆ (ëˆ„ì  ì ìš©)\n" +
               "2. ì•„ë‹ˆì˜¤ (ì·¨ì†Œ/ìœ ì§€)";

    replier.reply(formatCommand("ğŸ—ï¸ í•¨ì„  ì´ˆì›” ê°œì¡° ê²°ê³¼", user, body, "ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
    
    var logicRoom = (ALLOWED_ROOMS.indexOf(roomName) === -1) ? "ë‚´ë¦¬ë‹¤" : roomName;
    data.rooms[logicRoom].features.states.menuWait[user.uid] = { type: 'trade_enh_confirm', time: Date.now(), originRoom: roomName };
    safeSaveData(data);
}

/**
 * [í•µì‹¬ ì—”ì§„] ë¬´ì—­ ì •ì‚° ë° ì¬í•´ ì—”ì§„ v1.5
 */
function _processTradeArrival(user, data, replier, roomName, targetUid) {
    // 0. [ì—ëŸ¬ ë°©ì§€] ë³€ìˆ˜ ì„ ì–¸ ë° ë°ì´í„° ì¡´ì¬ ì—¬ë¶€ ìµœìš°ì„  ê²€ì¦
    if (!user || !user.voyage) return; // í•­í•´ ì¤‘ì´ ì•„ë‹ˆë©´ ì¦‰ì‹œ ì¢…ë£Œ
    var v = user.voyage; 

    util_fastClean(user);
    if (v) util_fastClean(v);

    // 1. ê¸°ì´ˆ ì„¤ì • ë° ì •ì±… ë¡œë“œ
    var economyRoomName = (ALLOWED_ROOMS.indexOf(roomName) === -1) ? "ë‚´ë¦¬ë‹¤" : roomName;
    var economyRoomData = data.rooms[economyRoomName];
    var pol = util_getActivePolicy(economyRoomData);
    var cfg = SYSTEM_CONFIG.TRADE;

    // 2. [v16.3] ë‹¨ì¼ ì´ë²¤íŠ¸ ì¶”ì²¨ (í•¨ìˆ˜ ì‹œì‘ ì‹œ ë”± í•œ ë²ˆë§Œ!)
    var baseDisasterProb = cfg.EVENTS.PROB || 0.40;
    var finalDisasterProb = baseDisasterProb * (pol.disasterProbMult || 1.0);
    var triggeredDisaster = null;

    if (Math.random() < finalDisasterProb) {
        var eventKeys = ["STORM", "FIRE", "CORROSION", "SMOOTH", "FESTIVAL", "FLOTSAM", "MONSTER", "FOG", "SCURVY"];
        triggeredDisaster = eventKeys[Math.floor(Math.random() * eventKeys.length)];

        // [ì•ˆì „ ê°€ë“œ] ì„¤ì •ê°’(cfg)ì— í•´ë‹¹ í‚¤ê°€ ì—†ìœ¼ë©´ ì´ë²¤íŠ¸ ì·¨ì†Œ (Crash ë°©ì§€)
        if (!cfg.EVENTS.LIST[triggeredDisaster]) {
            Log.warn("âš ï¸ [Trade Warning] ì„¤ì •(Sector 1)ì— ì—†ëŠ” ì´ë²¤íŠ¸ í‚¤ê°€ ì¶”ì²¨ë¨: " + triggeredDisaster);
            triggeredDisaster = null; 
        }
    }
    // [v16.4] í•´ìƒì™• ì¹­í˜¸ íš¨ê³¼ ê°œí¸: ë””ë²„í”„(ì¬í•´) ë°œìƒ ì‹œ 50% í™•ë¥ ë¡œ ê°€ë“œ ë°œë™
        var seaKingTag = "";
        var debuffs = ["STORM", "FIRE", "CORROSION", "PIRACY", "MONSTER", "FOG", "SCURVY"];
        if (user.title === "í•´ìƒì™•" && triggeredDisaster && debuffs.indexOf(triggeredDisaster) !== -1) {
            if (Math.random() < 0.5) {
                triggeredDisaster = null; // ì¬í•´ ë¬´íš¨í™”
                seaKingTag = " (âœ¨í•´ìƒì™• ê°€ë“œ ë°œë™!)";
            }
        }

    // 3. ì •ì‚°ìš© ë³€ìˆ˜ ì´ˆê¸°í™”
    var totalRevenue = 0;
    var totalCost = 0;
    var soldLog = [];
    var disasterLog = "";
    var hasFavoriteSold = false;

    // 1. [ì ê¸ˆ í†µí•© ê´€ë¦¬]: 1ë¶„ ì´ìƒ ì ê²¨ìˆìœ¼ë©´ ìœ ë ¹ ì ê¸ˆìœ¼ë¡œ íŒë‹¨í•˜ì—¬ í•´ì œ í›„ ì§„í–‰
    if (v.isProcessing === true) {
        if (Date.now() - (v.arrival || 0) > 60000) {
            v.isProcessing = false; 
            Log.warn("ğŸ”“ [Trade] " + user.name + "ì˜ ì •ì‚° ì ê¸ˆì„ ê°•ì œ í•´ì œí–ˆìŠµë‹ˆë‹¤.");
        } else {
            return; // 1ë¶„ ì´ë‚´ ì¤‘ë³µ ì‹¤í–‰ ì°¨ë‹¨ (ë„ë°° ë°©ì§€)
        }
    }
    
    v.isProcessing = true; // 2. [ì ê¸ˆ ì‹¤í–‰]: ì •ì‚° í”„ë¡œì„¸ìŠ¤ ì ìœ 

    try { // 3. [ë³´í˜¸ë§‰ ì‹œì‘]: ë‹¨ í•œ ë²ˆì˜ tryë¡œ ëª¨ë“  ë¡œì§ì„ ê°ì‹¸ ë¬¸ë²• ì˜¤ë¥˜ë¥¼ ì°¨ë‹¨í•¨

        // 4. ë¶ˆí•„ìš”í•œ ê°ì²´ ì°¸ì¡° ì¦‰ì‹œ ì œê±°
        if (user.replier) delete user.replier;
        if (user.imageDB) delete user.imageDB;
        if (v.replier) delete v.replier;
        if (user.lastAction && user.lastAction.replier) delete user.lastAction.replier;

        // 5. [ë°ì´í„° ë³µêµ¬]: ìŠ¤ëƒ…ìƒ· ëˆ„ë½ ì‹œ í˜„ì¬ ë°ì´í„°ë¡œ ê¸´ê¸‰ ìˆ˜í˜ˆ (ì•ˆì •ì„± ê°•í™”)
        var mainRoom = data.rooms["ë‚´ë¦¬ë‹¤"];
        if (!v.marketSnapshot) v.marketSnapshot = (mainRoom && mainRoom.features.tradeMarket) ? mainRoom.features.tradeMarket : SYSTEM_CONFIG.TRADE.NATIONS;
        if (!v.cargoSnapshot) v.cargoSnapshot = user.cargo || {};
        if (!v.specialtySnapshot) v.specialtySnapshot = user.specialties || {};
        if (!v.ecoMultSnapshot) v.ecoMultSnapshot = util_getEcoMultiplier("ë‚´ë¦¬ë‹¤");

        var cfg = SYSTEM_CONFIG.TRADE;
        
        // 6. í˜„ì¬ ë°© ë°ì´í„° ë³µêµ¬ ë° ê²½ì œ êµ¬ì—­ ì„¤ì • (1:1ë°© ì—°ë™ìš©)
        var economyRoomName = (ALLOWED_ROOMS.indexOf(roomName) === -1) ? "ë‚´ë¦¬ë‹¤" : roomName;
        var economyRoomData = data.rooms[economyRoomName];
        var roomData = data.rooms[roomName] || economyRoomData; 

        // 7. [í•µì‹¬] ì •ì‚° ì‹œ ë¶€ë„ ê°€ë“œ (ë©”ì¸ êµ¬ì—­ ê¸°ì¤€ìœ¼ë¡œ ì”ì•¡ ì²´í¬)
        if (typeof util_isBankruptcy === 'function' && util_isBankruptcy(economyRoomName)) {
            v.isProcessing = false; 
            if (v.isAlerted === true) return; 
            v.isAlerted = true; 
            
            var bankMsg = "ë¬´ì—­ì„ ì´ í•­êµ¬ì— ë„ì°©í–ˆìœ¼ë‚˜, [" + economyRoomName + "] êµ¬ì—­ì˜ ë¶€ë„ ìƒíƒœë¡œ ì¸í•´\n" +
                          "ì •ì‚°ê¸ˆì„ ì§€ê¸‰í•  ì¬ì›ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.\n\n" +
                          "ğŸ“¦ ìƒíƒœ: í™”ë¬¼ ë³´ì¡´ ë° ì…í•­ ëŒ€ê¸°\n" +
                          "ğŸ’° ì¡°ì¹˜: êµ­ê³  ë³µêµ¬ í›„ ì±„íŒ… ì…ë ¥ ì‹œ ìë™ ì •ì‚°";
            
            Api.replyRoom("ë‚´ë¦¬ë‹¤", formatCommand("âš“ ì…í•­ ëŒ€ê¸° (ì§€ë¶ˆ ì •ì§€)", user, bankMsg, "í•´ì œ ê¸°ì¤€: êµ­ê³  50% ë³µêµ¬"));
            safeSaveData(data, false);
            return;
        }

        v.isAlerted = false; // 8. ì •ì‚° í”„ë¡œì„¸ìŠ¤ ìƒíƒœ ì´ˆê¸°í™”

   // [ë³´ì•ˆ] ì‹¤ì‹œê°„ ê°€ë°©ì´ ì•„ë‹Œ, ì¶œí•­ ì‹œ ë°•ì œí–ˆë˜ ìŠ¤ëƒ…ìƒ·ì„ ì •ì‚° ëŒ€ìƒìœ¼ë¡œ ì„¤ì •
    // 1. [Snapshot] ì¶œí•­ ì‹œì ì˜ ê³ ì • ë°ì´í„°ë“¤ì„ ì •ì‚° ëŒ€ìƒìœ¼ë¡œ ì„¤ì • (íœ˜ë°œì„±/ë¡¤ë°± ë°©ì§€)
    var cargoToSell = v.cargoSnapshot || user.cargo || {};
    var specialtyToSell = v.specialtySnapshot || user.specialties || {};
    var producedByDest = TRADE_RELATION[v.dest] ? TRADE_RELATION[v.dest].produce : "";

    // ìˆ˜ì •: nationInfo ë³€ìˆ˜ ì„ ì–¸ ì¶”ê°€ (ReferenceError í•´ê²°)
    var nationInfo = (v.marketSnapshot && v.marketSnapshot[v.dest]) ? v.marketSnapshot[v.dest] : cfg.NATIONS[v.dest];
    
    var totalRevenue = 0; 
    var totalCost = 0; 
    var totalSpecRev = 0;  // ì—˜ë„ë¼ë„ ê³„ì‚°ìš©: íŠ¹ì‚°í’ˆ ì´ ë§¤ì¶œ
    var totalSpecCost = 0; // ì—˜ë„ë¼ë„ ê³„ì‚°ìš©: íŠ¹ì‚°í’ˆ ì´ ì›ê°€
    var soldLog = []; 
    var disasterLog = ""; 
    var cargoSummary = []; 
    var piracyLog = ""; 
    var piracyLoot = 0; // <--- ë³€ìˆ˜ ì„ ì–¸ ì¶”ê°€
    var taxAmount = 0;  
    var taxTag = "";    
    var pBonusTotal = 0;

    // 2. ì¼ë°˜ í™”ë¬¼ ì‹¤ì •ì‚° (ë§¤ì…ê°€ ê·¸ëŒ€ë¡œ ì ìš© ë¡œì§)
    for (var good in cargoToSell) {
        var count = Number(cargoToSell[good]); if (count <= 0) continue;
        
        // ëª¨ë“  ê³„ì‚°ì˜ ê¸°ì´ˆê°€ ë˜ëŠ” 'ì›ê°€'ë¥¼ ë£¨í”„ ìµœìƒë‹¨ì—ì„œ ë¨¼ì € ì •ì˜í•©ë‹ˆë‹¤.
        var myPurchasePrice = Number((user.cargoAvg && user.cargoAvg[good]) || cfg.GOODS_COST[good] || 10000);
        var itemCost = Number(myPurchasePrice * count); // ì—¬ê¸°ì„œ itemCostë¥¼ í™•ì‹¤íˆ ì •ì˜

        totalCost += itemCost;
        
        var rateInfo = SYSTEM_CONFIG.PROFIT_RATES[good] || { pref: 1.25, norm: 1.05, hate: 0.8 };
        var pInfo = (roomData.features.portData && roomData.features.portData[v.dest]) ? roomData.features.portData[v.dest] : { level: 1 };
        var portLevelBonus = Number((pInfo.level - 1) * (cfg.INVEST.BONUS_PER_LEVEL || 0.01));
        var multiplier = 1.0;

        if (good === producedByDest) {
            multiplier = 0; // ë§¤ì¶œì•¡ 0 ì²˜ë¦¬
            totalCost -= itemCost; // ì›ê°€ ê³„ì‚°ì—ì„œ ì œì™¸ (ë‚´ ê°€ë°©ì— ê·¸ëŒ€ë¡œ ë‚¨ìœ¼ë¯€ë¡œ)
            disasterLog += "\nğŸš« [ë°˜ì… ì œí•œ]: ìêµ­ ìƒì‚°ë¬¼ '" + good + "'ì€ ë§¤ì…ì´ ê±°ë¶€ë˜ì–´ ì°½ê³ ë¡œ ë°˜í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.";
            // ì‹¤ì œ ìœ ì €ì˜ ê°€ë°© ìˆ˜ëŸ‰ì„ ì‚­ê°í•˜ì§€ ì•Šê¸° ìœ„í•´ ì•„ë˜ì—ì„œ ê±´ë„ˆëœ€
        } else {
            if (good === nationInfo.favorite) {
                // ìƒë‹¨ì—ì„œ ì„ ì–¸ëœ itemCostë¥¼ ì•ˆì „í•˜ê²Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
                var baseEarn = Math.floor(myPurchasePrice * rateInfo.pref * count);
                var baseMargin = baseEarn - itemCost;
                var bonusAmt = baseMargin > 0 ? Math.floor(baseMargin * portLevelBonus * (pol.tradeBonusMult || 1.0)) : 0;
                
                pBonusTotal += bonusAmt;
                // 0 ë‚˜ëˆ„ê¸° ë°©ì§€ë¥¼ ìœ„í•´ itemCostê°€ 0ë³´ë‹¤ í´ ë•Œë§Œ ë°°ìœ¨ ê³„ì‚°
                multiplier = itemCost > 0 ? ((baseEarn + bonusAmt) / itemCost) : rateInfo.pref;
            }
            else if (good === nationInfo.hate) multiplier = rateInfo.hate;
            else multiplier = rateInfo.norm;
        }

        // ì¬í•´ ì²˜ë¦¬ (ìˆ˜ëŸ‰/ê°€ì¹˜ ì°¨ê°)
        if (triggeredDisaster === "FIRE" && (good === "ì‹ë£Œí’ˆ" || good === "ê³µì˜ˆí’ˆ")) {
            var lost = Math.ceil(count * 0.1); count -= lost;
            disasterLog += "\nğŸ”¥ [ì¬í•´: í™”ì¬]: " + good + " " + lost + "ìƒì ì†Œì‹¤";
        } else if (triggeredDisaster === "CORRO" && (good === "ê³µì—…í’ˆ" || good === "ê·€ê¸ˆì†")) {
            multiplier *= 0.9;
            disasterLog += "\nğŸ§ª [ì¬í•´: ë¶€ì‹]: í™”ë¬¼ ê°€ì¹˜ 10% í•˜ë½";
        }

        // ìµœì¢… ê°œë³„ ë§¤ì¶œ = ë‚´ ë§¤ì…ê°€ * ìˆ˜ìµë¥ % * ë‚¨ì€ ìˆ˜ëŸ‰
        var earn = Math.floor(myPurchasePrice * multiplier * count);
        totalRevenue += earn;
        cargoSummary.push(good + "x" + count);

        if (count > 0 && multiplier > 0) {
            var sign = (multiplier >= 1.1) ? "ğŸ”º" : (multiplier <= 0.9 ? "ğŸ”¹" : "â–");
            soldLog.push("â€¢ " + good + " x" + count + ": " + fp(earn) + "P " + sign);
        }
        
        // ë§¤ì… ê±°ë¶€ëœ í’ˆëª©ì´ ì•„ë‹ ë•Œë§Œ ê°€ë°©(í‰ë‹¨ê°€/ìˆ˜ëŸ‰)ì„ ë¹„ì›€
        if (good !== producedByDest) {
            if (user.cargo) user.cargo[good] = 0;
            if (user.cargoAvg) user.cargoAvg[good] = 0;
        }
    }

    // 3. íŠ¹ì‚°í’ˆ ì •ì‚° (specialtyToSell ìŠ¤ëƒ…ìƒ· ê¸°ë°˜ ë£¨í”„)
    for (var sName in specialtyToSell) {
        var sCount = Number(specialtyToSell[sName]); if (sCount <= 0) continue;
        var sMult = 1.0; var sTag = "";

        var parentGood = "";
        var sBasePrice = 10000; // ê¸°ë³¸ê°’ (í´ë°±)

        // í•´ë‹¹ íŠ¹ì‚°í’ˆì˜ ìƒìœ„ ì¹´í…Œê³ ë¦¬(produce) ë° ê·¸ì— ë”°ë¥¸ ê¸°ë³¸ ê°€ê²© íƒìƒ‰
        for (var n in TRADE_RELATION) {
            if (TRADE_RELATION[n].set === sName) { 
                parentGood = TRADE_RELATION[n].produce; 
                sBasePrice = cfg.SPECIALTY_COST[parentGood] || 10000;
                break; 
            }
        }

        // [v16.7] ì›ê°€ ì¼ë‹¨ í•©ì‚°
        var currentItemCost = (sBasePrice * sCount);
        totalCost += currentItemCost;

        if (parentGood === producedByDest) {
            sMult = 0;
            totalCost -= (sBasePrice * sCount); // ì›ê°€ ì œì™¸
            disasterLog += "\nğŸš« [í†µê´€ ê±°ë¶€]: ìêµ­ íŠ¹ì‚°í’ˆ '" + sName + "'ì€ ë§¤ì…ì´ ê±°ë¶€ë˜ì–´ ì°½ê³ ë¡œ ë°˜í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.";
        } else if (parentGood === nationInfo.favorite) {
            sMult = cfg.SPECIALTY_PROFIT;
            sTag = "â­ [ì„¸íŠ¸ìˆ˜ìš”]";
        } else if (parentGood === nationInfo.hate) {
            sMult = 0.5;
            sTag = "ğŸ”¹ [ìˆ˜ìš”ê¸‰ê°]";
        }

       // [v16.7] ë§¤ì¶œ ê³„ì‚° ë° ì—˜ë„ë¼ë„ìš© ë³€ìˆ˜ ëˆ„ì  (ì¤‘ìš”!)
        var sRev = Math.floor(sBasePrice * sCount * sMult);
        
        if (sMult > 0) {
            totalRevenue += sRev;
            totalSpecRev += sRev;           // ì—˜ë„ë¼ë„ ì •ì‚° ì‹œ ëº„ ê¸ˆì•¡
            totalSpecCost += currentItemCost; // ì—˜ë„ë¼ë„ ì •ì‚° ì‹œ ëº„ ì›ê°€
            soldLog.push("â€¢ [íŠ¹] " + sName + " x" + sCount + ": " + fp(sRev) + "P " + sTag);
            cargoSummary.push(sName + "x" + sCount); // ë¦¬í¬íŠ¸ ìš”ì•½ìš© ì¶”ê°€
        }

        if (parentGood !== producedByDest) {
            if (user.specialties) user.specialties[sName] = 0;
        }
    }

    // [ğŸš¨ í•µì‹¬] ë£¨í”„ê°€ ëª¨ë‘ ëë‚œ ì§í›„ì— ìš”ì•½ ë¬¸ìì—´ ìƒì„±
    var cargoSummaryStr = cargoSummary.join(", ");

    // 5. [í•µì‹¬] ìˆœìˆ˜ìµ(ë§ˆì§„) ê¸°ë°˜ ì°¨ë“± ì •ì‚° ë¡œì§
    var baseMargin = totalRevenue - totalCost; // ìˆœìˆ˜ ë§ˆì§„(ì´ìµê¸ˆ) ì‚°ì¶œ

    // [ì„ ë°• ì²´ê¸‰ë³„ ìˆ˜ìµ êµ¬ê°„ ê°•ì œ ë°¸ëŸ°ì‹± ì—”ì§„]
    var shipEfficiency = 1.0;
    if (user.shipLevel === 1) shipEfficiency = 3.5; 
    else if (user.shipLevel === 2) shipEfficiency = 1.5; 
    else shipEfficiency = 1.0; 

    // 1ë‹¨ê³„: ì„ ë°• íš¨ìœ¨ì´ ì ìš©ëœ 'ê¸°ì´ˆ ìˆ˜ìµ' í™•ì • (ë³€ìˆ˜ëª…ì„ shipEffë¡œ í†µì¼)
    var shipEff = (user.shipLevel === 1) ? 3.5 : (user.shipLevel === 2 ? 1.5 : 1.0);
    var efficientMargin = Math.floor(baseMargin * shipEff);

    // 1-2ë‹¨ê³„: ì—˜ë„ë¼ë„(ìŠí˜€ì§„ ì„±ì—­) ì „ìš© ìˆ˜ìµ ì¦í­ ë° íŠ¹ì‚°í’ˆ ë°°ì œ
    if (v.dest === ELDORADO_CONFIG.NAME) {
        // [ìˆ˜ì •] ìœ„ì—ì„œ ì„ ì–¸í•œ shipEffë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì—¬ 'ìˆœìˆ˜ ì¼ë°˜ êµì—­í’ˆ ë§ˆì§„' ê³„ì‚°
        var pureCargoMargin = Math.floor((totalRevenue - totalSpecRev - (totalCost - totalSpecCost)) * shipEff);
        
        // ì—˜ë„ë¼ë„ëŠ” ê¸°ì´ˆ íš¨ìœ¨ ë§ˆì§„ì„ 2ë°°(PROFIT_MULT)ë¡œ ì¦í­
        efficientMargin = pureCargoMargin * ELDORADO_CONFIG.PROFIT_MULT;
        
        // ì—˜ë„ë¼ë„ëŠ” ìì¹˜ë ¹ ë³´ë„ˆìŠ¤(pBonusTotal)ë¥¼ 0ìœ¼ë¡œ ê³ ì •
        pBonusTotal = 0; 
        
        // ë¦¬í¬íŠ¸ ê°€ë…ì„±ì„ ìœ„í•´ íŠ¹ì‚°í’ˆ íŒë§¤ ë¡œê·¸ í•„í„°ë§
        soldLog = soldLog.filter(function(line){ return line.indexOf("[íŠ¹]") === -1; });
        disasterLog += "\nâœ¨ [í™©ê¸ˆì˜ ê°€í˜¸]: ì—˜ë„ë¼ë„ì˜ ê¸°ìš´ìœ¼ë¡œ ì¼ë°˜ êµì—­ ìˆœìˆ˜ìµì´ 2ë°°ë¡œ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.";
    } 
    else {
        // 2ë‹¨ê³„: ì¼ë°˜ í•­êµ¬ì¼ ê²½ìš° ê¸°ì¡´ì˜ ë°œì „ë„ ë³´ë„ˆìŠ¤ ì‚°ì¶œ ë¡œì§ ìˆ˜í–‰
        var pInfo = (economyRoomData.features.portData && economyRoomData.features.portData[v.dest]) ? economyRoomData.features.portData[v.dest] : { level: 1 };
        var portLevelRate = Number((pInfo.level - 1) * 0.01);
        pBonusTotal = efficientMargin > 0 ? Math.floor(efficientMargin * portLevelRate) : 0;
    }

    // 3ë‹¨ê³„: ìµœì¢… ì„¸ì „ ë§ˆì§„ í™•ì •
    var margin = efficientMargin + pBonusTotal;

    // === [v16.1] ì§€ëŠ¥í˜• ê´€ì„¸ ë° ë°±ë¶„ìœ„ ì—”ì§„ êµì • (1:1ë°© ì—°ë™ ìµœì í™”) ===
    var autoTaxRate = 0.05; // ê¸°ë³¸ í•˜í•œ ì„¸ìœ¨ 5%
    var taxBenefitTag = "";

    try {
        // [êµì •] roomName ëŒ€ì‹  ì‹¤ì œ ìœ ì € ë°ì´í„°ê°€ ëª¨ì—¬ìˆëŠ” economyRoomName(ë‚´ë¦¬ë‹¤)ì„ ì „ë‹¬
        var percentile = (typeof util_getNetWorthPercentile === 'function') ? 
                         util_getNetWorthPercentile(user, economyRoomName) : 50;

        // 1. ìì‚° ë°±ë¶„ìœ„ì— ë”°ë¥¸ ê¸°ë³¸ ì„¸ìœ¨ ê²°ì •
        if (percentile <= 15) autoTaxRate = 0.10;      // ìƒìœ„ 15% (ìì‚°ê°€)
        else if (percentile <= 40) autoTaxRate = 0.07; // ìƒìœ„ 40% (ì¤‘ì‚°ì¸µ)
        else autoTaxRate = 0.05;                       // ê·¸ ì™¸ (ì„œë¯¼ì¸µ)

        // 2. [ììœ¨ ì§€ëŠ¥] êµ­ê³  ìœ„ê¸° ìƒíƒœì— ë”°ë¥¸ ë°©ì–´ ê´€ì„¸ ê°€ì‚° (economyRoomData ì°¸ì¡°)
        if (economyRoomData.lastBankAlert === "warning") autoTaxRate += 0.02;
        else if (economyRoomData.lastBankAlert === "disaster") autoTaxRate += 0.05;

        // 3. [ì¹­í˜¸ í˜œíƒ] ê¸°ë¶€ì™• ìµœì¢… ì„¸ìœ¨ 50% ê°ë©´
        if (user.title === "ê¸°ë¶€ì™•") {
            autoTaxRate *= 0.5;
            taxBenefitTag = " âœ¨ê¸°ë¶€ì™• í˜œíƒ";
        }
    } catch (e) {
        Log.error("ë¬´ì—­ ê´€ì„¸ ê³„ì‚° ì˜¤ë¥˜: " + e);
        autoTaxRate = 0.05; // ì—ëŸ¬ ì‹œ ê¸°ë³¸ì„¸ìœ¨ë¡œ íšŒê·€ (ë¬´í•œ ë£¨í”„ ë°©ì§€)
    }

    // [í™•ì •] ë§ˆì§„ì´ ì´ë“(>0)ì¼ ë•Œë§Œ ì„¸ê¸ˆ ê³„ì‚°, ì†ì‹¤ ì‹œ 0P ì²˜ë¦¬
    taxAmount = margin > 0 ? Math.floor(margin * autoTaxRate) : 0;
    var taxPercentText = (autoTaxRate * 100).toFixed(1);
    var afterTaxMargin = margin - taxAmount;

    // [ê´€ì„¸] ì´ë… ê´€ì„¸ ì§•ìˆ˜ ë¡œì§
    var pDataPath = roomData.features.portData;
    var govInfo = (pDataPath && pDataPath[v.dest]) ? pDataPath[v.dest] : null;
    var govTag = "";
    if (govInfo && govInfo.governorUid && govInfo.governorUid !== "") {
        if (govInfo.governorUid !== targetUid) {
            var tariff = margin > 0 ? Math.floor(margin * 0.01) : 0;
            afterTaxMargin -= tariff;
            govInfo.collectedTariff = (Number(govInfo.collectedTariff) || 0) + tariff;
            
            // ì‹¤ì œ ëˆì„ êµ­ê³ ë¡œ ì…ê¸ˆ ì²˜ë¦¬ (íšŒê³„ ì¥ë¶€ ì¼ì¹˜í™”)
            if (tariff > 0) {
                util_updateReserve(economyRoomData, tariff, "ìì¹˜ë ¹ ê´€ì„¸ êµ­ê³  ì…ê³  (" + v.dest + ")", economyRoomName);
            }
            var gUser = roomData.users[govInfo.governorUid];
            govTag = "\nğŸª™ ê´€ì„¸(1%): -" + fp(tariff) + "P (" + (gUser ? gUser.name : "ì´ë…") + " ì§•ìˆ˜)";
        } else { 
            govTag = "\nğŸ‘‘ [ìì¹˜ë ¹ íŠ¹ê¶Œ]: ê´€ì„¸ ë©´ì œ ì ìš©"; 
        }
    }

    // [ì‹ ìš©] ë“±ê¸‰ë³„ ìˆ˜ìµ ë°°ìœ¨ ì ìš© (ë§ˆì§„ì—ë§Œ ì ìš©)
    var crInfo = getCreditInfo(user.creditScore, roomName);
    var creditMult = util_getTradeCreditMult(crInfo.grade);
    var finalNetProfit = Math.floor(afterTaxMargin * creditMult); 

    // [ì •ë¶€ ì •ì±… ì—°ë™] ì˜íšŒ ê°€ê²° ì•ˆê±´ì— ë”°ë¥¸ ì¶”ê°€ ì„¸ê¸ˆ ë° ìˆ˜ìµ ì¡°ì •
    if (finalNetProfit > 0) {
        // 1. ë¬´ì—­ ì „ìš© ì†Œë“ì„¸ (ì˜ˆ: ê°•íƒœê³µì˜ ì¶•ì œë ¹ - ìˆœì´ìµ 15% ì°¨ê°)
        if (pol.tradeIncomeTax) {
            var specialTax = Math.floor(finalNetProfit * pol.tradeIncomeTax);
            finalNetProfit -= specialTax;
            util_updateReserve(economyRoomData, specialTax, "ì˜íšŒ ë¬´ì—­ íŠ¹ë³„ì„¸ ì§•ìˆ˜", economyRoomName);
        }
        // 2. ë²”ìš© ìˆ˜ìµ í™˜ìˆ˜ (ì˜ˆ: ë³µì§€ êµ­ê°€ ê±´ì„¤ì•ˆ - ìˆ˜ìµ 10% í™˜ìˆ˜)
        if (pol.allProfitTax) {
            var welfareTax = Math.floor(finalNetProfit * pol.allProfitTax);
            finalNetProfit -= welfareTax;
            util_updateReserve(economyRoomData, welfareTax, "ì˜íšŒ ë³µì§€ ê¸°ê¸ˆ ì§•ìˆ˜", economyRoomName);
        }
        // 3. ì¸í”Œë ˆì´ì…˜ ì–µì œ (ì˜ˆ: ëª¨ë“  ìˆ˜ìµ 20% ì¼ê´„ ì‚­ê°)
        if (pol.globalRewardMult) {
            finalNetProfit = Math.floor(finalNetProfit * pol.globalRewardMult);
        }
        // 4. ê·¼ë¡œ ìˆ˜ìµ ê°ì†Œ (ì˜ˆ: ê³¨ë™í’ˆ ë°œêµ´ ì¥ë ¤ë ¹ - ê·¼ë¡œ ìˆ˜ìµ 25% ê°ì†Œ)
        if (pol.workMult) {
            finalNetProfit = Math.floor(finalNetProfit * pol.workMult);
        }
    }

    var creditLoss = afterTaxMargin - finalNetProfit; // ì‹ ìš© ë“±ê¸‰ì— ë”°ë¥¸ ìˆ˜ìµ ì°¨ê°ì•¡ ê³„ì‚°

    var pillageLog = "";
    var escortLog = "";

    // [1] ìœ ì € í•´ì  ì•½íƒˆ ì •ì‚° (ë§ˆì§„ ê¸°ë°˜: ìƒì¸ ì›ê¸ˆ ë³´í˜¸)
    if ((user.isPillaged === true || v.isPillaged === true) && v.pirateUid) {
        var pirateObj = null;
        for (var r in data.rooms) { if (data.rooms[r].users[v.pirateUid]) { pirateObj = data.rooms[r].users[v.pirateUid]; break; } }
        
        if (pirateObj) {
            var pMin = cfg.PIRATE.pillageRateMin || 0.3;
            var pMax = cfg.PIRATE.pillageRateMax || 0.5;
            var pLevel = pirateObj.shipLevel || 1;
            var pRate = pMin + (pMax - pMin) * (pLevel - 1) / 9;
            
            var pillageLoss = finalNetProfit > 0 ? Math.floor(finalNetProfit * pRate) : 0;
            
            if (pillageLoss > 0) {
                finalNetProfit -= pillageLoss;
                pirateObj.claimableReward = (Number(pirateObj.claimableReward) || 0) + pillageLoss;
                pirateObj.hasNotifiedReward = false; // ì•Œë¦¼ í”Œë˜ê·¸ ì´ˆê¸°í™” (ë‹¤ìŒ ì±„íŒ… ì‹œ ì•Œë¦¼ ë°œìƒ)
                pillageLog = "\nğŸ´â€â˜ ï¸ [ì•½íƒˆ í”¼í•´]: ìˆ˜ìµì˜ " + (pRate * 100).toFixed(1) + "%(-" + fp(pillageLoss) + "P)ê°€ í•´ì ì—ê²Œ ê°•íƒˆë¨";
                pirateObj.currentBounty = 0; 
            }
        }
    }

   // [2] í•´êµ° í˜¸ìœ„ì„¸ ì •ì‚° ë° ì§€ì—­ í•´êµ° ì°¨ë“± ë¶„ë°° (ì„ ë°• ë ˆë²¨ ê¸°ë°˜)
    if (v.escortFee && v.escortFee > 0) {

        // B. í˜„ì¬ ë°©(roomName)ì— ìˆëŠ” í™œë™ ê°€ëŠ¥í•œ í•´êµ° ìœ ì € íƒìƒ‰
        var localNavies = [];
        var totalNavyLevels = 0;
        var currentRoomObj = data.rooms[roomName];
        if (currentRoomObj && currentRoomObj.users) {
            for (var uId in currentRoomObj.users) {
                var u = currentRoomObj.users[uId];
                if (u.job === 'navy' && uId !== targetUid) {
                    localNavies.push(u);
                    totalNavyLevels += (u.shipLevel || 1);
                }
            }
        }

        if (localNavies.length > 0) {
            // C. í•´ë‹¹ êµ¬ì—­ í•´êµ°ë“¤ì—ê²Œ ì„ ë°• ë ˆë²¨ ë¹„ì¤‘ì— ë”°ë¼ ì°¨ë“± ë¶„ë°°
            localNavies.forEach(function(n) {
                var weight = (n.shipLevel || 1) / totalNavyLevels;
                var perNavyReward = Math.floor(v.escortFee * weight);
                n.claimableReward = (Number(n.claimableReward) || 0) + perNavyReward;
                n.hasNotifiedReward = false; // ìˆ˜ë ¹ ì•Œë¦¼ íŠ¸ë¦¬ê±°
                n.fame = (n.fame || 0) + 2;   // í˜¸ìœ„ ê³µë¡œ ëª…ì„± ìƒìŠ¹
            });
            escortLog = "\nğŸ›¡ï¸ í˜¸ìœ„ ë¹„ìš©: -" + fp(v.escortFee) + "P";
        } else {
            // D. ë°©ì— í•´êµ° ìœ ì €ê°€ ì—†ëŠ” ê²½ìš° êµ­ê³  ê·€ì†
            util_updateReserve(economyRoomData, v.escortFee, "AI í˜¸ìœ„ ìˆ˜ìˆ˜ë£Œ êµ­ê³  í™˜ìˆ˜", economyRoomName);
            escortLog = "\nğŸ›¡ï¸ í˜¸ìœ„ ë¹„ìš©: -" + fp(v.escortFee) + "P (êµ­ê³  ê·€ì†)";
        }
    }

    // [ì¬í•´] í­í’ìš° ìˆ˜ë¦¬ë¹„ (ìµœì¢… ìˆ˜ìµì—ì„œ ì°¨ê°)
    var repairFee = 0;
    if (triggeredDisaster === "STORM") {
        repairFee = Math.floor(Math.abs(finalNetProfit) * 0.1 + 10000);
        finalNetProfit -= repairFee;
        disasterLog += "\nğŸŒŠ [í­í’ìš°]: ì„ ì²´ íŒŒì† ìˆ˜ë¦¬ë¹„ " + fp(repairFee) + "P ì§€ì¶œ";
    }

    // [ìµœì¢…] ì§€ê¸‰ì•¡ í™•ì • = ì›ê¸ˆ(ë³´ì¡´) + ëª¨ë“  ë³´ì •ì´ ëë‚œ ìˆœì´ìµ
    var totalPayout = totalCost + finalNetProfit;

    // í¬ì¸íŠ¸ ì§€ê¸‰ ë° êµ­ê³  ì—°ë™
    util_updatePoint(user, economyRoomData, totalPayout, "ë¬´ì—­ ì •ì‚° ì™„ë£Œ (ì›ê¸ˆ+ìˆ˜ìµ)", economyRoomName);

    // 1. í˜„ì¬ ìœ„ì¹˜ë¥¼ ëª©ì ì§€ í•­êµ¬ë¡œ ê°±ì‹  (ë¬´ì—­ ì§€ë¶€ë¡œ ë³µê·€í•˜ì§€ ì•Šê³  í˜„ì§€ ì²´ë¥˜)
    user.currentLoc = v.dest; 
    
    // 2. ë¬´ì—­ íšŸìˆ˜ ëˆ„ì  ê¸°ë¡
    util_setData(user, 'tradeCount', (user.tradeCount || 0) + 1, "ë¬´ì—­ íšŸìˆ˜ ëˆ„ì ", roomName);

    // 3. êµ­ê³  ê·€ì† (ì„¸ê¸ˆ ë° ì‹ ìš© ì°¨ì•¡) í™•ì • ì²˜ë¦¬
    if (taxAmount > 0) util_updateReserve(economyRoomData, taxAmount, "ë¬´ì—­ì„¸ ì§•ìˆ˜", economyRoomName);
    if (creditLoss > 0) util_updateReserve(economyRoomData, creditLoss, "ì‹ ìš© ë“±ê¸‰ ì°¨ë“± ìˆ˜ìµ í™˜ìˆ˜", economyRoomName);

    // 4. í˜„ì¬ í•­í•´ ì„¸ì…˜ ê³µì‹ ì¢…ë£Œ (ë©”ëª¨ë¦¬ ë½ í•´ì œ)
    v.active = false; 
    v.isProcessing = false;

    // 5. [ë‚´êµ¬ë„ 0% ì‹œìŠ¤í…œ] ë¬´ì—­ ì§€ë¶€ ìë™ íšŒí•­ (ê²¬ì¸ ë¡œì§)
    if (user.durability <= 0 && user.currentLoc !== "ë¬´ì—­ ì§€ë¶€") {
        Api.replyRoom("ë‚´ë¦¬ë‹¤", "ğŸš¨ [ê¸°ë™ ë¶ˆëŠ¥] ì„ ë°• ë‚´êµ¬ë„ê°€ 0%ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤! ì•ˆì „ì„ ìœ„í•´ ëª¨ë“  í™”ë¬¼ì„ ì‹£ê³  ì¦‰ì‹œ 'ë¬´ì—­ ì§€ë¶€'ë¡œ ìë™ ê²¬ì¸ë©ë‹ˆë‹¤.");
        
        // ë³´ìœ í•œ í™”ë¬¼(cargo)ê³¼ íŠ¹ì‚°í’ˆ(specialties)ì„ ê·¸ëŒ€ë¡œ ì‹¤ì€ ì±„ ì§€ë¶€ë¡œ ì¬ì¶œí•­
        _departVoyage(user, data, replier, roomName, "ë¬´ì—­ ì§€ë¶€", cfg, user.cargo, user.specialties); 
    }

    // [v16.7] 7. íŠ¹ì‚°í’ˆ ë°œê²¬ ë° ì§„ê·€í•œ ìœ ë¬¼ íŒì •
    var specialtyFound = "";
    if (Math.random() < cfg.SPECIALTY_CHANCE) {
        if (v.dest === ELDORADO_CONFIG.NAME) {
            // ì—˜ë„ë¼ë„: ì§„ê·€í•œ ë³´ë¬¼ íšë“
            user.rareSpecialties = (user.rareSpecialties || 0) + 1;
            specialtyFound = "\n\nğŸ’ [ì „ì„¤ì˜ ìœ ë¬¼]: 'ì•„ìŠ¤í…Œë¦¬ì•„ í™©ê¸ˆ ì„±ë°°' 1ê°œ íšë“!\n(ì¼ë°˜ í•­êµ¬ ë§¤ê° ì‹œ 100,000P)";
        } else {
            // ì¼ë°˜ í•­êµ¬: ê¸°ì¡´ íŠ¹ì‚°í’ˆ ë¡œì§
            var newItem = nationInfo.specialty;
            var pInfo = (roomData.features.portData && roomData.features.portData[v.dest]) ? roomData.features.portData[v.dest] : { governorUid: "" };
            var isGov = (pInfo.governorUid === targetUid);
            var amount = isGov ? (Math.floor(Math.random() * (Number(cfg.INVEST.GOV_SPEC_MAX) - Number(cfg.INVEST.GOV_SPEC_MIN) + 1)) + Number(cfg.INVEST.GOV_SPEC_MIN)) : 1;
            user.specialties[newItem] = (user.specialties[newItem] || 0) + amount;
            specialtyFound = "\n\nâœ¨ íŠ¹ì‚°í’ˆ '" + newItem + "' " + (isGov ? "x" + amount + " " : "") + "ë°œê²¬!";
        }
    }

    // [v16.7] 7-1. ì—˜ë„ë¼ë„ ì „ìš© ìˆ˜ìµ ë³´ì • ë° íŠ¹ì‚°í’ˆ íŒë§¤ ì œì™¸
    if (v.dest === ELDORADO_CONFIG.NAME) {
        // [ë³´ì •] íŠ¹ì‚°í’ˆ ë§¤ì¶œ(sRev)ë¿ë§Œ ì•„ë‹ˆë¼ íŠ¹ì‚°í’ˆ ì›ê°€ê¹Œì§€ ì œì™¸í•˜ì—¬ ìˆœìˆ˜ êµì—­í’ˆ ë§ˆì§„ë§Œ 2ë°°ë¡œ ê³„ì‚°
        var pureCargoMargin = Math.floor((tRev - (sRev || 0) - (totalCost - (sBase * sCount || 0))) * shipEff);
        efficientMargin = pureCargoMargin * ELDORADO_CONFIG.PROFIT_MULT;
        pBonusTotal = 0; // ìì¹˜ë ¹ ë³´ë„ˆìŠ¤ ì œì™¸
        soldLog = soldLog.filter(function(line){ return line.indexOf("[íŠ¹]") === -1; });
        disasterLog += "\nâœ¨ [í™©ê¸ˆì˜ ê°€í˜¸]: ì—˜ë„ë¼ë„ì˜ ê¸°ìš´ìœ¼ë¡œ ì¼ë°˜ êµì—­ ìˆœìˆ˜ìµì´ 2ë°°ë¡œ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.";
    }

    // [v16.7] 7-2. ë¬´ì—­ ì„±ê³µ ì‹œ 20% í™•ë¥  ê³ ëŒ€ ì§€ë„ ë³´ê¸‰ (ê³µí†µ)
    var mapLootMsg = "";
    if (Math.random() < ELDORADO_CONFIG.MAP_PROB) {
        user.ancientMaps = (user.ancientMaps || 0) + 1;
        mapLootMsg = "\n\nğŸ—ºï¸ [ëœ»ë°–ì˜ ìˆ˜í™•]: ì„ ì‹¤ êµ¬ì„ì—ì„œ 'ê³ ëŒ€ ì§€ë„' 1ì¥ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤!";
    }

    /* v16.7 ì ì¬ëœ ì§„ê·€í•œ ë³´ë¬¼(ì„±ë°° ë“±) íŒë§¤ ì •ì‚° */
   var rareLootCount = Number(specialtyToSell["_rare"] || 0);
    if (rareLootCount > 0) {
        var rareRevenue = rareLootCount * (ELDORADO_CONFIG.RARE_PRICE || 100000);
        totalRevenue += rareRevenue;
        // ë³´ë¬¼ì€ íšë“ê°€ê°€ 0ì´ë¯€ë¡œ ë§ˆì§„ ê³„ì‚° ì‹œ ìˆ˜ìµìœ¼ë¡œë§Œ ì „ì•¡ í•©ì‚°
        efficientMargin += Math.floor(rareRevenue * shipEff); 
        soldLog.push("â€¢ ğŸ’ì§„ê·€í•œ ë³´ë¬¼ x" + rareLootCount + ": " + fp(rareRevenue) + "P ğŸ”º");
        
        // ìœ ì € ì‹¤ì œ ë³´ìœ  ë°ì´í„°ì—ì„œ ì°¨ê°
        user.rareSpecialties = Math.max(0, (user.rareSpecialties || 0) - rareLootCount);
    }

    // [ìœ ì§€] 1. ìˆœìˆ˜ìµ í•©ê³„ ê³„ì‚° ë° ì´ˆì›” ê°•í™” ë³´ì •
    var profitBonusMult = 1 + ((user.enhProfit || 0) / 100);
    
    var enhancedPureMargin = Math.floor(efficientMargin * profitBonusMult); // ìˆœìˆ˜ìµ * ê°•í™”ë°°ìœ¨
    var totalNetMargin = enhancedPureMargin + pBonusTotal;                  // + ë°œì „ë„ ë³´ë„ˆìŠ¤

    var enhProfitTag = (user.enhProfit > 0) ? " (âœ¨ìˆ˜ìµê°•í™” +" + user.enhProfit + "%)" : "";

    // [ìœ ì§€] 2. í•´ìƒ ì´ë²¤íŠ¸(ì¬í•´/ì¶•ì œ) ì‹¤ì •ì‚° ë¡œì§ (ê¸°ì¡´ ë¡œì§ ë³´ì¡´)
    if (triggeredDisaster) {
        var ev = cfg.EVENTS.LIST[triggeredDisaster];

        if (["STORM", "FIRE", "MONSTER"].indexOf(triggeredDisaster) !== -1) {
                var extraWear = Math.floor(Math.random() * 6) + 20; // 20~25%
                user.durability = Math.max(0, user.durability - extraWear);
                disasterLog += "\nğŸ› ï¸ [ë‚´êµ¬ë„ ê¸‰ë½]: " + ev.name + "ì˜ ì—¬íŒŒë¡œ ì„ ì²´ê°€ ëŒ€íŒŒë˜ì—ˆìŠµë‹ˆë‹¤! (-" + extraWear + "%)";
            }

        if (triggeredDisaster === "FESTIVAL" && hasFavoriteSold) {
            var festAmt = Math.floor(totalNetMargin * ev.boost);
            totalNetMargin += festAmt;
            disasterLog += "\n" + ev.msg + " (+" + fp(festAmt) + "P)";
        } 
        else if (triggeredDisaster === "FLOTSAM") {
            var flotsamBonus = Math.floor(Math.random() * (ev.max - ev.min + 1)) + ev.min;
            totalNetMargin += flotsamBonus;
            disasterLog += "\n" + ev.msg + " (+" + fp(flotsamBonus) + "P)";
        }
        else if (triggeredDisaster === "MONSTER" || triggeredDisaster === "FOG") {
            var loss = Math.floor(totalNetMargin * ev.penalty);
            totalNetMargin -= loss;
            disasterLog += "\n" + ev.msg + " (-" + fp(loss) + "P)";
        }
        else if (triggeredDisaster === "SCURVY") {
            var medFee = ev.flatPenalty || 20000;
                totalNetMargin -= medFee;
                disasterLog += "\n" + ev.msg + " (-" + fp(medFee) + "P)";
        }
    }

    // [ìœ ì§€] 3. ìµœì¢… ì„¸ê¸ˆ ë° ì‹¤ì§€ê¸‰ì•¡ í™•ì •
    taxAmount = totalNetMargin > 0 ? Math.floor(totalNetMargin * autoTaxRate) : 0;
    var afterTaxMargin = totalNetMargin - taxAmount;
    if (govTag && govInfo && govInfo.governorUid !== targetUid) {
        var tariff = totalNetMargin > 0 ? Math.floor(totalNetMargin * 0.01) : 0;
        afterTaxMargin -= tariff;
    }
    if (v.escortFee) afterTaxMargin -= v.escortFee;
    
    var finalNetProfit = Math.floor(afterTaxMargin * creditMult); 
    var totalPayout = totalCost + finalNetProfit;

    // 4. ë¦¬í¬íŠ¸ ë³¸ë¬¸ ì¡°ë¦½ (ì „ì²´ ë©”ì‹œì§€ í†µí•©)
    var report = "ğŸ“ ëª©ì ì§€: " + v.dest + " (" + cargoSummaryStr + ")\n\n" +
                 "ğŸ’° ì´ ë§¤ì¶œì•¡: " + fp(totalRevenue) + "P\n" +
                 "ğŸ“ˆ ìˆœìˆ˜ ì´ìµ: +" + fp(efficientMargin) + "P\n" + 
                 "ğŸ—ï¸ ë°œì „ë„ ë³´ë„ˆìŠ¤: +" + fp(pBonusTotal) + "P\n" +
                 "ğŸ’µ ìˆœìˆ˜ìµ í•©ê³„: " + fp(totalNetMargin) + "P" + seaKingTag + enhProfitTag + "\n" +
                 (disasterLog ? disasterLog.trim() + "\n" : "") +
                 "âš–ï¸ ë¬´ì—­ì„¸(" + taxPercentText + "%): -" + fp(taxAmount) + "P" + taxBenefitTag + "\n" +
                 (pillageLog ? pillageLog.trim() + "\n" : "") +
                 (escortLog ? escortLog.trim() + "\n" : "") +
                 (govTag ? govTag.trim() + "\n" : "") +
                 "\n" +
                 "ğŸŠ ìµœì¢… ìˆ˜ë ¹ì•¡: " + fp(totalPayout) + "P\n" +
                 "(ì‹ ìš© " + crInfo.label + " " + (creditMult * 100).toFixed(0) + "%ì§€ê¸‰)\n" +
                 (specialtyFound ? specialtyFound.trim() : "") + 
                 (mapLootMsg ? mapLootMsg.trim() : "");

    // 5. ê²°ê³¼ ë©”ì‹œì§€ ì „ì†¡ (ë‚´ë¦¬ë‹¤ ë°© ê³ ì •)
    var resultMsg = formatCommand("ğŸŒŠ [í•­í•´ ì¼ì§€: ë¬´ì—­ ë³´ê³ ]", user, report, "ëˆ„ì  ë¬´ì—­ " + user.tradeCount + "íšŒ / ì”ì•¡ " + fp(user.point) + "P");
    Api.replyRoom("ë‚´ë¦¬ë‹¤", resultMsg);

    /* [v16.5] ë¬´ì—­ íšŸìˆ˜ ê¸°ë°˜ ì‘ìœ„ ìˆ˜ì—¬ ì‹œìŠ¤í…œ (ëˆ„ë½ë¶„ ë³µêµ¬) */
    var rStub = { reply: function(m) { Api.replyRoom(roomName, m); } };
    var tCount = Number(user.tradeCount || 0);

    if (tCount >= 200) {
        util_checkAndAwardTitle(user, rStub, "í•´ìƒì™•", 5104, "ğŸ”±", "ë‚´ë¦¬ë‹¤ í•´ìš´ ì—°í•©", "ëˆ„ì  ë¬´ì—­ 200íšŒ", "[ì¥ì°© íš¨ê³¼]: í•­í•´ ì¤‘ ë°œìƒí•˜ëŠ” ëª¨ë“  ì¬í•´(ë””ë²„í”„) í™•ë¥ ì´ 50% ìƒì‹œ ê°ì†Œí•©ë‹ˆë‹¤.", roomName);
    } else if (tCount >= 150) {
        util_checkAndAwardTitle(user, rStub, "ëŒ€í•­í•´ì‚¬", 5103, "ğŸš¢", "ë‚´ë¦¬ë‹¤ í•´ìš´ ì—°í•©", "ëˆ„ì  ë¬´ì—­ 150íšŒ", "ì´ì œ ê±°ì¹œ íŒŒë„ë„ ë‹¹ì‹ ì˜ ì•ê¸¸ì„ ë§‰ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", roomName);
    } else if (tCount >= 100) {
        util_checkAndAwardTitle(user, rStub, "í•­í•´ì‚¬", 5102, "ğŸ§­", "ë‚´ë¦¬ë‹¤ í•´ìš´ ì—°í•©", "ëˆ„ì  ë¬´ì—­ 100íšŒ", "ëŠ¥ìˆ™í•œ ì†œì”¨ë¡œ í•¨ëŒ€ë¥¼ ì§€íœ˜í•˜ëŠ” ë²•ì„ ê¹¨ë‹¬ì•˜ìŠµë‹ˆë‹¤.", roomName);
    } else if (tCount >= 50) {
        util_checkAndAwardTitle(user, rStub, "ê²¬ìŠµì„ ì›", 5101, "âš“", "ë‚´ë¦¬ë‹¤ í•´ìš´ ì—°í•©", "ëˆ„ì  ë¬´ì—­ 50íšŒ", "ë°”ë‹¤ì˜ ì§ ë‚´ì— ìµìˆ™í•´ì§„ ë‹¹ì‹ , ì§„ì •í•œ ë±ƒì‚¬ëŒìœ¼ë¡œ ê±°ë“­ë‚©ë‹ˆë‹¤.", roomName);
    }
    
    v.active = false; 

    v.isProcessing = false; 
    user.skipHealing = true;
    safeSaveData(data, true);

    } catch (e) { 
        // 9. [ì—ëŸ¬ ë³µêµ¬]: ë¡œì§ ì¤‘ê°„ì— ì—ëŸ¬ ë°œìƒ ì‹œ ì ê¸ˆì„ í•´ì œí•˜ì—¬ ë‹¤ìŒ ì±„íŒ… ë•Œ ì¬ì‹œë„ ê°€ëŠ¥ì¼€ í•¨
        v.isProcessing = false; 
        Log.error("ğŸš¨ [Trade Error] " + user.name + " ì •ì‚° ì‹¤íŒ¨: " + e + " (Line: " + e.lineNumber + ")");
        try { replier.reply("ğŸš« [ë¬´ì—­ ì •ì‚° ì˜¤ë¥˜]\në¡œì§ ì¶©ëŒë¡œ ì •ì‚°ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.\nì ì‹œ í›„ ë‹¤ì‹œ ì±„íŒ…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); } catch(err) {}
    } finally {
        // 10. [ìµœì¢… í•´ì œ]: ì„±ê³µí•˜ë“  ì‹¤íŒ¨í•˜ë“  í•¨ìˆ˜ ì¢…ë£Œ ì‹œ ì ê¸ˆ ë¬´ì¡°ê±´ í•´ì œ
        v.isProcessing = false; 
    }
} // _processTradeArrival í•¨ìˆ˜ ë§ˆê°

// í•´ìƒ í™œë™ ì •ì‚° ì•Œë¦¼ í•¨ìˆ˜ (ì„¹í„° 24ì˜ í•¸ë“¤ëŸ¬ì—ì„œ í˜¸ì¶œë¨)
/**
 * [v14.0] í•´ìƒ í™œë™ ë¯¸ìˆ˜ë ¹ ì •ì‚°ê¸ˆ ë°˜ì‘í˜• ì•Œë¦¼ ì—”ì§„
 */
function util_notifySeaReward(user, replier) {
    if (!user || Number(user.claimableReward || 0) <= 0 || user.hasNotifiedReward === true) return;

    var rewardTitle = (user.job === 'pirate') ? "ğŸ´â€â˜ ï¸ ë‚˜ì†Œ ì•½íƒˆê¸ˆ ì…ê³  ì•Œë¦¼" : "ğŸ‘® í•´êµ° ë³¸ë¶€ ì •ì‚° ëŒ€ê¸° ì•Œë¦¼";
    var rewardMsg = "í˜„ì¬ ì •ì‚°ë˜ì§€ ì•Šì€ ìˆ˜ìµê¸ˆì´ ëˆ„ì ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\n\n" +
                     "ğŸ’° ëˆ„ì  ê¸ˆì•¡: " + fp(user.claimableReward) + "P\n" +
                     "ğŸ“ ìˆ˜ë ¹ì²˜: [/ë¬´ì—­] â” ì¡°í•© ì‚¬ë¬´ì†Œ/ë³¸ë¶€ â” ì •ì‚°/ì¼ê¸‰ ë©”ë‰´";
    
    replier.reply(formatCommand(rewardTitle, user, rewardMsg));
    user.hasNotifiedReward = true; // ì²« ì±„íŒ… ì‹œ 1íšŒë§Œ ì•Œë¦¼
}

//==========ì„¹í„°52==========

/**
Â * [í•µì‹¬ ëª¨ë“ˆ] í†µí•© ì¹´ì§€ë…¸ ì—”ì§„ (ì‚¬ë‹¤ë¦¬ & ë°”ì¹´ë¼)
Â * ê¸°ëŠ¥: ë©”ë‰´ ì¶œë ¥, ë°°íŒ… ê²€ì¦, ìµœê·¼ ê²°ê³¼ ì¡°íšŒ
Â */

/**
 * [ì‹ ê·œ] ì¹´ì§€ë…¸ ì‹¤ì‹œê°„ ì¤‘ê³„ ì „ìš© ì¶œë ¥ ì—”ì§„ (v2.0 Full-Relay)
 * ê¸°ëŠ¥: ìœ ì €ì—ê²Œ ë‹µì¥í•¨ê³¼ ë™ì‹œì— ì§€ì •ëœ ì¤‘ê³„ë°©ì—ë„ ë‚´ìš©ì„ í† ì”¨ í•˜ë‚˜ ì•ˆ í‹€ë¦¬ê³  ë³µì œ ì „ì†¡í•©ë‹ˆë‹¤.
 * ì„¹í„° 52ì˜ ëª¨ë“  replier.replyëŠ” ì´ì œ ì´ í•¨ìˆ˜ë¥¼ ê±°ì¹©ë‹ˆë‹¤.
 */
function util_casinoRelayReply(replier, user, content, roomName) {
    if (!content) return;
    replier.reply(content); 
}

/* [ë©”ì¸] ì¹´ì§€ë…¸ ë¡œì§ ì§„ì…ì  */
function _gameCasinoLogic(msg, user, data, replier, roomName, targetUid) {
    // 1. ê³µë°± ì œê±° (ìˆ«ì ì¸ì‹ë¥  í–¥ìƒ)
    var cleanMsg = msg.trim();

Â  Â  // ìˆ˜ì •: ëª¨ë“  ì‹¤í–‰ ê²½ë¡œì—ì„œ ì°¸ì¡°í•  ìˆ˜ ìˆë„ë¡ í•µì‹¬ ë³€ìˆ˜ ì„ ì–¸ë¶€ë¥¼ í•¨ìˆ˜ ìµœìƒë‹¨ìœ¼ë¡œ ì´ë™ (ì°¸ì¡° ì˜¤ë¥˜ í•´ê²°)
    var MAIN_ZONE = "ë‚´ë¦¬ë‹¤";
    var mainRoomData = data.rooms[MAIN_ZONE];
    if (!user || !mainRoomData) return false;
    var nowTs = Date.now(); // í˜„ì¬ ì‹œê°„ ë³€ìˆ˜ë¥¼ ìµœìƒë‹¨ì— ì„ ì–¸í•˜ì—¬ ëª¨ë“  ì¡°ê±´ë¬¸ì—ì„œ ê³µìœ 

    // ì¹´ì§€ë…¸ ë°ì´í„° êµ¬ì¡° ì•ˆì „ì„± í™•ë³´
    if (mainRoomData && !mainRoomData.features.casino) {
        mainRoomData.features.casino = {
            ladder: { round: 1, history: [], bets: {} },
            baccarat: { round: 1, history: [], bets: {} }
        };
    }
    var casino = mainRoomData.features.casino;

    // í˜„ì¬ ë°©ì˜ ë©”ë‰´ ìƒíƒœ ì €ì¥ì†Œ ì°¸ì¡°
    if (!data.rooms[roomName].features.states) data.rooms[roomName].features.states = { menuWait: {} };
    var mState = data.rooms[roomName].features.states.menuWait;

    // [v14.6 êµì •] ë‹¨ì²´ë°© ì…ì¥ ì œí•œ ê°€ë“œ (ëª…ë ¹ì–´ ì…ë ¥ ì‹œì—ë§Œ ë°˜ì‘)
    if (user.isGroupChatTemp === true) {
        // ì¼ë°˜ ì±„íŒ… ì¤‘ ì„¸ì…˜ ì˜¤ì¸ìœ¼ë¡œ ì¸í•œ ìë™ ì¶œë ¥ì„ ë§‰ê¸° ìœ„í•´ ì¡°ê±´ì„ '/ì¹´ì§€ë…¸' ëª…ë ¹ì–´ë¡œ í•œì •í•©ë‹ˆë‹¤.
        if (msg.startsWith("/ì¹´ì§€ë…¸")) {
            var inviteBody = "ì¤‘ì•™ ì¹´ì§€ë…¸ëŠ” VIP ê³ ê°ë‹˜ì˜ ë³´ì•ˆê³¼\n" +
                             "ì¾Œì í•œ í™˜ê²½ì„ ìœ„í•´ ì˜¤ì§ [1:1 ëŒ€í™”]ë¥¼\n" +
                             "í†µí•´ì„œë§Œ ê²Œì„ì„ ì œí•œí•˜ê³  ìˆìŠµë‹ˆë‹¤.\n" +
                             "https://open.kakao.com/me/nerida";
            replier.reply(formatCommand("ğŸ“¨ VIP ì „ìš© ì•ˆë‚´", user, inviteBody, "ë´‡ì˜ ì˜¤í”ˆí”„ë¡œí•„ 1:1 ì±„íŒ…ë°©ì—ì„œ ë§Œë‚˜ìš”!"));
        }
        return true; 
    }

    // 1. ëª…ë ¹ì–´ ì²˜ë¦¬: /ì¹´ì§€ë…¸
    if (cleanMsg === "/ì¹´ì§€ë…¸") {
        if (typeof util_isBankruptcy === 'function' && util_isBankruptcy(roomName)) {
            var bankMsg = "ğŸš¨ [ê¸´ê¸‰: ì¹´ì§€ë…¸ ì„ì‹œ íœ´ì—…]\n" +
                          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                          "í˜„ì¬ ë©”ì¸ êµ¬ì—­ì˜ êµ­ê°€ ë¶€ë„ ì„ í¬ë¡œ ì¸í•´\n" +
                          "ëª¨ë“  ê²Œì„ê³¼ ë°°íŒ…ì´ ì „ë©´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.";
            replier.reply(formatCommand("ğŸ° ì¹´ì§€ë…¸ ì˜ì—… ì •ì§€", user, bankMsg, "í•´ì œ ê¸°ì¤€: êµ­ê³  50% ë³µêµ¬"));
            return true; 
        }

        if (user.mining && user.mining.active === true) {
            replier.reply(formatError(user, "ë°°íŒ… ë¶ˆê°€", "í˜„ì¬ ê´‘ì‚°ì—ì„œ ì±„êµ´ ì‘ì—… ì¤‘ì…ë‹ˆë‹¤."));
            return true;
        }

        if (nowTs - (user.lastBotUseTime || 0) > 180000 || !user.casinoAuditStartTime) {
            user.casinoAuditStartTime = nowTs;
            user.casinoAuditStartAssets = Number(user.point || 0) + Number(user.bank || 0);
            user.casinoAuditAlertHistory = [];
            
            var entryLog = "ğŸ”” [ì¹´ì§€ë…¸ ì…ì¥ ì•Œë¦¼]\n" +
                           "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                           "ğŸ‘¤ ìœ ì €: " + user.name + "\n" +
                           "ğŸ†” ID: " + targetUid + "\n" +
                           "ğŸ“ ì¥ì†Œ: 1:1 ëŒ€í™”ë°© (" + roomName + ")\n" +
                           "ğŸ’° í˜„ì¬ìì‚°: " + fp(user.casinoAuditStartAssets) + " P\n" +
                           "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                           "âš ï¸ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì¤‘";
            try { Api.replyRoom("ë² ë¦­ë°©", entryLog); } catch(e) { Log.error("Entry Alert Fail: " + e); }
        }

        user.lastBotUseTime = nowTs; 
        // [í•µì‹¬ íŒ¨ì¹˜]: originRoomì„ ê¸°ë¡í•˜ì—¬ íƒ€ ë°© ê°„ì„­ ë° íƒ€ì„ì•„ì›ƒ ì˜¤ì‘ë™ ë°©ì§€
        mState[targetUid] = { type: 'casino_main', time: nowTs, originRoom: roomName };

        var body = "í˜„ì¬ ì…ì¥ ê°€ëŠ¥í•œ ê²Œì„ë£¸ì…ë‹ˆë‹¤.\n\n" +
                   "1. ğŸŒ“ ì‚¬ë‹¤ë¦¬ (2ë¶„ ì£¼ê¸° / 1.90~4.0ë°°)\n" +
                   "2. ğŸƒ ë°”ì¹´ë¼ (3ë¶„ ì£¼ê¸° / 2.0~8.0ë°°)\n" +
                   "3. ğŸ•´ï¸ ë¸”ë™ì­ (ê°œì¸ì „ / ë”œëŸ¬ ëŒ€ê²°)\n";
        
        util_casinoRelayReply(replier, user, formatCommand("ğŸ° ë‚´ë¦¬ë‹¤ ì¤‘ì•™ ì¹´ì§€ë…¸", user, body, "ì´ë™í•˜ì‹¤ ê²Œì„ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."), roomName);
        safeSaveData(data);
        return true; 
    }

    /* ìˆ«ì ì…ë ¥ ì²˜ë¦¬ */
Â  Â  var state = mState[targetUid];
Â  Â  if (!state) return false; // ëŒ€ê¸° ìƒíƒœê°€ ì—†ìœ¼ë©´ ì¢…ë£Œ

Â  Â  // 2. ì‚¬ë‹¤ë¦¬ ë©”ë‰´
Â  Â  if (state.type === 'casino_main' && cleanMsg === "1") {
Â  Â  Â  Â  mState[targetUid] = { type: 'casino_ladder', time: Date.now() };
Â  Â  Â  Â  _showCasinoSubMenu(replier, user, "ì‚¬ë‹¤ë¦¬", casino.ladder, 2, roomName);
        safeSaveData(data);
Â  Â  Â  Â  return true;
Â  Â  }

Â  Â  // 3. ë°”ì¹´ë¼ ë©”ë‰´
Â  Â  if (state.type === 'casino_main' && cleanMsg === "2") {
Â  Â  Â  Â  mState[targetUid] = { type: 'casino_baccarat', time: Date.now() };
Â  Â  Â  Â  _showCasinoSubMenu(replier, user, "ë°”ì¹´ë¼", casino.baccarat, 3, roomName);
        safeSaveData(data);
Â  Â  Â  Â  return true;
Â  Â  }

Â  Â  // 3-1. ë¸”ë™ì­ ë©”ë‰´
Â  Â if (state.type === 'casino_main' && cleanMsg === "3") {
        if (typeof util_isBankruptcy === 'function' && util_isBankruptcy(roomName)) {
            replier.reply(formatError(user, "ë¸”ë™ì­ íì‡„", "êµ­ê°€ ë¶€ë„ ì„ í¬ë¡œ ì¸í•´ ë”œëŸ¬ë“¤ì´ ëª¨ë‘ íœ´ê°€ ì¤‘ì…ë‹ˆë‹¤."));
            return true;
        }
        
        if (!data.rooms[roomName].features.states.bankProcess) {
            data.rooms[roomName].features.states.bankProcess = {};
        }

        data.rooms[roomName].features.states.bankProcess[targetUid] = { type: 'blackjack_bet_input', time: Date.now() };
        delete mState[targetUid];
        
        var bjCfg = SYSTEM_CONFIG.CASINO.BLACKJACK;
        var minB = bjCfg.MIN_BET || 2000;
        var maxB = bjCfg.LIMIT || 50000;
        
        var welcomeMsg = "ë”œëŸ¬ê°€ ì¹´ë“œë¥¼ ì„ê³  ìˆìŠµë‹ˆë‹¤.\në°°íŒ…í•˜ì‹¤ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n\n" +
                         "â€¢ ìµœì†Œ: " + fp(minB) + "P\n" +
                         "â€¢ ìµœëŒ€: " + fp(maxB) + "P";

        util_casinoRelayReply(replier, user, formatCommand("ğŸ•´ï¸ ë¸”ë™ì­ í…Œì´ë¸” ì…ì¥", user, welcomeMsg, "ì·¨ì†Œ: [ì·¨ì†Œ]"), roomName);
        safeSaveData(data);
        return true;
    }

Â  Â  // 4. ê²Œì„ë³„ ì„¸ë¶€ ê¸°ëŠ¥
Â  Â  if (state.type === 'casino_ladder' || state.type === 'casino_baccarat') {
Â  Â  Â  Â  var gameType = (state.type.indexOf('ladder') !== -1) ? "ladder" : "baccarat";Â 
Â  Â  Â  Â  var gameObj = casino[gameType];
Â  Â  Â  Â  var interval = (gameType === "ladder") ? 2 : 3;

Â  Â  Â  Â  if (cleanMsg === "1") {
            mState[targetUid].type = state.type + "_sub"; 
            _showCasinoRoundInfo(replier, user, gameType, gameObj, interval, roomName);
        } else if (cleanMsg === "2") {
            mState[targetUid].type = state.type + "_sub";
Â  Â  Â  Â  Â  Â  _showCasinoHistory(replier, user, gameType, gameObj, roomName);
        } else if (cleanMsg === "3") {
            mState[targetUid].type = state.type + "_sub";
            // ìˆ˜ì •: roomName ì¸ì ì¶”ê°€ ì „ë‹¬
            _showCasinoDailyHistory(replier, user, gameType, roomName);
        }
        safeSaveData(data);
Â  Â  Â  Â  return true;
Â  Â  }

Â  Â  return false;
}

/* [ì„œë¸Œ] ì¹´ì§€ë…¸ ê²Œì„ë³„ 2ë‹¨ê³„ ë©”ë‰´ ì¶œë ¥ */
function _showCasinoSubMenu(replier, user, title, obj, interval, roomName) {
    var now = new Date();
    var remainSec = (interval * 60) - ((now.getMinutes() % interval) * 60 + now.getSeconds());
    var min = Math.floor(remainSec / 60);
    var sec = remainSec % 60;

    var totalBet = 0;
    for (var uid in obj.bets) { totalBet += Number(obj.bets[uid].amount); }

    var lastResLine = "";
    var gKey = (title === "ì‚¬ë‹¤ë¦¬") ? "ladder" : "baccarat";
    // [ìˆ˜ì •] íƒ€ì…(gKey)ì´ ì¼ì¹˜í•˜ê³ , ë°”ë¡œ ì§ì „ íšŒì°¨(obj.round-1) ê¸°ë¡ì¼ ë•Œë§Œ ì¶œë ¥
    if (user.lastCasinoResult && user.lastCasinoResult.type === gKey) {
        var lr = user.lastCasinoResult;
        if (Number(lr.round) === Number(obj.round) - 1) {
            var icon = lr.isWin ? "ğŸŠ" : "ğŸ’€";
            var sign = lr.isWin ? "+" : "";
            lastResLine = "â€¢ ë‚´ ì§ì „ê²°ê³¼: " + lr.res + " [" + sign + fp(lr.profit) + "P] " + icon + "\n";
        }
    }

    var body = "ì§„í–‰ ì¤‘ì¸ íšŒì°¨ ë° ë©”ë‰´ë¥¼ ì„ íƒí•˜ì„¸ìš”.\n\n" +
               "[í˜„ì¬ íšŒì°¨ ì •ë³´]\n" +
               "â€¢ íšŒì°¨: ì œ " + (obj.round || 1) + "íšŒì°¨\n" +
               lastResLine + // ìš”ì•½ ë¼ì¸ ì‚½ì…
               "â€¢ ë‚¨ì€ ì‹œê°„: " + (min > 0 ? min + "ë¶„ " : "") + sec + "ì´ˆ\n" +
               "â€¢ ì´ íŒëˆ: " + fp(totalBet) + "P\n\n" +
               "1. ğŸ“ˆ ì§„í–‰ ì¤‘ì¸ íšŒì°¨ ì •ë³´ (ë°°íŒ… í˜„í™©)\n" +
               "2. ğŸ“‹ ìµœê·¼ 10ê²½ê¸° ê²°ê³¼\n" +
               "3. ğŸ† ê¸ˆì¼ ë‹¹ì²¨ ê¸°ë¡ í™•ì¸";

    util_casinoRelayReply(replier, user, formatCommand((title === "ì‚¬ë‹¤ë¦¬" ? "ğŸªœ " : "ğŸƒ ") + title + " ê²Œì„ì‹¤", user, body, "ì›í•˜ì‹œëŠ” ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."), roomName);
}

/**
 * @param {String} type - "ladder" ë˜ëŠ” "baccarat"
 */
function _showCasinoDailyHistory(replier, user, type, roomName) {
    var wins = (type === "ladder") ? (user.dailyLadderWins || []) : (user.dailyBaccaratWins || []);
    var titleStr = (type === "ladder") ? "ğŸªœ ì‚¬ë‹¤ë¦¬" : "ğŸƒ ë°”ì¹´ë¼";
    
    var list = [];
    var totalProfit = 0;
    
    if (wins.length === 0) {
        list.push("(ê¸ˆì¼ ë‹¹ì²¨ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤)");
    } else {
        // ìµœëŒ€ 15ê±´ê¹Œì§€ë§Œ ì¶œë ¥ (ë§í’ì„  ê¸¸ì´ ì œí•œ ëŒ€ë¹„)
        var displayCount = Math.min(wins.length, 15);
        for (var i = 0; i < displayCount; i++) {
            var w = wins[i];
            var pickName = (type === "ladder") ? w.pick : w.res;
            list.push("â€¢ [" + w.round + "íšŒ] " + pickName + " : +" + fp(w.profit) + "P (" + w.time + ")");
            totalProfit += Number(w.profit);
        }
        if (wins.length > 15) list.push("...ì™¸ " + (wins.length - 15) + "ê±´ ë” ìˆìŒ");
    }

    var body = "[ì˜¤ëŠ˜ì˜ ìŠ¹ì „ë³´]\n" + list.join("\n") + "\n\n" +
               "ğŸ“Š ë‹¹ì¼ ëˆ„ì  í•©ê³„\n" +
               "â€¢ ë‹¹ì²¨ íšŸìˆ˜: " + wins.length + "íšŒ\n" +
               "â€¢ ëˆ„ì  ìˆ˜ìµ: +" + fp(totalProfit) + "P";

    util_casinoRelayReply(replier, user, formatCommand(titleStr + " ê¸ˆì¼ ë‹¹ì²¨ ë¦¬í¬íŠ¸", user, body, "(â†©ï¸ ë’¤ë¡œ / ğŸ  ì²˜ìŒìœ¼ë¡œ)"), roomName);
}

/* [ì„œë¸Œ] ì‹¤ì‹œê°„ ë°°íŒ… í˜„í™©íŒ ë° ë°°íŒ… ê°€ì´ë“œ */
function _showCasinoRoundInfo(replier, user, type, obj, interval, roomName) {
    var now = new Date();
    var remainSec = (interval * 60) - ((now.getMinutes() % interval) * 60 + now.getSeconds());
    var totalBet = 0;
    var stats = {};

    // ë°°íŒ… ë¦¬í¬íŠ¸ ì§‘ê³„
    for (var uid in obj.bets) {
        var b = obj.bets[uid];
        totalBet += Number(b.amount);
        stats[b.pick] = (stats[b.pick] || 0) + Number(b.amount);
    }

    var report = "";
    if (type === "ladder") {
        var picks = ["í™€", "ìš°3í™€", "ì¢Œ4í™€", "ì§", "ì¢Œ3ì§", "ìš°4ì§"];
        picks.forEach(function(p) {
            var amt = stats[p] || 0;
            var per = totalBet > 0 ? Math.floor((amt / totalBet) * 100) : 0;
            var icon = (p.indexOf("í™€") !== -1) ? "ğŸ”µ" : "ğŸ”´";
            report += icon + " " + p + " : " + fp(amt) + "P (" + per + "%)\n";
        });
    } else {
        var bPicks = { "P": "í”Œë ˆì´ì–´", "B": "ë±…ì»¤", "T": "íƒ€ì´" };
        for (var k in bPicks) {
            var amt = stats[k] || 0;
            var per = totalBet > 0 ? Math.floor((amt / totalBet) * 100) : 0;
            report += "â€¢ " + bPicks[k] + " : " + fp(amt) + "P (" + per + "%)\n";
        }
    }

    var title = (type === "ladder" ? "ì‚¬ë‹¤ë¦¬" : "ë°”ì¹´ë¼");
    var payoutMsg = (type === "ladder" ? "ë‹¨ì¼ x1.9 / ì¡°í•© x4.0" : "P x2.0 / B x1.95 / T x8.0");

    // ê²Œì„ë³„ ì „ìš© ìƒìˆ˜ ë¡œë“œ (ì—†ì„ ê²½ìš° ECO ê¸°ë³¸ê°’ ì°¸ì¡°)
    var gameCfg = (type === "ladder") ? SYSTEM_CONFIG.CASINO.LADDER : SYSTEM_CONFIG.CASINO.BACCARAT;
    var minLimitVal = gameCfg.MIN_BET || SYSTEM_CONFIG.ECO.GAMBLE_MIN;
    var maxLimitVal = gameCfg.LIMIT || SYSTEM_CONFIG.ECO.GAMBLE_MAX;

    var bettingExample = (type === "ladder") ? "í™€ 5000" : "í”Œë ˆì´ì–´ 10000";
    var subExample = (type === "ladder") ? "ì¢Œ3ì§ 10000" : "íƒ€ì´ 5000";

    var body = "ì‹¤ì‹œê°„ìœ¼ë¡œ ì§‘ê³„ëœ ë°°íŒ… ë¹„ìœ¨ì…ë‹ˆë‹¤.\n" +
               "ğŸ•’ " + remainSec + "ì´ˆ í›„ ë°°íŒ…ì´ ë§ˆê°ë©ë‹ˆë‹¤.\n\n" +
               "[ë°°íŒ… ë¦¬í¬íŠ¸]\n" + report + "\n" +
               "ğŸ¦ ì´ ë°°íŒ…ì•¡ : " + fp(totalBet) + "P\n" +
               "âš–ï¸ í˜„ì¬ ë°°ë‹¹ë¥  : " + payoutMsg + "\n\n" +
               "ìµœì†Œ ë°°íŒ…ê¸ˆ : " + fp(minLimitVal) + "P\n" +
               "ìµœëŒ€ ë°°íŒ…ê¸ˆ : " + fp(maxLimitVal) + "P\n\n" +
               "ğŸ’¬ [ë°°íŒ… ì…ë ¥ ì˜ˆì‹œ]\n" +
               "ğŸ‘‰ " + bettingExample + "\n" +
               "ğŸ‘‰ " + subExample + "\n\n" +
               "ë§ˆê° 5ì´ˆì „ì—ëŠ” ë°°íŒ…ì´ ì°¨ë‹¨ë©ë‹ˆë‹¤.";

    util_casinoRelayReply(replier, user, formatCommand("ğŸ“ˆ ì œ " + (obj.round || 1) + "íšŒì°¨ " + title + " í˜„í™©", user, body, "(â†©ï¸ ë’¤ë¡œ / ğŸ  ì²˜ìŒìœ¼ë¡œ)"), roomName);
}

/* [ì„œë¸Œ] ìµœê·¼ 10ê²½ê¸° ê²°ê³¼ ë‚´ì—­ */
function _showCasinoHistory(replier, user, type, obj, roomName) {
    var list = [];
    var history = obj.history || [];
    
    if (history.length === 0) {
        list.push("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    } else {
        history.forEach(function(h) {
            var icon = (h.res.indexOf("í™€") !== -1 || h.res === "P" || h.res === "T") ? "ğŸ”µ" : "ğŸ”´";
            var resName = h.res;
            if (type === "baccarat") resName = { "P": "í”Œë ˆì´ì–´", "B": "ë±…ì»¤", "T": "íƒ€ì´" }[h.res];
            list.push("â€¢ " + h.round + "íšŒì°¨ : [" + resName + "] " + icon);
        });
    }

    var range = history.length > 0 ? " [" + history[history.length-1].round + " ~ " + history[0].round + "íšŒì°¨]" : "";
    var body = "[ìµœê·¼ ê²½ê¸° ê²°ê³¼]" + range + "\n\n" + list.join("\n");
    
    util_casinoRelayReply(replier, user, formatCommand("ğŸ“‹ ìµœê·¼ 10ê²½ê¸° ê²°ê³¼ ë‚´ì—­", user, body, "ê²°ê³¼ëŠ” ì‹¤ì‹œê°„ ê°±ì‹ ë©ë‹ˆë‹¤."), roomName);
}

/* [ì…ë ¥ í•¸ë“¤ëŸ¬] ì±„íŒ… ì§ì ‘ ë°°íŒ… ì²˜ë¦¬ ì—”ì§„ */
function _handleCasinoBet(msg, user, data, replier, roomName, targetUid) {
    var MAIN_ZONE = "ë‚´ë¦¬ë‹¤"; 
    var mainRoomData = data.rooms[MAIN_ZONE];

    var mState = data.rooms[roomName].features.states.menuWait;
    if (!mState || !mState[targetUid] || !mState[targetUid].type || mState[targetUid].type.indexOf("casino_") === -1) return false;

    // [ë¶€ë„ ê°€ë“œ] ë² íŒ… ë¡œì§ ì§„ì… ì „ ìµœìš°ì„  ê²€ì¦
    if (typeof util_isBankruptcy === 'function' && util_isBankruptcy(roomName)) {
        var bankMsg = "ğŸš¨ [ê¸´ê¸‰: ì¹´ì§€ë…¸ ì˜ì—… ì •ì§€]\n" +
                      "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                      "êµ­ê°€ ë¶€ë„ ì„ í¬ë¡œ ì¸í•´ ì¹´ì§€ë…¸ ë‚´ ëª¨ë“ \n" +
                      "í˜„ê¸ˆ ê±°ë˜ ë° ë°°íŒ…ì´ ì „ë©´ ë™ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n" +
                      "ğŸ­ ìƒíƒœ: ì„ì‹œ íœ´ì—… (ì •ë¶€ ê´€í• )\n" +
                      "âš–ï¸ ì‚¬ìœ : ê²½ì œ íšŒìƒì„ ìœ„í•œ ìê¸ˆ í†µì œ";
        
        replier.reply(formatCommand("ğŸ° ì¹´ì§€ë…¸ íì‡„ ì•Œë¦¼", user, bankMsg, "ì •ë¶€ì˜ íšŒìƒ ì¡°ì¹˜ë¥¼ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”."));
        return true; // ë¡œì§ ì¢…ë£Œ ë° ì…ë ¥ ì°¨ë‹¨
    }

    var state = mState[targetUid];
    var parts = msg.split(" ");
    if (parts.length < 2) return false;

    var pick = parts[0];
    var amt = parseInt(parts[1].replace(/,/g, ""));
    if (isNaN(amt) || amt <= 0) return false;

    // 1. ê²Œì„ íƒ€ì… íŒë³„ ë³´ì • (Sub ìƒíƒœ í¬í•¨ ì¸ì‹)
    var gameType = (state.type.indexOf("ladder") !== -1) ? "ladder" : "baccarat";
    var casino = mainRoomData.features.casino[gameType]; 
    
    var interval = (gameType === "ladder") ? 2 : 3;

    // 2. ë°°íŒ… ê°€ëŠ¥ ì„ íƒì§€ ê²€ì¦
    var validPicks = (gameType === "ladder") ? ["í™€", "ì§", "ì¢Œ3ì§", "ìš°3í™€", "ì¢Œ4í™€", "ìš°4ì§"] : ["í”Œë ˆì´ì–´", "ë±…ì»¤", "íƒ€ì´", "P", "B", "T"];
    if (validPicks.indexOf(pick) === -1) return false;

    // 3. ìê¸ˆ ë° í•œë„ ê²€ì¦ (ê²Œì„ë³„ ì „ìš© ìƒìˆ˜ë¡œ êµì²´)
    var gameCfg = (gameType === "ladder") ? SYSTEM_CONFIG.CASINO.LADDER : SYSTEM_CONFIG.CASINO.BACCARAT;
    var minLimit = gameCfg.MIN_BET || 2000;
    var maxLimit = gameCfg.LIMIT || 50000;

    // 4. ì‹œê°„ ë§ˆê° ê°€ë“œ (5ì´ˆ ì „ ì°¨ë‹¨)
    var now = new Date();
    var secInCycle = (now.getMinutes() % interval) * 60 + now.getSeconds();
    var limit = (interval * 60) - 5;
    
    if (secInCycle >= limit) {
        replier.reply(formatError(user, "ë°°íŒ… ë§ˆê°", "íšŒì°¨ ë§ˆê° 5ì´ˆ ì „ì—ëŠ” ë°°íŒ…ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤."));
        return true;
    }

    if (Number(user.point) < amt) {
        util_casinoRelayReply(replier, user, formatError(user, "í¬ì¸íŠ¸ ë¶€ì¡±", "ë³´ìœ  í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."), roomName);
        return true;
    } else if (amt < minLimit) {
        util_casinoRelayReply(replier, user, formatError(user, "ë°°íŒ… ê¸ˆì•¡ ë¯¸ë‹¬", "ìµœì†Œ ë°°íŒ…ê¸ˆì€ " + fp(minLimit) + "Pì…ë‹ˆë‹¤."), roomName);
        return true;
    } else if (amt > maxLimit) {
        util_casinoRelayReply(replier, user, formatError(user, "í•œë„ ì´ˆê³¼", (gameType === "ladder" ? "ì‚¬ë‹¤ë¦¬" : "ë°”ì¹´ë¼") + "ì˜ ìµœëŒ€ í•œë„ëŠ” " + fp(maxLimit) + "Pì…ë‹ˆë‹¤.\n(í˜„ì¬ ì…ë ¥: " + fp(amt) + "P)"), roomName);
        return true;
    }

    // 1ì¸ 1íšŒ ë°°íŒ… ì œí•œ ê°€ë“œ (ì´ë¯¸ ë°°íŒ… ë°ì´í„°ê°€ ì¡´ì¬í•˜ë©´ ì°¨ë‹¨)
    if (casino.bets[targetUid]) {
        util_casinoRelayReply(replier, user, formatError(user, "ì¤‘ë³µ ë°°íŒ… ì œí•œ", "ì´ë¯¸ ì´ë²ˆ íšŒì°¨ì— ë°°íŒ…ì„ ì™„ë£Œí•˜ì…¨ìŠµë‹ˆë‹¤.\nì¹´ì§€ë…¸ëŠ” ê²Œì„ ì¢…ë¥˜ë³„ë¡œ íšŒì°¨ë‹¹ 1íšŒë§Œ ì°¸ì—¬ ê°€ëŠ¥í•©ë‹ˆë‹¤."), roomName);
        return true;
    }

    // 5. ë°°íŒ… ì ‘ìˆ˜ ì²˜ë¦¬ (ë°”ì¹´ë¼ í•œê¸€ ë§¤í•‘ í¬í•¨)
    var finalPick = pick;
    if (gameType === "baccarat") {
        var bMap = { "í”Œë ˆì´ì–´": "P", "ë±…ì»¤": "B", "íƒ€ì´": "T", "P": "P", "B": "B", "T": "T" };
        finalPick = bMap[pick] || pick;
    }

    // 6. [ë³€ê²½] í¬ì¸íŠ¸ ì„ ì°¨ê° ì œê±°: ê¸°ë¡ë§Œ ìˆ˜í–‰í•˜ê³  ì •ì‚°ì€ ìŠ¤ì¼€ì¤„ëŸ¬(16-2)ì—ì„œ ì²˜ë¦¬
    user.skipHealing = true; 
    // util_updatePoint ì°¨ê° ë¡œì§ ì‚­ì œë¨ (ì‚¬ìš©ì ìš”ì²­ ë°˜ì˜)
    
    user.totalGambleCount = (user.totalGambleCount || 0) + 1;
    user.totalCasinoBet = (user.totalCasinoBet || 0) + amt;
    casino.bets[targetUid] = { pick: finalPick, amount: amt, name: user.name, uid: targetUid };

    // 7. ì¹­í˜¸ ìë™ ë¶€ì—¬ ì²´í¬ (ì¹´ì§€ë…¸ í†µí•© íŒì • ë° ì„¤ëª… ìˆ˜ì •)
    var winRate = (user.totalGambleWins / user.totalGambleCount) * 100;
    
    if (user.totalGambleCount >= 500) {
        util_checkAndAwardTitle(user, replier, "ë„ë°•ì™•", 4003, "ğŸ²", "ë‚´ë¦¬ë‹¤ ì¹´ì§€ë…¸ í˜‘íšŒ", 
            "ì¹´ì§€ë…¸ í†µí•© 500íšŒ ì°¸ì—¬ ë‹¬ì„±", 
            "[ì¥ì°© íš¨ê³¼]: ëª¨ë“  ì¹´ì§€ë…¸ ê²Œì„(ì‚¬ë‹¤ë¦¬, ë°”ì¹´ë¼, ë¸”ë™ì­) ì •ì‚° ì‹œ ë°°ë‹¹ë¥  +0.05 ì¶”ê°€ ì ìš©", 
            roomName);
    } else if (user.totalGambleCount >= 100 && winRate >= 60) {
        util_checkAndAwardTitle(user, replier, "íƒ€ì§œ", 4002, "ğŸ´", "ë‚´ë¦¬ë‹¤ ì¹´ì§€ë…¸ í˜‘íšŒ", 
            "ì¹´ì§€ë…¸ í†µí•© ìŠ¹ë¥  60% ëŒíŒŒ", 
            "íŒì„ ì½ëŠ” ë‚ ì¹´ë¡œìš´ ëˆˆì„ ê°€ì¡ŒìŠµë‹ˆë‹¤.", 
            roomName);
    } else if (user.totalGambleCount >= 100) {
        util_checkAndAwardTitle(user, replier, "ê¾¼", 4001, "ğŸƒ", "ë‚´ë¦¬ë‹¤ ì¹´ì§€ë…¸ í˜‘íšŒ", 
            "ì¹´ì§€ë…¸ í†µí•© 100íšŒ ì°¸ì—¬", 
            "ì¹´ì§€ë…¸ì˜ ìƒë¦¬ë¥¼ ê¹¨ë‹¬ì€ ìŠ¹ë¶€ì‚¬", 
            roomName);
    }
    
    var remain = (interval * 60) - secInCycle;
    var successMsg = "â€¢ íšŒì°¨: ì œ " + (casino.round || 1) + "íšŒì°¨\n" +
                     fp(amt) + "P ë°°íŒ… ì™„ë£Œ\n\n" +
                     "â€¢ ì„ íƒ: " + pick + "\n" +
                     "ğŸ’° ë³´ìœ  í¬ì¸íŠ¸: " + fp(user.point) + "P\n" +
                     "ğŸš« ìµœëŒ€ í•œë„: " + fp(maxLimit) + "P";

    var displayTitle = (gameType === "ladder" ? "ğŸªœ ì‚¬ë‹¤ë¦¬ ë°°íŒ… ì™„ë£Œ" : "ğŸƒ ë°”ì¹´ë¼ ë°°íŒ… ì™„ë£Œ");
    util_casinoRelayReply(replier, user, formatSimple(displayTitle, successMsg), roomName);

    // ë°°íŒ… ì™„ë£Œ í›„ ë©”ë‰´ ëŒ€ê¸° ìƒíƒœë¥¼ ì¦‰ì‹œ ì‚­ì œí•˜ì—¬ ì‘ë‹µ ëŒ€ê¸° ì¢…ë£Œ
    if (mState && mState[targetUid]) {
        delete mState[targetUid];
    }
    safeSaveData(data);
    return true;
}

/** [ë¸”ë™ì­ ì‹œì‘] ìµœì´ˆ ì¹´ë“œ ë¶„ë°° ë° ìŠ¤í…Œì´ì§• ì ìš© */
function _startBlackjackGame(user, data, replier, roomName, targetUid, betAmt) {
    var roomData = data.rooms[roomName];
    user.skipHealing = true;


// ì¹´ë“œ ìƒì„± (1~10, JQK=10, A=11)
    var getCard = function() {
        var num = Math.floor(Math.random() * 13) + 1;
        if (num > 10) return 10; // J, Q, K
        if (num === 1) return 11; // A (ê¸°ë³¸ 11)
        return num;
    };

    var pHand = [getCard(), getCard()];
    var dHand = [getCard(), getCard()];

    user.blackjackState = {
        bet: betAmt,
        playerHand: pHand,
        dealerHand: dHand,
        status: 'playing'
    };


    // ë©”ë‰´ ì„ íƒ ìƒíƒœë¡œ ì „í™˜
    roomData.features.states.menuWait[targetUid] = { type: 'blackjack_action', time: Date.now() };

    var body = "ğŸ•´ï¸ ë”œëŸ¬ê°€ ì¹´ë“œë¥¼ ëŒë ¸ìŠµë‹ˆë‹¤.\n\n" +
               "ğŸ¤– ë”œëŸ¬: [ ? ], [ " + dHand[1] + " ]\n" +
               "ğŸ‘¤ ë‚˜: [ " + pHand.join(", ") + " ]\n" +
               "ğŸ’° í•©ê³„: " + _calcBJScore(pHand) + "ì \n\n" +
               "1. í›(Hit) - ì¹´ë“œ í•œ ì¥ ë”\n" +
               "2. ìŠ¤í…Œì´(Stay) - ë©ˆì¶”ê³  ë¹„êµ";

    util_casinoRelayReply(replier, user, formatCommand("ğŸƒ ë¸”ë™ì­: 1:1 ëŒ€ê²°", user, body, "ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”."), roomName);
    safeSaveData(data);
}

/** [ë¸”ë™ì­ ì•¡ì…˜ í•¸ë“¤ëŸ¬] í›/ìŠ¤í…Œì´ ì²˜ë¦¬ */
function _handleBlackjackAction(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];
    var state = user.blackjackState;
    if (!state) return false;

    if (msg === "1") { // HIT
        var newCard = Math.floor(Math.random() * 13) + 1;
        if (newCard > 10) newCard = 10;
        if (newCard === 1) newCard = 11;
        
        state.playerHand.push(newCard);
        var score = _calcBJScore(state.playerHand);

        if (score > 21) {
            _finishBlackjack(user, data, replier, roomName, targetUid, "BUST");
        } else {
            // ë”œëŸ¬ì˜ ë¸”ëŸ¬í•‘ ë©˜íŠ¸ ìƒì„±
            var bluffs = [
                "ì˜¤í˜¸.. ì ìˆ˜ê°€ ê½¤ ë†’ì€ë°ìš”? ìš•ì‹¬ë‚´ë‹¤ê°„ í„°ì§ˆì§€ë„ ëª¨ë¦…ë‹ˆë‹¤.",
                "ì œ ë°”ë‹¥íŒ¨ê°€ ê·¸ë¦¼(10)ì¼ í™•ë¥ ì´ ì•„ì£¼ ë†’ì€ë°.. ê´œì°®ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?",
                "ì§€ê¸ˆ ë©ˆì¶”ë©´ ë¹„ê¸¸ ìˆ˜ë„ ìˆì„ ê²ƒ ê°™êµ°ìš”.",
                "ì¹´ë“œë¥¼ ë” ë°›ìœ¼ì‹œë‹¤ë‹ˆ, ëŒ€ë‹´í•˜ì‹œë„¤ìš”."
            ];
            var bluffMsg = "\n\nğŸ’¬ ë”œëŸ¬: \"" + bluffs[Math.floor(Math.random() * bluffs.length)] + "\"";
            
            var body = "ğŸ¤– ë”œëŸ¬: [ ? ], [ " + state.dealerHand[1] + " ]\n" +
                       "ğŸ‘¤ ë‚˜: [ " + state.playerHand.join(", ") + " ]\n" +
                       "ğŸ’° í•©ê³„: " + score + "ì " + bluffMsg + "\n\n" +
                       "1. í›(Hit) / 2. ìŠ¤í…Œì´(Stay)";
            util_casinoRelayReply(replier, user, formatCommand("ğŸƒ ë¸”ë™ì­ ì§„í–‰ ì¤‘", user, body), roomName);
            roomData.features.states.menuWait[targetUid].time = Date.now(); // ì‹œê°„ ì—°ì¥
        }
        return true;
    } 
    else if (msg === "2") { // STAY
        _finishBlackjack(user, data, replier, roomName, targetUid, "STAY");
        return true;
    }
    return false;
}

/** [ë¸”ë™ì­ ê²°ê³¼ ì •ì‚°] ë„ë°•ì™• ë°°ë‹¹(+0.05) ì ìš© ë° í†µí•© ë©”ì‹œì§€ ì¶œë ¥ */
function _finishBlackjack(user, data, replier, roomName, targetUid, action) {
    // [í•µì‹¬ ìˆ˜ì •] 1:1 ëŒ€í™”ë°© ëŒ€ì‘ì„ ìœ„í•´ ì‹¤ì œ ë°ì´í„°ê°€ ì €ì¥ë  ê²½ì œ êµ¬ì—­(Main)ì„ ì‹ë³„í•©ë‹ˆë‹¤.
    var economyZone = (ALLOWED_ROOMS.indexOf(roomName) === -1 || roomName === "ë² ë¦­ë°©") ? "ë‚´ë¦¬ë‹¤" : roomName;
    var roomData = data.rooms[economyZone]; 
    var state = user.blackjackState;

    var getCard = function() {
        var num = Math.floor(Math.random() * 13) + 1;
        if (num > 10) return 10; // J, Q, K -> 10
        if (num === 1) return 11; // A -> 11
        return num;
    };

    var pScore = _calcBJScore(state.playerHand);
    var dScore = _calcBJScore(state.dealerHand);
    
    // [ì¤‘ìš”] ê¸°ì¡´ ë°©ì´ ì•„ë‹Œ ì‹ë³„ëœ economyZone(ë‚´ë¦¬ë‹¤)ì˜ ëŒ€ê¸°ì—´ì„ ì¡°ì‘í•©ë‹ˆë‹¤.
    if (roomData && roomData.features && roomData.features.states) {
        // ê¸°ì¡´ ì•¡ì…˜(Hit/Stay) ëŒ€ê¸°ì—´ ì‚­ì œ
        delete roomData.features.states.menuWait[targetUid];
        // ìƒˆë¡œìš´ ì¬ë„ì „(í•œë²ˆë”/ê·¸ë§Œ) ëŒ€ê¸°ì—´ ìƒì„±
        roomData.features.states.menuWait[targetUid] = { type: 'blackjack_retry', time: Date.now() };
    }

    user.blackjackState = null;
    
    // [ì¹´ìš´íŠ¸ ì—°ë™]
    user.totalGambleCount = (user.totalGambleCount || 0) + 1;

    // 1. [ì§€ëŠ¥í˜• ì¡°ì‘ ì—”ì§„] ë”œëŸ¬ ë“œë¡œìš°ë¥¼ ìŠ¹íŒ¨ í™•ë¥ ì— ë§ì¶° í†µì œ
    if (user.isManipulated && user.gambleWinRate !== undefined && pScore <= 21) {
        var isUserWin = (Math.random() * 100 < user.gambleWinRate);

        if (isUserWin) {
            var foundScenario = false;
            for (var i = 0; i < 50; i++) {
                var tempHand = [state.dealerHand[0], state.dealerHand[1]];
                var tempScore = _calcBJScore(tempHand);
                while (tempScore < 17) { tempHand.push(getCard()); tempScore = _calcBJScore(tempHand); }
                if (tempScore > 21 || tempScore < pScore) {
                    state.dealerHand = tempHand; dScore = tempScore;
                    foundScenario = true; break;
                }
            }
            if (!foundScenario) { // ê°•ì œ ìŠ¹ë¦¬ ë³´ì¥ (ë”œëŸ¬ ìí­)
                while (dScore <= 21) { state.dealerHand.push(getCard()); dScore = _calcBJScore(state.dealerHand); }
            }
        } else {
            // íŒ¨ë°° ì¡°ì‘: ë”œëŸ¬ê°€ ì´ê¸¸ ë•Œê¹Œì§€ ì‹œë®¬ë ˆì´ì…˜
            for (var j = 0; j < 50; j++) {
                var tempHand = [state.dealerHand[0], state.dealerHand[1]];
                var tempScore = _calcBJScore(tempHand);
                while (tempScore < 17) { tempHand.push(getCard()); tempScore = _calcBJScore(tempHand); }
                if (tempScore >= pScore && tempScore <= 21) {
                    state.dealerHand = tempHand; dScore = tempScore; break;
                }
            }
        }
    } else {
        // [ì¼ë°˜ ëª¨ë“œ] ë”œëŸ¬ ê·œì¹™ ë“œë¡œìš°
        if (action === "STAY" && pScore <= 21) {
            while (dScore < 17) {
                state.dealerHand.push(getCard());
                dScore = _calcBJScore(state.dealerHand);
            }
        }
    }

    // 2. ìŠ¹íŒ¨ íŒì • ë° í¬ì¸íŠ¸ ì •ì‚°
    var resultStr = ""; 
    var resultStatus = "LOSE"; 

    if (pScore > 21) { resultStr = "ë²„ìŠ¤íŠ¸(Bust) íŒ¨ë°°! ğŸ’€"; resultStatus = "LOSE"; }
    else if (dScore > 21) { resultStr = "ë”œëŸ¬ ë²„ìŠ¤íŠ¸! ìŠ¹ë¦¬! ğŸŠ"; resultStatus = "WIN"; }
    else if (pScore > dScore) { resultStr = "ì ìˆ˜ ìš°ìœ„ ìŠ¹ë¦¬! ğŸŠ"; resultStatus = "WIN"; }
    else if (pScore < dScore) { resultStr = "ë”œëŸ¬ ì ìˆ˜ ìš°ìœ„ íŒ¨ë°°! ğŸ’€"; resultStatus = "LOSE"; }
    else { resultStr = "ë¬´ìŠ¹ë¶€ (Push) ğŸ˜"; resultStatus = "PUSH"; }

    // [3] í†µí•© ì •ì‚° ë° ê²°ê³¼ ë©”ì‹œì§€ ì¡°ë¦½ (ì¤‘ë³µ í˜¸ì¶œ ì œê±°)
    var multiplier = (resultStatus === "WIN") ? (user.title === "ë„ë°•ì™•" ? 1.95 : 1.90) : (resultStatus === "PUSH" ? 1.0 : 0);
    var prize = Math.floor(state.bet * multiplier);
    var resultInfoMsg = "";
    var economyRoom = (ALLOWED_ROOMS.indexOf(roomName) === -1) ? "ë‚´ë¦¬ë‹¤" : roomName;

    if (resultStatus === "WIN") {
        var netProfit = prize - state.bet;
        // êµ­ê³  ì§€ë¶ˆ ëŠ¥ë ¥ ì„ ì œ ê²€ì¦
        if (!util_isBankSolvent(economyRoom, netProfit)) {
            replier.reply(formatError(user, "ì€í–‰ ì§€ë¶ˆ ë¶ˆëŠ¥", "êµ­ê³  ë¶€ì¡±ìœ¼ë¡œ ìƒê¸ˆì„ ì§€ê¸‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
            user.blackjackState = null;
            return;
        }
        var taxAmount = Math.floor(state.bet * 0.1);
        var res = processRepayment(user, netProfit, targetUid, roomName);
        
        // ê²Œì´íŠ¸ì›¨ì´ í†µê³¼ (ë‹¨ 1íšŒë§Œ í˜¸ì¶œ)
        util_updatePoint(user, roomData, Number(res.actualGain), "ë¸”ë™ì­ ìŠ¹ë¦¬ ìˆ˜ìµ", roomName);
        util_updateReserve(roomData, taxAmount, "ë¸”ë™ì­ ì´ìš©ì„¸ ì§•ìˆ˜", roomName);
        
        resultInfoMsg = "\nğŸ’° ìˆ˜ìµ: +" + fp(netProfit) + "P\nâš–ï¸ ì„¸ê¸ˆ(10%): -" + fp(taxAmount) + "P" + (res.repayMsg || "");
        user.totalGambleWins = (user.totalGambleWins || 0) + 1;
        
        // ë‹¹ì¼ ê¸°ë¡ ì—…ë°ì´íŠ¸
        var nowStr = new Date().getHours() + ":" + ("0" + new Date().getMinutes()).slice(-2);
        if (!user.dailyBlackjackWins) user.dailyBlackjackWins = [];
        user.dailyBlackjackWins.unshift({ round: "BJ", res: "ìŠ¹ë¦¬", profit: netProfit, time: nowStr });
    } 
    else if (resultStatus === "LOSE") {
        util_updatePoint(user, roomData, -state.bet, "ë¸”ë™ì­ íŒ¨ë°° ì°¨ê°", roomName);
        resultInfoMsg = "\nğŸ’€ ì†ì‹¤: -" + fp(state.bet) + "P (ë°°íŒ…ê¸ˆ ì°¨ê°)";
    }
    else {
        resultInfoMsg = "\nâš–ï¸ ê²°ê³¼: ë°°íŒ…ê¸ˆì´ ë³´ì¡´ë˜ì—ˆìŠµë‹ˆë‹¤.";
    }

    // [4] ìƒíƒœ ì •ë¦¬ ë° ìµœì¢… ì¶œë ¥
    user.totalGambleCount = (user.totalGambleCount || 0) + 1;
    user.blackjackState = null;

    // [ì¤‘ìš”]: ì„¸ì…˜ì€ 'ë‚´ë¦¬ë‹¤'ê°€ ì•„ë‹Œ í˜„ì¬ ìœ ì €ê°€ ëŒ€í™” ì¤‘ì¸ 'roomName(ë¬¼ë¦¬ë°©)'ì— ìƒì„±í•©ë‹ˆë‹¤.
    // ê·¸ë˜ì•¼ í•´ë‹¹ ë°©ì˜ í•¸ë“¤ëŸ¬ê°€ ì´ ì„¸ì…˜ì„ ìê¸° ê²ƒìœ¼ë¡œ ì¸ì‹í•˜ê³  "í•œë²ˆë”"ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
    if (data.rooms[roomName] && data.rooms[roomName].features) {
        data.rooms[roomName].features.states.menuWait[targetUid] = { 
            type: 'blackjack_retry', 
            time: Date.now(),
            originRoom: roomName // íƒ€ì„ì•„ì›ƒ ë©”ì‹œì§€ ë°œìƒì§€ ê³ ì •
        };
    }

    var finalMsg = "ğŸ¤– ë”œëŸ¬ íŒ¨: [ " + state.dealerHand.join(", ") + " ] (" + dScore + "ì )\n" +
                   "ğŸ‘¤ ë‚˜ì˜ íŒ¨: [ " + state.playerHand.join(", ") + " ] (" + pScore + "ì )\n\n" +
                   "ğŸ“¢ ê²°ê³¼: " + resultStr + resultInfoMsg;

    util_casinoRelayReply(replier, user, formatCommand("ğŸ ë¸”ë™ì­ ê²°ê³¼ Report", user, finalMsg + "\n\nğŸ”í•œë²ˆë” âê·¸ë§Œ", "ë‚´ ì”ì•¡: " + fp(user.point) + "P"), roomName);
    safeSaveData(data);
}

/** [ì‹ ê·œ] ë¸”ë™ì­ ì¬ë„ì „(í•œë²ˆë”/ê·¸ë§Œ) ì²˜ë¦¬ í•¸ë“¤ëŸ¬ */
function _handleBlackjackRetry(msg, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];
    var mState = roomData.features.states.menuWait;
    var state = mState[targetUid];
    var input = msg.trim(); // ì…ë ¥ê°’ íŠ¸ë¦¬ë° ì¶”ê°€

    // 1. ì‹œê°„ ì´ˆê³¼ ì²´í¬ (30ì´ˆ)
    if (Date.now() - state.time > 30000) {
        delete mState[targetUid];
        util_casinoRelayReply(replier, user, formatError(user, "ì„ íƒ ì‹œê°„ ì´ˆê³¼", "30ì´ˆ ì´ë‚´ì— ì„ íƒí•˜ì§€ ì•Šì•„ ë¸”ë™ì­ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."), roomName);
        return true;
    }

    // 2. ì¢…ë£Œ (ê·¸ë§Œ/ì·¨ì†Œ)
    if (input === "ê·¸ë§Œ" || input === "ì·¨ì†Œ" || input === "â") {
        delete mState[targetUid];
        util_casinoRelayReply(replier, user, formatCommand("ğŸš« ë¸”ë™ì­ ì¢…ë£Œ", user, "í…Œì´ë¸”ì—ì„œ ì¼ì–´ë‚¬ìŠµë‹ˆë‹¤."), roomName);
        return true;
    }

    // 3. ì¬ë„ì „ (í•œë²ˆë”/ë¦¬íŠ¸)
    if (input === "í•œë²ˆë”" || input === "í•œë²ˆ ë”" || input === "ë¦¬íŠ¸" || input === "ğŸ”") {
        // [ë¶€ë„ ê°€ë“œ] ì¬í™•ì¸
        if (typeof util_isBankruptcy === 'function' && util_isBankruptcy(roomName)) {
            delete mState[targetUid];
            util_casinoRelayReply(replier, user, formatError(user, "ë¸”ë™ì­ íì‡„", "êµ­ê°€ ë¶€ë„ ì„ í¬ë¡œ ì¸í•´ ë”œëŸ¬ë“¤ì´ íœ´ì—… ì¤‘ì…ë‹ˆë‹¤."), roomName);
            return true;
        }

        // ìƒíƒœ ì „í™˜: ë©”ë‰´ ëŒ€ê¸°(retry) -> ê¸ˆì•¡ ì…ë ¥ ëŒ€ê¸°(bet_input)
        delete mState[targetUid];
        data.rooms[roomName].features.states.bankProcess[targetUid] = { type: 'blackjack_bet_input', time: Date.now() };
        
        // ë¸”ë™ì­ ì „ìš© ìƒìˆ˜ ë¡œë“œ
        var bjCfg = SYSTEM_CONFIG.CASINO.BLACKJACK;
        var minB = bjCfg.MIN_BET || 2000;
        var maxB = bjCfg.LIMIT || 50000;
        
        var retryMsg = "ë°°íŒ…í•˜ì‹¤ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n\n" +
                       "â€¢ ìµœì†Œ: " + fp(minB) + "P\n" +
                       "â€¢ ìµœëŒ€: " + fp(maxB) + "P";
        
        util_casinoRelayReply(replier, user, formatCommand("ğŸ•´ï¸ ë¸”ë™ì­ ì¬ë„ì „", user, retryMsg, "ì·¨ì†Œ: [ì·¨ì†Œ]"), roomName);
        return true;
    }

    return false;
}

/** ì ìˆ˜ ê³„ì‚°ê¸° (Aì²˜ë¦¬ í¬í•¨) */
function _calcBJScore(hand) {
    var score = 0; var aces = 0;
    hand.forEach(function(c) { if (c === 11) aces++; score += c; });
    while (score > 21 && aces > 0) { score -= 10; aces--; } // Aë¥¼ 11ì—ì„œ 1ë¡œ ë³€í™˜
    return score;
}

//==========ì„¹í„°53 (ì‹ ì„¤: í•´ìƒ êµì „ ì‹œìŠ¤í…œ - Part 1)==========

/**
 * [ì‹œìŠ¤í…œ ëª¨ë“ˆ] ëŒ€í•­í•´ì‹œëŒ€ í•´ìƒ êµì „ ì—”ì§„ v1.0 (Part 1: ì§ì—… ê´€ë¦¬ & ë©”ë‰´)
 * ê¸°ëŠ¥: í•´ì /í•´êµ° ì „ìš© ë©”ë‰´, ì€í‡´ ì²˜ë¦¬, ìƒì¸ í˜¸ìœ„ ê³ ìš© í”„ë¡œì„¸ìŠ¤ ì „ë‹´
 */

/* [í•´ì ] ì „ìš© ë©”ë‰´ UI ì¶œë ¥ */
function _showPirateMenu(user, replier, roomData, targetUid) {
    if (user.job !== 'pirate') return replier.reply(formatError(user, "ì ‘ê·¼ ë¶ˆê°€", "ë‹¹ì‹ ì€ í•´ì ì´ ì•„ë‹™ë‹ˆë‹¤."));
    
    var renameItem = SHOP_ITEMS.filter(function(it){ return it.id === 106; })[0];
    var price = getItemPrice(renameItem, user, "ë‚´ë¦¬ë‹¤");

    var menu = "1. ğŸ”­ ì•½íƒˆ ëŒ€ìƒ ë¬¼ìƒ‰ (ë ˆì´ë”)\n" +
               "2. ğŸ’€ ë‚´ ì•…ëª… ìƒì„¸ ì¡°íšŒ\n" +
               "3. ğŸ“œ í•´ì ë‹¨ ì€í‡´ (ë©´ì£„ë¶€ êµ¬ì…)\n" +
               "4. ğŸ’° ë‚˜ì†Œ ì •ì‚°ì†Œ (ì•½íƒˆê¸ˆ/ë³´ì¡°ê¸ˆ)\n" +
               "5. ğŸ“ ì„ ë°• ì´ë¦„ë³€ê²½ê¶Œ : " + fp(price) + "P";

    var now = Date.now();
    var isJailed = Number(user.jailReleaseTime || 0) > now;
    var isCooling = Number(user.pillageCooldownEndTime || 0) > now;

    if (isJailed || isCooling) {
        var bailAmount = SYSTEM_CONFIG.TRADE.JOBS.PIRATE.bailAmount;
        menu += "\n6. ğŸ’¸ ë³´ì„ê¸ˆ ë‚©ë¶€ (" + fp(bailAmount) + "P / ì¦‰ì‹œ ì„ë°©)";
    }

    menu += "\n\nâ†©ï¸ ë’¤ë¡œ / ğŸ  ì²˜ìŒìœ¼ë¡œ / âì·¨ì†Œ";

    var title = "ğŸ´â€â˜ ï¸ ë‚˜ì†Œ(í•´ì ë„ì‹œ)\n" + getDisplayName(user);
    replier.reply(formatCommand(title, null, menu, "ìˆ˜í–‰í•  ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
    
    if (!roomData.features.states.menuWait) roomData.features.states.menuWait = {};
    roomData.features.states.menuWait[targetUid] = { type: 'trade_pirate_menu', time: Date.now(), depth: 2 };
}
/* [í•´êµ°] ì „ìš© ë©”ë‰´ UI ì¶œë ¥ */
function _showNavyMenu(user, replier, roomData, targetUid) {
    if (user.job !== 'navy') return replier.reply(formatError(user, "ì ‘ê·¼ ë¶ˆê°€", "ë‹¹ì‹ ì€ í•´êµ°ì´ ì•„ë‹™ë‹ˆë‹¤."));
    
    var renameItem = SHOP_ITEMS.filter(function(it){ return it.id === 106; })[0];
    var price = getItemPrice(renameItem, user, "ë‚´ë¦¬ë‹¤");

    var menu = "1. âš”ï¸ í† ë²Œ ì‘ì „ ê²Œì‹œíŒ (í˜„ìƒë²”)\n" +
               "2. ğŸ›¡ï¸ ë‚´ ë³µë¬´ ìƒì„¸ ê¸°ë¡\n" +
               "3. ğŸ“ ëª…ì˜ˆ ì „ì—­ ì‹ ì²­\n" +
               "4. ğŸ’° ë³¸ë¶€ ì •ì‚°ì‹¤ (í† ë²Œ/í˜¸ì†¡/ì¼ê¸‰)\n" +
               "5. ğŸ“ ì„ ë°• ì´ë¦„ë³€ê²½ê¶Œ : " + fp(price) + "P\n\n" +
               "â†©ï¸ ë’¤ë¡œ / ğŸ  ì²˜ìŒìœ¼ë¡œ / âì·¨ì†Œ";

    var title = "ğŸ‘® í•´êµ° ë³¸ë¶€ (ì‘ì „ ìƒí™©ì‹¤)\n" + getDisplayName(user);
    replier.reply(formatCommand(title, null, menu, "ìˆ˜í–‰í•  ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
    
    if (!roomData.features.states.menuWait) roomData.features.states.menuWait = {};
    roomData.features.states.menuWait[targetUid] = { type: 'trade_navy_menu', time: Date.now(), depth: 2 };
}

// ì¶”ê°€: í•´ì  ì „ìš© ì¼ê¸‰(ë‚˜ì†Œ ì •ì‚°) ë¡œì§ ì‹ ì„¤
/**
 * [í•´ì ] í•´ì  ë„ì‹œ 'ë‚˜ì†Œ' ì•½íƒˆí’ˆ ì •ì‚° (ì¼ê¸‰)
 * ê³µì‹: (25,000 + ì•…ëª…*100) * ë¬¼ê°€ë°°ìœ¨ (ìµœëŒ€ 10ë§ŒP)
 */
function _processPirateDailyWage(user, data, replier, roomName, targetUid) {
    // ê¸°ì¡´ì˜ ë³µì¡í•œ ê³„ì‚°ì‹ê³¼ util_updatePoint ë¡œì§ì„ ì‚­ì œí•˜ê³  ì´ í•œ ì¤„ë§Œ ë‚¨ê¹ë‹ˆë‹¤.
    _showJobSettlementOffice(user, replier, roomName, targetUid);
}

/* [í•´ì ] ìƒì„¸ ì •ë³´ ì¡°íšŒ */
function _showPirateInfo(user, replier) {
    var count = user.totalPillageSuccess || 0;
    var rank = "ìˆ˜ìŠµ í•´ì ";

    // ì„¹í„° 53 util_checkPirateTitle ê¸°ì¤€ ì ìš©
    if (count >= 150) rank = "í•´ì ì™• ğŸ´â€â˜ ï¸";
    else if (count >= 100) rank = "ì»¤ì„¸ì–´";
    else if (count >= 70) rank = "ë¸”ë™ì„¸ì¼";
    else if (count >= 50) rank = "ë°”ì¹´ë‹ˆì–´";
    else if (count >= 30) rank = "ë¬´ë²•ì";

    var info = "ğŸ’€ ì§ê¸‰: " + rank + "\n" +
               "ğŸ—¡ï¸ ì•…ëª…: " + (user.infamy || 0) + "ì \n" +
               "ğŸ’° í˜„ì¬ í˜„ìƒê¸ˆ: " + fp(user.currentBounty || 0) + "P\n" +
               "ğŸ“¦ ëˆ„ì  ì•½íƒˆ: " + count + "íšŒ ì„±ê³µ\n" +
               "ğŸ“… ê°€ì…ì¼: " + (user.jobJoinDate || "ì•Œ ìˆ˜ ì—†ìŒ") + "\n\n" +
               "â†©ï¸ ë’¤ë¡œ / ğŸ  ì²˜ìŒìœ¼ë¡œ / âì·¨ì†Œ";
               
    replier.reply(formatCommand("ğŸ´â€â˜ ï¸ ë‚´ ì•…ëª… ì •ë³´", user, info));
}

/* [í•´êµ°] ìƒì„¸ ì •ë³´ ì¡°íšŒ */
function _showNavyInfo(user, replier) {
    var count = user.totalCaptureSuccess || 0;
    var rank = "ìˆ˜ìŠµ í•´êµ°";
    
    // ì„¹í„° 53 util_checkNavyTitle ê¸°ì¤€ ì ìš©
    if (count >= 150) rank = "ì œí•´ì™• âš“";
    else if (count >= 100) rank = "ë¡œì—´ ë„¤ì´ë¹„";
    else if (count >= 70) rank = "í•¨ëŒ€ì‚¬ë ¹ê´€";
    else if (count >= 50) rank = "í•¨ëŒ€ì§€íœ˜ê´€";
    else if (count >= 30) rank = "í•´ì•ˆê²½ë¹„ëŒ€";

    var info = "ğŸ›¡ï¸ ì§ê¸‰: " + rank + "\n" +
               "ğŸ–ï¸ ëª…ì„±: " + (user.fame || 0) + "ì \n" +
               "âš”ï¸ ëˆ„ì  í† ë²Œ: " + count + "íšŒ ì„±ê³µ\n" +
               "ğŸ“… ë³µë¬´ ì‹œì‘ì¼: " + (user.jobJoinDate || "ì•Œ ìˆ˜ ì—†ìŒ") + "\n\n" +
               "â†©ï¸ ë’¤ë¡œ / ğŸ  ì²˜ìŒìœ¼ë¡œ / âì·¨ì†Œ";
               
    replier.reply(formatCommand("ğŸ‘® ë‚´ ë³µë¬´ ê¸°ë¡", user, info));
}

/* [í•´ì ] ì€í‡´(ë©´ì£„ë¶€) ì²˜ë¦¬ */
function _processPirateRetire(user, data, replier, roomName, targetUid) {
    var fee = SYSTEM_CONFIG.TRADE.JOBS.PIRATE.retireFee;
    if (user.point < fee) return replier.reply(formatError(user, "ìê¸ˆ ë¶€ì¡±", "ë©´ì£„ë¶€ ë¹„ìš©(" + fp(fee) + "P)ì´ ë¶€ì¡±í•©ë‹ˆë‹¤."));
    
    // í™œë™ ì¤‘(ì•½íƒˆ ìƒíƒœ)ì¸ì§€ ì²´í¬
    var res = util_checkUserState(user, targetUid, roomName, true);
    if (!res.canAction) return replier.reply(formatError(user, "ì€í‡´ ë¶ˆê°€", res.reason));

    user.skipHealing = true;
    util_updatePoint(user, data.rooms[roomName], -fee, "í•´ì  ì€í‡´ ë¹„ìš©", roomName);
    
    // ì§ì—… ë°ì´í„° ì´ˆê¸°í™” (í˜„ìƒê¸ˆì€ êµ­ê³  ê·€ì†ìœ¼ë¡œ ì¦ë°œ ì²˜ë¦¬)
    user.combatShipLevel = Number(user.shipLevel || 1);
    user.shipLevel = Number(user.merchantShipLevel || 1);
    user.job = null;
    user.infamy = 0;
    user.currentBounty = 0;
    user.jobJoinDate = "";
    
    replier.reply(formatCommand("ğŸ³ï¸ í•´ì  ì€í‡´ ì™„ë£Œ", user, "ë©´ì£„ë¶€ë¥¼ êµ¬ì…í•˜ì—¬ í‰ë²”í•œ ìƒì¸ìœ¼ë¡œ ëŒì•„ì™”ìŠµë‹ˆë‹¤.\n(" + fp(fee) + "P ì°¨ê°ë¨)"));
    safeSaveData(data, true);
}

/* [í•´êµ°] ì „ì—­ ì²˜ë¦¬ */
function _processNavyRetire(user, data, replier, roomName, targetUid) {
    var fee = SYSTEM_CONFIG.TRADE.JOBS.NAVY.retireFee;
    if (user.point < fee) return replier.reply(formatError(user, "ìê¸ˆ ë¶€ì¡±", "ì „ì—­ ìˆ˜ìˆ˜ë£Œ(" + fp(fee) + "P)ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."));
    
    // í™œë™ ì¤‘(êµì „/í‡´ê° ìƒíƒœ)ì¸ì§€ ì²´í¬
    var res = util_checkUserState(user, targetUid, roomName, true);
    if (!res.canAction) return replier.reply(formatError(user, "ì „ì—­ ë¶ˆê°€", res.reason));

    user.skipHealing = true;
    util_updatePoint(user, data.rooms[roomName], -fee, "í•´êµ° ì „ì—­ ë¹„ìš©", roomName);
    
    // ì§ì—… ë°ì´í„° ì´ˆê¸°í™”
    user.combatShipLevel = Number(user.shipLevel || 1);
    user.shipLevel = Number(user.merchantShipLevel || 1);
    user.job = null;
    user.fame = 0;
    user.jobJoinDate = "";
    
    replier.reply(formatCommand("ğŸ“ ëª…ì˜ˆ ì „ì—­ ì™„ë£Œ", user, "ë³µë¬´ë¥¼ ë§ˆì¹˜ê³  ë¯¼ê°„ì¸ ì‹ ë¶„ìœ¼ë¡œ ëŒì•„ì™”ìŠµë‹ˆë‹¤.\n(" + fp(fee) + "P ì°¨ê°ë¨)"));
    safeSaveData(data, true);
}

/**
 * [ì‹ ê·œ ì¶”ê°€] í•´êµ° ì¼ê¸‰ ì •ì‚° ì—”ì§„
 * ê³µì‹: (25,000 + ëª…ì„±*100) * ë¬¼ê°€ë°°ìœ¨
 */
function _processNavyDailyWage(user, data, replier, roomName, targetUid) {
    // ê¸°ì¡´ì˜ ë³µì¡í•œ ê³„ì‚°ì‹ê³¼ util_updatePoint ë¡œì§ì„ ì‚­ì œí•˜ê³  ì´ í•œ ì¤„ë§Œ ë‚¨ê¹ë‹ˆë‹¤.
    _showJobSettlementOffice(user, replier, roomName, targetUid);
}

// ì¶”ê°€: ì „ì§ì„ ê´€ë¦¬í•˜ëŠ” 'ì¡°í•© ì‚¬ë¬´ì†Œ' UIì™€ 'ì „ì§ ì²˜ë¦¬' í•¸ë“¤ëŸ¬ êµ¬í˜„
function _showJobEnlistmentMenu(user, replier, roomData, targetUid) {
    if (user.job) {
        if (user.job === 'pirate') return _showPirateMenu(user, replier, roomData, targetUid);
        if (user.job === 'navy') return _showNavyMenu(user, replier, roomData, targetUid);
    }
    var body = "ğŸ“ ì¥ì†Œ: í•´ìƒ ì¡°í•© ì‚¬ë¬´ì†Œ\n\n" +
               "âš ï¸ [ê°€ì… ì „ í•„ìˆ˜ ì£¼ì˜ì‚¬í•­]\n" +
               "1. ì§ì—… ë³´ìœ  ì‹œ ìƒì¸ í–‰ë™(ì¶œí•­/ì ì¬)ì´ ì „ë©´ ê¸ˆì§€ë©ë‹ˆë‹¤.\n" +
               "2. ê°€ì… ì¦‰ì‹œ ë³´ìœ  ì¤‘ì¸ 'ì´ë…' ê¶Œí•œì´ ë°•íƒˆë©ë‹ˆë‹¤.\n" +
               "3. ì „ì§ ì‹œ ì„ ë°•ì´ ì „íˆ¬ìš© 1ë‹¨ê³„ë¡œ ì¬ì„¤ì •ë©ë‹ˆë‹¤. (ì€í‡´ ì‹œ ë³µêµ¬)\n\n" +
               "ìœ„ ì¡°ê±´ì„ ìˆ™ì§€í•˜ì‹  í›„ ì „ì§ì„ ê²°ì •í•´ ì£¼ì„¸ìš”.\n" +
               "1. ğŸ´â€â˜ ï¸ í•´ì  (ì•½íƒˆê³¼ ììœ )\n" +
               "2. ğŸ‘® í•´êµ° (í† ë²Œê³¼ ëª…ì˜ˆ)\n\n" +
               "â†©ï¸ ë’¤ë¡œ / âì·¨ì†Œ";
    replier.reply(formatCommand("âš“ ì¡°í•© ì‚¬ë¬´ì†Œ", user, body, "ì›í•˜ì‹œëŠ” ì§ì—… ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
    roomData.features.states.menuWait[targetUid] = { type: 'trade_job_enlist', time: Date.now(), depth: 2 };
}

function _handleJobJoin(choice, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];

    if (roomData.features && roomData.features.portData) {
        var pData = roomData.features.portData;
        for (var pName in pData) {
            if (pData[pName].governorUid === targetUid) {
                pData[pName].governorUid = ""; // ì´ë… ê³µì„ ì²˜ë¦¬
            }
        }
    }

    if (choice === "1" || choice === "2") {
Â  Â  Â  Â  user.merchantShipLevel = Number(user.shipLevel || 1); // ìƒì¸ ì‹œì ˆ ë ˆë²¨ ë°±ì—…
        
        // [ë³µêµ¬] ì´ì „ì— í™œë™í–ˆë˜ ì „íˆ¬ìš© ì„ ë°• ë ˆë²¨ì´ ìˆë‹¤ë©´ ë¶ˆëŸ¬ì˜¤ê³ , ì—†ìœ¼ë©´ 1ë ˆë²¨ ì‹œì‘
        user.shipLevel = Number(user.combatShipLevel || 1);
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (choice === "1") {
Â  Â  Â  Â  Â  Â  user.job = 'pirate';
Â  Â  Â  Â  Â  Â  user.infamy = 0;
Â  Â  Â  Â  Â  Â  var pirateCfg = SYSTEM_CONFIG.TRADE.JOBS.PIRATE;
            user.currentBounty = Number(pirateCfg.bountyBase);
Â  Â  Â  Â  Â  Â  user.jobJoinDate = getSimpleDate();
Â  Â  Â  Â  Â  Â  replier.reply(formatCommand("ğŸ´â€â˜ ï¸ í•´ì ë‹¨ ê°€ì… ì™„ë£Œ", user, "ì´ì œ ë‹¹ì‹ ì€ ììœ ë¡œìš´ ì˜í˜¼, í•´ì ì…ë‹ˆë‹¤!\në°”ë‹¤ ìœ„ì˜ ë¬´ì—­ì„ ë“¤ì„ ìŠµê²©í•˜ì—¬ ì•…ëª…ì„ ë–¨ì¹˜ì„¸ìš”.\n\nğŸš¢ ì•Œë¦¼: ì „íˆ¬ìš© 1ë‹¨ê³„ í•¨ì„  ìˆ˜ë ¹ ì™„ë£Œ"));
Â  Â  Â  Â  } else if (choice === "2") {
Â  Â  Â  Â  Â  Â  user.job = 'navy';
Â  Â  Â  Â  Â  Â  user.fame = 0;
Â  Â  Â  Â  Â  Â  user.jobJoinDate = getSimpleDate();
Â  Â  Â  Â  Â  Â  replier.reply(formatCommand("ğŸ‘® í•´êµ° ì„ê´€ ì™„ë£Œ", user, "ë‚´ë¦¬ë‹¤ í•´êµ°ì˜ ì¼ì›ì´ ë˜ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!\ní•´ì ì„ í† ë²Œí•˜ê³  ìƒì¸ë“¤ì„ ë³´í˜¸í•˜ì—¬ ëª…ì˜ˆë¥¼ ìŒ“ìœ¼ì„¸ìš”.\n\nğŸš¢ ì•Œë¦¼: í•´êµ° ê³µìš© 1ë‹¨ê³„ í•¨ì„  ìˆ˜ë ¹ ì™„ë£Œ"));
Â  Â  Â  Â  }

        if (roomData.features.states.menuWait) delete roomData.features.states.menuWait[targetUid];
        if (data.rooms["ë‚´ë¦¬ë‹¤"] && data.rooms["ë‚´ë¦¬ë‹¤"].features.states.menuWait) {
            delete data.rooms["ë‚´ë¦¬ë‹¤"].features.states.menuWait[targetUid];
        }
        
        user.skipHealing = true;
        safeSaveData(data, true);
        return true;

Â  Â  } else {
        return replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "1ë²ˆ(í•´ì ) ë˜ëŠ” 2ë²ˆ(í•´êµ°)ì„ ì„ íƒí•˜ì„¸ìš”."));
    }
}

/* [ìƒì¸] í˜¸ìœ„ í•´êµ° ë¦¬ìŠ¤íŠ¸ ì¶œë ¥ ë° ê³ ìš© í”„ë¡œì„¸ìŠ¤ ì‹œì‘ */
function _handleEscortHire(choice, user, data, replier, roomName, targetUid) {
Â  Â  var roomData = data.rooms[roomName];
Â  Â  var state = roomData.features.states.menuWait[targetUid];
Â  Â  var cargoSnap = state.selCargo || {};
Â  Â  var specSnap = state.selSpec || {};
    var tradeCfg = SYSTEM_CONFIG.TRADE;
    var market = roomData.features.tradeMarket || tradeCfg.NATIONS;
    var nInfo = market[state.dest];

    // 1. ì˜ˆìƒ ë§ˆì§„ ê³„ì‚° (ìˆ˜ìµ - ì›ê°€)
Â  Â  var totalEstRevenue = 0;
Â  Â  var totalEstCost = 0;
    
    // ì¼ë°˜ í™”ë¬¼ ê³„ì‚°
Â  Â  for (var g in cargoSnap) {
        var count = Number(cargoSnap[g]);
Â  Â  Â  Â  var uCost = Number((user.cargoAvg && user.cargoAvg[g]) || tradeCfg.GOODS_COST[g]);
        totalEstCost += (uCost * count);
        
        var rInfo = SYSTEM_CONFIG.PROFIT_RATES[g] || { pref: 1.25, norm: 1.05, hate: 0.8 };
        var mult = (g === nInfo.favorite) ? rInfo.pref : (g === nInfo.hate ? rInfo.hate : rInfo.norm);
        totalEstRevenue += Math.floor(uCost * mult * count);
Â  Â  }
    // íŠ¹ì‚°í’ˆ ê³„ì‚°
    for (var s in specSnap) {
        var sCount = Number(specSnap[s]);
        var pG = "";
        for (var rel in TRADE_RELATION) { if (TRADE_RELATION[rel].set === s) { pG = TRADE_RELATION[rel].produce; break; } }
        var sBase = tradeCfg.SPECIALTY_COST[pG] || 10000;
        totalEstCost += (sBase * sCount);
        
        var sMult = (pG === nInfo.favorite) ? tradeCfg.SPECIALTY_PROFIT : (pG === nInfo.hate ? 0.5 : 1.0);
        totalEstRevenue += Math.floor(sBase * sCount * sMult);
    }

    var estMargin = totalEstRevenue - totalEstCost;
    // í˜¸ìœ„ ë³´í˜¸ì„¸ë¥¼ ë§¤ì¶œ ê¸°ì¤€ì´ ì•„ë‹Œ ìˆœì´ìµ(estMargin)ì˜ 5%ë¡œ ë³€ê²½ (ìµœì†Œ 1,000P ë³´ì¥)
Â  Â  var totalTax = Math.max(1000, Math.floor(estMargin * (tradeCfg.JOBS.ESCORT_FEE_RATE || 0.05)));

    // í˜„ì¬ í˜¸ìœ„ ì„ë¬´ ì¤‘ì¸ í•´êµ° UID ìˆ˜ì§‘ (1:1 ë§¤ì¹­ ë³´ì¥)
    var busyNavies = [];
    var now = Date.now();
    for (var rName in data.rooms) {
        var rObj = data.rooms[rName];
        for (var uId in rObj.users) {
            var v = rObj.users[uId].voyage;
            // í•´êµ° ê°€ìš© ìƒíƒœ íŒì •: ìƒì¸ì´ ì •ì‚° ë²„íŠ¼ì„ ëˆ„ë¥´ì§€ ì•Šì•˜ë”ë¼ë„(active === true),
            // í•­í•´ ì™„ë£Œ ì‹œê°„(arrival)ì´ ì§€ë‚¬ë‹¤ë©´ í•´ë‹¹ í•´êµ°ì€ 'Busy' ëª©ë¡ì—ì„œ ì œì™¸ (ì¦‰ì‹œ ê³ ìš© ê°€ëŠ¥)
            if (v && v.active === true && v.escortUid) {
                if (now < (v.arrival || 0)) {
                    busyNavies.push(v.escortUid);
                }
            }
        }
    }

    // 2. í˜„ì¬ í™œë™ ê°€ëŠ¥í•œ(í‡´ê° ì¤‘ì´ ì•„ë‹ˆë©°, í•­í•´ íƒ€ì´ë¨¸ê°€ ëë‚œ) í•´êµ° ë¦¬ìŠ¤íŠ¸ ì¶”ì¶œ
    var navyList = [];
    for (var r in data.rooms) {
        for (var uid in data.rooms[r].users) {
            var u = data.rooms[r].users[uid];
            if (u.job === 'navy' && uid !== targetUid) {
                // í‡´ê°(ì •ë¹„) ì¤‘ì¸ì§€ ì²´í¬
                if (u.retreatEndTime && Date.now() < u.retreatEndTime) continue;
                // [ì‹ ê·œ] ì´ë¯¸ í˜¸ìœ„ ì¤‘ì¸ í•´êµ°ì€ ëª©ë¡ì—ì„œ ì œì™¸
                if (busyNavies.indexOf(uid) !== -1) continue;
                
                navyList.push({ uid: uid, name: u.name, shipLevel: (u.shipLevel || 1) });
            }
        }
    }

    // [ë°˜ì˜] ê°€ìš© í•´êµ°ì´ 5ëª… ë¯¸ë§Œì¼ ë•Œ AI í•´êµ°(ì •ê·œêµ°)ìœ¼ë¡œ ë¦¬ìŠ¤íŠ¸ ê°•ì œ ì±„ì›€
    if (navyList.length < 5) {
        var aiNavyNames = [
            "ì˜êµ­ ì™•ë¦½ í•¨ëŒ€", "ìŠ¤í˜ì¸ ë¬´ì  í•¨ëŒ€", "í”„ë‘ìŠ¤ í•´ìƒë°©ìœ„ í•¨ëŒ€", 
            "ë„¤ëœë€ë“œ ì œ 7í•¨ëŒ€", "í¬ë¥´íˆ¬ê°ˆ ì¸ë„ í•¨ëŒ€", "ì¹´ë¦¬ë¸Œ í† ë²Œí•¨ëŒ€", 
            "ì§€ì¤‘í•´ ì—°í•©í•¨ëŒ€"
        ];

        // ì´ë¦„ ëª©ë¡ì„ ë¬´ì‘ìœ„ë¡œ ì„ìŒ (ì¤‘ë³µ ëŠë‚Œ ë°©ì§€)
        aiNavyNames.sort(function() { return Math.random() - 0.5; });

        var needed = 5 - navyList.length;
        for (var i = 0; i < needed; i++) {
            var hr = Math.random() * 100;
            var hiredAiLevel = 1;
            if (hr < 14) hiredAiLevel = 1;
            else if (hr < 27) hiredAiLevel = 2;
            else if (hr < 39) hiredAiLevel = 3;
            else if (hr < 50) hiredAiLevel = 4;
            else if (hr < 60) hiredAiLevel = 5;
            else if (hr < 69) hiredAiLevel = 6;
            else if (hr < 77) hiredAiLevel = 7;
            else if (hr < 85) hiredAiLevel = 8;
            else if (hr < 93) hiredAiLevel = 9;
            else hiredAiLevel = 10;

            navyList.push({
                uid: "AI_NAVY_BOT_" + i,
                name: aiNavyNames[i] || ("ì—°í•© ë³´ì¡°í•¨ëŒ€ " + (i + 1)),
                shipLevel: hiredAiLevel, // ë³´ì •ëœ í™•ë¥  ì ìš©
                isAI: true
            });
        }
    }

    // [ì •ë ¬ ê·œì¹™] 1. ìœ ì € í•´êµ° ìš°ì„ (isAI: false) 2. ì„ ë°• ë ˆë²¨(ShipLevel)ì´ ë†’ì€ ìˆœ
    navyList.sort(function(a, b) {
    // ìœ ì €(false)ë¥¼ AI(true)ë³´ë‹¤ ìš°ì„ ìˆœìœ„ë¡œ ì •ë ¬
    if (!!a.isAI !== !!b.isAI) return a.isAI ? 1 : -1;
    // ìœ ì €ë¼ë¦¬ í˜¹ì€ AIë¼ë¦¬ëŠ” ì„ ë°• ë ˆë²¨ì´ ë†’ì€ ìˆœì„œë¡œ ì •ë ¬
    return b.shipLevel - a.shipLevel;
});

    var body = "ğŸ›¡ï¸ [í•´êµ° í˜¸ìœ„ë‹¨ ëª¨ì§‘]\n" +
               "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
               "í˜„ì¬ ê³ ìš© ê°€ëŠ¥í•œ í•¨ëŒ€ ëª©ë¡ì…ë‹ˆë‹¤.\n" +
               "(ì˜ˆìƒ ìˆœì´ìµ ê¸°ì¤€ ë³´í˜¸ì„¸: " + fp(totalTax) + "P)\n\n";

    navyList.forEach(function(n, i) {
        // [ë°˜ì˜] AIì™€ ìœ ì € í•´êµ° ì•„ì´ì½˜ êµ¬ë¶„ í‘œì‹œ
        var typeIcon = n.isAI ? "ğŸ¤–" : "ğŸ‘®";
        body += (i + 1) + ". " + typeIcon + " " + n.name + " (ì„ ë°• Lv." + n.shipLevel + ")\n";
    });

    body += "\n0. í˜¸ìœ„ ì—†ì´ ë‹¨ë… ì¶œí•­\n" +
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
            "ğŸ’¡ [ê°€ì´ë“œ]: ê³ ìš©í•  í•´êµ°ì˜ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.\n" +
            "[0] ì…ë ¥ ì‹œ ì¦‰ì‹œ ì¶œí•­í•©ë‹ˆë‹¤.";

    // ì„¸ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸ (í˜¸ìœ„ ê³ ìš© ëŒ€ê¸°)
    state.type = 'trade_escort_confirm';
    state.extra = { navyList: navyList, totalTax: totalTax };
    state.time = Date.now();

    replier.reply(formatCommand("ğŸ›¡ï¸ í˜¸ìœ„ í•´êµ° ì„ íƒ", user, body));
}

/* [ìƒì¸] í˜¸ìœ„ í•´êµ° ì„ íƒ í™•ì • ë° ì¶œí•­ ì²˜ë¦¬ (ìˆ«ì ì…ë ¥ í•¸ë“¤ëŸ¬) */
function _handleEscortConfirm(msg, user, data, replier, roomName, targetUid, cfg) {
    var roomData = data.rooms[roomName];
    var state = roomData.features.states.menuWait[targetUid];
    var choice = parseInt(msg.replace(/[^0-9]/g, ""));

    if (isNaN(choice) || choice < 0 || choice > state.extra.navyList.length) {
        return replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "0~" + state.extra.navyList.length + "ë²ˆ ì‚¬ì´ë¥¼ ì„ íƒí•˜ì„¸ìš”."));
    }

    // 0ë²ˆ ì„ íƒ ì‹œ ë‹¨ë… ì¶œí•­
    if (choice === 0) {
        _departVoyage(user, data, replier, roomName, state.dest, cfg, state.selCargo, state.selSpec);
        delete roomData.features.states.menuWait[targetUid];
        return;
    }

    // í•´êµ° ì„ íƒ ë° ë³´í˜¸ì„¸ ì§€ë¶ˆ
    var selectedNavy = state.extra.navyList[choice - 1];
    var tax = state.extra.totalTax;

    if (user.point < tax) {
        return replier.reply(formatError(user, "ìê¸ˆ ë¶€ì¡±", "ë³´í˜¸ì„¸(" + fp(tax) + "P)ê°€ ë¶€ì¡±í•˜ì—¬ ê³ ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
    }

    user.skipHealing = true;
    util_updatePoint(user, roomData, -tax, "í•´êµ° í˜¸ìœ„ ë³´í˜¸ì„¸ ì§€ë¶ˆ", roomName);

    // ì¶œí•­ ì‹œì‘ (í˜¸ìœ„ ì •ë³´ í¬í•¨)
    _departVoyage(user, data, replier, roomName, state.dest, cfg, state.selCargo, state.selSpec, selectedNavy.uid, tax);
    
    if (!selectedNavy.isAI) {
        try {
            var navyTarget = null;
            // ì „ ì„œë²„ ë°©ì„ ë’¤ì ¸ì„œ í•´ë‹¹ í•´êµ° ìœ ì €ì™€ ë°© ì´ë¦„ì„ ì°¾ìŒ
            for (var rN in data.rooms) {
                if (data.rooms[rN].users && data.rooms[rN].users[selectedNavy.uid]) {
                    navyTarget = { data: data.rooms[rN].users[selectedNavy.uid], roomName: rN };
                    break;
                }
            }
        } catch(e) { Log.error("Navy Notify Error: " + e); }
    } else {
        replier.reply("ğŸ¤– [AI í•¨ëŒ€ í†µì‹ ]\n\"ì¤‘ì•™ ì •ë¶€ì˜ ëª…ì— ë”°ë¼ ê·€í•˜ì˜ ì„ ë‹¨ì„ ë³´í˜¸í•˜ê² ìŠµë‹ˆë‹¤.\"");
    }

    delete roomData.features.states.menuWait[targetUid];
    safeSaveData(data, true);
}

/* [í•´ì ] ì•½íƒˆ ê°€ëŠ¥í•œ í•­í•´ ì¤‘ì¸ ìœ ì € ë¦¬ìŠ¤íŠ¸ ì¶œë ¥ */
function _showRaidList(user, replier, data, roomName, targetUid) {
    var sailingUsers = [];
    var now = Date.now();
    var mainRoom = data.rooms["ë‚´ë¦¬ë‹¤"];
    var currentPillages = mainRoom.features.activePillages || {};

    var stateRes = util_checkUserState(user, targetUid, roomName, true);
    if (!stateRes.canAction) return replier.reply(formatError(user, "íƒìƒ‰ ë¶ˆê°€", stateRes.reason));

    // 1. ì‹¤ì œ ìœ ì € íƒìƒ‰ (ê¸°ì¡´ ë¡œì§)
    for (var r in data.rooms) {
        var roomObj = data.rooms[r];
        for (var uid in roomObj.users) {
            var u = roomObj.users[uid];
            var isSailing = (u.voyage && u.voyage.active === true);

            /* [ì¶”ê°€] v16.7 ì—˜ë„ë¼ë„ ìŠ¤í…”ìŠ¤ ëª¨ë“œ: ê³ ëŒ€ í•­ë¡œë¥¼ ì´ìš© ì¤‘ì¸ ì„ ë°•ì€ í•´ì  ë ˆì´ë”ì— ì¡íˆì§€ ì•ŠìŠµë‹ˆë‹¤. */
            if (isSailing && u.voyage.dest === ELDORADO_CONFIG.NAME) continue;

            var hasEnoughTime = isSailing && (u.voyage.arrival - now >= 180000);
            var alreadyTargeted = (u.isPillaged === true || (u.voyage && u.voyage.isPillaged === true));
            var isUnderAttack = (currentPillages && currentPillages[uid]); 

            if (hasEnoughTime && !alreadyTargeted && !isUnderAttack && uid !== targetUid) {
                sailingUsers.push({ uid: uid, data: u, roomName: r, isAI: false });
            }
        }
    }

    // ìœ ì € ìƒì¸ì´ 5ëª… ë¯¸ë§Œì¼ ê²½ìš° ë¶€ì¡±í•œ ë§Œí¼ AI ìƒì¸(ìœ ë ¹ ìƒë‹¨) ìƒì„±
    if (sailingUsers.length < 5) {
        var aiNames = ["ë™ë°©ë¬´ì—­ì„ ", "ì„œë°©ì—°í•©í•¨ëŒ€", "ì œêµ­ ìš´ì†¡ì„ ", "í™©ê¸ˆë„ì‹œ ìƒë‹¨", "ë¶í•´ ë¬´ì—­í˜‘íšŒ"];
        var aiDests = ["í¬ë¥´íˆ¬", "ì½”ì½œë¼", "ë‚˜í´ë¦¬", "ë² ë¼í¬ë£¨ìŠ¤", "í‚´ë²Œë¦¬"];
        
        // ì´ë¦„ ëª©ë¡ì„ ë¬´ì‘ìœ„ë¡œ ì„ìŒ (ì¤‘ë³µ ë°©ì§€ ì…”í”Œ)
        aiNames.sort(function() { return Math.random() - 0.5; });

        var needed = 5 - sailingUsers.length;
        for (var i = 0; i < needed; i++) {
            // ì…”í”Œëœ ëª©ë¡ì—ì„œ ìˆœì„œëŒ€ë¡œ ì´ë¦„ì„ ê°€ì ¸ì˜´ (ì´ë¦„ë‹¹ ë”± 1ê°œì”©ë§Œ ìƒì„±ë¨)
            var uniqueName = aiNames[i]; 
            if (!uniqueName) break; // ì´ë¦„ì´ ëª¨ìë¼ë©´ ì¤‘ë‹¨

            var randDest = aiDests[Math.floor(Math.random() * aiDests.length)];
            // [ì´ˆë¯¸ì„¸ ê°€ì¤‘ì¹˜] ê° ë ˆë²¨ ê°„ í™•ë¥  ì°¨ì´ë¥¼ ìµœì†Œí™”í•œ ì´˜ì´˜í•œ ë¶„í¬
            var r = Math.random() * 100;
            var randLevel = 1;

            if (r < 14) randLevel = 1;       // 14%
            else if (r < 27) randLevel = 2;  // 13%
            else if (r < 39) randLevel = 3;  // 12%
            else if (r < 50) randLevel = 4;  // 11%
            else if (r < 60) randLevel = 5;  // 10%
            else if (r < 69) randLevel = 6;  // 9%
            else if (r < 77) randLevel = 7;  // 8%
            else if (r < 85) randLevel = 8;  // 8%
            else if (r < 93) randLevel = 9;  // 8%
            else randLevel = 10;             // 7%

            var hasAIescort = true; 

            sailingUsers.push({
                uid: "AI_BOT_" + i,
                isAI: true,
                data: {
                    name: "ğŸš¢ " + uniqueName,
                    shipLevel: randLevel,
                    voyage: {
                        dest: randDest,
                        arrival: now + ((Math.floor(Math.random() * 20) + 10) * 60000),
                        escortUid: "AI_NAVY_ELITE" 
                    }
                },
                roomName: "ë‚´ë¦¬ë‹¤"
            });
        }
    }

    // [ì •ë ¬]: ë‚¨ì€ ì‹œê°„ì´ ë§ì´ ë‚¨ì€ ìˆœ(ë„ì°© ì‹œê°„ì´ ëŠ¦ì€ ìˆœ)ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
    sailingUsers.sort(function(a, b) {
        // ìœ ì €(false)ê°€ AI(true)ë³´ë‹¤ ì•ì— ì˜¤ë„ë¡ ì •ë ¬
        if (a.isAI !== b.isAI) return a.isAI ? 1 : -1;
        // ë‚¨ì€ ì‹œê°„ì´ ì ì€(ë„ì°© ì˜ˆì • ì‹œê°„ì´ ë¹ ë¥¸) ìœ ì €ê°€ ìƒë‹¨ì— ì˜¤ë„ë¡ ì •ë ¬
        return a.data.voyage.arrival - b.data.voyage.arrival;
    });

    var listBody = "ğŸ”­ ë ˆì´ë”ì— í¬ì°©ëœ ë¬´ì—­ì„  ëª©ë¡ì…ë‹ˆë‹¤.\n\n";
    sailingUsers.forEach(function(target, i) {
        var v = target.data.voyage;
        var ship = SYSTEM_CONFIG.TRADE.SHIPS[target.data.shipLevel || 1];
        var protectedMark = v.escortUid ? "ğŸ›¡ï¸ [í˜¸ìœ„í•¨ ë™í–‰]" : "âšª [ë¬´ë°©ë¹„]";
        var remainMs = v.arrival - now;
        var timeStr = Math.floor(remainMs / 60000) + "ë¶„ " + Math.floor((remainMs % 60000) / 1000) + "ì´ˆ";

        listBody += (i + 1) + ". " + target.data.name + " (" + ship.name + ")\n" +
                    "    ğŸ“ ëª©ì ì§€: " + v.dest + " | " + protectedMark + "\n" +
                    "    â³ ë‚¨ì€ì‹œê°„: " + timeStr + "\n";
    });

    listBody += "\n" + "â†©ï¸ ë’¤ë¡œ / ğŸ  ì²˜ìŒìœ¼ë¡œ / âì·¨ì†Œ";
    
    // [ë³´ì •]: 1:1ë°© ìˆ«ì ì¸ì‹ì„ ìœ„í•´ í˜„ì¬ ì±„íŒ…ë°©(roomName)ì— ì„¸ì…˜ ì§ì ‘ ì €ì¥
    if (!data.rooms[roomName].features.states.menuWait) data.rooms[roomName].features.states.menuWait = {};
    data.rooms[roomName].features.states.menuWait[targetUid] = { 
        type: 'trade_raid_list', 
        time: now, 
        originRoom: roomName,
        extra: { targets: sailingUsers } 
    };

    replier.reply(formatCommand("ğŸ´â€â˜ ï¸ ì•½íƒˆ ëŒ€ìƒ ë¬¼ìƒ‰", user, listBody, "ì•½íƒˆí•  ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
}

// ìˆ˜ì •: í˜„ì¬ ë°©ì˜ menuWaitë¥¼ ì°¸ì¡°í•˜ë„ë¡ í•¸ë“¤ëŸ¬ ë³´ì •
function _handlePillageSelect(choice, user, data, replier, roomName, targetUid) {
    var roomData = data.rooms[roomName];
    if (!roomData || !roomData.features || !roomData.features.states.menuWait[targetUid]) return;

    var stateRes = util_checkUserState(user, targetUid, roomName, true);
    if (!stateRes.canAction) return replier.reply(formatError(user, "ìŠµê²© ë¶ˆê°€", stateRes.reason));

    var state = roomData.features.states.menuWait[targetUid];
    var idx = parseInt(choice) - 1;

    if (isNaN(idx) || idx < 0 || idx >= state.extra.targets.length) {
        return replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "ëª©ë¡ì— ìˆëŠ” ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”."));
    }

    var target = state.extra.targets[idx];
    var victim = target.data;
    var vId = target.uid;

    if (target.isAI) {
        // [í•µì‹¬] í˜¸ìœ„í•¨ ì¡´ì¬ ì—¬ë¶€ì— ë”°ë¥¸ ë¶„ê¸° ì²˜ë¦¬
        if (victim.voyage && victim.voyage.escortUid) {
            replier.reply("ğŸ›¡ï¸ [ê²½ë³´]\nìŠµê²©í•œ '" + victim.name + "'ì€(ëŠ”) AI ìƒë‹¨ì…ë‹ˆë‹¤!\ní˜¸ìœ„ ì¤‘ì¸ 'AI í•´êµ°' í•¨ëŒ€ì™€ ì¦‰ì‹œ êµì „ì´ ì‹œì‘ë©ë‹ˆë‹¤!");
            _executeSeaCombat(user, vId, "AI_NAVY_ELITE", data, roomName, "AI_COMBAT");
        } else {
            replier.reply("ğŸ“¦ [ìŠµê²© ì„±ê³µ]\nìŠµê²©í•œ '" + victim.name + "'ì€(ëŠ”) í˜¸ìœ„í•¨ì´ ì—†ëŠ” ë¬´ë°©ë¹„ ìƒíƒœì˜€ìŠµë‹ˆë‹¤!\nì¦‰ì‹œ í™”ë¬¼ì„ ì•½íƒˆí•˜ê³  ìì·¨ë¥¼ ê°ì¶¥ë‹ˆë‹¤.");
            if (typeof _processPillageSuccess === 'function') {
                _processPillageSuccess(vId, { pirateUid: targetUid, victimName: victim.name }, data, roomName);
            }
        }
        delete roomData.features.states.menuWait[targetUid];
        safeSaveData(data, true);
        return; // AI ë¡œì§ ì¢…ë£Œ
    }

    // ì„ íƒ ì‹œì ì— ëŒ€ìƒ ìœ ì €ì˜ ìµœì‹  ë°ì´í„°ë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ì—¬ ì´ë¯¸ í„¸ë¦° ìœ ì €ì¸ì§€ 2ì°¨ ê²€ì¦
    if (victim.isPillaged === true || (victim.voyage && victim.voyage.isPillaged === true)) {
        replier.reply(formatError(user, "ìŠµê²© ì‹¤íŒ¨", "ì´ë¯¸ ë‹¤ë¥¸ í•´ì ì—ê²Œ ì•½íƒˆë‹¹í–ˆê±°ë‚˜ ì •ì‚°ì´ ì™„ë£Œëœ ì„ ë°•ì…ë‹ˆë‹¤."));
        return;
    }

    // ì¤‘ë³µ í™•ì¸ (ì„ ì  ê°€ë“œ: í˜„ì¬ ê³µê²© ì§„í–‰ ì¤‘ì¸ì§€ í™•ì¸)
    var mainRoom = data.rooms["ë‚´ë¦¬ë‹¤"];
    if (!mainRoom.features.activePillages) mainRoom.features.activePillages = {};

    if (mainRoom.features.activePillages[vId]) {
        replier.reply(formatError(user, "ìŠµê²© ì‹¤íŒ¨", "ì´ë¯¸ ë‹¤ë¥¸ í•´ì ì´ ê³µê²© ì¤‘ì¸ ì„ ë°•ì…ë‹ˆë‹¤."));
        return;
    }

    if (victim.job === 'navy') {
        // 1ìˆœìœ„: ì•½íƒˆ ëŒ€ìƒ(A)ì´ í•´êµ°ì¸ ê²½ìš° -> ì¦‰ì‹œ ìë™ í† ë²Œ ì§„í–‰
        replier.reply("ğŸ“¡ [ìœ„ê¸° ë°œìƒ]\nì´ëŸ°! ë‹¹ì‹ ì´ ìŠµê²©í•œ ìƒì¸ '" + victim.name + "'ë‹˜ì€ ìœ„ì¥ ë¬´ì—­ ì¤‘ì´ë˜ 'í•´êµ°'ì´ì—ˆìŠµë‹ˆë‹¤!\nì¦‰ì‹œ í•´ìƒ êµì „ì´ ì‹œì‘ë©ë‹ˆë‹¤!");
        
        // ì „íˆ¬ ì‹¤í–‰: í•´ì (user) vs í•´êµ°ìƒì¸(victim)
        // modeë¥¼ "ESCORT"ë¡œ ì „ë‹¬í•˜ë©´ victimì´ í•´êµ°ì¸¡ìœ¼ë¡œ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.
        _executeSeaCombat(user, vId, vId, data, roomName, "ESCORT");
    } 
    else if (victim.voyage.escortUid) {
        // 2ìˆœìœ„: ëŒ€ìƒì€ ì¼ë°˜ì¸ì´ì§€ë§Œ ê³ ìš©ëœ í˜¸ìœ„ í•´êµ°ì´ ìˆëŠ” ê²½ìš°
        replier.reply("ğŸ›¡ï¸ [ê²½ë³´] ìŠµê²©í•œ ì„ ë°•ì— ì „ìš© í˜¸ìœ„í•¨ì´ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤!\nì¦‰ì‹œ í•´ì „ì´ ì‹œì‘ë©ë‹ˆë‹¤!");
        _executeSeaCombat(user, vId, victim.voyage.escortUid, data, roomName, "ESCORT");
    } 
    else {
        // 3ìˆœìœ„: ëŒ€ìƒì´ ì¼ë°˜ì¸ì´ê³  í˜¸ìœ„ë„ ì—†ëŠ” ê²½ìš° -> ì •ìƒ ì•½íƒˆ ì„¸ì…˜(3ë¶„) ì§„ì…
        mainRoom.features.activePillages[vId] = {
            pirateUid: targetUid,
            pirateName: user.name,
            startTime: Date.now(),
            room: target.roomName
        };

        var alertMsg = "ğŸš¨ [í•´ìƒ ê¸´ê¸‰ íƒ€ì „]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                       "ğŸ´â€â˜ ï¸ í•´ì  '" + user.name + "'(ì´)ê°€\n" +
                       "ğŸ“¦ '" + victim.name + "'ë‹˜ì˜ ì„ ë°•ì„ ìŠµê²©í–ˆìŠµë‹ˆë‹¤!\n\n" +
                       "âš ï¸ ì•½íƒˆ ì™„ë£Œê¹Œì§€: 3ë¶„\n" +
                       "âš”ï¸ í•´êµ° ë³¸ë¶€ëŠ” ì¦‰ì‹œ í† ë²ŒëŒ€ë¥¼ íŒŒê²¬í•˜ì‹­ì‹œì˜¤!";
        
        Api.replyRoom("ë‚´ë¦¬ë‹¤", alertMsg);
    }
    
    delete roomData.features.states.menuWait[targetUid];
    safeSaveData(data, true);
}

/* [í•´êµ°] í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì•½íƒˆ ëª©ë¡ ì¡°íšŒ (í† ë²Œ ê²Œì‹œíŒ) */
function _showBattleList(user, replier, roomData, targetUid, roomName) {
    // [ê°€ë“œ] í•´êµ° í™œë™ ê°€ëŠ¥ ìƒíƒœ ê²€ì¦ (í‡´ê°/ì§•ì—­/ì±„êµ´ ë“±)
    var stateRes = util_checkUserState(user, targetUid, roomName, true);
    if (!stateRes.canAction) return replier.reply(formatError(user, "ì¶œë™ ë¶ˆê°€", stateRes.reason));

    var mainRoom = globalData.rooms["ë‚´ë¦¬ë‹¤"];
    var pillages = mainRoom.features.activePillages || {};
    var pKeys = Object.keys(pillages);

    var availablePillageKeys = pKeys.filter(function(k) {
        var p = pillages[k];
        return p.isBattled !== true && p.isProcessing !== true;
    });

    if (availablePillageKeys.length === 0) {
        if (roomData.features.states.menuWait && roomData.features.states.menuWait[targetUid]) {
            delete roomData.features.states.menuWait[targetUid];
        }
        return replier.reply(formatSimple("âš”ï¸ í† ë²Œ ê²Œì‹œíŒ", "í˜„ì¬ ë³´ê³ ëœ í•´ì  ìŠµê²© ì‚¬ê±´ì´ ì—†ê±°ë‚˜\nì´ë¯¸ ëª¨ë“  í•¨ëŒ€ê°€ êµì „ ì¤‘ì…ë‹ˆë‹¤.", "í‰í™”ë¡œìš´ ë°”ë‹¤ì…ë‹ˆë‹¤."));
    }

    var body = "ğŸš¨ í˜„ì¬ í˜„ìƒìˆ˜ë°° ì¤‘ì¸ í•´ì  ìŠµê²© í˜„í™©ì…ë‹ˆë‹¤.\n\n";
    var currentPillages = [];

    availablePillageKeys.forEach(function(vId, i) {
        var p = pillages[vId];
        var remainSec = Math.ceil((180000 - (Date.now() - p.startTime)) / 1000);
        if (remainSec < 0) return;

        body += (i + 1) + ". ğŸ´â€â˜ ï¸ " + p.pirateName + " â” ğŸ“¦ " + (globalData.rooms[p.room].users[vId].name) + "\n" +
                "   â³ ë‚¨ì€ ì‹œê°„: " + remainSec + "ì´ˆ\n";
        currentPillages.push({ victimUid: vId, pirateUid: p.pirateUid });
    });

    body += "\n" + "â†©ï¸ ë’¤ë¡œ / ğŸ  ì²˜ìŒìœ¼ë¡œ / âì·¨ì†Œ";
    
    if (!roomData.features.states.menuWait) roomData.features.states.menuWait = {};
    roomData.features.states.menuWait[targetUid] = { 
        type: 'trade_battle_list', 
        time: Date.now(), 
        originRoom: roomName,
        extra: { pillages: currentPillages } 
    };

    replier.reply(formatCommand("ğŸ‘® í† ë²Œ ì‘ì „ ê²Œì‹œíŒ", user, body, "ê°œì…í•  ì‚¬ê±´ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
}

/* [í•´êµ°] í† ë²Œ ë²ˆí˜¸ ì„ íƒ ë° ì „íˆ¬ ì‹¤í–‰ */
function _handleCombatSelect(choice, user, data, replier, roomName, targetUid) {
    var stateRes = util_checkUserState(user, targetUid, roomName, true); 
    if (!stateRes.canAction) return replier.reply(formatError(user, "ì „íˆ¬ ë¶ˆê°€", stateRes.reason));
    var roomData = data.rooms[roomName];
    var state = roomData.features.states.menuWait[targetUid];
    var idx = parseInt(choice) - 1;

    if (isNaN(idx) || idx < 0 || idx >= state.extra.pillages.length) {
        return replier.reply(formatError(user, "ë²ˆí˜¸ ì˜¤ë¥˜", "ëª©ë¡ì— ìˆëŠ” ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”."));
    }

    var targetPillage = state.extra.pillages[idx];
    
    // ì „íˆ¬ ì‹¤í–‰ (í•´êµ° ê°œì… ëª¨ë“œ)
    _executeSeaCombat(user, targetPillage.victimUid, targetUid, data, roomName, "INTERVENE");
    
    delete roomData.features.states.menuWait[targetUid];
}

/* [í•µì‹¬ ì—”ì§„] í•´ìƒì „íˆ¬ ì§‘í–‰ (Navy vs Pirate) */
function _executeSeaCombat(navyOrPirate, victimUid, navyUid, data, roomName, mode) {
    var mainRoom = data.rooms["ë‚´ë¦¬ë‹¤"];
    var session = (mainRoom.features && mainRoom.features.activePillages) ? mainRoom.features.activePillages[victimUid] : null;
    
    // [ë³´ì •] victim ê°ì²´ ì‹ë³„ ë¡œì§ (ì°¸ì¡° ì˜¤ë¥˜ í•´ê²° í•µì‹¬)
    var victim = null;
    if (victimUid && victimUid.indexOf("AI_BOT_") === -1) { // ìœ ì € ìƒì¸ì¸ ê²½ìš°ì—ë§Œ ê²€ìƒ‰
        for (var r in data.rooms) { 
            if (data.rooms[r].users && data.rooms[r].users[victimUid]) { 
                victim = data.rooms[r].users[victimUid]; 
                break; 
            } 
        }
    }

    if (typeof util_scrubNativeObject === 'function') {
        util_scrubNativeObject(navyOrPirate);
        if (session) util_scrubNativeObject(session);
        if (victim) util_scrubNativeObject(victim);
    }

    var cfg = SYSTEM_CONFIG.TRADE.JOBS;

    if (mode === "INTERVENE") {
        if (!session || session.isBattled === true) {
            try { Api.replyRoom(roomName, "ğŸ“¡ [êµì „ ë¶ˆê°€] ì´ë¯¸ ë‹¤ë¥¸ í•¨ëŒ€ê°€ êµì „ ì¤‘ì…ë‹ˆë‹¤."); } catch(e) {}
            return;
        }
        session.isBattled = true; 
    }

   // [êµì •] navyUid ê°€ë“œ ë° AI í•´êµ°/ì „íˆ¬ íŒë³„ (ê³ ìš©ëœ AI ë˜ëŠ” AI ìƒë‹¨ í˜¸ìœ„ë³‘ í†µí•© ì¸ì‹)
    var isAINavy = (navyUid && typeof navyUid === 'string' && (navyUid.indexOf("AI_NAVY_") === 0 || navyUid.indexOf("AI_BOT_") === 0));
    var isAICombat = (mode === "AI_COMBAT");

    var pirate = (mode === "ESCORT" || isAICombat) ? navyOrPirate : null;
    var navy = (mode === "INTERVENE") ? navyOrPirate : null;
    
    if (!isAICombat) {
        if (!pirate) {
            var pId = session ? session.pirateUid : null;
            if (!pId) return;
            for (var r in data.rooms) { if (data.rooms[r].users[pId]) { pirate = data.rooms[r].users[pId]; break; } }
        }
        // AI í•´êµ°ì´ ì•„ë‹ ë•Œë§Œ ìœ ì € DBì—ì„œ navy ê°ì²´ë¥¼ ì°¾ìŒ (invalid ë°©ì§€)
        if (!navy && !isAINavy) {
            // targetUidê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ navyUidë¥¼ ìš°ì„  ì°¸ì¡°
            var nSearchId = navyUid || (session ? session.escortUid : null);
            for (var r in data.rooms) { if (data.rooms[r].users[nSearchId]) { navy = data.rooms[r].users[nSearchId]; break; } }
        }
    }

    // í•„ìˆ˜ ê°ì²´ ê²€ì¦ ê°€ë“œ (pirateëŠ” í•„ìˆ˜, í•´êµ°ì€ ìœ ì € í•´êµ°ì¼ ë•Œë§Œ í•„ìˆ˜)
    if (!pirate || (!isAICombat && !isAINavy && !navy)) return;

    // [ì•ˆì „ ê°€ë“œ] ì´ë¦„ ì¶”ì¶œ ì‹œ null ì°¸ì¡° ì˜¤ë¥˜ ì›ì²œ ì°¨ë‹¨
    var nName = "AI ì—°í•©í•¨ëŒ€";
    if (!isAINavy && !isAICombat && navy) nName = navy.name;
    else if (isAICombat) nName = "AI ì—˜ë¦¬íŠ¸ í•´êµ°";

    var pName = (pirate) ? pirate.name : "ì •ì²´ë¶ˆëª…ì˜ í•´ì ";

    // [ë°˜ì˜] AI í•´êµ°ì˜ ë ˆë²¨ íŒì • ë¡œì§
    var nShip = 1;
    if (isAICombat) {
        // AI ìƒë‹¨ì„ ì§€í‚¤ëŠ” ì—˜ë¦¬íŠ¸ í•´êµ°ì€ í•´ì  ë ˆë²¨ì— ë§ì¶° ê°•í•´ì§ (ìµœì†Œ 7, ìµœëŒ€ 10)
        nShip = Math.max(7, Math.min(10, (pirate.shipLevel || 1) + 1));
    } else if (isAINavy) {
        // ìƒì¸ì´ ê³ ìš©í•œ AI í•¨ëŒ€ (ê¸°ë³¸ 5, ì„ ë°• ë ˆë²¨ì— ë”°ë¼ ë³´ì • ê°€ëŠ¥)
        nShip = (navyOrPirate.voyage && navyOrPirate.voyage.escortLevel) ? navyOrPirate.voyage.escortLevel : 7;
    } else {
        // ìœ ì € í•´êµ° ë ˆë²¨
        nShip = navy ? (navy.shipLevel || 1) : 1;
    }

    var pShip = pirate.shipLevel || 1;

    // AI í•´êµ° ë ˆë²¨ íŒì • (ê³ ì • ìˆ˜ì¹˜ê°€ ì•„ë‹Œ ìƒì„±ëœ ìŠ¤ëƒ…ìƒ· ë ˆë²¨ ì‚¬ìš©)
    var nShip = 1;
    if (isAICombat) {
        // AI ìƒë‹¨ ìŠµê²© ì‹œ: ë¯¸ë¦¬ ìƒì„±ë˜ì–´ voyageì— ì €ì¥ëœ í˜¸ìœ„ ë ˆë²¨ì„ ê°€ì ¸ì˜´
        nShip = (victim && victim.voyage && victim.voyage.escortLevel) ? victim.voyage.escortLevel : 5;
    } else if (isAINavy) {
        // ìœ ì € ìƒì¸ì´ ê³ ìš©í•œ AI í•¨ëŒ€: ì¶œí•­ ì‹œ ì €ì¥ëœ escortLevel ì‚¬ìš©
        nShip = (navyOrPirate.voyage && navyOrPirate.voyage.escortLevel) ? navyOrPirate.voyage.escortLevel : 5;
    } else {
        // ìœ ì € í•´êµ°
        nShip = navy ? (navy.shipLevel || 1) : 1;
    }
    
    // [ìˆ˜ì •] ìŠ¹ë¥  ê³µì‹ ë³´ì •: í•´êµ° ê¸°ë³¸ 52% (í•´ì  48%) + ë ˆë²¨ë‹¹ 5% ì°¨ì´
    var winChance = 52 + (nShip - pShip) * 5;
    
    // [ìˆ˜ì •] AI í•´êµ° ì¶”ê°€ ìŠ¹ë¥  ë³´ë„ˆìŠ¤ ì œê±° (ìœ ì €ì™€ ë™ë“± ì¡°ê±´)
    // if (isAICombat) winChance += 5; <--- ì‚­ì œë¨

    // [ì‹ ê·œ] ìœ ì € í•´êµ° ëª…ì„± ë³´ë„ˆìŠ¤ (ëª…ì„± 100ë‹¹ +1%)
    if (!isAINavy && !isAICombat && navy) {
        var fameBonus = Math.floor((navy.fame || 0) / 100);
        winChance += fameBonus;
    }

    winChance = Math.max(15, Math.min(95, winChance)); // ìµœì†Œ 15% ~ ìµœëŒ€ 95% ìº¡ (ëª…ì„± ê³ ë ¤ ìƒí•œ ì†Œí­ ìƒí–¥)
    
    var isNavyWin = (Math.random() * 100 < winChance);

    var resultMsg = "âš”ï¸ [í•´ìƒ êµì „ ê²°ê³¼ ë³´ê³ ]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                    "ğŸ‘® í•´êµ°: " + (isAINavy ? "AI ì—°í•©í•¨ëŒ€" : (isAICombat ? "AI ì—˜ë¦¬íŠ¸ í•´êµ°" : navy.name)) + " (Lv." + nShip + ")\n" + 
                    "ğŸ´â€â˜ ï¸ í•´ì : " + pirate.name + " (Lv." + pShip + ")\n\n";

    if (isNavyWin) {
        var piratePenaltyMs = cfg.PIRATE.jailTime || 3600000;
        pirate.pillageCooldownEndTime = Date.now() + piratePenaltyMs;
        pirate.infamy = Math.max(0, (pirate.infamy || 0) - 20);
        
        var baseReward = Math.floor(cfg.PIRATE.bountyBase * 0.3);
        var bounty = baseReward + (Number(pirate.currentBounty) || 0);
        pirate.currentBounty = Number(cfg.PIRATE.bountyBase);

        // [ë¶„ë°°] ê³ ìš©ëœ AI í•´êµ° ìŠ¹ë¦¬ ì‹œì—ë„ í˜„ì¬ ë°©ì˜ ìœ ì € í•´êµ°ë“¤ì—ê²Œ í˜„ìƒê¸ˆ ê· ë“± ë¶„ë°°
       if (isAINavy || isAICombat) {
            var localNavies = [];
            var totalNavyLevels = 0;
            var targetRoomObj = data.rooms[roomName];
            
            if (targetRoomObj && targetRoomObj.users) {
                for (var uId in targetRoomObj.users) {
                    var u = targetRoomObj.users[uId];
                    if (u.job === 'navy') {
                        localNavies.push(u);
                        totalNavyLevels += (u.shipLevel || 1);
                    }
                }
            }

            if (localNavies.length > 0) {
                localNavies.forEach(function(n) { 
                    var weight = (n.shipLevel || 1) / totalNavyLevels;
                    var myShare = Math.floor(bounty * weight);
                    n.claimableReward = (Number(n.claimableReward) || 0) + myShare; 
                    n.hasNotifiedReward = false;
                });
                resultMsg += "ğŸŠ [AI í•´êµ° ìŠ¹ë³´] í˜„ìƒê¸ˆ " + fp(bounty) + "Pë¥¼ í™•ë³´í–ˆìŠµë‹ˆë‹¤!\n" +
                             "ğŸ’° ì§€ë¶„ ë°°ë¶„: í•¨ì„  ì²´ê¸‰(Lv)ì— ë¹„ë¡€í•˜ì—¬ ì •ì‚°ì†Œë¡œ ì…ê³ ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n";
            }
        } else {
            navy.fame = (navy.fame || 0) + 10;
            navy.claimableReward = (Number(navy.claimableReward) || 0) + bounty;
            navy.hasNotifiedReward = false;
            navy.totalCaptureSuccess = (navy.totalCaptureSuccess || 0) + 1;
            util_checkNavyTitle(navy, null, "ë‚´ë¦¬ë‹¤");
            resultMsg += "ğŸ’° " + navy.name + ": í˜„ìƒê¸ˆ " + fp(bounty) + "P íšë“\n";
        }

        if (!isAICombat && victim && victim.voyage) {
            victim.voyage.escortUid = null; // í•´êµ°ì€ ì¦‰ì‹œ ììœ  ì‹ ë¶„ (ê³ ìš© ê°€ëŠ¥)
            victim.voyage.escortFee = 0;
            victim.isPillaged = true; // [ìƒì¸ ë³´í˜¸] í•œë²ˆ ì‹œë„ëœ ì„ ë°•ì€ ì•½íƒˆ ê°€ëŠ¥ ëª©ë¡ì—ì„œ ì œì™¸
            if (victim.voyage) victim.voyage.isPillaged = true;
            resultMsg += "ğŸ›¡ï¸ [ì„ë¬´ ì™„ë£Œ]: í•´ì ì„ ê²©í‡´í–ˆìŠµë‹ˆë‹¤. í•´ë‹¹ ìƒì„ ì€ ë³´í˜¸ í”„ë¡œí† ì½œì— ë”°ë¼ ë” ì´ìƒ ìŠµê²©ë°›ì§€ ì•ŠìŠµë‹ˆë‹¤.\n";
        }

        if (session) delete mainRoom.features.activePillages[victimUid];
        resultMsg += "ğŸ”¥ [í•´êµ° ìŠ¹ë¦¬] í•´ì ì„ ì´ ë‚˜í¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n" +
                     "âš“ " + pirate.name + ": ì•½íƒˆ ê¸ˆì§€ " + Math.floor(piratePenaltyMs / 60000) + "ë¶„ ë¶€ê³¼\n" +
                     ((isAICombat || isAINavy) ? "" : "ğŸ’° " + navy.name + ": í˜„ìƒê¸ˆ " + fp(bounty) + "P íšë“");
        } else {
        // í•´ì  ìŠ¹ë¦¬ (í•´êµ° íŒ¨ë°°) ë¡œì§ ì‹œì‘
        
        // 1. [êµì •] ìŠµê²© ëŒ€ìƒì´ AIì¸ì§€ ì—¬ë¶€ ì„ í–‰ íŒë³„ (ìœ ë ¹ ìƒë‹¨ ë° ê³ ìš©ëœ AI í•¨ëŒ€ í¬í•¨)
        var isVictimAI = (victimUid && victimUid.indexOf("AI_BOT_") === 0);

        // 2. [ì¦‰ì‹œ ì™„ë£Œ ë¶„ê¸°] AI ìƒë‹¨ ìŠµê²© ì‹œ 3ë¶„ ëŒ€ê¸° ì—†ì´ ë°”ë¡œ ì •ì‚°
        if (isAICombat || isVictimAI) {
            var ecoMult = util_getEcoMultiplier("ë‚´ë¦¬ë‹¤");
            var vMargin = (Math.floor(Math.random() * 100001) + 100000) * ecoMult;
            var pMin = cfg.PIRATE.pillageRateMin || 0.3;
            var pMax = cfg.PIRATE.pillageRateMax || 0.5;
            var pRate = pMin + (pMax - pMin) * (pShip - 1) / 9;
            var pAmt = Math.floor(vMargin * pRate);

            // ì •ì‚° í•¨ìˆ˜ í˜¸ì¶œ (ë°ì´í„°ë§Œ ì—…ë°ì´íŠ¸)
            if (typeof _processPillageSuccess === 'function') {
                var vName = victim ? victim.name : "ìœ ë ¹ ìƒë‹¨";
                _processPillageSuccess(victimUid, { pirateUid: pirate.uid, victimName: vName, forcedAmount: pAmt, forcedRate: pRate }, data, roomName);
            }
            
            // [í†µí•©] êµì „ ê²°ê³¼ ë³´ê³ ì„œì— í˜„ìƒê¸ˆ ì •ë³´ ì¶”ê°€
            resultMsg += "ğŸ´â€â˜ ï¸ [AI ìƒë‹¨ ì•½íƒˆ ì„±ê³µ]\n" +
                         "í•´ì  '" + pirate.name + "'ì´ ìœ ë ¹ ìƒë‹¨ì„ ì™„ë²½íˆ ì œì••í–ˆìŠµë‹ˆë‹¤!\n" +
                         "ğŸ’° ì´ë²ˆ ì•½íƒˆ ìˆ˜ìµ: +" + fp(pAmt) + "P (ì •ì‚° ëŒ€ê¸°)\n" +
                         "ğŸ“ˆ ì ìš© ì•½íƒˆë¥ : " + (pRate * 100).toFixed(1) + "%\n" +
                         "ğŸ’€ ëˆ„ì  í˜„ìƒê¸ˆ: " + fp(pirate.currentBounty) + "P ëŒíŒŒ!"; // <--- í˜„ìƒê¸ˆ ë¼ì¸ í†µí•©
        }
        // ì‹¤ì œ ìœ ì € ìƒë‹¨ ìŠµê²© ì‹œ
        else {
            var retreatMs = cfg.NAVY.retreatTime || 300000;
            var fameLoss = (mode === "INTERVENE") ? 20 : 10;
            var navyName = isAINavy ? "AI ì—°í•©í•¨ëŒ€" : (navy ? navy.name : "í•´êµ° í˜¸ìœ„í•¨");

            if (!isAINavy && navy) {
                navy.retreatEndTime = Date.now() + retreatMs;
                navy.fame = Math.max(0, (navy.fame || 0) - fameLoss);
            }

            pirate.infamy = (pirate.infamy || 0) + 5;

            resultMsg += "ğŸ’€ [í•´ì  ìŠ¹ë¦¬] " + navyName + "ê°€ íŒ¨í‡´í–ˆìŠµë‹ˆë‹¤!\n\n" +
                         (!isAINavy ? "ğŸ“‰ " + navyName + ": ëª…ì„± -" + fameLoss + "ì  í•˜ë½\n" : "") +
                         (!isAINavy ? "ğŸ©¹ " + navyName + ": " + Math.floor(retreatMs/60000) + "ë¶„ê°„ ì •ë¹„ ëŒì…\n" : "ğŸ“¡ AI í˜¸ìœ„í•¨ëŒ€ê°€ í‡´ê°í•˜ì—¬ ìƒì„ ì´ ë…¸ì¶œë˜ì—ˆìŠµë‹ˆë‹¤!\n") +
                         "âš ï¸ ì•½íƒˆì´ ê³„ì† ì§„í–‰ë©ë‹ˆë‹¤!";

            if (victim && victim.voyage) {
                victim.voyage.escortUid = null; // [2ë²ˆ] í˜¸ìœ„ í•´ì œ (í•´êµ°ì€ ììœ )
                
                // [1ë²ˆ] í•´ì ì´ ì´ê²¼ìœ¼ë¯€ë¡œ ì¦‰ì‹œ 'ì•½íƒˆ ì§„í–‰ ì¤‘' ìƒíƒœë¡œ ì „í™˜
                // ì´ ìƒíƒœê°€ ë˜ë©´ _showRaidList í•¨ìˆ˜ì—ì„œ ìë™ìœ¼ë¡œ ëª©ë¡ì—ì„œ ì œì™¸ë¨
                if (!mainRoom.features.activePillages) mainRoom.features.activePillages = {};
                
                // í•´ì  UID í™•ë³´
                var pUid = pirate.uid || (mode === "ESCORT" ? navyOrPirate.uid : null);
                
                if (pUid) {
                    mainRoom.features.activePillages[victimUid] = {
                        pirateUid: pUid,
                        pirateName: pirate.name,
                        startTime: Date.now(),
                        room: roomName,
                        isBattled: true // ì´ë¯¸ ì „íˆ¬í–ˆìœ¼ë¯€ë¡œ ì¶”ê°€ ì „íˆ¬ ë¶ˆê°€
                    };
                    resultMsg += "\nâ³ [ì•½íƒˆ ê°œì‹œ] ë°©ì–´ì„ ì´ ë¬´ë„ˆì ¸ ì¦‰ì‹œ ì•½íƒˆ(3ë¶„)ì´ ì§„í–‰ë©ë‹ˆë‹¤!";
                }
            }
        }
    }

    Api.replyRoom("ë‚´ë¦¬ë‹¤", resultMsg);
    safeSaveData(data, true);
}

function _showJobSettlementOffice(user, replier, roomName, targetUid) {
    var today = getSimpleDate();
    var multiplier = util_getEcoMultiplier(roomName);
    var isPirate = (user.job === 'pirate');
    
    // 1. ì¼ê¸‰ ê³„ì‚° (ë¯¸ìˆ˜ë ¹ ì‹œì—ë§Œ í‘œì‹œ)
    var dailyWage = 0;
    var wageBreakdown = "";
    var isWageAvailable = (isPirate ? user.lastPirateWageDate : user.lastNavyWageDate) !== today;

    if (isWageAvailable) {
        var base = 25000;
        var bonus = isPirate ? (Number(user.infamy || 0) * 100) : (Number(user.fame || 0) * 100);
        dailyWage = Math.floor((base + bonus) * multiplier);
        if (user.title === "í•´ì ì™•" || user.title === "ì œí•´ì™•") {
            dailyWage = Math.floor(dailyWage * 1.5);
            var kingTitle = user.title;
        }
        dailyWage = Math.min(100000, dailyWage);
        
        wageBreakdown = "  - ê¸°ë³¸ê¸‰: " + fp(base) + "P\n" +
                        "  - " + (isPirate ? "ì•…ëª…" : "ëª…ì„±") + "ìˆ˜ë‹¹: +" + fp(bonus) + "P\n" +
                        "  - ë¬¼ê°€ë³´ì •: x" + multiplier.toFixed(2) + "\n" +
                        "  â” ì¼ê¸‰ í•©ê³„: " + fp(dailyWage) + "P\n";
    }

    // 2. ëˆ„ì  ë³´ìƒê¸ˆ (í† ë²Œ/ì•½íƒˆ/í˜¸ì†¡)
    var accumulated = Number(user.claimableReward || 0);
    var totalAvailable = dailyWage + accumulated;

    var body = (isPirate ? "ğŸ´â€â˜ ï¸ ë‚˜ì†Œ ì¥ë¬¼ ì •ì‚°ì†Œ" : "ğŸ‘® í•´êµ° ë³¸ë¶€ íšŒê³„ì‹¤") + "\n\n" +
               "[ğŸ’° ì •ì‚° ê°€ëŠ¥ ë‚´ì—­]\n" +
               (isWageAvailable ? "ğŸ’µ ê¸ˆì¼ ê¸°ë³¸ ì¼ê¸‰:\n" + wageBreakdown : "âœ… ê¸ˆì¼ ì¼ê¸‰ ìˆ˜ë ¹ ì™„ë£Œ\n") +
               "\nğŸ“¦ ë¯¸ìˆ˜ë ¹ í™œë™ ë³´ìƒ: " + fp(accumulated) + "P\n" +
               "(í† ë²Œ/ì•½íƒˆ/í˜¸ì†¡ ìˆ˜ìµ í¬í•¨)\n" +
               "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
               "ğŸ’° ì´ ìˆ˜ë ¹ ê°€ëŠ¥ì•¡: " + fp(totalAvailable) + "P\n\n" +
               "ğŸ’¬ [ìˆ˜ë ¹ ë°©ë²•]\n" +
               "â€¢ ë¶€ë¶„ ìˆ˜ë ¹: [ê¸ˆì•¡] ì…ë ¥\n" +
               "â€¢ ì¼ê´„ ìˆ˜ë ¹: [ì „ë¶€] ì…ë ¥\n\n" +
               "â†©ï¸ ë’¤ë¡œ / âì·¨ì†Œ";

    replier.reply(formatCommand("ğŸ¦ ì§ì—… ìì‚° ì •ì‚°ì†Œ", user, body));
    
    var mState = globalData.rooms[roomName].features.states.menuWait;
    mState[targetUid] = { 
        type: 'trade_job_settlement', 
        time: Date.now(), 
        extra: { wage: dailyWage, rewards: accumulated, total: totalAvailable, isWageAvailable: isWageAvailable } 
    };
}

// [ì¶”ê°€] ì§ì—… ì •ì‚° ì…ë ¥ ì²˜ë¦¬ í•¸ë“¤ëŸ¬ (ì „ë¶€/ë¶€ë¶„ ìˆ˜ë ¹)
function _handleJobSettlement(msg, user, data, replier, roomName, targetUid) {
    var state = data.rooms[roomName].features.states.menuWait[targetUid];
    if (!state) return false;

    var totalAvailable = Number(state.extra.total);
    var withdrawAmt = (msg === "ì „ë¶€") ? totalAvailable : parseInt(msg.replace(/[^0-9]/g, ""));

    if (isNaN(withdrawAmt) || withdrawAmt <= 0) return false;
    if (withdrawAmt > totalAvailable) {
        replier.reply(formatError(user, "ìˆ˜ë ¹ ë¶ˆê°€", "ìµœëŒ€ " + fp(totalAvailable) + "Pê¹Œì§€ë§Œ ìˆ˜ë ¹ ê°€ëŠ¥í•©ë‹ˆë‹¤."));
        return true;
    }

    var today = getSimpleDate();
    var isPirate = (user.job === 'pirate');
    
    // ì¼ê¸‰ ì²˜ë¦¬: ì¸ì¶œì•¡ì´ ì˜¤ëŠ˜ì¹˜ ì¼ê¸‰ë³´ë‹¤ ë§ìœ¼ë©´ ì¼ê¸‰ ìˆ˜ë ¹ ì™„ë£Œ ì²˜ë¦¬
    if (state.extra.isWageAvailable && withdrawAmt >= state.extra.wage) {
        if (isPirate) user.lastPirateWageDate = today;
        else user.lastNavyWageDate = today;
    }

    // ë³´ìƒê¸ˆ ì£¼ë¨¸ë‹ˆ ì°¨ê°
    user.claimableReward = Math.max(0, totalAvailable - withdrawAmt - (state.extra.isWageAvailable && withdrawAmt < state.extra.wage ? state.extra.wage : 0));

    user.skipHealing = true;
    var res = processRepayment(user, withdrawAmt, targetUid, roomName);
    util_updatePoint(user, data.rooms["ë‚´ë¦¬ë‹¤"], Number(res.actualGain), "ì§ì—… í™œë™ ìì‚° ì •ì‚°", "ë‚´ë¦¬ë‹¤");

    var resBody = "ì§ì—… í™œë™ ìˆ˜ìµ ì •ì‚°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\n" +
                  "ğŸ’° ìˆ˜ë ¹ ê¸ˆì•¡: +" + fp(withdrawAmt) + "P\n" +
                  "ğŸ›ï¸ ë‚¨ì€ ë¯¸ìˆ˜ë ¹ì•¡: " + fp(user.claimableReward) + "P\n" +
                  (res.repayMsg || "âœ… ì§€ê°‘ìœ¼ë¡œ ì¦‰ì‹œ ì…ê¸ˆë˜ì—ˆìŠµë‹ˆë‹¤.");

    delete data.rooms[roomName].features.states.menuWait[targetUid];
    replier.reply(formatCommand("âœ… ì •ì‚° ì™„ë£Œ", user, resBody, "ë‚´ ì”ì•¡: " + fp(user.point) + "P"));
    safeSaveData(data, true);
    return true;
}

/* [ì‹œìŠ¤í…œ] ì•½íƒˆ ì„±ê³µ ì •ì‚° (ìŠ¤ì¼€ì¤„ëŸ¬ì—ì„œ 3ë¶„ ë§Œë£Œ ì‹œ í˜¸ì¶œ) */
function _processPillageSuccess(victimUid, pData, data, roomName) {
    var victim = null;
    var pirate = null;
    var isAI = (victimUid.indexOf("AI_BOT_") === 0);

    // 1. ìœ ì € ì‹ë³„ ë° ìœ„ì¹˜ íƒìƒ‰
    for (var r in data.rooms) {
        if (!isAI && data.rooms[r].users[victimUid]) victim = data.rooms[r].users[victimUid];
        if (data.rooms[r].users[pData.pirateUid]) pirate = data.rooms[r].users[pData.pirateUid];
    }

    if (!pirate) return;
    if (!isAI && (!victim || !victim.voyage)) return;

    var cfg = SYSTEM_CONFIG.TRADE;
    var pName = isAI ? (pData.victimName || "ìœ ë ¹ ìƒë‹¨") : victim.name;

    // [v16.8] ì „íˆ¬ ë¦¬í¬íŠ¸ì—ì„œ ì „ë‹¬ëœ í™•ì • ìˆ˜ì¹˜(forced)ë¥¼ ìš°ì„  í• ë‹¹ (ì¤‘ë³µ ì„ ì–¸ ì œê±°)
    var pRate = pData.forcedRate || 0;
    var pillageAmount = pData.forcedAmount || 0;

    // 2. í™•ì • ê¸ˆì•¡ì´ ì—†ì„ ë•Œë§Œ(ìŠ¤ì¼€ì¤„ëŸ¬ ìë™ ë§Œë£Œ ì‹œ) ì•„ë˜ ê³„ì‚° ë¡œì§ì„ ì‹¤í–‰
    if (!pillageAmount) {
        if (isAI) {
            // AI ìƒë‹¨ ì•½íƒˆì•¡ ë°¸ëŸ°ì‹±
            var ecoMult = util_getEcoMultiplier("ë‚´ë¦¬ë‹¤");
            var virtualMargin = (Math.floor(Math.random() * 100001) + 100000) * ecoMult;
            pRate = 0.3; 
            pillageAmount = Math.floor(virtualMargin * pRate);
        } else {
            // [ìœ ì € ì •ì‚°]: ê¸°ì¡´ ì†ŒìŠ¤ì½”ë“œì˜ ì •ë°€ ìŠ¤ëƒ…ìƒ· ê¸°ë°˜ ê³„ì‚° ìœ ì§€
            var v = victim.voyage;
            var tRev = 0; var tCost = 0;
            var nSnap = v.marketSnapshot[v.dest];
            var cSnap = v.cargoSnapshot || {};
            var sSnap = v.specialtySnapshot || {};

            // ì¼ë°˜ í™”ë¬¼ ë§¤ì¶œ/ì›ê°€ ê³„ì‚°
            for (var g in cSnap) {
                var qty = Number(cSnap[g]); if (qty <= 0) continue;
                var myPurchasePrice = Number((victim.cargoAvg && victim.cargoAvg[g]) || cfg.GOODS_COST[g]);
                var rateInfo = SYSTEM_CONFIG.PROFIT_RATES[g] || { pref: 1.15, norm: 1.05, hate: 0.8 };
                var mult = (g === nSnap.favorite) ? rateInfo.pref : (g === nSnap.hate ? rateInfo.hate : rateInfo.norm);
                tCost += (myPurchasePrice * qty);
                tRev += Math.floor(myPurchasePrice * mult * qty);
            }
            // íŠ¹ì‚°í’ˆ ë§¤ì¶œ/ì›ê°€ ê³„ì‚°
            for (var s in sSnap) {
                var sQty = Number(sSnap[s]); if (sQty <= 0) continue;
                var pG = "";
                for (var rel in TRADE_RELATION) { if (TRADE_RELATION[rel].set === s) { pG = TRADE_RELATION[rel].produce; break; } }
                var sBase = cfg.SPECIALTY_COST[pG] || 10000;
                var sMult = (pG === nSnap.favorite) ? cfg.SPECIALTY_PROFIT : (pG === nSnap.hate ? 0.5 : 1.0);
                tCost += (sBase * sQty);
                tRev += Math.floor(sBase * sQty * sMult);
            }

            var margin = (tRev - tCost);
            var shipEff = (victim.shipLevel === 1) ? 4.2 : (victim.shipLevel === 2 ? 1.9 : 1.15);
            
            // í•­êµ¬ ë°œì „ë„ ë³´ë„ˆìŠ¤ í•©ì‚° ì •ì‚°
            var pInfo = (data.rooms[roomName].features.portData && data.rooms[roomName].features.portData[v.dest]) ? data.rooms[roomName].features.portData[v.dest] : { level: 1 };
            var pBonus = Math.floor(Math.floor(margin * shipEff) * ((pInfo.level - 1) * 0.01));
            var totalNetMargin = Math.floor(margin * shipEff) + pBonus;

            // í•´ì  ìˆ™ë ¨ë„(ì„ ë°• ë ˆë²¨)ì— ë”°ë¥¸ ì•½íƒˆë¥  ì ìš©
            var pMin = cfg.JOBS.PIRATE.pillageRateMin || 0.3;
            var pMax = cfg.JOBS.PIRATE.pillageRateMax || 0.5;
            pRate = pMin + (pMax - pMin) * (Number(pirate.shipLevel || 1) - 1) / 9;
            
            pillageAmount = totalNetMargin > 0 ? Math.floor(totalNetMargin * pRate) : 0;

            // í”¼í•´ì ìƒíƒœ ì—…ë°ì´íŠ¸
            victim.isPillaged = true;
            v.isPillaged = true;
            v.pillageRateSnapshot = pRate;
        }
    }

    // 3. ê³µí†µ ë°ì´í„° ë°˜ì˜ ë° ì£¼ë¨¸ë‹ˆ(ì •ì‚°ì†Œ) ì ë¦½
    if (pillageAmount > 0) {
        var pirateCfg = (SYSTEM_CONFIG.TRADE.JOBS && SYSTEM_CONFIG.TRADE.JOBS.PIRATE) ? SYSTEM_CONFIG.TRADE.JOBS.PIRATE : { bountyInc: 15000 };
        
        // ë°ì´í„° ì—…ë°ì´íŠ¸
        pirate.claimableReward = (Number(pirate.claimableReward) || 0) + pillageAmount;
        pirate.infamy = (pirate.infamy || 0) + 10;
        pirate.currentBounty = (Number(pirate.currentBounty) || 0) + (pirateCfg.bountyInc || 15000);
        pirate.totalPillageSuccess = (pirate.totalPillageSuccess || 0) + 1;
        
        pirate.hasNotifiedReward = false;
        pirate.pillageCooldownEndTime = Date.now() + (cfg.JOBS.PIRATE.winCooldown || 300000);
        
        // ì¹­í˜¸ ì²´í¬ ë° ì˜ì†ì„± ì €ì¥ (Master Logic ì¤€ìˆ˜)
        util_checkPirateTitle(pirate, null, "ë‚´ë¦¬ë‹¤");
        safeSaveData(data, true);

        Log.info("[Pillage] " + pirate.name + " -> " + pName + " ì„±ê³µ (" + pillageAmount + "P)");
    }
}

// ì‹ ì„¤: í•´ì  ì „ìš© ë³´ì„ê¸ˆ ë‚©ë¶€ ë¡œì§
function _processPirateBail(user, data, replier, roomName, targetUid) {
Â  Â  var cfg = SYSTEM_CONFIG.TRADE.JOBS.PIRATE;
Â  Â  var now = Date.now();
Â  Â Â 
Â  Â  var inJail = (user.jailReleaseTime && now < user.jailReleaseTime);
    var inPillageCooldown = (user.pillageCooldownEndTime && now < user.pillageCooldownEndTime);

    if (!inJail && !inPillageCooldown) {
        return replier.reply(formatError(user, "ë‚©ë¶€ ë¶ˆê°€", "í˜„ì¬ ì œí•œ ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤."));
    }

Â  Â  if (user.point < cfg.bailAmount) {
Â  Â  Â  Â  return replier.reply(formatError(user, "ìê¸ˆ ë¶€ì¡±", "ë³´ì„ê¸ˆ " + fp(cfg.bailAmount) + "Pê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."));
Â  Â  }

Â  Â  user.skipHealing = true;
Â  Â  util_updatePoint(user, data.rooms[roomName], -cfg.bailAmount, "í•´ì  ë³´ì„ê¸ˆ ì„ë°©", roomName);
Â  Â Â 
Â  Â  // ìƒíƒœ ì¦‰ì‹œ ì´ˆê¸°í™”
Â  Â  user.jailReleaseTime = 0;
Â  Â  user.pillageCooldownEndTime = 0;

    // ì„ë°© ì²˜ë¦¬ê°€ ì™„ë£Œë˜ëŠ” ì¦‰ì‹œ ë©”ë‰´ ì‘ë‹µ ëŒ€ê¸° ì„¸ì…˜(menuWait)ì„ ì¢…ë£Œí•¨
    if (data.rooms[roomName].features && data.rooms[roomName].features.states.menuWait) {
        delete data.rooms[roomName].features.states.menuWait[targetUid];
    }
Â  Â Â 
Â  Â  replier.reply(formatCommand("ğŸ”“ ì¦‰ì‹œ ì„ë°© ì™„ë£Œ", user, "ë³´ì„ê¸ˆ " + fp(cfg.bailAmount) + "Pë¥¼ ì§€ë¶ˆí•˜ê³  ììœ ì˜ ëª¸ì´ ë˜ì—ˆìŠµë‹ˆë‹¤!\nì¦‰ì‹œ í•´ìƒ í™œë™ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤."));
Â  Â  safeSaveData(data, true);
}

/**
 * [v14.4 ì‹ ê·œ] í•´ìƒ ì§ì—… ì¹­í˜¸ ê´€ë¦¬ ì—”ì§„
 * ì¡°ê±´: 30 -> 50 -> 70 -> 100 -> 150
 */
function util_checkPirateTitle(user, replier, roomName) {
    var count = user.totalPillageSuccess || 0;
    var rStub = { reply: function(m) { try { Api.replyRoom(roomName, m); } catch(e){} } };

    if (count >= 150) {
        util_checkAndAwardTitle(user, rStub, "í•´ì ì™•", 5315, "ğŸ´â€â˜ ï¸", "ë‚˜ì†Œ í•´ì  ì˜íšŒ", "ëˆ„ì  ì•½íƒˆ 150íšŒ ë‹¬ì„±", "[ì¥ì°© íš¨ê³¼]: ì•½íƒˆ ì†Œìš” ì‹œê°„ 30% ë‹¨ì¶• ë° ê¸°ë³¸ ì¼ê¸‰ 50% ë³´ë„ˆìŠ¤ê°€ ì ìš©ë©ë‹ˆë‹¤.", roomName);
    } else if (count >= 100) {
        util_checkAndAwardTitle(user, rStub, "ì»¤ì„¸ì–´", 5314, "âš”ï¸", "ë‚˜ì†Œ í•´ì  ì˜íšŒ", "ëˆ„ì  ì•½íƒˆ 100íšŒ ë‹¬ì„±", "ë°”ë‹¤ì˜ ë¬´ë²•ì ì¤‘ì—ì„œë„ ê°€ì¥ ì•…ëª… ë†’ì€ ì´ë¦„ì…ë‹ˆë‹¤.", roomName);
    } else if (count >= 70) {
        util_checkAndAwardTitle(user, rStub, "ë¸”ë™ì„¸ì¼", 5313, "ğŸ’€", "ë‚˜ì†Œ í•´ì  ì˜íšŒ", "ëˆ„ì  ì•½íƒˆ 70íšŒ ë‹¬ì„±", "ìˆ˜í‰ì„  ë„ˆë¨¸ ë‹¹ì‹ ì˜ ë›ì´ ë³´ì´ë©´ ëª¨ë“  ìƒì„ ì´ ë©ˆì¶°ì„­ë‹ˆë‹¤.", roomName);
    } else if (count >= 50) {
        util_checkAndAwardTitle(user, rStub, "ë°”ì¹´ë‹ˆì–´", 5312, "ğŸ—¡ï¸", "ë‚˜ì†Œ í•´ì  ì˜íšŒ", "ëˆ„ì  ì•½íƒˆ 50íšŒ ë‹¬ì„±", "ë‹¹ì‹ ì˜ ì´ë¦„ì´ ì¹´ë¦¬ë¸Œí•´ í•­êµ¬ë§ˆë‹¤ ì†ì‚­ì—¬ì§‘ë‹ˆë‹¤.", roomName);
    } else if (count >= 30) {
        util_checkAndAwardTitle(user, rStub, "ë¬´ë²•ì", 5311, "ğŸ§¤", "ë‚˜ì†Œ í•´ì  ì˜íšŒ", "ëˆ„ì  ì•½íƒˆ 30íšŒ ë‹¬ì„±", "ë°”ë‹¤ì˜ ë²•ì„ ê±°ë¶€í•œ ë‹¹ì‹ , ììœ ë¡œìš´ ì•½íƒˆì˜ ê¸¸ì„ ì‹œì‘í•©ë‹ˆë‹¤.", roomName);
    }
}

function util_checkNavyTitle(user, replier, roomName) {
    var count = user.totalCaptureSuccess || 0;
    var rStub = { reply: function(m) { try { Api.replyRoom(roomName, m); } catch(e){} } };

    if (count >= 150) {
        util_checkAndAwardTitle(user, rStub, "ì œí•´ì™•", 5325, "âš“", "ë‚´ë¦¬ë‹¤ í•´êµ° ì‚¬ë ¹ë¶€", "ëˆ„ì  í† ë²Œ 150íšŒ ë‹¬ì„±", "[ì¥ì°© íš¨ê³¼]: í† ë²Œ í˜„ìƒê¸ˆ 20% ë³´ë„ˆìŠ¤ ë° ê¸°ë³¸ ì¼ê¸‰ 50% ë³´ë„ˆìŠ¤ê°€ ì ìš©ë©ë‹ˆë‹¤.", roomName);
    } else if (count >= 100) {
        util_checkAndAwardTitle(user, rStub, "ë¡œì—´ ë„¤ì´ë¹„", 5324, "ğŸ‘®", "ë‚´ë¦¬ë‹¤ í•´êµ° ì‚¬ë ¹ë¶€", "ëˆ„ì  í† ë²Œ 100íšŒ ë‹¬ì„±", "ë‹¹ì‹ ì€ êµ­ì™•ì˜ ê°€ì¥ ë‚ ì¹´ë¡œìš´ ì°½ì´ì ë“ ë“ í•œ ë°©íŒ¨ì…ë‹ˆë‹¤.", roomName);
    } else if (count >= 70) {
        util_checkAndAwardTitle(user, rStub, "í•¨ëŒ€ì‚¬ë ¹ê´€", 5323, "ğŸš©", "ë‚´ë¦¬ë‹¤ í•´êµ° ì‚¬ë ¹ë¶€", "ëˆ„ì  í† ë²Œ 70íšŒ ë‹¬ì„±", "ì¼ê°œ ì „ë‹¨ì„ ë„˜ì–´ ì „ í•´ì—­ì˜ í•¨ëŒ€ë¥¼ í†µì œí•˜ê¸° ì‹œì‘í–ˆìŠµë‹ˆë‹¤.", roomName);
    } else if (count >= 50) {
        util_checkAndAwardTitle(user, rStub, "í•¨ëŒ€ì§€íœ˜ê´€", 5322, "ğŸ¢", "ë‚´ë¦¬ë‹¤ í•´êµ° ì‚¬ë ¹ë¶€", "ëˆ„ì  í† ë²Œ 50íšŒ ë‹¬ì„±", "ë›°ì–´ë‚œ ì „ëµìœ¼ë¡œ í•´ì  ì†Œíƒ• ì‘ì „ì„ ì„±ê³µì ìœ¼ë¡œ ì´ëŒì—ˆìŠµë‹ˆë‹¤.", roomName);
    } else if (count >= 30) {
        util_checkAndAwardTitle(user, rStub, "í•´ì•ˆê²½ë¹„ëŒ€", 5321, "ğŸ›¡ï¸", "ë‚´ë¦¬ë‹¤ í•´êµ° ì‚¬ë ¹ë¶€", "ëˆ„ì  í† ë²Œ 30íšŒ ë‹¬ì„±", "ì²« í† ë²Œì˜ ê³µë¡œë¥¼ ì¸ì •ë°›ì•„ ì •ì‹ ì¥êµì˜ ê¸¸ì„ ê±·ìŠµë‹ˆë‹¤.", roomName);
    }
}
